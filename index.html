<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weizend Oyun DÃ¼nyasÄ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
/* --- YENÄ° EKLENECEK KOD --- */
#finishersList {
    max-height: 450px; /* YaklaÅŸÄ±k 5 satÄ±r + boÅŸluklar iÃ§in bir yÃ¼kseklik */
    overflow-y: auto;
}
#updateOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    text-align: center;
}
/* --- SÃœRPRÄ°Z KART SEÃ‡Ä°M STÄ°LÄ° --- */
#cardSelectionModal .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#cardSelectionModal .card:hover {
    transform: translateY(-10px) scale(1.05);
    box-shadow: 0 15px 30px rgba(255, 50, 50, 0.4);
}

.new-card-badge {
    position: absolute;
    top: -10px;
    left: -10px;
    background-color: #22c55e; /* bg-green-500 */
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    padding: 3px 8px;
    border-radius: 12px;
    border: 2px solid white;
    transform: rotate(-15deg);
    animation: pulse-new 1.5s infinite;
}

@keyframes pulse-new {
    0%, 100% { transform: rotate(-15deg) scale(1); }
    50% { transform: rotate(-15deg) scale(1.1); }
}
/* --- BÄ°LGÄ° BUTONU STÄ°LÄ° --- */
.info-button {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #3b82f6; /* bg-blue-600 */
    color: white;
    font-weight: bold;
    font-size: 1.1rem;
    border: 2px solid white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
}
.info-button:hover {
    transform: scale(1.1);
    background-color: #2563eb; /* bg-blue-700 */
}
/* --- YENÄ° KART PAKETÄ° STÄ°LLERÄ° --- */

/* Normal (Bronz) Kart Paketi iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.card_pack_normal {
    background: linear-gradient(145deg, #a16207, #854d0e); /* amber-700 to amber-800 */
    border-color: #fcd34d; /* amber-300 */
}
.box.opened.card_pack_normal .box-content::before {
    content: 'ğŸ¥‰';
    font-size: 2.5rem;
}

/* GÃ¼mÃ¼ÅŸ Kart Paketi iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.card_pack_gumus {
    background: linear-gradient(145deg, #71717a, #52525b); /* zinc-600 to zinc-700 */
    border-color: #e5e7eb; /* gray-200 */
}
.box.opened.card_pack_gumus .box-content::before {
    content: 'ğŸ¥ˆ';
    font-size: 2.5rem;
}

/* AltÄ±n Kart Paketi iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.card_pack_altin {
    background: linear-gradient(145deg, #f59e0b, #d97706); /* amber-500 to amber-600 */
    border-color: #fde047; /* yellow-300 */
}
.box.opened.card_pack_altin .box-content::before {
    content: 'ğŸ¥‡';
    font-size: 2.5rem;
}

/* Efsanevi Kart Paketi iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.card_pack_efsanevi {
    background: linear-gradient(145deg, #7e22ce, #6b21a8); /* purple-700 to purple-800 */
    border-color: #d8b4fe; /* purple-300 */
    animation: glow 2s ease-in-out infinite; /* Efsanevi Ä±ÅŸÄ±ltÄ±sÄ± */
}
.box.opened.card_pack_efsanevi .box-content::before {
    content: 'ğŸ†';
    font-size: 2.5rem;
}

/* Joker Kart iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.wildcard {
    background: linear-gradient(145deg, #a855f7, #7e22ce); /* purple */
    border-color: #d8b4fe;
}
.box.opened.wildcard .box-content::before {
    content: 'ğŸƒ'; /* GÃœNCELLENDÄ° */
    font-size: 2.5rem;
}

/* Kart Paketi iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.card_pack {
    background: linear-gradient(145deg, #6d28d9, #4c1d95); /* purple */
    border-color: #a78bfa;
}
.box.opened.card_pack .box-content::before {
    content: 'ğŸ´'; /* GÃœNCELLENDÄ° */
    font-size: 2.5rem;
}
/* --- KART Ã‡EVÄ°RME ANÄ°MASYONU STÄ°LLERÄ° --- */
.card-flip-container {
    perspective: 1000px;
    width: 150px;
    height: 210px;
    cursor: pointer;
}

.card-flipper {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s;
    transform-style: preserve-3d;
}

.card-flip-container.flipped .card-flipper {
    transform: rotateY(180deg);
}

.card-front, .card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    border-radius: 12px;
}

/* --- YENÄ°: KAPALI KART PAKETÄ° Ã–N YÃœZ STÄ°LLERÄ° --- */

/* TÃ¼m kapalÄ± paket Ã¶n yÃ¼zleri iÃ§in temel stil */
.card-front {
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* Efsanevi animasyonu iÃ§in Ã¶nemli */
}

.pack-icon {
    font-size: 5rem;
    opacity: 0.8;
    filter: drop-shadow(0 0 10px rgba(0,0,0,0.7));
}

/* Standart Paket Ã–n YÃ¼zÃ¼ (Mor/Gizemli) */
.pack-front-standart {
    background: linear-gradient(145deg, #4c1d95, #3730a3); /* Koyu Mor */
    border: 4px solid #a78bfa;
}
.pack-front-standart .pack-icon {
    color: #c4b5fd;
}

/* Bronz Paket Ã–n YÃ¼zÃ¼ */
.pack-front-normal {
    background: linear-gradient(145deg, #4a2c0f, #3a1e0b);
    border: 4px solid;
    border-image: linear-gradient(145deg, #d3a17c, #b37e5c, #d3a17c) 1;
}
.pack-front-normal .pack-icon {
    color: #d3a17c;
}

/* GÃ¼mÃ¼ÅŸ Paket Ã–n YÃ¼zÃ¼ */
.pack-front-gumus {
    background: linear-gradient(145deg, #4a5568, #2d3748);
    border: 4px solid;
    border-image: linear-gradient(145deg, #e5e7eb, #9ca3af, #e5e7eb) 1;
}
.pack-front-gumus .pack-icon {
    color: #e5e7eb;
}

/* AltÄ±n Paket Ã–n YÃ¼zÃ¼ */
.pack-front-altin {
    background: linear-gradient(145deg, #6a4f2b, #4a371e);
    border: 4px solid;
    border-image: linear-gradient(145deg, #ffee00, #ffd700, #ffb300) 1;
    box-shadow: 0 0 15px #ffd700;
}
.pack-front-altin .pack-icon {
    color: #ffee00;
}

/* Efsanevi Paket Ã–n YÃ¼zÃ¼ (Animasyonlu) */
.pack-front-efsanevi {
    position: relative;
    z-index: 1;
    background: #111;
}
.pack-front-efsanevi::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    z-index: 1;
    background: conic-gradient(#ff1b1b, #ff7f00, #ffee00, #ff7f00, #ff1b1b);
    animation: spin-around 4s linear infinite;
}
.pack-front-efsanevi::after {
    content: '';
    position: absolute;
    top: 4px; left: 4px; right: 4px; bottom: 4px;
    border-radius: 8px; /* Ä°Ã§ Ã§erÃ§eve iÃ§in daha az yuvarlaklÄ±k */
    z-index: 2;
    background: linear-gradient(145deg, #e43642, #b11f29);
    animation: breathing-bg 3s infinite ease-in-out;
}
.pack-front-efsanevi > * {
    position: relative;
    z-index: 3;
}
.pack-front-efsanevi .pack-icon {
    color: #ffee00;
    animation: badge-pulse 2s infinite ease-in-out;
}

/* AÃ§Ä±lmÄ±ÅŸ KartÄ±n GÃ¶rÃ¼nÃ¼mÃ¼ (Ã–n YÃ¼zÃ¼) */
.card-back {
    transform: rotateY(180deg);
}
/* --- TAKAS PAZARI STÄ°LLERÄ° --- */
.market-offer-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: #1f2937; /* bg-gray-800 */
    padding: 1rem;
    border-radius: 0.75rem;
    border: 1px solid #374151; /* border-gray-700 */
}

.market-card-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-align: left;
}

.market-card-info img {
    width: 50px;
    height: 70px;
    object-fit: cover;
    border-radius: 0.375rem;
    border: 2px solid #4b5563;
}

.market-card-info .card-name {
    font-weight: bold;
    color: white;
}
.market-card-info .card-owner {
    font-size: 0.8rem;
    color: #9ca3af; /* text-gray-400 */
}
/* --- KART YÃ–NETÄ°M BUTONLARI STÄ°LÄ° --- */
.card-admin-buttons {
    position: absolute;
    top: 4px;
    right: 4px;
    z-index: 2;
    display: flex;
    gap: 4px;
    background: rgba(0,0,0,0.5);
    padding: 4px;
    border-radius: 8px;
}
.card-admin-buttons button {
    background: #4a5568;
    border: none;
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    cursor: pointer;
    font-size: 16px;
    line-height: 28px;
    transition: background-color 0.2s;
}
.card-admin-buttons button:hover {
    background: #718096;
}
/* --- YENÄ°: KART KOLEKSÄ°YONU SÄ°STEMÄ° STÄ°LLERÄ° --- */

/* Kart albÃ¼mÃ¼nÃ¼n genel yerleÅŸimi */
#cardCollectionAlbum {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1.5rem;
    padding: 1rem;
}

/* Tek bir kartÄ±n (hem dolu hem boÅŸ) kapladÄ±ÄŸÄ± alan */
.card-slot {
    perspective: 1000px;
}

/* KartÄ±n kendisi - temel stil */
.card-item {
    width: 100%;
    aspect-ratio: 7 / 10; /* Kart en boy oranÄ± */
    border-radius: 12px;
    padding: 8px;
    background-color: #1f2937; /* bg-gray-800 */
    position: relative;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.4);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
}

.card-item:hover {
    transform: translateY(-10px) rotateX(5deg);
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
}

/* KartÄ±n iÃ§indeki resim */
.card-image {
    width: 100%;
    height: 70%;
    object-fit: cover;
    border-radius: 6px;
    border: 2px solid rgba(255, 255, 255, 0.1);
}

/* KartÄ±n adÄ± */
.card-name {
    text-align: center;
    font-weight: bold;
    color: white;
    font-size: 0.9rem;
    padding: 8px 4px 0 4px;
    text-shadow: 1px 1px 2px black;
}

/* Fazla kartlarÄ± gÃ¶steren rozet */
.duplicate-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    background-color: #fde047; /* yellow-400 */
    color: #111827; /* gray-900 */
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
    border: 2px solid white;
}

/* --- NADÄ°RLÄ°K Ã‡ERÃ‡EVELERÄ° (GÃœNCELLENMÄ°Å) --- */

/* Normal Kart (Bronz GÃ¶rÃ¼nÃ¼m) */
.rarity-normal {
    background: linear-gradient(145deg, #4a2c0f, #3a1e0b); /* Koyu bronz arkaplan */
    border: 4px solid;
    border-image: linear-gradient(145deg, #d3a17c, #b37e5c, #d3a17c) 1; /* Bronz Ã§erÃ§eve */
    box-shadow: 0 0 10px rgba(205, 127, 50, 0.3); /* Hafif bronz Ä±ÅŸÄ±ltÄ± */
}

/* GÃ¼mÃ¼ÅŸ Kart */
.rarity-gumus {
    background: linear-gradient(145deg, #4a5568, #2d3748);
    border: 4px solid;
    border-image: linear-gradient(145deg, #e5e7eb, #9ca3af, #e5e7eb) 1;
    box-shadow: 0 0 15px rgba(200, 200, 220, 0.4);
}

/* AltÄ±n Kart (Daha Koyu Arkaplan ve CanlÄ± Ã‡erÃ§eve) */
.rarity-altin {
    /* ArkaplanÄ± daha koyu ve zengin bir tona Ã§ektik */
    background: linear-gradient(145deg, #6a4f2b, #4a371e);
    border: 4px solid;
    /* Ã‡erÃ§eve renklerini daha parlak ve canlÄ± sarÄ±/altÄ±n tonlarÄ± yaptÄ±k */
    border-image: linear-gradient(145deg, #ffee00, #ffd700, #ffb300) 1;
    /* Ã‡erÃ§evenin dÄ±ÅŸÄ±ndaki Ä±ÅŸÄ±ltÄ±yÄ± daha belirgin hale getirdik */
    box-shadow: 0 0 20px #ffd700;
}

/* Efsanevi Kart (AteÅŸli Ã‡erÃ§eve + Efsanevi Ä°ÅŸareti) */
@keyframes breathing-bg {
    0% {
        opacity: 1;
    }
    50% {
        opacity: 0.6; /* IÅŸÄ±ÄŸÄ±n ne kadar kÄ±sÄ±lacaÄŸÄ±nÄ± buradan ayarlayabilirsin */
    }
    100% {
        opacity: 1;
    }
}

.rarity-efsanevi {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    z-index: 1;
    background: #111;
}

.rarity-efsanevi::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    z-index: 1;

    /* 1. Ä°STEK: Ã‡erÃ§eveyi kÄ±rmÄ±zÄ±-turuncu-sarÄ± yaptÄ±k */
    background: conic-gradient(
        #ff1b1b, #ff7f00, #ffee00, #ff7f00, #ff1b1b
    );
    
    animation: spin-around 4s linear infinite;
}

.rarity-efsanevi::after {
    content: '';
    position: absolute;
    top: 4px;
    left: 4px;
    right: 4px;
    bottom: 4px;
    border-radius: 12px;
    z-index: 2;
    background: linear-gradient(145deg, #e43642, #b11f29);

    /* Animasyonu buraya ekliyoruz (3 saniyede bir nefes alÄ±p verecek) */
    animation: breathing-bg 3s infinite ease-in-out;
}

.rarity-efsanevi > * {
    position: relative;
    z-index: 3;
}

/* 2. Ä°STEK: Efsanevi iÅŸaretinin stili */
@keyframes badge-pulse {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 4px #ffee00); }
    50% { transform: scale(1.15); filter: drop-shadow(0 0 8px #ffee00); }
}

.legendary-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 4; /* Her ÅŸeyin en Ã¼stÃ¼nde */
    font-size: 1.5rem; /* 24px */
    /* Emojiye parlama efekti veriyoruz */
    filter: drop-shadow(0 0 4px #ffee00);
    /* HafifÃ§e sallanma ve parlama animasyonu */
    animation: badge-pulse 2s infinite ease-in-out;
}


/* Eksik Kart Stili */
.card-item.missing {
    background-color: #374151; /* gray-700 */
    border: 4px dashed #6b7280; /* gray-500 */
    align-items: center;
    justify-content: center;
    cursor: default;
}

.card-item.missing:hover {
    transform: none;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.4);
}

.missing-text {
    font-size: 4rem;
    color: #4b5563; /* gray-600 */
    font-weight: bold;
}
/* --- MOBÄ°L Ä°ZLEME PENCERESÄ° DÃœZELTMESÄ° --- */
#spectatorModal .modal-content {
    max-height: 85vh; /* Ä°Ã§eriÄŸin ekran yÃ¼ksekliÄŸinin %85'ini geÃ§mesini engeller */
    overflow-y: auto; /* EÄŸer iÃ§erik bu yÃ¼ksekliÄŸe sÄ±ÄŸmazsa, dikey kaydÄ±rma Ã§ubuÄŸu ekler */
}
  .floating-text {
      position: absolute;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      text-shadow: 1px 1px 3px black;
      animation: floatUp 1.5s ease-out forwards;
      pointer-events: none; /* TÄ±klanamaz yapar */
      z-index: 100;
  }
  @keyframes floatUp {
      0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
      }
      100% {
          opacity: 0;
          transform: translate(-50%, -150%) scale(1.2);
      }
  }
  body {
    font-family: 'Inter', sans-serif;
  }
  .inline-badge {
    margin-left: 4px; /* Rozetlerin soluna boÅŸluk ekler */
    vertical-align: middle; /* Dikey olarak ortalar */
}
  .scrollable-list::-webkit-scrollbar {
    width: 8px;
  }
  .scrollable-list::-webkit-scrollbar-track {
    background: #333;
    border-radius: 10px;
  }
  .scrollable-list::-webkit-scrollbar-thumb {
    background: #b71c1c;
    border-radius: 10px;
  }
  .scrollable-list::-webkit-scrollbar-thumb:hover {
    background: #ff4444;
  }
  @keyframes glow {
    0%, 100% { box-shadow: 0 0 5px #fde047, 0 0 10px #fde047, 0 0 15px #fde047; }
    50% { box-shadow: 0 0 10px #facc15, 0 0 20px #facc15, 0 0 30px #facc15; }
  }
  .glowing-border {
    animation: glow 2.5s ease-in-out infinite;
  }
  .card-back, .card-front {
    backface-visibility: hidden;
    transition: transform 0.5s ease-in-out;
  }
  .card.opened .card-back {
    transform: rotateY(180deg);
  }
  .card.opened .card-front {
    transform: rotateY(0deg);
  }
  .card-front {
    transform: rotateY(-180deg);
  }
  .user-mention {
    background-color: #4a5568;
    color: #a0aec0;
    padding: 2px 5px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .user-mention:hover {
    background-color: #718096;
  }
  .user-mention.highlighted {
    background-color: #f59e0b;
    color: #1a202c;
    font-weight: bold;
  }
  .admin-controls button:disabled svg {
    fill: #4a5568;
    cursor: not-allowed;
  }
  #gameDiv.modal-is-open .admin-controls,
  #gameDiv.modal-is-open .best-seller-badge {
    visibility: hidden;
  }
  /* ÅANS Ã‡ARKI STÄ°LLERÄ° BAÅLANGIÃ‡ */
#wheelContainer {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 2rem auto;
}

/* Sadece renkli dilimleri iÃ§eren dÃ¶nen arka plan */
#wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 10px solid #4a5568;
    transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
    position: relative;
    /* Arka plan JS tarafÄ±ndan 'conic-gradient' ile doldurulacak */
}

  /* YazÄ±yÄ± taÅŸÄ±yan ve merkezden dÃ¶nen gÃ¶rÃ¼nmez "Ã§ubuk" */
.wheel-text-container {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 50%; /* Ã‡arkÄ±n yarÄ±Ã§apÄ± kadar */
    height: 1px;
    transform-origin: left center; /* Merkezden dÃ¶nmesini saÄŸlar */
    z-index: 6; /* YazÄ±larÄ±n renklerin Ã¼stÃ¼nde olmasÄ±nÄ± saÄŸlar */
}

/* YazÄ±nÄ±n kendisi */
.wheel-text {
    display: block;
    position: absolute;
    left: 70%; 
    top: 70%;
    
    /* Bu transform, yazÄ±yÄ± kendi boyutlarÄ±na gÃ¶re tam olarak ortalar. */
    transform: translate(-80%, -80%);
    
    /* GÃ¶rsel Stiller */
    color: white;
    font-size: 25px;
    font-weight: bold;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 1);
    white-space: nowrap;
}
  
  .wheel-image {
    display: block;
    position: absolute;
    left: 60%; 
    top: 50%;
    /* BoyutlarÄ± ayarla */
    width: 45px;
    height: 45px;
    object-fit: contain; /* Resmin orantÄ±sÄ±nÄ± bozmadan sÄ±ÄŸdÄ±r */
    /* Ortalamak iÃ§in transformu ayarla */
    transform: translate(-50%, -50%);
}
  
/* Ãœstteki sabit sarÄ± ok iÅŸareti */
#wheelMarker {
    position: absolute;
    top: -5px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    border-top: 30px solid #fde047;
    z-index: 10;
}
/* ÅANS Ã‡ARKI STÄ°LLERÄ° BÄ°TÄ°Å */
   /* TÄ±kla Yakala Stilleri */
   #clickCatchGameArea {
    width: 100%;
    max-width: 600px;
    height: 400px;
    background-color: #1a202c;
    border: 3px solid #b71c1c;
    border-radius: 10px;
    position: relative;
    overflow: hidden;
    cursor: crosshair;
  }
  .catch-item {
    position: absolute;
    width: 50px;
    height: 50px;
    background-size: contain;
    background-repeat: no-repeat;
    cursor: pointer;
    transition: transform 0.1s ease;
    /* --- YENÄ° EKLENEN KODLAR --- */
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none;    /* Firefox */
    -ms-user-select: none;     /* Internet Explorer/Edge */
    user-select: none;         /* Standart sÃ¶zdizimi */
}
  .catch-item:hover {
      transform: scale(1.1);
  }
  /* Modal BaÅŸlÄ±ÄŸÄ± AlanÄ± (GÃ¼ncellendi) */
  .modal-header {
    /* Butonu saÄŸa yaslama komutunu kaldÄ±rÄ±yoruz, artÄ±k kendi baÅŸÄ±na ortalanacak */
    padding-bottom: 1rem;
    border-bottom: 1px solid #4a5568;
    margin-bottom: 1rem;
  }

 /* ...VE BU ORÄ°JÄ°NAL HALÄ°YLE DEÄÄ°ÅTÄ°R */
.modal-close-button {
    position: absolute;
    top: 10px; /* YukarÄ±dan boÅŸluk */
    right: 15px; /* SaÄŸdan boÅŸluk */
    color: white; /* Buton rengi */
    font-size: 28px; /* Buton yazÄ± boyutu */
    line-height: 1; /* SatÄ±r yÃ¼ksekliÄŸi */
    background: none; /* Arka planÄ± transparan yapar */
    border: none; /* KenarlÄ±ÄŸÄ± kaldÄ±rÄ±r */
    cursor: pointer; /* Ãœzerine gelince fare iÅŸaretÃ§isini deÄŸiÅŸtirir */
    opacity: 0.7; /* BaÅŸlangÄ±Ã§ta biraz saydam yapar */
    transition: all 0.2s ease-in-out; /* GeÃ§iÅŸ efekti */
    z-index: 10; /* DiÄŸer iÃ§eriklerin Ã¼stÃ¼nde kalmasÄ±nÄ± saÄŸlar */
}

.modal-close-button:hover {
    opacity: 1; /* Ãœzerine gelince tam gÃ¶rÃ¼nÃ¼r yapar */
    transform: scale(1.1); /* HafifÃ§e bÃ¼yÃ¼tÃ¼r */
    color: #ffdddd; /* Ãœzerine gelince renk deÄŸiÅŸimi */
}

/* Modal aÃ§Ä±kken body'nin kaymasÄ±nÄ± engelleyen sÄ±nÄ±f */
body.modal-open {
    overflow: hidden;
}

/* Modal iÃ§erisindeki kaydÄ±rÄ±labilir alanlarÄ±n kaymasÄ±nÄ± engellememek iÃ§in */
body.modal-open .modal-content {
    overflow-y: auto;
}
  .box-setting-input {
    width: 100%;
    padding: 10px;
    background-color: #374151; /* bg-gray-700 */
    border: 1px solid #4b5563; /* border-gray-600 */
    border-radius: 8px; /* rounded-lg */
    color: white;
  }
  .box-setting-input:focus {
    outline: none;
    border-color: #8b5cf6; /* focus:border-purple-500 */
    box-shadow: 0 0 0 2px #a78bfa; /* focus:ring-2 focus:ring-purple-400 */
  }
  body.modal-open {
    overflow: hidden;
}

</style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center py-8 px-4">
  <div id="globalAdminNotification" class="fixed top-5 left-1/2 -translate-x-1/2 w-auto max-w-md bg-blue-600 text-white px-6 py-3 rounded-lg shadow-xl text-center font-bold z-[100000] transition-all duration-500 ease-in-out opacity-0 -translate-y-20">
      </div>

  <header class="w-full max-w-4xl bg-gradient-to-r from-red-700 to-black text-white text-3xl font-extrabold tracking-wider py-4 rounded-xl shadow-xl mb-8 text-center relative">
    WEÄ°ZEND OYUN DÃœNYASI
    
    <div id="seasonCountdownContainer" class="text-base font-normal mt-2 text-yellow-300 hidden flex justify-center items-center gap-2">
    <span>AylÄ±k Sezonun Bitmesine: <span id="seasonCountdown" class="font-bold text-white tracking-wider"></span></span>
    <button onclick="openSeasonInfoModal()" class="text-blue-400 hover:text-blue-300 transition-colors" title="AylÄ±k Sezon SÄ±fÄ±rlamasÄ± HakkÄ±nda Bilgi">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>
</div>
</header>

<div id="activityFeedPanel" class="fixed top-0 right-0 h-full w-full max-w-md bg-gray-800 border-l-2 border-red-700 shadow-2xl z-[10000] transform translate-x-full transition-transform duration-300 ease-in-out hidden">
      <div class="flex flex-col h-full">
          <div class="flex justify-between items-center p-4 border-b border-gray-700">
              <h4 class="text-yellow-400 text-2xl font-bold">Son Eylemler</h4>
              <button onclick="closeActivityFeed()" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
              </button>
          </div>
          <div id="activityFeedList" class="flex-grow overflow-y-auto p-4 scrollable-list">
              </div>
      </div>
</div>

<div id="loginContainer" class="bg-gray-800 p-8 rounded-xl shadow-lg border border-red-700 w-full max-w-md">
    <div class="flex border-b border-gray-600 mb-6">
        <button id="loginTabBtn" onclick="switchAuthTab('login')" class="flex-1 py-3 text-lg font-bold border-b-2 border-red-500 text-white transition-colors duration-300">GiriÅŸ Yap</button>
        <button id="registerTabBtn" onclick="switchAuthTab('register')" class="flex-1 py-3 text-lg font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors duration-300">KayÄ±t Ol</button>
    </div>

    <div id="loginDiv">
        <input type="text" id="loginUsername" placeholder="Kick KullanÄ±cÄ± AdÄ±" autocomplete="username"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="password" id="loginPassword" placeholder="Åifre" autocomplete="current-password"
               class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <button onclick="login()"
                class="w-full py-3 mb-4 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
          GiriÅŸ Yap
        </button>
        <p class="mt-4 text-center">
          <a href="#" onclick="openPasswordResetModal()" class="text-red-500 hover:text-red-400 font-bold transition duration-200">
            Åifremi Unuttum
          </a>
        </p>
    </div>

    <div id="registerDiv" class="hidden">
        <div id="kickWarning" class="bg-yellow-900/50 border border-yellow-400 text-yellow-300 px-4 py-3 rounded-lg relative mb-4 text-center">
            <strong class="font-bold">Kick KullanÄ±cÄ± AdÄ± Zorunludur!</strong>
            <span class="block sm:inline">LÃ¼tfen Kick platformundaki kullanÄ±cÄ± adÄ±nÄ±z ile kayÄ±t olunuz.</span>
            <br>
            <span class="block sm:inline font-bold text-red-400 mt-2">Ã–NEMLÄ°: LÃ¼tfen Kick ÅŸifrenizi deÄŸil, bu siteye Ã¶zel yeni bir ÅŸifre oluÅŸturun!</span>
        </div>
        <input type="text" id="registerUsername" placeholder="Kick KullanÄ±cÄ± AdÄ±" autocomplete="username"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="password" id="registerPassword" placeholder="Åifre (Yeni Bir Åifre OluÅŸturun)" autocomplete="new-password"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="password" id="registerPasswordConfirm" placeholder="Åifre Tekrar" autocomplete="new-password"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="text" id="registerPin" placeholder="6 Haneli Unutulmaz Rakam (PIN)" maxlength="6"
               class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />

        <button onclick="register()"
                class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
          KayÄ±t Ol
        </button>
    </div>
</div>
<div id="gameDiv" class="w-full max-w-4xl hidden pb-16">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 mb-8 relative">
        <div class="flex flex-col items-center mb-4">
            <img id="currentUserAvatar" src="" class="w-24 h-24 rounded-full border-4 border-yellow-400 mb-3 object-cover shadow-lg cursor-pointer transition-opacity hover:opacity-80" onclick="openAvatarSelectionModal()">
            <div id="currentUserBadges" class="h-6 mb-1 flex items-center justify-center space-x-1"></div>
            <h3 class="text-yellow-400 text-2xl font-bold flex items-center justify-center">
                <span id="currentUser" class="inline-flex items-center cursor-pointer transition-opacity hover:opacity-80" onclick="openPublicUserDetailModal(currentUser)"></span> 
                <span id="role" class="text-base text-gray-400 ml-2"></span>
            </h3>
        </div>
        <p id="balance" class="text-lg text-gray-300 mb-4 text-center"></p>
        <div class="flex justify-center flex-wrap gap-4 mt-4">
            <button onclick="logout()" class="py-2 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md">Ã‡Ä±kÄ±ÅŸ Yap</button>
            <button id="dailyRewardButton" onclick="openDailyRewardModal()" class="py-2 px-6 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg shadow-md relative">
                GÃ¼nlÃ¼k Ã–dÃ¼l
                <span id="dailyRewardIndicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
            </button>
            <button id="inventoryButton" onclick="openInventoryModal()" class="py-2 px-6 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md">Envanter</button>
            <button id="adminPanelToggleButton" onclick="openAdminPanelModal()" class="py-2 px-6 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md hidden">Admin Paneli</button>
            <button id="helpButton" onclick="openHelpModal()" class="py-2 px-6 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">YardÄ±m</button>
        </div>
        <div id="activityBellContainer" class="absolute top-3 right-3 hidden">
            <button onclick="toggleActivityFeed()" class="relative p-2 rounded-full hover:bg-white/20 transition-colors" title="Son Eylemler">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <span id="activityCounter" class="absolute top-0 right-0 h-5 w-5 bg-yellow-400 text-black text-xs font-bold rounded-full flex items-center justify-center hidden"></span>
            </button>
        </div>
    </div>

    <div class="flex justify-center flex-wrap gap-4 mb-8">
      <button id="gameTabBtn" onclick="showSection('game')"
              class="relative py-3 px-8 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Kutu Oyunu
      </button>
      <button id="cardCollectionTabBtn" onclick="showSection('cardCollection')"
        class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
  Kart Koleksiyonu
</button>
       <button id="chanceWheelTabBtn" onclick="showSection('chanceWheel')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Åans Ã‡arkÄ±
      </button>
       <button id="clickCatchTabBtn" onclick="showSection('clickCatch')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        TÄ±kla-Yakala
      </button>
      <button id="storeTabBtn" onclick="showSection('store')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Puan AlÄ±ÅŸveriÅŸi
        <span id="storeIndicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
      </button>
      <button id="announcementsTabBtn" onclick="showSection('announcements')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Duyurular
        <span id="announcementIndicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
      </button>
    </div>
    
    <div id="cardCollectionContent" class="w-full hidden">

    <div class="flex justify-between items-center mb-2 px-4">
      <div class="flex items-center gap-4">
          <div>
              <div class="flex items-center gap-3">
                  <h3 class="text-yellow-400 text-3xl font-bold">Kart Koleksiyonu AlbÃ¼mÃ¼</h3>
                  <button onclick="openCollectionInfoModal()" class="info-button" title="Oyun HakkÄ±nda Bilgi">?</button>
              </div>
              <div id="seasonCountdownContainer_cards" class="text-sm font-normal mt-2 text-yellow-300 hidden flex justify-center items-center gap-2">
                  <span>Sezonun Bitmesine: <span id="seasonCountdown_cards" class="font-bold text-white tracking-wider"></span></span>
              </div>
          </div>
      </div>
      <div class="text-right">
          <p class="text-lg text-white">Tamamlanan: <span id="collectionProgress" class="font-bold text-green-400">0/0</span></p>
          <p id="wildcardIndicator" class="text-lg text-purple-400 hidden">Joker Kart: <span id="wildcardCount" class="font-bold text-white">0</span> ğŸƒ</p>
          <button onclick="openTradeMarket()" class="mt-2 py-2 px-4 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-bold">Takas PazarÄ±</button>
      </div>
    </div>

    <div id="collectionStatusOverlay" class="hidden w-full text-center bg-gray-800 border-2 border-yellow-500 rounded-xl p-12 my-6 max-w-4xl mx-auto">
        <h3 id="collectionStatusTitle" class="text-3xl font-bold text-yellow-300 mb-4"></h3>
        <p id="collectionStatusMessage" class="text-lg text-gray-300"></p>
    </div>

    <div id="grandPrizeDisplay" class="my-6 p-6 bg-gradient-to-br from-yellow-500/80 to-amber-600/80 rounded-xl shadow-lg border-2 border-yellow-300 max-w-4xl mx-auto text-center hidden">
        <h3 class="text-2xl font-bold text-white mb-4 text-shadow-lg">TÃ¼m KartlarÄ± Topla ve Bu Ã–dÃ¼lleri Kazan!</h3>
        <div id="prizeList" class="flex flex-wrap justify-center items-center gap-x-8 gap-y-4">
            </div>
    </div>
    
    <div id="collectionFinishersLeaderboard" class="hidden my-6 p-6 bg-gray-800 rounded-xl shadow-lg border-2 border-green-400 max-w-4xl mx-auto text-center">
    <h3 class="text-2xl font-bold text-green-300 mb-4">ğŸ† Koleksiyon Liderlik SÄ±ralamasÄ± ğŸ†</h3>
    <div id="finishersList" class="space-y-3 text-left">
        </div>
</div>
    
    <div id="adminCardCollectionControls" class="hidden my-4 p-6 bg-gray-800 rounded-lg border border-purple-500 max-w-4xl mx-auto">
        <h4 class="text-lg font-bold text-purple-300 mb-4 text-center border-b border-gray-700 pb-2">KOLEKSÄ°YON SEZON YÃ–NETÄ°MÄ°</h4>
        <p class="text-center text-gray-400 text-sm mb-4">Mevcut Sezon Durumu: <b id="collectionStatusText" class="text-white">Bilinmiyor</b></p>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="space-y-3">
                <button onclick="openCardCreatorModal()" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg">Kart Ekle/DÃ¼zenle</button>
                <button onclick="openGrandPrizeSettings()" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg">BÃ¼yÃ¼k Ã–dÃ¼lÃ¼ Ayarla</button>
            </div>
            
            <div class="space-y-3">
                <button onclick="toggleCollectionPause()" id="pauseResumeButton" class="w-full py-3 bg-orange-600 hover:bg-orange-500 text-white font-bold rounded-lg">Sezonu Duraklat</button>
                <button onclick="endCurrentSeason()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">â›” Sezonu Bitir</button>
                <button onclick="openTradeHistoryModal()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg">Takas GeÃ§miÅŸi</button>
            </div>

            <div class="space-y-3">
                <button onclick="startNewCollection()" class="w-full h-full py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-lg animate-pulse">
                    ğŸ’¥ YENÄ° SEZONU BAÅLAT ğŸ’¥
                </button>
            </div>
        </div>
    </div>
    
    <div id="cardCollectionAlbum" class="grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-6 p-4 bg-gray-900/50 rounded-xl border border-gray-700">
        </div>

</div>
    <div id="mainContentArea" class="w-full">
    <div id="gameContent" class="w-full">
      <div class="text-lg text-gray-300 mb-6 text-center flex flex-wrap justify-center items-center gap-4">
        <button id="boxSettingsButton" onclick="openBoxSettingsModal()" class="hidden py-1 px-3 text-sm bg-purple-600 hover:bg-purple-500 rounded-lg">Kutu AyarlarÄ±</button>
        <span>Toplam AÃ§Ä±lan: <b id="totalOpenedBoxesCount" class="font-bold text-yellow-400">0</b></span>
        <button onclick="openBoxStatsModal()" class="py-1 px-3 text-sm bg-blue-600 hover:bg-blue-500 rounded-lg">AÃ§anlar Detay</button>
        <button onclick="openUnopenedBoxContentsModal()" class="py-1 px-3 text-sm bg-green-600 hover:bg-green-500 rounded-lg">Kalan Ä°Ã§erikler</button>
        <button onclick="openSolveProblemsModal()" class="py-1 px-3 text-sm bg-orange-600 hover:bg-orange-500 rounded-lg">SorunlarÄ± Ã‡Ã¶z</button>
      </div>

      <div id="boxContainer" class="grid grid-cols-[repeat(auto-fill,minmax(80px,1fr))] gap-2 w-full mx-auto mb-8 p-2">
      </div>
      <div id="lastSurpriseFinderPanel" class="hidden w-full max-w-2xl mx-auto mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border-2 border-amber-400 text-center space-y-3">
        </div>
      <div id="tablesWrapper" class="flex flex-wrap justify-center gap-6 mb-8">
        <div class="tableBox bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 w-full md:flex-1 min-w-[280px] md:max-w-md">
            <h3 class="text-yellow-400 text-xl font-bold border-b border-gray-600 pb-3 mb-4">KARÄ°YER PUANI SIRALAMASI ğŸ†</h3>
            <p class="text-gray-300 mb-3">Toplam KullanÄ±cÄ±: <span id="totalUsers" class="font-bold text-yellow-400">0</span></p>
            <input type="text" id="searchUserRanking" oninput="renderUserRankings()" placeholder="SÄ±ralamada KullanÄ±cÄ± Ara..." class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <div id="allUserRankings" class="scrollable-list max-h-80 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-900 text-sm leading-relaxed">YÃ¼kleniyor...</div>
        </div>
        <div class="tableBox bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 w-full md:flex-1 min-w-[280px] md:max-w-md">
           <h3 class="text-yellow-400 text-xl font-bold border-b border-gray-600 pb-3 mb-4 flex justify-between items-center">
                <span>LÄ°DERLER SIRALAMASI ğŸ‘‘</span>
                <button onclick="openBadgeInfoModal()" class="text-xl text-blue-400 hover:text-blue-300 transition-colors" title="Rozet Bilgileri">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
            </h3>
          <div id="badgedUsersRanking" class="scrollable-list max-h-80 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-900 text-sm leading-relaxed">YÃ¼kleniyor...</div>
        </div>
      </div>
    </div>

        <div id="chanceWheelContent" class="w-full hidden">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 text-center">
        <div class="flex justify-center items-center gap-4 mb-4">
    <h3 class="text-yellow-400 text-3xl font-bold">Åans Ã‡arkÄ±</h3>

    <button onclick="openWheelLegendModal()" class="text-blue-400 hover:text-blue-300 transition-colors" title="Simge AnlamlarÄ±">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    </button>

    <button id="wheelSettingsButton" onclick="openWheelSettingsModal()" class="hidden py-1 px-3 text-sm bg-teal-600 hover:bg-teal-500 rounded-lg">Ã‡ark AyarlarÄ±</button>
</div>
        
        <p class="text-gray-300 mb-2">Ã‡arkÄ± Ã§evirerek harika Ã¶dÃ¼ller kazanma ÅŸansÄ± yakala!</p>
        <p class="text-lg font-semibold mb-4">Ã‡evirme Bedeli: <span class="text-green-400">1 Ã‡ark Bileti</span> | Mevcut Biletlerin: <span id="wheelTicketBalance" class="text-yellow-400 font-bold">0</span></p>
        
        <div id="wheelContainer">
    <div id="wheel"></div>
    <div id="wheelMarker"></div>
</div>

        <button id="spinWheelBtn" onclick="spinWheel()" class="py-3 px-10 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
            Ã‡arkÄ± Ã‡evir!
        </button>
        
        <div id="lastWheelSurprisePanel" class="hidden w-full max-w-lg mx-auto mt-6 bg-gray-900/50 p-4 rounded-xl shadow-lg border-2 border-amber-400 text-center space-y-2">
            </div>
        
        <div id="lastWheelSurprisePanel" class="hidden w-full max-w-lg mx-auto mt-6 bg-gray-900/50 p-4 rounded-xl shadow-lg border-2 border-amber-400 text-center space-y-2">
            </div>
            
        <div class="mt-8 bg-gray-900/50 p-4 rounded-lg border border-gray-700 max-w-lg mx-auto">
            <h4 class="text-yellow-300 text-lg font-semibold mb-3">Son Kazananlar</h4>
            <div id="wheelHistoryList" class="scrollable-list max-h-40 overflow-y-auto text-left">
                </div>
        </div>
    </div>
</div>
<div id="solveProblemsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-orange-500 w-11/12 max-w-lg text-center relative">
    <button class="modal-close-button" onclick="closeSolveProblemsModal()">&times;</button>
    <h4 class="text-orange-300 text-2xl font-bold mb-6">Sorun Giderme MenÃ¼sÃ¼</h4>
    <p class="text-gray-400 mb-6">Buradaki araÃ§larÄ± kullanarak oyunda oluÅŸabilecek genel sorunlarÄ± Ã§Ã¶zebilirsiniz.</p>
    <div class="space-y-4">
        <button onclick="manualUnlockGame()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">
            Kutu aÃ§maya devam et. (Kutu aÃ§Ä±lmÄ±yorsa)
        </button>
        <button onclick="manualResetAfterSurprise()" class="w-full py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">
            KutularÄ± sÄ±fÄ±rla (SÃ¼rpriz Kutu Bulunduysa)
        </button>
    </div>
  </div>
</div>
<div id="cardCreatorModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-yellow-500 w-11/12 max-w-lg text-left relative">
    <button class="modal-close-button" onclick="closeCardCreatorModal()">&times;</button>
    <h3 id="cardFormTitle" class="text-yellow-300 text-3xl font-bold mb-6 text-center">Yeni Kart OluÅŸtur</h3>
    <div class="space-y-4">
      <input type="text" id="cardNameInput" placeholder="Kart AdÄ± (Ã–rn: Efsanevi Mikrofon)" class="box-setting-input">
      <input type="text" id="cardImageUrlInput" placeholder="Kart Resim URL'si (hizliresim.com linki)" class="box-setting-input">

      <div>
        <label class="block text-sm font-medium text-gray-300 mb-1">Nadirlik Seviyesi:</label>
        <select id="cardRarityInput" class="box-setting-input">
          <option value="normal">Normal (Gri Ã‡erÃ§eve)</option>
          <option value="gumus">GÃ¼mÃ¼ÅŸ (GÃ¼mÃ¼ÅŸ Ã‡erÃ§eve)</option>
          <option value="altin">AltÄ±n (AltÄ±n Ã‡erÃ§eve)</option>
          <option value="efsanevi">Efsanevi (Hareketli Ã‡erÃ§eve)</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-300 mb-1">Åans AÄŸÄ±rlÄ±ÄŸÄ±:</label>
        <input type="number" id="cardChanceInput" placeholder="Ã–rn: Normal=100, Efsanevi=5" class="box-setting-input">
        <p class="text-xs text-gray-500 mt-1">Bu sayÄ±nÄ±n yÃ¼ksek olmasÄ±, kartÄ±n paketten Ã§Ä±kma ihtimalini artÄ±rÄ±r.</p>
      </div>
      </div>
    <div class="mt-6">
      <button id="saveCardBtn" onclick="saveCard()" class="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded-lg shadow-md">KARTI KAYDET</button>
    </div>
  </div>
</div>
      <div id="lobbyNotificationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-blue-500 w-11/12 max-w-md text-center relative">
    <h4 class="text-blue-400 text-3xl font-bold mb-4">ğŸ“¢ TÄ±kla-Yakala Lobisi Kuruldu! ğŸ“¢</h4>
    <div id="lobbyNotificationInfo" class="text-lg text-gray-200 space-y-3 bg-gray-900 p-4 rounded-lg">
        </div>
    <div class="flex gap-4 mt-8">
        <button onclick="closeLobbyNotificationModal()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">
          Kapat
        </button>
        <button onclick="goToLobbySection()" class="flex-1 py-3 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md">
          Lobiye Git
        </button>
    </div>
  </div>
</div>

        <div id="clickCatchContent" class="w-full hidden">
    
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 text-center">
                <div class="flex justify-center items-center gap-4 mb-4">
    <h3 class="text-yellow-400 text-3xl font-bold">TÄ±kla-Yakala</h3>
    <button onclick="openClickCatchInfoModal()" class="text-blue-400 hover:text-blue-300 transition-colors" title="Oyun ModlarÄ± HakkÄ±nda Bilgi">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>
</div>
                <div id="weeklyWinnerContainer" class="hidden w-full max-w-2xl mx-auto mt-6 mb-4 bg-gray-800 p-4 rounded-xl shadow-lg border-2 border-green-500 text-center relative">
    <h4 class="text-green-300 text-xl font-bold mb-3">ğŸ† HaftanÄ±n TÄ±kla-Yakala Åampiyonu ğŸ†</h4>
    <div id="weeklyWinnerInfo" class="text-lg text-gray-200 space-y-2">
        </div>
    <button id="clearWeeklyWinnerBtn" onclick="clearWeeklyWinnerDisplay()" class="hidden absolute -top-3 -right-3 bg-red-600 hover:bg-red-500 text-white rounded-full h-8 w-8 flex items-center justify-center text-lg font-bold" title="Kazanan Panelini Gizle">&times;</button>
</div>
        
                <div id="clickCatchAdminButtonsContainer" class="hidden bg-gray-900/50 p-4 rounded-lg border border-yellow-500 mb-6 flex justify-center gap-4">
                    <button onclick="openSoloGameSettingsModal()" class="py-3 px-6 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-md">
                        Tekli Oyun AyarlarÄ±
                    </button>
                    <button onclick="openLobbySettingsModal()" class="py-3 px-6 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">
                        Lobi YÃ¶netim Paneli
                    </button>
                </div>
        
                <div id="lastWinnerContainer" class="hidden bg-gray-900/50 p-4 rounded-lg border border-yellow-400 mb-6 text-left">
    <h4 id="lastWinnerInfo" class="text-yellow-300 text-xl font-semibold mb-3 border-b border-gray-700 pb-2"></h4>
    <div id="lastGameDetailsList" class="space-y-2">
        </div>
</div>
                
                <div id="lobbyStatusContainer" class="hidden bg-blue-900/50 p-4 rounded-lg border border-blue-400 mb-6">
                    <h4 id="lobbyStatusTitle" class="text-blue-300 text-xl font-semibold animate-pulse">Lobi KatÄ±lÄ±ma AÃ§Ä±k!</h4>
                    <p id="lobbyStatusInfo" class="mt-2 text-gray-200"></p>
                    <div id="lobbyPlayerList" class="mt-2 text-sm text-gray-400"></div>
                </div>
                
                <div class="flex justify-around items-center mb-4 bg-gray-900 p-3 rounded-lg">
                    <div id="displayScore" class="hidden">
                        <p class="text-gray-400 text-sm">Toplanan Skor</p>
                        <p id="clickCatchScore" class="text-green-400 font-bold text-lg">0</p>
                    </div>
                    <div id="displaySpecials" class="hidden">
                        <p class="text-gray-400 text-sm">AlÄ±nan Ã–dÃ¼ller</p>
                        <div id="collectedSpecials" class="h-[28px] flex items-center justify-center gap-2"></div>
                    </div>
                    <div id="displayTarget" class="hidden">
                        <p class="text-gray-400 text-sm">Hedef</p>
                        <p id="clickCatchTarget" class="text-purple-400 font-bold text-lg">0 / 10</p>
                    </div>
                    <div id="displayTimer" class="hidden">
                        <p class="text-gray-400 text-sm">Kalan SÃ¼re</p>
                        <p id="clickCatchTimer" class="text-yellow-400 font-bold text-lg">30</p>
                    </div>
                </div>
                <div id="clickCatchGameAreaContainer" class="flex justify-center mb-4">
                    <div id="clickCatchGameArea">
                         <div id="clickCatchStartScreen" class="w-full h-full flex flex-col justify-center items-center bg-black bg-opacity-50">
                            <p class="text-xl mb-6">Oyun Modunu SeÃ§</p>
                            <div class="flex gap-4">
                               <button id="startSoloGameBtn" onclick="startSoloClickCatchGame()" class="py-3 px-10 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-md">Tek Oyna</button>
                               <button id="joinLobbyBtn" onclick="joinLobby()" class="py-3 px-10 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Lobiye KatÄ±l</button>
                            </div>
                        </div>
                        
                        <div id="gameCountdownOverlay" class="absolute inset-0 bg-gray-900/90 hidden flex-col justify-center items-center text-center z-20">
                            <p class="text-6xl font-extrabold text-yellow-400 animate-pulse" id="countdownText"></p>
                        </div>
                        
                        <div id="lobbyGameOverScreen" class="absolute inset-0 bg-gray-900/95 rounded-lg hidden flex flex-col items-center justify-center p-8 text-center border-4 border-gray-700">
                            <h4 id="lobbyGameOverTitle" class="text-white text-3xl font-bold mb-4">Oyun Bitti!</h4>
                            <p id="lobbyGameOverInfo" class="text-xl text-gray-200 mb-6"></p>
                            <button onclick="closeLobbyGameOverScreen()" class="mt-4 py-2 px-6 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
                                Oyun EkranÄ±na DÃ¶n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="tableBox bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 w-full md:flex-1 min-w-[280px] mt-6 mx-auto max-w-2xl">
    <h3 class="text-yellow-400 text-xl font-bold border-b border-gray-600 pb-3 mb-4">TIKLA-YAKALA HAFTALIK SKOR SIRALAMASI ğŸ¯</h3>
    <input type="text" id="searchClickCatchRanking" oninput="loadClickCatchRankings()" placeholder="SÄ±ralamada KullanÄ±cÄ± Ara..." class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
    
    <div id="weeklyResetCountdownContainer" class="hidden text-center bg-purple-900/50 border border-purple-400 text-purple-200 p-3 rounded-lg mb-4">
        <div class="flex justify-center items-center gap-2">
            <span>HaftalÄ±k Liderin Belirlenmesine: <span id="weeklyResetCountdown" class="font-bold text-white tracking-wider"></span></span>
            <button onclick="openWeeklyResetInfoModal()" class="text-blue-400 hover:text-blue-300 transition-colors" title="HaftalÄ±k SÄ±fÄ±rlama HakkÄ±nda Bilgi">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
        </div>
    </div>

    <div id="clickCatchRankings" class="scrollable-list max-h-80 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-900 text-sm leading-relaxed">YÃ¼kleniyor...</div>
</div>
        
        </div>
            
        <div id="storeSection" class="w-full hidden">
          <h3 class="text-yellow-400 text-3xl font-bold mb-2 text-center">MaÄŸaza</h3>
          <div id="storeUserPointInfo" class="text-center mb-6 bg-gray-800 p-3 rounded-lg border border-gray-700 max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
    <div class="text-lg">
        <span class="text-green-400">Puan: <b id="storeCurrentUserBalance">0</b></span> |
        <span class="text-red-400">Harcanan: <b id="storeCurrentUserSpent">0</b></span>
    </div>
    <div class="text-lg">
        <span class="text-purple-400"> Kasa PuanÄ±: <b id="storeCurrentUserKasaBalance">0</b></span>
    </div>
    <button onclick="openPurchaseHistoryModal()" class="py-1 px-4 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg text-sm w-full md:w-auto justify-self-center">
        AlÄ±ÅŸveriÅŸ GeÃ§miÅŸim
    </button>
</div>
          
          <div id="adminStoreManagementButtonContainer" class="text-center mb-6 hidden">
             <button onclick="openNewItemForm()" class="py-2 px-6 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
               Yeni ÃœrÃ¼n Ekle
             </button>
          </div>
        
          <div class="flex border-b border-gray-600 mb-6 max-w-md mx-auto">
            <button id="gameStoreTabBtn" onclick="switchStoreTab('game')" class="flex-1 py-3 text-lg font-bold border-b-2 border-red-500 text-white transition-colors duration-300">Oyun MaÄŸazasÄ±</button>
            <button id="specialStoreTabBtn" onclick="switchStoreTab('special')" class="flex-1 py-3 text-lg font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors duration-300">Ã–zel ÃœrÃ¼n MaÄŸazasÄ±</button>
          </div>
          
          <div id="kasaTransferBolumu" class="bg-gray-900/50 p-6 rounded-xl border-2 border-purple-500 text-center mb-8 max-w-lg mx-auto">
    <div class="flex justify-center items-center gap-4 mb-3">
        <h4 class="text-purple-300 text-2xl font-bold">Puan KasasÄ±</h4>
        <button id="kasaSettingsBtn" onclick="openKasaSettingsModal()" class="hidden py-1 px-3 text-sm bg-gray-600 hover:bg-gray-500 rounded-lg">Ayarlar</button>
    </div>
    <p class="text-gray-400 mb-4">Sezon sÄ±fÄ±rlamasÄ±ndan etkilenmeyecek puanlarÄ±nÄ± buraya aktar. Bu puanlar sadece <b class="text-white">Ã–zel ÃœrÃ¼n MaÄŸazasÄ±'nda</b> kullanÄ±labilir ve sÄ±ralamaya etki etmez.</p>
    <div class="flex items-center gap-4">
        <input type="number" id="kasaTransferInput" min="1" placeholder="MiktarÄ± Girin" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500">
        <button onclick="kasaTransferEt()" class="py-3 px-6 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md whitespace-nowrap">Kasaya Aktar</button>
    </div>
</div>

<div id="kasaSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeKasaSettingsModal()">&times;</button>
    <h4 class="text-purple-300 text-2xl font-bold mb-6">Kasa Transfer AyarlarÄ±</h4>
    <div>
      <label for="minKasaTransferInput" class="block text-sm font-medium text-gray-300 mb-2">Minimum Transfer TutarÄ±</label>
      <input type="number" id="minKasaTransferInput" placeholder="Ã–rn: 1000 (0 yazÄ±lÄ±rsa limit olmaz)" class="box-setting-input">
      <p class="text-xs text-gray-500 mt-1">Bu tutarÄ±n altÄ±ndaki transferlere izin verilmez.</p>
    </div>
    <div class="mt-6">
      <button onclick="saveKasaSettings()" class="w-full py-3 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md">AyarlarÄ± Kaydet</button>
    </div>
  </div>
</div>

<div id="multiplierChoiceModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-yellow-500 w-11/12 max-w-lg text-center relative">
    <h4 class="text-yellow-400 text-2xl font-bold mb-4">âš¡ Ã‡arpan YÃ¼kseltmesi! âš¡</h4>
    <p class="text-gray-300 mb-6" id="multiplierChoiceInfo">YÃ¼kleniyor...</p>
    <div class="flex flex-col sm:flex-row gap-4">
        <button id="choiceConvertBtn" class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">
            </button>
        <button id="choiceCombineBtn" class="flex-1 py-3 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md">
            </button>
    </div>
  </div>
</div>
          
          <div id="gameStoreItemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
            </div>
        
          <div id="specialStoreItemsContainer" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
            </div>
        </div>
        
        <div id="announcementsContent" class="w-full hidden">
            <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">Duyurular</h3>
            
            <div id="adminAnnouncementControls" class="hidden bg-gray-800 p-6 rounded-lg border border-gray-700 mb-8 max-w-2xl mx-auto">
              <h4 id="announcementFormTitle" class="text-yellow-300 text-xl font-semibold mb-4">Yeni Duyuru Yap</h4>
              <textarea id="announcementText" placeholder="Duyuru metnini buraya yazÄ±n... KullanÄ±cÄ±larÄ± etiketlemek iÃ§in @kullaniciadi formatÄ±nÄ± kullanÄ±n." rows="4" class="w-full p-2 mb-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500"></textarea>
              <div class="flex gap-4">
                <button id="postAnnouncementBtn" onclick="postAnnouncement()" class="flex-1 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">DUYURU YAP</button>
                <button id="cancelEditAnnouncementBtn" onclick="resetAnnouncementForm()" class="hidden py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg">Ä°ptal</button>
              </div>
            </div>

            <div id="announcementsList" class="space-y-6 max-w-2xl mx-auto">
                <p class="text-center text-gray-400">Duyurular yÃ¼kleniyor...</p>
            </div>
        </div>
    </div>
</div>
  
<div id="adminStoreModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-60 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-3xl text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button" onclick="closeAdminStoreModal()">&times;</button>
      <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">ÃœrÃ¼n Ekle / DÃ¼zenle</h3>
      <div id="adminStoreControls" class="bg-gray-900 p-6 rounded-lg border border-gray-700 mb-6">
          <div class="mb-4">
            <input type="text" id="newItemName" placeholder="ÃœrÃ¼n AdÄ±" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <textarea id="newItemDescription" placeholder="ÃœrÃ¼n AÃ§Ä±klamasÄ±" rows="3" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300"></textarea>
            <input type="number" id="newItemCost" placeholder="Maliyet (Puan)" min="1" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <input type="number" id="newItemStock" placeholder="Stok Durumu (Opsiyonel, boÅŸ bÄ±rakÄ±lÄ±rsa sÄ±nÄ±rsÄ±z)" min="0" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <select id="newItemType" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
  <option value="">ÃœrÃ¼n Tipi SeÃ§in</option>
  <option value="boxRights">ğŸ“¦ Kutu HakkÄ±</option>
  <option value="wheelTicket">ï¸ğŸ« Ã‡ark Bileti</option>
  <option value="clickCatchTicket">ğŸŸï¸ TÄ±kla-Yakala Bileti</option>
  <option value="tempMultiplier">âœ–ï¸ GeÃ§ici Ã‡arpan</option>
  <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
  <option value="wildcard">ğŸƒ Joker Kart</option>
  <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
  <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
  <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
  <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
  <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
  <option value="special">ğŸš€ Ã–zel ÃœrÃ¼n (Onay Gerektirir)</option>
</select>
            <input type="number" id="newItemValue" placeholder="DeÄŸer (Kutu HakkÄ± Adedi / Ã‡arpan DeÄŸeri / Kalkan SayÄ±sÄ±)" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <input type="number" id="newItemMultiplierDuration" placeholder="Ã‡arpan SÃ¼resi (Kutu SayÄ±sÄ±)" min="1" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white hidden focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            
            <label class="text-gray-300 text-sm block mt-2 mb-1 text-left">Geri SayÄ±m SÃ¼resi (BoÅŸ BÄ±rakÄ±lÄ±rsa SÃ¼resiz):</label>
            <div class="flex gap-2 mb-4">
                <input type="number" id="storeItemCountdownDays" placeholder="GÃ¼n" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <input type="number" id="storeItemCountdownHours" placeholder="Saat" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <input type="number" id="storeItemCountdownMinutes" placeholder="Dakika" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <input type="number" id="storeItemCountdownSeconds" placeholder="Saniye" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>

            <input type="text" id="newItemImageUrl" placeholder="Resim URL (Opsiyonel)" class="w-full p-2 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <button onclick="saveStoreItem()" id="addUpdateStoreItemBtn" class="w-full py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">ÃœRÃœN EKLE</button>
            <button onclick="resetStoreItemForm()" class="w-full py-2 mt-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md hover:-translate-y-1 transition duration-300">Formu Temizle</button>
          </div>
        </div>
  </div>
</div>

<div id="purchaseHistoryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-2xl text-center relative max-h-[90vh]">
        <button class="modal-close-button absolute top-2 right-4 text-white text-4xl leading-none bg-transparent border-none cursor-pointer hover:text-red-500 transition duration-200" onclick="closePurchaseHistoryModal()">&times;</button>
        <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">SatÄ±n Alma GeÃ§miÅŸi</h3>
        <div id="purchaseHistoryList" class="scrollable-list max-h-[70vh] overflow-y-auto">
            <div class='text-center text-gray-400'>SatÄ±n alma geÃ§miÅŸi yÃ¼kleniyor...</div>
        </div>
    </div>
</div>

<div id="boxStatsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-lg text-center relative max-h-[90vh]">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl" onclick="closeBoxStatsModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-4">GÃ¼ncel Tur Kutu AÃ§ma Ä°statistikleri</h4>
      <p class="text-sm text-gray-400 mb-6">Bu istatistikler oyun sÄ±fÄ±rlandÄ±ÄŸÄ±nda temizlenir.</p>
      <div id="boxStatsList" class="scrollable-list max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-lg">
          YÃ¼kleniyor...
      </div>
  </div>
</div>

<div id="globalSurpriseBoxModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-md text-center relative">
        <h4 class="text-yellow-400 text-3xl font-bold mb-4">ğŸ‰ SÃœRPRÄ°Z KUTU! ğŸ‰</h4>
        <div class="text-lg text-gray-200 space-y-3">
            <p><span id="surpriseOpener" class="text-green-400 font-bold text-2xl"></span> adlÄ± kullanÄ±cÄ±,</p>
            <p id="surpriseSourceInfo"></p>
            <p class="text-3xl text-yellow-300 font-extrabold my-4">
                <span id="surprisePoints"></span> Puan
            </p>
            <p id="surpriseMultiplierInfo" class="text-base text-gray-400 -mt-2"></p>
            <p>kazandÄ±!</p>
        </div>
        <button onclick="closeGlobalSurpriseBoxModal()" class="mt-8 w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">
            Tamam
        </button>
    </div>
</div>

<div id="adminPanelModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-2xl border border-yellow-500 w-full max-w-7xl h-[95vh] text-white relative flex flex-col">
    <button class="modal-close-button" onclick="closeAdminPanelModal()">&times;</button>
    
    <div class="flex-shrink-0 mb-4">
      <h3 class="text-yellow-300 text-3xl font-bold text-center">YÃ¶netim Paneli</h3>
      <p class="text-center text-gray-400">TÃ¼m yÃ¶netim araÃ§larÄ± elinizin altÄ±nda.</p>
    </div>

    <div class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto scrollable-list pr-2">
      
      <div class="flex flex-col gap-6">
        <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700">
          <h4 class="text-yellow-200 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Onay Bekleyenler</h4>
          <div class="space-y-4">
            <div>
              <h5 class="text-gray-300 font-bold mb-2">KullanÄ±cÄ±lar</h5>
              <div id="pendingUsers" class="scrollable-list max-h-48 overflow-y-auto p-2 bg-gray-900/50 rounded-md">YÃ¼kleniyor...</div>
            </div>
            <div>
              <h5 class="text-gray-300 font-bold mb-2">Ã–zel ÃœrÃ¼n AlÄ±mlarÄ±</h5>
              <div id="pendingSpecialPurchasesList" class="scrollable-list max-h-48 overflow-y-auto p-2 bg-gray-900/50 rounded-md">YÃ¼kleniyor...</div>
            </div>
          </div>
        </div>

        <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700">
          <h4 class="text-red-400 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Tehlikeli BÃ¶lge</h4>
          <div class="flex flex-wrap gap-3 justify-center">
            <div class="bg-gray-800/80 p-6 rounded-xl border border-green-500">
    <h4 class="text-green-300 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">ğŸ† AylÄ±k Sezon YÃ¶netimi ğŸ‘‘</h4>
    <button onclick="openSeasonManagementModal()" class="w-full py-3 bg-green-800 hover:bg-green-700 text-white font-bold rounded-lg">Sezon AyarlarÄ±nÄ± AÃ§</button>
</div>
<button onclick="forceClientUpdate()" class="w-full py-3 bg-teal-700 hover:bg-teal-600 text-white font-bold rounded-lg text-sm">
    TÃ¼m KullanÄ±cÄ±lara GÃ¼ncellemeyi Zorla
</button>

            <button onclick="restartSystem()" class="flex-1 py-2 px-3 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg text-sm">Sistemi SÄ±fÄ±rla</button>
            <button onclick="clearAllTotalSpentPoints()" class="flex-1 py-2 px-3 bg-purple-800 hover:bg-purple-700 text-white font-bold rounded-lg text-sm">Harcanan PuanlarÄ± Temizle</button>
            <button onclick="clearPurchaseHistory()" class="flex-1 py-2 px-3 bg-pink-800 hover:bg-pink-700 text-white font-bold rounded-lg text-sm">SatÄ±n Alma GeÃ§miÅŸini Sil</button>
          </div>
        </div>
      </div>
      
      <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700 flex flex-col">
        <h4 class="text-yellow-200 text-xl font-semibold mb-4 border-b border-gray-600 pb-2 flex-shrink-0">KullanÄ±cÄ± YÃ¶netimi</h4>
        <div class="flex-shrink-0 mb-4">
          <input type="text" id="searchUser" placeholder="KullanÄ±cÄ± Ara..." oninput="searchUsers()" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500 transition duration-300">
        </div>
        <div id="allUsers" class="flex-grow scrollable-list overflow-y-auto bg-gray-900/50 p-2 rounded-md">YÃ¼kleniyor...</div>
      </div>
      
      <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700">
        <h4 class="text-yellow-200 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Toplu KullanÄ±cÄ± Ä°ÅŸlemleri</h4>
        <div class="space-y-6">
          <div>
            <label for="globalPoint" class="block text-gray-300 mb-1">Toplu Puan Ä°ÅŸlemi</label>
            <input type="number" id="globalPoint" placeholder="Puan MiktarÄ±" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="changeAllPoints(true)" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Ekle</button>
              <button onclick="changeAllPoints(false)" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sil</button>
            </div>
          </div>
          <div>
            <label for="globalBoxRight" class="block text-gray-300 mb-1">Toplu Kutu HakkÄ± Ä°ÅŸlemi</label>
            <input type="number" id="globalBoxRight" placeholder="Kutu HakkÄ± MiktarÄ±" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="changeAllBoxRights(true)" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Ekle</button>
              <button onclick="changeAllBoxRights(false)" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sil</button>
            </div>
          </div>
          <div>
            <label for="globalShield" class="block text-gray-300 mb-1">Toplu Ä°flas KalkanÄ± Ä°ÅŸlemi</label>
            <input type="number" id="globalShield" placeholder="Kalkan MiktarÄ±" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="changeAllShields(true)" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Ekle</button>
              <button onclick="changeAllShields(false)" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sil</button>
            </div>
          </div>
          <div>
            <label for="globalWheelTicket" class="block text-gray-300 mb-1">Toplu Ã‡ark Bileti Ä°ÅŸlemi</label>
            <input type="number" id="globalWheelTicket" placeholder="Bilet MiktarÄ±" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="changeAllWheelTickets(true)" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Ekle</button>
              <button onclick="changeAllWheelTickets(false)" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sil</button>
            </div>
          </div>
          <div>
            <label for="globalClickCatchTicket" class="block text-gray-300 mb-1">Toplu TÄ±kla-Yakala Bileti Ä°ÅŸlemi</label>
            <input type="number" id="globalClickCatchTicket" placeholder="Bilet MiktarÄ±" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="changeAllClickCatchTickets(true)" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Ekle</button>
              <button onclick="changeAllClickCatchTickets(false)" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sil</button>
            </div>
          </div>
          <div>
            <label for="globalMultiplier" class="block text-gray-300 mb-1">Toplu Ã‡arpan Ä°ÅŸlemi</label>
            <input type="number" id="globalMultiplier" placeholder="Ã‡arpan DeÄŸeri (Ã¶rn: 2, 3)" min="2" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <input type="number" id="globalMultiplierUses" placeholder="KullanÄ±m SayÄ±sÄ±" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="setAllMultipliers()" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Uygula</button>
              <button onclick="clearAllMultipliers()" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">SÄ±fÄ±rla</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  <div id="pointAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closePointAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± Puan AyarÄ±: <span id="adjUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut PuanÄ±: <span id="adjUserBalance" class="font-bold"></span></p>
      <input type="number" id="adjAmount" placeholder="Puan MiktarÄ±" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserPoints(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Puan Ekle</button>
        <button onclick="adjustUserPoints(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Puan Ã‡Ä±kar</button>
      </div>
    </div>
</div>

<div id="boxRightAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeBoxRightAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± Kutu HakkÄ± AyarÄ±: <span id="adjBoxRightUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Kutu HakkÄ±: <span id="adjUserBoxRight" class="font-bold"></span></p>
      <input type="number" id="adjBoxRightAmount" placeholder="Kutu HakkÄ± MiktarÄ±" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserBoxRights(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Kutu HakkÄ± Ekle</button>
        <button onclick="adjustUserBoxRights(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Kutu HakkÄ± Ã‡Ä±kar</button>
      </div>
    </div>
</div>

<div id="wheelTicketAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeWheelTicketAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± Ã‡ark Bileti AyarÄ±: <span id="adjWheelTicketUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Ã‡ark Bileti: <span id="adjUserWheelTicket" class="font-bold"></span></p>
      <input type="number" id="adjWheelTicketAmount" placeholder="Bilet MiktarÄ±" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserWheelTickets(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Bilet Ekle</button>
        <button onclick="adjustUserWheelTickets(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Bilet Ã‡Ä±kar</button>
      </div>
    </div>
</div>

<div id="clickCatchTicketAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeClickCatchTicketAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± TÄ±kla-Yakala Bileti AyarÄ±: <span id="adjClickCatchTicketUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Bilet SayÄ±sÄ±: <span id="adjUserClickCatchTicket" class="font-bold"></span></p>
      <input type="number" id="adjClickCatchTicketAmount" placeholder="Bilet MiktarÄ±" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserClickCatchTickets(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Bilet Ekle</button>
        <button onclick="adjustUserClickCatchTickets(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Bilet Ã‡Ä±kar</button>
      </div>
    </div>
</div>

<div id="iflasShieldAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeIflasShieldAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± Ä°flas KalkanÄ± AyarÄ±: <span id="adjIflasShieldUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Ä°flas KalkanÄ±: <span id="adjUserIflasShield" class="font-bold"></span></p>
      <input type="number" id="adjIflasShieldAmount" placeholder="Ä°flas KalkanÄ± MiktarÄ±" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserIflasShields(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Kalkan Ekle</button>
        <button onclick="adjustUserIflasShields(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Kalkan Ã‡Ä±kar</button>
      </div>
    </div>
</div>

<div id="multiplierAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeMultiplierAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± Ã‡arpan AyarÄ±: <span id="adjMultiplierUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Ã‡arpan: <span id="adjUserMultiplier" class="font-bold"></span> (Kalan KullanÄ±m: <span id="adjUserMultiplierUses" class="font-bold"></span>)</p>
      <div class="mb-4">
        <label for="setMultiplierValue" class="block text-left text-gray-300 mb-1">Ã‡arpan DeÄŸeri:</label>
        <input type="number" id="setMultiplierValue" placeholder="Ã‡arpan DeÄŸeri (Ã¶rn: 2, 3, 5)" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
      </div>
      <div class="mb-4">
        <label for="setMultiplierSource" class="block text-left text-gray-300 mb-1">Ã‡arpan KaynaÄŸÄ±:</label>
        <select id="setMultiplierSource" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
          <option value="none">Yok</option>
          <option value="store">MaÄŸaza</option>
          <option value="box">Kutu</option>
        </select>
      </div>
      <div class="mb-6">
        <label for="setMultiplierUses" class="block text-left text-gray-300 mb-1">Kalan KullanÄ±m (Sadece MaÄŸaza Ä°Ã§in):</label>
        <input type="number" id="setMultiplierUses" placeholder="Kalan KullanÄ±m" min="0" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
      </div>
      <div class="flex gap-4 justify-center">
        <button onclick="setMultiplier()" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Ã‡arpanÄ± Ayarla</button>
        <button onclick="resetMultiplier()" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Ã‡arpanÄ± SÄ±fÄ±rla</button>
      </div>
    </div>
</div>

<div id="blockDurationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeBlockDurationModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ±yÄ± Engelle: <span id="blockUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Engelleme SÃ¼resi (Dakika):</p>
      <input type="number" id="blockDuration" placeholder="SÃ¼re (dakika)" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <button onclick="confirmBlockUser()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Engellemeyi Onayla</button>
    </div>
</div>

<div id="blockedMessageModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <h4 class="text-red-500 text-3xl font-bold mb-6">HESABINIZ ENGELLENDÄ°</h4>
      <p id="blockedReason" class="text-lg text-gray-300 mb-4"></p>
      <p id="blockedCountdown" class="text-2xl text-yellow-400 font-semibold"></p>
    </div>
</div>

<div id="kickVerificationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeKickVerificationModal()">&times;</button>
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">Kick KullanÄ±cÄ± AdÄ± DoÄŸrulamasÄ±</h4>
    <p class="text-lg text-gray-300 mb-6">
      KayÄ±t iÅŸleminin son adÄ±mÄ± olarak, hesabÄ±nÄ±zÄ± doÄŸrulamak iÃ§in Kick sohbet kanalÄ±mÄ±za gidip
      <span class="text-green-400 font-bold p-1 bg-gray-900 rounded">!doÄŸrula</span>
      yazarak gÃ¶ndermeniz gerekmektedir. OnaylandÄ±ktan sonra giriÅŸ yapabilirsiniz.
    </p>
    <button onclick="window.open('https://kick.com/popout/weizendtv/chat', '_blank'); closeKickVerificationModal();" class="w-full py-3 bg-green-500 hover:bg-green-400 text-gray-900 font-bold rounded-lg">
      Kick Sohbete Git
    </button>
  </div>
</div>

<div id="passwordResetModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closePasswordResetModal()">&times;</button>
      <div id="resetStep1">
          <h4 class="text-yellow-400 text-2xl font-bold mb-6">Åifre SÄ±fÄ±rlama (AdÄ±m 1/2)</h4>
          <input type="text" id="resetUsername" placeholder="Kick KullanÄ±cÄ± AdÄ±" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <input type="text" id="resetPin" placeholder="6 Haneli PIN" maxlength="6" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <button onclick="verifyResetInfo()" class="w-full py-3 mt-4 bg-red-700 hover:bg-red-600 rounded-lg font-bold">Bilgileri DoÄŸrula</button>
      </div>
      <div id="resetStep3" class="hidden">
          <h4 class="text-yellow-400 text-2xl font-bold mb-6">Yeni Åifre Belirle (AdÄ±m 2/2)</h4>
          <input type="password" id="newPassword" placeholder="Yeni Åifre" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <input type="password" id="newPasswordConfirm" placeholder="Yeni Åifre Tekrar" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <button onclick="updatePassword()" class="w-full py-3 mt-4 bg-red-700 hover:bg-red-600 rounded-lg font-bold">Åifreyi GÃ¼ncelle</button>
      </div>
  </div>
</div>

<div id="generalMessageModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeGeneralMessageModal()">&times;</button>
    <p id="generalMessageContent" class="text-lg text-gray-300 mb-6"></p>
    <button onclick="closeGeneralMessageModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Tamam</button>
  </div>
</div>

<div id="welcomeGiftModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <h4 class="text-yellow-400 text-3xl font-bold mb-4">AramÄ±za HoÅŸ Geldin!</h4>
    <p class="text-lg text-gray-300 mb-6">Weizend Oyun DÃ¼nyasÄ±'na katÄ±ldÄ±ÄŸÄ±n iÃ§in teÅŸekkÃ¼rler! BaÅŸlangÄ±Ã§ olarak sana Ã¶zel bir hediyemiz var.</p>
    <p class="text-2xl text-green-400 font-bold mb-8">ğŸ 3 Kutu AÃ§ma HakkÄ± KazandÄ±n!</p>
    <button onclick="closeWelcomeGiftModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Harika!</button>
  </div>
</div>

<div id="cardSelectionModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-2xl text-center relative">
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">SÃ¼rpriz Kutu! Bir Kart SeÃ§in</h4>
    
    <h4 id="cardSelectionCountdown" class="text-red-500 text-2xl font-bold mb-4">60</h4>

    <div class="card-container grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 justify-center items-center"></div>
  </div>
</div>

<div id="openedBoxInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeOpenedBoxInfoModal()">&times;</button>
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">AÃ§Ä±lan Kutu Bilgisi</h4>
    <div id="openedBoxInfoContent" class="text-lg text-gray-300 mb-6"></div>
    <button onclick="closeOpenedBoxInfoModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Tamam</button>
  </div>
</div>

<div id="globalOpenedBoxInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[100000] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">KUTU AÃ‡ILDI!</h4>
    <div id="globalOpenedBoxInfoContent" class="text-lg text-gray-300 mb-4"></div>
    <p id="globalOpenedBoxCountdown" class="text-xl text-yellow-400 font-semibold"></p>
  </div>
</div>

<div id="userManagementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-xl text-center relative max-h-[90vh] flex flex-col">
    
    <div class="p-8 pb-4 flex-shrink-0">
        <button class="modal-close-button absolute top-2 right-4 text-white text-4xl leading-none bg-transparent border-none cursor-pointer hover:text-red-500 transition duration-200" onclick="closeUserManagementModal()">&times;</button>
        <img id="managedUserAvatar" src="" class="w-24 h-24 rounded-lg mx-auto mb-4 object-contain">
        <h4 class="text-yellow-400 text-2xl font-bold">KullanÄ±cÄ± YÃ¶netimi: <span id="managedUserName"></span></h4>
    </div>

    <div class="overflow-y-auto px-8 pb-8">
        <div id="managedUserDetails" class="text-left text-gray-300 mb-6 space-y-1">
            <p><span id="managedBadgeBalance" class="inline-block w-6 text-center"></span>Mevcut PuanÄ±: <span id="managedUserBalance" class="font-bold text-yellow-300"></span></p>
            <p><span id="managedBadgeHighest" class="inline-block w-6 text-center"></span>Kariyer PuanÄ±: <span id="managedUserHighestBalance" class="font-bold text-green-400"></span></p>
            <p>Kutu HakkÄ±: <span id="managedUserBoxRight" class="font-bold text-green-400"></span></p>
            <p>Åans Ã‡arkÄ± Bileti: <span id="managedUserWheelTickets" class="font-bold text-yellow-400"></span></p>
            <p>TÄ±kla-Yakala Bileti: <span id="managedUserClickCatchTickets" class="font-bold text-fuchsia-400"></span></p>
            <p>Ä°flas KalkanÄ±: <span id="managedUserIflasShield" class="font-bold text-blue-400"></span></p>
            <p>Aktif Ã‡arpan: <span id="managedUserMultiplier" class="font-bold text-purple-400"></span></p>
            <p>Ã‡arpan Kalan KullanÄ±m: <span id="managedUserMultiplierUses" class="font-bold text-purple-400"></span></p>
            <p>Engelli Durumu: <span id="managedUserBlockedStatus" class="font-bold"></span></p>
            <p id="managedUserBlockedCountdownContainer" class="hidden text-red-400">Kalan SÃ¼re: <span id="managedUserBlockedCountdown" class="font-bold"></span></p>
            <hr class="my-3 border-gray-600">
            <p><span id="managedBadgeBox" class="inline-block w-6 text-center"></span>AÃ§Ä±lan Kutu (TÃ¼m Zamanlar): <span id="managedUserBoxesOpened" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeSurprise" class="inline-block w-6 text-center"></span>SÃ¼rpriz Kutu Buldu: <span id="managedUserSurpriseBoxes" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeBomb" class="inline-block w-6 text-center"></span>Bulunan Bomba SayÄ±sÄ±: <span id="managedUserBombCount" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeMultiplier" class="inline-block w-6 text-center"></span>Bulunan Ã‡arpan SayÄ±sÄ±: <span id="managedUserMultiplierFoundCount" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeStore" class="inline-block w-6 text-center"></span>MaÄŸazada Harcanan Puan: <span id="managedUserTotalSpent" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeShield" class="inline-block w-6 text-center"></span>KullanÄ±lan Kalkan SayÄ±sÄ±: <span id="managedUserShieldUsedCount" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeClickCatch" class="inline-block w-6 text-center"></span>TÄ±kla-Yakala Rekoru: <span id="managedUserClickCatchScore" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeWheel" class="inline-block w-6 text-center"></span>Ã‡evrilen Ã‡ark SayÄ±sÄ±: <span id="managedUserWheelSpins" class="font-bold text-fuchsia-400"></span></p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <button onclick="openPointAdjustmentModal(selectedUserForManagement)" class="py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">Puan AyarÄ±</button>
            <button onclick="openBoxRightAdjustmentModal(selectedUserForManagement)" class="py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-md">Kutu HakkÄ± AyarÄ±</button>
            <button onclick="openIflasShieldAdjustmentModal(selectedUserForManagement)" class="py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-lg shadow-md">Ä°flas KalkanÄ± AyarÄ±</button>
            <button onclick="openWheelTicketAdjustmentModal(selectedUserForManagement)" class="py-3 bg-pink-600 hover:bg-pink-500 text-white font-bold rounded-lg shadow-md">Ã‡ark Bileti AyarÄ±</button>
            <button onclick="openClickCatchTicketAdjustmentModal(selectedUserForManagement)" class="py-3 bg-fuchsia-600 hover:bg-fuchsia-500 text-white font-bold rounded-lg shadow-md">TÄ±kla-Yakala Bileti AyarÄ±</button>
            <button onclick="openMultiplierAdjustmentModal(selectedUserForManagement)" class="py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-md">Ã‡arpan AyarÄ±</button>
            <button id="toggleBlockUserBtn" class="py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg shadow-md">Engelle / Engeli KaldÄ±r</button>
            <button onclick="resetUser(selectedUserForManagement)" class="py-3 bg-orange-600 hover:bg-orange-500 text-white font-bold rounded-lg shadow-md">KullanÄ±cÄ±yÄ± SÄ±fÄ±rla</button>
            <button onclick="denyUser(selectedUserForManagement, false, true)" class="py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md lg:col-span-3">KullanÄ±cÄ±yÄ± Sil</button>
        </div>
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 mt-6">
            <h4 class="text-yellow-300 text-xl font-semibold mb-4">Avatar YÃ¶netimi</h4>
            <div id="managedUserAvatarGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 scrollable-list max-h-60 overflow-y-auto p-3 bg-gray-800 rounded-md">
            </div>
        </div>
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 mt-6">
            <h4 class="text-yellow-300 text-xl font-semibold mb-4">KullanÄ±cÄ±nÄ±n SatÄ±n Alma GeÃ§miÅŸi</h4>
            <div id="managedUserPurchaseHistory" class="scrollable-list max-h-60 overflow-y-auto p-3 bg-gray-800 rounded-md">
                <div class='text-center text-gray-400'>SatÄ±n alma geÃ§miÅŸi yÃ¼kleniyor...</div>
            </div>
        </div>
    </div>

  </div>
</div>

<div id="publicUserDetailModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[10001] hidden" onclick="closeModalOnClickOutside(event)">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm rounded-2xl shadow-2xl border border-yellow-500 w-11/12 max-w-2xl text-center relative max-h-[90vh] flex flex-col">
    
    <div class="p-6 pb-4 flex-shrink-0 relative">
        <button class="modal-close-button absolute top-4 right-4 text-gray-400 hover:text-white text-4xl transition-colors" onclick="closePublicUserDetailModal()">&times;</button>

        <div class="flex flex-col items-center gap-4">
            <img id="publicUserAvatar" src="" class="w-28 h-28 rounded-full border-4 border-yellow-400 object-cover">
            <div class="flex flex-col items-center text-center">
                <div id="publicUserProfileBadges" class="flex items-center justify-center gap-2 h-8 mb-2"></div>
                <h4 id="publicUserName" class="text-yellow-300 text-3xl font-bold"></h4>
            </div>
        </div>
        
        <div id="publicUserChampionships" class="hidden w-full max-w-lg mx-auto bg-yellow-900/50 border-2 border-yellow-500 text-yellow-200 p-4 rounded-xl mt-4 space-y-2 text-center shadow-lg">
        </div>
    </div>

    <div class="flex-grow overflow-y-auto scrollable-list p-6 pt-2">
        <div id="publicUserBlockedInfo" class="hidden bg-red-900/50 border border-red-500 text-red-300 p-3 rounded-lg mb-4">
            Bu kullanÄ±cÄ± engellidir. Kalan sÃ¼re: <span id="publicUserBlockedCountdown" class="font-bold"></span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
            <div class="bg-gray-800/70 p-4 rounded-xl border border-gray-700">
                <h5 class="font-bold text-yellow-200 text-xl mb-3 border-b border-gray-600 pb-2">Puan & Envanter</h5>
                <div class="space-y-3 text-gray-300">
                    <p class="flex justify-between items-center"><span> Kasa PuanÄ±:</span> <span id="publicUserKasaBalance" class="font-bold text-purple-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span id="publicBadgeBalance" class="inline-block w-6 text-center"></span>Mevcut PuanÄ±:</span> <span id="publicUserBalance" class="font-bold text-yellow-300 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span id="publicBadgeHighest" class="inline-block w-6 text-center"></span>Kariyer PuanÄ±:</span> <span id="publicUserHighestBalance" class="font-bold text-green-400 text-lg"></span></p>
                    <hr class="border-gray-600 !my-2">
                    <p class="flex justify-between items-center"><span> Kutu HakkÄ±:</span> <span id="publicUserBoxRight" class="font-bold text-green-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span> Åans Ã‡arkÄ± Bileti:</span> <span id="publicUserWheelTickets" class="font-bold text-yellow-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span> TÄ±kla-Yakala Bileti:</span> <span id="publicUserClickCatchTickets" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span> Ä°flas KalkanÄ±:</span> <span id="publicUserIflasShield" class="font-bold text-blue-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span> Aktif Ã‡arpan:</span> <span id="publicUserMultiplier" class="font-bold text-purple-400 text-lg text-right"></span></p>
                </div>
            </div>

            <div class="bg-gray-800/70 p-4 rounded-xl border border-gray-700">
                <h5 class="font-bold text-yellow-200 text-xl mb-3 border-b border-gray-600 pb-2">Oyun Ä°statistikleri</h5>
                <div class="space-y-3 text-gray-300">
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-box"></span>Toplam AÃ§Ä±lan Kutu:</span> <span id="publicUserBoxesOpened" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-wheel"></span>Toplam Ã‡evrilen Ã‡ark:</span> <span id="publicUserWheelSpins" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-clickcatch"></span>TÄ±kla-Yakala Skoru:</span> <span id="publicUserClickCatchScore" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <hr class="border-gray-600 !my-2">
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-surprise"></span>Bulunan SÃ¼rpriz Kutu:</span> <span id="publicUserSurpriseBoxes" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-bomb"></span>Bulunan Bomba SayÄ±sÄ±:</span> <span id="publicUserBombCount" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-multiplier"></span>Bulunan Ã‡arpan SayÄ±sÄ±:</span> <span id="publicUserMultiplierFoundCount" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-shield"></span>KullanÄ±lan Kalkan SayÄ±sÄ±:</span> <span id="publicUserShieldUsedCount" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-store"></span>MaÄŸazada Harcanan Puan:</span> <span id="publicUserTotalSpent" class="font-bold text-fuchsia-400 text-lg"></span></p>
                </div>
            </div>
        </div>
        <button onclick="closePublicUserDetailModal()" class="mt-6 w-full max-w-xs mx-auto py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg transition-colors">Kapat</button>
    </div>
  </div>
</div>
  <div id="inventoryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeInventoryModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Envanterin</h4>
      <div id="inventoryDetails" class="text-left text-gray-300 mb-6 space-y-3 bg-gray-900 p-4 rounded-lg border border-gray-700">
          <p class="flex justify-between items-center"><span>ğŸ“¦ Kutu HakkÄ±:</span> <strong id="inventoryBoxRights" class="text-green-400 text-lg">0</strong></p>
          <p class="flex justify-between items-center"><span>ğŸ¡ Åans Ã‡arkÄ± Bileti:</span> <strong id="inventoryWheelTickets" class="text-yellow-400 text-lg">0</strong></p>
          <p class="flex justify-between items-center"><span>ğŸ¯ TÄ±kla-Yakala Bileti:</span> <strong id="inventoryClickCatchTickets" class="text-fuchsia-400 text-lg">0</strong></p>
          <p class="flex justify-between items-center"><span>ğŸ›¡ï¸ Ä°flas KalkanÄ±:</span> <strong id="inventoryIflasShields" class="text-blue-400 text-lg">0</strong></p>
          <hr class="border-gray-600 my-2">
          <div id="inventoryMultiplierDetails">
              <p>âœ–ï¸ Aktif Ã§arpan yok.</p>
          </div>
      </div>
      <div class="flex gap-4 mt-6">
        <button onclick="openAvatarSelectionModal()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">AvatarlarÄ±m</button>
        <button onclick="closeInventoryModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Kapat</button>
      </div>
  </div>
</div>

<div id="badgeInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-lg text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button" onclick="closeBadgeInfoModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Rozetler ve AnlamlarÄ±</h4>
      <div class="space-y-4 text-left">
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ‘‘</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Kral TacÄ±</strong>
                <p class="text-gray-400">TÃ¼m liderlik rozetlerine (ğŸ¥‡, ğŸ†, ğŸ‰, ğŸ’£, ğŸ›’, âœ–ï¸, ğŸ“¦, ğŸ›¡ï¸, ğŸ¯, ğŸ¡) aynÄ± anda sahip olan kullanÄ±cÄ±ya verilir. En prestijli rozettir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ¥‡</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Mevcut Puan Lideri</strong>
                <p class="text-gray-400">AnlÄ±k olarak en yÃ¼ksek puana sahip olan kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
    <span class="text-3xl w-8 text-center">ğŸ†</span>
    <div>
        <strong class="text-yellow-200 block text-lg">Kariyer Puan Lideri</strong>
        <p class="text-gray-400">Sezon iÃ§inde kazanÄ±lan tÃ¼m puanlarÄ±n toplamÄ±ndan oluÅŸan Kariyer PuanÄ±'nda lider olan kullanÄ±cÄ±ya verilir.</p>
    </div>
</div>
         <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ¯</span>
            <div>
                <strong class="text-yellow-200 block text-lg">TÄ±kla-Yakala Lideri</strong>
                <p class="text-gray-400">TÄ±kla-Yakala puan sÄ±ralamasÄ±nda lider olan oyuncuya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ¡</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Ã‡ark Lideri</strong>
                <p class="text-gray-400">TÃ¼m zamanlarda en Ã§ok Åans Ã‡arkÄ± Ã§eviren kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ“¦</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Kutu AÃ§ma Lideri</strong>
                <p class="text-gray-400">TÃ¼m zamanlarda en Ã§ok kutu aÃ§an kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ‰</span>
            <div>
                <strong class="text-yellow-200 block text-lg">SÃ¼rpriz Kutu Lideri</strong>
                <p class="text-gray-400">TÃ¼m zamanlarda en Ã§ok "SÃ¼rpriz Kutu" bulan kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ’£</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Bomba Lideri</strong>
                <p class="text-gray-400">TÃ¼m zamanlarda en Ã§ok "Ä°flas (Bomba)" kutusu bulan ÅŸanssÄ±z kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">âœ–ï¸</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Ã‡arpan Lideri</strong>
                <p class="text-gray-400">TÃ¼m zamanlarda en Ã§ok "Ã‡arpan" kutusu bulan kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ›’</span>
            <div>
                <strong class="text-yellow-200 block text-lg">AlÄ±ÅŸveriÅŸ Lideri</strong>
                <p class="text-gray-400">MaÄŸazada en Ã§ok puan harcayan kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ›¡ï¸</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Kalkan Lideri</strong>
                <p class="text-gray-400">En Ã§ok "Ä°flas KalkanÄ±" kullanan kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ</span>
            <div>
                <strong class="text-yellow-200 block text-lg">SÃ¼rpriz Kutu Rozeti</strong>
                <p class="text-gray-400">En az bir adet "SÃ¼rpriz Kutu" bulmuÅŸ olan tÃ¼m kullanÄ±cÄ±lara verilir (Liderlik gerektirmez).</p>
            </div>
        </div>
      </div>
  </div>
</div>

<div id="helpModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-3xl text-left relative max-h-[90vh] flex flex-col">
      
      <div class="flex-shrink-0 p-6 border-b border-gray-700 relative">
          <h3 class="text-yellow-400 text-3xl font-bold text-center">Weizend Oyun DÃ¼nyasÄ± Rehberi</h3>
          <button class="modal-close-button" onclick="closeHelpModal()">&times;</button>
      </div>
      
      <div class="overflow-y-auto scrollable-list p-6">
        <div class="space-y-8 text-gray-300">
            
            <div>
                <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ‘‹ Oyuna HoÅŸ Geldin!</h4>
                <p>Weizend Oyun DÃ¼nyasÄ±'na hoÅŸ geldin! Bu rehber, oyundaki tÃ¼m Ã¶zellikleri anlaman ve en iyi stratejileri geliÅŸtirmen iÃ§in hazÄ±rlandÄ±. Temel amacÄ±n puan toplayarak liderlik sÄ±ralamalarÄ±nda yÃ¼kselmek, mini oyunlarda en iyi skorlarÄ± yapmak ve sezonun ÅŸampiyonu olmaktÄ±r.</p>
            </div>

            <hr class="border-gray-700">

            <div>
                <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ† Oyunun Temel AmacÄ±</h4>
                <p class="mb-2">Oyunda iki ana hedef bulunur:</p>
                <ul class="list-disc list-inside mt-2 space-y-2 pl-4">
                    <li><b class="text-green-400">Liderlik TablolarÄ±:</b> "Kariyer PuanÄ±" ve "TÄ±kla-Yakala Skoru" gibi farklÄ± kategorilerde en tepeye tÄ±rmanarak sezonun en iyisi olduÄŸunu kanÄ±tla.</li>
                    <li><b class="text-purple-400">Kart Koleksiyonu AlbÃ¼mÃ¼:</b> Oyunun en bÃ¼yÃ¼k ve en prestijli hedefi! Sezon bitmeden tÃ¼m kartlarÄ± toplayan herkes, admin tarafÄ±ndan belirlenen bÃ¼yÃ¼k Ã¶dÃ¼lleri kazanÄ±r.</li>
                </ul>
            </div>

            <hr class="border-gray-700">

            <div>
                <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ¦ Puan Sistemi ve Ekonomi</h4>
                <p class="mb-2">Oyunda stratejini belirleyecek 3 farklÄ± puan tÃ¼rÃ¼ vardÄ±r:</p>
                 <ul class="list-disc list-inside mt-2 space-y-2 pl-4">
                    <li><b class="text-green-400">Mevcut Puan:</b> Bu, senin <b class="text-white">harcanabilir</b> puanÄ±ndÄ±r. MaÄŸazadan bir ÅŸey satÄ±n aldÄ±ÄŸÄ±nda veya lobi oyunlarÄ±na giriÅŸ Ã¼creti Ã¶dediÄŸinde bu puan dÃ¼ÅŸer. Kutu oyunundan kazandÄ±ÄŸÄ±n ana puan tÃ¼rÃ¼dÃ¼r.</li>
                    <li><b class="text-yellow-200">Kariyer PuanÄ±:</b> Bu, senin <b class="text-white">sÄ±ralama</b> puanÄ±ndÄ±r. Sezon boyunca kazandÄ±ÄŸÄ±n tÃ¼m puanlarÄ±n toplamÄ±nÄ± gÃ¶sterir ve maÄŸazada harcama yapsan bile <b class="text-red-400">asla dÃ¼ÅŸmez</b>. Ana liderlik tablosu bu puana gÃ¶re sÄ±ralanÄ±r.</li>
                    <li><b class="text-purple-300">Kasa PuanÄ±:</b> Sezon sÄ±fÄ±rlamasÄ±ndan etkilenmeyen Ã¶zel bir "banka" hesabÄ±dÄ±r. PuanlarÄ±nÄ± buraya aktararak bir sonraki sezona taÅŸÄ±yabilirsin. Kasa puanlarÄ± sadece "Ã–zel ÃœrÃ¼n MaÄŸazasÄ±"nda kullanÄ±labilir ve sÄ±ralamaya etki etmez.</li>
                </ul>
            </div>

            <hr class="border-gray-700">

            <div>
                <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ² Oyun ModlarÄ± DetaylÄ± AnlatÄ±m</h4>
                <div class="space-y-6">
                    <div>
                        <h5 class="text-xl font-semibold text-red-400 mb-2">ğŸ Kutu Oyunu</h5>
                        <p class="mb-2">Oyunun kalbi ve ana kaynak motorudur. "Kutu HaklarÄ±" kullanarak kutularÄ± aÃ§ar ve iÃ§lerindeki sÃ¼rprizleri keÅŸfedersin. Puan, bilet, kalkan, Ã§arpan ve en Ã¶nemlisi <b class="text-purple-400">kart paketleri</b> buradan Ã§Ä±kar.</p>
                    </div>
                    
                    <div>
                        <h5 class="text-xl font-semibold text-purple-400 mb-2">ğŸƒ Kart Koleksiyonu & Takas PazarÄ±</h5>
                        <p class="mb-2">Koleksiyonu tamamlamak iÃ§in kartlarÄ± doÄŸrudan bulmazsÄ±n; oyun iÃ§inden kazandÄ±ÄŸÄ±n <b class="text-white">Kart Paketlerini</b> aÃ§arak kart elde edersin.</p>
                        <ul class="list-disc list-inside mt-2 space-y-2 pl-4">
                            <li><b>Fazla Kartlar:</b> AynÄ± karttan birden fazla kazandÄ±ÄŸÄ±nda, bunlar "fazla" olarak birikir. Fazla kartlarÄ±nÄ± <b class="text-green-400">Takas PazarÄ±</b>'nda diÄŸer oyuncularla takas ederek eksiklerini tamamlayabilirsin.</li>
                             <li><b>Joker Kart:</b> Ã‡ok nadirdir! Koleksiyon albÃ¼mÃ¼nde eksik olan bir kartÄ±n Ã¼zerine tÄ±klayarak Joker Kart'Ä±nÄ± kullanabilir ve o kartÄ± anÄ±nda envanterine ekleyebilirsin.</li>
                        </ul>
                    </div>

                    <div>
                        <h5 class="text-xl font-semibold text-teal-400 mb-2">ğŸ¡ Åans Ã‡arkÄ±</h5>
                        <p>"Ã‡ark Biletleri" kullanarak Ã§arkÄ± Ã§evir ve birÃ§ok farklÄ± Ã¶dÃ¼lden birini anÄ±nda kazanma ÅŸansÄ± yakala!</p>
                    </div>

                    <div>
                        <h5 class="text-xl font-semibold text-orange-400 mb-2">ğŸ¯ TÄ±kla-Yakala</h5>
                        <p class="mb-2">Ä°ki modu vardÄ±r: <b class="text-white">Tekli Oyun</b> modunda haftalÄ±k liderlik iÃ§in yarÄ±ÅŸÄ±rsÄ±n. <b class="text-white">Lobi Oyunu</b> modunda ise admin tarafÄ±ndan kurulan anlÄ±k bir yarÄ±ÅŸa katÄ±larak bÃ¼yÃ¼k Ã¶dÃ¼lÃ¼ kazanmaya Ã§alÄ±ÅŸÄ±rsÄ±n.</p>
                    </div>
                </div>
            </div>

            <hr class="border-gray-700">

            <div>
                <h4 class="text-2xl font-bold text-yellow-300 mb-3">â­ Ã‡arpan Sistemi: Strateji Rehberi</h4>
                <p class="mb-2">Ã‡arpanlar, oyundaki en stratejik Ã¶ÄŸelerden biridir. Ä°ki ana tÃ¼rÃ¼ vardÄ±r:</p>
                <ul class="list-disc list-inside mt-2 space-y-4 pl-4">
                    <li>
                        <b class="text-white">Tek KullanÄ±mlÄ±k Ã‡arpan (Kutudan Gelen):</b>
                        <ul class="list-circle list-inside ml-4 mt-1">
                            <li>Bir sonraki kutu aÃ§Ä±lÄ±ÅŸÄ±nda <b class="text-green-400">otomatik olarak</b> kullanÄ±lÄ±r.</li>
                            <li>EÄŸer tek kullanÄ±mlÄ±k bir Ã§arpanÄ±n varken kutudan yeni bir tane daha bulursan, ikisinin deÄŸerleri <b class="text-teal-300">otomatik olarak birleÅŸir!</b> (Ã–rn: 2x varken 3x bulursan, yeni Ã§arpanÄ±n tek kullanÄ±mlÄ±k 5x olur).</li>
                        </ul>
                    </li>
                    <li>
                        <b class="text-white">KalÄ±cÄ± Ã‡arpan (MaÄŸaza, Ã–dÃ¼l vb.):</b>
                        <ul class="list-circle list-inside ml-4 mt-1 space-y-1">
                            <li>Birden Ã§ok kullanÄ±m hakkÄ± vardÄ±r ve kutu aÃ§arken kullanÄ±p kullanmamayÄ± <b class="text-yellow-400">sen seÃ§ersin.</b></li>
                            <li>KalÄ±cÄ± bir Ã§arpanÄ±n varken kutudan yeni bir Ã§arpan bulduÄŸunda bir seÃ§im ekranÄ± Ã§Ä±kar:
                                <ul class="list-disc list-inside ml-6 mt-1 text-gray-400">
                                    <li>EÄŸer yeni Ã§arpan <b class="text-green-400">daha gÃ¼Ã§lÃ¼yse</b>, eskisini Kutu HakkÄ±'na Ã§evirip yenisine geÃ§ebilirsin.</li>
                                    <li>EÄŸer yeni Ã§arpan <b class="text-red-400">daha zayÄ±fsa</b>, eskisini koruyup yenisini Kutu HakkÄ±'na Ã§evirebilirsin.</li>
                                    <li>EÄŸer yeni Ã§arpan <b class="text-blue-400">aynÄ± deÄŸerdeyse</b>, mevcut Ã§arpanÄ±nÄ±n kullanÄ±m hakkÄ± otomatik olarak +1 artar.</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <hr class="border-gray-700">

            <div>
                <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ“… Sezonluk SÄ±fÄ±rlama</h4>
                <p class="mb-2">Rekabeti taze tutmak iÃ§in her ay oyun sÄ±fÄ±rlanÄ±r. Ana ekrandaki geri sayÄ±m bittiÄŸinde yeni sezon baÅŸlar.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-red-900/50 p-4 rounded-lg">
                        <h5 class="font-bold text-red-300">Neler SÄ±fÄ±rlanÄ±r? âŒ</h5>
                        <ul class="list-disc list-inside text-sm mt-2">
                            <li>Mevcut Puan ve Kariyer PuanÄ±</li>
                            <li>Kart Koleksiyonu AlbÃ¼mÃ¼ ve Joker Kartlar</li>
                            <li>TÃ¼m oyun istatistikleri (kutu sayÄ±sÄ± vb.)</li>
                            <li>TÃ¼m liderlik tablolarÄ±</li>
                        </ul>
                    </div>
                    <div class="bg-green-900/50 p-4 rounded-lg">
                        <h5 class="font-bold text-green-300">Neler KalÄ±cÄ±dÄ±r? âœ…</h5>
                         <ul class="list-disc list-inside text-sm mt-2">
                            <li>KullanÄ±cÄ± hesaplarÄ±n</li>
                            <li><b class="text-purple-300">Kasa'ya</b> aktardÄ±ÄŸÄ±n puanlar</li>
                            <li>MaÄŸazadan alÄ±nan <b class="text-white">Avatarlar</b></li>
                            <li>KazanÄ±lan <b class="text-yellow-200">Åampiyonluk UnvanlarÄ±</b> (Profilde gÃ¶rÃ¼nÃ¼r)</li>
                            <li>Sezon sonunda hediye edilen envanter</li>
                        </ul>
                    </div>
                </div>
            </div>

            <hr class="border-gray-700">

            <div class="text-center">
                <p class="text-lg">Unutma, oyunun en Ã¶nemli amacÄ± eÄŸlenmek! Liderlik tablolarÄ±nda tÄ±rmanÄ±rken ve koleksiyonunu tamamlarken herkese bol ÅŸans ve iyi oyunlar dileriz!</p>
                <p class="text-2xl mt-2">ğŸ‰ğŸ†ğŸƒ</p>
            </div>

        </div>
      </div>
  </div>
</div>

<div id="avatarSelectionModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-3xl text-center relative max-h-[90vh] flex flex-col">
      <button class="modal-close-button" onclick="closeAvatarSelectionModal()">&times;</button>
      <h3 class="text-blue-300 text-3xl font-bold mb-6">AvatarÄ±nÄ± SeÃ§</h3>
      <div id="avatarGrid" class="flex-grow grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 overflow-y-auto scrollable-list p-4 bg-gray-900 rounded-lg"></div>
  </div>
</div>
</div>
  <div id="boxSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-2xl text-center relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeBoxSettingsModal()">&times;</button>
    <h3 class="text-purple-300 text-3xl font-bold mb-6">Oyun Kutusu AyarlarÄ±</h3>
    
    <div class="flex-grow overflow-y-auto scrollable-list pr-4 space-y-2" id="boxSettingsRowsContainer">
      </div>

    <div class="mt-6 pt-4 border-t border-gray-700">
        <div class="text-lg text-white mb-4">Toplam Kutu SayÄ±sÄ±: <span id="totalBoxCountDisplay" class="font-bold text-yellow-300">0</span></div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <button onclick="addBoxSettingRow()" class="py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">Yeni SatÄ±r Ekle</button>
    <button onclick="resetBoxSettingsToDefault()" class="py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg shadow-md">VarsayÄ±lana DÃ¶ndÃ¼r</button>
    <button onclick="saveBoxSettings()" class="py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">Kaydet ve SÄ±fÄ±rla</button>
</div>
<div class="mt-4 pt-4 border-t border-gray-600 grid grid-cols-1 sm:grid-cols-3 gap-4">
    <button id="toggleGameLockBtn" onclick="toggleGameLock()" class="py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">Oyunu Kilitle</button>
    <button onclick="revealAll()" class="py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-md">TÃ¼m KutularÄ± AÃ§</button>
    <button onclick="resetGame()" class="py-3 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-md">Oyunu SÄ±fÄ±rla</button>
</div>
    </div>
  </div>
</div>
  <div id="soloGameSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-3xl text-left relative max-h-[90vh] flex flex-col">
        <button class="modal-close-button" onclick="closeSoloGameSettingsModal()">&times;</button>
        <h3 class="text-purple-300 text-3xl font-bold mb-6 text-center">TÄ±kla-Yakala YÃ¶netim Paneli</h3>
        <div class="flex-grow overflow-y-auto scrollable-list pr-4">
            <h4 class="text-lg font-semibold text-yellow-300 mb-3 text-center">Tekli Oyun AyarlarÄ±</h4>
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <div>
                        <h5 class="font-semibold text-gray-300 mb-2">SÃ¼re ve GÃ¶rÃ¼nÃ¼m</h5>
                        <label for="soloGameDuration" class="block text-sm font-medium text-gray-400">Oyun SÃ¼resi (saniye)</label>
                        <input type="number" id="soloGameDuration" class="box-setting-input mt-1 mb-3">
                        <label for="soloItemInterval" class="block text-sm font-medium text-gray-400">Yeni Hedef SÄ±klÄ±ÄŸÄ± (ms)</label>
                        <input type="number" id="soloItemInterval" class="box-setting-input mt-1 mb-3">
                        <label for="soloItemDisappearTime" class="block text-sm font-medium text-gray-400">Hedef Kaybolma SÃ¼resi (ms)</label>
                        <input type="number" id="soloItemDisappearTime" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-300 mb-2">Puan DeÄŸerleri</h5>
                        <label for="soloNormalValue" class="block text-sm font-medium text-gray-400">DÃ¼ÅŸÃ¼k Skor (ğŸ¥®)</label>
                        <input type="number" id="soloNormalValue" class="box-setting-input mt-1 mb-3">
                        <label for="soloGoldValue" class="block text-sm font-medium text-gray-400">YÃ¼ksek Skor (ğŸ’°)</label>
                        <input type="number" id="soloGoldValue" class="box-setting-input mt-1 mb-3">
                        <label for="soloBombValue" class="block text-sm font-medium text-gray-400">Bomba CezasÄ± (ğŸ’£)</label>
                        <input type="number" id="soloBombValue" class="box-setting-input mt-1 mb-3">
                        <label for="soloTimeValue" class="block text-sm font-medium text-gray-400">SÃ¼re Bonusu (â°)</label>
                        <input type="number" id="soloTimeValue" class="box-setting-input mt-1">
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 mt-4">
                <h5 class="font-semibold text-gray-300 mb-2">Ã‡Ä±kma Ä°htimalleri (ToplamÄ± 100 olmalÄ±)</h5>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div>
                        <label for="soloNormalChance" class="block text-sm font-medium text-gray-400">ğŸ¥® (%)</label>
                        <input type="number" id="soloNormalChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloGoldChance" class="block text-sm font-medium text-gray-400">ğŸ’° (%)</label>
                        <input type="number" id="soloGoldChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloBombChance" class="block text-sm font-medium text-gray-400">ğŸ’£ (%)</label>
                        <input type="number" id="soloBombChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloTimeChance" class="block text-sm font-medium text-gray-400">â° (%)</label>
                        <input type="number" id="soloTimeChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloSpecialChance" class="block text-sm font-medium text-gray-400">ğŸ (%)</label>
                        <input type="number" id="soloSpecialChance" class="box-setting-input mt-1">
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 mt-4">
                <h5 class="font-semibold text-gray-300 mb-2">Ã‡Ä±kacak Ã–zel Hedef</h5>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="soloSpecialItemType" class="box-setting-input md:col-span-1">
    <option value="boxRight">ğŸ“¦ Kutu HakkÄ±</option>
    <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±)</option>
    <option value="wheelTicket">ğŸ« Ã‡ark Bileti</option>
    <option value="tempMultiplier">âœ–ï¸ Ã‡arpan</option>
    <option value="wildcard">ğŸƒ Joker Kart</option>
    <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
    <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
    <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
    <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
    <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
</select>
                    <div id="soloSpecialValueContainer" class="md:col-span-2 grid grid-cols-2 gap-4">
                        <input type="number" id="soloSpecialValue" class="box-setting-input" placeholder="Adet (Ã¶rn: 1, 5)">
                        <input type="number" id="soloSpecialMultiplierUses" class="box-setting-input hidden" placeholder="KullanÄ±m HakkÄ±">
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <button onclick="saveSoloGameSettings()" class="w-full py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">Tekli Oyun AyarlarÄ±nÄ± Kaydet</button>
            </div>
        </div>
        
        <div class="mt-6 pt-4 border-t-2 border-dashed border-purple-400">
            <h4 class="text-lg font-semibold text-purple-300 mb-3 text-center">ğŸ† HaftalÄ±k Otomatik SÄ±fÄ±rlama YÃ¶netimi</h4>
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-4">
                <div>
                    <label for="weeklyResetEndDateInput" class="block text-sm font-medium text-gray-300 mb-1">HaftalÄ±k SÄ±fÄ±rlama BitiÅŸ Tarihi ve Saati:</label>
                    <input type="datetime-local" id="weeklyResetEndDateInput" class="box-setting-input">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Åampiyon Ã–dÃ¼lÃ¼:</label>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="weeklyPrizeType" class="box-setting-input">
                            <option value="points">Puan</option>
                            <option value="boxRights">Kutu HakkÄ±</option>
                            <option value="wheelTicket">Ã‡ark Bileti</option>
                            <option value="iflasShield">Ä°flas KalkanÄ±</option>
                        </select>
                        <input type="number" id="weeklyPrizeAmount" class="box-setting-input" value="1000" min="1" placeholder="Miktar">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                     <button onclick="saveWeeklyResetSettings()" class="w-full py-2 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md">HaftalÄ±k Geri SayÄ±mÄ± BaÅŸlat/Kaydet</button>
                     <button onclick="stopWeeklyReset()" class="w-full py-2 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-md">Geri SayÄ±mÄ± Ä°ptal Et</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="lobbySettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-lg text-left relative">
        <button class="modal-close-button" onclick="closeLobbySettingsModal()">&times;</button>
        <h3 class="text-blue-300 text-3xl font-bold mb-6 text-center">Lobi YÃ¶netim Paneli</h3>
        
        <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 mb-4">
            <h4 class="text-lg font-semibold text-yellow-300 mb-3">Lobi AyarlarÄ±</h4>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="lobbyEntryFee" class="block text-sm font-medium text-gray-300">GiriÅŸ Ãœcreti (Puan)</label>
                    <input type="number" id="lobbyEntryFee" value="100" class="box-setting-input mt-1">
                </div>
                 <div>
                    <label for="lobbyEntryTickets" class="block text-sm font-medium text-gray-300">GiriÅŸ Ãœcreti (Bilet)</label>
                    <input type="number" id="lobbyEntryTickets" value="0" class="box-setting-input mt-1">
                </div>
                <div>
                    <label for="lobbyTarget" class="block text-sm font-medium text-gray-300">Hedef Skor</label>
                    <input type="number" id="lobbyTarget" value="10" class="box-setting-input mt-1">
                </div>
                 <div>
                    <label for="lobbyPrize" class="block text-sm font-medium text-gray-300">Kazanan Ã–dÃ¼lÃ¼ (Puan)</label>
                    <input type="number" id="lobbyPrize" value="1000" class="box-setting-input mt-1">
                </div>
                 <div class="col-span-2">
                    <label for="lobbyItemInterval" class="block text-sm font-medium text-gray-300">Hedef Ã‡Ä±kma SÄ±klÄ±ÄŸÄ± (ms)</label>
                    <input type="number" id="lobbyItemInterval" value="800" class="box-setting-input mt-1">
                </div>
            </div>
             <button onclick="startLobbyGame()" class="w-full mt-4 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">Lobi Kur ve Beklemeye Al</button>
        </div>

        <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
            <h4 class="text-lg font-semibold text-yellow-300 mb-3">Oyun KontrolÃ¼</h4>
            <div class="flex gap-4">
                <button id="lobbyStartBtn" onclick="triggerLobbyGameStart()" class="flex-1 py-3 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Oyunu BaÅŸlat</button>
                <button onclick="endLobbyGame(true)" class="flex-1 py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">Lobi Ä°ptal Et ve Ãœcretleri Ä°ade Et</button>
            </div>
            <button onclick="resetClickCatchLeaderboard()" class="w-full mt-4 py-2 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-md">HaftalÄ±k SÄ±ralamayÄ± SÄ±fÄ±rla</button>
        </div>
    </div>
</div>
  <div id="spectatorModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-2xl text-center relative">
        <h4 id="spectatorTitle" class="text-yellow-400 text-3xl font-bold mb-4"></h4>
        <p class="text-gray-300 mb-2">KullanÄ±cÄ±nÄ±n bir kart seÃ§mesi bekleniyor...</p>
        <div class="text-2xl font-bold text-red-500 mb-6" id="spectatorCountdown">60</div>
        <div id="spectatorCardContainer" class="card-container grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 justify-center items-center">
            </div>
        <div id="spectatorResultContainer" class="mt-6 min-h-[60px]">
    <p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8"></p>
</div>
    </div>
</div>
  <div id="wheelSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-teal-500 w-11/12 max-w-4xl text-center relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeWheelSettingsModal()">&times;</button>
    <h3 class="text-teal-300 text-3xl font-bold mb-6">Åans Ã‡arkÄ± AyarlarÄ±</h3>
    
    <div class="flex-grow overflow-y-auto scrollable-list pr-4 space-y-2" id="wheelSettingsRowsContainer">
      </div>

    <div class="mt-6 pt-4 border-t border-gray-700">
        <div class="flex flex-col sm:flex-row gap-4">
            <button onclick="addWheelSettingRow()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">Yeni Dilim Ekle</button>
            <button onclick="resetWheelSettingsToDefault()" class="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg shadow-md">VarsayÄ±lana DÃ¶ndÃ¼r</button>
            <button onclick="saveWheelSettings()" class="flex-1 py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">AyarlarÄ± Kaydet</button>
        </div>
    </div>
  </div>
</div>
  <div id="unopenedBoxContentsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-green-700 w-11/12 max-w-lg text-center relative max-h-[90vh]">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl" onclick="closeUnopenedBoxContentsModal()">&times;</button>
      <h4 class="text-green-300 text-2xl font-bold mb-4">KapalÄ± Kutularda Kalanlar</h4>
      <p class="text-sm text-gray-400 mb-6">Bu listede sadece henÃ¼z aÃ§Ä±lmamÄ±ÅŸ kutularÄ±n iÃ§erikleri gÃ¶sterilir.</p>
      <div id="unopenedBoxContentsList" class="scrollable-list max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-lg text-left">
          YÃ¼kleniyor...
      </div>
  </div>
</div>

<div id="newAnnouncementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-md text-center relative">
    <h4 class="text-yellow-400 text-3xl font-bold mb-4">ğŸ“¢ YENÄ° DUYURU! ğŸ“¢</h4>
    <div class="text-lg text-gray-200 space-y-3 bg-gray-900 p-4 rounded-lg max-h-60 overflow-y-auto scrollable-list">
        <p id="newAnnouncementText"></p>
    </div>
    <div class="flex gap-4 mt-8">
        <button onclick="closeNewAnnouncementModal()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">
          Sonra Bak
        </button>
        <button onclick="goToAnnouncements()" class="flex-1 py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">
          Duyuruya Git
        </button>
    </div>
  </div>
</div>
  <div id="dailyRewardModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 rounded-xl shadow-2xl border border-yellow-500 w-11/12 max-w-4xl text-center relative max-h-[90vh] flex flex-col">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl z-20" onclick="closeDailyRewardModal()">&times;</button>
      
      <div class="flex-shrink-0 pt-8 px-8 pb-4">
          <h4 class="text-yellow-400 text-3xl font-bold mb-2">GÃ¼nlÃ¼k Ã–dÃ¼ller</h4>
          <p id="dailyRewardMessage" class="text-lg text-gray-300 mb-6">AÅŸaÄŸÄ±daki Ã¶dÃ¼llerden alabileceklerini topla. Bol ÅŸans!</p>
          <div id="adminDailyRewardManagementButtonContainer" class="text-center mb-6 hidden">
              <button onclick="openNewDailyRewardForm()" class="py-2 px-6 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md">
                  Yeni Ã–dÃ¼l Ekle
              </button>
          </div>
      </div>
      
      <div class="flex-grow overflow-y-auto scrollable-list px-8 pb-8">
          <div id="dailyRewardItemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              </div>
      </div>

  </div>
</div>
  <div id="announcementLikesModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative max-h-[90vh]">
    <button class="modal-close-button" onclick="closeAnnouncementLikesModal()">&times;</button>
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">BeÄŸenen KullanÄ±cÄ±lar</h4>
    <div id="announcementLikesList" class="scrollable-list max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-lg text-left">
      </div>
  </div>
</div>

<div id="adminDailyRewardModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[100] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-3xl text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl" onclick="closeAdminDailyRewardModal()">&times;</button>
      <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">GÃ¼nlÃ¼k Ã–dÃ¼l YÃ¶netimi</h3>
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700">
          <div class="mb-4 space-y-2">
              <input type="text" id="dailyRewardName" placeholder="Ã–dÃ¼l AdÄ± (Ã–rn: 100 Puan)" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              <textarea id="dailyRewardDescription" placeholder="Ã–dÃ¼l AÃ§Ä±klamasÄ±" rows="2" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white"></textarea>
              <select id="dailyRewardType" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
    <option value="">Ã–dÃ¼l Tipi SeÃ§in</option>
    <option value="points">ğŸ’° Puan</option>
    <option value="boxRights">ğŸ“¦ Kutu HakkÄ±</option>
    <option value="wheelTicket">ğŸ« Ã‡ark Bileti</option>
    <option value="clickCatchTicket">ğŸŸï¸ TÄ±kla-Yakala Bileti</option>
    <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
    <option value="tempMultiplier">âœ–ï¸ Ã‡arpan</option>
    <option value="avatar">ğŸ‘¤ Avatar</option>
    <option value="wildcard">ğŸƒ Joker Kart</option>
    <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
    <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
    <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
    <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
    <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
</select>
              
              <div id="dailyRewardAvatarFields" class="hidden space-y-2">
                  <input type="text" id="dailyRewardAvatarName" placeholder="AvatarÄ±n AdÄ±" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="text" id="dailyRewardAvatarImageUrl" placeholder="AvatarÄ±n Resim URL'si" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              </div>
              <input type="number" id="dailyRewardValue" placeholder="DeÄŸer (Puan/Hak Adedi/Kalkan)" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              <input type="number" id="dailyRewardMultiplierUses" placeholder="Ã‡arpan KullanÄ±m HakkÄ±" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white hidden">
              
              <label class="text-gray-300 text-sm block text-left">Ã–dÃ¼l Bekleme SÃ¼resi:</label>
              <div class="flex gap-2">
                  <input type="number" id="dailyRewardCooldownDays" placeholder="GÃ¼n" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="number" id="dailyRewardCooldownHours" placeholder="Saat" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="number" id="dailyRewardCooldownMinutes" placeholder="Dakika" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="number" id="dailyRewardCooldownSeconds" placeholder="Saniye" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              </div>
              
              <input type="text" id="dailyRewardImageUrl" placeholder="Ã–dÃ¼l KartÄ± Resim URL (Opsiyonel)" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
          </div>
          <button onclick="saveDailyReward()" id="saveDailyRewardBtn" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">GÃœNLÃœK Ã–DÃœL OLUÅTUR</button>
          <button onclick="resetDailyRewardForm()" class="w-full py-2 mt-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md hover:-translate-y-1 transition duration-300">Formu Temizle</button>
      </div>
  </div>
</div>
  <div id="wheelLegendModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-md text-center relative max-h-[90vh]">
      <button class="modal-close-button" onclick="closeWheelLegendModal()">&times;</button>
      <h4 class="text-blue-300 text-2xl font-bold mb-6">Ã‡ark Simgeleri ve AnlamlarÄ±</h4>
      <div id="wheelLegendContent" class="space-y-3 text-left scrollable-list max-h-80 overflow-y-auto">
          </div>
  </div>
</div>

  <div id="clickCatchInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeClickCatchInfoModal()">&times;</button>
        <h4 class="text-blue-300 text-2xl font-bold text-center">TÄ±kla-Yakala Oyun Bilgileri</h4>
    </div>

    <div class="overflow-y-auto scrollable-list pr-4 space-y-6 text-gray-300">
        <div>
            <h5 class="text-xl font-bold text-purple-400 mb-2">Tekli Oyun (HaftalÄ±k Skor YarÄ±ÅŸmasÄ±)</h5>
            <p class="mb-2">Bu mod, haftalÄ±k liderlik tablosunda en yÃ¼ksek skoru elde etme yarÄ±ÅŸmasÄ±dÄ±r.</p>
            <ul class="list-disc list-inside space-y-1 pl-2">
                <li>Oyuna girmek <strong>1 TÄ±kla-Yakala Bileti</strong> gerektirir.</li>
                <li>Oyun sÄ±rasÄ±nda topladÄ±ÄŸÄ±nÄ±z skorlar, ana PuanÄ±nÄ±za deÄŸil, o haftaki toplam skorunuza eklenir.</li>
                <li>Hafta sonunda, en yÃ¼ksek skoru yapan oyuncu "HaftanÄ±n Åampiyonu" seÃ§ilir ve <strong>Ã¶zel bir Ã¶dÃ¼l</strong> kazanÄ±r.</li>
                <li>Kazanan seÃ§ildikten sonra, o hafta yarÄ±ÅŸmaya katÄ±lmÄ±ÅŸ olan <strong>tÃ¼m oyunculara +1 Bilet</strong> hediye edilir.</li>
                <li>SÄ±ralama ve tÃ¼m kiÅŸisel skorlar sÄ±fÄ±rlanarak yeni bir haftaya baÅŸlanÄ±r.</li>
            </ul>
        </div>
        <div>
            <h5 class="text-xl font-bold text-green-400 mb-2">Lobi Oyunu (RekabetÃ§i Mod)</h5>
            <p class="mb-2">Admin tarafÄ±ndan kurulan bu mod, diÄŸer oyuncularla gerÃ§ek zamanlÄ± bir skor yarÄ±ÅŸÄ±dÄ±r.</p>
            <ul class="list-disc list-inside space-y-1 pl-2">
                <li>Lobiye katÄ±lmak iÃ§in admin tarafÄ±ndan belirlenen bir <strong>giriÅŸ Ã¼creti</strong> (Puan veya Bilet) Ã¶denir.</li>
                <li>Adminin belirlediÄŸi <strong>hedef skora ilk ulaÅŸan oyuncu</strong> oyunu anÄ±nda kazanÄ±r.</li>
                <li>Kazanan oyuncu, lobideki <strong>bÃ¼yÃ¼k Ã¶dÃ¼lÃ¼n</strong> sahibi olur.</li>
            </ul>
        </div>

        <div>
            <h5 class="text-xl font-bold text-yellow-300 mb-2">TÄ±klanabilir Hedefler ve AnlamlarÄ±</h5>
            <div class="space-y-3">
                <p class="font-semibold text-purple-400">-- Tekli Oyunda GeÃ§erli --</p>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ¥®</span><span><strong>DÃ¼ÅŸÃ¼k Skor:</strong> Oyundaki temel skor kaynaÄŸÄ±nÄ±zdÄ±r.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ’°</span><span><strong>YÃ¼ksek Skor:</strong> Normal hedeften daha fazla skor kazandÄ±rÄ±r.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ’£</span><span><strong>Bomba:</strong> DÄ°KKAT! TÄ±klanÄ±ldÄ±ÄŸÄ±nda toplam skorunuzdan -skor dÃ¼ÅŸÃ¼rÃ¼r.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">â°</span><span><strong>Ekstra SÃ¼re:</strong> Kalan oyun sÃ¼renize bonus saniyeler ekler.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ</span><span><strong>Ã–zel Hedef:</strong> Nadiren belirir. Kutu HakkÄ± (ğŸ“¦), Ä°flas KalkanÄ± (ğŸ›¡ï¸), Joker Kart (ğŸƒ) veya Ã§eÅŸitli Kart Paketleri (ğŸ´ğŸ¥‰ğŸ¥ˆğŸ¥‡ğŸ†) gibi Ã§ok deÄŸerli Ã¶dÃ¼ller kazandÄ±rÄ±r.</span></div>
                <hr class="border-gray-600">
                <p class="font-semibold text-green-400">-- Lobi Oyununda GeÃ§erli --</p>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ¯</span><span><strong>Hedef:</strong> Hedef skora ulaÅŸmak iÃ§in tÄ±klamanÄ±z gereken ana hedeftir. (+1 Skor)</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ’£</span><span><strong>Bomba:</strong> Bu hedefe tÄ±klamak, o anki lobi skorunuzu bir azaltÄ±r. (-1 Skor)</span></div>
            </div>
        </div>
        </div>
  </div>
</div>
  <div id="seasonManagementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-green-500 w-11/12 max-w-3xl text-left relative max-h-[95vh] flex flex-col">
    
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeSeasonManagementModal()">&times;</button>
        <h4 class="text-green-300 text-2xl font-bold text-center">ğŸ† AylÄ±k Sezon YÃ¶netimi ğŸ‘‘</h4>
    </div>

    <div class="overflow-y-auto scrollable-list pr-4 space-y-6">
      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
  <h5 class="text-lg font-semibold text-yellow-300 mb-3">Otomatik Sezon Sonu AyarlarÄ±</h5>
  <div>
    <label for="seasonManagementEndDateInput" class="block text-gray-300 mb-1 text-sm">Sezon BitiÅŸ Tarih ve Saati:</label>
    <input type="datetime-local" id="seasonManagementEndDateInput" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
  </div>
</div>

      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
        <h5 class="text-lg font-semibold text-yellow-300 mb-3">Åampiyon Avatar Ã–dÃ¼lleri</h5>
        <p class="text-xs text-gray-400 mb-3">Bu alanlara URL girilirse, sezon sonunda liderlerin avatarlarÄ± otomatik olarak bu resimlerle gÃ¼ncellenir.</p>
        <div>
          <label for="puanLeaderAvatarUrl" class="block text-gray-300 mb-1 text-sm">Kariyer Puan SÄ±ralamasÄ± 1.'sinin Avatar URL'i:</label>
          <input type="text" id="puanLeaderAvatarUrl" placeholder="https://ornek.com/resim.png" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
        </div>
        <div class="mt-3">
          <label for="rozetLeaderAvatarUrl" class="block text-gray-300 mb-1 text-sm">Liderler SÄ±ralamasÄ± 1.'sinin Avatar URL'i:</label>
          <input type="text" id="rozetLeaderAvatarUrl" placeholder="https://ornek.com/resim.png" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
        </div>
      </div>

      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
        <h5 class="text-lg font-semibold text-yellow-300 mb-3">Genel KatÄ±lÄ±mcÄ± Ã–dÃ¼lleri</h5>
        <p class="text-xs text-gray-400 mb-3">SÄ±fÄ±rlama sonrasÄ± TÃœM KULLANICILARA (ÅŸampiyonlar dahil) verilecek hediye miktarlarÄ±. BoÅŸ bÄ±rakÄ±lÄ±rsa o hediye verilmez.</p>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div>
                <label for="rewardBoxRights" class="block text-gray-300 mb-1 text-sm">ğŸ“¦ Kutu HakkÄ±</label>
                <input type="number" id="rewardBoxRights" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label for="rewardWheelTickets" class="block text-gray-300 mb-1 text-sm">ğŸ¡ Ã‡ark Bileti</label>
                <input type="number" id="rewardWheelTickets" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label for="rewardClickCatchTickets" class="block text-gray-300 mb-1 text-sm">ğŸ¯ TÄ±kla-Yakala Bileti</label>
                <input type="number" id="rewardClickCatchTickets" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label for="rewardIflasShields" class="block text-gray-300 mb-1 text-sm">ğŸ›¡ï¸ Ä°flas KalkanÄ±</label>
                <input type="number" id="rewardIflasShields" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
        </div>
      </div>
      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
        <h5 class="text-lg font-semibold text-yellow-300 mb-3">Eylemler</h5>
        <div class="space-y-3">
            <button onclick="saveAutomaticResetSettings()" class="w-full py-2 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg">Otomatik SÄ±fÄ±rlamayÄ± Ayarla/Kaydet</button>
            <p class="text-xs text-gray-400 text-center">YukarÄ±daki ayarlarÄ± kaydeder ve geri sayÄ±mÄ± baÅŸlatÄ±r.</p>
            <hr class="border-gray-600">
            <button onclick="stopSeasonCountdown()" class="w-full py-2 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg">Otomatik SÄ±fÄ±rlamayÄ± Ä°ptal Et</button>
            <p class="text-xs text-gray-400 text-center">AyarlanmÄ±ÅŸ olan otomatik sÄ±fÄ±rlamayÄ± ve geri sayÄ±mÄ± durdurur.</p>
            <hr class="border-gray-600">
            <button onclick="executeSeasonReset(true)" class="w-full py-3 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg">SEZONU ÅÄ°MDÄ° BÄ°TÄ°R (MANUEL)</button>
            <p class="text-xs text-gray-400 text-center">Geri sayÄ±mÄ± beklemeden, anÄ±nda her ÅŸeyi sÄ±fÄ±rlar ve Ã¶dÃ¼lleri daÄŸÄ±tÄ±r.</p>
        </div>
      </div>
    </div>
  </div>
</div>
  <div id="persistentAnnouncementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[100002] hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-lg text-center relative">
    <h4 id="persistentAnnTitle" class="text-yellow-400 text-3xl font-bold mb-4"></h4>
    <div id="persistentAnnMessage" class="text-lg text-gray-200 space-y-3 bg-gray-800 p-4 rounded-lg max-h-80 overflow-y-auto scrollable-list"></div>
    <button onclick="markPersistentAnnouncementAsSeen()" class="mt-8 w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">
      AnladÄ±m, Kapat
    </button>
  </div>
</div>
  <div id="seasonInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeSeasonInfoModal()">&times;</button>
        <h4 class="text-blue-300 text-2xl font-bold text-center">ğŸ† AylÄ±k Sezon SÄ±fÄ±rlamasÄ± Nedir?</h4>
    </div>

    <div class="overflow-y-auto scrollable-list pr-4 space-y-4 text-gray-300">
        <p>Oyunumuz, her ay rekabeti tazelemek ve tÃ¼m oyunculara yeni bir baÅŸlangÄ±Ã§ ÅŸansÄ± sunmak iÃ§in <strong>Sezonluk SÄ±fÄ±rlama</strong> sistemini kullanÄ±r. Geri sayÄ±m sayacÄ± sona erdiÄŸinde, bir Ã¶nceki sezon biter ve yeni bir sezon baÅŸlar.</p>
        
        <div>
            <h5 class="text-xl font-bold text-yellow-300 mb-2">Sezon BittiÄŸinde Ne Olur?</h5>
            <ul class="list-disc list-inside space-y-2 pl-2">
                <li><strong>Ã–dÃ¼ller DaÄŸÄ±tÄ±lÄ±r:</strong>
                    <ul class="list-circle list-inside pl-4 mt-1 space-y-2">
                        <li>
                            <p>Åampiyonlar dahil, oyundaki <strong>tÃ¼m oyunculara</strong> admin tarafÄ±ndan belirlenen bir <strong>hediye paketi</strong> gÃ¶nderilir.</p>
                            <div id="seasonGiftPackageDetails" class="mt-3 bg-gray-900/50 p-4 rounded-lg border border-gray-600">
                                <p class="text-gray-400">Ã–dÃ¼l detaylarÄ± yÃ¼kleniyor...</p>
                            </div>
                        </li>
                        <li>
                            <p>AyrÄ±ca sÄ±ralamalarda 1. olan ÅŸampiyonlara Ã¶zel Ã¶dÃ¼ller verilir.</p>
                             <div id="seasonChampionPrizes" class="mt-3 bg-gray-900/50 p-4 rounded-lg border border-yellow-600">
                                <p class="text-gray-400">Åampiyon Ã¶dÃ¼lleri yÃ¼kleniyor...</p>
                            </div>
                        </li>
                    </ul>
                </li>
                <li><strong>Her Åey SÄ±fÄ±rlanÄ±r:</strong>
                    <ul class="list-circle list-inside pl-4 mt-1 text-red-400">
                        <li>TÃ¼m kullanÄ±cÄ±larÄ±n <strong>PuanlarÄ±</strong> sÄ±fÄ±rlanÄ±r.</li>
                        <li>TÃ¼m liderlik istatistikleri (aÃ§Ä±lan kutu sayÄ±sÄ±, harcanan puan vb.) sÄ±fÄ±rlanÄ±r.</li>
                        <li>MaÄŸaza satÄ±n alma geÃ§miÅŸleri ve Ã¼rÃ¼nlerin "kaÃ§ kez satÄ±n alÄ±ndÄ±ÄŸÄ±" bilgisi temizlenir.</li>
                        <li><strong class="text-amber-400">Kart Koleksiyonu AlbÃ¼mleri</strong> ve tÃ¼m kart ilerlemeleri sÄ±fÄ±rlanÄ±r.</li>
                    </ul>
                </li>
                 <li><strong>Neler KalÄ±r?</strong>
                    <ul class="list-circle list-inside pl-4 mt-1 text-green-400">
                        <li>KullanÄ±cÄ± hesaplarÄ±nÄ±z, ÅŸifreleriniz ve PIN'leriniz.</li>
                        <li>Kasaya aktarÄ±lan <strong>Kasa PuanlarÄ±</strong>.</li>
                        <li>MaÄŸazadan satÄ±n aldÄ±ÄŸÄ±nÄ±z <strong>Avatarlar</strong> gibi kalÄ±cÄ± kozmetikler.</li>
                        <li>KazanÄ±lan <strong>Koleksiyon ÅampiyonluÄŸu</strong> unvanlarÄ± profilde kalÄ±r.</li>
                        <li>Sezon sonunda hediye edilen envanter eÅŸyalarÄ± (Kutu HaklarÄ±, Biletler vb.) yeni sezona aktarÄ±lÄ±r.</li>
                    </ul>
                </li>
            </ul>
        </div>
        <p class="font-bold text-center text-yellow-200 pt-2 border-t border-gray-700">Yeni sezon, yeni bir baÅŸlangÄ±Ã§ demektir. Herkese bol ÅŸans!</p>
    </div>
  </div>
</div>
<div id="weeklyResetInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeWeeklyResetInfoModal()">&times;</button>
        <h4 class="text-purple-300 text-2xl font-bold text-center">ğŸ¯ HaftalÄ±k TÄ±kla-Yakala SÄ±fÄ±rlamasÄ± Nedir?</h4>
    </div>
    <div class="overflow-y-auto scrollable-list pr-4 space-y-4 text-gray-300">
        <p>TÄ±kla-Yakala oyununda rekabeti canlÄ± tutmak iÃ§in her hafta liderlik tablosu sÄ±fÄ±rlanÄ±r ve Ã¶dÃ¼ller daÄŸÄ±tÄ±lÄ±r. Geri sayÄ±m sayacÄ± sona erdiÄŸinde, bir Ã¶nceki hafta biter ve yeni bir hafta baÅŸlar.</p>
        <div>
            <h5 class="text-xl font-bold text-yellow-300 mb-2">Hafta BittiÄŸinde Ne Olur?</h5>
            <ul class="list-disc list-inside space-y-2 pl-2">
                <li><strong>Åampiyon Belirlenir:</strong> HaftalÄ±k skor tablosunda <strong>1. sÄ±rada</strong> olan oyuncu "HaftanÄ±n Åampiyonu" olur ve admin tarafÄ±ndan belirlenen Ã¶zel Ã¶dÃ¼lÃ¼ kazanÄ±r.</li>
                
                <div id="weeklyWinnerPrizeDetails" class="mt-2 mb-2 bg-gray-900/50 p-4 rounded-lg border border-gray-600">
                    <p class="text-gray-400">Åampiyon Ã¶dÃ¼lÃ¼ yÃ¼kleniyor...</p>
                </div>
                
                <li><strong>KatÄ±lÄ±m Ã–dÃ¼lÃ¼ DaÄŸÄ±tÄ±lÄ±r:</strong> O hafta en az bir kez TÄ±kla-Yakala oynamÄ±ÅŸ olan <strong>tÃ¼m katÄ±lÄ±mcÄ±lara</strong> (ÅŸampiyon dahil) <strong class="text-green-400">+1 TÄ±kla-Yakala Bileti</strong> hediye edilir.</li>
                <li><strong>SÄ±ralama SÄ±fÄ±rlanÄ±r:</strong> TÃ¼m oyuncularÄ±n o haftaki skorlarÄ± ve haftalÄ±k liderlik tablosu tamamen temizlenir. Herkes yeni haftaya eÅŸit ÅŸartlarda baÅŸlar.</li>
            </ul>
        </div>
        <p class="font-bold text-center text-yellow-200 pt-2 border-t border-gray-700">Yeni hafta, yeni bir ÅŸampiyonluk ÅŸansÄ± demektir. Bol ÅŸans!</p>
    </div>
  </div>
</div>

<div id="tradeHistoryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10000] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-indigo-500 w-11/12 max-w-3xl text-left relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeTradeHistoryModal()">&times;</button>
    <h3 class="text-indigo-300 text-3xl font-bold mb-6 text-center">Takas GeÃ§miÅŸi KayÄ±tlarÄ±</h3>
    <div id="tradeHistoryList" class="flex-grow overflow-y-auto scrollable-list pr-4">
      <p class="text-center text-gray-400">Takas kayÄ±tlarÄ± yÃ¼kleniyor...</p>
    </div>
  </div>
</div>

<div id="tradeMarketModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-2xl border border-purple-500 w-11/12 max-w-4xl h-[90vh] text-center relative flex flex-col">
    <button class="modal-close-button" onclick="closeTradeMarketModal()">&times;</button>
    <h3 class="text-purple-300 text-3xl font-bold mb-4 flex-shrink-0">Takas PazarÄ±</h3>
    
    <div class="flex-shrink-0 mb-4 flex flex-col sm:flex-row justify-between items-center gap-4 p-2 bg-gray-800/50 rounded-lg">
        <div class="flex border-b border-gray-700">
            <button id="marketTabAll" onclick="switchMarketTab('all')" class="market-tab-btn flex-1 py-2 px-6 text-base font-bold border-b-2 border-purple-500 text-white">Pazardaki Teklifler</button>
            <button id="marketTabMine" onclick="switchMarketTab('mine')" class="market-tab-btn flex-1 py-2 px-6 text-base font-bold border-b-2 border-transparent text-gray-400">Benim Tekliflerim</button>
        </div>
        <button onclick="openCreateOfferModal()" class="py-2 px-5 bg-green-600 hover:bg-green-500 rounded-lg font-bold text-sm">
            + Yeni Takas Teklifi OluÅŸtur
        </button>
    </div>

    <div id="marketOffersList" class="flex-grow overflow-y-auto scrollable-list pr-2 space-y-3">
        </div>
  </div>
</div>


<div id="createOfferModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10002] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-green-500 w-11/12 max-w-xl text-left relative">
        <button class="modal-close-button" onclick="closeCreateOfferModal()">&times;</button>
        <h3 class="text-green-300 text-3xl font-bold mb-6 text-center">Takas Teklifi OluÅŸtur</h3>
        
        <div class="flex justify-around items-center gap-4">
            <div class="flex-1 text-center">
                <h4 class="font-bold text-yellow-300 mb-2">Teklif EttiÄŸim Kart:</h4>
                <select id="offerMyCardSelect" class="box-setting-input"></select>
            </div>
            
            <span class="text-3xl font-bold text-gray-500">â‡„</span>

            <div class="flex-1 text-center">
                <h4 class="font-bold text-yellow-300 mb-2">Ä°stediÄŸim Kart:</h4>
                <select id="offerRequestCardSelect" class="box-setting-input"></select>
            </div>
        </div>
        <p id="tradeFeeInfo" class="text-center text-sm text-gray-400 mt-6"></p>
        <button onclick="submitTradeOffer()" class="w-full mt-2 py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">TEKLÄ°FÄ° PAZARA KOY</button>
    </div>
</div>

<div id="cardPackOpeningModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex-col justify-center items-center z-[10003] hidden">
    <h2 id="cardPackOpeningTitle" class="text-3xl font-bold text-yellow-300 mb-8 animate-pulse">Kart Paketlerini AÃ§!</h2>
    <div id="cardPackOpeningArea" class="flex flex-wrap justify-center items-center gap-8">
        </div>
</div>

<div id="collectionInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeCollectionInfoModal()">&times;</button>
    <h3 class="text-blue-300 text-3xl font-bold mb-6 text-center">Kart Koleksiyonu Rehberi</h3>
    
    <div class="space-y-4 text-gray-300 overflow-y-auto scrollable-list pr-4">
        <div_>
            <h4 class="font-bold text-lg text-yellow-300">ğŸ† AmaÃ§ Nedir?</h4>
            <p>Oyunun amacÄ±, tÃ¼m kartlarÄ± toplayarak koleksiyon albÃ¼mÃ¼nÃ¼ tamamlamaktÄ±r. AlbÃ¼mÃ¼ tamamlayan herkes, admin tarafÄ±ndan belirlenen bÃ¼yÃ¼k Ã¶dÃ¼lleri kazanÄ±r!</p>
        </div_>
        
        <div>
            <h4 class="font-bold text-lg text-yellow-300">ğŸ´ NasÄ±l Kart KazanÄ±lÄ±r?</h4>
            <p>Koleksiyon kartlarÄ± doÄŸrudan bulunmaz. Bunun yerine, oyunun Ã§eÅŸitli yerlerinden **"Kart Paketi"** kazanÄ±rsÄ±n. Her paket, iÃ§inden rastgele bir koleksiyon kartÄ± Ã§Ä±karÄ±r.</p>
            <ul class="list-disc list-inside ml-4 mt-2">
                <li><b>Kutu Oyunu:</b> KutularÄ± aÃ§arak Kart Paketi bulabilirsin.</li>
                <li><b>Åans Ã‡arkÄ±:</b> Ã‡arkÄ± Ã§evirerek Kart Paketi kazanabilirsin.</li>
                <li><b>MaÄŸaza:</b> PuanlarÄ±nla MaÄŸaza'dan Kart Paketi satÄ±n alabilirsin.</li>
            </ul>
        </div>
        
        <div>
            <h4 class="font-bold text-lg text-yellow-300">â‡„ Fazla Kartlar ve Takas</h4>
            <p>AynÄ± karttan birden fazla kazandÄ±ÄŸÄ±nda, bu kartlar "fazla" olarak birikir. Fazla kartlarÄ±n en Ã¶nemli amacÄ± takas yapmaktÄ±r! **"Takas PazarÄ±"**'na giderek elindeki fazla kartlarÄ±, koleksiyonundaki eksik kartlar karÅŸÄ±lÄ±ÄŸÄ±nda diÄŸer oyuncularla takas edebilirsin.</p>
        </div>

        <div>
            <h4 class="font-bold text-lg text-yellow-300">ğŸƒ Joker Kart Nedir?</h4>
            <p>Joker Kart, oyundaki en nadir ve en Ã¶zel karttÄ±r. Bu kart, koleksiyonundaki herhangi bir eksik kartÄ±n yerine geÃ§er. Eksik bir kartÄ±n Ã¼zerine tÄ±klayarak Joker Kart'Ä±nÄ± kullanabilir ve o kartÄ± anÄ±nda koleksiyonuna ekleyebilirsin!</p>
        </div>

    </div>
  </div>
</div>

<div id="grandPrizeSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-yellow-500 w-11/12 max-w-2xl text-center relative">
    <button class="modal-close-button" onclick="closeGrandPrizeSettingsModal()">&times;</button>
    <h3 class="text-yellow-300 text-3xl font-bold mb-6">BÃ¼yÃ¼k Ã–dÃ¼l AyarlarÄ±</h3>
    
    <div class="space-y-4">
        <p class="text-sm text-gray-400">Koleksiyonu tamamlayan tÃ¼m oyunculara verilecek Ã¶dÃ¼lleri buradan ayarlayÄ±n.</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    <input type="number" id="prizePoints" placeholder="Puan" class="box-setting-input">
    <input type="number" id="prizeBoxRights" placeholder="Kutu HakkÄ±" class="box-setting-input">
    <input type="number" id="prizeIflasShields" placeholder="Ä°flas KalkanÄ±" class="box-setting-input">
    <input type="number" id="prizeWheelTickets" placeholder="Ã‡ark Bileti" class="box-setting-input">
    <input type="number" id="prizeClickCatchTickets" placeholder="T-Y Bileti" class="box-setting-input">
    
    <input type="text" id="prizeAvatarName" placeholder="Ã–dÃ¼l Avatar AdÄ±" class="box-setting-input">
    <input type="text" id="prizeAvatarImageUrl" placeholder="Ã–dÃ¼l Avatar Resim URL" class="box-setting-input lg:col-span-2">

    <input type="text" id="prizeDescription" placeholder="DiÄŸer Ã–dÃ¼l (Ã–rn: VIP)" class="box-setting-input sm:col-span-2 lg:col-span-3">
</div>
        <button onclick="saveGrandPrizeAndCloseModal()" class="w-full mt-3 py-3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded-lg">BÃ¼yÃ¼k Ã–dÃ¼lÃ¼ Kaydet</button>
    </div>
  </div>
</div>
<div id="updateOverlay" style="display: none;">
    <h2 class="text-3xl font-bold text-yellow-400 mb-4">Yeni bir gÃ¼ncelleme mevcut!</h2>
    <p class="text-lg">Oyunun en gÃ¼ncel sÃ¼rÃ¼mÃ¼ne geÃ§iriliyorsunuz...</p>
    <p class="mt-8 text-4xl animate-spin">â³</p>
</div>

<div id="missingCardsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[10002] hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-cyan-500 w-11/12 max-w-4xl h-[90vh] text-center relative flex flex-col">
    <button class="modal-close-button" onclick="closeMissingCardsModal()">&times;</button>
    <h3 id="missingCardsTitle" class="text-cyan-300 text-3xl font-bold mb-4 flex-shrink-0">KullanÄ±cÄ±nÄ±n Eksik KartlarÄ±</h3>
    
    <div id="missingCardsList" class="flex-grow overflow-y-auto scrollable-list pr-2 grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-6 p-4 bg-gray-900/50 rounded-xl border border-gray-700">
        </div>
  </div>
</div>

<div id="forceUpdateModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-90 flex-col justify-center items-center z-[999999] hidden text-center">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-md relative">
    <h2 class="text-3xl font-bold text-yellow-400 mb-4">Yeni GÃ¼ncelleme Mevcut!</h2>
    <p class="text-lg text-gray-200 mb-8">
      Oyunun en son sÃ¼rÃ¼mÃ¼ne ve yeni Ã¶zelliklere eriÅŸmek iÃ§in lÃ¼tfen sayfayÄ± yenileyin.
    </p>
    <button onclick="performForceReload()" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold text-xl rounded-lg shadow-md animate-pulse">
      Åimdi Yenile
    </button>
  </div>
</div>
Â  <script>
Â      document.addEventListener('DOMContentLoaded', () => {
    const typeSelect = document.getElementById('soloSpecialItemType');
    if (typeSelect) {
        typeSelect.addEventListener('change', () => {
            const valueInput = document.getElementById('soloSpecialValue');
            const usesInput = document.getElementById('soloSpecialMultiplierUses');
            if (typeSelect.value === 'tempMultiplier') {
                valueInput.placeholder = 'Ã‡arpan DeÄŸeri (Ã¶rn: 2)';
                usesInput.classList.remove('hidden');
            } else {
                valueInput.placeholder = 'Adet (Ã¶rn: 1, 5)';
                usesInput.classList.add('hidden');
            }
        });
    }
});
Â  // Firebase yapÄ±landÄ±rmasÄ±
Â  const firebaseConfig = {
    apiKey: "AIzaSyAVuyT2Hb7v9omKSgcwtoj0gzjTbXRtQn8",
    authDomain: "weizendtv-oyun.firebaseapp.com",
    databaseURL: "https://weizendtv-oyun-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "weizendtv-oyun",
    storageBucket: "weizendtv-oyun.appspot.com",
    messagingSenderId: "762409187638",
    appId: "1:762409187638:web:6e9888f4bdacfac017db97"
  };

  try {
    firebase.initializeApp(firebaseConfig);
  } catch (e) {
    if (!e.message.includes("already exists")) {
      console.error("Firebase baÅŸlatma hatasÄ±: ", e);
    }
  }

  const db = firebase.database()
  // BU YENÄ° KOD BLOÄUNU OLDUÄU GÄ°BÄ° EKLE

let serverTimeOffset = 0;
db.ref(".info/serverTimeOffset").on("value", function(snapshot) {
    serverTimeOffset = snapshot.val();
});

function getSyncedTime() {
    return Date.now() + serverTimeOffset;
};
  
  
  // --- YENÄ°: Listener (Dinleyici) YÃ¶netimi ---
  let activeListeners = {};
  function detachAllListeners() {
      console.log("TÃ¼m Firebase dinleyicileri kapatÄ±lÄ±yor...");
      for (const key in activeListeners) {
          const listener = activeListeners[key];
          if (listener && listener.ref && listener.event && listener.callback) {
              listener.ref.off(listener.event, listener.callback);
          }
      }
      activeListeners = {};
      console.log("Dinleyiciler kapatÄ±ldÄ±.");
  }
  // --- YENÄ° KOD BÄ°TÄ°Å ---
  const auth = firebase.auth();

  // Global deÄŸiÅŸkenler
  let hasShownLobbyNotification = false;
  let currentUser = null;
  let allUsersCache = [];
  let isAdmin = false;
  let boxes = [];
  const BOX_RIGHTS_COST_PER_BOX = 1;
  let isGameLocked = false; 
  let sessionStartTime = Date.now();
  let latestAnnouncementTimestamp = 0;
  let latestStoreItemTimestamp = 0;
  let newlyAcquiredCards = new Set();

  const defaultAvatarUrl = 'https://i.hizliresim.com/n01dnz4.png?_gl=1*11uaptm*_ga*NTE1MDc3ODEyLjE3Mzg5Mjg1MDk.*_ga_M9ZRXYS2YN*czE3NTQ2OTEwMTgkbzkkZzEkdDE3NTQ2OTEwMjYkajUyJGwwJGgw'; // VarsayÄ±lan profil resmi
  
  const BOX_CONTENTS = [
    { type: 'surpriz', value: 0, count: 1 },
    { type: 'points', value: 1000, count: 2 },
    { type: 'iflas', count: 2 },
    { type: 'points', value: 750, count: 4 },
    { type: 'points', value: 500, count: 6 },
    { type: 'points', value: 250, count: 8 },
    { type: 'points', value: 100, count: 10 },
    { type: 'points', value: 50, count: 15 },
    { type: 'points', value: 10, count: 20 },
    { type: 'points', value: 1, count: 30 },
    { type: 'multiplier', value: 2, count: 1 },
    { type: 'multiplier', value: 3, count: 1 }
  ];
  const TOTAL_BOXES = BOX_CONTENTS.reduce((sum, item) => sum + item.count, 0);

  // Modal elementleri
  const pointAdjustmentModal = document.getElementById('pointAdjustmentModal');
  const boxRightAdjustmentModal = document.getElementById('boxRightAdjustmentModal');
  const iflasShieldAdjustmentModal = document.getElementById('iflasShieldAdjustmentModal');
  const multiplierAdjustmentModal = document.getElementById('multiplierAdjustmentModal');
  const blockDurationModal = document.getElementById('blockDurationModal');
  const blockedMessageModal = document.getElementById('blockedMessageModal');
  const kickVerificationModal = document.getElementById('kickVerificationModal');
  const passwordResetModal = document.getElementById('passwordResetModal');
  const generalMessageModal = document.getElementById('generalMessageModal');
  const welcomeGiftModal = document.getElementById('welcomeGiftModal');
  const cardSelectionModal = document.getElementById('cardSelectionModal');
  const cardContainer = document.querySelector('#cardSelectionModal .card-container');
  const openedBoxInfoModal = document.getElementById('openedBoxInfoModal');
  const adminPanelModal = document.getElementById('adminPanelModal');
  const adminPanelToggleButton = document.getElementById('adminPanelToggleButton');
  const userManagementModal = document.getElementById('userManagementModal');
  const publicUserDetailModal = document.getElementById('publicUserDetailModal'); 
  const inventoryModal = document.getElementById('inventoryModal');
  const globalOpenedBoxInfoModal = document.getElementById('globalOpenedBoxInfoModal');
  const badgeInfoModal = document.getElementById('badgeInfoModal');
  const purchaseHistoryModal = document.getElementById('purchaseHistoryModal');
  const boxStatsModal = document.getElementById('boxStatsModal');
  const spectatorModal = document.getElementById('spectatorModal');
  const dailyRewardModal = document.getElementById('dailyRewardModal');
  const newAnnouncementModal = document.getElementById('newAnnouncementModal');
  const announcementLikesModal = document.getElementById('announcementLikesModal');
  const adminStoreModal = document.getElementById('adminStoreModal');
  const adminDailyRewardModal = document.getElementById('adminDailyRewardModal');
  const wheelTicketAdjustmentModal = document.getElementById('wheelTicketAdjustmentModal');
  const clickCatchTicketAdjustmentModal = document.getElementById('clickCatchTicketAdjustmentModal');
  const boxSettingsModal = document.getElementById('boxSettingsModal');
  const helpModal = document.getElementById('helpModal');
  const avatarSelectionModal = document.getElementById('avatarSelectionModal');

  let targetUserForAdjustment = null;
  let targetUserForBoxRightAdjustment = null;
  let targetUserForIflasShieldAdjustment = null;
  let targetUserForMultiplierAdjustment = null;
  let targetUserForBlock = null;
  let targetUserForWheelTicket = null;
  let targetUserForClickCatchTicket = null;
  let userForPasswordReset = null;
  let selectedUserForManagement = null;
  let countdownInterval = null;
  let cardValues = [1000, 2000, 3000, 4000, 5000];
  let activeBlockedUserTimers = {};
  let activeDailyRewardTimers = {};
  
  let currentCardsToOpen = 0;
  let cardsOpenedInCurrentSurpriseSession = 0;
  let totalPointsGainedInSurpriseSession = 0;
  let surpriseBoxMultiplier = 1;

  let editingItemId = null;
  let currentActiveSection = 'game';

  let storeCountdownInterval = null;
  let activeStoreCountdowns = {};
  
  let editingDailyRewardId = null;
  let editingAnnouncementId = null;
  let activeUserProfileListener = null;
  
  // Åans Ã‡arkÄ± DeÄŸiÅŸkenleri
  const wheel = document.getElementById('wheel');
  const spinBtn = document.getElementById('spinWheelBtn');
  let isWheelSpinning = false;
  let wheelSegments = []; // Bu artÄ±k veritabanÄ±ndan doldurulacak

const defaultWheelSegments = [
    // SÄ±k Gelen Ã–dÃ¼ller
    { type: 'points', value: 100, label: 'ğŸŒ', prizeName: '+100 Puan', color: '#fde047', weight: 20 },
    { type: 'boxRights', value: 1, label: 'ğŸ“¦', prizeName: '+1 Kutu HakkÄ±', color: '#8b5cf6', weight: 15 },
    { type: 'card_pack', value: 1, label: 'ğŸ´', prizeName: '+1 Standart Kart Paketi', color: '#14b8a6', weight: 12 }, 
    { type: 'card_pack_normal', value: 1, label: 'ğŸ¥‰', prizeName: '+1 Bronz Kart Paketi', color: '#a16207', weight: 10 },
    { type: 'points', value: 10, label: 'ğŸ†', prizeName: '+10 Puan', color: '#9ca3af', weight: 10 },
    { type: 'pas', label: 'â˜ ï¸', prizeName: 'Pas', color: '#6b7280', weight: 10 },

    // Orta Seviye Ã–dÃ¼ller
    { type: 'card_pack_gumus', value: 1, label: 'ğŸ¥ˆ', prizeName: '+1 GÃ¼mÃ¼ÅŸ Kart Paketi', color: '#71717a', weight: 8 },
    { type: 'points', value: 250, label: 'ğŸ', prizeName: '+250 Puan', color: '#22c55e', weight: 10 },
    { type: 'iflasShield', value: 1, label: 'ğŸ›¡ï¸', prizeName: '+1 Ä°flas KalkanÄ±', color: '#3b82f6', weight: 8 },
    { type: 'clickCatchTicket', value: 1, label: 'ğŸŸï¸', prizeName: '+1 T-Y Bileti', color: '#ec4899', weight: 8 },
    { type: 'wheelTicket', value: 1, label: 'ğŸ¡', prizeName: 'Bedava Ã‡evirme', color: '#f97316', weight: 8 },
    { type: 'pas', label: 'â˜ ï¸', prizeName: 'Pas', color: '#6b7280', weight: 10 },
    
    // Nadir ve Efsanevi Ã–dÃ¼ller
    { type: 'card_pack_altin', value: 1, label: 'ğŸ¥‡', prizeName: '+1 AltÄ±n Kart Paketi', color: '#f59e0b', weight: 4 },
    { type: 'wildcard', value: 1, label: 'ğŸƒ', prizeName: '+1 Joker Kart', color: '#d946ef', weight: 4 },
    { type: 'tempMultiplier', value: 5, duration: 1, label: 'âœ–ï¸', prizeName: '5X Ã‡arpan', color: '#06b6d4', weight: 2 }, // EKLENEN SATIR
    { type: 'points', value: 1000, label: 'ğŸ‚', prizeName: '+1000 Puan', color: '#ef4444', weight: 2 },
    { type: 'card_pack_efsanevi', value: 1, label: 'ğŸ†', prizeName: '+1 Efsanevi Kart Paketi', color: '#7e22ce', weight: 1 },
    { type: 'surpriseBox', value: 1, label: 'ğŸ‰', prizeName: 'SÃ¼rpriz Kutu', color: '#eab308', weight: 1 }
];
  
  // TÄ±kla Yakala DeÄŸiÅŸkenleri
  let clickCatchGameActive = false;
  let clickCatchScore = 0;
  let clickCatchTimer = 30; // Bu artÄ±k sadece bir baÅŸlangÄ±Ã§ deÄŸeri
  let clickCatchTimerInterval = null;
  let clickCatchItemInterval = null;
  
  // Oyun sonunda eklenecek Ã¶dÃ¼lleri tutan deÄŸiÅŸkenler
  let collectedBoxRights = 0;
  let collectedIflasShields = 0;
  let collectedWheelTickets = 0;
  let collectedCardPacks = [];
  
  // HaftanÄ±n liderini bu deÄŸiÅŸkende tutacaÄŸÄ±z. SÄ±ralama gÃ¼ncellendiÄŸinde bu da gÃ¼ncellenir.
  let clickCatchLeader = null; 
  
  // Tekli oyunun tÃ¼m ayarlarÄ±nÄ± bu obje iÃ§inde toplayacaÄŸÄ±z.
  let soloGameSettings = {
      duration: 30,
      itemDisappearTime: 1200,
      itemInterval: 600,
      bombChance: 40,
      timeChance: 8,
      goldChance: 6,
      specialChance: 4,
      timeValue: 3,
      bombValue: -75,
      goldValue: 100,
      normalValue: 50
  };
  
  // Her oyun baÅŸladÄ±ÄŸÄ±nda rastgele bir Ã¶zel eÅŸya seÃ§ip bu deÄŸiÅŸkene atayacaÄŸÄ±z.
  let specialItemForThisRound = null;

  // GÄ°RÄ°Å/KAYIT SÄ°STEMÄ°
  function switchAuthTab(tab) {
    const loginDiv = document.getElementById('loginDiv');
    const registerDiv = document.getElementById('registerDiv');
    const loginTabBtn = document.getElementById('loginTabBtn');
    const registerTabBtn = document.getElementById('registerTabBtn');

    if (tab === 'login') {
        loginDiv.classList.remove('hidden');
        registerDiv.classList.add('hidden');
        loginTabBtn.classList.add('border-red-500', 'text-white');
        loginTabBtn.classList.remove('border-transparent', 'text-gray-400');
        registerTabBtn.classList.add('border-transparent', 'text-gray-400');
        registerTabBtn.classList.remove('border-red-500', 'text-white');
    } else {
        loginDiv.classList.add('hidden');
        registerDiv.classList.remove('hidden');
        registerTabBtn.classList.add('border-red-500', 'text-white');
        registerTabBtn.classList.remove('border-transparent', 'text-gray-400');
        loginTabBtn.classList.add('border-transparent', 'text-gray-400');
        loginTabBtn.classList.remove('border-red-500', 'text-white');
    }
  }
  
  async function login() {
    const user = document.getElementById("loginUsername").value.trim().toLowerCase();
    const pass = document.getElementById("loginPassword").value.trim();

    if (!user || !pass) {
        displayMessage("KullanÄ±cÄ± adÄ± ve ÅŸifre boÅŸ bÄ±rakÄ±lamaz!");
        return;
    }

    if (user === "weizendtv") {
        const adminEmail = "weizendtv@weizendtvoyun.com";
        try {
            await auth.signInWithEmailAndPassword(adminEmail, pass);
        } catch (error) {
            displayMessage("Admin kullanÄ±cÄ± adÄ± veya ÅŸifresi yanlÄ±ÅŸ!");
        }
        return;
    }

    db.ref('users/' + user).once('value').then(snap => {
        if (!snap.exists()) {
            displayMessage("Hesap bulunamadÄ±. LÃ¼tfen 'KayÄ±t Ol' sekmesinden yeni bir hesap oluÅŸturun.");
            return;
        }
        
        const data = snap.val();
        
        if (data.approved && data.approvalNotified === false) {
            displayMessage(`<b>${user}</b>, hesabÄ±nÄ±z onaylandÄ±. ArtÄ±k giriÅŸ yapabilirsiniz!`);
            db.ref('users/' + user).update({ approvalNotified: true });
            return;
        }

        if (data.password !== pass) {
            displayMessage("Åifre yanlÄ±ÅŸ!");
            return;
        }
        if (!data.approved) {
            displayMessage("HesabÄ±nÄ±z henÃ¼z admin tarafÄ±ndan onaylanmamÄ±ÅŸ. LÃ¼tfen Kick Ã¼zerinden doÄŸrulamayÄ± tamamladÄ±ÄŸÄ±nÄ±zdan emin olun ve bekleyin.");
            return;
        }
        
        // --- YENÄ° EKLENEN SATIR BAÅLANGICI ---
        // KullanÄ±cÄ± adÄ± ve ÅŸifre doÄŸruysa, tarayÄ±cÄ±ya kullanÄ±cÄ± adÄ±nÄ± kaydet.
        localStorage.setItem('weizendOyunUser', user);
        // --- YENÄ° EKLENEN SATIR SONU ---

        checkAndProceedLogin(user, data);

    }).catch(error => {
        console.error("Firebase veritabanÄ± okuma hatasÄ±: ", error);
        displayMessage("GiriÅŸ yaparken bir sorun oluÅŸtu.");
    });
}
  // MEVCUT register fonksiyonunu bununla deÄŸiÅŸtir
async function register() {
    const username = document.getElementById("registerUsername").value.trim().toLowerCase();
    const password = document.getElementById("registerPassword").value.trim();
    const passwordConfirm = document.getElementById("registerPasswordConfirm").value.trim();
    const pin = document.getElementById("registerPin").value.trim();

    if (!username || !password || !passwordConfirm || !pin) {
        displayMessage("LÃ¼tfen tÃ¼m alanlarÄ± eksiksiz doldurun.");
        return;
    }
    if (username.length < 3) {
        displayMessage("KullanÄ±cÄ± adÄ± en az 3 karakter olmalÄ±!");
        return;
    }
    if (password.length < 6) {
        displayMessage("Åifre en az 6 karakter olmalÄ±!");
        return;
    }
    if (password !== passwordConfirm) {
        displayMessage("Åifreler uyuÅŸmuyor!");
        return;
    }
    if (!/^\d{6}$/.test(pin)) {
        displayMessage("PIN, 6 haneli bir rakam olmalÄ±dÄ±r!");
        return;
    }

    const existingUsernameSnap = await db.ref('users/' + username).once('value');
    if (existingUsernameSnap.exists()) {
        displayMessage("Bu Kick kullanÄ±cÄ± adÄ± zaten alÄ±nmÄ±ÅŸ.");
        return;
    }

    const confirmed = await customConfirm(`<b>${username}</b> kullanÄ±cÄ± adÄ±nÄ±n Kick hesabÄ±nÄ±zla aynÄ± olduÄŸuna emin misiniz? Onay sÃ¼reci bu isme gÃ¶re yapÄ±lacaktÄ±r.`);
    if (confirmed) {
        const newUser = {
            password: password,
            pin: pin,
            balance: 0,
            highestBalanceEver: 0,
            kariyerPuani: 0, // YENÄ° EKLENEN SATIR
            totalSpentPoints: 0,
            kutuHakki: 0,
            carkBileti: 0,
            clickCatchTickets: 0,
            clickCatchHighestScore: 0,
            approved: false,
            approvalNotified: null,
            blocked: false,
            blockedUntil: null,
            boxesOpenedCount: 0,
            surpriseBoxesOpened: 0,
            activeMultiplier: 1,
            multiplierSource: 'none',
            multiplierRemainingUses: 0,
            iflasShieldUses: 0,
            registeredAt: new Date().toLocaleString(),
            iflasCount: 0,
            iflasShieldUsedCount: 0,
            multiplierFoundCount: 0,
            storePurchasesCount: 0,
            hasReceivedWelcomeGift: false,
            notifications: {},
            dailyRewardsClaimed: {},
            lastSeenAnnouncementTimestamp: 0,
        };

        db.ref('users/' + username).set(newUser).then(() => {
            openKickVerificationModal();
        }).catch(error => {
            console.error("Firebase kayÄ±t hatasÄ±: ", error);
            displayMessage("KayÄ±t olurken bir hata oluÅŸtu.");
        });
    }
}

  // Åifre SÄ±fÄ±rlama
  function openPasswordResetModal() {
    document.getElementById('resetStep1').classList.remove('hidden');
    document.getElementById('resetStep3').classList.add('hidden');
    document.getElementById('resetUsername').value = '';
    document.getElementById('resetPin').value = '';
    passwordResetModal.style.display = 'flex';
  }

  async function verifyResetInfo() {
      const username = document.getElementById('resetUsername').value.trim().toLowerCase();
      const pin = document.getElementById('resetPin').value.trim();
      
      if (!username || !pin) {
          displayMessage("KullanÄ±cÄ± adÄ± ve PIN gereklidir.");
          return;
      }

      const userSnap = await db.ref('users/' + username).once('value');
      if (!userSnap.exists()) {
          displayMessage("KullanÄ±cÄ± bulunamadÄ±.");
          return;
      }

      const userData = userSnap.val();
      if (userData.pin !== pin) {
          displayMessage("Girilen PIN, kullanÄ±cÄ± ile eÅŸleÅŸmiyor.");
          return;
      }
      
      userForPasswordReset = username;
      document.getElementById('resetStep1').classList.add('hidden');
      document.getElementById('resetStep3').classList.remove('hidden');
  }

  async function updatePassword() {
      const newPass = document.getElementById('newPassword').value.trim();
      const newPassConfirm = document.getElementById('newPasswordConfirm').value.trim();

      if (newPass.length < 6) {
          displayMessage("Yeni ÅŸifre en az 6 karakter olmalÄ±dÄ±r.");
          return;
      }
      if (newPass !== newPassConfirm) {
          displayMessage("Yeni ÅŸifreler uyuÅŸmuyor.");
          return;
      }
      await db.ref('users/' + userForPasswordReset).update({ password: newPass });
      displayMessage("Åifreniz baÅŸarÄ±yla gÃ¼ncellendi. ArtÄ±k giriÅŸ yapabilirsiniz.");
      closePasswordResetModal();
  }
  
  function closePasswordResetModal() {
      passwordResetModal.style.display = 'none';
      userForPasswordReset = null;
  }
  
  function openKickVerificationModal() { kickVerificationModal.style.display = 'flex'; }
  function closeKickVerificationModal() { 
      kickVerificationModal.style.display = 'none'; 
      switchAuthTab('login');
  }
  function closeWelcomeGiftModal() { welcomeGiftModal.style.display = 'none'; }


  // Oturum yÃ¶netimi
  function checkAndProceedLogin(username, userData) {
    if (userData.blocked && userData.blockedUntil && Date.now() >= userData.blockedUntil) {
         db.ref('users/' + username).update({ blocked: false, blockedUntil: null }).then(() => {
            currentUser = username;
            isAdmin = false;
            afterLogin();
         });
         return;
    }
    
    currentUser = username;
    isAdmin = false;
    afterLogin();
  }

 // BU FONKSÄ°YONU BUL VE AÅAÄIDAKÄ°YLE DEÄÄ°ÅTÄ°R
// Sayfa yÃ¼klendiÄŸinde oturum kontrolÃ¼ yapar.
document.addEventListener('DOMContentLoaded', () => {
    auth.onAuthStateChanged(user => {
        // 1. Ã–nce Admin giriÅŸi var mÄ± diye kontrol et (Firebase Auth ile)
        if (user) {
            const firebaseAuthUsername = user.email ? user.email.split('@')[0].toLowerCase() : '';
            if (firebaseAuthUsername === "weizendtv") {
                currentUser = "WeizendTv";
                isAdmin = true;
                afterLogin();
            }
        } 
        // 2. Admin giriÅŸi yoksa, normal kullanÄ±cÄ± giriÅŸi var mÄ± diye kontrol et (localStorage ile)
        else {
            const savedUser = localStorage.getItem('weizendOyunUser');
            if (savedUser) {
                // KayÄ±tlÄ± kullanÄ±cÄ± varsa, veritabanÄ±ndan bilgilerini Ã§ekip doÄŸrula
                db.ref('users/' + savedUser).once('value').then(snap => {
                    if (snap.exists()) {
                        // KullanÄ±cÄ± veritabanÄ±nda varsa, otomatik giriÅŸ yap
                        checkAndProceedLogin(savedUser, snap.val());
                    } else {
                        // KullanÄ±cÄ± silinmiÅŸse, hafÄ±zayÄ± temizle ve giriÅŸ ekranÄ±nÄ± gÃ¶ster
                        localStorage.removeItem('weizendOyunUser');
                        document.getElementById("loginContainer").style.display = "block";
                        document.getElementById("gameDiv").style.display = "none";
                    }
                });
            } 
            // 3. HiÃ§bir giriÅŸ yoksa, giriÅŸ ekranÄ±nÄ± gÃ¶ster
            else {
                document.getElementById("loginContainer").style.display = "block";
                document.getElementById("gameDiv").style.display = "none";
                switchAuthTab('login');
                detachAllListeners(); // GÃ¼venlik iÃ§in tÃ¼m dinleyicileri kapat
            }
        }
    });
});

async function saveWeeklyResetSettings() {
    if (!isAdmin) return;

    const dateInput = document.getElementById('weeklyResetEndDateInput').value;
    const prizeType = document.getElementById('weeklyPrizeType').value;
    const prizeAmount = parseInt(document.getElementById('weeklyPrizeAmount').value);

    if (!dateInput || isNaN(prizeAmount) || prizeAmount <= 0) {
        displayMessage("LÃ¼tfen geÃ§erli bir bitiÅŸ tarihi ve Ã¶dÃ¼l miktarÄ± girin.");
        return;
    }
    
    const settings = {
        endDate: new Date(dateInput).getTime(),
        prize: {
            type: prizeType,
            amount: prizeAmount
        }
    };
    
    await db.ref('gameConfig/weeklyClickCatchReset').set(settings);
    
    displayMessage("HaftalÄ±k otomatik sÄ±fÄ±rlama ayarlarÄ± kaydedildi. Geri sayÄ±m baÅŸlayacak.");
    closeSoloGameSettingsModal();
}

async function stopWeeklyReset() {
    if (!isAdmin) return;

    const confirmed = await customConfirm("Mevcut haftalÄ±k geri sayÄ±mÄ± durdurmak ve ayarlarÄ± silmek istediÄŸinizden emin misiniz?");
    if (!confirmed) return;

    await db.ref('gameConfig/weeklyClickCatchReset').remove();
    displayMessage("HaftalÄ±k otomatik sÄ±fÄ±rlama iptal edildi.");
    closeSoloGameSettingsModal();
}

function listenForWeeklyCountdown() {
    const countdownContainer = document.getElementById('weeklyResetCountdownContainer');
    const countdownEl = document.getElementById('weeklyResetCountdown');
    const ref = db.ref('gameConfig/weeklyClickCatchReset');

    const callback = snap => {
        if (weeklyCountdownInterval) clearInterval(weeklyCountdownInterval);

        const settings = snap.val();

        if (!settings || !settings.endDate || settings.endDate < getSyncedTime()) {
            countdownContainer.classList.add('hidden');
            return;
        }

        countdownContainer.classList.remove('hidden');

        const updateTimer = () => {
            const now = getSyncedTime();
            const timeLeft = settings.endDate - now;

            if (timeLeft <= 0) {
                countdownEl.textContent = "HAFTA BÄ°TTÄ°!";
                clearInterval(weeklyCountdownInterval);
                
                // --- DEÄÄ°ÅÄ°KLÄ°K BURADA ---
                // ArtÄ±k sadece adminin deÄŸil, herhangi bir kullanÄ±cÄ±nÄ±n tarayÄ±cÄ±sÄ±
                // bu iÅŸlemi tetikleyebilir. Ancak sistem, iÅŸlemi sadece bir kez
                // yapacak ÅŸekilde ayarlandÄ±ÄŸÄ± iÃ§in sorun olmaz.
                executeWeeklyReset(); 
                // --- DEÄÄ°ÅÄ°KLÄ°K SONA ERDÄ° ---

                return;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            countdownEl.textContent = `${days}g ${hours}s ${minutes}d ${seconds}sn`;
        };

        updateTimer();
        weeklyCountdownInterval = setInterval(updateTimer, 1000);
    };

    if (activeListeners.weeklyCountdown) {
        activeListeners.weeklyCountdown.ref.off('value', activeListeners.weeklyCountdown.callback);
    }
    activeListeners.weeklyCountdown = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// MEVCUT executeWeeklyReset fonksiyonunu bununla deÄŸiÅŸtir
async function executeWeeklyReset() {
    if (!isAdmin) return;
    console.log("HaftalÄ±k sÄ±fÄ±rlama iÅŸlemi tetiklendi...");
    const seasonEndDateSnap = await db.ref('gameConfig/seasonEndDate').once('value');
    if (seasonEndDateSnap.exists()) {
        const seasonEndDate = seasonEndDateSnap.val();
        if (seasonEndDate - Date.now() < 5 * 60 * 1000) {
            console.log("AylÄ±k sezon sÄ±fÄ±rlamasÄ± yakÄ±n. HaftalÄ±k sÄ±fÄ±rlama atlandÄ±.");
            await db.ref('gameConfig/weeklyClickCatchReset').remove();
            return;
        }
    }
    const weeklyScoresSnap = await db.ref('clickCatchWeeklyScores').once('value');
    if (!weeklyScoresSnap.exists()) {
        console.log("SÄ±ralama boÅŸ, sÄ±fÄ±rlama iÅŸlemi iptal edildi.");
        await db.ref('gameConfig/weeklyClickCatchReset').remove();
        return;
    }
    const scores = [];
    weeklyScoresSnap.forEach(child => {
        scores.push({ username: child.key, score: child.val() });
    });
    scores.sort((a, b) => b.score - a.score);
    const winner = scores[0];
    const participants = scores.map(s => s.username);
    const settingsSnap = await db.ref('gameConfig/weeklyClickCatchReset').once('value');
    const settings = settingsSnap.val();
    if (!settings || !settings.prize) {
        console.error("Ã–dÃ¼l ayarlarÄ± bulunamadÄ±, sÄ±fÄ±rlama iptal edildi.");
        return;
    }
    const prize = settings.prize;
    const prizeNames = { boxRights: "Kutu HakkÄ±", points: "Puan", wheelTicket: "Ã‡ark Bileti", iflasShield: "Ä°flas KalkanÄ±" };
    const prizeName = prizeNames[prize.type];
    await db.ref('gameStats/weeklyClickCatchWinner').set({
        winnerName: winner.username,
        winningScore: winner.score,
        prizeAwarded: `${prize.amount} ${prizeName}`,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    const allUsersSnap = await db.ref('users').once('value');
    const allUsers = allUsersSnap.val();
    const updates = {};
    for (const username in allUsers) {
        if (!allUsers[username].approved) continue;
        const userPath = `/users/${username}`;
        if (allUsers[username].clickCatchHighestScore) {
            updates[`${userPath}/clickCatchHighestScore`] = 0;
        }
        if (participants.includes(username)) {
            updates[`${userPath}/clickCatchTickets`] = (allUsers[username].clickCatchTickets || 0) + 1;
        }
        if (username === winner.username) {
            if (prize.type === 'points') {
                updates[`${userPath}/balance`] = (allUsers[username].balance || 0) + prize.amount;
                // KARÄ°YER PUANI GÃœNCELLEMESÄ°
                updates[`${userPath}/kariyerPuani`] = (allUsers[username].kariyerPuani || 0) + prize.amount;
            } else {
                const prizeKey = prize.type === 'iflasShield' ? 'iflasShieldUses' : prize.type;
                updates[`${userPath}/${prizeKey}`] = (allUsers[username][prizeKey] || 0) + prize.amount;
            }
        }
    }
    updates['/clickCatchWeeklyScores'] = null;
    updates['/gameConfig/weeklyClickCatchReset'] = null;
    await db.ref().update(updates);
    const notificationMessage = `TÄ±kla-Yakala haftasÄ±nÄ±n ÅŸampiyonu ${winner.username} oldu! Yeni hafta baÅŸladÄ± ve tÃ¼m katÄ±lÄ±mcÄ±lara +1 bilet hediye edildi!`;
    db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
    console.log("HaftalÄ±k sÄ±fÄ±rlama baÅŸarÄ±yla tamamlandÄ±.");
}

  // MEVCUT afterLogin FONKSÄ°YONUNU SÄ°L VE BUNUNLA DEÄÄ°ÅTÄ°R
async function afterLogin() {
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("gameDiv").style.display = "block";
    
    document.getElementById("currentUser").textContent = currentUser;
    document.getElementById("role").textContent = isAdmin ? "(Admin)" : "";
    document.getElementById("inventoryButton").style.display = isAdmin ? 'none' : 'inline-block';

    if (isAdmin) {
      document.getElementById('adminPanelToggleButton').classList.remove('hidden');
      document.getElementById('boxSettingsButton').classList.remove('hidden');
      document.getElementById('currentUserAvatar').src = 'https://i.hizliresim.com/mtwdr1x.png?_gl=1*1vzhmma*_ga*MTA2NTkzNzE4OC4xNzQ3MTQ1Mzk0*_ga_M9ZRXYS2YN*czE3NTUxNzY3MTckbzEwJGcxJHQxNzU1MTc3NTAwJGozNyRsMCRoMA..';
    } else {
      document.getElementById('adminPanelToggleButton').classList.add('hidden');
      document.getElementById('boxSettingsButton').classList.add('hidden');
      
      const userSnap = await db.ref('users/' + currentUser).once('value');
      const userData = userSnap.val();
      const avatarUrl = userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;
      document.getElementById('currentUserAvatar').src = avatarUrl;
    }

    showSection('game');
    await loadWheelSettingsFromDB();
    renderWheel();
    
    loadBalanceAndBoxRights();
    loadUserRankingsAndBoxCounts();
    loadLeaderboardRanking();
    loadBoxes();
    loadTotalOpenedBoxesCount();
    loadAnnouncements();
    loadClickCatchRankings();
    listenForGameChanges();
    listenForSurpriseBox();
    listenForDailyRewardChanges();
    initActivityFeed();
    listenForGlobalNotifications();
    listenForLobbyChanges();
    listenForWeeklyWinner(); 
    listenForSeasonCountdown();
    listenForWeeklyCountdown();
    listenForPersistentAnnouncement();
    listenForLastSurpriseFinderPanel();
    listenForLastWheelSurprisePanel();
    listenForForceUpdateSignal();
    
    if (!isAdmin) {
        listenForAdminNotifications();
        listenForNewAnnouncements(); 
        listenForNewStoreItems(); 
        checkAvailableDailyRewards();

        const userRef = db.ref('users/' + currentUser);
        userRef.once('value').then(snap => {
            const userData = snap.val();
            if (userData && userData.hasReceivedWelcomeGift === false) {
                welcomeGiftModal.style.display = 'flex';
                userRef.update({
                    kutuHakki: (userData.kutuHakki || 0) + 3,
                    hasReceivedWelcomeGift: true
                });
            }
        });
    }
}

  function switchStoreTab(tab) {
    const gameStoreContainer = document.getElementById('gameStoreItemsContainer');
    const specialStoreContainer = document.getElementById('specialStoreItemsContainer');
    const gameTabBtn = document.getElementById('gameStoreTabBtn');
    const specialTabBtn = document.getElementById('specialStoreTabBtn');

    if (tab === 'game') {
        gameStoreContainer.classList.remove('hidden');
        specialStoreContainer.classList.add('hidden');
        gameTabBtn.classList.add('border-red-500', 'text-white');
        gameTabBtn.classList.remove('border-transparent', 'text-gray-400');
        specialTabBtn.classList.add('border-transparent', 'text-gray-400');
        specialTabBtn.classList.remove('border-red-500', 'text-white');
    } else { // special
        gameStoreContainer.classList.add('hidden');
        specialStoreContainer.classList.remove('hidden');
        specialTabBtn.classList.add('border-red-500', 'text-white');
        specialTabBtn.classList.remove('border-transparent', 'text-gray-400');
        gameTabBtn.classList.add('border-transparent', 'text-gray-400');
        gameTabBtn.classList.remove('border-red-500', 'text-white');
    }
  }
  /**
 * Ana iÃ§erik alanÄ±ndaki bÃ¶lÃ¼mleri (oyun, maÄŸaza, kartlar vb.) yÃ¶netir.
 * Ã–nce tÃ¼m bÃ¶lÃ¼mleri gizler, sonra sadece isteneni gÃ¶sterir.
 * Ä°lgili sekme butonunu aktif olarak iÅŸaretler ve bÃ¶lÃ¼me Ã¶zel fonksiyonlarÄ± Ã§alÄ±ÅŸtÄ±rÄ±r.
 * @param {string} sectionId - GÃ¶sterilecek bÃ¶lÃ¼mÃ¼n kimliÄŸi (Ã¶rn: 'game', 'store', 'cardCollection').
 */
// MEVCUT showSection FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
function showSection(sectionId) {
    // Kart koleksiyonu sekmesinden baÅŸka bir sekmeye geÃ§ildiÄŸinde "YENÄ°" etiketini temizle
    if (currentActiveSection === 'cardCollection' && sectionId !== 'cardCollection') {
        newlyAcquiredCards.clear();
    }

    // TÃ¼m iÃ§erik alanlarÄ±nÄ± ve sekme butonlarÄ±nÄ± sÄ±fÄ±rla
    const contentIds = ['gameContent', 'storeSection', 'announcementsContent', 'chanceWheelContent', 'clickCatchContent', 'cardCollectionContent'];
    const tabButtonIds = ['gameTabBtn', 'storeTabBtn', 'announcementsTabBtn', 'chanceWheelTabBtn', 'clickCatchTabBtn', 'cardCollectionTabBtn'];

    contentIds.forEach(id => document.getElementById(id)?.classList.add('hidden'));
    tabButtonIds.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.classList.remove('bg-red-700', 'hover:bg-red-600');
            btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
        }
    });
    
    // Sadece istenen iÃ§eriÄŸi ve sekme butonunu aktif et
    document.getElementById(`${sectionId}Content`)?.classList.remove('hidden');
    // Not: BazÄ± bÃ¶lÃ¼mlerin hem '...Content' hem de '...Section' ID'si olabilir, bu yÃ¼zden ikisini de kontrol ediyoruz.
    document.getElementById(`${sectionId}Section`)?.classList.remove('hidden');

    const activeBtn = document.getElementById(`${sectionId}TabBtn`);
    if (activeBtn) {
        activeBtn.classList.add('bg-red-700', 'hover:bg-red-600');
        activeBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
    }

    // BÃ¶lÃ¼me Ã¶zel admin panellerini varsayÄ±lan olarak gizle
    document.getElementById('adminStoreManagementButtonContainer').classList.add('hidden');
    document.getElementById('adminAnnouncementControls').classList.add('hidden');
    document.getElementById('clickCatchAdminButtonsContainer')?.classList.add('hidden');
    document.getElementById('adminCardCollectionControls')?.classList.add('hidden');
    document.getElementById('kasaSettingsBtn')?.classList.add('hidden');

    // Hangi sekmeye tÄ±klandÄ±ysa ona Ã¶zel fonksiyonlarÄ± Ã§alÄ±ÅŸtÄ±r
    if (sectionId === 'store') {
        loadStoreItems();
        if (isAdmin) {
            document.getElementById('adminStoreManagementButtonContainer').classList.remove('hidden');
            document.getElementById('kasaSettingsBtn').classList.remove('hidden');
        } else {
            document.getElementById('storeIndicator').classList.add('hidden');
            db.ref(`users/${currentUser}/lastSeenStoreTimestamp`).set(latestStoreItemTimestamp);
        }
        switchStoreTab('game'); 
    } else if (sectionId === 'announcements') {
        loadAnnouncements();
        if (isAdmin) {
            document.getElementById('adminAnnouncementControls').classList.remove('hidden');
        } else {
            document.getElementById('announcementIndicator').classList.add('hidden');
            db.ref(`users/${currentUser}/lastSeenAnnouncementTimestamp`).set(latestAnnouncementTimestamp);
        }
    } else if (sectionId === 'clickCatch') {
        loadClickCatchRankings();
        listenForLastGameSummary(); 
        if (isAdmin) {
            document.getElementById('clickCatchAdminButtonsContainer').classList.remove('hidden');
            loadSoloGameSettings(); 
        }
    } else if (sectionId === 'chanceWheel') {
        loadWheelHistory();
        const wheelSettingsBtn = document.getElementById('wheelSettingsButton');
        if (isAdmin) {
            wheelSettingsBtn.classList.remove('hidden');
        } else {
            wheelSettingsBtn.classList.add('hidden');
        }
    } else if (sectionId === 'cardCollection') {
        loadCollectionAlbum();
        loadGrandPrizeDisplay();
        loadCollectionLeaderboard(); // Koleksiyon liderlik sÄ±ralamasÄ±nÄ± yÃ¼kle
        if (isAdmin) {
            document.getElementById('adminCardCollectionControls').classList.remove('hidden');
            loadMarketSettingsForAdmin();
            loadPrizeSettingsForAdmin();
        }
    }
    
    currentActiveSection = sectionId;
}
  
  // Admin panel
  function openAdminPanelModal() { 
    document.body.classList.add('modal-open'); // BU SATIRI EKLE
    adminPanelModal.style.display = 'flex'; 
    loadPendingUsers(); 
    loadAllUsers(); 
    loadPendingSpecialPurchases();
  }
  function closeAdminPanelModal() { 
    document.body.classList.remove('modal-open'); // BU SATIRI EKLE
    adminPanelModal.style.display = 'none'; 
  }
    

async function logout() {
    const confirmed = await customConfirm("Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?");
    if (!confirmed) return;

    // --- YENÄ° EKLENEN SATIR BAÅLANGICI ---
    // Ã‡Ä±kÄ±ÅŸ yaparken tarayÄ±cÄ± hafÄ±zasÄ±ndaki kullanÄ±cÄ± kaydÄ±nÄ± sil.
    localStorage.removeItem('weizendOyunUser');
    // --- YENÄ° EKLENEN SATIR SONU ---

    detachAllListeners();
    
    document.getElementById("gameDiv").style.display = "none";
    document.getElementById("loginContainer").style.display = "block";
    
    const activityFeedPanel = document.getElementById('activityFeedPanel');
    if (activityFeedPanel) {
        activityFeedPanel.classList.add('hidden', 'translate-x-full');
    }
    const activityBellContainer = document.getElementById('activityBellContainer');
    if (activityBellContainer) {
        activityBellContainer.classList.add('hidden');
    }

    currentUser = null;
    isAdmin = false;
    
    auth.signOut().catch((error) => {
        console.error("Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken hata oluÅŸtu: ", error);
        displayMessage("Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken bir hata oluÅŸtu.");
    });
}

// MEVCUT loadBalanceAndBoxRights fonksiyonunu bununla deÄŸiÅŸtir
function loadBalanceAndBoxRights() {
    if (isAdmin) {
        document.getElementById("balance").textContent = "Admin Paneli Aktif";
        document.getElementById("currentUser").innerHTML = `${currentUser}`;
        return;
    }
    const ref = db.ref('users/' + currentUser);
    const allUsersRef = db.ref('users');

    const callback = async snap => {
        const userData = snap.val();
        if (!userData) return;

        if (userData.blocked && userData.blockedUntil && Date.now() < userData.blockedUntil) {
            displayBlockedMessage(userData.blockedUntil, currentUser);
        } else if (userData.blocked) {
            db.ref('users/' + currentUser).update({ blocked: false, blockedUntil: null });
        }

        let statusText = `Mevcut PuanÄ±: ${userData.balance || 0} | Kutu HakkÄ±: ${userData.kutuHakki || 0}`;
        if ((userData.carkBileti || 0) > 0) statusText += ` | ğŸ¡ Ã‡ark Bileti: ${userData.carkBileti}`;
        if ((userData.clickCatchTickets || 0) > 0) statusText += ` | ğŸ¯ Yakalama Bileti: ${userData.clickCatchTickets}`;
        if (userData.iflasShieldUses > 0) statusText += ` | ğŸ›¡ï¸ Kalkan: ${userData.iflasShieldUses}`;
        if (userData.multiplierSource === 'store' && userData.multiplierRemainingUses > 0) statusText += ` | âœ–ï¸ Ã‡arpan: ${userData.activeMultiplier}x (${userData.multiplierRemainingUses} kullanÄ±m)`;
        else if (userData.multiplierSource === 'box') statusText += ` | âœ–ï¸ Ã‡arpan: ${userData.activeMultiplier}x (Otomatik)`;

        document.getElementById("balance").textContent = statusText;
        document.getElementById('storeCurrentUserBalance').textContent = userData.balance || 0;
        document.getElementById('storeCurrentUserSpent').textContent = userData.totalSpentPoints || 0;
        // GÃœNCELLENEN SATIR BURADA
        document.getElementById('storeCurrentUserKasaBalance').textContent = userData.kasaPuani || 0;
        document.getElementById('wheelTicketBalance').textContent = userData.carkBileti || 0;

        const allUsersSnap = await allUsersRef.once('value');
        const leaders = await calculateAllLeaders(allUsersSnap.val());
        const userLeaderStatus = {
            isCurrentLeader: currentUser === leaders.currentBalanceUser,
            isHighLeader: currentUser === leaders.highEverBalanceUser,
            isSurpriseLeader: currentUser === leaders.surpriseBoxUser,
            isBombLeader: currentUser === leaders.bombUser,
            isStoreLeader: currentUser === leaders.spentPointsUser,
            isMultiplierLeader: currentUser === leaders.multiplierUser,
            isBoxLeader: currentUser === leaders.boxUser,
            isShieldLeader: currentUser === leaders.shieldUser,
            isClickCatchLeader: currentUser === leaders.clickCatchLeaderUser,
            isWheelSpinLeader: currentUser === leaders.wheelSpinUser
        };
        const badgesHtml = getInlineBadgesHtmlFromStatus(userLeaderStatus);
        document.getElementById("currentUserBadges").innerHTML = badgesHtml;
        document.getElementById("currentUser").innerHTML = `${currentUser}`;
    };
    
    if(activeListeners.balance) activeListeners.balance.ref.off('value', activeListeners.balance.callback);
    activeListeners.balance = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// --- YENÄ° EKLENECEK SÄ°HÄ°RLÄ° ROZET FONKSÄ°YONU ---
function getInlineBadgesHtmlFromStatus(userLeaderStatus) {
    if (!userLeaderStatus) return '';

    const hasKingCrown = userLeaderStatus.isCurrentLeader && userLeaderStatus.isHighLeader && userLeaderStatus.isSurpriseLeader &&
                         userLeaderStatus.isBombLeader && userLeaderStatus.isStoreLeader && userLeaderStatus.isMultiplierLeader &&
                         userLeaderStatus.isBoxLeader && userLeaderStatus.isShieldLeader && userLeaderStatus.isClickCatchLeader && userLeaderStatus.isWheelSpinLeader;

    if (hasKingCrown) {
        return `<span class="inline-badge" title="TÃ¼m Liderlik Rozetlerinin Sahibi!">ğŸ‘‘</span>`;
    }

    const badges = [];
    if (userLeaderStatus.isCurrentLeader) badges.push(`<span class="inline-badge" title="Mevcut Puan Lideri">ğŸ¥‡</span>`);
    if (userLeaderStatus.isHighLeader) badges.push(`<span class="inline-badge" title="UlaÅŸÄ±lan En YÃ¼ksek Puan Lideri">ğŸ†</span>`);
    if (userLeaderStatus.isClickCatchLeader) badges.push(`<span class="inline-badge" title="TÄ±kla-Yakala Lideri">ğŸ¯</span>`);
    if (userLeaderStatus.isWheelSpinLeader) badges.push(`<span class="inline-badge" title="Ã‡ark Lideri">ğŸ¡</span>`);
    if (userLeaderStatus.isBoxLeader) badges.push(`<span class="inline-badge" title="Kutu Lideri">ğŸ“¦</span>`);
    if (userLeaderStatus.isSurpriseLeader) badges.push(`<span class="inline-badge" title="SÃ¼rpriz Kutu Lideri">ğŸ‰</span>`);
    if (userLeaderStatus.isBombLeader) badges.push(`<span class="inline-badge" title="Bomba Lideri">ğŸ’£</span>`);
    if (userLeaderStatus.isMultiplierLeader) badges.push(`<span class="inline-badge" title="Ã‡arpan Lideri">âœ–ï¸</span>`);
    if (userLeaderStatus.isStoreLeader) badges.push(`<span class="inline-badge" title="AlÄ±ÅŸveriÅŸ Lideri">ğŸ›’</span>`);
    if (userLeaderStatus.isShieldLeader) badges.push(`<span class="inline-badge" title="Kalkan Lideri">ğŸ›¡ï¸</span>`);
    
    return badges.join(''); // Rozetleri yanyana birleÅŸtirip dÃ¶ndÃ¼r
}
// --- YENÄ° FONKSÄ°YON BÄ°TÄ°Å ---
  
 function getUserBadgesHtml(u, leaders, forPublicProfile = false) {
    const hasKingCrown = leaders.isCurrentLeader && leaders.isHighLeader && leaders.isSurpriseLeader &&
                         leaders.isBombLeader && leaders.isStoreLeader && leaders.isMultiplierLeader &&
                         leaders.isBoxLeader && leaders.isShieldLeader && leaders.isClickCatchLeader && leaders.isWheelSpinLeader;

    if (forPublicProfile) {
        if (hasKingCrown) {
            return {
                crown: `<span class="text-3xl" title="TÃ¼m Liderlik Rozetlerinin Sahibi!">ğŸ‘‘</span>`,
                others: ''
            };
        }

        const allBadges = [];
        if (leaders.isCurrentLeader) allBadges.push(`<span class="text-2xl" title="Mevcut Puan Lideri">ğŸ¥‡</span>`);
        if (leaders.isHighLeader) allBadges.push(`<span class="text-2xl" title="UlaÅŸÄ±lan En YÃ¼ksek Puan Lideri">ğŸ†</span>`);
        if (leaders.isClickCatchLeader) allBadges.push(`<span class="text-2xl" title="TÄ±kla-Yakala Lideri">ğŸ¯</span>`);
        if (leaders.isWheelSpinLeader) allBadges.push(`<span class="text-2xl" title="Ã‡ark Lideri">ğŸ¡</span>`);
        if (leaders.isBoxLeader) allBadges.push(`<span class="text-2xl" title="Kutu Lideri">ğŸ“¦</span>`);
        if (leaders.isSurpriseLeader) allBadges.push(`<span class="text-2xl" title="SÃ¼rpriz Kutu Lideri">ğŸ‰</span>`);
        if (leaders.isBombLeader) allBadges.push(`<span class="text-2xl" title="Bomba Lideri">ğŸ’£</span>`);
        if (leaders.isMultiplierLeader) allBadges.push(`<span class="text-2xl" title="Ã‡arpan Lideri">âœ–ï¸</span>`);
        if (leaders.isStoreLeader) allBadges.push(`<span class="text-2xl" title="AlÄ±ÅŸveriÅŸ Lideri">ğŸ›’</span>`);
        if (leaders.isShieldLeader) allBadges.push(`<span class="text-2xl" title="Kalkan Lideri">ğŸ›¡ï¸</span>`);
        if (!leaders.isSurpriseLeader && (u.surpriseBoxesOpened || 0) > 0) {
            allBadges.push(`<span class="text-2xl" title="SÃ¼rpriz Kutu Rozeti">ğŸ</span>`);
        }
        
        return {
            crown: '',
            others: allBadges.join('')
        };
    }

    const rankingBadges = [];
    if (leaders.isCurrentLeader) rankingBadges.push(`<span class="text-xl" title="Mevcut Puan Lideri">ğŸ¥‡</span>`);
    if (leaders.isHighLeader) rankingBadges.push(`<span class="text-xl" title="UlaÅŸÄ±lan En YÃ¼ksek Puan Lideri">ğŸ†</span>`);
    if (leaders.isClickCatchLeader) rankingBadges.push(`<span class="text-xl" title="TÄ±kla-Yakala Lideri">ğŸ¯</span>`);
    if (leaders.isWheelSpinLeader) rankingBadges.push(`<span class="text-xl" title="Ã‡ark Lideri">ğŸ¡</span>`);
    if (leaders.isBoxLeader) rankingBadges.push(`<span class="text-xl" title="Kutu Lideri">ğŸ“¦</span>`);
    if (leaders.isSurpriseLeader) rankingBadges.push(`<span class="text-xl" title="SÃ¼rpriz Kutu Lideri">ğŸ‰</span>`);
    if (leaders.isBombLeader) rankingBadges.push(`<span class="text-xl" title="Bomba Lideri">ğŸ’£</span>`);
    if (leaders.isMultiplierLeader) rankingBadges.push(`<span class="text-xl" title="Ã‡arpan Lideri">âœ–ï¸</span>`);
    if (leaders.isStoreLeader) rankingBadges.push(`<span class="text-xl" title="AlÄ±ÅŸveriÅŸ Lideri">ğŸ›’</span>`);
    if (leaders.isShieldLeader) rankingBadges.push(`<span class="text-xl" title="Kalkan Lideri">ğŸ›¡ï¸</span>`);
    if (!leaders.isSurpriseLeader && (u.surpriseBoxesOpened || 0) > 0) {
        rankingBadges.push(`<span class="text-xl" title="SÃ¼rpriz Kutu Rozeti">ğŸ</span>`);
    }

    const crownHtml = hasKingCrown ? `<div class="flex justify-center w-full mb-1"><span class="text-3xl" title="TÃ¼m Liderlik Rozetlerinin Sahibi!">ğŸ‘‘</span></div>` : '';
    const otherBadgesHtml = `<div class="flex items-center justify-center gap-1 h-6">${rankingBadges.join('')}</div>`;

    return crownHtml + otherBadgesHtml;
}

  // === ESKÄ° loadUserRankingsAndBoxCounts FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR ===

function loadUserRankingsAndBoxCounts() {
    const ref = db.ref('users');

    // Ã–nceki dinleyiciyi temizle
    if (activeListeners.userRankings && activeListeners.userRankings.ref) {
        activeListeners.userRankings.ref.off();
    }
    
    // Dinleyiciyi kaydet
    activeListeners.userRankings = { ref: ref };
    
    // Sadece ilk yÃ¼klemede tÃ¼m veriyi Ã§ek
    ref.once('value', initialSnap => {
        allUsersCache = []; // Ã–nbelleÄŸi temizle
        const usersData = initialSnap.val();
        if (usersData) {
            allUsersCache = Object.entries(usersData)
                .filter(([username, userData]) => username.toLowerCase() !== 'weizendtv' && userData.approved)
                .map(([username, userData]) => ({ username, ...userData }));
        }
        renderUserRankings(); // Ä°lk sÄ±ralamayÄ± Ã§iz
    });

    // Yeni eklenen kullanÄ±cÄ±larÄ± dinle
    ref.on('child_added', snap => {
        const username = snap.key;
        const userData = snap.val();
        if (username.toLowerCase() !== 'weizendtv' && userData.approved) {
            // EÄŸer Ã¶nbellekte zaten varsa ekleme (ilk yÃ¼klemede gelebilir), yoksa ekle
            if (!allUsersCache.some(u => u.username === username)) {
                allUsersCache.push({ username, ...userData });
                renderUserRankings();
            }
        }
    });

    // DeÄŸiÅŸen kullanÄ±cÄ±larÄ± dinle
    ref.on('child_changed', snap => {
        const username = snap.key;
        const userData = snap.val();
        const userIndex = allUsersCache.findIndex(u => u.username === username);
        if (userIndex > -1) {
            // KullanÄ±cÄ±yÄ± Ã¶nbellekte gÃ¼ncelle
            allUsersCache[userIndex] = { username, ...userData };
            renderUserRankings(); // SÄ±ralamayÄ± yeniden Ã§iz
        }
    });

    // Silinen kullanÄ±cÄ±larÄ± dinle
    ref.on('child_removed', snap => {
        const username = snap.key;
        const userIndex = allUsersCache.findIndex(u => u.username === username);
        if (userIndex > -1) {
            // KullanÄ±cÄ±yÄ± Ã¶nbellekten sil
            allUsersCache.splice(userIndex, 1);
            renderUserRankings(); // SÄ±ralamayÄ± yeniden Ã§iz
        }
    });
}

// MEVCUT calculateAllLeaders fonksiyonunu bununla deÄŸiÅŸtir
async function calculateAllLeaders(allUsersData) {
    const currentClickCatchLeader = await getClickCatchLeaderUsername();
    let leaders = {
        highestCurrentBalance: -1, currentBalanceUser: null,
        highestEverBalance: -1, highEverBalanceUser: null, // Bu satÄ±rÄ±n anlamÄ± artÄ±k "En YÃ¼ksek Kariyer Puan" olacak
        maxSurpriseBoxes: -1, surpriseBoxUser: null,
        maxBombCount: -1, bombUser: null,
        maxSpentPoints: -1, spentPointsUser: null,
        maxMultiplierFound: -1, multiplierUser: null,
        maxBoxesOpened: -1, boxUser: null,
        maxShieldUsed: -1, shieldUser: null,
        maxWheelSpins: -1, wheelSpinUser: null,
    };

    for (const username in allUsersData) {
        if (username.toLowerCase() === 'weizendtv' || !allUsersData[username].approved) continue;
        const userData = allUsersData[username];
        
        const userBalance = userData.balance || 0;
        if (userBalance > 0 && userBalance > leaders.highestCurrentBalance) {
            leaders.highestCurrentBalance = userBalance;
            leaders.currentBalanceUser = username;
        }

        // --- DEÄÄ°ÅÄ°KLÄ°K BURADA ---
        // ArtÄ±k 'highestBalanceEver' yerine 'kariyerPuani'nÄ± kontrol ediyoruz.
        const userHighestBalance = userData.kariyerPuani || 0; 
        if (userHighestBalance > 0 && userHighestBalance > leaders.highestEverBalance) {
            leaders.highestEverBalance = userHighestBalance;
            leaders.highEverBalanceUser = username;
        }

        const userSurpriseBoxes = userData.surpriseBoxesOpened || 0;
        if (userSurpriseBoxes > 0 && userSurpriseBoxes > leaders.maxSurpriseBoxes) {
            leaders.maxSurpriseBoxes = userSurpriseBoxes;
            leaders.surpriseBoxUser = username;
        }

        const userBombCount = userData.iflasCount || 0;
        if (userBombCount > 0 && userBombCount > leaders.maxBombCount) {
            leaders.maxBombCount = userBombCount;
            leaders.bombUser = username;
        }

        const userSpentPoints = userData.totalSpentPoints || 0;
        if (userSpentPoints > 0 && userSpentPoints > leaders.maxSpentPoints) {
            leaders.maxSpentPoints = userSpentPoints;
            leaders.spentPointsUser = username;
        }

        const userMultiplierFound = userData.multiplierFoundCount || 0;
        if (userMultiplierFound > 0 && userMultiplierFound > leaders.maxMultiplierFound) {
            leaders.maxMultiplierFound = userMultiplierFound;
            leaders.multiplierUser = username;
        }

        const userBoxesOpened = userData.boxesOpenedCount || 0;
        if (userBoxesOpened > 0 && userBoxesOpened > leaders.maxBoxesOpened) {
            leaders.maxBoxesOpened = userBoxesOpened;
            leaders.boxUser = username;
        }

        const userShieldUsed = userData.iflasShieldUsedCount || 0;
        if (userShieldUsed > 0 && userShieldUsed > leaders.maxShieldUsed) {
            leaders.maxShieldUsed = userShieldUsed;
            leaders.shieldUser = username;
        }
        
        const userWheelSpins = userData.wheelSpinsCount || 0;
        if (userWheelSpins > 0 && userWheelSpins > leaders.maxWheelSpins) {
            leaders.maxWheelSpins = userWheelSpins;
            leaders.wheelSpinUser = username;
        }
    }
    
    leaders.clickCatchLeaderUser = currentClickCatchLeader;
    
    return leaders;
}

  // MEVCUT renderUserRankings fonksiyonunu bununla deÄŸiÅŸtir
async function renderUserRankings() {
    const searchTerm = document.getElementById('searchUserRanking').value.trim().toLowerCase();
    
    let filteredUsers = allUsersCache;
    if (searchTerm) {
        filteredUsers = allUsersCache.filter(u => u.username.toLowerCase().includes(searchTerm));
    }

    const allUsersSnap = await db.ref('users').once('value');
    const allUsersData = allUsersSnap.val() || {};
    
    const leaders = await calculateAllLeaders(allUsersData);

    // SIRALAMA Kriteri: 'kariyerPuani' oldu.
    filteredUsers.sort((a, b) => (b.kariyerPuani || 0) - (a.kariyerPuani || 0));

    let html = filteredUsers.map((u, i) => {
        const userLeaderStatus = {
            isCurrentLeader: u.username === leaders.currentBalanceUser,
            isHighLeader: u.username === leaders.highEverBalanceUser,
            isSurpriseLeader: u.username === leaders.surpriseBoxUser,
            isBombLeader: u.username === leaders.bombUser,
            isStoreLeader: u.username === leaders.spentPointsUser,
            isMultiplierLeader: u.username === leaders.multiplierUser,
            isBoxLeader: u.username === leaders.boxUser,
            isShieldLeader: u.username === leaders.shieldUser,
            isClickCatchLeader: u.username === leaders.clickCatchLeaderUser,
            isWheelSpinLeader: u.username === leaders.wheelSpinUser
        };

        const userIcons = getUserBadgesHtml(u, userLeaderStatus);
        const avatarUrl = u.selectedAvatar ? u.selectedAvatar.url : defaultAvatarUrl;
        
        let blockedInfo = '';
        const isBlocked = u.blocked && u.blockedUntil && Date.now() < u.blockedUntil;
        if (isBlocked) {
            blockedInfo = `<div class="text-red-400 font-bold mt-2">Engelli - Kalan SÃ¼re: <span id="countdown-${u.username}">--:--</span></div>`;
        }

        // GÃ–STERÄ°LEN Puan: 'kariyerPuani' oldu.
        const scoreToShow = u.kariyerPuani || 0;

        return `<div class="relative mb-3 p-3 bg-gray-800 rounded-xl border border-gray-700 cursor-pointer hover:bg-gray-700/70 transition-colors" onclick="openPublicUserDetailModal('${u.username}')">
            <div class="flex items-center w-full gap-3">
                <span class="font-bold text-xl text-gray-400 w-8 text-center flex-shrink-0">${i + 1}.</span>
                <img src="${avatarUrl}" class="w-14 h-14 rounded-full object-cover flex-shrink-0 border-2 border-gray-600">
                
                <div class="flex flex-col min-w-0 flex-grow">
                    <div class="h-6 min-h-[24px] flex items-center">${userIcons}</div>
                    <p class="font-bold text-lg text-white truncate" title="${u.username}">${u.username}</p>
                    <p class="text-sm font-semibold text-yellow-400/80">${scoreToShow} (Kariyer Puan)</p>
                </div>
            </div>
            ${blockedInfo ? `<div class="text-center mt-2">${blockedInfo}</div>` : ''}
        </div>`;

    }).join("");

    document.getElementById("allUserRankings").innerHTML = html || "<div class='text-center text-gray-400'>Aramayla eÅŸleÅŸen kullanÄ±cÄ± bulunamadÄ±.</div>";
    document.getElementById("totalUsers").textContent = allUsersCache.length;
}

async function loadLeaderboardRanking() {
    const ref = db.ref('users');

    if (activeListeners.leaderboard && activeListeners.leaderboard.ref) {
        activeListeners.leaderboard.ref.off();
    }

    activeListeners.leaderboard = { ref: ref };

    const renderLeaders = async (snap) => {
        const usersData = snap.val() || {};

        if (Object.keys(usersData).length === 0) {
            document.getElementById("badgedUsersRanking").innerHTML = "<div class='text-center text-gray-400'>HenÃ¼z lider kullanÄ±cÄ± yok.</div>";
            return;
        }

        const leaders = await calculateAllLeaders(usersData);
        
        const leaderUsernames = new Set([
            leaders.currentBalanceUser, leaders.highEverBalanceUser, leaders.surpriseBoxUser,
            leaders.bombUser, leaders.spentPointsUser, leaders.multiplierUser,
            leaders.boxUser, leaders.shieldUser, leaders.clickCatchLeaderUser, leaders.wheelSpinUser
        ]);
        leaderUsernames.delete(null);
        
        const allUsersAsArray = Object.entries(usersData).map(([username, data]) => ({ username, ...data }));
        const leaderUsers = allUsersAsArray.filter(u => leaderUsernames.has(u.username));

        leaderUsers.sort((a, b) => {
            const getBadgeCount = (user) => {
                let count = 0;
                if (user.username === leaders.currentBalanceUser) count++;
                if (user.username === leaders.highEverBalanceUser) count++;
                if (user.username === leaders.surpriseBoxUser) count++;
                if (user.username === leaders.bombUser) count++;
                if (user.username === leaders.spentPointsUser) count++;
                if (user.username === leaders.multiplierUser) count++;
                if (user.username === leaders.boxUser) count++;
                if (user.username === leaders.shieldUser) count++;
                if (user.username === leaders.clickCatchLeaderUser) count++;
                if (user.username === leaders.wheelSpinUser) count++;
                return count;
            };

            const aBadgeCount = getBadgeCount(a);
            const bBadgeCount = getBadgeCount(b);
            
            if (bBadgeCount !== aBadgeCount) return bBadgeCount - aBadgeCount;
            return (b.balance || 0) - (a.balance || 0);
        });

        const html = leaderUsers.map((u, i) => {
            const userLeaderStatus = {
                isCurrentLeader: u.username === leaders.currentBalanceUser,
                isHighLeader: u.username === leaders.highEverBalanceUser,
                isSurpriseLeader: u.username === leaders.surpriseBoxUser,
                isBombLeader: u.username === leaders.bombUser,
                isStoreLeader: u.username === leaders.spentPointsUser,
                isMultiplierLeader: u.username === leaders.multiplierUser,
                isBoxLeader: u.username === leaders.boxUser,
                isShieldLeader: u.username === leaders.shieldUser,
                isClickCatchLeader: u.username === leaders.clickCatchLeaderUser,
                isWheelSpinLeader: u.username === leaders.wheelSpinUser
            };
            const badgesHtml = getUserBadgesHtml(u, userLeaderStatus);
            const avatarUrl = u.selectedAvatar ? u.selectedAvatar.url : defaultAvatarUrl;

            return `<div class="mb-3 p-3 bg-gray-800 rounded-md border border-gray-700 cursor-pointer hover:bg-gray-700" onclick="openPublicUserDetailModal('${u.username}')">
                <div class="text-center">${badgesHtml}</div>
                <div class="flex items-center justify-start mt-1">
                    <span class="font-semibold text-lg text-yellow-300 mr-3 w-8 text-left">${i + 1}.</span>
                    <img src="${avatarUrl}" class="w-12 h-12 rounded-md mr-3 object-contain">
                    <span class="font-semibold text-lg">${u.username}</span>
                </div>
            </div>`;
        }).join("");

        document.getElementById("badgedUsersRanking").innerHTML = html || "<div class='text-center text-gray-400'>HenÃ¼z lider kullanÄ±cÄ± yok.</div>";
    };

    ref.on('value', renderLeaders);
}
  
  function loadPendingUsers() {
    const ref = db.ref('users');
    const callback = snap => {
      const data = snap.val();
      let html = "";
      if (data) {
          for (const u in data) {
            if (data[u].approved === false) {
              html += `<div class="flex justify-between items-center p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-red-500">
                <span class="text-gray-200">${u}</span>
                <div class="flex space-x-2">
                <button onclick="approveUser('${u}')" class="py-1 px-3 bg-green-600 hover:bg-green-500 text-white text-sm font-bold rounded-md">Onayla</button>
                <button onclick="denyUser('${u}', true)" class="py-1 px-3 bg-red-600 hover:bg-red-500 text-white text-sm font-bold rounded-md">Sil</button></div></div>`;
            }
          }
      }
      document.getElementById("pendingUsers").innerHTML = html || "<div class='text-center text-gray-400'>Onay bekleyen kullanÄ±cÄ± yok.</div>";
    };
    activeListeners.pendingUsers = { ref, event: 'value', callback };
    ref.on('value', callback);
  }

  function loadAllUsers() {
    const ref = db.ref('users');
    const callback = snap => {
      const data = snap.val();
      let html = "";
      if (data) {
          for (const u in data) {
            if (u.toLowerCase() === "weizendtv") continue;
            const user = data[u];
            let blockedStatusHtml = '';
            const isCurrentlyBlocked = user.blocked && user.blockedUntil && Date.now() < user.blockedUntil;
            if (isCurrentlyBlocked) {
                blockedStatusHtml = `<span class="text-red-400">(Engelli - <span id="admin-countdown-${u}">--:--</span>)</span>`;
                if (!activeBlockedUserTimers[u]) {
                    const timerId = setInterval(() => {
                        const timeLeft = user.blockedUntil - Date.now();
                        const el = document.getElementById(`admin-countdown-${u}`);
                        if (timeLeft <= 0) {
                            clearInterval(timerId);
                            if(el) el.parentElement.innerHTML = '<span class="text-green-400">(Engel KalktÄ±)</span>';
                        } else {
                            const minutes = Math.floor(timeLeft / 60000);
                            const seconds = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, '0');
                            if(el) el.textContent = `${minutes}:${seconds}`;
                        }
                    }, 1000);
                    activeBlockedUserTimers[u] = timerId;
                }
            } else if (user.blocked) {
                blockedStatusHtml = `<span class="text-green-400">(Engel SÃ¼resi Doldu)</span>`;
            }

            const avatarUrl = user.selectedAvatar ? user.selectedAvatar.url : defaultAvatarUrl;
html += `<div class="flex items-center justify-between p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-blue-500 cursor-pointer hover:bg-gray-600 transition-colors" onclick="openUserManagementModal('${u}')">
            <div class="flex items-center">
              <img src="${avatarUrl}" class="w-12 h-12 rounded-md mr-3 object-contain">
              <span class="text-gray-200">${u} ${blockedStatusHtml}</span>
            </div>
            <span class="text-yellow-300">Puan: ${user.balance || 0}</span>
          </div>`;
          }
      }
      document.getElementById("allUsers").innerHTML = html || "<div class='text-center text-gray-400'>KullanÄ±cÄ± yok.</div>";
    };
    activeListeners.allUsers = { ref, event: 'value', callback };
    ref.on('value', callback);
  }
  
  function displayMessage(message) { document.getElementById('generalMessageContent').innerHTML = message; generalMessageModal.style.display = 'flex'; }
  function closeGeneralMessageModal() { generalMessageModal.style.display = 'none'; }
  function customConfirm(message, callback) {
    return new Promise(resolve => {
        const confirmBox = document.createElement('div');
        confirmBox.className = 'fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999]';
        confirmBox.innerHTML = `
          <div class="bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
            <p class="text-lg text-gray-300 mb-6">${message}</p>
            <div class="flex gap-4 justify-center">
              <button id="confirmYes" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Evet</button>
              <button id="confirmNo" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">HayÄ±r</button>
            </div>
          </div>
        `;
        document.body.appendChild(confirmBox);
        document.getElementById('confirmYes').onclick = () => { confirmBox.remove(); resolve(true); };
        document.getElementById('confirmNo').onclick = () => { confirmBox.remove(); resolve(false); };
    });
  }

  function notifyUser(username, message) {
      if (!username || !message) return;
      const notifRef = db.ref(`users/${username}/notifications`).push();
      notifRef.set({
          message: message,
          timestamp: firebase.database.ServerValue.TIMESTAMP
      });
  }

  function openPointAdjustmentModal(username) {
    targetUserForAdjustment = username;
    document.getElementById('adjUserName').textContent = username;
    db.ref('users/' + username + '/balance').once('value').then(snap => {
      document.getElementById('adjUserBalance').textContent = snap.val() || 0;
    });
    pointAdjustmentModal.style.display = 'flex';
  }

  function closePointAdjustmentModal() {
    pointAdjustmentModal.style.display = 'none';
    document.getElementById('adjAmount').value = '';
    targetUserForAdjustment = null;
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement);
  }

  // MEVCUT adjustUserPoints fonksiyonunu bununla deÄŸiÅŸtir
function adjustUserPoints(add) {
    const amount = parseInt(document.getElementById('adjAmount').value);
    if (isNaN(amount) || amount <= 0) {
      displayMessage("GeÃ§erli bir miktar girin.");
      return;
    }
    db.ref('users/' + targetUserForAdjustment).once('value').then(snap => {
      let data = snap.val();
      let bal = data.balance || 0;
      let highBal = data.highestBalanceEver || 0;
      
      // KARÄ°YER PUANI GÃœNCELLEMESÄ°
      let kariyerPuani = data.kariyerPuani || 0;
      if (add) {
          kariyerPuani += amount;
      }
      
      bal = add ? bal + amount : Math.max(0, bal - amount);
      if (bal > highBal) highBal = bal;
      db.ref('users/' + targetUserForAdjustment).update({
        balance: bal,
        highestBalanceEver: highBal,
        kariyerPuani: kariyerPuani // Yeni alanÄ± da gÃ¼ncelle
      }).then(() => {
        const message = `Admin tarafÄ±ndan hesabÄ±nÄ±za ${amount} puan ${add ? 'eklendi' : 'silindi'}.`;
        notifyUser(targetUserForAdjustment, message);
        displayMessage(`${targetUserForAdjustment} yeni bakiyesi: ${bal}`);
        closePointAdjustmentModal();
      });
    });
}

  function openBoxRightAdjustmentModal(username) {
    targetUserForBoxRightAdjustment = username;
    document.getElementById('adjBoxRightUserName').textContent = username;
    db.ref('users/' + username + '/kutuHakki').once('value').then(snap => {
      document.getElementById('adjUserBoxRight').textContent = snap.val() || 0;
    });
    boxRightAdjustmentModal.style.display = 'flex';
  }

  function closeBoxRightAdjustmentModal() {
    boxRightAdjustmentModal.style.display = 'none';
    document.getElementById('adjBoxRightAmount').value = '';
    targetUserForBoxRightAdjustment = null;
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement);
  }

  function adjustUserBoxRights(add) {
    const amount = parseInt(document.getElementById('adjBoxRightAmount').value);
    if (isNaN(amount) || amount <= 0) {
      displayMessage("GeÃ§erli bir miktar girin.");
      return;
    }
    db.ref('users/' + targetUserForBoxRightAdjustment + '/kutuHakki').once('value').then(snap => {
      let val = snap.val() || 0;
      val = add ? val + amount : Math.max(0, val - amount);
      db.ref('users/' + targetUserForBoxRightAdjustment).update({
        kutuHakki: val
      }).then(() => {
        const message = `Admin tarafÄ±ndan hesabÄ±nÄ±za ${amount} kutu hakkÄ± ${add ? 'eklendi' : 'silindi'}.`;
        notifyUser(targetUserForBoxRightAdjustment, message);
        displayMessage(`${targetUserForBoxRightAdjustment} yeni kutu hakkÄ±: ${val}`);
        closeBoxRightAdjustmentModal();
      });
    });
  }

  function openIflasShieldAdjustmentModal(username) {
    targetUserForIflasShieldAdjustment = username;
    document.getElementById('adjIflasShieldUserName').textContent = username;
    db.ref('users/' + username + '/iflasShieldUses').once('value').then(snap => {
      document.getElementById('adjUserIflasShield').textContent = snap.val() || 0;
    });
    iflasShieldAdjustmentModal.style.display = 'flex';
  }

  function closeIflasShieldAdjustmentModal() {
    iflasShieldAdjustmentModal.style.display = 'none';
    document.getElementById('adjIflasShieldAmount').value = '';
    targetUserForIflasShieldAdjustment = null;
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement);
  }

  async function adjustUserIflasShields(add) {
    const amount = parseInt(document.getElementById('adjIflasShieldAmount').value);
    if (isNaN(amount) || amount <= 0) {
      displayMessage("GeÃ§erli bir miktar girin.");
      return;
    }
    const userRef = db.ref('users/' + targetUserForIflasShieldAdjustment + '/iflasShieldUses');
    userRef.once('value').then(snap => {
      let currentShields = snap.val() || 0;
      const newShields = add ? currentShields + amount : Math.max(0, currentShields - amount);
      userRef.set(newShields).then(() => {
        const message = `Admin tarafÄ±ndan hesabÄ±nÄ±za ${amount} Ä°flas KalkanÄ± ${add ? 'eklendi' : 'silindi'}.`;
        notifyUser(targetUserForIflasShieldAdjustment, message);
        displayMessage(`${targetUserForIflasShieldAdjustment} iÃ§in kalkan ayarlandÄ±: ${newShields}`);
        closeIflasShieldAdjustmentModal();
      });
    });
  }

  async function openMultiplierAdjustmentModal(username) {
    targetUserForMultiplierAdjustment = username;
    document.getElementById('adjMultiplierUserName').textContent = username;
    const userSnap = await db.ref('users/' + username).once('value');
    const userData = userSnap.val();
    if (userData) {
      document.getElementById('adjUserMultiplier').textContent = `${userData.activeMultiplier || 1}x`;
      document.getElementById('adjUserMultiplierUses').textContent = userData.multiplierRemainingUses || 0;
      document.getElementById('setMultiplierValue').value = userData.activeMultiplier || 1;
      document.getElementById('setMultiplierSource').value = userData.multiplierSource || 'none';
      document.getElementById('setMultiplierUses').value = userData.multiplierRemainingUses || 0;
    }
    multiplierAdjustmentModal.style.display = 'flex';
  }

  function closeMultiplierAdjustmentModal() {
    multiplierAdjustmentModal.style.display = 'none';
    targetUserForMultiplierAdjustment = null;
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement);
  }

  async function setMultiplier() {
    const multiplierValue = parseInt(document.getElementById('setMultiplierValue').value);
    const multiplierSource = document.getElementById('setMultiplierSource').value;
    const multiplierUses = parseInt(document.getElementById('setMultiplierUses').value);
    if (isNaN(multiplierValue) || multiplierValue <= 0) {
      displayMessage("GeÃ§erli Ã§arpan deÄŸeri girin.");
      return;
    }
    const updates = {
      activeMultiplier: multiplierValue,
      multiplierSource: multiplierSource,
      multiplierRemainingUses: multiplierSource === 'store' ? (isNaN(multiplierUses) ? 0 : multiplierUses) : (multiplierSource === 'box' ? 1 : 0)
    };
    await db.ref('users/' + targetUserForMultiplierAdjustment).update(updates);
    const message = `Admin tarafÄ±ndan hesabÄ±nÄ±za ${multiplierValue}x Ã§arpan ayarlandÄ±.`;
    notifyUser(targetUserForMultiplierAdjustment, message);
    displayMessage("Ã‡arpan ayarlandÄ±.");
    closeMultiplierAdjustmentModal();
  }

  async function resetMultiplier() {
    const updates = {
      activeMultiplier: 1,
      multiplierSource: 'none',
      multiplierRemainingUses: 0,
      activeStoreMultiplierItemId: null
    };
    await db.ref('users/' + targetUserForMultiplierAdjustment).update(updates);
    notifyUser(targetUserForMultiplierAdjustment, "Ã‡arpanÄ±nÄ±z admin tarafÄ±ndan sÄ±fÄ±rlandÄ±.");
    displayMessage("Ã‡arpan sÄ±fÄ±rlandÄ±.");
    closeMultiplierAdjustmentModal();
  }
function openWheelTicketAdjustmentModal(username) { 
    targetUserForWheelTicket = username; 
    document.getElementById('adjWheelTicketUserName').textContent = username; 
    db.ref('users/' + username + '/carkBileti').once('value').then(snap => { 
        document.getElementById('adjUserWheelTicket').textContent = snap.val() || 0; 
    }); 
    wheelTicketAdjustmentModal.style.display = 'flex'; 
}
function closeWheelTicketAdjustmentModal() { 
    wheelTicketAdjustmentModal.style.display = 'none'; 
    document.getElementById('adjWheelTicketAmount').value = ''; 
    targetUserForWheelTicket = null; 
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement); 
}
function adjustUserWheelTickets(add) { 
    const amount = parseInt(document.getElementById('adjWheelTicketAmount').value); 
    if(isNaN(amount) || amount <= 0) { displayMessage("GeÃ§erli bir miktar girin."); return; } 
    const userRef = db.ref('users/' + targetUserForWheelTicket + '/carkBileti');
    userRef.transaction(currentTickets => {
        currentTickets = currentTickets || 0;
        return add ? currentTickets + amount : Math.max(0, currentTickets - amount);
    }).then(() => {
        const message = `Admin tarafÄ±ndan ${targetUserForWheelTicket} hesabÄ±na ${amount} Ã§ark bileti ${add ? 'eklendi' : 'silindi'}.`;
        notifyUser(targetUserForWheelTicket, message);
        displayMessage(message); 
        closeWheelTicketAdjustmentModal(); 
    });
}

function openClickCatchTicketAdjustmentModal(username) { 
    targetUserForClickCatchTicket = username; 
    document.getElementById('adjClickCatchTicketUserName').textContent = username; 
    db.ref('users/' + username + '/clickCatchTickets').once('value').then(snap => { 
        document.getElementById('adjUserClickCatchTicket').textContent = snap.val() || 0; 
    }); 
    clickCatchTicketAdjustmentModal.style.display = 'flex'; 
}
function closeClickCatchTicketAdjustmentModal() { 
    clickCatchTicketAdjustmentModal.style.display = 'none'; 
    document.getElementById('adjClickCatchTicketAmount').value = ''; 
    targetUserForClickCatchTicket = null; 
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement); 
}
function adjustUserClickCatchTickets(add) { 
    const amount = parseInt(document.getElementById('adjClickCatchTicketAmount').value); 
    if(isNaN(amount) || amount <= 0) { displayMessage("GeÃ§erli bir miktar girin."); return; } 
    const userRef = db.ref('users/' + targetUserForClickCatchTicket + '/clickCatchTickets');
    userRef.transaction(currentTickets => {
        currentTickets = currentTickets || 0;
        return add ? currentTickets + amount : Math.max(0, currentTickets - amount);
    }).then(() => {
        const message = `Admin tarafÄ±ndan ${targetUserForClickCatchTicket} hesabÄ±na ${amount} TÄ±kla-Yakala bileti ${add ? 'eklendi' : 'silindi'}.`;
        notifyUser(targetUserForClickCatchTicket, message);
        displayMessage(message); 
        closeClickCatchTicketAdjustmentModal(); 
    });
}

// --- YENÄ° BÄ°LET YÃ–NETÄ°M FONKSÄ°YONLARI BÄ°TÄ°Å ---
  // Admin iÅŸlemleri
  function openBlockDurationModal(username) { targetUserForBlock = username; document.getElementById('blockUserName').textContent = username; blockDurationModal.style.display = 'flex'; }
  function closeBlockDurationModal() { blockDurationModal.style.display = 'none'; document.getElementById('blockDuration').value = ''; targetUserForBlock = null; if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement); }
  function confirmBlockUser() { const duration = parseInt(document.getElementById('blockDuration').value); if (isNaN(duration) || duration <= 0) { displayMessage("GeÃ§erli sÃ¼re girin."); return; } const blockedUntil = Date.now() + duration * 60 * 1000; db.ref('users/' + targetUserForBlock).update({ blocked: true, blockedUntil: blockedUntil }).then(() => { displayMessage(`${targetUserForBlock} ${duration} dakika engellendi.`); closeBlockDurationModal(); }); }
  async function toggleBlockUser(user, currentStatus, blockedUntil) { 
    const isCurrentlyBlocked = currentStatus && blockedUntil && Date.now() < blockedUntil;
    if (isCurrentlyBlocked) { 
      const confirmed = await customConfirm(user + " engelini kaldÄ±rmak istiyor musunuz?"); 
      if(confirmed) db.ref('users/' + user).update({ blocked: false, blockedUntil: null }).then(() => { displayMessage(user + " engeli kaldÄ±rÄ±ldÄ±."); if(selectedUserForManagement) openUserManagementModal(user); }); 
    } else { 
      openBlockDurationModal(user); 
    } 
  }
  async function approveUser(user) { const confirmed = await customConfirm(user + " kullanÄ±cÄ±sÄ±nÄ± onaylamak istiyor musunuz?"); if(confirmed) { db.ref('users/' + user).update({ approved: true, approvalNotified: false }); displayMessage(`${user} onaylandÄ±.`); } }
  async function denyUser(user, fromPending = false, fromManagementModal = false) {
    const confirmed = await customConfirm(`<b>${user}</b> kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinize emin misiniz? Bu iÅŸlem, kullanÄ±cÄ±ya ait tÃ¼m puan, bilet, skor ve istatistikleri kalÄ±cÄ± olarak silecektir!`);
    if (confirmed) {
        // Silinecek tÃ¼m verilerin yollarÄ±nÄ± bir obje iÃ§inde topluyoruz.
        const updates = {};

        // 1. Ana kullanÄ±cÄ± verisini silmek iÃ§in hazÄ±rlÄ±yoruz.
        updates[`users/${user}`] = null;

        // 2. HaftalÄ±k "TÄ±kla-Yakala" skor tablosundaki kaydÄ±nÄ± siliyoruz.
        // Rozetlerin geri gelmesinin ana sebebi bu kaydÄ±n kalmasÄ±ydÄ±.
        updates[`clickCatchWeeklyScores/${user}`] = null;
        
        // (Gelecekte baÅŸka tablolar eklenirse, buraya o tablolardaki silme yolu da eklenebilir)

        // TÃ¼m silme iÅŸlemlerini tek seferde ve gÃ¼venli bir ÅŸekilde yapÄ±yoruz.
        await db.ref().update(updates);

        displayMessage(`${user} kullanÄ±cÄ±sÄ± ve iliÅŸkili tÃ¼m verileri baÅŸarÄ±yla silindi.`);
        
        // EÄŸer liderlik tablosundaki lider silindiyse, lider deÄŸiÅŸkenini sÄ±fÄ±rla
        if (clickCatchLeader === user) {
            clickCatchLeader = null;
        }

        if (fromManagementModal) {
            closeUserManagementModal();
        }
    }
}

    // MEVCUT changeAllPoints fonksiyonunu bununla deÄŸiÅŸtir
async function changeAllPoints(add) {
    const amount = parseInt(document.getElementById("globalPoint").value);
    if (isNaN(amount) || amount <= 0) { displayMessage("GeÃ§erli miktar girin."); return; }
    const confirmed = await customConfirm(`TÃ¼m kullanÄ±cÄ±lara ${amount} puan ${add ? 'eklemek' : 'silmek'} istediÄŸinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let balance = child.val().balance || 0;
                    let highestBalanceEver = child.val().highestBalanceEver || 0;
                    
                    // KARÄ°YER PUANI GÃœNCELLEMESÄ°
                    let kariyerPuani = child.val().kariyerPuani || 0;
                    if (add) {
                        kariyerPuani += amount;
                    }

                    balance = add ? balance + amount : Math.max(balance - amount, 0);
                    if (balance > highestBalanceEver) highestBalanceEver = balance;
                    updates['users/' + child.key + '/balance'] = balance;
                    updates['users/' + child.key + '/highestBalanceEver'] = highestBalanceEver;
                    updates['users/' + child.key + '/kariyerPuani'] = kariyerPuani; // Yeni alanÄ± da gÃ¼ncelle
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("TÃ¼m kullanÄ±cÄ±lara puan iÅŸlemi baÅŸarÄ±yla uygulandÄ±.");
                const actionText = add ? 'ekledi' : 'Ã§Ä±kardÄ±';
                const notificationMessage = `Admin, tÃ¼m kullanÄ±cÄ±lara ${amount} Puan ${actionText}.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
            });
        });
    }
}
    
  async function changeAllBoxRights(add) {
    const amount = parseInt(document.getElementById("globalBoxRight").value);
    if (isNaN(amount) || amount <= 0) { displayMessage("GeÃ§erli miktar girin."); return; }
    const confirmed = await customConfirm(`TÃ¼m kullanÄ±cÄ±lara ${amount} kutu hakkÄ± ${add ? 'eklemek' : 'silmek'} istediÄŸinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let kutuHakki = child.val().kutuHakki || 0;
                    kutuHakki = add ? kutuHakki + amount : Math.max(kutuHakki - amount, 0);
                    updates['users/' + child.key + '/kutuHakki'] = kutuHakki;
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("TÃ¼m kullanÄ±cÄ±lara kutu hakkÄ± iÅŸlemi baÅŸarÄ±yla uygulandÄ±.");
                // YENÄ° EKLENEN KOD BAÅLANGICI
                const actionText = add ? 'verdi' : 'sildi';
                const notificationMessage = `Admin, tÃ¼m kullanÄ±cÄ±lara ${amount} Kutu HakkÄ± ${actionText}.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                // YENÄ° EKLENEN KOD SONU
            });
        });
    }
}
    
async function changeAllShields(add) {
    const amount = parseInt(document.getElementById("globalShield").value);
    if (isNaN(amount) || amount <= 0) { displayMessage("GeÃ§erli bir kalkan miktarÄ± girin."); return; }
    const confirmed = await customConfirm(`TÃ¼m kullanÄ±cÄ±lara ${amount} adet Ä°flas KalkanÄ± ${add ? 'eklemek' : 'silmek'} istediÄŸinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let currentShields = child.val().iflasShieldUses || 0;
                    currentShields = add ? currentShields + amount : Math.max(0, currentShields - amount);
                    updates['users/' + child.key + '/iflasShieldUses'] = currentShields;
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("TÃ¼m kullanÄ±cÄ±lara kalkan iÅŸlemi baÅŸarÄ±yla uygulandÄ±.");
                // YENÄ° EKLENEN KOD BAÅLANGICI
                const actionText = add ? 'gÃ¶nderdi' : 'sildi';
                const notificationMessage = `Admin, tÃ¼m kullanÄ±cÄ±lara ${amount} Ä°flas KalkanÄ± ${actionText}.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                // YENÄ° EKLENEN KOD SONU
            });
        });
    }
}
    
async function changeAllWheelTickets(add) {
    const amount = parseInt(document.getElementById("globalWheelTicket").value);
    if (isNaN(amount) || amount <= 0) { displayMessage("GeÃ§erli bir bilet miktarÄ± girin."); return; }
    const confirmed = await customConfirm(`TÃ¼m kullanÄ±cÄ±lara ${amount} adet Ã‡ark Bileti ${add ? 'eklemek' : 'silmek'} istediÄŸinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let currentTickets = child.val().carkBileti || 0;
                    currentTickets = add ? currentTickets + amount : Math.max(0, currentTickets - amount);
                    updates['users/' + child.key + '/carkBileti'] = currentTickets;
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("TÃ¼m kullanÄ±cÄ±lara Ã‡ark Bileti iÅŸlemi baÅŸarÄ±yla uygulandÄ±.");
                // YENÄ° EKLENEN KOD BAÅLANGICI
                const actionText = add ? 'gÃ¶nderdi' : 'sildi';
                const notificationMessage = `Admin, tÃ¼m kullanÄ±cÄ±lara ${amount} Ã‡ark Bileti ${actionText}.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                // YENÄ° EKLENEN KOD SONU
            });
        });
    }
}
    
async function setAllMultipliers() {
    const multiplier = parseInt(document.getElementById("globalMultiplier").value);
    const uses = parseInt(document.getElementById("globalMultiplierUses").value);
    if (isNaN(multiplier) || multiplier < 2) { displayMessage("GeÃ§erli bir Ã§arpan deÄŸeri girin (en az 2)."); return; }
    if (isNaN(uses) || uses <= 0) { displayMessage("GeÃ§erli bir kullanÄ±m sayÄ±sÄ± girin."); return; }
    const confirmed = await customConfirm(`TÃ¼m kullanÄ±cÄ±lara ${multiplier}x Ã§arpanÄ± ${uses} kullanÄ±m hakkÄ± ile uygulamak istediÄŸinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    const userPath = 'users/' + child.key;
                    updates[userPath + '/activeMultiplier'] = multiplier;
                    updates[userPath + '/multiplierRemainingUses'] = uses;
                    updates[userPath + '/multiplierSource'] = 'store';
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("TÃ¼m kullanÄ±cÄ±lara Ã§arpan iÅŸlemi baÅŸarÄ±yla uygulandÄ±.");
                // YENÄ° EKLENEN KOD BAÅLANGICI
                const notificationMessage = `Admin, tÃ¼m kullanÄ±cÄ±lara ${uses} kullanÄ±mlÄ±k ${multiplier}x Ã‡arpan verdi.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                // YENÄ° EKLENEN KOD SONU
            });
        });
    }
}
    
async function clearAllMultipliers() {
    const confirmed = await customConfirm("TÃ¼m kullanÄ±cÄ±larÄ±n aktif Ã§arpanlarÄ±nÄ± sÄ±fÄ±rlamak istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.");
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    const userPath = 'users/' + child.key;
                    updates[userPath + '/activeMultiplier'] = 1;
                    updates[userPath + '/multiplierRemainingUses'] = 0;
                    updates[userPath + '/multiplierSource'] = 'none';
                    updates[userPath + '/activeStoreMultiplierItemId'] = null;
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("TÃ¼m kullanÄ±cÄ±larÄ±n Ã§arpanlarÄ± baÅŸarÄ±yla sÄ±fÄ±rlandÄ±.");
                const notificationMessage = `Admin, tÃ¼m kullanÄ±cÄ±larÄ±n aktif Ã§arpanlarÄ±nÄ± sÄ±fÄ±rladÄ±.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
            });
        });
    }
}
  async function resetUser(username) {
    const confirmed = await customConfirm(`<b>${username}</b> kullanÄ±cÄ±sÄ±nÄ± sÄ±fÄ±rlamak istediÄŸinize emin misiniz? Bu iÅŸlem kullanÄ±cÄ±nÄ±n puanlarÄ±nÄ±, biletlerini ve istatistiklerini sÄ±fÄ±rlar!`);
    if (!confirmed) return;

    const updates = {};
    const userRefPath = `users/${username}`;
    
    // Temel verileri sÄ±fÄ±rla
    updates[`${userRefPath}/balance`] = 0;
    updates[`${userRefPath}/highestBalanceEver`] = 0;
    updates[`${userRefPath}/totalSpentPoints`] = 0;
    updates[`${userRefPath}/kutuHakki`] = 0;
    updates[`${userRefPath}/carkBileti`] = 0;
    updates[`${userRefPath}/clickCatchTickets`] = 0; // TÄ±kla-yakala bileti de sÄ±fÄ±rlanÄ±yor
    updates[`${userRefPath}/clickCatchHighestScore`] = 0;
    updates[`${userRefPath}/iflasShieldUses`] = 0;
    
    // Ã‡arpanÄ± sÄ±fÄ±rla
    updates[`${userRefPath}/activeMultiplier`] = 1;
    updates[`${userRefPath}/multiplierSource`] = 'none';
    updates[`${userRefPath}/multiplierRemainingUses`] = 0;
    updates[`${userRefPath}/activeStoreMultiplierItemId`] = null;

    // Ä°statistikleri sÄ±fÄ±rla
    updates[`${userRefPath}/boxesOpenedCount`] = 0;
    updates[`${userRefPath}/surpriseBoxesOpened`] = 0;
    updates[`${userRefPath}/iflasCount`] = 0;
    updates[`${userRefPath}/iflasShieldUsedCount`] = 0;
    updates[`${userRefPath}/multiplierFoundCount`] = 0;
    updates[`${userRefPath}/storePurchasesCount`] = 0;

    // DiÄŸer durumlarÄ± sÄ±fÄ±rla
    updates[`${userRefPath}/dailyRewardsClaimed`] = null;
    
    await db.ref().update(updates);
    displayMessage(`${username} kullanÄ±cÄ±sÄ± baÅŸarÄ±yla sÄ±fÄ±rlandÄ±.`);
    
    // EÄŸer o an yÃ¶netiliyorsa modalÄ± yenile
    if (selectedUserForManagement === username) {
        openUserManagementModal(username);
    }
}

    // YENÄ° AVATAR SÄ°LME FONKSÄ°YONU
async function deleteUserAvatar(username, avatarId) {
    if (!isAdmin) return;

    const confirmed = await customConfirm(`<b>${username}</b> adlÄ± kullanÄ±cÄ±nÄ±n bu avatarÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?`);
    if (!confirmed) return;

    try {
        const userRef = db.ref(`users/${username}`);
        const userSnap = await userRef.once('value');
        const userData = userSnap.val();

        // Silme iÅŸlemleri iÃ§in bir gÃ¼ncelleme objesi hazÄ±rlÄ±yoruz
        const updates = {};
        updates[`/users/${username}/avatars/${avatarId}`] = null; // AvatarÄ± koleksiyondan sil

        // EÄŸer silinen avatar, kullanÄ±cÄ±nÄ±n o an seÃ§tiÄŸi avatarsa, seÃ§ili avatarÄ± da sÄ±fÄ±rla
        if (userData.selectedAvatar && userData.selectedAvatar.id === avatarId) {
            updates[`/users/${username}/selectedAvatar`] = null;
        }

        // TÃ¼m gÃ¼ncellemeleri tek seferde yap
        await db.ref().update(updates);

        displayMessage("Avatar baÅŸarÄ±yla kullanÄ±cÄ±dan silindi.");
        
        // YÃ¶netim penceresini gÃ¼ncel bilgilerle yeniden aÃ§arak anÄ±nda deÄŸiÅŸikliÄŸi gÃ¶ster
        openUserManagementModal(username);

    } catch (error) {
        console.error("Avatar silinirken hata oluÅŸtu:", error);
        displayMessage("Avatar silinirken bir hata meydana geldi.");
    }
}
  // Kutu iÅŸlemleri
  async function createBoxes() {
    // 1. VeritabanÄ±ndan Ã¶zel kutu ayarlarÄ±nÄ± Ã§ek
    const settingsRef = db.ref('gameConfig/boxContents');
    const snapshot = await settingsRef.once('value');
    
    // 2. EÄŸer veritabanÄ±nda ayar yoksa, kodun en baÅŸÄ±ndaki global BOX_CONTENTS listesini kullan.
    const currentBoxConfig = snapshot.exists() ? snapshot.val() : BOX_CONTENTS;

    // 3. Ayarlara gÃ¶re kutu iÃ§eriÄŸini oluÅŸtur
    boxes = []; 
    let allContents = []; 
    currentBoxConfig.forEach(item => { 
        for (let i = 0; i < item.count; i++) { 
            allContents.push({ type: item.type, value: item.value || 0 }); 
        } 
    }); 
    
    // 4. Kutu iÃ§eriÄŸini karÄ±ÅŸtÄ±r
    for (let i = allContents.length - 1; i > 0; i--) { 
        const j = Math.floor(Math.random() * (i + 1)); 
        [allContents[i], allContents[j]] = [allContents[j], allContents[i]]; 
    } 
    
    // 5. KarÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ iÃ§erikle yeni kutu listesini oluÅŸtur
    const TOTAL_BOXES = allContents.length;
    for (let i = 0; i < TOTAL_BOXES; i++) { 
        boxes.push({ 
            id: i + 1, 
            content: allContents[i].type, 
            value: allContents[i].value, 
            opened: false, 
            opener: '' 
        }); 
    } 
    
    // 6. Yeni kutu listesini veritabanÄ±na yaz
    db.ref('boxes').set(boxes); 
    db.ref('gameStats/boxesOpenedByUsers').remove(); 
}
  
  function loadBoxes() {
    const ref = db.ref('boxes');
    const callback = snap => {
        if (!snap.exists()) {
            createBoxes();
        } else {
            boxes = snap.val();
            renderBoxes();
        }
    };
    activeListeners.boxes = { ref, event: 'value', callback };
    ref.on('value', callback);
  }
  
  function renderBoxes() { 
    const container = document.getElementById("boxContainer"); 
    container.innerHTML = ''; 
    boxes.forEach((box, i) => { 
        let div = document.createElement('div'); 
        div.className = `box bg-gray-700 border-2 border-red-700 aspect-square flex flex-col items-center justify-center cursor-pointer font-bold text-lg rounded-lg relative transition-all duration-200 shadow-md hover:shadow-lg`;
        
        if (box.opened) {
            div.classList.add('opened', 'bg-gray-600', 'cursor-default', 'border-gray-500', 'shadow-inner');
            
            let openedContentHtml = '';

            // Kart paketi veya Joker Kart ise, CSS sÄ±nÄ±fÄ±nÄ± ekle (ikon CSS'ten gelecek)
            if (box.content && (box.content.startsWith('card_pack') || box.content === 'wildcard')) {
                div.classList.add(box.content);
                openedContentHtml = `<div class="box-content"></div>`; 
            }
            // DiÄŸer iÃ§erik tÃ¼rleri iÃ§in ikonu/yazÄ±yÄ± doÄŸrudan ekle
            else if (box.content === 'points') { 
                openedContentHtml = `<span class="box-content text-green-400 text-xl">+${box.finalPoints || box.value}</span>`; 
                div.classList.add('bg-green-700', 'border-green-500', 'animate-pulse'); 
            } else if (box.content === 'surpriz') { 
                openedContentHtml = `<div class="box-content text-yellow-400 text-2xl">ğŸ‰</div>`;
                div.classList.add('bg-yellow-700', 'border-yellow-500', 'animate-pulse'); 
            } else if (box.content === 'iflas') { 
                openedContentHtml = `<div class="box-content text-red-400 text-2xl">ğŸ’£</div>`;
                div.classList.add('bg-red-700', 'border-red-500'); 
            } else if (box.content === 'multiplier') { 
                openedContentHtml = `<span class="box-content text-blue-400 text-xl">${box.value}X</span>`; 
                div.classList.add('bg-blue-700', 'border-blue-500', 'animate-pulse'); 
            } else if (box.content === 'wheelTicket') {
                openedContentHtml = `<div class="box-content text-pink-400 text-2xl">ğŸ«ï¸</div>`;
                div.classList.add('bg-pink-700', 'border-pink-500', 'animate-pulse'); 
            } else if (box.content === 'clickCatchTicket') {
                openedContentHtml = `<div class="box-content text-orange-400 text-2xl">ğŸŸï¸</div>`;
                div.classList.add('bg-orange-700', 'border-orange-500', 'animate-pulse');
            } else if (box.content === 'iflasShield') {
                openedContentHtml = `<div class="box-content text-cyan-400 text-2xl">ğŸ›¡ï¸</div>`;
                div.classList.add('bg-cyan-700', 'border-cyan-500', 'animate-pulse');
            }
            
            div.innerHTML = openedContentHtml;
          
            if (box.opener) {
                let openerDiv = document.createElement('div'); 
                openerDiv.className = 'opener absolute bottom-1 left-0 right-0 text-center text-xs text-gray-400 truncate px-1'; 
                openerDiv.textContent = box.opener; 
                div.appendChild(openerDiv); 
            }

            if (box.multiplierApplied && box.multiplierApplied > 1) {
                let multiplierIcon = document.createElement('div');
                multiplierIcon.className = 'absolute top-0 right-1 text-yellow-300 font-bold text-xs bg-black bg-opacity-50 px-1 rounded-bl';
                multiplierIcon.textContent = `âœ–ï¸${box.multiplierApplied}`;
                multiplierIcon.title = `Bu kutu ${box.multiplierApplied}x Ã§arpan ile aÃ§Ä±ldÄ±.`;
                div.appendChild(multiplierIcon);
            }
        } else {
            // Kutu kapalÄ±ysa, sadece numarasÄ±nÄ± gÃ¶ster
            div.innerHTML = `<span class="box-content text-gray-300">${box.id}</span>`;
        }
        
        div.onclick = () => { 
            if (box.opened) { 
                showOpenedBoxInfo(box); 
            } else { 
                openBox(i); 
            } 
        }; 
        container.appendChild(div); 
    }); 
}

function addBoxSettingRow(item = {}) {
    const container = document.getElementById('boxSettingsRowsContainer');
    const row = document.createElement('div');
    row.className = 'box-setting-row flex items-center gap-3 p-3 bg-gray-900 rounded-lg';

    const type = item.type || 'points';
    const value = item.value === 0 ? 0 : (item.value || '');
    const count = item.count || '';

    row.innerHTML = `
        <select class="setting-type flex-grow bg-gray-700 p-2 rounded-md text-white border border-gray-600" onchange="handleRowTypeChange(this)">
            <option value="points" ${type === 'points' ? 'selected' : ''}>ğŸ’° Puan</option>
            <option value="iflas" ${type === 'iflas' ? 'selected' : ''}>ğŸ’£ Ä°flas (Bomba)</option>
            <option value="surpriz" ${type === 'surpriz' ? 'selected' : ''}>ğŸ‰ SÃ¼rpriz Kutu</option>
            <option value="multiplier" ${type === 'multiplier' ? 'selected' : ''}>âœ–ï¸ Ã‡arpan</option>
            <option value="wheelTicket" ${type === 'wheelTicket' ? 'selected' : ''}>ğŸ« Ã‡ark Bileti</option>
            <option value="clickCatchTicket" ${type === 'clickCatchTicket' ? 'selected' : ''}>ğŸŸï¸ T-Y Bileti</option>
            <option value="iflasShield" ${type === 'iflasShield' ? 'selected' : ''}>ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
            <option value="wildcard" ${type === 'wildcard' ? 'selected' : ''}>ğŸƒ Joker Kart</option>
            <option value="card_pack" ${type === 'card_pack' ? 'selected' : ''}>ğŸ´ Standart Kart Paketi</option>
            <option value="card_pack_normal" ${type === 'card_pack_normal' ? 'selected' : ''}>ğŸ¥‰ Bronz Kart Paketi</option>
            <option value="card_pack_gumus" ${type === 'card_pack_gumus' ? 'selected' : ''}>ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
            <option value="card_pack_altin" ${type === 'card_pack_altin' ? 'selected' : ''}>ğŸ¥‡ AltÄ±n Kart Paketi</option>
            <option value="card_pack_efsanevi" ${type === 'card_pack_efsanevi' ? 'selected' : ''}>ğŸ† Efsanevi Kart Paketi</option>
        </select>
        <input type="number" value="${value}" class="setting-value w-28 bg-gray-700 p-2 rounded-md text-white border border-gray-600" placeholder="DeÄŸer">
        <input type="number" value="${count}" class="setting-count w-28 bg-gray-700 p-2 rounded-md text-white border border-gray-600" placeholder="Adet" oninput="updateTotalBoxCount()">
        <button class="bg-red-700 hover:bg-red-600 text-white p-2 rounded-md" onclick="this.parentElement.remove(); updateTotalBoxCount();">Sil</button>
    `;
    
    container.appendChild(row);
    handleRowTypeChange(row.querySelector('.setting-type'));
    updateTotalBoxCount();
}

// 2. Kutu AyarlarÄ±'nda seÃ§ilen tÃ¼re gÃ¶re "DeÄŸer" alanÄ±nÄ± yÃ¶netir (Joker Kart VE Kart Paketi dahil)
function handleRowTypeChange(selectElement) {
    const row = selectElement.parentElement;
    const valueInput = row.querySelector('.setting-value');
    const selectedType = selectElement.value;

    const typesWithValue = ['points', 'multiplier'];
    const typesWithAutoValue = ['wheelTicket', 'clickCatchTicket', 'iflasShield', 'wildcard', 'card_pack'];

    if (typesWithValue.includes(selectedType)) {
        valueInput.disabled = false;
        valueInput.placeholder = 'DeÄŸer';
        if(selectedType === 'multiplier') valueInput.placeholder = 'DeÄŸer (2, 3 vb.)';
    } else {
        valueInput.disabled = true;
        valueInput.placeholder = 'N/A';
        if(typesWithAutoValue.includes(selectedType)){
             valueInput.value = 1;
        } else {
             valueInput.value = 0;
        }
    }
}

async function openBox(index) {
    if (isGameLocked) {
        displayMessage("Kutular 1 saniye arayla aÃ§Ä±lÄ±yor. LÃ¼tfen tekrar deneyin. Sorun devam ediyorsa, sorunlarÄ± Ã§Ã¶z menÃ¼sÃ¼ne gÃ¶z atabilirsin.");
        return;
    }
    if (boxes[index].opened) return;
    if (isAdmin) {
        displayMessage("Adminler oyun oynamaz, sadece izler.");
        return;
    }

    const userRef = db.ref('users/' + currentUser);
    let userSnap = await userRef.once('value');
    let user = userSnap.val();

    if (!user) { displayMessage("KullanÄ±cÄ± verisi bulunamadÄ±."); return; }

    if ((user.kutuHakki || 0) < BOX_RIGHTS_COST_PER_BOX) {
        displayMessage("Yetersiz kutu hakkÄ±.");
        return;
    }

    const initialConfirm = await customConfirm(`<b>${boxes[index].id}</b> numaralÄ± kutuyu aÃ§mak istediÄŸinize emin misiniz?`);
    if (!initialConfirm) return;

    const boxRef = db.ref('boxes/' + index);
    let latestBoxSnap = await boxRef.once('value');
    if (latestBoxSnap.val().opened) {
        displayMessage(`SeÃ§tiÄŸiniz kutu <b>${latestBoxSnap.val().opener}</b> tarafÄ±ndan aÃ§Ä±ldÄ±. GeÃ§ kaldÄ±nÄ±z!`);
        return;
    }
    userSnap = await userRef.once('value');
    user = userSnap.val();

    let finalMultiplier = 1;
    let useMultiplier = false;
    const originalMultiplierSource = user.multiplierSource || 'none';

    if (user.multiplierSource === 'box') {
        finalMultiplier = user.activeMultiplier;
        useMultiplier = true;
    } else if (user.multiplierSource === 'store' && (user.multiplierRemainingUses || 0) > 0) {
        const confirmed = await customConfirm(`Mevcut <b>${user.activeMultiplier}x</b> Ã§arpanÄ±nÄ±zÄ± kullanmak ister misiniz?`);
        if (confirmed) {
            latestBoxSnap = await boxRef.once('value');
            if (latestBoxSnap.val().opened) {
                displayMessage(`Siz Ã§arpanÄ± onaylayana kadar bu kutu <b>${latestBoxSnap.val().opener}</b> tarafÄ±ndan aÃ§Ä±ldÄ±. HaklarÄ±nÄ±z ve Ã§arpanÄ±nÄ±z kullanÄ±lmadÄ±.`);
                return;
            }
            finalMultiplier = user.activeMultiplier;
            useMultiplier = true;
        }
    }

    const statsRef = db.ref(`gameStats/boxesOpenedByUsers/${currentUser}`);
    await statsRef.transaction(currentValue => {
        return (currentValue || 0) + 1;
    });

    const box = boxes[index];
    let message = '';
    const updates = {};
    updates['kutuHakki'] = (user.kutuHakki || 0) - BOX_RIGHTS_COST_PER_BOX;
    updates['boxesOpenedCount'] = (user.boxesOpenedCount || 0) + 1;

    const boxUpdate = { opened: true, opener: currentUser, id: box.id, content: box.content, value: box.value };
    const boxOpenInfo = { boxId: box.id, opener: currentUser, content: box.content, value: box.value, timestamp: firebase.database.ServerValue.TIMESTAMP };

    if (finalMultiplier > 1) {
        boxUpdate.multiplierApplied = finalMultiplier;
        boxOpenInfo.multiplierUsed = finalMultiplier;
    }
    
    let shouldLockGame = true;
    let shouldDisplayMessage = true;

    if (box.content === 'multiplier') {
        updates['multiplierFoundCount'] = (user.multiplierFoundCount || 0) + 1;
        
        if (user.multiplierSource === 'store' && user.multiplierRemainingUses > 0) {
            if (box.value === user.activeMultiplier) {
                updates['multiplierRemainingUses'] = (user.multiplierRemainingUses || 0) + 1;
                message = `Tebrikler! Mevcut <b>${user.activeMultiplier}x</b> Ã§arpanÄ±nla aynÄ± tÃ¼rde bir Ã§arpan daha buldun. KullanÄ±m hakkÄ±n <b>+1</b> arttÄ±!`;
                logActivity('multiplierStacked', currentUser, { value: user.activeMultiplier, uses: 1 });

            } else {
                shouldLockGame = false;
                shouldDisplayMessage = false;
                
                const existingMultiplier = {
                    value: user.activeMultiplier,
                    uses: user.multiplierRemainingUses
                };
                const foundMultiplier = {
                    value: box.value,
                    uses: 1
                };

                await userRef.update(updates);
                await boxRef.update(boxUpdate);
                await db.ref('lastOpenedBox').set(boxOpenInfo);
                
                openMultiplierChoiceModal({ hasMultiplier: true, existing: existingMultiplier, found: foundMultiplier });
                return;
            }

        } else {
            if (user.multiplierSource === 'box' && user.activeMultiplier > 1) {
                const oldValue = user.activeMultiplier;
                const newValue = box.value;
                const combinedValue = oldValue + newValue;

                updates['activeMultiplier'] = combinedValue;
                updates['multiplierSource'] = 'box';
                updates['multiplierRemainingUses'] = 0;
                
                message = `ÅanslÄ±sÄ±n! Mevcut tek kullanÄ±mlÄ±k <b>${oldValue}x</b> Ã§arpanÄ±n, kutudan Ã§Ä±kan <b>${newValue}x</b> ile birleÅŸerek <b>${combinedValue}x</b> gÃ¼cÃ¼ne ulaÅŸtÄ±!`;
                
                logActivity('multiplierCombined', currentUser, {
                    boxId: box.id,
                    oldValue: oldValue,
                    newValue: newValue,
                    combinedValue: combinedValue
                });

            } else {
                message = `Tebrikler! <b>${box.value}x Ã‡arpan</b> buldun! Bu Ã§arpan, bir sonraki kutu aÃ§Ä±lÄ±ÅŸÄ±nda otomatik olarak kullanÄ±lacak.`;
                updates['activeMultiplier'] = box.value;
                updates['multiplierSource'] = 'box';
                updates['multiplierRemainingUses'] = 0;
                logActivity('multiplierFound', currentUser, { boxId: box.id, value: box.value, multiplier: finalMultiplier });
            }
        }
    }
    else {
        if (useMultiplier) {
            if (originalMultiplierSource === 'box') {
                updates['activeMultiplier'] = 1;
                updates['multiplierSource'] = 'none';
            } else if (originalMultiplierSource === 'store') {
                updates['multiplierRemainingUses'] = (user.multiplierRemainingUses || 0) - 1;
                if (updates['multiplierRemainingUses'] <= 0) {
                    updates['multiplierSource'] = 'none';
                    updates['activeStoreMultiplierItemId'] = null;
                }
            }
        }

        if (box.content === 'points') {
            const pointsGained = box.value * finalMultiplier;
            updates['balance'] = (user.balance || 0) + pointsGained;
            if (updates['balance'] > (user.highestBalanceEver || 0)) updates['highestBalanceEver'] = updates['balance'];
            
            updates['kariyerPuani'] = (user.kariyerPuani || 0) + pointsGained;

            message = `+${pointsGained} puan kazandÄ±nÄ±z!`;
            boxUpdate.basePoints = box.value;
            boxUpdate.finalPoints = pointsGained;
            boxOpenInfo.basePoints = box.value;
            boxOpenInfo.finalPoints = pointsGained;
            logActivity('openBox', currentUser, { 
                boxId: box.id, 
                points: pointsGained, 
                multiplier: finalMultiplier, 
                newBalance: updates['balance'] 
            });
        }
        else if (box.content === 'iflas') {
            let shieldWasUsed = false;
            const lostPoints = user.balance || 0;
            let newBalanceForLog = user.balance || 0; 
            updates['iflasCount'] = (user.iflasCount || 0) + 1;
            if ((user.iflasShieldUses || 0) > 0) {
                updates['iflasShieldUses'] = (user.iflasShieldUses || 0) - 1;
                updates['iflasShieldUsedCount'] = (user.iflasShieldUsedCount || 0) + 1; 
                shieldWasUsed = true;
                message = `Ä°flas! ğŸ›¡ï¸ KalkanÄ±n seni korudu!`;
            } else {
                updates['balance'] = 0;
                newBalanceForLog = 0; 
                message = `Ä°flas! TÃ¼m puanlarÄ±n (${lostPoints} puan) silindi.`;
            }
            boxUpdate.shieldUsed = shieldWasUsed;
            boxUpdate.lostPoints = shieldWasUsed ? 0 : lostPoints;
            boxOpenInfo.shieldUsed = shieldWasUsed;
            boxOpenInfo.lostPoints = shieldWasUsed ? 0 : lostPoints;
            logActivity('iflas', currentUser, { 
                shieldUsed: shieldWasUsed, 
                lostPoints: shieldWasUsed ? 0 : lostPoints, 
                boxId: box.id, 
                multiplier: finalMultiplier,
                newBalance: newBalanceForLog 
            });
        }
        else if (box.content === 'surpriz') {
            updates['surpriseBoxesOpened'] = (user.surpriseBoxesOpened || 0) + 1;
            shouldLockGame = false;
            shouldDisplayMessage = false;

            const openedInTurnSnap = await db.ref(`gameStats/boxesOpenedByUsers/${currentUser}`).once('value');
            const openedBoxesThisRound = openedInTurnSnap.val() || 1; 

            const sessionRef = db.ref('surprise_box_session');
            await sessionRef.set({
                active: true, user: currentUser, boxId: box.id, multiplier: finalMultiplier,
                cards: shuffleArray([...cardValues]), selection: null, result: null,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                boxesOpenedThisRound: openedBoxesThisRound
            });

            const snap = await sessionRef.once('value');
            await sessionRef.update({ expirationTimestamp: snap.val().timestamp + 60000 });
            openCardSelectionModal(currentUser);
        }
        else if (box.content === 'wildcard') {
            const itemsGained = (box.value || 1) * finalMultiplier;
            const userSnapForCheck = await userRef.once('value');
            const userForCheck = userSnapForCheck.val();
            
            if (userForCheck.completedCollection === true) {
                const boxRightsToGain = itemsGained * 5;
                updates['kutuHakki'] = (user.kutuHakki || 0) + boxRightsToGain;
                message = `Harika! Koleksiyonu zaten tamamladÄ±ÄŸÄ±n iÃ§in kazandÄ±ÄŸÄ±n ${itemsGained} ğŸƒ Joker Kart, hesabÄ±na <b class="text-green-400">+${boxRightsToGain} Kutu HakkÄ±</b> olarak eklendi!`;
                logActivity('wildcardConverted', currentUser, { 
                    source: `${box.id} numaralÄ± kutu`,
                    wildcards: itemsGained, 
                    boxRights: boxRightsToGain,
                    multiplier: finalMultiplier
                });
            } else {
                updates['wildcards'] = (user.wildcards || 0) + itemsGained;
                message = `Ä°NANILMAZ! Kutudan <b class="text-purple-400">+${itemsGained} ğŸƒ Joker Kart</b> kazandÄ±n!`;
                logActivity('newItemFound', currentUser, { itemName: `+${itemsGained} Joker Kart`, itemType: 'wildcard', boxId: box.id, multiplier: finalMultiplier });
            }
        }
        else if (box.content.startsWith('card_pack')) {
            const packsToOpen = (box.value || 1) * finalMultiplier;
            
            const packNamesForPopup = {
                'card_pack': 'ğŸ´ Standart Kart Paketi',
                'card_pack_normal': 'ğŸ¥‰ Bronz Kart Paketi',
                'card_pack_gumus': 'ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi',
                'card_pack_altin': 'ğŸ¥‡ AltÄ±n Kart Paketi',
                'card_pack_efsanevi': 'ğŸ† Efsanevi Kart Paketi'
            };
            const packNameForPopup = packNamesForPopup[box.content] || 'Kart Paketi';
            
            const packNamesForLog = {
                'card_pack': 'Standart Kart Paketi',
                'card_pack_normal': 'Bronz Kart Paketi',
                'card_pack_gumus': 'GÃ¼mÃ¼ÅŸ Kart Paketi',
                'card_pack_altin': 'AltÄ±n Kart Paketi',
                'card_pack_efsanevi': 'Efsanevi Kart Paketi'
            };
            const packNameForLog = packNamesForLog[box.content] || 'Kart Paketi';
            
            message = `Tebrikler! Kutudan ${packsToOpen} adet ${packNameForPopup} buldun!`;
            
            logActivity('newItemFound', currentUser, { itemName: `+${packsToOpen} ${packNameForLog}`, itemType: box.content, boxId: box.id, multiplier: finalMultiplier });
            
            boxUpdate.value = `+${packsToOpen} ${packNameForPopup}`;
            boxOpenInfo.value = `+${packsToOpen} ${packNameForPopup}`;

            shouldLockGame = false; 
            shouldDisplayMessage = true; 
            startCardPackOpening(packsToOpen, `${box.id} numaralÄ± kutu`, finalMultiplier, box.content);
        }
        else {
            const itemsGained = box.value * finalMultiplier;
            const itemNames = { wheelTicket: 'Åans Ã‡arkÄ± Bileti', clickCatchTicket: 'TÄ±kla-Yakala Bileti', iflasShield: 'Ä°flas KalkanÄ±' };
            const dbKeys = { wheelTicket: 'carkBileti', clickCatchTicket: 'clickCatchTickets', iflasShield: 'iflasShieldUses' };
            updates[dbKeys[box.content]] = (user[dbKeys[box.content]] || 0) + itemsGained;
            message = `Kutudan <b>+${itemsGained} ${itemNames[box.content]}</b> kazandÄ±n!`;

            boxUpdate.baseValue = box.value;
            boxUpdate.finalValue = itemsGained;
            boxOpenInfo.baseValue = box.value;
            boxOpenInfo.finalValue = itemsGained;

            logActivity('newItemFound', currentUser, { itemName: `+${itemsGained} ${itemNames[box.content]}`, itemType: box.content, boxId: box.id, multiplier: finalMultiplier });
        }
    }

    await userRef.update(updates);
    await boxRef.update(boxUpdate);

    if (shouldDisplayMessage) {
        await db.ref('lastOpenedBox').set(boxOpenInfo);
        displayMessage(message);
    }
    
    if (shouldLockGame) {
        await db.ref('gameLock').set(true);
    }
}

// MEVCUT listenForActivityFeed FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
function listenForActivityFeed() {
    const ref = db.ref('activityFeed').orderByChild('timestamp').limitToLast(15);
    const callback = (snapshot) => {
        const feed = document.getElementById('activityFeed');
        feed.innerHTML = '';
        const activities = [];
        snapshot.forEach(child => {
            activities.push({ key: child.key, ...child.val() });
        });
        
        activities.reverse().forEach(activity => {
            let message = '';
            const details = activity.details || {};
            const timeAgo = formatTimeAgo(activity.timestamp);
            let icon = 'ğŸ’¬';

            switch (activity.type) {
                case 'buyItem':
                    icon = 'ğŸ›’';
                    const isKP = details.itemCost.toString().includes('KP');
                    const costText = isKP ? details.itemCost : `${formatNumber(details.itemCost)} Puan`;
                    const balance = isKP ? details.newKasaBalance : details.newBalance;
                    const balanceUnit = isKP ? 'KP' : 'PuanÄ±';
                    message = `<b class="text-yellow-300">${activity.username}</b>, maÄŸazadan <b class="text-red-500">-${costText}</b> harcayarak <b class="text-green-400">${details.itemName}</b> aldÄ±. (Mevcut ${balanceUnit}: ${formatNumber(balance)})`;
                    break;

                case 'spinWheel':
                    icon = 'ğŸ¡';
                    const prizeText = details.type === 'pas' 
                        ? 'Pas geÃ§ti' 
                        : `<b class="text-green-400">${details.result}</b> kazandÄ±`;
                    message = `<b class="text-yellow-300">${activity.username}</b>, Ã§arkÄ± Ã§evirerek ${prizeText}.`;
                    break;
                
                // KUTU EYLEMLERÄ° Ä°Ã‡Ä°N STANDART FORMAT
                case 'openBox':
                case 'iflas':
                case 'multiplierFound':
                case 'newItemFound':
                    const multiplierText = details.multiplier > 1 
                        ? `(<b>${details.multiplier}x</b> Ã§arpan kullandÄ±)` 
                        : `(Ã§arpan kullanmadÄ±)`;
                    let prizeHtml = '';

                    if (activity.type === 'openBox') {
                        icon = 'ğŸ“¦';
                        prizeHtml = `<b class="text-green-400">+${details.points} Puan</b>`;
                    } else if (activity.type === 'iflas') {
                        icon = 'ğŸ“¦';
                        prizeHtml = details.shieldUsed ? '<b class="text-blue-400">Ä°flas etti ama kalkanÄ± korudu</b>' : '<b class="text-red-500">Ä°flas etti</b>';
                    } else if (activity.type === 'multiplierFound') {
                        icon = 'ğŸ“¦';
                        prizeHtml = `<b class="text-yellow-400">${details.value}x Ã‡arpan</b>`;
                    } else if (activity.type === 'newItemFound') {
                        icon = 'ğŸ“¦';
                        if (details.itemType === 'wildcard') icon = 'ğŸƒ';
                        if (details.itemType === 'card_pack') icon = 'ğŸ´';
                        prizeHtml = `<b class="text-cyan-400">${details.itemName}</b>`;
                    }
                    
                    message = `<b class="text-yellow-300">${activity.username}</b>, ${details.boxId} numaralÄ± kutudan ${prizeHtml} kazandÄ±. ${multiplierText}`;
                    break;
                
                // DÃ–NÃœÅÃœM EYLEMLERÄ° Ä°Ã‡Ä°N YENÄ° FORMATLAR
                case 'cardPackConverted':
                    icon = 'ğŸ´';
                    const packsMultiplierText = details.multiplier > 1 
                        ? `(<b>${details.multiplier}x</b> Ã§arpan kullandÄ±)` 
                        : `(Ã§arpan kullanmadÄ±)`;
                    message = `<b class="text-yellow-300">${activity.username}</b>, ${details.source}'dan <b class="text-purple-400">+${details.packs} Kart Paketi</b> buldu. AlbÃ¼mÃ¼ tamamladÄ±ÄŸÄ± iÃ§in <b class="text-green-400">+${formatNumber(details.points)} Puana</b> dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼. ${packsMultiplierText}`;
                    break;
                case 'wildcardConverted':
                    icon = 'ğŸƒ';
                    const wildcardsMultiplierText = details.multiplier > 1 
                        ? `(<b>${details.multiplier}x</b> Ã§arpan kullandÄ±)` 
                        : `(Ã§arpan kullanmadÄ±)`;
                    message = `<b class="text-yellow-300">${activity.username}</b>, ${details.source}'dan <b class="text-purple-400">+${details.wildcards} Joker Kart</b> buldu. AlbÃ¼mÃ¼ tamamladÄ±ÄŸÄ± iÃ§in <b class="text-cyan-400">+${details.boxRights} Kutu HakkÄ±</b> ile deÄŸiÅŸtirildi. ${wildcardsMultiplierText}`;
                    break;

                case 'collectionCompleted':
                    icon = 'ğŸ†';
                    if (details.isFirst) {
                        message = `<b class="text-yellow-300">${activity.username}</b>, koleksiyonu tamamlayan <b class="text-amber-400">Ä°LK KÄ°ÅÄ°</b> oldu ve bÃ¼yÃ¼k Ã¶dÃ¼lÃ¼ kazandÄ±!`;
                    } else {
                        message = `<b class="text-yellow-300">${activity.username}</b>, koleksiyonu tamamlayarak bÃ¼yÃ¼k Ã¶dÃ¼lÃ¼ kazandÄ±!`;
                    }
                    break;
                default:
                    message = ``; 
            }
            
            if (message) {
                feed.innerHTML += `
                    <div class="activity-item">
                        <div class="activity-icon">${icon}</div>
                        <div class="activity-text">${message}</div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>`;
            }
        });
    };
    activeListeners.activityFeed = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// MEVCUT listenForLastOpenedBox FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
function listenForLastOpenedBox() {
    const ref = db.ref('lastOpenedBox');
    const callback = (snap) => {
        const data = snap.val();
        const infoDiv = document.getElementById('lastOpenedBoxInfo');
        if (data && data.opener) {
            let contentHtml = '';
            if (data.content === 'points') {
                contentHtml = `<span class="text-green-400 font-bold">${data.finalPoints} Puan</span> kazandÄ±!`;
            } else if (data.content === 'iflas') {
                contentHtml = data.shieldUsed 
                    ? `<span class="text-blue-400 font-bold">Ä°flas etti ama KalkanÄ± onu korudu!</span>`
                    : `<span class="text-red-500 font-bold">Ä°flas etti!</span>`;
            } else if (data.content === 'multiplier') {
                contentHtml = `<span class="text-yellow-400 font-bold">${data.value}X Ã‡arpan</span> buldu!`;
            } 
            else if (data.content === 'card_pack') {
                 contentHtml = `<span class="text-purple-400 font-bold">${data.value}</span> buldu!`;
            }
            else {
                const itemsGained = data.finalValue || data.value;
                const itemNames = { wheelTicket: 'Ã‡ark Bileti', clickCatchTicket: 'T-Y Bileti', iflasShield: 'Ä°flas KalkanÄ±', wildcard: 'Joker Kart' };
                const friendlyName = itemNames[data.content] || 'bir eÅŸya';
                contentHtml = `<span class="text-cyan-400 font-bold">+${itemsGained} ${friendlyName}</span> kazandÄ±!`;
            }

            infoDiv.innerHTML = `
                <span class="font-bold text-yellow-300">${data.opener}</span> adlÄ± oyuncu 
                <span class="font-bold text-gray-300">${data.boxId}</span> numaralÄ± kutudan 
                ${contentHtml}
            `;
        } else {
            infoDiv.textContent = 'HenÃ¼z kimse kutu aÃ§madÄ±.';
        }
    };
    activeListeners.lastOpenedBox = { ref, event: 'value', callback };
    ref.on('value', callback);
}

  async function revealAll() { const confirmed = await customConfirm("TÃ¼m kutularÄ± aÃ§mak istiyor musunuz?"); if(confirmed) { boxes.forEach(b => { if (!b.opened) { b.opened = true; b.opener = 'Admin'; } }); db.ref('boxes').set(boxes).then(() => displayMessage("TÃ¼m kutular baÅŸarÄ±yla aÃ§Ä±ldÄ±.")) } }
  
  async function resetGameBoard() {
      console.log("resetGameBoard fonksiyonu Ã§alÄ±ÅŸtÄ±! Oyun sÄ±fÄ±rlanÄ±yor...");
      await createBoxes();
      // Oyunu sÄ±fÄ±rlarken, SADECE "kim kaÃ§ kutu aÃ§tÄ±" istatistiÄŸini temizliyoruz.
      await db.ref('gameStats/boxesOpenedByUsers').remove();
      // ---------------------------------
      await db.ref('lastOpenedBox').remove();
      await db.ref('gameLock').set(false);
}

async function handleSurpriseBoxCleanup(sessionData) {
    if (!sessionData) return;

    // --- SÃœRPRÄ°Z KUTU DÃœZELTMESÄ°: Kutunun nereden geldiÄŸini kontrol et ---
    if (sessionData.boxId !== 'Ã‡ark') {
    }
    
    // Her durumda, sÃ¼rpriz kutu oturumunu veritabanÄ±ndan temizle.
    await db.ref('surprise_box_session').remove();
}

  async function resetGame() {
      const confirmed = await customConfirm("Oyunu sÄ±fÄ±rlamak istiyor musunuz? (TÃ¼m kutular kapatÄ±lÄ±r, karÄ±ÅŸtÄ±rÄ±lÄ±r ve kutu aÃ§ma istatistikleri sÄ±fÄ±rlanÄ±r)");
      if (confirmed) {
          await resetGameBoard();
          displayMessage("Oyun yÃ¶neticisi tarafÄ±ndan sÄ±fÄ±rlandÄ±.");
      }
  }

  async function restartSystem() {
    const confirmed = await customConfirm("Sistemi baÅŸtan baÅŸlatmak istediÄŸinize emin misiniz? TÃ¼m kullanÄ±cÄ± verileri (puan, hak, istatistik) sÄ±fÄ±rlanacak!");
    if (confirmed) {
        const userSnap = await db.ref('users').once('value');
        const usersData = userSnap.val();
        const updates = {};
        if (usersData) {
            for (const u in usersData) {
                if (u !== "weizendtv") {
                    updates['users/' + u + '/balance'] = 0;
                    updates['users/' + u + '/highestBalanceEver'] = 0;
                    updates['users/' + u + '/totalSpentPoints'] = 0;
                    updates['users/' + u + '/kutuHakki'] = 0;
                    updates['users/' + u + '/carkBileti'] = 0; // YENÄ°
                    updates['users/' + u + '/clickCatchHighestScore'] = 0; // YENÄ°
                    updates['users/' + u + '/boxesOpenedCount'] = 0;
                    updates['users/' + u + '/surpriseBoxesOpened'] = 0;
                    updates['users/' + u + '/activeMultiplier'] = 1;
                    updates['users/' + u + '/multiplierSource'] = 'none';
                    updates['users/' + u + '/multiplierRemainingUses'] = 0;
                    updates['users/' + u + '/activeStoreMultiplierItemId'] = null;
                    updates['users/' + u + '/iflasShieldUses'] = 0;
                    updates['users/' + u + '/iflasCount'] = 0;
                    updates['users/' + u + '/iflasShieldUsedCount'] = 0;
                    updates['users/' + u + '/multiplierFoundCount'] = 0;
                    updates['users/' + u + '/storePurchasesCount'] = 0;
                    updates['users/' + u + '/hasReceivedWelcomeGift'] = false;
                    updates['users/' + u + '/approvalNotified'] = null;
                    updates['users/' + u + '/notifications'] = null;
                    updates['users/' + u + '/dailyRewardsClaimed'] = null;
                    updates['users/' + u + '/lastSeenAnnouncementTimestamp'] = null;
                    updates['users/' + u + '/lastSeenGlobalNotifTimestamp'] = null; // YENÄ° EKLENEN SATIR
                }
            }
            await db.ref().update(updates);
        }
        await createBoxes();
        await db.ref('purchaseHistory').remove();
        await db.ref('pendingSpecialPurchases').remove();
        await db.ref('gameStats').remove();
        await db.ref('announcements').remove();
        await db.ref('dailyRewardOptions').remove();
        await db.ref('gameConfig').remove(); // <-- BU SATIRI EKLE
        displayMessage("Sistem baÅŸarÄ±yla baÅŸtan baÅŸlatÄ±ldÄ±!");
    }
  }

  function loadTotalOpenedBoxesCount() {
    const ref = db.ref('boxes');
    const callback = snap => {
        const allBoxes = snap.val();
        let openedCount = 0;
        if (allBoxes) {
            openedCount = allBoxes.filter(box => box.opened).length;
        }
        document.getElementById('totalOpenedBoxesCount').textContent = openedCount;
    };
    activeListeners.totalOpenedBoxes = { ref, event: 'value', callback };
    ref.on('value', callback);
  }
  
  // YENÄ° VE DÃœZGÃœN Ã‡ALIÅAN KOD (Bununla deÄŸiÅŸtir)
function searchUsers() {
    const term = document.getElementById("searchUser").value.trim().toLowerCase();
    db.ref('users').once('value').then(snap => {
        const data = snap.val();
        let html = "";
        if (data) {
            for (const u in data) {
                if (u.toLowerCase() === "weizendtv") continue;

                // Arama terimine gÃ¶re filtreleme
                if (u.toLowerCase().includes(term)) {
                    const user = data[u];
                    let blockedStatusHtml = '';
                    const isCurrentlyBlocked = user.blocked && user.blockedUntil && Date.now() < user.blockedUntil;

                    if (isCurrentlyBlocked) {
                        blockedStatusHtml = `<span class="text-red-400">(Engelli - <span id="admin-countdown-${u}">--:--</span>)</span>`;
                        // Not: Bu arama fonksiyonu anlÄ±k olduÄŸu iÃ§in geri sayÄ±m sayacÄ±nÄ± burada yeniden baÅŸlatmak 
                        // karmaÅŸÄ±k olabilir, ancak en azÄ±ndan "Engelli" durumu doÄŸru gÃ¶rÃ¼necektir.
                    } else if (user.blocked) {
                        blockedStatusHtml = `<span class="text-green-400">(Engel SÃ¼resi Doldu)</span>`;
                    }

                    const avatarUrl = user.selectedAvatar ? user.selectedAvatar.url : defaultAvatarUrl;
                    html += `<div class="flex items-center justify-between p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-blue-500 cursor-pointer hover:bg-gray-600 transition-colors" onclick="openUserManagementModal('${u}')">
                        <div class="flex items-center">
                            <img src="${avatarUrl}" class="w-12 h-12 rounded-md mr-3 object-contain">
                            <span class="text-gray-200">${u} ${blockedStatusHtml}</span>
                        </div>
                        <span class="text-yellow-300">Puan: ${user.balance || 0}</span>
                    </div>`;
                }
            }
        }
        document.getElementById("allUsers").innerHTML = html || "<div class='text-center text-gray-400'>Aramayla eÅŸleÅŸen kullanÄ±cÄ± bulunamadÄ±.</div>";
    });
}
  
  function displayBlockedMessage(blockedUntil, username) {
      blockedMessageModal.style.display = 'flex';
      document.getElementById('blockedReason').textContent = "HesabÄ±nÄ±z geÃ§ici olarak engellendi. SÃ¼re dolduÄŸunda devam edebilirsiniz.";
      
      if(countdownInterval) clearInterval(countdownInterval);

      const updateCountdown = () => {
          const timeLeft = blockedUntil - Date.now();
          if (timeLeft <= 0) {
              document.getElementById('blockedCountdown').textContent = "Engel sÃ¼reniz doldu!";
              clearInterval(countdownInterval);
              setTimeout(() => {
                 blockedMessageModal.style.display = 'none';
                 if (username === currentUser) {
                    db.ref('users/' + username).update({ blocked: false, blockedUntil: null });
                 }
              }, 2000);
              return;
          }
          const minutes = Math.floor(timeLeft / 60000);
          const seconds = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, '0');
          document.getElementById('blockedCountdown').textContent = `Kalan sÃ¼re: ${minutes}:${seconds}`;
      };
      countdownInterval = setInterval(updateCountdown, 1000);
      updateCountdown();
  }
  
  // YENÄ° VE GÃœNCELLENMÄ°Å FONKSÄ°YON
// YENÄ° VE DÃœZGÃœN Ã‡ALIÅAN KOD (Bununla deÄŸiÅŸtir)
function showOpenedBoxInfo(box) {
    let contentDisplay = '';

    const itemNames = {
        wheelTicket: 'Åans Ã‡arkÄ± Bileti',
        clickCatchTicket: 'TÄ±kla-Yakala Bileti',
        iflasShield: 'Ä°flas KalkanÄ±',
        wildcard: 'Joker Kart',
        card_pack: 'Kart Paketi'
    };

    if (box.content === 'points') {
        let multiplierText = ` (Ã‡arpan kullanÄ±lmadÄ±)`;
        // DEÄÄ°ÅÄ°KLÄ°K BURADA: 'multiplierUsed' yerine 'multiplierApplied' kullanÄ±ldÄ±
        if (box.multiplierApplied && box.multiplierApplied > 1) { 
            multiplierText = ` (${box.basePoints} Puan x ${box.multiplierApplied} Ã‡arpan)`;
        }
        contentDisplay = `<b>+${box.finalPoints} Puan</b><br><span class="text-sm text-gray-400">${multiplierText}</span>`;
    } 
    else if (box.content === 'iflas') {
        contentDisplay = box.shieldUsed ? 'Ä°flas (Kalkanla Korundu)' : (box.lostPoints ? `Ä°flas (-${box.lostPoints} Puan)` : 'Ä°flas');
    } 
    else if (box.content === 'multiplier') {
        contentDisplay = `<b>${box.value}X Ã‡arpan</b>`;
    } 
    else if (box.content === 'surpriz') {
        contentDisplay = 'SÃ¼rpriz Kutu';
    } 
    else if (itemNames[box.content]) { // DiÄŸer tÃ¼m eÅŸyalar iÃ§in (Bilet, Kalkan, Joker, Kart Paketi)
        const itemName = itemNames[box.content];
        const finalValue = box.finalValue || box.value || 1;
        contentDisplay = `<b>+${finalValue} Adet ${itemName}</b>`;
        // DEÄÄ°ÅÄ°KLÄ°K BURADA: 'multiplierUsed' yerine 'multiplierApplied' kullanÄ±ldÄ±
        if (box.multiplierApplied && box.multiplierApplied > 1) {
            const baseValue = box.baseValue || 1;
            contentDisplay += `<br><span class="text-sm text-gray-400">(${baseValue} Adet x ${box.multiplierApplied} Ã‡arpan)</span>`;
        }
    }

    const contentHtml = `<div class='text-center mb-4'><p class='text-gray-400'>${box.id} Nolu Kutuyu AÃ§an</p><p class='text-2xl font-bold text-green-400 py-2'>${box.opener}</p></div><hr class="border-gray-600 my-3"><p class="text-xl"><b>Ä°Ã§erik:</b> ${contentDisplay}</p>`;
    document.getElementById('openedBoxInfoContent').innerHTML = contentHtml;
    openedBoxInfoModal.style.display = 'flex';
}
  
  function closeOpenedBoxInfoModal() { openedBoxInfoModal.style.display = 'none'; }
  function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
  
  function openCardSelectionModal(userId) {
    if (countdownInterval) clearInterval(countdownInterval);
    cardContainer.innerHTML = '';
    const sessionRef = db.ref('surprise_box_session');

    sessionRef.once('value').then(snap => {
        const sessionData = snap.val();
        if (!sessionData || !sessionData.active || sessionData.result) return;

        sessionData.cards.forEach((cardValue, index) => {
            // Ã‡Ã–ZÃœM: CSS'in beklediÄŸi doÄŸru HTML yapÄ±sÄ± burada oluÅŸturuluyor.
            const containerDiv = document.createElement('div');
            containerDiv.className = 'card-flip-container'; // Ana container
            containerDiv.dataset.value = cardValue;
            containerDiv.dataset.index = index;
            
            containerDiv.innerHTML = `
                <div class="card-flipper">
                    <div class="card-front bg-gradient-to-br from-red-700 to-red-900 flex items-center justify-center text-white text-6xl font-bold">
                        ?
                    </div>
                    <div class="card-back bg-gray-900 flex flex-col items-center justify-center text-yellow-400 text-3xl">
                        
                    </div>
                </div>
            `;

            containerDiv.onclick = () => selectCard(containerDiv, userId);
            cardContainer.appendChild(containerDiv);
        });
        
        cardSelectionModal.style.display = 'flex';

        const countdownEl = document.getElementById('cardSelectionCountdown');
        let timeLeft = Math.round((sessionData.expirationTimestamp - getSyncedTime()) / 1000);

        const handleTimeout = () => {
            // ... (bu kÄ±sÄ±m aynÄ± kalÄ±yor)
        };

        if (timeLeft <= 0) {
            // ... (bu kÄ±sÄ±m aynÄ± kalÄ±yor)
            return;
        }

        countdownEl.textContent = timeLeft;
        countdownInterval = setInterval(() => {
            // ... (bu kÄ±sÄ±m aynÄ± kalÄ±yor)
        }, 1000);
    });
}

// MEVCUT selectCard fonksiyonunu bununla deÄŸiÅŸtir
async function selectCard(selectedCardDiv, userId) { 
    if (countdownInterval) clearInterval(countdownInterval);
    if (selectedCardDiv.classList.contains('opened')) return; 

    const cardIndex = selectedCardDiv.dataset.index;
    const sessionRef = db.ref('surprise_box_session');
    
    await sessionRef.child('selection').set({ user: userId, cardIndex: cardIndex });

    const snap = await sessionRef.once('value');
    const sessionData = snap.val();
    let points = parseInt(selectedCardDiv.dataset.value) * sessionData.multiplier;
    
    const userRef = db.ref('users/' + userId); 

    // KARÄ°YER PUANI GÃœNCELLEMESÄ° (Transaction ile)
    await userRef.transaction(user => {
        if (user) {
            user.balance = (user.balance || 0) + points;
            if (user.balance > (user.highestBalanceEver || 0)) {
                user.highestBalanceEver = user.balance;
            }
            user.kariyerPuani = (user.kariyerPuani || 0) + points;
        }
        return user;
    });

    const finalUserSnap = await userRef.once('value');
    const finalUserData = finalUserSnap.val();
    let newBalance = finalUserData.balance || 0;
 
    await sessionRef.child('result').set({ points: points, newBalance: newBalance });
}

// MEVCUT listenForSurpriseBox FONKSÄ°YONUNU SÄ°L VE BUNUNLA DEÄÄ°ÅTÄ°R

let isProcessingSurpriseResult = false;
let spectatorViewingResult = false;

function listenForSurpriseBox() {
    const sessionRef = db.ref('surprise_box_session');
    
    if (activeListeners.surpriseBox) {
        activeListeners.surpriseBox.ref.off(activeListeners.surpriseBox.event, activeListeners.surpriseBox.callback);
    }

    const callback = snap => {
        const sessionData = snap.val();

        if (sessionData && sessionData.active && !sessionData.result) {
            const sessionAge = getSyncedTime() - sessionData.timestamp;
            if (sessionAge > 70000) {
                console.log("Zaman aÅŸÄ±mÄ±na uÄŸramÄ±ÅŸ SÃ¼rpriz Kutu oturumu tespit edildi ve temizleniyor...");
                sessionRef.remove();
                return; 
            }
        }

        if (sessionData && sessionData.active) {
            if (sessionData.user === currentUser && !sessionData.result && cardSelectionModal.style.display !== 'flex') {
                openCardSelectionModal(currentUser);
            }
            
            if (sessionData.selection && sessionData.result && spectatorModal.style.display === 'flex') {
                updateSpectatorView(sessionData);
            }

            if (sessionData.user !== currentUser && !sessionData.result && sessionData.expirationTimestamp && spectatorModal.style.display !== 'flex' && !isProcessingSurpriseResult) {
                openSpectatorModal(sessionData);
            }

            if (sessionData.result && !sessionData.logged && !isProcessingSurpriseResult) {
                isProcessingSurpriseResult = true; 

                sessionRef.transaction(currentData => {
                    if (currentData && currentData.result && !currentData.logged) {
                        currentData.logged = true; 
                        return currentData;
                    }
                    return; 
                }, (error, committed, snapshot) => {
                    if (error) {
                        console.error('SÃ¼rpriz kutu iÅŸlemi sÄ±rasÄ±nda transaction hatasÄ±: ', error);
                        isProcessingSurpriseResult = false;
                    } else if (committed) {
                        const finalSessionData = snapshot.val();

                        const surpriseInfo = {
                            finder: finalSessionData.user,
                            boxId: finalSessionData.boxId,
                            points: finalSessionData.result.points,
                            newBalance: finalSessionData.result.newBalance,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        };

                        if (finalSessionData.boxId === 'Ã‡ark') {
                            db.ref('gameStats/lastWheelSurpriseInfo').set(surpriseInfo);
                        } else {
                            surpriseInfo.boxesOpenedThisRound = finalSessionData.boxesOpenedThisRound || null;
                            surpriseInfo.resettledBy = null;
                            surpriseInfo.resettled = false; // YENÄ° EKLENEN SATIR: SÄ±fÄ±rlama hakkÄ± doÄŸdu
                            db.ref('gameStats/lastSurpriseInfo').set(surpriseInfo);
                        }
                        
                        logActivity('surpriseBox', finalSessionData.user, { 
                            boxId: finalSessionData.boxId,
                            points: finalSessionData.result.points, 
                            multiplier: finalSessionData.multiplier,
                            newBalance: finalSessionData.result.newBalance
                        });
                        
                        if (finalSessionData.user === currentUser) {
                            closeCardSelectionModal();
                            displayMessage(`SÃ¼rpriz kutudan tebrikler! Toplam ${finalSessionData.result.points} puan kazandÄ±nÄ±z!`);
                        } else {
                            showGlobalSurpriseBoxNotification(finalSessionData);
                        }
                        
                        setTimeout(() => {
                            closeGlobalSurpriseBoxModal(); 
                            handleSurpriseBoxCleanup(finalSessionData);
                            isProcessingSurpriseResult = false;
                        }, 4000);
                    } else {
                        isProcessingSurpriseResult = false;
                    }
                });
            }
        } else {
            if (!spectatorViewingResult) {
                closeSpectatorModal();
            }
        }
    };

    activeListeners.surpriseBox = { ref: sessionRef, event: 'value', callback };
    sessionRef.on('value', callback);
}

  function closeCardSelectionModal() { 
    cardSelectionModal.style.display = 'none'; 
  }
  
  const storeItemsRef = db.ref('storeItems');

  function openNewItemForm() {
    resetStoreItemForm();
    openAdminStoreModal();
  }

  function openAdminStoreModal() {
    document.getElementById('gameDiv').classList.add('modal-is-open');
    adminStoreModal.style.display = 'flex';
  }

  // Bu fonksiyon, "ÃœrÃ¼n Ekle / DÃ¼zenle" panelini kapatÄ±r.
function closeAdminStoreModal() {
    document.getElementById('gameDiv').classList.remove('modal-is-open');
    adminStoreModal.style.display = 'none';
    resetStoreItemForm();
}
  
  function loadStoreItems() {
    const ref = storeItemsRef;
    const callback = snap => {
        const items = snap.val();
        renderStoreItems(items);
    };
    activeListeners.storeItems = { ref, event: 'value', callback };
    ref.on('value', callback);
  }
  
  function updateStoreCountdowns() {
      const now = Date.now();
      for (const itemId in activeStoreCountdowns) {
          const { endTime } = activeStoreCountdowns[itemId];
          const countdownEl = document.getElementById(`countdown-${itemId}`);
          const buyButton = document.getElementById(`buy-btn-${itemId}`);
          
          if (!countdownEl) continue;

          const timeLeft = endTime - now;

          if (timeLeft > 0) {
              const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
              const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
              const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
              const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
              
              let parts = [];
              if (days > 0) parts.push(`${days}g`);
              if (hours > 0) parts.push(`${hours}sa`);
              if (minutes > 0) parts.push(`${minutes}d`);
              if (seconds >= 0) parts.push(`${seconds}sn`);
              
              const timeString = parts.join(' ');

              countdownEl.innerHTML = `Kalan SÃ¼re: <b class="text-white">${timeString}</b>`;
          } else {
              countdownEl.innerHTML = `<span class="text-red-500 font-bold">SÃ¼re Doldu</span>`;
              if (buyButton) {
                  buyButton.disabled = true;
                  buyButton.classList.add('bg-gray-600', 'cursor-not-allowed');
                  buyButton.classList.remove('bg-red-700', 'hover:bg-red-600');
              }
              delete activeStoreCountdowns[itemId];
          }
      }
  }

  // DEÄÄ°ÅTÄ°RÄ°LECEK FONKSÄ°YON
function renderStoreItems(items) { 
    const gameContainer = document.getElementById('gameStoreItemsContainer');
    const specialContainer = document.getElementById('specialStoreItemsContainer');
    gameContainer.innerHTML = '';
    specialContainer.innerHTML = '';

    if (storeCountdownInterval) clearInterval(storeCountdownInterval);
    activeStoreCountdowns = {};

    if (!items) {
        const placeholder = '<p class="text-center col-span-full text-gray-400">MaÄŸazada ÅŸu an Ã¼rÃ¼n bulunmamaktadÄ±r.</p>';
        gameContainer.innerHTML = placeholder;
        specialContainer.innerHTML = placeholder;
        return;
    }
    
    // ÃœrÃ¼nleri Ã¶nce kategoriye ayÄ±r, sonra sÄ±rala
    let allItemsArray = Object.entries(items);
    let gameItems = allItemsArray
        .filter(([, item]) => item.type !== 'special')
        .sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

    let specialItems = allItemsArray
        .filter(([, item]) => item.type === 'special')
        .sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

    let bestSellerGameItemId = null;
    if (gameItems.length > 0) {
      const sortedByPurchase = [...gameItems].sort(([,a], [,b]) => (b.purchaseCount || 0) - (a.purchaseCount || 0));
      if((sortedByPurchase[0][1].purchaseCount || 0) > 0) {
        bestSellerGameItemId = sortedByPurchase[0][0];
      }
    }

    let bestSellerSpecialItemId = null;
    if (specialItems.length > 0) {
      const sortedByPurchase = [...specialItems].sort(([,a], [,b]) => (b.purchaseCount || 0) - (a.purchaseCount || 0));
      if((sortedByPurchase[0][1].purchaseCount || 0) > 0) {
        bestSellerSpecialItemId = sortedByPurchase[0][0];
      }
    }

    const renderItem = (itemData, container) => {
        const [itemId, item] = itemData; // itemID ve item objesini ayÄ±r
        const isSpecial = item.type === 'special';
        const list = isSpecial ? specialItems : gameItems;
        const index = list.findIndex(([id]) => id === itemId); // Kendi listesindeki index'i bul
        const isBestSeller = isSpecial ? itemId === bestSellerSpecialItemId : itemId === bestSellerGameItemId;

        const outOfStock = item.stock !== undefined && item.stock <= 0;
        let isExpired = false;
        let countdownHtml = '';
        
        let adminControlsHtml = '';
        if(isAdmin){
          const leftArrowDisabled = index === 0 ? 'disabled' : '';
          const rightArrowDisabled = index === list.length - 1 ? 'disabled' : '';
          adminControlsHtml = `
            <div class="admin-controls absolute top-0 right-0 p-1 bg-gray-900 bg-opacity-70 rounded-bl-lg flex gap-1 z-10">
                <button onclick="reorderStoreItem('${itemId}', ${index - 1})" ${leftArrowDisabled} title="Sola TaÅŸÄ±" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/></svg>
                </button>
                <button onclick="editStoreItem('${itemId}')" title="DÃ¼zenle" class="p-1 rounded-full hover:bg-gray-700">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a1 1 0 011-1h2.586l-2 2H6v3h3v-1.586l2-2H13a1 1 0 011 1v5a1 1 0 01-1 1H6a1 1 0 01-1-1v-2z"/></svg>
                </button>
                 <button onclick="deleteStoreItem('${itemId}')" title="Sil" class="p-1 rounded-full hover:bg-gray-700">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"/></svg>
                </button>
                <button onclick="reorderStoreItem('${itemId}', ${index + 1})" ${rightArrowDisabled} title="SaÄŸa TaÅŸÄ±" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>
                </button>
            </div>`;
        }

        if (item.countdownDurationMinutes && item.createdAt) {
            const endTime = item.createdAt + item.countdownDurationMinutes * 60 * 1000;
            if (Date.now() > endTime) {
                isExpired = true;
            } else {
                activeStoreCountdowns[itemId] = { endTime: endTime };
                countdownHtml = `<div id="countdown-${itemId}" class="text-sm text-yellow-300 font-bold mb-2 h-5"></div>`;
            }
        } else {
            countdownHtml = `<div class="h-5 mb-2"></div>`;
        }

        const disabled = outOfStock || isExpired;
        
        const popularityHtml = `<p class="text-blue-300 text-sm mb-2">ğŸ”¥ ${item.purchaseCount || 0} kez satÄ±n alÄ±ndÄ±</p>`;
        const bestSellerBadge = isBestSeller ? `<span class="best-seller-badge absolute top-2 left-2 bg-yellow-500 text-gray-900 text-xs font-bold px-2 py-1 rounded-full z-10">Ã‡OK SATAN</span>` : '';
        const cardClass = isBestSeller ? 'glowing-border' : 'border-red-700';

        const cardDiv = document.createElement('div');
        cardDiv.className = `relative bg-gray-800 p-6 rounded-xl shadow-lg border-2 ${cardClass} text-center flex flex-col justify-between`;
        cardDiv.innerHTML = `
            ${adminControlsHtml}
            ${bestSellerBadge}
            <div class="flex-grow">
              <img src="${item.imageUrl || 'https://via.placeholder.com/150'}" alt="${item.name}" class="w-24 h-24 mx-auto mb-4 rounded-lg object-cover">
              <h4 class="text-yellow-400 text-xl font-bold">${item.name}</h4>
              <p class="text-gray-300 mb-2 flex-grow">${item.description}</p>
            </div>
            <div>
              ${countdownHtml}
              ${popularityHtml}
              <p class="text-gray-400 text-sm mb-2">Stok: ${item.stock !== undefined && item.stock !== null ? item.stock : 'SÄ±nÄ±rsÄ±z'}</p>
              <p class="text-green-400 text-2xl font-bold mb-4">${item.cost} Puan</p>
              <button id="buy-btn-${itemId}" onclick="buyItem('${itemId}')" ${disabled ? 'disabled' : ''} class="w-full py-3 mt-auto ${disabled ? 'bg-gray-600 cursor-not-allowed' : 'bg-red-700 hover:bg-red-600'} text-white font-bold rounded-lg transition duration-300">
                ${isExpired ? 'SÃ¼re Doldu' : (outOfStock ? 'Stok TÃ¼kendi' : 'SatÄ±n Al')}
              </button>
            </div>
          `;
        container.appendChild(cardDiv);
    };

    if (gameItems.length > 0) {
      gameItems.forEach(itemData => renderItem(itemData, gameContainer));
    } else {
      gameContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">Oyun maÄŸazasÄ±nda Ã¼rÃ¼n bulunmamaktadÄ±r.</p>';
    }
    
    if (specialItems.length > 0) {
      specialItems.forEach(itemData => renderItem(itemData, specialContainer));
    } else {
      specialContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">Ã–zel Ã¼rÃ¼n maÄŸazasÄ±nda Ã¼rÃ¼n bulunmamaktadÄ±r.</p>';
    }

    if (Object.keys(activeStoreCountdowns).length > 0) {
        updateStoreCountdowns();
        storeCountdownInterval = setInterval(updateStoreCountdowns, 1000);
    }
}

async function buyItem(itemId) {
    if (isAdmin) {
        displayMessage("Adminler alÄ±ÅŸveriÅŸ yapamaz.");
        return;
    }
    const userRef = db.ref('users/' + currentUser);
    const itemRef = db.ref('storeItems/' + itemId);
    const [userSnap, itemSnap] = await Promise.all([userRef.once('value'), itemRef.once('value')]);
    const user = userSnap.val();
    const item = itemSnap.val();

    if (!user || !item) return;

    if (item.type === 'special') {
        const kasaPuani = user.kasaPuani || 0;
        if (kasaPuani < item.cost) {
            displayMessage(`Bu Ã¶zel Ã¼rÃ¼nÃ¼ almak iÃ§in yeterli Kasa PuanÄ±nÄ±z yok! (Gereken: ${item.cost} KP, Mevcut: ${kasaPuani} KP)`);
            return;
        }

        if (item.stock !== undefined && item.stock <= 0) {
            displayMessage("Bu Ã¼rÃ¼nÃ¼n stoÄŸu tÃ¼kenmiÅŸtir.");
            return;
        }
        
        const confirmed = await customConfirm(`'${item.name}' Ã¼rÃ¼nÃ¼nÃ¼ ${item.cost} Kasa PuanÄ±'na almak istiyor musunuz? Bu puanlar Kasa'nÄ±zdan dÃ¼ÅŸÃ¼lecektir.`);
        if (!confirmed) return;

        const purchaseId = db.ref('pendingSpecialPurchases').push().key;
        await db.ref(`pendingSpecialPurchases/${purchaseId}`).set({
            username: currentUser,
            itemName: item.name,
            itemCost: item.cost,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        await userRef.update({
            kasaPuani: kasaPuani - item.cost
        });

        await db.ref(`purchaseHistory/${purchaseId}`).set({
            username: currentUser,
            itemName: item.name,
            itemCost: item.cost,
            imageUrl: item.imageUrl,
            status: 'pending',
            purchaseType: 'kasaPuani',
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        let itemUpdates = {};
        if (item.stock !== undefined && item.stock !== null) {
            itemUpdates.stock = item.stock - 1;
        }
        itemUpdates.purchaseCount = (item.purchaseCount || 0) + 1;
        await itemRef.update(itemUpdates);

        logActivity('buyItem', currentUser, {
            itemName: item.name,
            itemCost: `${item.cost} KP`,
            itemType: item.type,
            newKasaBalance: kasaPuani - item.cost
        });
        
        displayMessage(`'${item.name}' talebiniz admine iletildi. OnaylandÄ±ÄŸÄ±nda hesabÄ±nÄ±za eklenecek. Kasa'nÄ±zdan ${item.cost} KP dÃ¼ÅŸÃ¼ldÃ¼.`);
        return;
    }

    if (item.type === 'tempMultiplier') {
        if (typeof item.value !== 'number' || typeof item.duration !== 'number') {
            displayMessage("MaÄŸaza HatasÄ±: Bu Ã§arpan Ã¼rÃ¼nÃ¼nde eksik bilgi var. LÃ¼tfen yÃ¶netici ile iletiÅŸime geÃ§in.");
            return;
        }

        if (user.multiplierSource && user.multiplierSource !== 'none') {
            if (item.value === user.activeMultiplier) {
                if ((user.balance || 0) < item.cost) {
                    displayMessage("Yetersiz Puan!"); return;
                }
                const confirmedStack = await customConfirm(`Zaten ${user.activeMultiplier}x Ã§arpanÄ±n var. Bu alÄ±m, mevcut Ã§arpanÄ±na <b>+${item.duration} kullanÄ±m hakkÄ±</b> ekleyecek ve toplamda <b>${(user.multiplierRemainingUses || 0) + item.duration} kullanÄ±m hakkÄ±n</b> olacak. OnaylÄ±yor musun?`);
                if (confirmedStack) {
                    logActivity('multiplierStackedFromStore', currentUser, { cost: item.cost, multiplierValue: item.value, usesAdded: item.duration, newTotalUses: (user.multiplierRemainingUses || 0) + item.duration, newBalance: user.balance - item.cost });
                    await userRef.update({ balance: user.balance - item.cost, totalSpentPoints: (user.totalSpentPoints || 0) + item.cost, multiplierRemainingUses: (user.multiplierRemainingUses || 0) + item.duration });
                    await itemRef.transaction(currentItem => { if (currentItem) { if (currentItem.stock !== undefined && currentItem.stock !== null) { currentItem.stock--; } currentItem.purchaseCount = (currentItem.purchaseCount || 0) + 1; } return currentItem; });
                    displayMessage(`BaÅŸarÄ±lÄ±! ${user.activeMultiplier}x Ã§arpanÄ±na +${item.duration} kullanÄ±m hakkÄ± eklendi.`);
                    return;
                } else { return; }
            } else if (item.value > user.activeMultiplier) {
                if ((user.balance || 0) < item.cost) {
                    displayMessage("Yetersiz Puan!"); return;
                }
                const kutuHakkiDonusum = user.multiplierRemainingUses || 0;
                const confirmedUpgrade = await customConfirm(`Mevcut ${user.activeMultiplier}x Ã§arpanÄ±nÄ± daha yÃ¼ksek olan <b>${item.value}x</b> ile deÄŸiÅŸtirmek Ã¼zeresin. Mevcut Ã§arpanÄ±nÄ±n kalan <b>${user.multiplierRemainingUses} kullanÄ±m hakkÄ±</b>, envanterine <b>+${kutuHakkiDonusum} Kutu HakkÄ±</b> olarak eklenecek. OnaylÄ±yor musun?`);
                if (confirmedUpgrade) {
                    logActivity('multiplierUpgradedFromStore', currentUser, { oldValue: user.activeMultiplier, newValue: item.value, boxRights: kutuHakkiDonusum, cost: item.cost, newBalance: user.balance - item.cost });
                    await userRef.update({ balance: user.balance - item.cost, totalSpentPoints: (user.totalSpentPoints || 0) + item.cost, kutuHakki: (user.kutuHakki || 0) + kutuHakkiDonusum, activeMultiplier: item.value, multiplierRemainingUses: item.duration, multiplierSource: 'store' });
                    await itemRef.transaction(currentItem => { if (currentItem) { if (currentItem.stock !== undefined && currentItem.stock !== null) { currentItem.stock--; } currentItem.purchaseCount = (currentItem.purchaseCount || 0) + 1; } return currentItem; });
                    displayMessage(`YÃ¼kseltme baÅŸarÄ±lÄ±! Envanterine +${kutuHakkiDonusum} Kutu HakkÄ± eklendi ve yeni ${item.value}x Ã§arpanÄ±n aktif!`);
                    return;
                } else { return; }
            } else {
                displayMessage(`Mevcut Ã§arpanÄ±n (${user.activeMultiplier}x) zaten bu Ã¼rÃ¼nden (${item.value}x) daha gÃ¼Ã§lÃ¼. Daha dÃ¼ÅŸÃ¼k bir Ã§arpan alamazsÄ±n.`);
                return;
            }
        }
    }

    if (item.type === 'avatar' && user.avatars && user.avatars[itemId]) {
        displayMessage("Bu avatara zaten sahipsin!");
        return;
    }

    if ((user.balance || 0) < item.cost) {
        displayMessage("Yetersiz Puan!");
        return;
    }
    if (item.stock !== undefined && item.stock <= 0) {
        displayMessage("Bu Ã¼rÃ¼nÃ¼n stoÄŸu tÃ¼kenmiÅŸtir.");
        return;
    }
    const confirmed = await customConfirm(`${item.name} Ã¼rÃ¼nÃ¼nÃ¼ ${item.cost} puana almak istiyor musunuz?`);
    if (confirmed) {
        const itemValue = parseInt(item.value) || 0;
        
        if (item.type.startsWith('card_pack')) {
            await userRef.update({ balance: user.balance - item.cost, totalSpentPoints: (user.totalSpentPoints || 0) + item.cost });
            await itemRef.transaction(currentItem => { if (currentItem) { if (currentItem.stock !== undefined && currentItem.stock !== null) { currentItem.stock--; } currentItem.purchaseCount = (currentItem.purchaseCount || 0) + 1; } return currentItem; });
            displayMessage(`${item.cost} puan harcandÄ±. Kart paketlerin aÃ§Ä±lÄ±yor...`);
            startCardPackOpening(itemValue || 1, 'MaÄŸaza', 1, item.type);
            return;
        }

        logActivity('buyItem', currentUser, { itemName: item.name, itemCost: item.cost, itemType: item.type, itemValue: item.value || null, itemDuration: item.duration || null, newBalance: user.balance - item.cost });
        let updates = { balance: user.balance - item.cost, totalSpentPoints: (user.totalSpentPoints || 0) + item.cost, storePurchasesCount: (user.storePurchasesCount || 0) + 1 };
        let message = 'SatÄ±n alma baÅŸarÄ±lÄ±!';
        const itemDuration = parseInt(item.duration) || 0;

        if (item.type === 'boxRights') {
            updates.kutuHakki = (user.kutuHakki || 0) + itemValue;
        } else if (item.type === 'wheelTicket') {
            updates.carkBileti = (user.carkBileti || 0) + itemValue;
        } else if (item.type === 'clickCatchTicket') {
            updates.clickCatchTickets = (user.clickCatchTickets || 0) + itemValue;
        } else if (item.type === 'tempMultiplier') {
            updates.activeMultiplier = itemValue;
            updates.multiplierSource = 'store';
            updates.multiplierRemainingUses = itemDuration;
            updates.activeStoreMultiplierItemId = itemId;
        } else if (item.type === 'iflasShield') {
            updates.iflasShieldUses = (user.iflasShieldUses || 0) + itemValue;
        } else if (item.type === 'wildcard') {
            if (user.completedCollection === true) {
                const boxRightsToGain = itemValue * 5;
                updates.kutuHakki = (user.kutuHakki || 0) + boxRightsToGain;
                message = `Koleksiyonu tamamladÄ±ÄŸÄ±n iÃ§in, aldÄ±ÄŸÄ±n ${itemValue} Joker Kart, <b class="text-green-400">+${boxRightsToGain} Kutu HakkÄ±na</b> dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼!`;
            } else {
                updates.wildcards = (user.wildcards || 0) + itemValue;
                message = `Tebrikler! MaÄŸazadan ${itemValue} adet Joker Kart satÄ±n aldÄ±n!`;
            }
        } else if (item.type === 'avatar') {
            const newAvatar = { id: itemId, name: item.name, imageUrl: item.imageUrl };
            updates[`avatars/${itemId}`] = newAvatar;
            message = `'${item.name}' avatarÄ± koleksiyonuna eklendi!`;
        }
        
        let itemUpdates = {};
        if (item.stock !== undefined && item.stock !== null) {
            itemUpdates.stock = item.stock - 1;
        }
        itemUpdates.purchaseCount = (item.purchaseCount || 0) + 1;
        await itemRef.update(itemUpdates);
        await userRef.update(updates);
        const purchaseId = db.ref('purchaseHistory').push().key;
        db.ref(`purchaseHistory/${purchaseId}`).set({ username: currentUser, itemName: item.name, itemCost: item.cost, imageUrl: item.imageUrl, status: 'completed', timestamp: firebase.database.ServerValue.TIMESTAMP });
        displayMessage(message);
    }
}
  
  function resetStoreItemForm() {
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemDescription').value = '';
    document.getElementById('newItemCost').value = '';
    document.getElementById('newItemStock').value = '';
    document.getElementById('newItemType').value = '';
    document.getElementById('newItemValue').value = '';
    document.getElementById('newItemMultiplierDuration').value = '';
    
    document.getElementById('storeItemCountdownDays').value = '';
    document.getElementById('storeItemCountdownHours').value = '';
    document.getElementById('storeItemCountdownMinutes').value = '';
    document.getElementById('storeItemCountdownSeconds').value = '';

    document.getElementById('newItemImageUrl').value = '';
    document.getElementById('addUpdateStoreItemBtn').textContent = 'ÃœRÃœN EKLE';
    document.getElementById('newItemMultiplierDuration').classList.add('hidden');
    editingItemId = null; 
  }

  document.getElementById('newItemType').addEventListener('change', function() {
      const durationInput = document.getElementById('newItemMultiplierDuration');
      if (this.value === 'tempMultiplier') {
          durationInput.classList.remove('hidden');
      } else {
          durationInput.classList.add('hidden');
      }
  });

  async function saveStoreItem() {
    if (!isAdmin) return;

    try {
        const name = document.getElementById('newItemName').value.trim();
        const description = document.getElementById('newItemDescription').value.trim();
        const cost = parseInt(document.getElementById('newItemCost').value);
        const type = document.getElementById('newItemType').value;
        const imageUrl = document.getElementById('newItemImageUrl').value.trim();
        let stockInput = document.getElementById('newItemStock').value;

        const days = parseInt(document.getElementById('storeItemCountdownDays').value) || 0;
        const hours = parseInt(document.getElementById('storeItemCountdownHours').value) || 0;
        const minutes = parseInt(document.getElementById('storeItemCountdownMinutes').value) || 0;
        const seconds = parseInt(document.getElementById('storeItemCountdownSeconds').value) || 0;
        const totalMinutes = (days * 24 * 60) + (hours * 60) + minutes + Math.round(seconds / 60);

        // Temel alanlarÄ±n kontrolÃ¼
        if (!name || !description || isNaN(cost) || !type) {
            displayMessage("LÃ¼tfen Ad, AÃ§Ä±klama, Maliyet ve Tip alanlarÄ±nÄ± doldurun.");
            return;
        }

        const stock = (stockInput === '' || stockInput === null) ? null : parseInt(stockInput);

        const itemData = {
            name, description, cost, stock, type,
            imageUrl: imageUrl || 'https://via.placeholder.com/150',
        };

        // Her Ã¼rÃ¼n tipi iÃ§in DeÄŸer ve SÃ¼re kontrolÃ¼nÃ¼ ayrÄ± ayrÄ± ve daha gÃ¼venli yapÄ±yoruz.
        if (type === 'tempMultiplier') {
            const value = parseInt(document.getElementById('newItemValue').value);
            const multiplierDuration = parseInt(document.getElementById('newItemMultiplierDuration').value);

            if (isNaN(value) || value <= 0) {
                displayMessage("Ã‡arpan iÃ§in geÃ§erli bir 'DeÄŸer' (2x, 3x gibi) girmelisiniz.");
                return;
            }
            if (isNaN(multiplierDuration) || multiplierDuration <= 0) {
                displayMessage("Ã‡arpan iÃ§in geÃ§erli bir 'KullanÄ±m SayÄ±sÄ±' girmelisiniz.");
                return;
            }
            itemData.value = value;
            itemData.duration = multiplierDuration;
        } else {
            const typesThatNeedValue = ['boxRights', 'wheelTicket', 'clickCatchTicket', 'iflasShield'];
            if (typesThatNeedValue.includes(type)) {
                const value = parseInt(document.getElementById('newItemValue').value);
                if (isNaN(value) || value <= 0) {
                    displayMessage(`'${type}' tipi iÃ§in geÃ§erli bir 'DeÄŸer' girmelisiniz.`);
                    return;
                }
                itemData.value = value;
            }
        }

        if (totalMinutes > 0) {
            itemData.countdownDurationMinutes = totalMinutes;
        } else {
            itemData.countdownDurationMinutes = null;
        }

        if (editingItemId) {
            const existingItemSnap = await storeItemsRef.child(editingItemId).once('value');
            const existingItem = existingItemSnap.val();
            itemData.createdAt = existingItem.createdAt || firebase.database.ServerValue.TIMESTAMP;
            itemData.order = existingItem.order;
            itemData.purchaseCount = existingItem.purchaseCount || 0;
            await storeItemsRef.child(editingItemId).update(itemData);
            displayMessage(`'${name}' Ã¼rÃ¼nÃ¼ baÅŸarÄ±yla gÃ¼ncellendi!`);
        } else {
            itemData.createdAt = firebase.database.ServerValue.TIMESTAMP;
            itemData.purchaseCount = 0;
            const maxOrderSnap = await storeItemsRef.orderByChild('order').limitToLast(1).once('value');
            let maxOrder = -1;
            if (maxOrderSnap.exists()) {
                maxOrder = Object.values(maxOrderSnap.val())[0].order || 0;
            }
            itemData.order = maxOrder + 1;
            await storeItemsRef.push(itemData);
            displayMessage(`'${name}' Ã¼rÃ¼nÃ¼ baÅŸarÄ±yla eklendi!`);
        }
        
        closeAdminStoreModal();
        loadStoreItems();

    } catch (error) {
        console.error("MaÄŸaza Ã¼rÃ¼nÃ¼ kaydetme hatasÄ±:", error);
        displayMessage("ÃœrÃ¼n kaydedilirken bir hata oluÅŸtu: " + error.message);
    }
}
  
  // DEÄÄ°ÅTÄ°RÄ°LECEK FONKSÄ°YON
async function reorderStoreItem(itemId, newIndex) {
    if (!isAdmin) return;
    const itemsRef = db.ref('storeItems');
    const itemsSnap = await itemsRef.once('value');
    const items = itemsSnap.val();
    if (!items) return;

    const itemType = items[itemId].type;

    let allItemsArray = Object.entries(items);
    let gameItems = allItemsArray.filter(([, item]) => item.type !== 'special').sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));
    let specialItems = allItemsArray.filter(([, item]) => item.type === 'special').sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

    let listToModify = (itemType === 'special') ? specialItems : gameItems;

    const itemToMoveIndex = listToModify.findIndex(([id]) => id === itemId);
    if (itemToMoveIndex === -1) return;

    if (newIndex < 0 || newIndex >= listToModify.length) return;

    const [movedItem] = listToModify.splice(itemToMoveIndex, 1);
    listToModify.splice(newIndex, 0, movedItem);

    const finalCombinedList = [...gameItems, ...specialItems];

    const updates = {};
    finalCombinedList.forEach(([id], index) => {
        updates[`storeItems/${id}/order`] = index;
    });

    await db.ref().update(updates);
}
  async function editStoreItem(itemId) {
    if (!isAdmin) return;
    
    const itemSnap = await storeItemsRef.child(itemId).once('value');
    const item = itemSnap.val();
    if (!item) {
        displayMessage("DÃ¼zenlenecek Ã¼rÃ¼n bulunamadÄ±.");
        return;
    }

    document.getElementById('newItemName').value = item.name;
    document.getElementById('newItemDescription').value = item.description;
    document.getElementById('newItemCost').value = item.cost;
    document.getElementById('newItemStock').value = item.stock !== null ? item.stock : '';
    document.getElementById('newItemType').value = item.type;
    document.getElementById('newItemValue').value = item.value;
    document.getElementById('newItemImageUrl').value = item.imageUrl || '';

    const totalMins = item.countdownDurationMinutes || 0;
    const days = Math.floor(totalMins / 1440);
    const remainingMinsAfterDays = totalMins % 1440;
    const hours = Math.floor(remainingMinsAfterDays / 60);
    const minutes = remainingMinsAfterDays % 60;

    document.getElementById('storeItemCountdownDays').value = days > 0 ? days : '';
    document.getElementById('storeItemCountdownHours').value = hours > 0 ? hours : '';
    document.getElementById('storeItemCountdownMinutes').value = minutes > 0 ? minutes : '';
    document.getElementById('storeItemCountdownSeconds').value = '';
    
    const durationInput = document.getElementById('newItemMultiplierDuration');
    if (item.type === 'tempMultiplier') {
      durationInput.classList.remove('hidden');
      durationInput.value = item.duration || '';
    } else {
      durationInput.classList.add('hidden');
    }

    document.getElementById('addUpdateStoreItemBtn').textContent = 'ÃœRÃœNÃœ GÃœNCELLE';
    editingItemId = itemId;
    openAdminStoreModal();
  }

  async function deleteStoreItem(itemId) {
      if (!isAdmin) return;
      if (await customConfirm("Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!")) {
          try {
              await storeItemsRef.child(itemId).remove();
              displayMessage("ÃœrÃ¼n baÅŸarÄ±yla silindi.");
          } catch (error) {
              console.error("ÃœrÃ¼n silme hatasÄ±:", error);
              displayMessage("ÃœrÃ¼n silinirken bir hata oluÅŸtu.");
          }
      }
  }

  function openPurchaseHistoryModal() {
      loadPurchaseHistory();
      purchaseHistoryModal.style.display = 'flex';
  }
  function closePurchaseHistoryModal() {
      purchaseHistoryModal.style.display = 'none';
  }
  
  function loadPurchaseHistory() {
      const list = document.getElementById('purchaseHistoryList');
      list.innerHTML = "<div class='text-center text-gray-400'>YÃ¼kleniyor...</div>";
      let ref = db.ref('purchaseHistory');
      
      // Admin deÄŸilse sadece kendi geÃ§miÅŸini gÃ¶rsÃ¼n
      if (!isAdmin) {
          ref = ref.orderByChild('username').equalTo(currentUser);
      }

      ref.once('value').then(snap => {
          const history = snap.val();
          let html = '';
          if (!history || Object.keys(history).length === 0) {
              list.innerHTML = `<div class='text-center text-gray-400'>${isAdmin ? 'HiÃ§bir satÄ±n alma iÅŸlemi yapÄ±lmamÄ±ÅŸ.' : 'HenÃ¼z bir satÄ±n alma iÅŸlemi yapmadÄ±nÄ±z.'}</div>`;
              return;
          }
          
          // YENÄ°: AnahtarlarÄ± (ID'leri) kaybetmemek iÃ§in Object.entries kullanÄ±yoruz
          const sorted = Object.entries(history).sort(([, a], [, b]) => b.timestamp - a.timestamp);

          sorted.forEach(([key, r]) => { // key = purchaseId
              let statusBadge = '';
              if (r.status === 'pending') {
                  statusBadge = '<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200">Beklemede</span>';
              } else if (r.status === 'denied') {
                  statusBadge = '<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-red-600 bg-red-200">Reddedildi</span>';
              }

              // YENÄ°: Admin ise silme butonu ekliyoruz
              const deleteButton = isAdmin ? `
                <button onclick="deletePurchase('${key}')" class="ml-4 p-2 text-gray-400 hover:text-red-500 rounded-full transition-colors" title="Bu alÄ±mÄ± sil ve iade et">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
              ` : '';

              html += `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 mb-3 bg-gray-700 rounded-lg border-l-4 border-red-500">
                    <div class="flex items-center mb-2 sm:mb-0">
                        <img src="${r.imageUrl || 'https://via.placeholder.com/150'}" alt="${r.itemName}" class="w-12 h-12 rounded-md mr-4 object-cover">
                        <div>
                            <p class="font-bold text-lg text-yellow-300">${r.itemName}</p>
                            <p class="text-sm text-gray-300">Maliyet: ${r.itemCost} ${r.purchaseType === 'kasaPuani' ? 'KP' : 'Puan'}</p>
                        </div>
                    </div>
                    <div class="flex items-center w-full sm:w-auto">
                        <div class="text-xs text-gray-400 text-right flex-grow">
                            ${new Date(r.timestamp).toLocaleString()}
                            ${isAdmin ? `<br><span class="font-semibold text-white">${r.username}</span>` : ''}
                            ${statusBadge ? `<br class="mt-1">${statusBadge}` : ''}
                        </div>
                        ${deleteButton}
                    </div>
                </div>
              `;
          });
          list.innerHTML = html;
      });
  }

    // DEÄÄ°ÅTÄ°RÄ°LECEK FONKSÄ°YON
async function deletePurchase(purchaseId) {
    if (!isAdmin) return;

    const confirmed = await customConfirm("Bu satÄ±n alÄ±mÄ± silmek istediÄŸinizden emin misiniz? Puanlar kullanÄ±cÄ±ya iade edilecek, Ã¼rÃ¼n istatistikleri gÃ¼ncellenecektir.");
    if (!confirmed) return;

    try {
        const purchaseRef = db.ref(`purchaseHistory/${purchaseId}`);
        const purchaseSnap = await purchaseRef.once('value');
        const purchaseData = purchaseSnap.val();

        if (!purchaseData) {
            displayMessage("Hata: Silinecek satÄ±n alÄ±m kaydÄ± bulunamadÄ±.");
            return;
        }

        const { username, itemName, itemCost } = purchaseData;
        const userRef = db.ref(`users/${username}`);
        const storeItemsRef = db.ref('storeItems');

        const itemsSnap = await storeItemsRef.orderByChild('name').equalTo(itemName).once('value');
        let originalItemId = null;
        let originalItem = null;
        if (itemsSnap.exists()) {
            originalItemId = Object.keys(itemsSnap.val())[0];
            originalItem = itemsSnap.val()[originalItemId];
        }

        const userSnap = await userRef.once('value');
        const userData = userSnap.val();
        if (!userData) {
            displayMessage(`Hata: ${username} adlÄ± kullanÄ±cÄ± bulunamadÄ±.`);
            await purchaseRef.remove(); // KullanÄ±cÄ± yoksa bile geÃ§miÅŸi sil
            return;
        }

        const updates = {};
        
        updates[`/users/${username}/balance`] = (userData.balance || 0) + itemCost;
        updates[`/users/${username}/totalSpentPoints`] = Math.max(0, (userData.totalSpentPoints || 0) - itemCost);
        
        if (originalItemId && originalItem) {
            updates[`/storeItems/${originalItemId}/purchaseCount`] = Math.max(0, (originalItem.purchaseCount || 0) - 1);
            if (originalItem.stock !== null && originalItem.stock !== undefined) {
                updates[`/storeItems/${originalItemId}/stock`] = (originalItem.stock || 0) + 1;
            }
        }

        updates[`/purchaseHistory/${purchaseId}`] = null;

        await db.ref().update(updates);

        displayMessage(`'${itemName}' alÄ±mÄ± baÅŸarÄ±yla silindi. ${username} adlÄ± kullanÄ±cÄ±ya ${itemCost} puan iade edildi.`);
        // EÄŸer modal aÃ§Ä±ksa, listeyi yenile
        if (purchaseHistoryModal.style.display === 'flex') {
            loadPurchaseHistory();
        }

    } catch (error) {
        console.error("SatÄ±n alÄ±m silinirken hata oluÅŸtu: ", error);
        displayMessage("Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu. LÃ¼tfen konsolu kontrol edin.");
    }
}
  async function clearPurchaseHistory() { if(await customConfirm("TÃ¼m satÄ±n alma geÃ§miÅŸini silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!")) { db.ref('purchaseHistory').remove().then(() => displayMessage("SatÄ±n alma geÃ§miÅŸi baÅŸarÄ±yla temizlendi.")) } }
  async function clearAllTotalSpentPoints() { if(await customConfirm("TÃ¼m kullanÄ±cÄ±larÄ±n harcadÄ±ÄŸÄ± puanlarÄ± sÄ±fÄ±rlamak istediÄŸinize emin misiniz?")) { db.ref('users').once('value').then(snap => { const updates = {}; snap.forEach(c => { if(c.key !== 'weizendtv') updates[`users/${c.key}/totalSpentPoints`] = 0; }); db.ref().update(updates).then(() => displayMessage("TÃ¼m kullanÄ±cÄ±larÄ±n harcanan puanlarÄ± sÄ±fÄ±rlandÄ±.")) }); } }
  
  function openInventoryModal() {
      const userRef = db.ref('users/' + currentUser);
      userRef.once('value').then(snap => {
          const user = snap.val();
          if (user) {
              document.getElementById('inventoryBoxRights').textContent = user.kutuHakki || 0;
              document.getElementById('inventoryWheelTickets').textContent = user.carkBileti || 0;
              // YENÄ° EKLENEN SATIR
              document.getElementById('inventoryClickCatchTickets').textContent = user.clickCatchTickets || 0;
              // YENÄ° EKLENEN SATIR BÄ°TÄ°Å
              document.getElementById('inventoryIflasShields').textContent = user.iflasShieldUses || 0;
              
              let multiplierHtml = '<p>âœ–ï¸ Aktif Ã§arpan yok.</p>';
              if (user.multiplierSource === 'store' && user.multiplierRemainingUses > 0) {
                  multiplierHtml = `<p><b>âœ–ï¸ Aktif Ã‡arpan:</b> </b> [ ${user.activeMultiplier}X - ${user.multiplierRemainingUses} ADET ] </p>`;
              } else if (user.multiplierSource === 'box') {
                  multiplierHtml = `<p><b>âœ–ï¸ Aktif Ã‡arpan:</b> </b> [ ${user.activeMultiplier}X - [ </b> 1 ADET (Otomatik) ] </p>`;
              }
              document.getElementById('inventoryMultiplierDetails').innerHTML = multiplierHtml;
          }
      });
      inventoryModal.style.display = 'flex';
  }
  function closeInventoryModal() { inventoryModal.style.display = 'none'; }
  function openBadgeInfoModal() { badgeInfoModal.style.display = 'flex'; }
  function closeBadgeInfoModal() { badgeInfoModal.style.display = 'none'; }

// MEVCUT openPublicUserDetailModal FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
async function openPublicUserDetailModal(username) {
    if (!username) return;

    const modal = document.getElementById('publicUserDetailModal');
    if (!modal) return;

    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
    
    // YÃ¼kleniyor... metinlerini ayarla
    document.getElementById('publicUserName').textContent = `${username} yÃ¼kleniyor...`;
    document.getElementById('publicUserAvatar').src = defaultAvatarUrl;
    // DiÄŸer tÃ¼m alanlarÄ± temizle...

    if (activeUserProfileListener && activeUserProfileListener.ref) {
        activeUserProfileListener.ref.off('value', activeUserProfileListener.callback);
    }

    const userRef = db.ref('users/' + username);
    
    const userProfileCallback = async (userSnap) => {
        const userData = userSnap.val();
        if (!userData) {
            closePublicUserDetailModal();
            return;
        }

        const allUsersSnap = await db.ref('users').once('value');
        const leaders = await calculateAllLeaders(allUsersSnap.val());

        const userLeaderStatus = {
            isCurrentLeader: username === leaders.currentBalanceUser,
            isHighLeader: username === leaders.highEverBalanceUser,
            isBoxLeader: username === leaders.boxUser,
            isSurpriseLeader: username === leaders.surpriseBoxUser,
            isBombLeader: username === leaders.bombUser,
            isMultiplierLeader: username === leaders.multiplierUser,
            isStoreLeader: username === leaders.spentPointsUser,
            isShieldLeader: username === leaders.shieldUser,
            isClickCatchLeader: username === leaders.clickCatchLeaderUser,
            isWheelSpinLeader: username === leaders.wheelSpinUser
        };

        // ROZETLERÄ°N GÃ–RÃœNMEME SORUNUNU Ã‡Ã–ZEN KISIM
        document.getElementById('publicBadgeBalance').innerHTML = userLeaderStatus.isCurrentLeader ? 'ğŸ¥‡' : '';
        document.getElementById('publicBadgeHighest').innerHTML = userLeaderStatus.isHighLeader ? 'ğŸ†' : '';
        document.getElementById('badge-stat-box').innerHTML = userLeaderStatus.isBoxLeader ? 'ğŸ“¦' : '';
        document.getElementById('badge-stat-wheel').innerHTML = userLeaderStatus.isWheelSpinLeader ? 'ğŸ¡' : '';
        document.getElementById('badge-stat-clickcatch').innerHTML = userLeaderStatus.isClickCatchLeader ? 'ğŸ¯' : '';
        document.getElementById('badge-stat-surprise').innerHTML = userLeaderStatus.isSurpriseLeader ? 'ğŸ‰' : '';
        document.getElementById('badge-stat-bomb').innerHTML = userLeaderStatus.isBombLeader ? 'ğŸ’£' : '';
        document.getElementById('badge-stat-multiplier').innerHTML = userLeaderStatus.isMultiplierLeader ? 'âœ–ï¸' : '';
        document.getElementById('badge-stat-shield').innerHTML = userLeaderStatus.isShieldLeader ? 'ğŸ›¡ï¸' : '';
        document.getElementById('badge-stat-store').innerHTML = userLeaderStatus.isStoreLeader ? 'ğŸ›’' : '';

        const badges = getUserBadgesHtml(userData, userLeaderStatus, true);
        document.getElementById('publicUserProfileBadges').innerHTML = badges.crown + badges.others;
        
        document.getElementById('publicUserAvatar').src = userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;
        document.getElementById('publicUserName').textContent = username;
        
        document.getElementById('publicUserBalance').textContent = formatNumber(userData.balance || 0);
        document.getElementById('publicUserHighestBalance').textContent = formatNumber(userData.kariyerPuani || 0);
        document.getElementById('publicUserKasaBalance').textContent = formatNumber(userData.kasaPuani || 0);
        document.getElementById('publicUserBoxRight').textContent = formatNumber(userData.kutuHakki || 0);
        document.getElementById('publicUserWheelTickets').textContent = formatNumber(userData.carkBileti || 0);
        document.getElementById('publicUserClickCatchTickets').textContent = formatNumber(userData.clickCatchTickets || 0);
        document.getElementById('publicUserIflasShield').textContent = formatNumber(userData.iflasShieldUses || 0);
        
        document.getElementById('publicUserBoxesOpened').textContent = formatNumber(userData.boxesOpenedCount || 0);
        document.getElementById('publicUserWheelSpins').textContent = formatNumber(userData.wheelSpinsCount || 0);
        document.getElementById('publicUserClickCatchScore').textContent = formatNumber(userData.clickCatchHighestScore || 0);
        document.getElementById('publicUserSurpriseBoxes').textContent = formatNumber(userData.surpriseBoxesOpened || 0);
        document.getElementById('publicUserBombCount').textContent = formatNumber(userData.iflasCount || 0);
        document.getElementById('publicUserMultiplierFoundCount').textContent = formatNumber(userData.multiplierFoundCount || 0);
        document.getElementById('publicUserShieldUsedCount').textContent = formatNumber(userData.iflasShieldUsedCount || 0);
        document.getElementById('publicUserTotalSpent').textContent = formatNumber(userData.totalSpentPoints || 0);

        let multiplierText = 'Yok';
        if (userData.multiplierSource === 'store' && userData.multiplierRemainingUses > 0) {
          multiplierText = `${userData.activeMultiplier}x (MaÄŸaza - ${userData.multiplierRemainingUses} kullanÄ±m)`;
        } else if (userData.multiplierSource === 'box') {
          multiplierText = `${userData.activeMultiplier}x (Kutu - Otomatik)`;
        }
        document.getElementById('publicUserMultiplier').textContent = multiplierText;

        const championshipsDiv = document.getElementById('publicUserChampionships');
        let championshipsHtml = '';
        if (userData.rozetChampionshipsWon > 0) championshipsHtml += `<p>ğŸ‘‘ ${userData.rozetChampionshipsWon} kez 'LÄ°DERLER SIRALAMASI' ÅŸampiyonu oldu.</p>`;
        if (userData.puanChampionshipsWon > 0) championshipsHtml += `<p>ğŸ† ${userData.puanChampionshipsWon} kez 'KARÄ°YER PUAN SIRALAMASI' ÅŸampiyonu oldu.</p>`;
        if (userData.collectionChampionshipsWon > 0) championshipsHtml += `<p>ğŸƒ ${userData.collectionChampionshipsWon} kez 'KART KOLEKSÄ°YONU' ÅŸampiyonu oldu.</p>`;
        
        if (championshipsHtml) {
            championshipsDiv.innerHTML = championshipsHtml;
            championshipsDiv.classList.remove('hidden');
        } else {
            championshipsDiv.classList.add('hidden');
        }
    };
    
    userRef.on('value', userProfileCallback);
    activeUserProfileListener = { ref: userRef, callback: userProfileCallback };
}

// BU EKSÄ°K FONKSÄ°YONU SCRIPT BLOÄUNUN Ä°Ã‡Ä°NE EKLE
async function openUserManagementModal(username) {
    if (activeBlockedUserTimers[username]) {
        clearInterval(activeBlockedUserTimers[username]);
        delete activeBlockedUserTimers[username];
    }
    selectedUserForManagement = username;

    const [userSnap, allUsersSnap] = await Promise.all([
        db.ref('users/' + username).once('value'),
        db.ref('users').once('value')
    ]);

    const userData = userSnap.val();
    if (!userData) {
        displayMessage("KullanÄ±cÄ± bulunamadÄ±.");
        return;
    }

    const leaders = await calculateAllLeaders(allUsersSnap.val());

    const userLeaderStatus = {
        isCurrentLeader: username === leaders.currentBalanceUser,
        isHighLeader: username === leaders.highEverBalanceUser,
        isBoxLeader: username === leaders.boxUser,
        isSurpriseLeader: username === leaders.surpriseBoxUser,
        isBombLeader: username === leaders.bombUser,
        isMultiplierLeader: username === leaders.multiplierUser,
        isStoreLeader: username === leaders.spentPointsUser,
        isShieldLeader: username === leaders.shieldUser,
        isClickCatchLeader: username === leaders.clickCatchLeaderUser,
        isWheelSpinLeader: username === leaders.wheelSpinUser
    };
    document.getElementById('managedBadgeBalance').innerHTML = userLeaderStatus.isCurrentLeader ? 'ğŸ¥‡' : '';
    document.getElementById('managedBadgeHighest').innerHTML = userLeaderStatus.isHighLeader ? 'ğŸ†' : '';

    const avatarUrl = userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;
    document.getElementById('managedUserAvatar').src = avatarUrl;
    document.getElementById('managedUserName').textContent = username;
    document.getElementById('managedUserBalance').textContent = formatNumber(userData.balance || 0);
    document.getElementById('managedUserHighestBalance').textContent = formatNumber(userData.kariyerPuani || 0);
    document.getElementById('managedUserBoxRight').textContent = formatNumber(userData.kutuHakki || 0);
    document.getElementById('managedUserWheelTickets').textContent = formatNumber(userData.carkBileti || 0);
    document.getElementById('managedUserClickCatchTickets').textContent = formatNumber(userData.clickCatchTickets || 0);
    document.getElementById('managedUserIflasShield').textContent = formatNumber(userData.iflasShieldUses || 0);
    let multiplierText = 'Yok';
    if (userData.multiplierSource === 'store') multiplierText = `${userData.activeMultiplier}x (MaÄŸaza - ${userData.multiplierRemainingUses} kullanÄ±m)`;
    else if (userData.multiplierSource === 'box') multiplierText = `${userData.activeMultiplier}x (Kutu - Otomatik)`;
    document.getElementById('managedUserMultiplier').textContent = multiplierText;
    document.getElementById('managedUserMultiplierUses').textContent = userData.multiplierRemainingUses || 0;

    const isCurrentlyBlocked = userData.blocked && userData.blockedUntil && Date.now() < userData.blockedUntil;
    const countdownContainer = document.getElementById('managedUserBlockedCountdownContainer');
    const countdownEl = document.getElementById('managedUserBlockedCountdown');
    document.getElementById('managedUserBlockedStatus').textContent = isCurrentlyBlocked ? 'Engelli' : 'Aktif';
    if (isCurrentlyBlocked) {
        countdownContainer.classList.remove('hidden');
        const updateCountdown = () => {
            const timeLeft = userData.blockedUntil - Date.now();
            if (timeLeft <= 0) {
                clearInterval(activeBlockedUserTimers[username]);
                delete activeBlockedUserTimers[username];
                countdownEl.textContent = 'Engel KalktÄ±';
            } else {
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, '0');
                countdownEl.textContent = `${minutes}:${seconds}`;
            }
        };
        updateCountdown();
        activeBlockedUserTimers[username] = setInterval(updateCountdown, 1000);
    } else {
        countdownContainer.classList.add('hidden');
    }
    const toggleBtn = document.getElementById('toggleBlockUserBtn');
    toggleBtn.textContent = isCurrentlyBlocked ? 'Engeli KaldÄ±r' : 'Engelle';
    toggleBtn.onclick = () => toggleBlockUser(username, userData.blocked, userData.blockedUntil);

    document.getElementById('managedUserBoxesOpened').textContent = formatNumber(userData.boxesOpenedCount || 0);
    document.getElementById('managedUserSurpriseBoxes').textContent = formatNumber(userData.surpriseBoxesOpened || 0);
    document.getElementById('managedUserBombCount').textContent = formatNumber(userData.iflasCount || 0);
    document.getElementById('managedUserMultiplierFoundCount').textContent = formatNumber(userData.multiplierFoundCount || 0);
    document.getElementById('managedUserTotalSpent').textContent = formatNumber(userData.totalSpentPoints || 0);
    document.getElementById('managedUserShieldUsedCount').textContent = formatNumber(userData.iflasShieldUsedCount || 0);
    document.getElementById('managedUserClickCatchScore').textContent = formatNumber(userData.clickCatchHighestScore || 0);
    document.getElementById('managedUserWheelSpins').textContent = formatNumber(userData.wheelSpinsCount || 0);

    ['managedBadgeWheel', 'managedBadgeBox', 'managedBadgeSurprise', 'managedBadgeBomb', 'managedBadgeMultiplier', 'managedBadgeStore', 'managedBadgeShield', 'managedBadgeClickCatch'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });

    if (userLeaderStatus.isBoxLeader) document.getElementById('managedBadgeBox').innerHTML = 'ğŸ“¦';
    if (userLeaderStatus.isSurpriseLeader) document.getElementById('managedBadgeSurprise').innerHTML = 'ğŸ‰';
    if (userLeaderStatus.isBombLeader) document.getElementById('managedBadgeBomb').innerHTML = 'ğŸ’£';
    if (userLeaderStatus.isMultiplierLeader) document.getElementById('managedBadgeMultiplier').innerHTML = 'âœ–ï¸';
    if (userLeaderStatus.isStoreLeader) document.getElementById('managedBadgeStore').innerHTML = 'ğŸ›’';
    if (userLeaderStatus.isShieldLeader) document.getElementById('managedBadgeShield').innerHTML = 'ğŸ›¡ï¸';
    if (userLeaderStatus.isClickCatchLeader) document.getElementById('managedBadgeClickCatch').innerHTML = 'ğŸ¯';
    if (userLeaderStatus.isWheelSpinLeader) document.getElementById('managedBadgeWheel').innerHTML = 'ğŸ¡';

    const historyList = document.getElementById('managedUserPurchaseHistory');
    historyList.innerHTML = 'YÃ¼kleniyor...';
    db.ref('purchaseHistory').orderByChild('username').equalTo(username).once('value').then(snap => {
        const history = snap.val();
        let html = '';
        if (!history) {
            historyList.innerHTML = '<div class="text-center text-gray-400">Bu kullanÄ±cÄ±nÄ±n satÄ±n alma geÃ§miÅŸi yok.</div>';
            return;
        }
        const sorted = Object.values(history).sort((a, b) => b.timestamp - a.timestamp);
        sorted.forEach(r => {
            html += `<div class="p-2 bg-gray-900 mb-2 rounded text-sm"><b>ÃœrÃ¼n:</b> ${r.itemName}, <b>Maliyet:</b> ${r.itemCost} Puan, <b>Tarih:</b> ${new Date(r.timestamp).toLocaleString()}</div>`;
        });
        historyList.innerHTML = html;
    });

    const avatarGrid = document.getElementById('managedUserAvatarGrid');
    avatarGrid.innerHTML = '';
    if (userData.avatars && Object.keys(userData.avatars).length > 0) {
        for (const avatarId in userData.avatars) {
            const avatar = userData.avatars[avatarId];
            const avatarCard = document.createElement('div');
            avatarCard.className = 'relative p-2 bg-gray-700 rounded-lg text-center';
            avatarCard.innerHTML = `<img src="${avatar.imageUrl}" alt="${avatar.name}" class="w-full h-auto rounded-md object-cover aspect-square"><p class="text-xs mt-2 text-white truncate" title="${avatar.name}">${avatar.name}</p><button onclick="deleteUserAvatar('${username}', '${avatarId}')" class="absolute -top-2 -right-2 bg-red-600 hover:bg-red-500 text-white rounded-full h-7 w-7 flex items-center justify-center text-lg font-bold" title="Bu AvatarÄ± Sil">&times;</button>`;
            avatarGrid.appendChild(avatarCard);
        }
    } else {
        avatarGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Bu kullanÄ±cÄ±nÄ±n satÄ±n alÄ±nmÄ±ÅŸ avatarÄ± yok.</p>';
    }

    userManagementModal.style.display = 'flex';
}

    function closePublicUserDetailModal() {
    const publicUserDetailModal = document.getElementById('publicUserDetailModal');
    publicUserDetailModal.style.display = 'none';
    document.body.classList.remove('modal-open');

    // --- DEÄÄ°ÅEN KISIM BAÅLANGICI ---
    // EÄŸer aktif bir profil dinleyicisi varsa, onu kapatÄ±yoruz.
    if (activeUserProfileListener && activeUserProfileListener.ref && activeUserProfileListener.callback) {
        // Dinleyiciyi 'value' event'i iÃ§in ve sakladÄ±ÄŸÄ±mÄ±z callback ile kapatÄ±yoruz.
        activeUserProfileListener.ref.off('value', activeUserProfileListener.callback);
        activeUserProfileListener = null; // DeÄŸiÅŸkeni temizliyoruz ki tekrar kullanÄ±lmasÄ±n.
    }
    // --- DEÄÄ°ÅEN KISIM SONU ---

    const viewingUser = publicUserDetailModal.dataset.viewingUser;
    if (viewingUser && activeBlockedUserTimers[viewingUser]) {
        clearInterval(activeBlockedUserTimers[viewingUser]);
        delete activeBlockedUserTimers[viewingUser];
    }
}
  
  function closeUserManagementModal() {
    if (selectedUserForManagement && activeBlockedUserTimers[selectedUserForManagement]) {
        clearInterval(activeBlockedUserTimers[selectedUserForManagement]);
        delete activeBlockedUserTimers[selectedUserForManagement];
    }
    userManagementModal.style.display = 'none'; 
    selectedUserForManagement = null; 
  }

  function loadPendingSpecialPurchases() {
    const list = document.getElementById('pendingSpecialPurchasesList');
    const ref = db.ref('pendingSpecialPurchases');
    const callback = snap => {
        const purchases = snap.val();
        let html = '';
        if (!purchases || Object.keys(purchases).length === 0) {
            list.innerHTML = "<div class='text-center text-gray-400'>Onay bekleyen Ã¶zel Ã¼rÃ¼n alÄ±mÄ± yok.</div>";
            return;
        }
        for (const key in purchases) {
            const purchase = purchases[key];
            html += `
                <div class="flex flex-col items-start justify-between p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-yellow-500">
                    <div>
                        <span class="text-gray-200 font-bold">${purchase.username}</span>
                        <span class="text-gray-300">- ${purchase.itemName}</span>
                    </div>
                    <div class="flex space-x-2 mt-2 self-end">
                        <button onclick="approveSpecialPurchase('${key}', '${purchase.username}')" class="py-1 px-3 bg-green-600 hover:bg-green-500 text-white text-sm font-bold rounded-md">Onayla</button>
                        <button onclick="denySpecialPurchase('${key}', '${purchase.username}', ${purchase.itemCost})" class="py-1 px-3 bg-red-600 hover:bg-red-500 text-white text-sm font-bold rounded-md">Reddet</button>
                    </div>
                </div>
            `;
        }
        list.innerHTML = html;
    };
    activeListeners.pendingPurchases = { ref, event: 'value', callback };
    ref.on('value', callback);
  }

  async function approveSpecialPurchase(purchaseId, username) {
      const purchaseItemSnap = await db.ref(`/pendingSpecialPurchases/${purchaseId}`).once('value');
      const purchaseItem = purchaseItemSnap.val();
      if (!purchaseItem) {
        displayMessage("Onaylanacak Ã¶ÄŸe bulunamadÄ±.");
        return;
      }
      
      if (!await customConfirm(`${username} kullanÄ±cÄ±sÄ±nÄ±n '${purchaseItem.itemName}' alÄ±mÄ±nÄ± onaylamak istediÄŸinize emin misiniz?`)) return;

      const updates = {};
      updates[`/pendingSpecialPurchases/${purchaseId}`] = null; 
      updates[`/purchaseHistory/${purchaseId}/status`] = 'completed'; 

      db.ref().update(updates).then(() => {
          notifyUser(username, `'${purchaseItem.itemName}' adlÄ± Ã¶zel Ã¼rÃ¼n alÄ±mÄ±nÄ±z onaylandÄ±!`);
          displayMessage("Ã–zel Ã¼rÃ¼n alÄ±mÄ± baÅŸarÄ±yla onaylandÄ±.");
      }).catch(err => {
          console.error("Onaylama hatasÄ±: ", err);
          displayMessage("Onaylama sÄ±rasÄ±nda bir hata oluÅŸtu.");
      });
  }

  // MEVCUT denySpecialPurchase fonksiyonunu bununla deÄŸiÅŸtir
async function denySpecialPurchase(purchaseId, username, itemCost) {
      const purchaseItemSnap = await db.ref(`/pendingSpecialPurchases/${purchaseId}`).once('value');
      const purchaseItem = purchaseItemSnap.val();
       if (!purchaseItem) {
        displayMessage("Reddedilecek Ã¶ÄŸe bulunamadÄ±.");
        return;
      }

      if (!await customConfirm(`${username} kullanÄ±cÄ±sÄ±nÄ±n '${purchaseItem.itemName}' alÄ±mÄ±nÄ± reddetmek istediÄŸinize emin misiniz? Puan iadesi yapÄ±lacaktÄ±r.`)) return;
      
      const userRef = db.ref(`users/${username}`);
      const updates = {};

      const userSnap = await userRef.once('value');
      const userData = userSnap.val();
      if (userData) {
          // Ä°ade edilen puan hem balance'a hem de kariyer puanÄ±na eklenmeli
          // Ã§Ã¼nkÃ¼ bu bir "kazanÄ±m" deÄŸil, "kaybÄ±n geri alÄ±nmasÄ±" durumudur.
          // Sistemin tutarlÄ±lÄ±ÄŸÄ± iÃ§in kariyer puanÄ±nÄ± etkilememesi daha doÄŸru olur.
          // Bu yÃ¼zden burada kariyer puanÄ±na dokunmuyoruz. SADECE KASA PUANI'nÄ± iade ediyoruz.
          updates[`users/${username}/kasaPuani`] = (userData.kasaPuani || 0) + itemCost;
          // NOT: 'totalSpentPoints' Kasa PuanÄ± harcamalarÄ±nÄ± saymÄ±yor, o yÃ¼zden ona dokunmaya gerek yok.
      }

      updates[`/pendingSpecialPurchases/${purchaseId}`] = null;
      updates[`/purchaseHistory/${purchaseId}/status`] = 'denied';

      db.ref().update(updates).then(() => {
          notifyUser(username, `'${purchaseItem.itemName}' adlÄ± Ã¶zel Ã¼rÃ¼n alÄ±mÄ±nÄ±z reddedildi. ${itemCost} Kasa PuanÄ± hesabÄ±nÄ±za iade edildi.`);
          displayMessage("Ã–zel Ã¼rÃ¼n alÄ±mÄ± reddedildi ve Kasa PuanÄ± iadesi yapÄ±ldÄ±.");
      }).catch(err => {
          console.error("Reddetme hatasÄ±: ", err);
          displayMessage("Reddetme sÄ±rasÄ±nda bir hata oluÅŸtu.");
      });
  }

  let globalCountdownInterval = null;
    let spectatorCountdownInterval = null;

  // MEVCUT listenForGameChanges FONKSÄ°YONUNU SÄ°L VE BUNUNLA DEÄÄ°ÅTÄ°R
function listenForGameChanges() {
    const gameLockRef = db.ref('gameLock');
    const gameLockCallback = snap => {
        isGameLocked = snap.val() === true;
        const toggleBtn = document.getElementById('toggleGameLockBtn');
        if (toggleBtn) {
            if (isGameLocked) {
                toggleBtn.textContent = 'Oyun Kilidini AÃ§';
                toggleBtn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
                toggleBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            } else {
                toggleBtn.textContent = 'Oyunu Kilitle';
                toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
                toggleBtn.classList.add('bg-gray-600', 'hover:bg-gray-500');
            }
        }
    };
    activeListeners.gameLock = { ref: gameLockRef, event: 'value', callback: gameLockCallback };
    gameLockRef.on('value', gameLockCallback);

    const lastOpenedBoxRef = db.ref('lastOpenedBox');
    const lastOpenedBoxCallback = snap => {
        const info = snap.val();
        if (info && (Date.now() - info.timestamp < 10000)) {
            if (info.content !== 'surpriz') {
                showGlobalOpenedBoxInfo(info);
            }
        }
    };
    activeListeners.lastOpenedBox = { ref: lastOpenedBoxRef, event: 'value', callback: lastOpenedBoxCallback };
    lastOpenedBoxRef.on('value', lastOpenedBoxCallback);
}

// --- SORUNLARI Ã‡Ã–Z MODALI Ä°Ã‡Ä°N YENÄ° FONKSÄ°YONLAR ---

function openSolveProblemsModal() {
    document.getElementById('solveProblemsModal').style.display = 'flex';
}

function closeSolveProblemsModal() {
    document.getElementById('solveProblemsModal').style.display = 'none';
}

async function manualUnlockGame() {
    const gameLockRef = db.ref('gameLock');
    const lockSnap = await gameLockRef.once('value');
    if (lockSnap.val() === true) {
        await gameLockRef.set(false);
        displayMessage("Oyun kilidi baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±. ArtÄ±k kutu aÃ§abilirsiniz.");
    } else {
        displayMessage("Oyun zaten kilitli deÄŸil, kutular ÅŸu anda aÃ§Ä±labilir durumda.");
    }
    closeSolveProblemsModal();
}

async function manualResetAfterSurprise() {
    const lastSurpriseSnap = await db.ref('gameStats/lastSurpriseInfo').once('value');
    const lastSurpriseData = lastSurpriseSnap.val();

    // Ã‡Ã–ZÃœM 1: Sadece sÄ±fÄ±rlanmamÄ±ÅŸ bir sÃ¼rpriz varsa iÅŸlemi yap
    if (lastSurpriseData && lastSurpriseData.resettled === false) {
        
        // Ã‡Ã–ZÃœM 2: Veriyi silmek yerine, kimin sÄ±fÄ±rladÄ±ÄŸÄ±nÄ± ekleyerek gÃ¼ncelle
        await db.ref('gameStats/lastSurpriseInfo').update({
            resettled: true,
            resettledBy: currentUser
        });
        
        // Oyunu sÄ±fÄ±rla
        await resetGameBoard();
        
        displayMessage("AÃ§Ä±lmÄ±ÅŸ sÃ¼rpriz kutu tespit edildi ve oyun senin tarafÄ±ndan sÄ±fÄ±rlandÄ±!");

    } else {
        displayMessage("Bu Ã¶zellik sadece bir sÃ¼rpriz kutu bulunduktan sonra kullanÄ±labilir.");
    }
    
    closeSolveProblemsModal();
}

async function silSonSurprizKutusu() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Son SÃ¼rpriz Kutu panelini kalÄ±cÄ± olarak gizlemek istediÄŸinizden emin misiniz?");
    if (confirmed) {
        await db.ref('gameStats/lastSurpriseInfo').remove();
    }
}
/**
 * "Ã‡arktan Son Ã‡Ä±kan SÃ¼rpriz" panelini temizlemeden Ã¶nce onay sorar.
 */
async function silSonCarkSurprizi() {
    if (!isAdmin) {
        console.error("Bu iÅŸlem sadece adminler tarafÄ±ndan yapÄ±labilir.");
        return;
    }
    // --- YENÄ° EKLENEN KOD BAÅLANGICI ---
    const confirmed = await customConfirm("Son Ã‡ark SÃ¼rprizi panelini silmek istediÄŸinden emin misin?");
    if (confirmed) {
    // --- YENÄ° EKLENEN KOD SONU ---
        await db.ref('gameStats/lastWheelSurpriseInfo').remove();
        console.log("BaÅŸarÄ±lÄ±: 'Ã‡arktan Son Ã‡Ä±kan SÃ¼rpriz' paneli temizlendi.");
    } // --- if bloÄŸunu kapatan parantez
}

function listenForLastSurpriseFinderPanel() {
    const ref = db.ref('gameStats/lastSurpriseInfo');
    const panel = document.getElementById('lastSurpriseFinderPanel');

    const callback = snap => {
        const data = snap.val();
        if (!data || !data.finder) {
            panel.classList.add('hidden');
            return;
        }

        let adminDeleteButton = '';
        if (isAdmin) {
            adminDeleteButton = `
                <button onclick="silSonSurprizKutusu()" class="absolute -top-3 -right-3 bg-red-600 hover:bg-red-500 text-white rounded-full h-8 w-8 flex items-center justify-center text-lg font-bold transition-transform hover:scale-110" title="Bu Paneli Gizle">
                    &times;
                </button>
            `;
        }

        let messageHtml = `
            ${adminDeleteButton}
            <h4 class="text-amber-300 text-xl font-bold">ğŸ‰ SON SÃœRPRÄ°Z KUTUSU BULUNDU! ğŸ‰</h4>
            <p><b class="text-white text-lg">${data.finder}</b>, ${data.boxId} numaralÄ± kutudan SÃ¼rpriz Kutu buldu!</p>
            <p>Kart seÃ§iminden <b class="text-green-400">+${data.points} Puan</b> kazandÄ±.</p>
        `;

        // Ã‡Ã–ZÃœM: "resettledBy" alanÄ± varsa, kimin sÄ±fÄ±rladÄ±ÄŸÄ±nÄ± gÃ¶sterir. Yoksa uyarÄ±yÄ± gÃ¶sterir.
        if (data.resettledBy) {
            messageHtml += `
                <hr class="border-gray-600 my-2">
                <p class="text-sm text-lime-400">KutularÄ± <b class="text-white">${data.resettledBy}</b> sÄ±fÄ±rladÄ± ve oyun yeniden baÅŸladÄ±.</p>
            `;
        } else {
             messageHtml += `
                <hr class="border-gray-600 my-2">
                <p class="text-sm text-yellow-400 animate-pulse">Oyunun yeniden baÅŸlamasÄ± iÃ§in bir oyuncunun 'SorunlarÄ± Ã‡Ã¶z' menÃ¼sÃ¼nden kutularÄ± sÄ±fÄ±rlamasÄ± gerekiyor.</p>
            `;
        }

        panel.innerHTML = messageHtml;
        panel.classList.add('relative');
        panel.classList.remove('hidden');
    };

    if (activeListeners.surprisePanel) {
        activeListeners.surprisePanel.ref.off('value', activeListeners.surprisePanel.callback);
    }
    activeListeners.surprisePanel = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// YEPYENÄ° FONKSÄ°YON - BU KOD BLOÄUNU OLDUÄU GÄ°BÄ° EKLE
async function toggleGameLock() {
    if (!isAdmin) return;
    const gameLockRef = db.ref('gameLock');
    const lockSnap = await gameLockRef.once('value');
    const isCurrentlyLocked = lockSnap.val() === true;
    await gameLockRef.set(!isCurrentlyLocked);
    displayMessage(`Oyun kilidi baÅŸarÄ±yla ${!isCurrentlyLocked ? 'aktif edildi' : 'kaldÄ±rÄ±ldÄ±'}.`);
}

  function showGlobalOpenedBoxInfo(info) {
    const isPlayingClickCatch = clickCatchGameActive || (lobbyGameSettings && lobbyGameSettings.state === 'active');
    if (isPlayingClickCatch) return;

    // YENÄ° EKLENEN KISIM: Modal yerine Ã¼stte Ã§Ä±kan bildirim bandÄ±nÄ± kullanacaÄŸÄ±z.
    const notificationMessage = `${info.opener}, ${info.boxId} numaralÄ± kutuyu aÃ§tÄ±.`;
    displayGlobalNotification(notificationMessage);

    // DEÄÄ°ÅEN SATIR: ZamanlayÄ±cÄ± 3 saniyeye dÃ¼ÅŸÃ¼rÃ¼ldÃ¼.
    let countdown = 1; // <--- BU SATIRI 1 OLARAK DEÄÄ°ÅTÄ°R

    // Geri kalan zamanlayÄ±cÄ± mantÄ±ÄŸÄ± aynÄ± kalÄ±yor, Ã§Ã¼nkÃ¼ oyun kilidini bu yÃ¶netiyor.
    const countdownEl = document.getElementById('globalOpenedBoxCountdown'); // Bu element artÄ±k gÃ¶rÃ¼nmese de sayaÃ§ Ã§alÄ±ÅŸmaya devam eder.

    if(globalCountdownInterval) clearInterval(globalCountdownInterval);

    globalCountdownInterval = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
            clearInterval(globalCountdownInterval);
            // SÄ°LÄ°NEN SATIR: Modal artÄ±k olmadÄ±ÄŸÄ± iÃ§in kapatmaya gerek yok.
            // globalOpenedBoxInfoModal.style.display = 'none';

            // En Ã¶nemli kÄ±sÄ±m: SÃ¼re dolduÄŸunda oyun kilidini aÃ§ar.
            db.ref('gameLock').set(false);
        }
    }, 1000);
}

    // YENÄ° DUYURU SÄ°STEMÄ°
    function resetAnnouncementForm() {
        document.getElementById('announcementText').value = '';
        document.getElementById('announcementFormTitle').textContent = 'Yeni Duyuru Yap';
        document.getElementById('postAnnouncementBtn').textContent = 'DUYURU YAP';
        document.getElementById('cancelEditAnnouncementBtn').classList.add('hidden');
        editingAnnouncementId = null;
    }

    async function postAnnouncement() {
        if (!isAdmin) return;
        const text = document.getElementById('announcementText').value.trim();
        if (!text) {
            displayMessage("Duyuru metni boÅŸ olamaz.");
            return;
        }

        const announcementData = {
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            likes: editingAnnouncementId ? (await db.ref(`announcements/${editingAnnouncementId}/likes`).once('value')).val() || 0 : 0,
            likedBy: editingAnnouncementId ? (await db.ref(`announcements/${editingAnnouncementId}/likedBy`).once('value')).val() || {} : {}
        };

        if (editingAnnouncementId) {
            await db.ref('announcements/' + editingAnnouncementId).update(announcementData);
            displayMessage("Duyuru baÅŸarÄ±yla gÃ¼ncellendi.");
        } else {
            await db.ref('announcements').push(announcementData);
            displayMessage("Duyuru baÅŸarÄ±yla yayÄ±nlandÄ±.");
        }
        resetAnnouncementForm();
    }
    
    async function editAnnouncement(id) {
        const annSnap = await db.ref(`announcements/${id}`).once('value');
        const ann = annSnap.val();
        if (ann) {
            editingAnnouncementId = id;
            document.getElementById('announcementText').value = ann.text;
            document.getElementById('announcementFormTitle').textContent = 'Duyuruyu DÃ¼zenle';
            document.getElementById('postAnnouncementBtn').textContent = 'GÃœNCELLE';
            document.getElementById('cancelEditAnnouncementBtn').classList.remove('hidden');
            document.getElementById('adminAnnouncementControls').scrollIntoView({ behavior: 'smooth' });
        }
    }

    async function deleteAnnouncement(id) {
        if (!isAdmin) return;
        if (await customConfirm("Bu duyuruyu silmek istediÄŸinizden emin misiniz?")) {
            await db.ref('announcements/' + id).remove();
            displayMessage("Duyuru silindi.");
        }
    }
    
    function loadAnnouncements() {
        const listEl = document.getElementById('announcementsList');
        const userRef = db.ref(`users/${currentUser}`);
        const ref = db.ref('announcements').orderByChild('timestamp');

        const callback = async (snap) => {
            listEl.innerHTML = '';
            const announcements = snap.val();

            if (!announcements) {
                listEl.innerHTML = '<p class="text-center text-gray-400">HenÃ¼z yayÄ±nlanmÄ±ÅŸ bir duyuru yok.</p>';
                return;
            }
            
            const userSnap = await userRef.once('value');
            const userData = userSnap.val() || {};
            const likedAnnouncements = userData.likedAnnouncements || {};
            
            const sortedAnnouncements = Object.entries(announcements).sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            sortedAnnouncements.forEach(([id, ann]) => {
                const date = new Date(ann.timestamp).toLocaleString('tr-TR');
                const processedText = ann.text.replace(/@(\w+)/g, (match, username) => {
                    const isCurrentUserMention = username.toLowerCase() === (currentUser || '').toLowerCase();
                    const highlightClass = isCurrentUserMention ? 'user-mention highlighted' : 'user-mention';
                    return `<span class="${highlightClass}" data-username="${username}">${match}</span>`;
                });
                
                let adminButtons = '';
                if(isAdmin) {
                    adminButtons = `
                        <button onclick="editAnnouncement('${id}')" class="py-1 px-3 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-md">DÃ¼zenle</button>
                        <button onclick="deleteAnnouncement('${id}')" class="py-1 px-3 bg-red-600 hover:bg-red-500 text-white text-xs font-bold rounded-md">Sil</button>
                    `;
                }

                const isLiked = likedAnnouncements[id] && !isAdmin;
                const likeButtonClass = isLiked ? 'bg-blue-600 text-white' : 'bg-gray-600 hover:bg-gray-500 text-gray-300';
                const likeButtonText = isLiked ? 'BeÄŸenildi' : 'BeÄŸen';

                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-6 rounded-lg border-l-4 border-yellow-500 shadow-lg';
                div.innerHTML = `
                    <p class="text-lg text-gray-200 mb-4 whitespace-pre-wrap">${processedText}</p>
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-700">
                        <p class="text-xs text-gray-500">${date}</p>
                        <div class="flex items-center gap-4">
                             <a onclick="showAnnouncementLikes('${id}')" class="cursor-pointer font-bold text-yellow-400 hover:text-yellow-300">${ann.likes || 0} BeÄŸeni</a>
                             ${!isAdmin ? `
                             <button id="likeBtn-${id}" onclick="likeAnnouncement('${id}')" class="${likeButtonClass} px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.562 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.82 2.316l-1.09 1.817c-.381.636-.632 1.356-.632 2.146z" /></svg>
                                ${likeButtonText}
                            </button>
                             ` : adminButtons}
                        </div>
                    </div>
                `;
                listEl.appendChild(div);
            });
            
            listEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('user-mention')) {
                    const usernameToView = e.target.dataset.username;
                    if (usernameToView) {
                        openPublicUserDetailModal(usernameToView.toLowerCase());
                    }
                }
            });
        };

        activeListeners.announcements = { ref, event: 'value', callback };
        ref.on('value', callback);
    }

    async function likeAnnouncement(announcementId) {
        if (isAdmin) {
            displayMessage("Adminler beÄŸeni yapamaz.");
            return;
        }

        const userLikeRef = db.ref(`users/${currentUser}/likedAnnouncements/${announcementId}`);
        const userLikeSnap = await userLikeRef.once('value');
        const announcementRef = db.ref(`announcements/${announcementId}`);

        if (userLikeSnap.exists()) {
            await userLikeRef.remove();
            await db.ref(`announcements/${announcementId}/likedBy/${currentUser}`).remove();
            await announcementRef.child('likes').transaction(currentLikes => (currentLikes || 0) - 1);
        } else {
            await userLikeRef.set(true);
            await db.ref(`announcements/${announcementId}/likedBy/${currentUser}`).set(true);
            await announcementRef.child('likes').transaction(currentLikes => (currentLikes || 0) + 1);
        }
    }
    
    function listenForNewAnnouncements() {
    const ref = db.ref('announcements').orderByChild('timestamp').limitToLast(1);
    const userRef = db.ref(`users/${currentUser}`);

    const callback = async (snap) => {
        if (!snap.exists()) return;

        const latestAnnKey = Object.keys(snap.val())[0];
        const latestAnn = snap.val()[latestAnnKey];
        latestAnnouncementTimestamp = latestAnn.timestamp;
        
        const userSnap = await userRef.once('value');
        const userData = userSnap.val();
        
        if (userData && latestAnn.timestamp > (userData.lastSeenAnnouncementTimestamp || 0)) {
            // Sadece modal kapalÄ±ysa ve duyuru sekmesinde deÄŸilsek gÃ¶ster
            const isModalHidden = document.getElementById('newAnnouncementModal').style.display !== 'flex';
            if (currentActiveSection !== 'announcements' && isModalHidden) {
                document.getElementById('newAnnouncementText').textContent = latestAnn.text.substring(0, 250) + (latestAnn.text.length > 250 ? '...' : '');
                newAnnouncementModal.style.display = 'flex';
            }
            document.getElementById('announcementIndicator').classList.remove('hidden');
        }
    };

    if (activeListeners.newAnnouncements) {
        activeListeners.newAnnouncements.ref.off(activeListeners.newAnnouncements.event, activeListeners.newAnnouncements.callback);
    }
    activeListeners.newAnnouncements = { ref, event: 'value', callback };
    ref.on('value', callback);
}

    function listenForNewStoreItems() {
    const ref = db.ref('storeItems').orderByChild('createdAt').limitToLast(1);
    const userRef = db.ref(`users/${currentUser}`);

    const callback = async (snap) => {
        if (!snap.exists()) return;

        const latestItemKey = Object.keys(snap.val())[0];
        const latestItem = snap.val()[latestItemKey];
        latestStoreItemTimestamp = latestItem.createdAt;

        const userSnap = await userRef.once('value');
        const userData = userSnap.val();

        if (userData && latestItem.createdAt > (userData.lastSeenStoreTimestamp || 0)) {
            document.getElementById('storeIndicator').classList.remove('hidden');
        }
    };

    if (activeListeners.newStoreItems) {
        activeListeners.newStoreItems.ref.off(activeListeners.newStoreItems.event, activeListeners.newStoreItems.callback);
    }
    activeListeners.newStoreItems = { ref, event: 'value', callback };
    ref.on('value', callback);
}

    function closeNewAnnouncementModal() {
    newAnnouncementModal.style.display = 'none';
    if (!isAdmin) {
        db.ref(`users/${currentUser}/lastSeenAnnouncementTimestamp`).set(latestAnnouncementTimestamp);
    }
}
    
    function goToAnnouncements() {
    closeNewAnnouncementModal();
    showSection('announcements');
}

    async function openUnopenedBoxContentsModal() {
    const listEl = document.getElementById('unopenedBoxContentsList');
    listEl.innerHTML = 'YÃ¼kleniyor...';
    
    try {
        const configSnap = await db.ref('gameConfig/boxContents').once('value');
        const defaultBoxConfig = [ { type: 'surpriz', value: 0, count: 1 }, { type: 'points', value: 1000, count: 2 }, { type: 'iflas', count: 2 }, { type: 'points', value: 750, count: 4 }, { type: 'points', value: 500, count: 6 }, { type: 'points', value: 250, count: 8 }, { type: 'points', value: 100, count: 10 }, { type: 'points', value: 50, count: 15 }, { type: 'points', value: 10, count: 20 }, { type: 'points', value: 1, count: 30 }, { type: 'multiplier', value: 2, count: 1 }, { type: 'multiplier', value: 3, count: 1 } ];
        const boxConfig = configSnap.exists() ? configSnap.val() : defaultBoxConfig;

        const boxesSnap = await db.ref('boxes').once('value');
        const currentBoxes = boxesSnap.val();

        const remainingContents = {};

        boxConfig.forEach(item => {
            const key = `${item.type}-${item.value}`;
            remainingContents[key] = (remainingContents[key] || 0) + item.count;
        });

        if (currentBoxes) {
            currentBoxes.forEach(box => {
                if (box.opened) {
                    const key = `${box.content}-${box.value}`;
                    if (remainingContents[key]) {
                        remainingContents[key]--;
                    }
                }
            });
        }
        
        listEl.innerHTML = '';
        let html = '';
        Object.entries(remainingContents).forEach(([key, count]) => {
            if (count > 0) {
                const [type, value] = key.split('-');
                let label = '';
                let icon = 'â“';
                switch(type) {
                    case 'points': label = `${value} Puan`; icon = 'ğŸ’°'; break;
                    case 'iflas': label = 'Ä°flas (Bomba)'; icon = 'ğŸ’£'; break;
                    case 'surpriz': label = 'SÃ¼rpriz Kutu'; icon = 'ğŸ‰'; break;
                    case 'multiplier': label = `${value}x Ã‡arpan`; icon = 'âœ–ï¸'; break;
                    case 'iflasShield': label = 'Ä°flas KalkanÄ±'; icon = 'ğŸ›¡ï¸'; break;
                    case 'wheelTicket': label = 'Ã‡ark Bileti'; icon = 'ï¸ğŸ«'; break;
                    case 'clickCatchTicket': label = 'TÄ±kla-Yakala Bileti'; icon = 'ğŸŸï¸'; break;
                    case 'wildcard': label = 'Joker Kart'; icon = 'ğŸƒ'; break;
                    case 'card_pack': label = 'Standart Kart Paketi'; icon = 'ğŸ´'; break;
                    case 'card_pack_normal': label = 'Bronz Kart Paketi'; icon = 'ğŸ¥‰'; break;
                    case 'card_pack_gumus': label = 'GÃ¼mÃ¼ÅŸ Kart Paketi'; icon = 'ğŸ¥ˆ'; break;
                    case 'card_pack_altin': label = 'AltÄ±n Kart Paketi'; icon = 'ğŸ¥‡'; break;
                    case 'card_pack_efsanevi': label = 'Efsanevi Kart Paketi'; icon = 'ğŸ†'; break;
                }
                html += `<p class="flex justify-between items-center p-2 bg-gray-800 rounded mb-2 text-white"><span>${icon} ${label}</span> <span class="font-bold text-yellow-300">${count} Adet</span></p>`;
            }
        });

        listEl.innerHTML = html || '<p class="text-center text-gray-400">TÃ¼m kutular aÃ§Ä±lmÄ±ÅŸ!</p>';

    } catch (error) {
        console.error("Kalan iÃ§erik yÃ¼klenirken hata:", error);
        listEl.innerHTML = '<p class="text-red-500">Ä°Ã§erik yÃ¼klenemedi.</p>';
    }

    document.getElementById('unopenedBoxContentsModal').style.display = 'flex';
}

    function closeUnopenedBoxContentsModal() {
    document.getElementById('unopenedBoxContentsModal').style.display = 'none';
}

    async function showAnnouncementLikes(announcementId) {
        const likesRef = db.ref(`announcements/${announcementId}/likedBy`);
        const likesSnap = await likesRef.once('value');
        const likers = likesSnap.val();
        
        const listEl = document.getElementById('announcementLikesList');
        listEl.innerHTML = '';

        if (!likers) {
            listEl.innerHTML = '<p class="text-gray-400">Bu duyuruyu henÃ¼z kimse beÄŸenmedi.</p>';
        } else {
            const usernames = Object.keys(likers);
            usernames.forEach(username => {
                listEl.innerHTML += `<div class="p-2 bg-gray-800 rounded mb-2 text-white">${username}</div>`;
            });
        }
        
        announcementLikesModal.style.display = 'flex';
    }

    function closeAnnouncementLikesModal() {
        announcementLikesModal.style.display = 'none';
    }


    // YENÄ° GÃœNLÃœK Ã–DÃœL SÄ°STEMÄ° (ZAMAN AYARLI)
    function openNewDailyRewardForm() {
        resetDailyRewardForm();
        openAdminDailyRewardModal();
    }

    function openAdminDailyRewardModal() {
        adminDailyRewardModal.style.display = 'flex';
    }
    function closeAdminDailyRewardModal() {
        adminDailyRewardModal.style.display = 'none';
    }

    // DEÄÄ°ÅTÄ°RÄ°LECEK FONKSÄ°YON
function closeDailyRewardModal() { 
    Object.values(activeDailyRewardTimers).forEach(clearInterval);
    activeDailyRewardTimers = {};
    const dailyRewardModal = document.getElementById('dailyRewardModal');
    if (dailyRewardModal) {
        dailyRewardModal.style.display = 'none'; 
    }
}
    
    async function checkAvailableDailyRewards() {
    if (isAdmin) {
        document.getElementById('dailyRewardIndicator').classList.add('hidden');
        return;
    }

    const userSnap = await db.ref('users/' + currentUser).once('value');
    const user = userSnap.val();
    const rewardsSnap = await db.ref('dailyRewardOptions').once('value');
    const rewards = rewardsSnap.val();

    if (!rewards || !user) {
        document.getElementById('dailyRewardIndicator').classList.add('hidden');
        return;
    }

    const userClaims = user.dailyRewardsClaimed || {};
    let hasAvailableReward = false;

    for (const rewardId in rewards) {
        const reward = rewards[rewardId];
        const cooldown = reward.cooldownMs || 0;
        const lastClaim = userClaims[rewardId] || 0;

        // --- DEÄÄ°ÅTÄ°RÄ°LEN VE DÃœZELTÄ°LEN MANTIK BAÅLANGICI ---
        let isAvailable = false;
        // 1. Durum: Ã–dÃ¼l tek seferlik ise (bekleme sÃ¼resi 0 ise)
        if (cooldown === 0) {
            // Sadece daha Ã¶nce hiÃ§ alÄ±nmadÄ±ysa (lastClaim === 0) mÃ¼saittir.
            isAvailable = (lastClaim === 0);
        }
        // 2. Durum: Ã–dÃ¼lÃ¼n bekleme sÃ¼resi varsa
        else {
            // Sadece bekleme sÃ¼resi dolduysa mÃ¼saittir.
            isAvailable = (Date.now() > lastClaim + cooldown);
        }

        if (isAvailable) {
            hasAvailableReward = true;
            break; // MÃ¼sait bir Ã¶dÃ¼l bulduk, dÃ¶ngÃ¼yÃ¼ sonlandÄ±rabiliriz.
        }
        // --- DEÄÄ°ÅTÄ°RÄ°LEN VE DÃœZELTÄ°LEN MANTIK SONU ---
    }
    
    if (hasAvailableReward) {
        document.getElementById('dailyRewardIndicator').classList.remove('hidden');
    } else {
        document.getElementById('dailyRewardIndicator').classList.add('hidden');
    }
}
    
async function openDailyRewardModal() {
    const dailyRewardModal = document.getElementById('dailyRewardModal');
    if (!dailyRewardModal) {
        console.error("HATA: 'dailyRewardModal' elementi HTML'de bulunamadÄ±!");
        displayMessage("GÃ¼nlÃ¼k Ã¶dÃ¼l penceresi aÃ§Ä±lamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.");
        return;
    }

    dailyRewardModal.style.display = 'flex';
    const container = document.getElementById('dailyRewardItemsContainer');
    container.innerHTML = '<p class="text-center col-span-full text-gray-400">Ã–dÃ¼ller yÃ¼kleniyor...</p>';
    document.getElementById('dailyRewardMessage').textContent = 'AÅŸaÄŸÄ±daki Ã¶dÃ¼llerden alabileceklerini topla. Bol ÅŸans!';

    if (isAdmin) {
        document.getElementById('adminDailyRewardManagementButtonContainer').classList.remove('hidden');
    } else {
        document.getElementById('adminDailyRewardManagementButtonContainer').classList.add('hidden');
    }

    try {
        const userSnap = await db.ref('users/' + currentUser).once('value');
        const user = userSnap.val();
        const rewardsRef = db.ref('dailyRewardOptions');
        const rewardsSnap = await rewardsRef.orderByChild('order').once('value');
        
        if (!rewardsSnap.exists()) {
            container.innerHTML = '<p class="text-center col-span-full">Åu anda mevcut bir gÃ¼nlÃ¼k Ã¶dÃ¼l bulunmamaktadÄ±r.</p>';
            return;
        }

        container.innerHTML = ''; 

        const rewardsArray = [];
        rewardsSnap.forEach(childSnap => {
            rewardsArray.push([childSnap.key, childSnap.val()]);
        });

        const userClaims = user ? (user.dailyRewardsClaimed || {}) : {};
        
        rewardsArray.forEach(([rewardId, reward], index) => {
            const lastClaim = userClaims[rewardId] || 0;
            const cooldown = reward.cooldownMs || 0;
            const nextAvailableTime = lastClaim + cooldown;

            // --- DEÄÄ°ÅTÄ°RÄ°LEN KONTROL MANTIÄI BAÅLANGICI ---
            let canClaim = false;
            if (!isAdmin) {
                // EÄŸer bekleme sÃ¼resi 0 ise (tek seferlik) VE daha Ã¶nce alÄ±nmamÄ±ÅŸsa (lastClaim === 0), alÄ±nabilir.
                if (cooldown === 0) {
                    canClaim = (lastClaim === 0);
                } 
                // EÄŸer bekleme sÃ¼resi varsa, normal zaman kontrolÃ¼ yapÄ±lÄ±r.
                else {
                    canClaim = (Date.now() > nextAvailableTime);
                }
            }
            // --- DEÄÄ°ÅTÄ°RÄ°LEN KONTROL MANTIÄI SONU ---


            const card = document.createElement('div');
            card.className = 'relative bg-gray-900 p-4 rounded-xl shadow-lg border border-yellow-600 text-center flex flex-col justify-between';
            
            let adminControlsHtml = '';
            if(isAdmin){
                const leftArrowDisabled = index === 0 ? 'disabled' : '';
                const rightArrowDisabled = index === rewardsArray.length - 1 ? 'disabled' : '';
                
                adminControlsHtml = `
                  <div class="admin-controls absolute top-0 right-0 p-1 bg-gray-900 bg-opacity-70 rounded-bl-lg flex gap-1 z-10">
                      <button onclick="reorderDailyRewardItem('${rewardId}', ${index - 1})" ${leftArrowDisabled} title="Sola TaÅŸÄ±" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/></svg></button>
                      <button onclick="editDailyReward('${rewardId}')" title="DÃ¼zenle" class="p-1 rounded-full hover:bg-gray-700"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a1 1 0 011-1h2.586l-2 2H6v3h3v-1.586l2-2H13a1 1 0 011 1v5a1 1 0 01-1 1H6a1 1 0 01-1-1v-2z"/></svg></button>
                      <button onclick="removeDailyReward('${rewardId}')" title="Sil" class="p-1 rounded-full hover:bg-gray-700"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"/></svg></button>
                      <button onclick="reorderDailyRewardItem('${rewardId}', ${index + 1})" ${rightArrowDisabled} title="SaÄŸa TaÅŸÄ±" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg></button>
                  </div>`;
            }
            
            let buttonHTML = '<button id="claim-reward-btn-' + rewardId + '" onclick="claimDailyReward(\'' + rewardId + '\')" class="w-full py-2 mt-auto bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition duration-300">Ã–dÃ¼lÃ¼ Al</button>';
            let cooldownHTML = '<div class="text-sm text-gray-500 font-bold mb-3 h-5">SÃ¼re: ' + (reward.cooldownText || 'Tek Seferlik') + '</div>';

            if (isAdmin || !canClaim) {
                const disabledState = isAdmin ? 'disabled' : '';
                buttonHTML = '<button ' + disabledState + ' class="w-full py-2 mt-auto bg-gray-600 cursor-not-allowed text-white font-bold rounded-lg transition duration-300">' + (isAdmin ? 'Admin' : 'AlÄ±ndÄ±') + '</button>';

                if (!isAdmin) {
                   cooldownHTML = '<div id="reward-cooldown-' + rewardId + '" class="text-sm text-yellow-300 font-bold mb-3 h-5"></div>';
                    
                    if (activeDailyRewardTimers[rewardId]) clearInterval(activeDailyRewardTimers[rewardId]);

                    const timerId = setInterval(() => {
                        const now = Date.now();
                        const timeLeft = nextAvailableTime - now;
                        const el = document.getElementById('reward-cooldown-' + rewardId);
                        if (!el) {
                            clearInterval(timerId);
                            return;
                        }

                        if (timeLeft <= 0) {
                            // DEÄÄ°ÅTÄ°RÄ°LEN KISIM: Tek seferlik Ã¶dÃ¼ller iÃ§in bu blok Ã§alÄ±ÅŸmamalÄ±.
                            if(cooldown > 0){
                                el.innerHTML = '<span class="text-green-400">Åimdi AlÄ±nabilir!</span>';
                                const claimButton = el.closest('.relative').querySelector('button');
                                if (claimButton) {
                                    claimButton.id = 'claim-reward-btn-' + rewardId;
                                    claimButton.disabled = false;
                                    claimButton.onclick = () => claimDailyReward(rewardId);
                                    claimButton.classList.replace('bg-gray-600', 'bg-green-600');
                                    claimButton.classList.add('hover:bg-green-500');
                                    claimButton.textContent = 'Ã–dÃ¼lÃ¼ Al';
                                }
                            } else {
                                el.innerHTML = '<span class="text-red-400">Bu Ã¶dÃ¼l zaten alÄ±ndÄ±.</span>';
                            }
                            clearInterval(timerId);
                        } else {
                            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                            
                            let parts = [];
                            if (days > 0) parts.push(days + 'g');
                            if (hours > 0) parts.push(hours + 'sa');
                            if (minutes > 0) parts.push(minutes + 'd');
                            if (seconds >= 0) parts.push(seconds + 'sn');

                            el.textContent = 'Kalan SÃ¼re: ' + parts.join(' ');
                        }
                    }, 1000);
                    activeDailyRewardTimers[rewardId] = timerId;
                }
            }

            card.innerHTML = `
                ${adminControlsHtml}
                <div>
                    <img src="${reward.imageUrl || 'https://via.placeholder.com/150'}" alt="${reward.name}" class="w-20 h-20 mx-auto mb-3 rounded-lg object-cover">
                    <h4 class="text-yellow-300 text-lg font-bold">${reward.name}</h4>
                    <p class="text-gray-400 text-sm mb-3">${reward.description}</p>
                    ${cooldownHTML}
                </div>
                ${buttonHTML}
            `;
            container.appendChild(card);
        });
    } catch (error) {
        console.error("GÃ¼nlÃ¼k Ã¶dÃ¼ller yÃ¼klenirken bir hata oluÅŸtu:", error);
        container.innerHTML = '<p class="text-center col-span-full text-red-500">Ã–dÃ¼ller yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen daha sonra tekrar deneyin.</p>';
    }
}

async function claimDailyReward(rewardId) {
    if (isAdmin) return;

    const claimButton = document.getElementById(`claim-reward-btn-${rewardId}`);
    if (claimButton && claimButton.disabled) {
        return; 
    }
    if (claimButton) {
        claimButton.disabled = true;
        claimButton.textContent = 'Ä°ÅŸleniyor...';
    }

    try {
        const userRef = db.ref('users/' + currentUser);
        const rewardRef = db.ref('dailyRewardOptions/' + rewardId);

        const [userSnap, rewardSnap] = await Promise.all([userRef.once('value'), rewardRef.once('value')]);
        const user = userSnap.val();
        const reward = rewardSnap.val();

        if (!reward) {
            throw new Error("Ã–dÃ¼l bulunamadÄ±.");
        }

        const lastClaim = (user.dailyRewardsClaimed && user.dailyRewardsClaimed[rewardId]) || 0;
        const cooldown = reward.cooldownMs || 0;

        if (cooldown === 0 && lastClaim > 0) {
            displayMessage("Bu tek seferlik Ã¶dÃ¼lÃ¼ zaten aldÄ±nÄ±z.");
            if (claimButton) {
                claimButton.textContent = 'AlÄ±ndÄ±';
            }
            return;
        }

        if (Date.now() < lastClaim + cooldown) {
            displayMessage("Bu Ã¶dÃ¼l iÃ§in bekleme sÃ¼resi henÃ¼z dolmadÄ±.");
            if (claimButton) {
                claimButton.disabled = false;
                claimButton.textContent = 'Ã–dÃ¼lÃ¼ Al';
            }
            return;
        }

        if (reward.type === 'tempMultiplier') {
            if (user.multiplierSource && user.multiplierSource !== 'none') {
                const rewardValue = parseInt(reward.value);
                const userMultiplierValue = parseInt(user.activeMultiplier);

                if (rewardValue === userMultiplierValue) { 
                    const confirmedStack = await customConfirm(`Zaten ${user.activeMultiplier}x Ã§arpanÄ±n var. Bu Ã¶dÃ¼l, mevcut Ã§arpanÄ±na <b>+${reward.uses} kullanÄ±m hakkÄ±</b> ekleyecek. OnaylÄ±yor musun?`);
                    if (!confirmedStack) {
                        if (claimButton) { claimButton.disabled = false; claimButton.textContent = 'Ã–dÃ¼lÃ¼ Al'; }
                        return;
                    }
                    
                    const usesAdded = reward.uses;
                    const newTotalUses = (user.multiplierRemainingUses || 0) + usesAdded;
                    
                    logActivity('dailyRewardMultiplierStacked', currentUser, {
                        multiplierValue: reward.value,
                        usesAdded: usesAdded,
                        newTotalUses: newTotalUses
                    });

                    await userRef.update({ multiplierRemainingUses: newTotalUses });
                    await db.ref(`users/${currentUser}/dailyRewardsClaimed/${rewardId}`).set(firebase.database.ServerValue.TIMESTAMP);

                    displayMessage(`BaÅŸarÄ±lÄ±! ${reward.value}x Ã§arpanÄ±na +${usesAdded} kullanÄ±m hakkÄ± eklendi.`);
                    closeDailyRewardModal();
                    checkAvailableDailyRewards();
                    return;
                } 
                else if (rewardValue > userMultiplierValue) { 
                    const kutuHakkiDonusum = user.multiplierRemainingUses || 0;
                    const confirmedUpgrade = await customConfirm(`Mevcut ${user.activeMultiplier}x Ã§arpanÄ±nÄ± daha yÃ¼ksek olan <b>${reward.value}x</b> ile deÄŸiÅŸtirmek Ã¼zeresin. Mevcut Ã§arpanÄ±nÄ±n kalan <b>${user.multiplierRemainingUses} kullanÄ±m hakkÄ±</b>, envanterine <b>+${kutuHakkiDonusum} Kutu HakkÄ±</b> olarak eklenecek. OnaylÄ±yor musun?`);
                    if (!confirmedUpgrade) {
                        if (claimButton) { claimButton.disabled = false; claimButton.textContent = 'Ã–dÃ¼lÃ¼ Al'; }
                        return;
                    }
                    await userRef.update({
                        kutuHakki: (user.kutuHakki || 0) + kutuHakkiDonusum,
                        activeMultiplier: reward.value,
                        multiplierRemainingUses: reward.uses,
                        multiplierSource: 'store'
                    });
                } 
                else {
                    const kutuHakkiDonusum = reward.uses || 0;
                    const confirmedConvert = await customConfirm(`Mevcut <b>${user.activeMultiplier}x</b> Ã§arpanÄ±n bu <b>${reward.value}x</b> Ã¶dÃ¼lÃ¼nden daha gÃ¼Ã§lÃ¼. Bu Ã¶dÃ¼lÃ¼ alÄ±rsan, Ã§arpanÄ±n deÄŸiÅŸmeyecek ancak Ã¶dÃ¼lÃ¼n <b>${kutuHakkiDonusum} kullanÄ±m hakkÄ±</b>, envanterine <b>+${kutuHakkiDonusum} Kutu HakkÄ±</b> olarak eklenecek. OnaylÄ±yor musun?`);
                    
                    if (!confirmedConvert) {
                        if (claimButton) { claimButton.disabled = false; claimButton.textContent = 'Ã–dÃ¼lÃ¼ Al'; }
                        return;
                    }

                    logActivity('multiplierConvertedToBoxRights', currentUser, {
                        rewardValue: reward.value,
                        boxRights: kutuHakkiDonusum,
                        keptMultiplierValue: user.activeMultiplier 
                    });

                    await userRef.update({
                        kutuHakki: (user.kutuHakki || 0) + kutuHakkiDonusum
                    });

                    await db.ref(`users/${currentUser}/dailyRewardsClaimed/${rewardId}`).set(firebase.database.ServerValue.TIMESTAMP);
                    displayMessage(`BaÅŸarÄ±lÄ±! ${reward.name} Ã¶dÃ¼lÃ¼, envanterinize +${kutuHakkiDonusum} Kutu HakkÄ± olarak eklendi.`);
                    closeDailyRewardModal();
                    checkAvailableDailyRewards();
                    
                    return;
                }
            }
        }
        
        let updates = {};
        let message = `Tebrikler! GÃ¼nlÃ¼k Ã¶dÃ¼l olarak <b>${reward.name}</b> kazandÄ±n.`;

        switch (reward.type) {
            case 'points':
                updates['balance'] = (user.balance || 0) + reward.value;
                if (updates['balance'] > (user.highestBalanceEver || 0)) {
                    updates['highestBalanceEver'] = updates['balance'];
                }
                updates['kariyerPuani'] = (user.kariyerPuani || 0) + reward.value;
                break;
            case 'boxRights':
                updates['kutuHakki'] = (user.kutuHakki || 0) + reward.value;
                break;
            case 'wheelTicket':
                updates['carkBileti'] = (user.carkBileti || 0) + reward.value;
                break;
            case 'clickCatchTicket':
                updates['clickCatchTickets'] = (user.clickCatchTickets || 0) + reward.value;
                break;
            case 'iflasShield':
                updates['iflasShieldUses'] = (user.iflasShieldUses || 0) + reward.value;
                break;
            case 'tempMultiplier':
                updates['activeMultiplier'] = reward.value;
                updates['multiplierRemainingUses'] = reward.uses;
                updates['multiplierSource'] = 'store';
                break;
            case 'avatar':
                const newAvatarId = db.ref().push().key;
                updates[`avatars/${newAvatarId}`] = {
                    id: newAvatarId,
                    name: reward.avatarName,
                    imageUrl: reward.avatarImageUrl
                };
                message = `Tebrikler! <b>${reward.avatarName}</b> avatarÄ± koleksiyonuna eklendi!`;
                break;
            case 'wildcard':
                if (user.completedCollection === true) {
                    const boxRightsToGain = (reward.value || 1) * 5;
                    updates['kutuHakki'] = (user.kutuHakki || 0) + boxRightsToGain;
                    message = `Harika! Koleksiyonu zaten tamamladÄ±ÄŸÄ±n iÃ§in kazandÄ±ÄŸÄ±n ${reward.value} Joker Kart, hesabÄ±na <b class="text-green-400">+${boxRightsToGain} Kutu HakkÄ±</b> olarak eklendi!`;
                } else {
                    updates['wildcards'] = (user.wildcards || 0) + reward.value;
                    message = `Ä°NANILMAZ! GÃ¼nlÃ¼k Ã¶dÃ¼lden <b class="text-purple-400">+${reward.value} JOKER KART</b> kazandÄ±n!`;
                }
                break;
            case 'card_pack':
            case 'card_pack_normal':
            case 'card_pack_gumus':
            case 'card_pack_altin':
            case 'card_pack_efsanevi':
                if (user.completedCollection === true) {
                    const pointsToGain = (reward.value || 1) * 500;
                    updates['balance'] = (user.balance || 0) + pointsToGain;
                    updates['kariyerPuani'] = (user.kariyerPuani || 0) + pointsToGain;
                    message = `Tebrikler! Koleksiyonu zaten tamamladÄ±ÄŸÄ±n iÃ§in kazandÄ±ÄŸÄ±n ${reward.value} ${reward.name}, hesabÄ±na <b class="text-green-400">+${pointsToGain} Puan</b> olarak eklendi!`;
                } else {
                    startCardPackOpening(reward.value || 1, 'GÃ¼nlÃ¼k Ã–dÃ¼l', 1, reward.type);
                    message = `Tebrikler! GÃ¼nlÃ¼k Ã¶dÃ¼lden ${reward.value} adet ${reward.name} kazandÄ±n!`;
                }
                break;
        }

        const logDetails = { 
            rewardName: reward.name, 
            rewardType: reward.type, 
            rewardValue: reward.type !== 'avatar' ? reward.value : reward.avatarName
        };
        if (reward.type === 'tempMultiplier') {
            logDetails.rewardUses = reward.uses;
        }
        if (reward.type === 'points') {
            logDetails.newBalance = updates.balance;
        }
        logActivity('dailyReward', currentUser, logDetails);
        
        await userRef.update(updates);
        await db.ref(`users/${currentUser}/dailyRewardsClaimed/${rewardId}`).set(firebase.database.ServerValue.TIMESTAMP);

        displayMessage(message);
        closeDailyRewardModal();
        checkAvailableDailyRewards();

    } catch (error) {
        console.error("GÃ¼nlÃ¼k Ã¶dÃ¼l alÄ±nÄ±rken hata:", error);
        displayMessage("Ã–dÃ¼l alÄ±nÄ±rken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.");
        if (claimButton) {
            claimButton.disabled = false;
            claimButton.textContent = 'Ã–dÃ¼lÃ¼ Al';
        }
    }
}

function handleDailyRewardTypeChange() {
    const type = document.getElementById('dailyRewardType').value;
    const valueInput = document.getElementById('dailyRewardValue');
    const usesInput = document.getElementById('dailyRewardMultiplierUses');
    const avatarFields = document.getElementById('dailyRewardAvatarFields');

    // Ã–nce tÃ¼m Ã¶zel alanlarÄ± gizle
    valueInput.classList.remove('hidden');
    usesInput.classList.add('hidden');
    avatarFields.classList.add('hidden');

    if (type === 'tempMultiplier') {
        usesInput.classList.remove('hidden');
    } else if (type === 'avatar') {
        valueInput.classList.add('hidden'); // Avatar iÃ§in "DeÄŸer" alanÄ± gereksiz
        avatarFields.classList.remove('hidden');
    }
}
// Bu event listener'Ä± script'in en altÄ±na veya uygun bir yere ekleyin.
document.getElementById('dailyRewardType').addEventListener('change', handleDailyRewardTypeChange);

    function resetDailyRewardForm() {
    document.getElementById('dailyRewardName').value = '';
    document.getElementById('dailyRewardDescription').value = '';
    document.getElementById('dailyRewardType').value = '';
    document.getElementById('dailyRewardValue').value = '';
    document.getElementById('dailyRewardMultiplierUses').value = '';
    document.getElementById('dailyRewardCooldownDays').value = '';
    document.getElementById('dailyRewardCooldownHours').value = '';
    document.getElementById('dailyRewardCooldownMinutes').value = '';
    document.getElementById('dailyRewardCooldownSeconds').value = '';
    document.getElementById('dailyRewardImageUrl').value = '';
    
    // YENÄ° EKLENEN SATIRLAR
    document.getElementById('dailyRewardAvatarName').value = '';
    document.getElementById('dailyRewardAvatarImageUrl').value = '';
    
    document.getElementById('saveDailyRewardBtn').textContent = 'GÃœNLÃœK Ã–DÃœL OLUÅTUR';
    editingDailyRewardId = null;
    
    // Formun gÃ¶rsel durumunu da sÄ±fÄ±rla
    handleDailyRewardTypeChange();
}

    async function saveDailyReward() {
    if (!isAdmin) return;
    
    const name = document.getElementById('dailyRewardName').value.trim();
    const type = document.getElementById('dailyRewardType').value;
    const value = parseInt(document.getElementById('dailyRewardValue').value);
    const description = document.getElementById('dailyRewardDescription').value.trim();
    const imageUrl = document.getElementById('dailyRewardImageUrl').value.trim();
    
    const days = parseInt(document.getElementById('dailyRewardCooldownDays').value) || 0;
    const hours = parseInt(document.getElementById('dailyRewardCooldownHours').value) || 0;
    const minutes = parseInt(document.getElementById('dailyRewardCooldownMinutes').value) || 0;
    const seconds = parseInt(document.getElementById('dailyRewardCooldownSeconds').value) || 0;

    if (!name || !type || !description) {
        displayMessage("LÃ¼tfen Ã¶dÃ¼l iÃ§in tÃ¼m zorunlu alanlarÄ± (Ad, Tip, AÃ§Ä±klama) doldurun.");
        return;
    }

    const cooldownMs = (days * 24 * 3600 + hours * 3600 + minutes * 60 + seconds) * 1000;
    let cooldownText = '';
    if(days > 0) cooldownText += `${days}g `;
    if(hours > 0) cooldownText += `${hours}s `;
    if(minutes > 0) cooldownText += `${minutes}d `;
    if(seconds > 0) cooldownText += `${seconds}sn`;
    if (cooldownText === '') cooldownText = 'Tek Seferlik';

    const rewardData = { name, type, description, cooldownMs, cooldownText, imageUrl: imageUrl || 'https://via.placeholder.com/150' };

    if (editingDailyRewardId) {
        const existingRewardSnap = await db.ref('dailyRewardOptions/' + editingDailyRewardId).once('value');
        const existingReward = existingRewardSnap.val();
        rewardData.order = existingReward.order;
    } else {
        const maxOrderSnap = await db.ref('dailyRewardOptions').orderByChild('order').limitToLast(1).once('value');
        let maxOrder = -1;
        if(maxOrderSnap.exists()){
            maxOrder = Object.values(maxOrderSnap.val())[0].order || 0;
        }
        rewardData.order = maxOrder + 1;
    }

    // TÄ°PE GÃ–RE Ã–ZEL VERÄ°LERÄ° EKLEME
    if (type === 'tempMultiplier') {
        const uses = parseInt(document.getElementById('dailyRewardMultiplierUses').value);
        if (isNaN(uses) || uses <= 0) {
            displayMessage("Ã‡arpan iÃ§in geÃ§erli bir kullanÄ±m hakkÄ± sayÄ±sÄ± girin.");
            return;
        }
        rewardData.uses = uses;
        rewardData.value = value;
    } else if (type === 'avatar') {
        const avatarName = document.getElementById('dailyRewardAvatarName').value.trim();
        const avatarImageUrl = document.getElementById('dailyRewardAvatarImageUrl').value.trim();
        if (!avatarName || !avatarImageUrl) {
            displayMessage("Avatar Ã¶dÃ¼lÃ¼ iÃ§in Avatar AdÄ± ve Resim URL'si zorunludur.");
            return;
        }
        rewardData.avatarName = avatarName;
        rewardData.avatarImageUrl = avatarImageUrl;
    } else {
        if (isNaN(value) || value <= 0) {
            displayMessage("Bu Ã¶dÃ¼l tipi iÃ§in geÃ§erli bir 'DeÄŸer' girmelisiniz.");
            return;
        }
        rewardData.value = value;
    }
    
    if (editingDailyRewardId) {
        await db.ref('dailyRewardOptions/' + editingDailyRewardId).update(rewardData);
        displayMessage("GÃ¼nlÃ¼k Ã¶dÃ¼l baÅŸarÄ±yla gÃ¼ncellendi.");
    } else {
        await db.ref('dailyRewardOptions').push(rewardData);
        displayMessage("Yeni gÃ¼nlÃ¼k Ã¶dÃ¼l baÅŸarÄ±yla oluÅŸturuldu.");
    }
    
    resetDailyRewardForm();
    closeAdminDailyRewardModal();
    openDailyRewardModal();
}
    
    // DEÄÄ°ÅTÄ°RÄ°LECEK FONKSÄ°YON
async function reorderDailyRewardItem(rewardId, newIndex) {
    if (!isAdmin) return;
    const rewardsRef = db.ref('dailyRewardOptions');
    const rewardsSnap = await rewardsRef.once('value');
    const rewards = rewardsSnap.val();
    if (!rewards) return;

    let sortedRewards = Object.entries(rewards).sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));
    
    const itemToMoveIndex = sortedRewards.findIndex(([id]) => id === rewardId);
    if (itemToMoveIndex === -1) return;

    if (newIndex < 0 || newIndex >= sortedRewards.length) return;

    const [movedItem] = sortedRewards.splice(itemToMoveIndex, 1);
    sortedRewards.splice(newIndex, 0, movedItem);

    const updates = {};
    sortedRewards.forEach(([id], index) => {
      updates[`dailyRewardOptions/${id}/order`] = index;
    });
    
    await db.ref().update(updates);
}

    async function editDailyReward(rewardId) {
    if (!isAdmin) return;
    
    const rewardSnap = await db.ref('dailyRewardOptions/' + rewardId).once('value');
    const reward = rewardSnap.val();
    if (!reward) {
        displayMessage("DÃ¼zenlenecek Ã¶dÃ¼l bulunamadÄ±.");
        return;
    }
    
    document.getElementById('dailyRewardName').value = reward.name;
    document.getElementById('dailyRewardDescription').value = reward.description;
    document.getElementById('dailyRewardType').value = reward.type;
    document.getElementById('dailyRewardImageUrl').value = reward.imageUrl || '';
    
    const cooldownMs = reward.cooldownMs || 0;
    const days = Math.floor(cooldownMs / (1000 * 60 * 60 * 24));
    const hours = Math.floor((cooldownMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((cooldownMs % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((cooldownMs % (1000 * 60)) / 1000);

    document.getElementById('dailyRewardCooldownDays').value = days;
    document.getElementById('dailyRewardCooldownHours').value = hours;
    document.getElementById('dailyRewardCooldownMinutes').value = minutes;
    document.getElementById('dailyRewardCooldownSeconds').value = seconds;

    // TÄ°PE GÃ–RE Ã–ZEL ALANLARI DOLDUR
    if (reward.type === 'tempMultiplier') {
        document.getElementById('dailyRewardValue').value = reward.value || '';
        document.getElementById('dailyRewardMultiplierUses').value = reward.uses || '';
    } else if (reward.type === 'avatar') {
        document.getElementById('dailyRewardAvatarName').value = reward.avatarName || '';
        document.getElementById('dailyRewardAvatarImageUrl').value = reward.avatarImageUrl || '';
    } else {
        document.getElementById('dailyRewardValue').value = reward.value || '';
    }

    document.getElementById('saveDailyRewardBtn').textContent = 'Ã–DÃœLÃœ GÃœNCELLE';
    editingDailyRewardId = rewardId;
    
    handleDailyRewardTypeChange(); // Formun gÃ¶rsel durumunu gÃ¼ncelle
    openAdminDailyRewardModal(); 
    document.querySelector('#adminDailyRewardModal .modal-content').scrollTop = 0;
}

    async function removeDailyReward(rewardId) {
        if (!isAdmin) return;
        if (await customConfirm("Bu gÃ¼nlÃ¼k Ã¶dÃ¼lÃ¼ silmek istediÄŸinizden emin misiniz?")) {
            await db.ref('dailyRewardOptions/' + rewardId).remove();
            displayMessage("GÃ¼nlÃ¼k Ã¶dÃ¼l kaldÄ±rÄ±ldÄ±.");
            openDailyRewardModal();
        }
    }
  
    function listenForDailyRewardChanges() {
        const ref = db.ref('dailyRewardOptions');
        const callback = snap => {
            if (dailyRewardModal.style.display === 'flex') {
                openDailyRewardModal();
            }
            checkAvailableDailyRewards();
        };
        activeListeners.dailyRewards = { ref, event: 'value', callback };
        ref.on('value', callback);
    }
  
    function listenForAdminNotifications() {
      const ref = db.ref(`users/${currentUser}/notifications`);
      const callback = snap => {
          const notification = snap.val();
          if (notification && notification.message) {
              displayMessage(notification.message);
              snap.ref.remove();
          }
      };
      activeListeners.adminNotifications = { ref: ref.orderByChild('timestamp').startAt(sessionStartTime), event: 'child_added', callback };
      ref.orderByChild('timestamp').startAt(sessionStartTime).on('child_added', callback);
  }
  
    function openBoxStatsModal() {
      const listEl = document.getElementById('boxStatsList');
      listEl.innerHTML = 'YÃ¼kleniyor...';
      db.ref('gameStats/boxesOpenedByUsers').orderByValue().once('value').then(snap => {
          const stats = snap.val();
          if (!stats) {
              listEl.innerHTML = '<p class="text-center text-gray-400">Bu turda henÃ¼z kimse kutu aÃ§madÄ±.</p>';
          } else {
              let html = '';
              const sortedUsers = Object.entries(stats).sort(([, countA], [, countB]) => countB - countA);
              sortedUsers.forEach(([user, count]) => {
                  html += `<p class="p-2 bg-gray-800 rounded mb-2">${user}: <span class="font-bold text-yellow-300">${count}</span> kutu</p>`;
              });
              listEl.innerHTML = html;
          }
          boxStatsModal.style.display = 'flex';
      });
    }
    function closeBoxStatsModal() {
      boxStatsModal.style.display = 'none';
    }

    let surpriseSessionListener = null;

function openSpectatorModal(sessionData) {
    if (spectatorCountdownInterval) clearInterval(spectatorCountdownInterval);

    document.getElementById('spectatorTitle').innerHTML = `<span class="text-green-400 font-bold">${sessionData.user}</span> SÃ¼rpriz Kutu buldu!`;
    const cardContainer = document.getElementById('spectatorCardContainer');
    cardContainer.innerHTML = '';

    sessionData.cards.forEach((cardValue, index) => {
        const cardDiv = document.createElement('div');
        // --- DEÄÄ°ÅÄ°KLÄ°K BURADA: 'bg-gray-700' class'Ä± kaldÄ±rÄ±ldÄ±. ---
        cardDiv.className = 'card border-2 border-red-700 rounded-xl w-28 h-40 flex flex-col items-center justify-center font-bold text-2xl relative';
        cardDiv.id = `spectator-card-${index}`;
        cardDiv.innerHTML = `<div class="card-back absolute inset-0 bg-gradient-to-br from-red-700 to-red-900 flex items-center justify-center text-white text-5xl">?</div><div class="card-front absolute inset-0 bg-gray-900 flex items-center justify-center text-yellow-400 text-3xl"></div>`;
        cardContainer.appendChild(cardDiv);
    });

    const resultContainer = document.getElementById('spectatorResultContainer');
    resultContainer.innerHTML = '<p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8"></p>';

    const countdownEl = document.getElementById('spectatorCountdown');
    let timeLeft = Math.round((sessionData.expirationTimestamp - getSyncedTime()) / 1000);

    const handleTimeout = () => {
        countdownEl.textContent = 'SÃ¼re Doldu!';
        const resultP = document.getElementById('spectatorResult');
        if (resultP) {
            resultP.textContent = 'Kart seÃ§ilmedi, puan kazanÄ±lamadÄ±.';
            resultP.className = 'text-xl text-red-400 font-bold h-8';
        }
        resultContainer.innerHTML += `<button onclick="closeSpectatorModal()" class="mt-4 py-3 px-8 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg transition-colors">Oyuna DÃ¶n</button>`;
    };

    if (timeLeft <= 0) {
        handleTimeout();
        spectatorModal.style.display = 'flex';
        return;
    }

    countdownEl.textContent = timeLeft;
    spectatorCountdownInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft >= 0) {
            countdownEl.textContent = timeLeft;
        } else {
            clearInterval(spectatorCountdownInterval);
            handleTimeout();
        }
    }, 1000);

    spectatorModal.style.display = 'flex';
}

function updateSpectatorView(sessionData) {
    // *** YENÄ° EKLENEN SATIR ***
    // Ä°zleyicinin artÄ±k sonucu gÃ¶rdÃ¼ÄŸÃ¼nÃ¼ ve pencerenin kapanmamasÄ± gerektiÄŸini iÅŸaretle
    spectatorViewingResult = true;

    if (spectatorCountdownInterval) {
        clearInterval(spectatorCountdownInterval);
        spectatorCountdownInterval = null;
    }
    document.getElementById('spectatorCountdown').textContent = 'SeÃ§im YapÄ±ldÄ±!';

    const selectedCardIndex = sessionData.selection.cardIndex;
    const pointsGained = sessionData.result.points;

    const allCards = document.querySelectorAll('#spectatorCardContainer .card');
    
    sessionData.cards.forEach((cardValue, index) => {
        const cardEl = allCards[index];
        if (cardEl) {
            const cardFront = cardEl.querySelector('.card-front');
            const realPoints = cardValue * (sessionData.multiplier || 1);
            cardFront.textContent = `+${realPoints}`;

            setTimeout(() => {
                cardEl.classList.add('opened');
                if (index == selectedCardIndex) {
                    cardEl.classList.add('glowing-border');
                }
            }, 100);
        }
    });

    const resultContainer = document.getElementById('spectatorResultContainer');
    if (resultContainer) {
         resultContainer.innerHTML = `
            <p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8">
                ${sessionData.user}, ${pointsGained} puan kazandÄ±!
            </p>
            <button onclick="closeSpectatorModal()" class="mt-4 py-3 px-8 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg transition-colors">
                Oyuna Devam Et
            </button>
        `;
    }
}

// MEVCUT showGlobalSurpriseBoxNotification FONKSÄ°YONUNU BU BLOK Ä°LE DEÄÄ°ÅTÄ°RÄ°N

function showGlobalSurpriseBoxNotification(data) {
    document.getElementById('surpriseOpener').textContent = data.user;
    
    const sourceInfoEl = document.getElementById('surpriseSourceInfo');
    if (data.boxId === 'Ã‡ark') {
        sourceInfoEl.innerHTML = `<b>Åans Ã‡arkÄ±</b>'ndan SÃ¼rpriz Kutu elde etti ve kart seÃ§iminden`;
    } else {
        sourceInfoEl.innerHTML = `<span class="text-red-400 font-bold">${data.boxId}</span> numaralÄ± kutuyu aÃ§tÄ± ve kart seÃ§iminden`;
    }

    document.getElementById('surprisePoints').textContent = data.result.points;
    
    // *** Ä°STEÄÄ°NÄ°ZE GÃ–RE DÃœZENLENEN KISIM BAÅLANGICI ***
    let multiplierText = ''; // VarsayÄ±lan olarak metni boÅŸ yapÄ±yoruz.
    // Sadece kutudan geldiyse Ã§arpan metnini gÃ¶ster
    if (data.boxId !== 'Ã‡ark') {
        if (data.multiplier && data.multiplier > 1) {
            const basePoints = Math.round(data.result.points / data.multiplier);
            multiplierText = `kazandÄ±! <br><span class="text-base text-gray-400">(${basePoints} Puan x ${data.multiplier} Ã‡arpan)</span>`;
        } else {
            multiplierText = 'kazandÄ±! (Ã‡arpan kullanÄ±lmadÄ±)';
        }
    } else {
        // Ã‡arktan geldiyse sadece "kazandÄ±!" yazsÄ±n.
        multiplierText = 'kazandÄ±!';
    }
    // *** DÃœZENLENEN KISIM SONU ***

    document.getElementById('surpriseMultiplierInfo').innerHTML = multiplierText;

    document.getElementById('globalSurpriseBoxModal').style.display = 'flex';
}

// MEVCUT closeSpectatorModal FONKSÄ°YONUNU BU BLOK Ä°LE DEÄÄ°ÅTÄ°RÄ°N

function closeSpectatorModal() {
    if (spectatorCountdownInterval) {
        clearInterval(spectatorCountdownInterval);
        spectatorCountdownInterval = null;
    }
    const spectatorModal = document.getElementById('spectatorModal');
    spectatorModal.style.display = 'none';

    const resultContainer = document.getElementById('spectatorResultContainer');
    if (resultContainer) {
        resultContainer.innerHTML = '<p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8"></p>';
    }

    // *** YENÄ° EKLENEN SATIR ***
    // Ä°zleyici pencereyi kapattÄ±ÄŸÄ± iÃ§in bayraÄŸÄ± sÄ±fÄ±rla
    spectatorViewingResult = false;
}
    
// ...VE YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTÄ°R
function renderWheel() {
    const wheelElement = document.getElementById('wheel');
    if (!wheelElement) { return; }
    
    wheelElement.innerHTML = ''; 

    const segments = wheelSegments;
    const segmentCount = segments.length;
    if (segmentCount === 0) return;

    // --- MANUEL AYAR NOKTAN BURASI ---
    // Bu sayÄ±yÄ± deÄŸiÅŸtirerek tÃ¼m simgelerin yÃ¶nÃ¼nÃ¼ ayarla.
    // Pozitif sayÄ± = Saat yÃ¶nÃ¼nde kaydÄ±rÄ±r.
    // Negatif sayÄ± = Saat yÃ¶nÃ¼nÃ¼n tersine kaydÄ±rÄ±r.
    // 0 = Tam ortaya alÄ±r.
    const angleOffset = 6; 
    // ------------------------------------

    const segmentAngle = 360 / segmentCount;
    let gradientParts = [];

    segments.forEach((segment, i) => {
        const startAngle = segmentAngle * i;
        const endAngle = startAngle + segmentAngle;
        gradientParts.push(`${segment.color || '#cccccc'} ${startAngle}deg ${endAngle}deg`);

        // HESAPLAMA BURADA DEÄÄ°ÅTÄ°: ArtÄ±k angleOffset'i hesaba katÄ±yor.
        const textAngle = startAngle + (segmentAngle / 2) + angleOffset;
        
        const textHolder = document.createElement('div');
        textHolder.className = 'wheel-text-container';
        textHolder.style.transform = `rotate(${textAngle}deg)`;

        if (segment.imageUrl && segment.imageUrl.trim() !== '') {
            const imageEl = document.createElement('img');
            imageEl.src = segment.imageUrl;
            imageEl.className = 'wheel-image';
            
            if (textAngle > 90 && textAngle < 270) {
                imageEl.style.transform = 'translate(-50%, -50%) rotate(180deg)';
            } else {
                imageEl.style.transform = 'translate(-50%, -50%)';
            }
            textHolder.appendChild(imageEl);
        } else {
            const textSpan = document.createElement('span');
            textSpan.className = 'wheel-text';
            textSpan.textContent = segment.label;

            if (textAngle > 90 && textAngle < 270) {
                textSpan.style.transform = 'translate(-50%, -50%) rotate(180deg)';
            } else {
                textSpan.style.transform = 'translate(-50%, -50%)';
            }
            textHolder.appendChild(textSpan);
        }
        
        wheelElement.appendChild(textHolder);
    });

    wheelElement.style.background = `conic-gradient(${gradientParts.join(', ')})`;
}
    function listenForLastWheelSurprisePanel() {
    const ref = db.ref('gameStats/lastWheelSurpriseInfo');
    const panel = document.getElementById('lastWheelSurprisePanel');

    const callback = snap => {
        const data = snap.val();
        if (!data || !data.finder) {
            panel.classList.add('hidden');
            return;
        }

        // --- DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR ---
        let adminDeleteButton = '';
        if (isAdmin) {
            adminDeleteButton = `
                <button onclick="silSonCarkSurprizi()" class="absolute -top-3 -right-3 bg-red-600 hover:bg-red-500 text-white rounded-full h-8 w-8 flex items-center justify-center text-lg font-bold transition-transform hover:scale-110" title="Bu Paneli Gizle">
                    &times;
                </button>
            `;
        }
        // --- DEÄÄ°ÅÄ°KLÄ°K BURADA BÄ°TÄ°YOR ---

        const finderHtml = `<b class="text-white">${data.finder}</b>`;
        const messageHtml = `
            ${adminDeleteButton}
            <h4 class="text-amber-300 text-lg font-bold">ğŸ¡ Ã‡ARKTAN SON Ã‡IKAN SÃœRPRÄ°Z! ğŸ¡</h4>
            <p>${finderHtml}, Ã§arktan SÃ¼rpriz Kutu kazandÄ±!</p>
            <p>Kart seÃ§iminden <b class="text-green-400">+${data.points} Puan</b> elde etti. <span class="text-gray-400">(Mevcut PuanÄ±: ${data.newBalance})</span></p>
        `;

        panel.innerHTML = messageHtml;
        panel.classList.add('relative'); // Butonun konumlanmasÄ± iÃ§in gerekli
        panel.classList.remove('hidden');
    };

    if (activeListeners.wheelSurprisePanel) {
        activeListeners.wheelSurprisePanel.ref.off('value', activeListeners.wheelSurprisePanel.callback);
    }
    activeListeners.wheelSurprisePanel = { ref, event: 'value', callback };
    ref.on('value', callback);
}

async function spinWheel() {
    if (isWheelSpinning) return;
    if (isAdmin) {
        displayMessage("Adminler Ã§ark Ã§eviremez.");
        return;
    }
    
    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();

    if (!userData || (userData.carkBileti || 0) < 1) {
        displayMessage("Ã‡arkÄ± Ã§evirmek iÃ§in yeterli biletiniz yok.");
        return;
    }
    
    if (userData.multiplierSource !== 'none') {
        const confirmSpin = await customConfirm("Aktif bir Ã§arpanÄ±nÄ±z var. Ã‡arktan yeni bir Ã§arpan Ã§Ä±karsa, mevcut Ã§arpanÄ±nÄ±zÄ±n Ã¼zerine yazÄ±lÄ±r. Devam etmek istiyor musunuz?");
        if (!confirmSpin) return;
    }

    isWheelSpinning = true;
    spinBtn.disabled = true;
    spinBtn.textContent = 'DÃ¶nÃ¼yor...';

    await userRef.update({
        carkBileti: userData.carkBileti - 1,
        wheelSpinsCount: (userData.wheelSpinsCount || 0) + 1
    });

    const totalWeight = wheelSegments.reduce((sum, seg) => sum + (seg.weight || 1), 0);
    let randomWeight = Math.random() * totalWeight;
    let winningIndex = -1;
    for (let i = 0; i < wheelSegments.length; i++) {
        randomWeight -= (wheelSegments[i].weight || 1);
        if (randomWeight < 0) {
            winningIndex = i;
            break;
        }
    }
    if (winningIndex === -1) winningIndex = 0;
    const winningSegment = wheelSegments[winningIndex];
    
    const totalSegments = wheelSegments.length;
    const degreesPerSegment = 360 / totalSegments;
    const winningAngle = (winningIndex * degreesPerSegment) + (degreesPerSegment / 2);

    const spinCycles = 5 + Math.floor(Math.random() * 3);
    const finalRotation = (spinCycles * 360) + 270 - winningAngle;

    wheel.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
    wheel.style.transform = `rotate(${finalRotation}deg)`;
    
    setTimeout(async () => {
        isWheelSpinning = false;
        spinBtn.disabled = false;
        spinBtn.textContent = 'Ã‡arkÄ± Ã‡evir!';

        const currentUserDataSnap = await userRef.once('value');
        const currentUserData = currentUserDataSnap.val();

        if (!currentUserData) {
            console.error("Ã‡ark sonucu iÅŸlenirken kullanÄ±cÄ± verisi bulunamadÄ±!");
            displayMessage("Bir hata oluÅŸtu, Ã¶dÃ¼lÃ¼nÃ¼z iÅŸlenemedi. LÃ¼tfen sayfayÄ± yenileyin.");
            return;
        }

        let message = '';
        let updates = {};
        let shouldLogActivity = true;
        
        switch(winningSegment.type) {
            case 'points':
                message = `Tebrikler, Ã§arktan <b>+${winningSegment.value} Puan</b> kazandÄ±n!`;
                updates.balance = (currentUserData.balance || 0) + winningSegment.value;
                if(updates.balance > (currentUserData.highestBalanceEver || 0)) updates.highestBalanceEver = updates.balance;
                updates.kariyerPuani = (currentUserData.kariyerPuani || 0) + winningSegment.value;
                break;
            case 'boxRights':
                message = `Tebrikler, Ã§arktan <b>+${winningSegment.value} Kutu HakkÄ±</b> kazandÄ±n!`;
                updates.kutuHakki = (currentUserData.kutuHakki || 0) + winningSegment.value;
                break;
            case 'iflasShield':
                message = `Tebrikler, Ã§arktan <b>+${winningSegment.value} Ä°flas KalkanÄ±</b> kazandÄ±n!`;
                updates.iflasShieldUses = (currentUserData.iflasShieldUses || 0) + winningSegment.value;
                break;
            case 'clickCatchTicket':
                 message = `Tebrikler, Ã§arktan <b>+${winningSegment.value} TÄ±kla-Yakala Bileti</b> kazandÄ±n!`;
                updates.clickCatchTickets = (currentUserData.clickCatchTickets || 0) + winningSegment.value;
                break;
            case 'wheelTicket':
                 message = `Tebrikler, Ã§arktan <b>+${winningSegment.value} Ã‡ark Bileti</b> kazandÄ±n!`;
                 updates.carkBileti = (currentUserData.carkBileti || 0) + winningSegment.value;
                break;
            case 'tempMultiplier':
                message = `Tebrikler, Ã§arktan <b>${winningSegment.value}X Ã‡arpan</b> kazandÄ±n!`;
                updates.activeMultiplier = winningSegment.value;
                updates.multiplierSource = 'store';
                updates.multiplierRemainingUses = winningSegment.duration;
                break;
            case 'surpriseBox':
                 const sessionRef = db.ref('surprise_box_session');
                 await sessionRef.set({ 
                     active: true, user: currentUser, boxId: 'Ã‡ark', 
                     multiplier: 1, cards: shuffleArray([...cardValues]), 
                     selection: null, result: null, 
                     timestamp: firebase.database.ServerValue.TIMESTAMP
                 });
                 const snap = await sessionRef.once('value');
                 const serverTimestamp = snap.val().timestamp;
                 await sessionRef.update({ expirationTimestamp: serverTimestamp + 60000 });
                 openCardSelectionModal(currentUser);
                 message = "Vay canÄ±na! Ã‡arktan SÃ¼rpriz Kutu Ã§Ä±ktÄ±! Åimdi bir kart seÃ§.";
                 shouldLogActivity = false;
                 break;
            case 'wildcard':
                const userSnapForCheckWC = await userRef.once('value');
                const userForCheckWC = userSnapForCheckWC.val();
                if (userForCheckWC.completedCollection === true) {
                    const boxRightsToGain = (winningSegment.value || 1) * 5;
                    message = `Harika! Koleksiyonu zaten tamamladÄ±ÄŸÄ±n iÃ§in kazandÄ±ÄŸÄ±n Joker Kart, hesabÄ±na <b class="text-green-400">+${boxRightsToGain} Kutu HakkÄ±</b> olarak eklendi!`;
                    updates.kutuHakki = (currentUserData.kutuHakki || 0) + boxRightsToGain;
                } else {
                    message = `HARÄ°KA! Ã‡arktan en nadir Ã¶dÃ¼l olan <b class="text-purple-400">+${winningSegment.value} JOKER KART</b> kazandÄ±n!`;
                    updates.wildcards = (currentUserData.wildcards || 0) + winningSegment.value;
                }
                break;
            case 'card_pack':
            case 'card_pack_normal':
            case 'card_pack_gumus':
            case 'card_pack_altin':
            case 'card_pack_efsanevi':
                const packsToOpen = winningSegment.value || 1;
                message = `Tebrikler! Ã‡arktan ${packsToOpen} adet ${winningSegment.prizeName} kazandÄ±n!`;
                startCardPackOpening(packsToOpen, 'Åans Ã‡arkÄ±', 1, winningSegment.type);
                shouldLogActivity = false;
                break;
            case 'pas':
                message = "Bu seferlik pas! Bir dahaki sefere daha ÅŸanslÄ± olabilirsin.";
                break;
        }

        db.ref('wheelHistory').push().set({
            username: currentUser, 
            prize: winningSegment.prizeName || winningSegment.label,
            type: winningSegment.type,
            value: winningSegment.value !== undefined ? winningSegment.value : null,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        const historyRef = db.ref('wheelHistory');
        historyRef.orderByChild('timestamp').once('value', (snapshot) => {
            const totalCount = snapshot.numChildren();
            const limit = 10;
            if (totalCount > limit) {
                let itemsToDeleteCount = totalCount - limit;
                snapshot.forEach((childSnapshot) => {
                    if (itemsToDeleteCount <= 0) return true; 
                    childSnapshot.ref.remove();
                    itemsToDeleteCount--;
                });
            }
        });

        const logDetails = {
            result: winningSegment.prizeName || winningSegment.label,
            type: winningSegment.type,
            value: winningSegment.value !== undefined ? winningSegment.value : null
        };
        if (winningSegment.type === 'points') {
            logDetails.newBalance = updates.balance;
        }
        
        if (shouldLogActivity) {
            logActivity('spinWheel', currentUser, logDetails);
        }
        
        if(Object.keys(updates).length > 0) await userRef.update(updates);
        
        displayMessage(message);
        
        const normalizedRotation = finalRotation % 360;
        wheel.style.transition = 'none';
        wheel.style.transform = `rotate(${normalizedRotation}deg)`;

    }, 5100);
}

function closeSoloGameSettingsModal() {
    soloGameSettingsModal.style.display = 'none';
}

function openLobbySettingsModal() {
    lobbySettingsModal.style.display = 'flex';
}

function closeLobbySettingsModal() {
    lobbySettingsModal.style.display = 'none';
}

// --- YENÄ° FONKSÄ°YONLAR BÄ°TÄ°Å ---
  let lobbyGameSettings = {};
  let lobbyListener = null;

  function updateClickCatchTimer() {
    clickCatchTimer--;
    document.getElementById('clickCatchTimer').textContent = clickCatchTimer;
    if (clickCatchTimer <= 0) {
        endSoloClickCatchGame();
    }
  }
    
async function resetClickCatchLeaderboard() {
    if (!isAdmin) {
        displayMessage("Bu iÅŸlemi yapmaya yetkiniz yok.");
        return;
    }

    const confirmed = await customConfirm(
        "TÃ¼m 'TÄ±kla-Yakala' sÄ±ralamasÄ±nÄ± ve tÃ¼m kullanÄ±cÄ±larÄ±n kiÅŸisel rekorlarÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!"
    );

    if (!confirmed) {
        return;
    }

    try {
        // 1. HaftalÄ±k skor tablosunu tamamen sil.
        // Bu tablo olmasa bile kod hata vermeden Ã§alÄ±ÅŸacaktÄ±r.
        await db.ref('clickCatchWeeklyScores').remove();

        // 2. TÃ¼m kullanÄ±cÄ±larÄ±n kiÅŸisel rekorlarÄ±nÄ± sÄ±fÄ±rla.
        const usersRef = db.ref('users');
        const usersSnap = await usersRef.once('value');
        const usersData = usersSnap.val();
        
        const updates = {};
        if (usersData) {
            for (const username in usersData) {
                // Sadece 'clickCatchHighestScore' alanÄ± olan kullanÄ±cÄ±larÄ± gÃ¼ncelle
                if (usersData[username].hasOwnProperty('clickCatchHighestScore')) {
                    updates[`/users/${username}/clickCatchHighestScore`] = 0;
                }
            }
        }

        // EÄŸer gÃ¼ncellenecek kullanÄ±cÄ± varsa, toplu gÃ¼ncelleme yap.
        if (Object.keys(updates).length > 0) {
            await db.ref().update(updates);
        }

        // 3. Global lider deÄŸiÅŸkenini temizle
        clickCatchLeader = null;

        displayMessage("TÃ¼m TÄ±kla-Yakala sÄ±ralamasÄ± ve kiÅŸisel rekorlar baÅŸarÄ±yla sÄ±fÄ±rlandÄ±.");
        
    } catch (error) {
        console.error("TÄ±kla-Yakala sÄ±ralamasÄ± sÄ±fÄ±rlanÄ±rken hata oluÅŸtu:", error);
        displayMessage("SÄ±fÄ±rlama iÅŸlemi sÄ±rasÄ±nda bir hata meydana geldi.");
    }
}
  function createCatchItem(gameMode) {
    if (!clickCatchGameActive && gameMode === 'solo') return;
    if (gameMode === 'lobby' && (!lobbyGameSettings.state || lobbyGameSettings.state !== 'active')) return;

    const gameArea = document.getElementById('clickCatchGameArea');
    const item = document.createElement('div');
    item.className = 'catch-item';
    
    if (gameMode === 'solo') {
        const itemsWithChance = [
            { type: 'points', value: soloGameSettings.bombValue, emoji: 'ğŸ’£', chance: soloGameSettings.bombChance },
            { type: 'time', value: soloGameSettings.timeValue, emoji: 'â°', chance: soloGameSettings.timeChance },
            { type: 'points', value: soloGameSettings.goldValue, emoji: 'ğŸ’°', chance: soloGameSettings.goldChance },
            { type: 'special', value: null, emoji: null, chance: specialItemForThisRound ? soloGameSettings.specialChance : 0 },
            { type: 'points', value: soloGameSettings.normalValue, emoji: 'ğŸ¥®', chance: soloGameSettings.normalChance || 50 }
        ];
        
        const totalChance = itemsWithChance.reduce((sum, item) => sum + item.chance, 0);
        const random = Math.random() * totalChance;
        let cumulativeChance = 0;
        let itemToSpawn;

        for (const i of itemsWithChance) {
            cumulativeChance += i.chance;
            if (random < cumulativeChance) {
                itemToSpawn = i;
                break;
            }
        }
        
        if (!itemToSpawn) {
            itemToSpawn = { type: 'points', value: soloGameSettings.normalValue, emoji: 'ğŸ¥®' };
        }

        if (itemToSpawn.type === 'special') {
            itemToSpawn = specialItemForThisRound;
            specialItemForThisRound = null; 
        }
        
        item.textContent = itemToSpawn.emoji;
        item.dataset.type = itemToSpawn.type;
        item.dataset.value = itemToSpawn.value;
        item.dataset.emoji = itemToSpawn.emoji;

    } else { // Bu kÄ±sÄ±m lobi oyunu iÃ§in
        const isBomb = Math.random() < 0.2; // %20 ihtimalle bomba Ã§Ä±kar

        if (isBomb) {
            item.textContent = 'ğŸ’£';
            item.style.backgroundColor = 'transparent';
            item.style.fontSize = '30px';
            item.dataset.type = 'bomb';
        } else {
            item.textContent = 'ğŸ¯';
            item.style.backgroundColor = 'transparent';
            item.style.fontSize = '30px';
            item.dataset.type = 'target';
        }
    }

    item.style.left = `${Math.random() * (gameArea.clientWidth - 30)}px`;
    item.style.top = `${Math.random() * (gameArea.clientHeight - 30)}px`;
    
    item.onclick = gameMode === 'solo' ? handleSoloItemClick : handleLobbyItemClick;
    
    const disappearTime = gameMode === 'solo' ? soloGameSettings.itemDisappearTime : lobbyGameSettings.itemInterval;
    
    gameArea.appendChild(item);
    
    setTimeout(() => {
        if (item.parentNode) {
            item.remove();
        }
    }, disappearTime);
}
  function showFloatingText(text, x, y) {
      const gameArea = document.getElementById('clickCatchGameArea');
      const textEl = document.createElement('div');
      textEl.textContent = text;
      textEl.className = 'floating-text';
      
      const rect = gameArea.getBoundingClientRect();
      const relativeX = x - rect.left;
      const relativeY = y - rect.top;

      textEl.style.left = `${relativeX}px`;
      textEl.style.top = `${relativeY}px`;
      
      gameArea.appendChild(textEl);
      
      textEl.addEventListener('animationend', () => {
          textEl.remove();
      });
  }
    
async function clearLastWinner() {
    if (!isAdmin) {
        displayMessage("Bu iÅŸlemi yapmaya yetkiniz yok.");
        return;
    }
    const confirmed = await customConfirm("Son kazanan bilgisini silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!");
    if (confirmed) {
        await db.ref('clickCatchLobbyLastGameSummary').remove();
        displayMessage("Son kazanan bilgisi baÅŸarÄ±yla silindi.");
        // Not: ArayÃ¼zÃ¼n gÃ¼ncellenmesini listenForLastGameSummary fonksiyonu otomatik olarak yapacak.
    }
}
  
  function handleSoloItemClick(event) {
    if (!clickCatchGameActive) return;
    
    const item = event.target;
    const type = item.dataset.type;
    const value = parseInt(item.dataset.value);
    const uses = parseInt(item.dataset.uses);
    const emoji = item.dataset.emoji;
    
    let floatingText = '';

    switch(type) {
        case 'points':
            clickCatchScore = Number(clickCatchScore) + value;
            document.getElementById('clickCatchScore').textContent = clickCatchScore;
            floatingText = (value > 0 ? '+' : '') + value + ' Skor';
            break;
        case 'time':
            clickCatchTimer += value;
            document.getElementById('clickCatchTimer').textContent = clickCatchTimer;
            floatingText = `+${value} Saniye`;
            break;
        case 'boxRight':
            collectedBoxRights += value;
            floatingText = `+${value} Kutu HakkÄ±`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'iflasShield':
            collectedIflasShields += value;
            floatingText = `+${value} Ä°flas KalkanÄ±`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'wheelTicket':
            collectedWheelTickets += value;
            floatingText = `+${value} Ã‡ark Bileti`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'tempMultiplier':
            collectedMultipliers.push({ value: value, uses: uses });
            floatingText = `${value}x Ã‡arpan (${uses} kullanÄ±m)`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'wildcard':
            // Bu gelecekte eklenebilir, ÅŸimdilik diÄŸerleriyle aynÄ± mantÄ±kta Ã§alÄ±ÅŸsÄ±n
            // collectedWildcards += value;
            floatingText = `+${value} ğŸƒ Joker Kart YakalandÄ±!`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">ğŸ</span>`;
            break;
        case 'card_pack':
        case 'card_pack_normal':
        case 'card_pack_gumus':
        case 'card_pack_altin':
        case 'card_pack_efsanevi':
            const packNames = {
                'card_pack': 'ğŸ´ Standart Kart Paketi',
                'card_pack_normal': 'ğŸ¥‰ Bronz Kart Paketi',
                'card_pack_gumus': 'ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi',
                'card_pack_altin': 'ğŸ¥‡ AltÄ±n Kart Paketi',
                'card_pack_efsanevi': 'ğŸ† Efsanevi Kart Paketi'
            };
            const packName = packNames[type];
            collectedCardPacks.push({ type: type, value: value });
            floatingText = `+${value} ${packName} YakalandÄ±!`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">ğŸ</span>`;
            break;
    }
    
    showFloatingText(floatingText, event.clientX, event.clientY);
    item.remove();
}
  
async function deleteUserFromLeaderboard(event, username) {
      event.stopPropagation(); // OlayÄ±n yayÄ±lmasÄ±nÄ± engeller
      if (!isAdmin) return;
      const confirmed = await customConfirm(`<b>${username}</b> adlÄ± kullanÄ±cÄ±yÄ± YakalayÄ±cÄ±lar listesinden silmek istediÄŸinize emin misiniz?`);
      if (confirmed) {
          await db.ref(`clickCatchWeeklyScores/${username}`).remove();
          displayMessage(`${username} skor tablosundan silindi.`);
          loadClickCatchRankings(); // Tabloyu anÄ±nda yenile
      }
  }
  // YENÄ° YARDIMCI FONKSÄ°YON: TÄ±kla-Yakala liderinin kullanÄ±cÄ± adÄ±nÄ± anlÄ±k Ã§eker.
async function getClickCatchLeaderUsername() {
    const scoresSnap = await db.ref('clickCatchWeeklyScores').orderByValue().limitToLast(1).once('value');
    if (!scoresSnap.exists()) {
        return null; // Lider yoksa null dÃ¶ner
    }
    const scores = [];
    scoresSnap.forEach(child => {
        scores.push({ username: child.key });
    });
    return scores.length > 0 ? scores[0].username : null;
}
   function loadClickCatchRankings() {
      const rankingsList = document.getElementById('clickCatchRankings');
      const searchTerm = document.getElementById('searchClickCatchRanking').value.trim().toLowerCase();
      const ref = db.ref('clickCatchWeeklyScores').orderByValue();
      
      const callback = snap => {
          rankingsList.innerHTML = 'YÃ¼kleniyor...';
          
          if (!snap.exists()) {
              rankingsList.innerHTML = '<p class="text-center text-gray-400">Bu hafta henÃ¼z skor kaydedilmedi.</p>';
              clickCatchLeader = null;
              return;
          }

          let html = '';
          const scores = [];
          snap.forEach(child => {
              scores.push({ username: child.key, score: child.val() });
          });
          scores.reverse();

          if(scores.length > 0) { clickCatchLeader = scores[0].username; } 
          else { clickCatchLeader = null; }

          let filteredScores = scores;
          if (searchTerm) {
              filteredScores = scores.filter(entry => entry.username.toLowerCase().includes(searchTerm));
          }

          filteredScores.forEach((entry, index) => {
              const leaderBadge = (index === 0 && !searchTerm) ? '<span title="TÄ±kla ve Yakala Lideri">ğŸ¯</span>' : '';
              const deleteButton = isAdmin 
? `<button onclick="deleteUserFromLeaderboard(event, '${entry.username}')" class="ml-3 text-gray-500 hover:text-red-500 transition-colors" title="Skor Tablosundan Sil">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
     </button>` : '';

              const userData = allUsersCache.find(user => user.username === entry.username);
              const avatarUrl = userData && userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;

              html += `
                <div onclick="openPublicUserDetailModal('${entry.username}')" class="flex justify-between items-center p-2 mb-2 bg-gray-800 rounded-md cursor-pointer hover:bg-gray-700 transition-colors">
                    <div class="flex items-center">
                        <span class="font-bold mr-2">${index + 1}.</span>
                        <img src="${avatarUrl}" class="w-10 h-10 rounded-md mr-3 object-contain">
                        <span>${leaderBadge} ${entry.username}</span>
                        ${deleteButton}
                    </div>
                    <span class="font-bold text-yellow-300">${entry.score} Skor</span>
                </div>`;
          });
          rankingsList.innerHTML = html || '<p class="text-center text-gray-400">Aramayla eÅŸleÅŸen kullanÄ±cÄ± bulunamadÄ±.</p>';
      };
      
      if (activeListeners.clickCatchRankings) {
          activeListeners.clickCatchRankings.ref.off('value', activeListeners.clickCatchRankings.callback);
      }
      activeListeners.clickCatchRankings = { ref, event: 'value', callback };
      ref.on('value', callback);
  }

    // === BU YENÄ° FONKSÄ°YONLARI DOSYANIN SONUNA EKLE ===

// Lobi bildirim penceresini gÃ¶sterir
function showLobbyNotification(lobbyData) {
    const infoDiv = document.getElementById('lobbyNotificationInfo');
    const useTickets = lobbyData.entryTickets > 0;
    const entryRequirement = useTickets ? `${lobbyData.entryTickets} Bilet` : `${lobbyData.entryFee} Puan`;

    infoDiv.innerHTML = `
        <p>GiriÅŸ Ãœcreti: <b class="text-white">${entryRequirement}</b></p>
        <p>Hedef: <b class="text-white">${lobbyData.target} Yakalama</b></p>
        <p>BÃ¼yÃ¼k Ã–dÃ¼l: <b class="text-green-400">${lobbyData.prize} Puan</b></p>
        <p class="mt-2 text-sm text-gray-400">Hemen TÄ±kla-Yakala sekmesine git ve lobiye katÄ±l!</p>
    `;
    document.getElementById('lobbyNotificationModal').style.display = 'flex';
}

// Lobi bildirim penceresini kapatÄ±r
function closeLobbyNotificationModal() {
    document.getElementById('lobbyNotificationModal').style.display = 'none';
}

// "Lobiye Git" butonuna basÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
function goToLobbySection() {
    closeLobbyNotificationModal();
    showSection('clickCatch');
}

  // ESKÄ° listenForLobbyChanges FONKSÄ°YONUNU SÄ°LÄ°P, BUNU YAPIÅTIR

function listenForLobbyChanges() {
    const lobbyRef = db.ref('clickCatchLobby');

    if (activeListeners.lobby) {
        activeListeners.lobby.ref.off(activeListeners.lobby.event, activeListeners.lobby.callback);
    }
    
    const startScreen = document.getElementById('clickCatchStartScreen');
    const lobbyStatusContainer = document.getElementById('lobbyStatusContainer');
    const lobbyGameOverScreen = document.getElementById('lobbyGameOverScreen');

    const callback = snap => {
        const lobbyData = snap.val();
        const joinLobbyBtn = document.getElementById('joinLobbyBtn');
        const startSoloGameBtn = document.getElementById('startSoloGameBtn');
        const lobbyStartBtn = document.getElementById('lobbyStartBtn');
        
        if (countdownInterval) clearInterval(countdownInterval);

        startSoloGameBtn.disabled = false;

        if (!lobbyData || !lobbyData.state) {
            lobbyGameSettings = {};
            hasShownLobbyNotification = false; 
            closeLobbyNotificationModal(); 
            lobbyStatusContainer.classList.add('hidden');
            lobbyGameOverScreen.classList.add('hidden');
            startScreen.style.display = 'flex';
            
            // Oyun bitince veya iptal olunca arayÃ¼zdeki zamanlayÄ±cÄ±larÄ± temizle
            if (clickCatchItemInterval) {
                clearInterval(clickCatchItemInterval);
                clickCatchItemInterval = null;
            }
            
            joinLobbyBtn.disabled = true;
            joinLobbyBtn.textContent = 'Lobiye KatÄ±l';
            joinLobbyBtn.onclick = () => joinLobby();
            joinLobbyBtn.classList.remove('bg-orange-600', 'hover:bg-orange-500');
            joinLobbyBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');

            if (isAdmin && lobbyStartBtn) lobbyStartBtn.disabled = true;
            document.getElementById('displayTarget').classList.add('hidden');
            return;
        }

        lobbyGameSettings = lobbyData;
        lobbyStatusContainer.classList.remove('hidden');
        lobbyGameOverScreen.classList.add('hidden');

        const useTickets = lobbyData.entryTickets > 0;
        const entryRequirement = useTickets ? `${lobbyData.entryTickets} Bilet` : `${lobbyData.entryFee} Puan`;
        
        document.getElementById('lobbyStatusInfo').textContent = `KatÄ±lÄ±m Ã¼creti: ${entryRequirement} | Hedef: ${lobbyData.target} Yakalama | Ã–dÃ¼l: ${lobbyData.prize} Puan`;
        
        const players = lobbyData.players || {};
        const hasPlayers = Object.keys(players).length > 0;
        const isCurrentUserInLobby = lobbyData.state !== 'finished' && players[currentUser] !== undefined;

        const playerListEl = document.getElementById('lobbyPlayerList');
        playerListEl.innerHTML = ``;
        if (hasPlayers) {
            const sortedPlayers = Object.entries(players).sort(([, a], [, b]) => b.score - a.score);
            playerListEl.innerHTML = `KatÄ±lÄ±mcÄ±lar: <br>`;
            sortedPlayers.forEach(([username, playerData]) => {
                playerListEl.innerHTML += `<b>${username}:</b> ${playerData.score} / ${lobbyData.target}<br>`;
            });
        } else {
            playerListEl.textContent = `HenÃ¼z katÄ±lan yok.`;
        }

        if (isAdmin) {
            startSoloGameBtn.disabled = true;
            joinLobbyBtn.disabled = true;
            if(lobbyStartBtn) lobbyStartBtn.disabled = !(lobbyData.state === 'waiting' && hasPlayers);
        } else {
            if (isCurrentUserInLobby) {
                joinLobbyBtn.disabled = lobbyData.state === 'active';
                joinLobbyBtn.textContent = 'Lobiden AyrÄ±l';
                joinLobbyBtn.onclick = () => leaveLobby();
                joinLobbyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                joinLobbyBtn.classList.add('bg-orange-600', 'hover:bg-orange-500');
            } else {
                joinLobbyBtn.disabled = lobbyData.state !== 'waiting';
                joinLobbyBtn.textContent = 'Lobiye KatÄ±l';
                joinLobbyBtn.onclick = () => joinLobby();
                joinLobbyBtn.classList.remove('bg-orange-600', 'hover:bg-orange-500');
                joinLobbyBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            }
        }
        
        if (lobbyData.state === 'waiting') {
            document.getElementById('lobbyStatusTitle').textContent = "Lobi KatÄ±lÄ±ma AÃ§Ä±k!";
            startScreen.style.display = 'flex';
            document.getElementById('displayTarget').classList.add('hidden');
            
            if (!isAdmin && !isCurrentUserInLobby && !hasShownLobbyNotification) {
                showLobbyNotification(lobbyData);
                hasShownLobbyNotification = true;
            }
            
        } else if (lobbyData.state === 'active') {
            document.getElementById('lobbyStatusTitle').textContent = "Oyun BaÅŸladÄ±! Hedefe Ä°lk UlaÅŸan KazanÄ±r!";
            startScreen.style.display = 'none';
            closeLobbyNotificationModal();
            document.getElementById('displayScore').classList.add('hidden');
            document.getElementById('displaySpecials').classList.add('hidden');
            document.getElementById('displayTimer').classList.add('hidden');
            document.getElementById('displayTarget').classList.remove('hidden');
            
            const currentUserScore = isCurrentUserInLobby ? (players[currentUser] ? players[currentUser].score : 0) : 0;
            document.getElementById('clickCatchTarget').textContent = `${currentUserScore} / ${lobbyData.target}`;

            if (isCurrentUserInLobby && currentActiveSection !== 'clickCatch') {
                showSection('clickCatch');
            }
            
            // ================== PERFORMANS DÃœZELTMESÄ° BURADA ==================
            // Bu blok artÄ±k sadece lobiye katÄ±lan oyuncularda Ã§alÄ±ÅŸacak.
            if (isCurrentUserInLobby) {
                if (!clickCatchItemInterval) {
                   showGameCountdown(() => {
                       // Hedef oluÅŸturma dÃ¶ngÃ¼sÃ¼ sadece katÄ±lÄ±mcÄ± iÃ§in baÅŸlar.
                       clickCatchItemInterval = setInterval(() => createCatchItem('lobby'), lobbyData.itemInterval);
                   });
                }
            }
            // =================================================================

        } else if (lobbyData.state === 'finished') {
            lobbyStatusContainer.classList.add('hidden');
            lobbyGameOverScreen.classList.remove('hidden');
            document.getElementById('lobbyGameOverInfo').innerHTML = `Kazanan: <b class="text-2xl text-yellow-300">${lobbyData.winner}</b>! Ã–dÃ¼l: ${lobbyData.prize} Puan!`;
            
            startScreen.style.display = 'none';
            document.getElementById('displayTarget').classList.add('hidden');
            if (clickCatchItemInterval) {
                clearInterval(clickCatchItemInterval);
                clickCatchItemInterval = null;
            }
        }
    };

    activeListeners.lobby = { ref: lobbyRef, event: 'value', callback };
    lobbyRef.on('value', callback);
}

    // === BU YENÄ° FONKSÄ°YONLARI DOSYANIN SONUNA EKLE ===

async function changeAllWheelTickets(add) {
    const amount = parseInt(document.getElementById("globalWheelTicket").value);
    if (isNaN(amount) || amount <= 0) {
        displayMessage("GeÃ§erli miktar girin.");
        return;
    }
    const confirmed = await customConfirm(`TÃ¼m kullanÄ±cÄ±lara ${amount} adet Ã‡ark Bileti ${add ? 'eklemek' : 'silmek'} istediÄŸinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let currentTickets = child.val().carkBileti || 0;
                    currentTickets = add ? currentTickets + amount : Math.max(0, currentTickets - amount);
                    updates['users/' + child.key + '/carkBileti'] = currentTickets;
                }
            });
            db.ref().update(updates).then(() => displayMessage("TÃ¼m kullanÄ±cÄ±lara Ã‡ark Bileti iÅŸlemi baÅŸarÄ±yla uygulandÄ±."));
        });
    }
}

async function changeAllClickCatchTickets(add) {
    const amount = parseInt(document.getElementById("globalClickCatchTicket").value);
    if (isNaN(amount) || amount <= 0) {
        displayMessage("GeÃ§erli miktar girin.");
        return;
    }
    const confirmed = await customConfirm(`TÃ¼m kullanÄ±cÄ±lara ${amount} adet TÄ±kla-Yakala Bileti ${add ? 'eklemek' : 'silmek'} istediÄŸinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let currentTickets = child.val().clickCatchTickets || 0;
                    currentTickets = add ? currentTickets + amount : Math.max(0, currentTickets - amount);
                    updates['users/' + child.key + '/clickCatchTickets'] = currentTickets;
                }
            });
            db.ref().update(updates).then(() => {
                 displayMessage("TÃ¼m kullanÄ±cÄ±lara TÄ±kla-Yakala Bileti iÅŸlemi baÅŸarÄ±yla uygulandÄ±.");
                 // YENÄ° EKLENEN KOD BAÅLANGICI
                 const actionText = add ? 'gÃ¶nderdi' : 'sildi';
                 const notificationMessage = `Admin, tÃ¼m kullanÄ±cÄ±lara ${amount} TÄ±kla-Yakala Bileti ${actionText}.`;
                 db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                 // YENÄ° EKLENEN KOD SONU
            });
        });
    }
}

let globalNotificationTimeout;

/**
 * Ekranda genel bir yÃ¶netici bildirimi gÃ¶sterir.
 * @param {string} message - GÃ¶sterilecek mesaj.
 */
function displayGlobalNotification(message) {
    const notificationEl = document.getElementById('globalAdminNotification');
    if (!notificationEl) return;

    // Ã–nceki bildirimin zaman aÅŸÄ±mÄ±nÄ± temizle
    if (globalNotificationTimeout) {
        clearTimeout(globalNotificationTimeout);
    }

    notificationEl.textContent = message;
    // Bildirimi gÃ¶rÃ¼nÃ¼r yap ve animasyonu tetikle
    notificationEl.classList.remove('opacity-0', '-translate-y-20');

    // 5 saniye sonra bildirimi gizle
    globalNotificationTimeout = setTimeout(() => {
        notificationEl.classList.add('opacity-0', '-translate-y-20');
    }, 5000);
}
    
// YUKARIDAKÄ° ESKÄ° KODU SÄ°LÄ°P, YERÄ°NE BU YENÄ° KODU YAPIÅTIR
async function listenForGlobalNotifications() {
    // Adminler iÃ§in bu fonksiyon Ã§alÄ±ÅŸmasÄ±n
    if (isAdmin) return;

    const userRef = db.ref(`users/${currentUser}`);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();
    
    // KullanÄ±cÄ±nÄ±n en son gÃ¶rdÃ¼ÄŸÃ¼ bildirimin zamanÄ±nÄ± al, yoksa 0 kullan.
    const lastSeenTimestamp = userData.lastSeenGlobalNotifTimestamp || 0;
    
    const notificationsRef = db.ref('globalNotifications');
    const listenerRef = notificationsRef.orderByChild('timestamp').startAt(lastSeenTimestamp + 1);

    const callback = (snap) => {
        const notification = snap.val();
        if (notification && notification.message) {
            // Bildirimi gÃ¶ster
            displayGlobalNotification(notification.message);
            
            // KullanÄ±cÄ±nÄ±n "son gÃ¶rme" zamanÄ±nÄ± bu yeni bildirimin zamanÄ±yla gÃ¼ncelle
            userRef.update({
                lastSeenGlobalNotifTimestamp: notification.timestamp
            });
        }
    };
    
    // Listener'Ä± tekrar tekrar eklememek iÃ§in kontrol
    if (activeListeners.globalNotifications) {
        activeListeners.globalNotifications.ref.off('child_added', activeListeners.globalNotifications.callback);
    }
    
    activeListeners.globalNotifications = { ref: listenerRef, event: 'child_added', callback };
    listenerRef.on('child_added', callback);
}
  
  async function startLobbyGame() {
    if (!isAdmin) return;
    
    // Ã–nceki lobi verilerini temizle
    await db.ref('clickCatchLobby').remove();
    
    // Yeni lobi verilerini kur
    const lobbyData = {
        entryFee: parseInt(document.getElementById('lobbyEntryFee').value) || 100,
        entryTickets: parseInt(document.getElementById('lobbyEntryTickets').value) || 0,
        target: parseInt(document.getElementById('lobbyTarget').value) || 10,
        prize: parseInt(document.getElementById('lobbyPrize').value) || 1000,
        itemInterval: parseInt(document.getElementById('lobbyItemInterval').value) || 800,
        state: 'waiting',
        players: {} // Yeni lobi her zaman boÅŸ oyuncu listesiyle baÅŸlar
    };
    await db.ref('clickCatchLobby').set(lobbyData);
    displayMessage("Lobi kuruldu. Oyuncular katÄ±ldÄ±ktan sonra 'Oyunu BaÅŸlat' butonuna bas.");
}

  async function endLobbyGame(isCancel = false) {
    if (!isAdmin) return;

    const lobbyRef = db.ref('clickCatchLobby');
    const lobbySnap = await lobbyRef.once('value');
    const lobbyData = lobbySnap.val();

    // Lobi zaten yoksa veya boÅŸsa iÅŸlemi bitir.
    if (!lobbyData) {
        if (isCancel) {
            displayMessage("Ä°ptal edilecek aktif bir lobi bulunmuyor.");
        }
        await lobbyRef.remove();
        return;
    }

    const currentState = lobbyData.state;
    const useTickets = lobbyData.entryTickets > 0;
    const updates = {};
    let messageForAdmin = "";

    // Senaryo 1: Lobi "beklemede" veya "aktif" durumdayken admin tarafÄ±ndan iptal ediliyor.
    // Bu durumda Ã¼cretler iade edilir ve bildirim gÃ¶nderilir.
    if (isCancel && (currentState === 'waiting' || currentState === 'active')) {
        const confirmed = await customConfirm("Lobi iptal edilecek ve tÃ¼m katÄ±lÄ±mcÄ±larÄ±n Ã¼cretleri iade edilecek. Emin misin?");
        if (!confirmed) return;

        // Lobide oyuncu varsa iade iÅŸlemlerini yap
        if (lobbyData.players) {
            for (const player in lobbyData.players) {
                const userRef = db.ref(`users/${player}`);
                const userSnap = await userRef.once('value');
                const userData = userSnap.val();

                if (userData) {
                    // Ãœcret tÃ¼rÃ¼ne gÃ¶re iadeyi hazÄ±rla
                    if (useTickets) {
                        const currentTickets = userData.clickCatchTickets || 0;
                        updates[`users/${player}/clickCatchTickets`] = currentTickets + (lobbyData.entryTickets || 0);
                    } else {
                        const currentBalance = userData.balance || 0;
                        updates[`users/${player}/balance`] = currentBalance + (lobbyData.entryFee || 0);
                    }
                    
                    // --- YENÄ° EKLENEN BÄ°LDÄ°RÄ°M KODU ---
                    const messageForUser = "Kurulu lobi admin tarafÄ±ndan iptal edildi. KatÄ±lÄ±m Ã¼cretiniz iade edildi.";
                    const notifKey = db.ref('users/' + player + '/notifications').push().key;
                    updates[`users/${player}/notifications/${notifKey}`] = { message: messageForUser, timestamp: firebase.database.ServerValue.TIMESTAMP };
                    // --- BÄ°LDÄ°RÄ°M KODU SONU ---
                }
            }
        }
        messageForAdmin = "Lobi iptal edildi ve tÃ¼m katÄ±lÄ±mcÄ±larÄ±n Ã¼cretleri iade edildi.";
    } 
    // Senaryo 2: Oyun zaten bitmiÅŸ veya baÅŸka bir durumda iptal ediliyor.
    // Bu durumda Ã¼cret iadesi yapÄ±lmaz.
    else {
        let confirmationMessage = "Lobi sonlandÄ±rÄ±lacak. Bu iÅŸlem geri alÄ±namaz.";
        if (isCancel) {
             confirmationMessage = "Oyun zaten tamamlanmÄ±ÅŸ. Lobiyi sonlandÄ±rmak, Ã¼cretlerin iade edilmemesine neden olur. Emin misin?";
        }
        const confirmed = await customConfirm(confirmationMessage);
        if (!confirmed) return;

        const winner = lobbyData.winner;
        messageForAdmin = winner 
            ? `Oyun sonlandÄ±rÄ±ldÄ±. Kazanan: ${winner}. Ãœcretler iade edilmedi.`
            : "Lobi sonlandÄ±rÄ±ldÄ±. Kazanan belirlenmediÄŸi iÃ§in Ã¼cretler iade edilmedi.";
    }
    
    // HazÄ±rlanan tÃ¼m gÃ¼ncellemeleri (iade ve bildirimler) tek seferde veritabanÄ±na yaz
    if (Object.keys(updates).length > 0) {
        await db.ref().update(updates);
    }
    
    // Son olarak lobiyi sil ve admine bilgi ver
    await lobbyRef.remove();
    displayMessage(messageForAdmin);
}
  // Yeni eklenecek fonksiyon: Ekranda geÃ§ici bildirim gÃ¶sterir
function displayNotification(message, color = 'bg-yellow-500') {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 p-4 rounded-lg shadow-lg text-white font-bold text-center ${color} animate-fade-in-out`;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 3000); // 3 saniye sonra bildirim kaybolur
}
  // BU FONKSÄ°YONU BUL VE AÅAÄIDAKÄ°YLE DEÄÄ°ÅTÄ°R
async function triggerLobbyGameStart() {
    if (!isAdmin) return;
    if (lobbyGameSettings.state !== 'waiting') {
        displayMessage("Oyun sadece 'beklemede' durumundayken baÅŸlatÄ±labilir.");
        return;
    }
    if (!lobbyGameSettings.players || Object.keys(lobbyGameSettings.players).length === 0) {
        displayMessage("Oyunu baÅŸlatmak iÃ§in en az bir katÄ±lÄ±mcÄ± olmalÄ±dÄ±r.");
        return;
    }
    // OYUNUN BAÅLAMA ZAMANINI KAYDETMEK Ä°Ã‡Ä°N startTimestamp EKLENDÄ°
    await db.ref('clickCatchLobby').update({ 
        state: 'active',
        startTimestamp: firebase.database.ServerValue.TIMESTAMP 
    });
    displayMessage("Oyun baÅŸlatÄ±ldÄ±!");
}
  async function joinLobby() {
      if (isAdmin) return;
      const userRef = db.ref('users/' + currentUser);
      const userSnap = await userRef.once('value');
      const userData = userSnap.val();
      const useTickets = lobbyGameSettings.entryTickets > 0;
      let confirmed = false;

      if (useTickets) {
          if ((!userData.clickCatchTickets || userData.clickCatchTickets < lobbyGameSettings.entryTickets)) {
              displayMessage(`Lobiye katÄ±lmak iÃ§in ${lobbyGameSettings.entryTickets} adet TÄ±kla-Yakala Biletin yok.`);
              return;
          }
          confirmed = await customConfirm(`Lobiye katÄ±lmak iÃ§in ${lobbyGameSettings.entryTickets} adet bilet harcanacak. OnaylÄ±yor musun?`);
          if (confirmed) {
              await userRef.update({ clickCatchTickets: (userData.clickCatchTickets || 0) - lobbyGameSettings.entryTickets });
          }
      } else {
          if ((userData.balance || 0) < lobbyGameSettings.entryFee) {
              displayMessage("Lobiye katÄ±lmak iÃ§in yeterli puanÄ±n yok.");
              return;
          }
          confirmed = await customConfirm(`Lobiye katÄ±lmak iÃ§in ${lobbyGameSettings.entryFee} puan harcanacak. OnaylÄ±yor musun?`);
          if (confirmed) {
              await userRef.update({ balance: (userData.balance || 0) - lobbyGameSettings.entryFee });
          }
      }
      
      if (confirmed) {
          await db.ref(`clickCatchLobby/players/${currentUser}`).set({ score: 0 });
          displayMessage("Lobiye baÅŸarÄ±yla katÄ±ldÄ±n! Adminin oyunu baÅŸlatmasÄ± bekleniyor.");
      }
  }
  async function leaveLobby() {
    if (isAdmin || !lobbyGameSettings || lobbyGameSettings.state !== 'waiting') return;

    const confirmed = await customConfirm("Lobiden ayrÄ±lmak istediÄŸine emin misin? KatÄ±lÄ±m Ã¼cretin iade edilecek.");
    if (!confirmed) return;

    const userRef = db.ref('users/' + currentUser);
    const useTickets = lobbyGameSettings.entryTickets > 0;

    // Ãœcreti iade et
    await userRef.transaction(user => {
        if (user) {
            if (useTickets) {
                user.clickCatchTickets = (user.clickCatchTickets || 0) + lobbyGameSettings.entryTickets;
            } else {
                user.balance = (user.balance || 0) + lobbyGameSettings.entryFee;
            }
        }
        return user;
    });

    // Oyuncuyu lobiden sil
    await db.ref(`clickCatchLobby/players/${currentUser}`).remove();

    displayMessage("Lobiden ayrÄ±ldÄ±n ve katÄ±lÄ±m Ã¼cretin iade edildi.");
  }

  async function handleLobbyItemClick(event) {
    if (lobbyGameSettings.state !== 'active') return;
    
    // DÃ¼zeltilen kÄ±sÄ±m: TÄ±klanan element ne olursa olsun, en yakÄ±n ebeveyn catch-item'Ä± bulur
    const item = event.target.closest('.catch-item');
    if (!item) return; // EÄŸer doÄŸru element bulunamazsa iÅŸlemi durdur

    const itemType = item.dataset.type;

    const lobbyPlayerRef = db.ref(`clickCatchLobby/players/${currentUser}`);
    
    const playerSnap = await lobbyPlayerRef.once('value');
    const playerData = playerSnap.val();
    if (!playerData) return;

    let newScore = playerData.score;

    if (itemType === 'bomb') {
        newScore = Math.max(0, newScore - 1); // Skoru 1 azalt, ama 0'Ä±n altÄ±na dÃ¼ÅŸmesin
        showFloatingText('-1', event.clientX, event.clientY);
    } else {
        newScore++;
        showFloatingText('+1', event.clientX, event.clientY);
    }

    await lobbyPlayerRef.update({ score: newScore });

    document.getElementById('clickCatchTarget').textContent = `${newScore} / ${lobbyGameSettings.target}`;

    if(newScore >= lobbyGameSettings.target) {
        db.ref('clickCatchLobby/state').once('value').then(snap => {
            if (snap.val() === 'active') {
                setWinner(currentUser);
            }
        });
    }

    item.remove();
}

// **** YENÄ° EKLENECEK FONKSÄ°YONLAR BAÅLANGICI ****

/**
 * Oyun baÅŸlamadan Ã¶nce ekranda 3'ten geriye sayÄ±m gÃ¶sterir.
 * @param {function} onComplete - Geri sayÄ±m bittiÄŸinde Ã§alÄ±ÅŸtÄ±rÄ±lacak olan fonksiyon.
 */
function showGameCountdown(onComplete) {
    const overlay = document.getElementById('gameCountdownOverlay');
    const countdownText = document.getElementById('countdownText');
    const startScreen = document.getElementById('clickCatchStartScreen');

    startScreen.style.display = 'none'; // Oyun modunu seÃ§me ekranÄ±nÄ± gizle
    overlay.style.display = 'flex';    // Geri sayÄ±m ekranÄ±nÄ± gÃ¶ster

    let count = 3;
    countdownText.textContent = count;

    const countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
            countdownText.textContent = count;
        } else if (count === 0) {
            countdownText.textContent = 'BAÅLA!';
        } else {
            clearInterval(countdownInterval);
            overlay.style.display = 'none'; // Geri sayÄ±m bitince ekranÄ± gizle
            if (onComplete) {
                onComplete(); // AsÄ±l oyunu baÅŸlatan fonksiyonu Ã§aÄŸÄ±r
            }
        }
    }, 1000);
}

/**
 * Geri sayÄ±m bittikten sonra Tekli Oyun'u gerÃ§ekten baÅŸlatan yardÄ±mcÄ± fonksiyon.
 */
function _actuallyStartSoloGame() {
    // Bu fonksiyonun iÃ§eriÄŸi, startSoloClickCatchGame fonksiyonundan taÅŸÄ±ndÄ±.
    clickCatchTimerInterval = setInterval(updateClickCatchTimer, 1000);
    clickCatchItemInterval = setInterval(() => createCatchItem('solo'), soloGameSettings.itemInterval);
}

let weeklyCountdownInterval = null

  async function openSoloGameSettingsModal() {
    // Mevcut tekli oyun ayarlarÄ±nÄ± yÃ¼kle
    await loadSoloGameSettings();

    // HaftalÄ±k otomatik sÄ±fÄ±rlama ayarlarÄ±nÄ± yÃ¼kle
    const settingsSnap = await db.ref('gameConfig/weeklyClickCatchReset').once('value');
    if (settingsSnap.exists()) {
        const settings = settingsSnap.val();
        if (settings.endDate) {
            const date = new Date(settings.endDate);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            document.getElementById('weeklyResetEndDateInput').value = date.toISOString().slice(0, 16);
        }
        if (settings.prize) {
            document.getElementById('weeklyPrizeType').value = settings.prize.type || 'points';
            document.getElementById('weeklyPrizeAmount').value = settings.prize.amount || 1000;
        }
    } else {
        // EÄŸer ayar yoksa alanlarÄ± temizle/varsayÄ±lana ayarla
        document.getElementById('weeklyResetEndDateInput').value = '';
        document.getElementById('weeklyPrizeType').value = 'points';
        document.getElementById('weeklyPrizeAmount').value = 1000;
    }

    soloGameSettingsModal.style.display = 'flex';
}
  
  function closeSoloGameSettingsModal() {
      soloGameSettingsModal.style.display = 'none';
  }
  
  function closeSoloGameSettingsModal() {
    soloGameSettingsModal.style.display = 'none';
}

  function closeLobbySettingsModal() {
      lobbySettingsModal.style.display = 'none';
  }
  // YENÄ° EKLENECEK FONKSÄ°YON
// "Oyun Bitti" ekranÄ±nÄ± sadece tÄ±klayan kullanÄ±cÄ±nÄ±n ekranÄ±nda kapatÄ±r.
function closeLobbyGameOverScreen() {
    const gameOverScreen = document.getElementById('lobbyGameOverScreen');
    const startScreen = document.getElementById('clickCatchStartScreen');

    if (gameOverScreen) {
        gameOverScreen.classList.add('hidden');
    }
    if (startScreen) {
        startScreen.style.display = 'flex';
    }

    // --- YENÄ° EKLENEN SATIR BAÅLANGICI ---
    // Butona basÄ±ldÄ±ÄŸÄ± anda, bu oyuncu iÃ§in lobi durumunu yerel olarak sÄ±fÄ±rlÄ±yoruz.
    // Bu, kullanÄ±cÄ±nÄ±n butona bastÄ±ÄŸÄ± anda yeni bir oyuna baÅŸlayabilmesini saÄŸlar.
    // ArtÄ±k 5 saniye beklemesine gerek kalmaz.
    lobbyGameSettings = {};
    // --- YENÄ° EKLENEN SATIR SONU ---
}

async function saveSoloGameSettings() {
    if (!isAdmin) return;

    const settings = {
        duration: parseInt(document.getElementById('soloGameDuration').value) || 30,
        itemDisappearTime: parseInt(document.getElementById('soloItemDisappearTime').value) || 1200,
        itemInterval: parseInt(document.getElementById('soloItemInterval').value) || 600,
        bombChance: parseInt(document.getElementById('soloBombChance').value) || 40,
        timeChance: parseInt(document.getElementById('soloTimeChance').value) || 8,
        goldChance: parseInt(document.getElementById('soloGoldChance').value) || 6,
        specialChance: parseInt(document.getElementById('soloSpecialChance').value) || 4,
        normalChance: parseInt(document.getElementById('soloNormalChance').value) || 50,
        timeValue: parseInt(document.getElementById('soloTimeValue').value) || 3,
        bombValue: parseInt(document.getElementById('soloBombValue').value) || -75,
        goldValue: parseInt(document.getElementById('soloGoldValue').value) || 100,
        normalValue: parseInt(document.getElementById('soloNormalValue').value) || 50,
        specialItemType: document.getElementById('soloSpecialItemType').value || 'boxRight',
        specialValue: parseInt(document.getElementById('soloSpecialValue').value) || 1,
        specialMultiplierUses: parseInt(document.getElementById('soloSpecialMultiplierUses').value) || 1
    };

    const totalChance = settings.bombChance + settings.timeChance + settings.goldChance + settings.specialChance + settings.normalChance;

    await db.ref('gameSettings/clickCatchSolo').set(settings);

    if (totalChance !== 100) {
        displayMessage("UyarÄ±: Åans yÃ¼zdelerinin toplamÄ± 100 deÄŸil! LÃ¼tfen deÄŸerleri kontrol et. Ayarlar yine de kaydedildi.");
    } else {
        displayMessage("Tekli oyun ayarlarÄ± baÅŸarÄ±yla kaydedildi.");
    }
}

async function loadSoloGameSettings() {
    const settingsSnap = await db.ref('gameSettings/clickCatchSolo').once('value');
    if (settingsSnap.exists()) {
        soloGameSettings = settingsSnap.val();
    }
    document.getElementById('soloGameDuration').value = soloGameSettings.duration;
    document.getElementById('soloItemDisappearTime').value = soloGameSettings.itemDisappearTime;
    document.getElementById('soloItemInterval').value = soloGameSettings.itemInterval;
    document.getElementById('soloBombChance').value = soloGameSettings.bombChance;
    document.getElementById('soloTimeChance').value = soloGameSettings.timeChance;
    document.getElementById('soloGoldChance').value = soloGameSettings.goldChance;
    document.getElementById('soloSpecialChance').value = soloGameSettings.specialChance;
    document.getElementById('soloNormalChance').value = soloGameSettings.normalChance || 50;
    document.getElementById('soloTimeValue').value = soloGameSettings.timeValue || 3;
    document.getElementById('soloBombValue').value = soloGameSettings.bombValue || -75;
    document.getElementById('soloGoldValue').value = soloGameSettings.goldValue || 100;
    document.getElementById('soloNormalValue').value = soloGameSettings.normalValue || 50;
    document.getElementById('soloSpecialItemType').value = soloGameSettings.specialItemType || 'boxRight';
    document.getElementById('soloSpecialValue').value = soloGameSettings.specialValue || 1;
    document.getElementById('soloSpecialMultiplierUses').value = soloGameSettings.specialMultiplierUses || 1;
    
    // YENÄ° EKLENEN KOD: SeÃ§ime gÃ¶re input'larÄ± gÃ¶ster/gizle
    const typeSelect = document.getElementById('soloSpecialItemType');
    const valueInput = document.getElementById('soloSpecialValue');
    const usesInput = document.getElementById('soloSpecialMultiplierUses');
    if (typeSelect.value === 'tempMultiplier') {
        valueInput.placeholder = 'Ã‡arpan DeÄŸeri (Ã¶rn: 2)';
        usesInput.classList.remove('hidden');
    } else {
        valueInput.placeholder = 'Adet (Ã¶rn: 1, 5)';
        usesInput.classList.add('hidden');
    }
}

async function startSoloClickCatchGame() {
    if (lobbyGameSettings && lobbyGameSettings.state && (lobbyGameSettings.state === 'waiting' || lobbyGameSettings.state === 'active')) {
        displayMessage("Åu anda aktif bir lobi var. Lobi sona erdiÄŸinde tekli oyun oynayabilirsiniz.");
        return;
    }
    if (clickCatchGameActive) return;
    if (isAdmin) {
        displayMessage("Adminler bu oyunu oynayamaz.");
        return;
    }
    await loadSoloGameSettings();
    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();
    if ((!userData.clickCatchTickets || userData.clickCatchTickets < 1)) {
        displayMessage("Bu oyunu oynamak iÃ§in 'TÄ±kla-Yakala Bileti'ne ihtiyacÄ±n var. MaÄŸazadan alabilirsin.");
        return;
    }
    
    if (userData.multiplierSource && userData.multiplierSource !== 'none') {
        const warningConfirmed = await customConfirm(`Aktif bir <b>${userData.activeMultiplier}x</b> Ã§arpanÄ±n bulunuyor. Bu oyunda yeni bir Ã§arpan kazanÄ±rsan mevcut Ã§arpanÄ±nla etkileÅŸime girebilir. Devam etmek istiyor musun?`);
        if (!warningConfirmed) {
            return;
        }
    }

    const confirmed = await customConfirm("Oyuna baÅŸlamak iÃ§in 1 adet 'TÄ±kla-Yakala Bileti' harcanacaktÄ±r. OnaylÄ±yor musun?");
    if (!confirmed) return;
    await userRef.update({ clickCatchTickets: (userData.clickCatchTickets || 0) - 1 });
    
    // YENÄ° PAKETLERÄ° TANIYAN GÃœNCEL HARÄ°TA
    const specialItemMapping = {
      'boxRight': { type: 'boxRight', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ“¦' },
      'iflasShield': { type: 'iflasShield', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ›¡ï¸' },
      'wheelTicket': { type: 'wheelTicket', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ«ï¸' },
      'tempMultiplier': { type: 'tempMultiplier', value: soloGameSettings.specialValue || 2, uses: soloGameSettings.specialMultiplierUses || 1, emoji: 'âœ–ï¸' },
      'wildcard': { type: 'wildcard', value: soloGameSettings.specialValue || 1, emoji: 'ğŸƒ' },
      'card_pack_standart': { type: 'card_pack_standart', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ´' },
      'card_pack_bronz': { type: 'card_pack_bronz', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ¥‰' },
      'card_pack_gumus': { type: 'card_pack_gumus', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ¥ˆ' },
      'card_pack_altin': { type: 'card_pack_altin', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ¥‡' },
      'card_pack_efsanevi': { type: 'card_pack_efsanevi', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ†' }
    };
    specialItemForThisRound = specialItemMapping[soloGameSettings.specialItemType] || specialItemMapping['boxRight'];
    
    clickCatchGameActive = true;
    clickCatchScore = 0;
    clickCatchTimer = soloGameSettings.duration;
    collectedBoxRights = 0;
    collectedIflasShields = 0;
    collectedWheelTickets = 0;
    collectedMultipliers = [];
    collectedCardPacks = []; // YENÄ° EKLENDÄ°: Her oyun baÅŸÄ±nda listeyi sÄ±fÄ±rla

    document.getElementById('clickCatchScore').textContent = clickCatchScore;
    document.getElementById('clickCatchTimer').textContent = clickCatchTimer;
    document.getElementById('displayScore').classList.remove('hidden');
    document.getElementById('displaySpecials').classList.remove('hidden');
    document.getElementById('displayTimer').classList.remove('hidden');
    document.getElementById('displayTarget').classList.add('hidden');
    document.getElementById('collectedSpecials').innerHTML = '';
    showGameCountdown(_actuallyStartSoloGame);
}

async function endSoloClickCatchGame() {
    clickCatchGameActive = false;
    clearInterval(clickCatchTimerInterval);
    clearInterval(clickCatchItemInterval);
    clickCatchTimerInterval = null;
    clickCatchItemInterval = null;

    const gameArea = document.getElementById('clickCatchGameArea');
    const itemsToRemove = gameArea.querySelectorAll('.catch-item, .floating-text');
    itemsToRemove.forEach(item => item.remove());

    document.getElementById('clickCatchStartScreen').style.display = 'flex';
    document.getElementById('displayScore').classList.add('hidden');
    document.getElementById('displaySpecials').classList.add('hidden');
    document.getElementById('displayTimer').classList.add('hidden');

    const specialItemsWonLog = [];
    if (collectedBoxRights > 0) specialItemsWonLog.push(`+${collectedBoxRights} Kutu HakkÄ±`);
    if (collectedIflasShields > 0) specialItemsWonLog.push(`+${collectedIflasShields} Ä°flas KalkanÄ±`);
    if (collectedWheelTickets > 0) specialItemsWonLog.push(`+${collectedWheelTickets} Ã‡ark Bileti`);
    if (collectedMultipliers.length > 0) {
        collectedMultipliers.forEach(m => specialItemsWonLog.push(`${m.value}x Ã‡arpan (${m.uses} kullanÄ±m)`));
    }

    let endMessage = `Oyun bitti! Bu turdaki skorun: <b>${clickCatchScore}</b>.`;
    if (specialItemsWonLog.length > 0) {
        endMessage += `<br>AyrÄ±ca, <b>${specialItemsWonLog.join(', ')}</b> kazandÄ±n!`;
    }
    displayMessage(endMessage);

    const weeklyScoreRef = db.ref(`clickCatchWeeklyScores/${currentUser}`);
    const userRef = db.ref('users/' + currentUser);

    const [weeklyScoreSnap, userSnap] = await Promise.all([weeklyScoreRef.once('value'), userRef.once('value')]);
    
    const currentWeeklyScore = weeklyScoreSnap.val() || 0;
    const newTotalWeeklyScore = currentWeeklyScore + Math.max(0, clickCatchScore);
    const user = userSnap.val();

    logActivity('clickCatchSolo', currentUser, {
        score: clickCatchScore,
        specialItems: specialItemsWonLog,
        newWeeklyScore: newTotalWeeklyScore
    });
    
    const updates = {};
    updates[`clickCatchWeeklyScores/${currentUser}`] = newTotalWeeklyScore;
    updates[`users/${currentUser}/clickCatchHighestScore`] = newTotalWeeklyScore;
    updates[`users/${currentUser}/kutuHakki`] = (user.kutuHakki || 0) + collectedBoxRights;
    updates[`users/${currentUser}/iflasShieldUses`] = (user.iflasShieldUses || 0) + collectedIflasShields;
    updates[`users/${currentUser}/carkBileti`] = (user.carkBileti || 0) + collectedWheelTickets;
    
    // --- YENÄ° EKLENEN Ã‡ARPAN Ä°ÅLEME MANTIÄI BAÅLANGICI ---
    if(collectedMultipliers.length > 0){
        let currentUserMultiplier = user.activeMultiplier || 1;
        let currentUserUses = user.multiplierRemainingUses || 0;
        let currentUserSource = user.multiplierSource || 'none';

        for (const newMultiplier of collectedMultipliers) {
            if (currentUserSource === 'none') { // KullanÄ±cÄ±nÄ±n hiÃ§ Ã§arpanÄ± yoksa
                currentUserMultiplier = newMultiplier.value;
                currentUserUses = newMultiplier.uses;
                currentUserSource = 'store'; // T-Y'den gelenler maÄŸaza gibi davranÄ±r
            } else if (newMultiplier.value > currentUserMultiplier) { // Gelen Ã§arpan daha gÃ¼Ã§lÃ¼yse
                const kutuHakkiDonusum = currentUserUses || 0;
                updates[`users/${currentUser}/kutuHakki`] = (updates[`users/${currentUser}/kutuHakki`] || user.kutuHakki) + kutuHakkiDonusum;
                logActivity('multiplierUpgraded', currentUser, { oldValue: currentUserMultiplier, newValue: newMultiplier.value, boxRights: kutuHakkiDonusum });
                currentUserMultiplier = newMultiplier.value;
                currentUserUses = newMultiplier.uses;
            } else if (newMultiplier.value === currentUserMultiplier) { // Gelen Ã§arpan aynÄ±ysa
                currentUserUses += newMultiplier.uses;
                 logActivity('multiplierStacked', currentUser, { value: newMultiplier.value, uses: newMultiplier.uses });
            } else { // Mevcut Ã§arpan daha gÃ¼Ã§lÃ¼yse
                const kutuHakkiDonusum = newMultiplier.uses || 0;
                updates[`users/${currentUser}/kutuHakki`] = (updates[`users/${currentUser}/kutuHakki`] || user.kutuHakki) + kutuHakkiDonusum;
                logActivity('multiplierConvertedToBoxRights', currentUser, { rewardValue: newMultiplier.value, boxRights: kutuHakkiDonusum, keptMultiplierValue: currentUserMultiplier });
            }
        }
        updates[`users/${currentUser}/activeMultiplier`] = currentUserMultiplier;
        updates[`users/${currentUser}/multiplierRemainingUses`] = currentUserUses;
        updates[`users/${currentUser}/multiplierSource`] = currentUserSource;
    }
    // --- YENÄ° EKLENEN Ã‡ARPAN Ä°ÅLEME MANTIÄI SONU ---

    await db.ref().update(updates);
}
  // ... VE YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTIR
async function openSelectWinnerModal() {
    if (!isAdmin) return;

    const winnerInfoDiv = document.getElementById('winnerInfoForAdmin');
    winnerInfoDiv.innerHTML = '<p class="text-gray-400">Lider bilgisi yÃ¼kleniyor...</p>';
    
    const scoresSnap = await db.ref('clickCatchWeeklyScores').orderByValue().limitToLast(1).once('value');
    
    // --- DEÄÄ°ÅÄ°KLÄ°K BURADA ---
    // EÄŸer sÄ±ralama boÅŸsa (scoresSnap.exists() false ise)
    if (!scoresSnap.exists()) {
        // Ã–dÃ¼l penceresini aÃ§mak yerine genel bilgilendirme mesajÄ± gÃ¶ster
        displayMessage("Ã–dÃ¼l verilecek bir lider bulunamadÄ± Ã§Ã¼nkÃ¼ TÄ±kla-Yakala sÄ±ralamasÄ± ÅŸu anda boÅŸ.");
        // ve fonksiyonu burada bitir.
        return;
    }
    
    const scoresData = scoresSnap.val();
    const winnerUsername = Object.keys(scoresData)[0];
    const winnerScore = scoresData[winnerUsername];

    winnerInfoDiv.innerHTML = `
        <p>HaftanÄ±n Lideri: <b class="text-white text-lg">${winnerUsername}</b></p>
        <p>Toplam Skoru: <b class="text-yellow-300 text-lg">${winnerScore}</b></p>
    `;
    
    window.weeklyWinnerData = { username: winnerUsername, score: winnerScore };

    document.getElementById('selectWinnerPrizeModal').style.display = 'flex';
}

// Ã–dÃ¼l verme penceresini kapatÄ±r
function closeSelectWinnerModal() {
    document.getElementById('selectWinnerPrizeModal').style.display = 'none';
    window.weeklyWinnerData = null;
}

// ... VE YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTIR
async function confirmAndAwardPrize() {
    if (!isAdmin || !window.weeklyWinnerData) return;

    const { username, score } = window.weeklyWinnerData;
    const prizeType = document.getElementById('prizeType').value;
    const prizeAmount = parseInt(document.getElementById('prizeAmount').value);

    if (isNaN(prizeAmount) || prizeAmount <= 0) {
        displayMessage("LÃ¼tfen geÃ§erli bir Ã¶dÃ¼l miktarÄ± girin.");
        return;
    }

    const prizeNames = {
        boxRights: "Kutu HakkÄ±",
        points: "Puan",
        wheelTicket: "Ã‡ark Bileti",
        iflasShield: "Ä°flas KalkanÄ±"
    };
    const prizeName = prizeNames[prizeType];

    const confirmed = await customConfirm(
        `<b>${username}</b> adlÄ± kullanÄ±cÄ±ya <b>${prizeAmount} ${prizeName}</b> Ã¶dÃ¼lÃ¼ verilecek ve TÄ±kla-Yakala haftasÄ± sÄ±fÄ±rlanacak. OnaylÄ±yor musunuz?`
    );

    if (!confirmed) return;

    // --- YENÄ° ADIMLAR ---
    // Ã–nce o hafta oyuna katÄ±lan herkesi bulalÄ±m.
    const weeklyScoresSnap = await db.ref('clickCatchWeeklyScores').once('value');
    const participants = weeklyScoresSnap.exists() ? Object.keys(weeklyScoresSnap.val()) : [];
    // --- YENÄ° ADIMLAR BÄ°TÄ°Å ---

    // 1. KazananÄ±n bilgilerini kalÄ±cÄ± olarak kaydet
    const winnerDataToSave = {
        winnerName: username,
        winningScore: score,
        prizeAwarded: `${prizeAmount} ${prizeName}`,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    await db.ref('gameStats/weeklyClickCatchWinner').set(winnerDataToSave);

    // 2. Kazanan kullanÄ±cÄ±ya Ã¶dÃ¼lÃ¼nÃ¼ ver
    const winnerUserRef = db.ref(`users/${username}`);
    await winnerUserRef.transaction(user => {
        if (user) {
            if (prizeType === 'points') user.balance = (user.balance || 0) + prizeAmount;
            else if (prizeType === 'boxRights') user.kutuHakki = (user.kutuHakki || 0) + prizeAmount;
            else if (prizeType === 'wheelTicket') user.carkBileti = (user.carkBileti || 0) + prizeAmount;
            else if (prizeType === 'iflasShield') user.iflasShieldUses = (user.iflasShieldUses || 0) + prizeAmount;
        }
        return user;
    });

    // 3. HaftalÄ±k skor tablosunu sil
    await db.ref('clickCatchWeeklyScores').remove();

    // 4. TÃ¼m kullanÄ±cÄ±larÄ±n skorlarÄ±nÄ± ve BÄ°LET HEDÄ°YELERÄ°NÄ° gÃ¼ncelle
    const allUsersSnap = await db.ref('users').once('value');
    const allUsers = allUsersSnap.val();
    const updates = {};
    for (const u in allUsers) {
        // KiÅŸisel skoru sÄ±fÄ±rla (eÄŸer varsa)
        if (allUsers[u].clickCatchHighestScore) {
            updates[`/users/${u}/clickCatchHighestScore`] = 0;
        }
        // EÄŸer bu kullanÄ±cÄ± o hafta katÄ±lÄ±m gÃ¶sterdiyse +1 bilet hediye et
        if (participants.includes(u)) {
            const currentTickets = allUsers[u].clickCatchTickets || 0;
            updates[`/users/${u}/clickCatchTickets`] = currentTickets + 1;
        }
    }
    if (Object.keys(updates).length > 0) {
        await db.ref().update(updates);
    }
    
    // --- YENÄ° BÄ°LGÄ°LENDÄ°RME ADIMI ---
    // Global bir bildirim gÃ¶ndererek herkesi bilgilendir
    const notificationMessage = `TÄ±kla-Yakala haftasÄ±nÄ±n ÅŸampiyonu ${username} oldu! Kendisini tebrik ederiz. Yeni hafta baÅŸladÄ±!`;
    db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
    // --- YENÄ° BÄ°LGÄ°LENDÄ°RME BÄ°TÄ°Å ---


    displayMessage(`${username} Ã¶dÃ¼llendirildi ve TÄ±kla-Yakala haftasÄ± baÅŸarÄ±yla sÄ±fÄ±rlandÄ±! KatÄ±lÄ±mcÄ±lara +1 bilet hediye edildi.`);
    closeSelectWinnerModal();
}

// HaftanÄ±n kazananÄ± verisini dinler ve paneli gÃ¼nceller
function listenForWeeklyWinner() {
    const ref = db.ref('gameStats/weeklyClickCatchWinner');
    const container = document.getElementById('weeklyWinnerContainer');
    const infoDiv = document.getElementById('weeklyWinnerInfo');
    const clearBtn = document.getElementById('clearWeeklyWinnerBtn');

    const callback = snap => {
        const winnerData = snap.val();
        if (winnerData) {
            infoDiv.innerHTML = `
                <p>Kazanan: <b class="text-white">${winnerData.winnerName}</b></p>
                <p>Skor: <b class="text-white">${winnerData.winningScore}</b></p>
                <p>Ã–dÃ¼l: <b class="text-green-400">${winnerData.prizeAwarded}</b></p>
            `;
            container.classList.remove('hidden');
            if (isAdmin) {
                clearBtn.classList.remove('hidden');
            }
        } else {
            container.classList.add('hidden');
        }
    };
    
    // Listener'Ä± tekrar tekrar eklememek iÃ§in kontrol
    if (activeListeners.weeklyWinner) {
        activeListeners.weeklyWinner.ref.off('value', activeListeners.weeklyWinner.callback);
    }
    activeListeners.weeklyWinner = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// Adminin kazanan panelini kapatmasÄ±nÄ± saÄŸlar
async function clearWeeklyWinnerDisplay() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("HaftanÄ±n kazananÄ± panelini gizlemek istediÄŸinize emin misiniz? Bu iÅŸlem kazananÄ± veya Ã¶dÃ¼lÃ¼nÃ¼ silmez, sadece paneli gizler.");
    if (confirmed) {
        await db.ref('gameStats/weeklyClickCatchWinner').remove();
    }
}

// --- YENÄ° FONKSÄ°YONLAR BÄ°TÄ°Å ---

function initActivityFeed() {
    const activityBellContainer = document.getElementById('activityBellContainer');
    const activityCounter = document.getElementById('activityCounter');
    const activityFeedPanel = document.getElementById('activityFeedPanel');
    const activityFeedList = document.getElementById('activityFeedList');

    activityBellContainer.classList.remove('hidden');

    const userFeedStatusRef = db.ref(`users/${currentUser}/lastCheckedFeedTimestamp`);
    // initActivityFeed fonksiyonu iÃ§inde bu satÄ±rla deÄŸiÅŸtir:
const ref = db.ref('activityFeed').orderByChild('timestamp').limitToLast(20);

    const callback = async (snapshot) => {
        const feedData = snapshot.val();
        
        if (!feedData) {
            renderActivityFeed([]); 
            activityCounter.classList.add('hidden'); 
            return;
        }

        const userStatusSnap = await userFeedStatusRef.once('value');
        const lastChecked = userStatusSnap.val() || 0;
        
        let unreadCount = 0;
        
        const sortedActivities = Object.keys(feedData).map(key => {
            return { id: key, ...feedData[key] };
        }).sort((a, b) => b.timestamp - a.timestamp);

        sortedActivities.forEach(activity => {
            if (activity.timestamp > lastChecked) {
                unreadCount++;
            }
        });

        if (unreadCount > 0) {
            activityCounter.textContent = unreadCount > 9 ? '9+' : unreadCount;
            activityCounter.classList.remove('hidden');
        } else {
            activityCounter.classList.add('hidden');
        }
        
        renderActivityFeed(sortedActivities);
    };

    activeListeners.activityFeed = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// --- MEVCUT Ä°LGÄ°LÄ° FONKSÄ°YONLARI KOMPLE SÄ°LÄ°P BUNU YAPIÅTIR ---

function logActivity(type, username, details = {}) {
    // WeizendTv'nin kendi eylemlerini loglama (Ã¶rneÄŸin lobi iptali)
    if (username.toLowerCase() === 'weizendtv') {
        return;
    }
    const activityData = {
        type,
        username,
        details,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    const newActivityRef = db.ref('activityFeed').push();
    newActivityRef.set(activityData);

    const feedRef = db.ref('activityFeed');
    feedRef.orderByChild('timestamp').once('value', (snapshot) => {
        const totalCount = snapshot.numChildren();
        const limit = 20;

        if (totalCount > limit) {
            let itemsToDeleteCount = totalCount - limit;
            snapshot.forEach((childSnapshot) => {
                if (itemsToDeleteCount <= 0) {
                    return true; 
                }
                childSnapshot.ref.remove();
                itemsToDeleteCount--;
            });
        }
    });
}

function getActivityIcon(type, details = {}) {
    let icon = 'ğŸ””';
    let bgColor = 'bg-gray-500';

    switch (type) {
        case 'tradeOfferCreated':
            icon = 'ğŸ“¤';
            bgColor = 'bg-blue-500';
            break;
        case 'tradeOfferAccepted':
            icon = 'ğŸ¤';
            bgColor = 'bg-green-600';
            break;
        case 'openBox':
            icon = 'ğŸ’°';
            bgColor = 'bg-green-500';
            break;
        case 'surpriseBox':
            icon = 'ğŸ‰';
            bgColor = 'bg-yellow-500';
            break;
        case 'iflas':
            if (details.shieldUsed) {
                icon = 'ğŸ›¡ï¸';
                bgColor = 'bg-blue-500';
            } else if (details.multiplier && details.multiplier > 1) {
                icon = 'âŒ'; 
                bgColor = 'bg-red-800';
            } else {
                icon = 'ğŸ’£';
                bgColor = 'bg-red-600';
            }
            break;
        case 'kasaTransfer':
            icon = 'ğŸ¦';
            bgColor = 'bg-purple-600';
            break;
        case 'multiplierUpgraded':
            icon = 'â';
            bgColor = 'bg-teal-500';
            break;
        case 'multiplierFound':
        case 'multiplierRefund':
            icon = 'âœ–ï¸';
            bgColor = 'bg-purple-500';
            break;
        case 'multiplierCombined':
            icon = 'âœ¨';
            bgColor = 'bg-teal-500';
            break;
        case 'multiplierUpgradedFromStore':
        case 'multiplierStackedFromStore':
        case 'buyItem':
            icon = 'ğŸ›’';
            bgColor = 'bg-indigo-500';
            break;
        case 'multiplierDiscarded':
            icon = 'â';
            bgColor = 'bg-gray-600';
            break;
        case 'multiplierConvertedToBoxRights':
            icon = 'â™»ï¸';
            bgColor = 'bg-lime-600';
            break;
        case 'newItemFound':
            const itemType = details.itemType;
            if (itemType === 'card_pack_efsanevi') {
                icon = 'ğŸ†';
                bgColor = 'bg-purple-600';
            } else if (itemType === 'card_pack_altin') {
                icon = 'ğŸ¥‡';
                bgColor = 'bg-yellow-500';
            } else if (itemType === 'card_pack_gumus') {
                icon = 'ğŸ¥ˆ';
                bgColor = 'bg-gray-500';
            } else if (itemType === 'card_pack_normal') {
                icon = 'ğŸ¥‰';
                bgColor = 'bg-amber-600';
            } else if (itemType === 'card_pack') {
                icon = 'ğŸ´';
                bgColor = 'bg-indigo-500';
            } else if (itemType === 'wildcard') {
                icon = 'ğŸƒ';
                bgColor = 'bg-purple-500';
            } else if (itemType === 'iflasShield') {
                icon = 'ğŸ›¡ï¸';
                bgColor = 'bg-cyan-500';
            } else if (itemType === 'wheelTicket') {
                icon = 'ğŸ«';
                bgColor = 'bg-cyan-500';
            } else if (itemType === 'clickCatchTicket') {
                icon = 'ğŸŸï¸';
                bgColor = 'bg-cyan-500';
            } else {
                icon = 'ğŸ“¦';
                bgColor = 'bg-cyan-500';
            }
            break;
        case 'spinWheel':
            icon = 'ğŸ¡';
            bgColor = 'bg-pink-500';
            break;
        case 'lobbyJoined':
            icon = 'ğŸ®';
            bgColor = 'bg-blue-600';
            break;
        case 'clickCatchSolo':
        case 'clickCatchLobby':
            icon = 'ğŸ¯';
            bgColor = 'bg-orange-500';
            break;
        case 'dailyRewardMultiplierStacked':
            icon = 'ğŸ“…';
            bgColor = 'bg-teal-500';
            break;
        case 'dailyReward':
            if (details.rewardType === 'avatar') {
                icon = 'ğŸ‘¤';
                bgColor = 'bg-sky-500';
            } else if (details.rewardType === 'wildcard') {
                icon = 'ğŸƒ';
                bgColor = 'bg-purple-600';
            } else if (details.rewardType === 'card_pack') {
                icon = 'ğŸ´';
                bgColor = 'bg-indigo-600';
            } else {
                icon = 'ğŸ“…';
                bgColor = 'bg-teal-500';
            }
            break;
        case 'surpriseBoxTimeout':
            icon = 'â°';
            bgColor = 'bg-gray-600';
            break;
    }

    return `
        <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center ${bgColor} shadow-lg">
            <span class="text-2xl">${icon}</span>
        </div>
    `;
}

function renderActivityFeed(activities) {
    const activityFeedList = document.getElementById('activityFeedList');
    activityFeedList.innerHTML = '';

    if (isAdmin) {
        const clearButtonHtml = `
            <div class="px-2 mb-2 text-center">
                <button onclick="clearAllActivities()" class="w-full py-2 px-4 bg-red-800/50 hover:bg-red-700 text-white font-bold rounded-lg shadow-md text-sm border border-red-600">
                    Eylem GeÃ§miÅŸini Temizle
                </button>
            </div>
        `;
        activityFeedList.innerHTML += clearButtonHtml;
    }

    if (!activities || activities.length === 0) {
        activityFeedList.innerHTML += '<p class="text-center text-gray-400 p-4">GÃ¶sterilecek eylem bulunamadÄ±.</p>';
        return;
    }
    
    const typeToName = {
        points: 'Puan',
        boxRights: 'Kutu HakkÄ±',
        iflasShield: 'Ä°flas KalkanÄ±',
        wheelTicket: 'Ã‡ark Bileti',
        clickCatchTicket: 'TÄ±kla-Yakala Bileti',
        tempMultiplier: 'Ã‡arpan',
        wildcard: 'Joker Kart',
        card_pack: 'Kart Paketi'
    };

    activities.forEach(activity => {
        try {
            if (!activity || !activity.username || !activity.type) { 
                return; 
            }

            const details = activity.details || {};
            let iconHtml = getActivityIcon(activity.type, details);
            let message = '';
            const timeAgo = formatTimeAgo(activity.timestamp);
            const deleteButtonHtml = isAdmin ? `<button onclick="deleteActivity('${activity.id}')" class="ml-2 p-1 rounded-full text-gray-500 hover:text-red-500 hover:bg-white/10 transition-colors" title="Bu Eylemi Sil"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>` : '';
            const userHtml = `<b class="text-yellow-300 cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${activity.username}')">${activity.username}</b>`;

            const remainingBalanceText = (details.newBalance !== undefined && details.newBalance !== null) 
                ? ` <span class="text-gray-400">(Mevcut PuanÄ±: ${details.newBalance})</span>`
                : '';
            
            const weeklyScoreText = (details.newWeeklyScore !== undefined && details.newWeeklyScore !== null)
                ? ` <span class="text-gray-400">(Mevcut HaftalÄ±k Skor: ${details.newWeeklyScore})</span>`
                : '';

            switch (activity.type) {
                case 'multiplierUpgraded':
                    message = `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan <b class="text-yellow-400">${details.newValue}x Ã§arpan</b> buldu ve envanterinde bulunan ${details.remainingUses} adet ${details.oldValue}x Ã§arpan daha dÃ¼ÅŸÃ¼k olduÄŸu iÃ§in <b class="text-green-400">+${details.boxRights} kutu hakkÄ±na</b> dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼.`;
                    let multiplierUsedText = '';
                    if (details.multiplierUsed && details.multiplierUsed > 1) {
                        multiplierUsedText = ` <span class="text-gray-400">(${details.multiplierUsed}x Ã§arpan kullanÄ±ldÄ±)</span>`;
                    } else {
                        multiplierUsedText = ` <span class="text-gray-400">(Ã§arpan kullanmadÄ±)</span>`;
                    }
                    message += multiplierUsedText;
                    break;
                case 'dailyRewardMultiplierStacked':
                    message = `${userHtml},  <b>${details.multiplierValue}x Ã§arpanÄ±na</b> gÃ¼nlÃ¼k Ã¶dÃ¼lden <span class="text-green-300 font-bold">+${details.usesAdded} kullanÄ±m hakkÄ±</span> ekledi. Yeni toplam: <span class="text-white font-bold">${details.newTotalUses} kullanÄ±m</span>.`;
                    break;
                case 'multiplierConvertedToBoxRights':
                    message = `${userHtml}, mevcut <b>${details.keptMultiplierValue}x Ã§arpanÄ±nÄ±</b> koruyarak, gÃ¼nlÃ¼k Ã¶dÃ¼lden gelen ${details.rewardValue}x Ã§arpanÄ±nÄ± <span class="text-cyan-300 font-bold">+${details.boxRights} Kutu HakkÄ±'na</span> dÃ¶nÃ¼ÅŸtÃ¼rdÃ¼.`;
                    break;
                case 'kasaTransfer':
                    const newKasaBalanceText = (details.newKasaBalance !== undefined && details.newKasaBalance !== null) 
                        ? ` <span class="text-gray-400">(Yeni Kasa PuanÄ±: ${details.newKasaBalance})</span>`
                        : '';
                    message = `${userHtml}, <span class="text-green-300 font-bold">${details.amount} Puan</span>'Ä± kasasÄ±na aktardÄ±.${newKasaBalanceText}`;
                    break;
                case 'multiplierStackedFromStore':
                    message = `${userHtml}, maÄŸazadan <span class="text-red-400 font-bold">-${details.cost} Puan</span> harcayarak <b>${details.multiplierValue}x Ã§arpanÄ±na</b> <span class="text-green-300 font-bold">+${details.usesAdded} kullanÄ±m hakkÄ±</span> ekledi ve toplam <span class="text-green-300 font-bold">${details.newTotalUses} kullanÄ±m hakkÄ±</span> oldu. <span class="text-gray-400">(HesabÄ±nda ${details.newBalance} puanÄ± kaldÄ±.)</span>`;
                    break;
                case 'multiplierStacked':
                    message = `${userHtml}, mevcut <b>${details.value}x</b> Ã§arpanÄ±na <span class="text-green-300 font-bold">+${details.uses} kullanÄ±m hakkÄ±</span> ekledi.`;
                    break;
                case 'multiplierUpgradedFromStore':
                    message = `${userHtml}, maÄŸazadan yaptÄ±ÄŸÄ± alÄ±mla eski ${details.oldValue}x Ã§arpanÄ±nÄ± <span class="text-cyan-300 font-bold">${details.boxRights} Kutu HakkÄ±'na</span> dÃ¶nÃ¼ÅŸtÃ¼rdÃ¼ ve yeni <b>${details.newValue}x</b> Ã§arpanÄ±na geÃ§ti.`;
                    break;
                case 'multiplierDiscarded':
                    message = `${userHtml}, kutudan ${details.discardedValue}x Ã§arpan buldu ancak mevcut <b>${details.keptValue}x</b> Ã§arpanÄ± daha gÃ¼Ã§lÃ¼ olduÄŸu iÃ§in korundu.`;
                    break;
                case 'openBox':
                    let openBoxMultiplierText = (details.multiplier && details.multiplier > 1)
                        ? ` <span class="text-xs text-purple-400">(${details.multiplier}x Ã§arpan kullandÄ±)</span>`
                        : ` <span class="text-xs text-gray-400">(Ã§arpan kullanmadÄ±)</span>`;
                    message = `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan <span class="text-green-300 font-bold">+${details.points} Puan</span> kazandÄ±.${openBoxMultiplierText}${remainingBalanceText}`;
                    break;
                case 'iflas':
                    let iflasMultiplierText = (details.multiplier && details.multiplier > 1)
                        ? ` <span class="text-xs text-purple-400">(${details.multiplier}x Ã§arpan kullandÄ±)</span>`
                        : ` <span class="text-xs text-gray-400">(Ã§arpan kullanmadÄ±)</span>`;
                    message = details.shieldUsed 
                        ? `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan bomba buldu ama kalkanÄ± korudu.${iflasMultiplierText}`
                        : `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan <span class="text-red-400 font-bold">-${details.lostPoints} Puan</span> kaybetti.${iflasMultiplierText}${remainingBalanceText}`;
                    break;
                case 'surpriseBox':
                    let surpriseMultiplierText = (details.multiplier && details.multiplier > 1)
                        ? ` <span class="text-xs text-purple-400">(${details.multiplier}x Ã§arpan kullandÄ±)</span>`
                        : ` <span class="text-xs text-gray-400">(Ã§arpan kullanmadÄ±)</span>`;
                    const source = details.boxId === 'Ã‡ark' ? 'Åans Ã‡arkÄ±\'ndan' : `<b>${details.boxId}</b> numaralÄ± kutudan`;
                    message = `${userHtml}, ${source} SÃ¼rpriz Kutu buldu ve <span class="text-green-300 font-bold">+${details.points} Puan</span> kazandÄ±!${surpriseMultiplierText}${remainingBalanceText}`;
                    break;
                case 'multiplierFound':
                    message = `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan <span class="text-purple-300 font-bold">${details.value}x Ã‡arpan</span> buldu.`;
                    break;
                case 'multiplierRefund':
                     message = `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan <span class="text-purple-300 font-bold">${details.newMultiplier}x Ã‡arpan</span> buldu ve maÄŸaza Ã§arpanÄ± iade edildi.`;
                    break;
                case 'newItemFound':
                     let newItemMultiplierText = (details.multiplier && details.multiplier > 1)
                        ? ` <span class="text-xs text-purple-400">(${details.multiplier}x Ã§arpan kullandÄ±)</span>`
                        : ` <span class="text-xs text-gray-400">(Ã§arpan kullanmadÄ±)</span>`;
                    message = `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan <span class="text-cyan-300 font-bold">${details.itemName}</span> buldu.${newItemMultiplierText}`;
                    break;
                case 'buyItem':
                    let purchasedItemText = '';
                    if (details.itemType === 'tempMultiplier') {
                        purchasedItemText = `<span class="text-indigo-300 font-bold">${details.itemDuration} Adet ${details.itemValue}x Ã‡arpan</span>`;
                    } else if (details.itemValue) {
                        const itemName = typeToName[details.itemType] || details.itemName;
                        purchasedItemText = `<span class="text-indigo-300 font-bold">+${details.itemValue} ${itemName}</span>`;
                    } else {
                        purchasedItemText = `<span class="text-indigo-300 font-bold">${details.itemName}</span>`;
                    }
                    message = `${userHtml}, maÄŸazadan <span class="text-red-400 font-bold">-${details.itemCost} Puan</span> harcayarak ${purchasedItemText} aldÄ±.${remainingBalanceText}`;
                    break;
                case 'lobbyJoined':
                    message = `${userHtml}, TÄ±kla-Yakala lobisine <span class="text-red-400 font-bold">-${details.cost} Puan</span> karÅŸÄ±lÄ±ÄŸÄ±nda katÄ±ldÄ±.${remainingBalanceText}`;
                    break;
                case 'spinWheel':
                    let prizeText = '';
                    const prizeType = details.type;
                    const prizeValue = details.value;

                    if (prizeType === 'pas') {
                        message = `${userHtml}, Ã§arkÄ± Ã§evirdi ve <span class="text-gray-400 font-bold">Pas</span> geÃ§ti.`;
                    } else {
                        if (prizeType === 'points') {
                            prizeText = `+${prizeValue} Puan`;
                        } else if (prizeType === 'tempMultiplier') {
                            prizeText = `${prizeValue}X Ã‡arpan`;
                        } else {
                            prizeText = `+${prizeValue} ${typeToName[prizeType] || prizeType}`;
                        }
                        message = `${userHtml}, Ã§arkÄ± Ã§evirerek <span class="text-pink-300 font-bold">${prizeText}</span> kazandÄ±.${remainingBalanceText}`;
                    }
                    break;
                case 'clickCatchSolo':
                    if (details.score > 0) {
                        message = `${userHtml}, TÄ±kla-Yakala oynadÄ± ve <span class="text-green-300 font-bold">+${details.score} Skor</span> topladÄ±.${weeklyScoreText}`;
                    } else if (details.score < 0) {
                        message = `${userHtml}, TÄ±kla-Yakala oynadÄ± ve <span class="text-red-400 font-bold">${details.score} Skor</span> kaybetti.${weeklyScoreText}`;
                    } else {
                        message = `${userHtml}, TÄ±kla-Yakala oynadÄ± ancak skor toplayamadÄ±.${weeklyScoreText}`;
                    }

                    if (details.specialItems && details.specialItems.length > 0) {
                        message += ` AyrÄ±ca, <span class="text-cyan-300 font-bold">${details.specialItems.join(', ')}</span> kazandÄ±.`;
                    }
                    break;
                case 'clickCatchLobby':
                    message = `${userHtml}, lobi oyununu kazanarak <span class="text-yellow-300 font-bold">+${details.prize} Puan</span> Ã¶dÃ¼l aldÄ±!${remainingBalanceText}`;
                    break;
                case 'dailyReward':
                    let rewardText = '';
                    const rewardType = details.rewardType;
                    const rewardValue = details.rewardValue;
                    
                    if (rewardType === 'avatar') {
                        rewardText = `<span class="text-sky-300 font-bold">'${details.rewardName}' avatarÄ±nÄ±</span>`;
                        message = `${userHtml}, gÃ¼nlÃ¼k Ã¶dÃ¼l olarak ${rewardText} kazandÄ±.`;
                    } 
                    else {
                        if (rewardType === 'points') {
                            rewardText = `+${rewardValue} Puan`;
                        } else if (rewardType === 'tempMultiplier') {
                            rewardText = `${details.rewardUses} adet ${rewardValue}x Ã‡arpan`;
                        } else {
                            rewardText = `+${rewardValue} ${typeToName[rewardType] || details.rewardName}`;
                        }
                        message = `${userHtml}, gÃ¼nlÃ¼k Ã¶dÃ¼l olarak <span class="text-teal-300 font-bold">${rewardText}</span> aldÄ±.${remainingBalanceText}`;
                    }
                    break;
                case 'surpriseBoxTimeout':
                    message = `${userHtml}, SÃ¼rpriz Kutu ÅŸansÄ±nÄ± sÃ¼re dolduÄŸu iÃ§in kaÃ§Ä±rdÄ±.`;
                    break;
                default:
                    message = `${userHtml} bir eylem gerÃ§ekleÅŸtirdi. (Tip: ${activity.type})`;
                    break;
            }

            const activityHtml = `
                <div class="bg-gray-800/70 p-3 rounded-xl flex items-center gap-4 border border-transparent hover:border-gray-700 transition-all duration-200">
                    ${iconHtml}
                    <div class="flex-1 min-w-0">
                        <p class="text-gray-200 text-sm leading-relaxed">${message}</p>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500">${timeAgo}</span>
                            ${deleteButtonHtml}
                        </div>
                    </div>
                </div>`;
            
            activityFeedList.innerHTML += activityHtml;
        } catch (error) {
            console.error("Bir aktivite iÅŸlenirken hata oluÅŸtu, bu eylem atlandÄ±:", error);
            console.error("HatalÄ± aktivite verisi:", activity);
        }
    });
}

function initActivityFeed() {
    const activityBellContainer = document.getElementById('activityBellContainer');
    const activityCounter = document.getElementById('activityCounter');
    
    activityBellContainer.classList.remove('hidden');

    const userFeedStatusRef = db.ref(`users/${currentUser}/lastCheckedFeedTimestamp`);
    const ref = db.ref('activityFeed').orderByChild('timestamp').limitToLast(20);

    const callback = async (snapshot) => {
        const feedData = snapshot.val();
        
        if (!feedData) {
            renderActivityFeed([]); 
            activityCounter.classList.add('hidden'); 
            return;
        }

        const userStatusSnap = await userFeedStatusRef.once('value');
        const lastChecked = userStatusSnap.val() || 0;
        
        let unreadCount = 0;
        
        const sortedActivities = Object.keys(feedData).map(key => {
            return { id: key, ...feedData[key] };
        }).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        sortedActivities.forEach(activity => {
            if (activity.timestamp > lastChecked) {
                unreadCount++;
            }
        });

        if (unreadCount > 0) {
            activityCounter.textContent = unreadCount > 9 ? '9+' : unreadCount;
            activityCounter.classList.remove('hidden');
        } else {
            activityCounter.classList.add('hidden');
        }
        
        renderActivityFeed(sortedActivities);
    };

    activeListeners.activityFeed = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// ...VE YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTIR
function openActivityFeed() {
    const activityFeedPanel = document.getElementById('activityFeedPanel'); // EKLENEN SATIR
    const activityCounter = document.getElementById('activityCounter');   // EKLENEN SATIR
    activityFeedPanel.classList.remove('hidden');
    setTimeout(() => {
        activityFeedPanel.classList.remove('translate-x-full');
    }, 10);
    activityCounter.classList.add('hidden');
    db.ref(`users/${currentUser}/lastCheckedFeedTimestamp`).set(Date.now());
}

function closeActivityFeed() {
    const activityFeedPanel = document.getElementById('activityFeedPanel'); // EKLENEN SATIR
    activityFeedPanel.classList.add('translate-x-full');
    setTimeout(() => {
        activityFeedPanel.classList.add('hidden');
    }, 300);
}

function toggleActivityFeed() {
    const activityFeedPanel = document.getElementById('activityFeedPanel'); // EKLENEN SATIR
    if (activityFeedPanel.classList.contains('hidden')) {
        openActivityFeed();
    } else {
        closeActivityFeed();
    }
}

async function deleteActivity(activityId) {
    if (!isAdmin || !activityId) return;
    const confirmed = await customConfirm("Bu eylemi kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?");
    if (confirmed) {
        await db.ref('activityFeed/' + activityId).remove();
    }
}

async function clearAllActivities() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("TÃ¼m eylem geÃ§miÅŸini kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!");
    if (confirmed) {
        await db.ref('activityFeed').remove();
        renderActivityFeed([]);
    }
}

function formatTimeAgo(timestamp) {
    const now = getSyncedTime();
    const seconds = Math.floor((now - timestamp) / 1000);

    if (seconds < 60) {
        return `az Ã¶nce`;
    }
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) {
        return `${minutes} dakika Ã¶nce`;
    }
    const hours = Math.floor(minutes / 60);
    if (hours < 24) {
        return `${hours} saat Ã¶nce`;
    }
    const days = Math.floor(hours / 24);
    if (days < 7) {
        return `${days} gÃ¼n Ã¶nce`;
    }
    
    return new Date(timestamp).toLocaleDateString('tr-TR');
}

// "Adet" inputlarÄ±ndan biri her deÄŸiÅŸtiÄŸinde toplam kutu sayÄ±sÄ±nÄ± hesaplar ve gÃ¶sterir.
function updateTotalBoxCount() {
    let total = 0;
    document.querySelectorAll('.box-setting-row .setting-count').forEach(input => {
        const count = parseInt(input.value);
        if (!isNaN(count) && count > 0) {
            total += count;
        }
    });
    document.getElementById('totalBoxCountDisplay').textContent = total;
}

// TÃ¼m satÄ±rlardaki verileri okur, yeni ayarlarÄ± veritabanÄ±na kaydeder ve oyunu sÄ±fÄ±rlar.
async function saveBoxSettings() {
    if (!isAdmin) return;

    const newConfig = [];
    let totalBoxes = 0;
    let hasError = false;

    document.querySelectorAll('.box-setting-row').forEach(row => {
        const type = row.querySelector('.setting-type').value;
        const value = parseInt(row.querySelector('.setting-value').value);
        const count = parseInt(row.querySelector('.setting-count').value);

        // DoÄŸrulama: Adet ve DeÄŸer alanlarÄ± geÃ§erli mi?
        if (isNaN(count) || count <= 0) {
            // Adet girilmemiÅŸse bu satÄ±rÄ± atla
            return;
        }
        if (isNaN(value) && (type === 'points' || type === 'multiplier')) {
            displayMessage(`Hata: ${type} tÃ¼rÃ¼ iÃ§in geÃ§erli bir 'DeÄŸer' girmelisiniz.`);
            hasError = true;
            return;
        }
        
        newConfig.push({ type, value, count });
        totalBoxes += count;
    });

    if (hasError) return; // Hata varsa iÅŸlemi durdur

    if (totalBoxes === 0) {
        displayMessage("En az bir kutu tÃ¼rÃ¼ iÃ§in adet girmelisiniz!");
        return;
    }

    const confirmed = await customConfirm(`Toplam ${totalBoxes} kutu ile yeni bir oyun baÅŸlatÄ±lacak. Mevcut oyun sÄ±fÄ±rlanacak. OnaylÄ±yor musunuz?`);
    if (confirmed) {
        await db.ref('gameConfig/boxContents').set(newConfig);
        await resetGameBoard(); 
        displayMessage("Kutu ayarlarÄ± baÅŸarÄ±yla kaydedildi ve oyun yeni ayarlarla yeniden baÅŸlatÄ±ldÄ±!");
        closeBoxSettingsModal();
    }
}

    // YENÄ°: Kutu ayarlarÄ±nÄ± kodda tanÄ±mlÄ± olan varsayÄ±lan deÄŸerlere dÃ¶ndÃ¼rÃ¼r.
async function resetBoxSettingsToDefault() {
    if (!isAdmin) return;
    
    const confirmed = await customConfirm("Mevcut ayarlarÄ± silip varsayÄ±lan kutu yapÄ±landÄ±rmasÄ±na dÃ¶nmek istediÄŸinize emin misiniz? <br><small>(Bu iÅŸlem, siz 'Kaydet' butonuna basana kadar kalÄ±cÄ± olmayacaktÄ±r.)</small>");
    if (!confirmed) return;

    const container = document.getElementById('boxSettingsRowsContainer');
    container.innerHTML = ''; // Paneli temizle

    // Script'in en baÅŸÄ±nda tanÄ±mlÄ± olan varsayÄ±lan BOX_CONTENTS listesini kullan
    BOX_CONTENTS.forEach(item => {
        addBoxSettingRow(item);
    });

    updateTotalBoxCount(); // Toplam kutu sayÄ±sÄ±nÄ± gÃ¼ncelle
}

    // Ã‡ark AyarlarÄ±nÄ± veritabanÄ±ndan YÃœKLEYEN ve sÄ±ralayan fonksiyon
async function loadWheelSettingsFromDB() {
    const settingsRef = db.ref('gameConfig/wheelSegments');
    const snapshot = await settingsRef.once('value');
    
    if (snapshot.exists() && snapshot.val() !== null) {
        const loadedData = snapshot.val();
        
        if (Array.isArray(loadedData)) {
            wheelSegments = loadedData.filter(item => item).sort((a, b) => (a.order || 0) - (b.order || 0));
        } else {
            wheelSegments = Object.values(loadedData).sort((a, b) => (a.order || 0) - (b.order || 0));
        }
    } else {
        // Firebase'de ayar yoksa varsayÄ±lanÄ± kullan
        wheelSegments = defaultWheelSegments;
    }
    
    renderWheel();
}
function openWheelSettingsModal() {
    if (!isAdmin) return;
    const container = document.getElementById('wheelSettingsRowsContainer');
    container.innerHTML = '';
    wheelSegments.forEach(item => addWheelSettingRow(item));
    wheelSettingsModal.style.display = 'flex';
}

function closeWheelSettingsModal() {
    wheelSettingsModal.style.display = 'none';
}

// MEVCUT addWheelSettingRow FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR

// Ã‡ark AyarlarÄ± iÃ§in yeni satÄ±r ekler
function addWheelSettingRow(item = {}) {
    const container = document.getElementById('wheelSettingsRowsContainer');
    const row = document.createElement('div');
    row.className = 'wheel-setting-row grid grid-cols-1 sm:grid-cols-7 items-center gap-3 p-3 bg-gray-900 rounded-lg';

    const type = item.type || 'points';
    const value = item.value || '';
    const duration = item.duration || '';
    const label = item.label || '';
    const imageUrl = item.imageUrl || '';
    const color = item.color || '#f44336';
    const weight = item.weight || 10;

    row.innerHTML = `
        <select class="setting-type col-span-1 bg-gray-700 p-2 rounded-md text-white border border-gray-600" onchange="handleWheelRowTypeChange(this)">
            <option value="points" ${type === 'points' ? 'selected' : ''}>Puan</option>
            <option value="boxRights" ${type === 'boxRights' ? 'selected' : ''}>Kutu HakkÄ±</option>
            <option value="iflasShield" ${type === 'iflasShield' ? 'selected' : ''}>Ä°flas Kalkan</option>
            <option value="tempMultiplier" ${type === 'tempMultiplier' ? 'selected' : ''}>Ã‡arpan</option>
            <option value="surpriseBox" ${type === 'surpriseBox' ? 'selected' : ''}>SÃ¼rpriz Kutu</option>
            <option value="clickCatchTicket" ${type === 'clickCatchTicket' ? 'selected' : ''}>T-Y Bileti</option>
            <option value="wheelTicket" ${type === 'wheelTicket' ? 'selected' : ''}>Ã‡ark Bileti</option>
            <option value="wildcard" ${type === 'wildcard' ? 'selected' : ''}>Joker Kart</option>
            <option value="card_pack" ${type === 'card_pack' ? 'selected' : ''}>Standart Kart Paketi</option>
            <option value="card_pack_normal" ${type === 'card_pack_normal' ? 'selected' : ''}>Bronz Kart Paketi</option>
            <option value="card_pack_gumus" ${type === 'card_pack_gumus' ? 'selected' : ''}>GÃ¼mÃ¼ÅŸ Kart Paketi</option>
            <option value="card_pack_altin" ${type === 'card_pack_altin' ? 'selected' : ''}>AltÄ±n Kart Paketi</option>
            <option value="card_pack_efsanevi" ${type === 'card_pack_efsanevi' ? 'selected' : ''}>Efsanevi Kart Paketi</option>
            <option value="pas" ${type === 'pas' ? 'selected' : ''}>Pas</option>
        </select>
        <input type="text" value="${label}" class="setting-label col-span-1 sm:col-span-2 bg-gray-700 p-2 rounded-md text-white" placeholder="Etiket (Ã–rn: JOKER!)">
        <input type="text" value="${imageUrl}" class="setting-image-url col-span-1 sm:col-span-2 bg-gray-700 p-2 rounded-md text-white" placeholder="Resim URL (Opsiyonel)">
        <input type="number" value="${value}" class="setting-value bg-gray-700 p-2 rounded-md text-white" placeholder="DeÄŸer">
        <input type="number" value="${duration}" class="setting-duration bg-gray-700 p-2 rounded-md text-white" placeholder="SÃ¼re/KullanÄ±m">
        <div class="col-span-1 flex items-center gap-2">
            <input type="color" value="${color}" class="setting-color h-10 w-10 p-1 bg-gray-700 rounded-md">
            <input type="number" value="${weight}" class="setting-weight flex-grow bg-gray-700 p-2 rounded-md text-white" placeholder="Åans">
            <button class="bg-red-700 hover:bg-red-600 text-white p-2 rounded-md" onclick="this.parentElement.parentElement.remove();">Sil</button>
        </div>
    `;
    container.appendChild(row);
    handleWheelRowTypeChange(row.querySelector('.setting-type'));
}
    
// Ã‡ark AyarlarÄ±'nda seÃ§ilen tÃ¼re gÃ¶re "DeÄŸer" ve "SÃ¼re" alanlarÄ±nÄ± yÃ¶netir
function handleWheelRowTypeChange(selectElement) {
    const row = selectElement.closest('.wheel-setting-row');
    const valueInput = row.querySelector('.setting-value');
    const durationInput = row.querySelector('.setting-duration');
    const selectedType = selectElement.value;

    valueInput.disabled = false;
    durationInput.disabled = true;
    durationInput.value = ''; // SÃ¼reyi temizle

    if (selectedType === 'pas' || selectedType === 'surpriseBox') {
        valueInput.disabled = true;
        valueInput.value = ''; // DeÄŸeri temizle
    } else if (selectedType === 'tempMultiplier') {
        durationInput.disabled = false;
    } else if (selectedType === 'wildcard' || selectedType === 'card_pack') { // YENÄ° EKLENDÄ°
        valueInput.disabled = false;
        valueInput.value = 1; // DeÄŸeri otomatik 1 yap
    }
}

async function saveWheelSettings() {
    if (!isAdmin) return;

    const newConfig = [];
    let hasError = false;
    document.querySelectorAll('.wheel-setting-row').forEach((row, index) => {
        if(hasError) return;
        
        const type = row.querySelector('.setting-type').value;
        const label = row.querySelector('.setting-label').value.trim();
        const imageUrl = row.querySelector('.setting-image-url').value.trim(); // YENÄ°: Resim URL'i okunuyor
        const value = parseInt(row.querySelector('.setting-value').value) || 0;
        const duration = parseInt(row.querySelector('.setting-duration').value) || 0;
        const color = row.querySelector('.setting-color').value;
        const weight = parseInt(row.querySelector('.setting-weight').value);

        if (!label || !color || isNaN(weight) || weight <= 0) {
            displayMessage("Her dilim iÃ§in Etiket, Renk ve geÃ§erli bir Åans AÄŸÄ±rlÄ±ÄŸÄ± girmelisiniz.");
            hasError = true;
        }

        const segment = { type, label, imageUrl, color, weight, order: index }; // YENÄ°: imageUrl veriye eklendi
        if (!row.querySelector('.setting-value').disabled) segment.value = value;
        if (!row.querySelector('.setting-duration').disabled) segment.duration = duration;
        
        newConfig.push(segment);
    });

    if (hasError) return;
    
    if (newConfig.length === 0) {
        displayMessage("Ã‡arkta en az bir dilim olmalÄ±dÄ±r.");
        return;
    }

    const confirmed = await customConfirm("Yeni Ã§ark ayarlarÄ± kaydedilecek. OnaylÄ±yor musunuz?");
    if (confirmed) {
        await db.ref('gameConfig/wheelSegments').set(newConfig);
        await loadWheelSettingsFromDB();
        displayMessage("Åans Ã‡arkÄ± ayarlarÄ± baÅŸarÄ±yla kaydedildi.");
        closeWheelSettingsModal();
    }
}
    
async function resetWheelSettingsToDefault() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Mevcut ayarlarÄ± silip varsayÄ±lan Ã§ark yapÄ±landÄ±rmasÄ±na dÃ¶nmek istediÄŸinize emin misiniz? (DeÄŸiÅŸiklikleri kalÄ±cÄ± yapmak iÃ§in kaydetmeniz gerekir.)");
    if (!confirmed) return;
    const container = document.getElementById('wheelSettingsRowsContainer');
    container.innerHTML = '';
    defaultWheelSegments.forEach(item => addWheelSettingRow(item));
}

function loadWheelHistory() {
    const historyRef = db.ref('wheelHistory').limitToLast(10);
    const listEl = document.getElementById('wheelHistoryList');
    
    const callback = (snapshot) => {
        listEl.innerHTML = ''; 

        if (isAdmin) {
            listEl.innerHTML += `<div class="p-1 mb-2 text-center"><button onclick="clearWheelHistory()" class="w-full py-2 px-4 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg shadow-md text-sm">TÃ¼m Kazanan GeÃ§miÅŸini Temizle</button></div>`;
        }

        if (!snapshot.exists()) {
            listEl.innerHTML += '<p class="text-center text-gray-500">HenÃ¼z Ã§ark Ã§evrilmedi.</p>';
            return;
        }
        
        const history = [];
        snapshot.forEach(child => { history.push({ key: child.key, ...child.val() }); });
        history.reverse();

        history.forEach(item => {
            const timeAgo = formatTimeAgo(item.timestamp);
            
            let icon = 'â“';
            let prizeText = item.prize;
            const prizeType = item.type;
            const prizeValue = item.value;

            // YENÄ° Ä°KON MANTIÄI BURADA
            if (prizeType === 'points') {
                if (prizeValue >= 1000) icon = 'ğŸ‚';
                else if (prizeValue >= 250) icon = 'ğŸ';
                else if (prizeValue >= 100) icon = 'ğŸŒ';
                else icon = 'ğŸ†';
                prizeText = `+${prizeValue} PUAN`; 
            } else if (prizeType === 'surpriseBox') {
                icon = 'ğŸ‰';
                prizeText = 'SÃœRPRÄ°Z KUTU';
            } else if (prizeType === 'boxRights') {
                icon = prizeValue > 1 ? 'ğŸ' : 'ğŸ“¦';
                prizeText = `+${prizeValue} Kutu HakkÄ±`;
            } else if (prizeType === 'clickCatchTicket') {
                icon = 'ğŸŸï¸';
                prizeText = `+${prizeValue} TÄ±kla-Yakala Bileti`;
            } else if (prizeType === 'wheelTicket') {
                icon = 'ğŸ¡';
                prizeText = `+${prizeValue} Ã‡ark Bileti`;
            } else if (prizeType === 'tempMultiplier') {
                icon = 'âœ–ï¸';
                prizeText = `${prizeValue}X Ã‡ARPAN`;
            } else if (prizeType === 'iflasShield') {
                icon = 'ğŸ›¡ï¸';
                prizeText = `+${prizeValue} Ä°flas KalkanÄ±`;
            // YENÄ° EKLENEN KOD BAÅLANGICI
            } else if (prizeType === 'wildcard') {
                icon = 'ğŸƒ';
                prizeText = `+${prizeValue} Joker Kart`;
            } else if (prizeType === 'card_pack') {
                icon = 'ğŸ´';
                prizeText = `+${prizeValue} Kart Paketi`;
            // YENÄ° EKLENEN KOD SONU
            } else if (prizeType === 'pas') {
                icon = 'â˜ ï¸';
                prizeText = 'PAS';
            }
            
            const deleteButton = isAdmin 
                ? `<button onclick="deleteWheelHistoryEntry('${item.key}')" class="ml-3 text-gray-500 hover:text-red-500 transition-colors" title="Bu KaydÄ± Sil">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                   </button>` 
                : '';

            listEl.innerHTML += `
                <div class="p-2 bg-gray-800 rounded-md mb-2 text-sm flex justify-between items-center">
                    <span class="flex items-center">
                        <b>${item.username}:</b> 
                        <span class="text-yellow-200 ml-2 flex items-center gap-2">
                            <span>${prizeText}</span>
                            <span class="text-lg">${icon}</span>
                        </span>
                    </span>
                    <div class="flex items-center">
                        <span class="text-gray-500 text-xs">${timeAgo}</span>
                        ${deleteButton}
                    </div>
                </div>
            `;
        });
    };

    if (activeListeners.wheelHistory) {
      historyRef.off('value', activeListeners.wheelHistory.callback);
    }
    activeListeners.wheelHistory = { ref: historyRef, event: 'value', callback };
    historyRef.on('value', callback);
}

  function openHelpModal() {
  helpModal.style.display = 'flex';
}

function closeHelpModal() {
  helpModal.style.display = 'none';
}

  function closeAvatarSelectionModal() {
        avatarSelectionModal.style.display = 'none';
    }

    async function openAvatarSelectionModal() {
        closeInventoryModal(); // Ã–nce envanter penceresini kapat
        avatarSelectionModal.style.display = 'flex';
        const avatarGrid = document.getElementById('avatarGrid');
        avatarGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">YÃ¼kleniyor...</p>';

        const userRef = db.ref('users/' + currentUser);
        const userSnap = await userRef.once('value');
        const userData = userSnap.val();
        
        const purchasedAvatars = userData.avatars || {};
        const selectedAvatarId = userData.selectedAvatar ? userData.selectedAvatar.id : null;

        if (Object.keys(purchasedAvatars).length === 0) {
            avatarGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">HenÃ¼z satÄ±n alÄ±nmÄ±ÅŸ bir avatarÄ±nÄ±z yok. MaÄŸazayÄ± ziyaret edin!</p>';
            return;
        }

        avatarGrid.innerHTML = ''; // Temizle
        for (const itemId in purchasedAvatars) {
            const avatar = purchasedAvatars[itemId];
            const isSelected = selectedAvatarId === itemId;
            
            const avatarCard = document.createElement('div');
            avatarCard.className = `relative p-2 rounded-lg cursor-pointer transition-all duration-200 ${isSelected ? 'bg-blue-500 ring-4 ring-blue-300' : 'bg-gray-700 hover:bg-gray-600'}`;
            avatarCard.onclick = () => selectAvatar(itemId, avatar.imageUrl);
            
            avatarCard.innerHTML = `
                <img src="${avatar.imageUrl}" alt="${avatar.name}" class="w-full h-auto rounded-md object-cover aspect-square">
                <p class="text-xs mt-2 text-white truncate">${avatar.name}</p>
                ${isSelected ? '<div class="absolute top-1 right-1 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">âœ“</div>' : ''}
            `;
            avatarGrid.appendChild(avatarCard);
        }
    }

    async function selectAvatar(itemId, imageUrl) {
    if (isAdmin) return;
    const userRef = db.ref('users/' + currentUser);
    const avatarData = {
        id: itemId,
        url: imageUrl
    };
    await userRef.child('selectedAvatar').set(avatarData);

    document.getElementById('currentUserAvatar').src = imageUrl;

    displayMessage("Avatar baÅŸarÄ±yla seÃ§ildi!");
    closeAvatarSelectionModal();
}

// ModalÄ± aÃ§ar, veritabanÄ±ndan ayarlarÄ± Ã§eker ve satÄ±rlarÄ± oluÅŸturur.
async function openBoxSettingsModal() {
    if (!isAdmin) return;

    const container = document.getElementById('boxSettingsRowsContainer');
    container.innerHTML = ''; // Ã–nceki satÄ±rlarÄ± temizle

    const settingsRef = db.ref('gameConfig/boxContents');
    const snapshot = await settingsRef.once('value');

    // EÄŸer veritabanÄ±nda hiÃ§ ayar yoksa kullanÄ±lacak varsayÄ±lan ayarlar.
    const defaultSettings = [ 
        { type: 'points', value: 100, count: 10 }, 
        { type: 'iflas', value: 0, count: 2 }, 
        { type: 'iflasShield', value: 1, count: 2 },
        { type: 'surpriz', value: 0, count: 1 } 
    ];
    const currentConfig = snapshot.exists() ? snapshot.val() : defaultSettings;

    if (currentConfig && currentConfig.length > 0) {
        currentConfig.forEach(item => addBoxSettingRow(item));
    } else {
        addBoxSettingRow(); // EÄŸer hiÃ§ ayar yoksa boÅŸ bir satÄ±rla baÅŸlat
    }
    
    updateTotalBoxCount(); // Toplam sayÄ±yÄ± ilk aÃ§Ä±lÄ±ÅŸta hesapla
    boxSettingsModal.style.display = 'flex';
}

// ModalÄ± kapatÄ±r.
function closeBoxSettingsModal() {
    boxSettingsModal.style.display = 'none';
}

// Bir satÄ±rda tÃ¼r seÃ§imi deÄŸiÅŸtiÄŸinde "DeÄŸer" input'unu aktif/pasif yapar.
function handleRowTypeChange(selectElement) {
    const row = selectElement.parentElement;
    const valueInput = row.querySelector('.setting-value');
    const selectedType = selectElement.value;

    const typesWithValue = ['points', 'multiplier'];
    const typesWithAutoValue = ['wheelTicket', 'clickCatchTicket', 'iflasShield'];

    if (typesWithValue.includes(selectedType)) {
        valueInput.disabled = false;
        valueInput.placeholder = 'DeÄŸer';
        if(selectedType === 'multiplier') valueInput.placeholder = 'DeÄŸer (2, 3 vb.)';
    } else {
        valueInput.disabled = true;
        valueInput.placeholder = 'N/A';
        if(typesWithAutoValue.includes(selectedType)){
             valueInput.value = 1;
        } else {
             valueInput.value = 0;
        }
    }
}

// "Adet" inputlarÄ±ndan biri her deÄŸiÅŸtiÄŸinde toplam kutu sayÄ±sÄ±nÄ± hesaplar ve gÃ¶sterir.
function updateTotalBoxCount() {
    let total = 0;
    document.querySelectorAll('.box-setting-row .setting-count').forEach(input => {
        const count = parseInt(input.value);
        if (!isNaN(count) && count > 0) {
            total += count;
        }
    });
    document.getElementById('totalBoxCountDisplay').textContent = total;
}

function openHelpModal() {
  helpModal.style.display = 'flex';
}
function closeHelpModal() {
  helpModal.style.display = 'none';
}

    // YENÄ° EKLENEN FONKSÄ°YON: DIÅARIYA TIKLAYINCA KAPATIR
function closeModalOnClickOutside(event) {
  // EÄŸer tÄ±klanan elementin ID'si modalÄ±n kendisi ise (yani dÄ±ÅŸtaki karanlÄ±k alan ise)
  if (event.target.id === 'publicUserDetailModal') {
    closePublicUserDetailModal(); // Normal kapatma fonksiyonunu Ã§aÄŸÄ±r
  }
}

async function clearWheelHistory() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("TÃ¼m 'Son Kazananlar' geÃ§miÅŸini kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!");
    if (confirmed) {
        await db.ref('wheelHistory').remove();
        displayMessage("Ã‡ark geÃ§miÅŸi baÅŸarÄ±yla temizlendi.");
    }
}

async function deleteWheelHistoryEntry(entryKey) {
    if (!isAdmin || !entryKey) return;
    const confirmed = await customConfirm("Bu kaydÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?");
    if (confirmed) {
        await db.ref('wheelHistory/' + entryKey).remove();
    }
}

    function updateWheelAppearance() {
     const wheel = document.getElementById('wheel');
     if (!wheel) return;

     const segments = defaultWheelSegments;
     const numSegments = segments.length;
     const degreesPerSegment = 360 / numSegments;

     let conicGradient = 'conic-gradient(';
     wheel.innerHTML = ''; // Ã–nceki yazÄ±larÄ± temizle

     for (let i = 0; i < numSegments; i++) {
         const startAngle = i * degreesPerSegment;
         const endAngle = (i + 1) * degreesPerSegment;
         const color = getSegmentColor(i); // Fonksiyonu basitleÅŸtirdik
         
         // Renk dilimini oluÅŸtur
         conicGradient += `${color} ${startAngle}deg ${endAngle}deg`;
         if (i < numSegments - 1) {
             conicGradient += ', ';
         }

         // YazÄ±larÄ± oluÅŸtur ve yerleÅŸtir
         const segmentTextContainer = document.createElement('div');
         segmentTextContainer.className = 'wheel-segment-text';
         segmentTextContainer.style.transform = `rotate(${startAngle + (degreesPerSegment / 2)}deg)`;
         
         const textSpan = document.createElement('span');
         // HATALI KISIM DÃœZELTÄ°LDÄ°: ArtÄ±k doÄŸrudan doÄŸru segmentin etiketini alÄ±yor
         textSpan.innerText = segments[i].label; 
         
         segmentTextContainer.appendChild(textSpan);
         wheel.appendChild(segmentTextContainer);
     }
     conicGradient += ')';
     wheel.style.background = conicGradient;
 }

function getSegmentColor(index) {
     // Basit bir renk atama mantÄ±ÄŸÄ±
     const colors = ['#f44336', '#4caf50', '#2196f3', '#ffeb3b', '#9c27b0', '#e91e63', '#00bcd4', '#8bc34a', '#ff9800', '#607d8b', '#795548', '#cddc39'];
     // HATALI KISIM DÃœZELTÄ°LDÄ°: ArtÄ±k renkleri sÄ±rayla ve hatasÄ±z alÄ±yor
     return colors[index % colors.length];
 }

updateWheelAppearance();

// ...VE YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTIR
function getIconForWheelLabel(label) {
    const upperLabel = (label || '').toUpperCase();
    
    // Yeni Puan ikonlarÄ±
    if (upperLabel.includes('1000 PUAN')) return 'ğŸ‚';
    if (upperLabel.includes('250 PUAN')) return 'ğŸ';
    if (upperLabel.includes('100 PUAN')) return 'ğŸŒ';
    if (upperLabel.includes('10 PUAN')) return 'ğŸ†';

    // Yeni "Bedava Ã‡evirme" Ã¶dÃ¼lÃ¼
    if (upperLabel.includes('BEDAVA Ã‡EVÄ°R')) return 'ğŸ¡';

    // DiÄŸer sabit Ã¶dÃ¼ller
    if (upperLabel.includes('3 KUTU HAKKI')) return 'ğŸ';
    if (upperLabel.includes('1 KUTU HAKKI')) return 'ğŸ“¦';
    if (upperLabel.includes('TIKLA-YAKALA')) return 'ğŸŸï¸';
    if (upperLabel.includes('5X Ã‡ARPAN')) return 'âœ–ï¸';
    if (upperLabel.includes('SÃœRPRÄ°Z KUTU')) return 'ğŸ‰';
    if (upperLabel.includes('Ä°FLAS KALKANI')) return 'ğŸ›¡ï¸';
    if (upperLabel.includes('PAS')) return 'â˜ ï¸';
    
    return 'ğŸ¡'; // VarsayÄ±lan simge
}

function closeWheelLegendModal() {
    document.getElementById('wheelLegendModal').style.display = 'none';
}

function openWheelLegendModal() {
    document.body.classList.add('modal-open');
    const contentDiv = document.getElementById('wheelLegendContent');
    contentDiv.innerHTML = '';

    const legendData = [
        { icon: 'ğŸ‰', title: 'SÃœRPRÄ°Z KUTU', description: 'En nadir Ã¶dÃ¼l! Ä°Ã§inden Ã§ok yÃ¼ksek puanlar Ã§Ä±kan Ã¶zel bir kart seÃ§me oyunu baÅŸlatÄ±r.' },
        { icon: 'ğŸ†', title: 'EFSANEVÄ° KART PAKETÄ°', description: 'Ã‡ok nadir! Ä°Ã§inden sadece Efsanevi nadirlikte bir koleksiyon kartÄ± Ã§Ä±kar.' },
        { icon: 'ğŸƒ', title: 'JOKER KART', description: 'Ã‡ok nadir! Kart koleksiyonundaki herhangi bir eksik kartÄ± tamamlamanÄ± saÄŸlar.' },
        { icon: 'âœ–ï¸', title: '5X Ã‡ARPAN', description: 'Ã‡ok nadir! Bir sonraki kutu aÃ§Ä±lÄ±ÅŸÄ±nda kazanacaÄŸÄ±n puanÄ± veya eÅŸyayÄ± 5\'e katlar.' }, // EKLENEN BLOK
        { icon: 'ğŸ‚', title: '1000 PUAN', description: 'Nadir bulunan, yÃ¼ksek miktarda bir puan Ã¶dÃ¼lÃ¼dÃ¼r.' },
        { icon: 'ğŸ¥‡', title: 'ALTIN KART PAKETÄ°', description: 'Ä°Ã§inden sadece AltÄ±n nadirlikte bir koleksiyon kartÄ± Ã§Ä±kar.' },
        { icon: 'ğŸ', title: '3 KUTU HAKKI', description: 'DeÄŸerli bir Ã¶dÃ¼l! Kutu oyununda kullanmak Ã¼zere tam 3 adet aÃ§ma hakkÄ± verir.' },
        { icon: 'ğŸ¥ˆ', title: 'GÃœMÃœÅ KART PAKETÄ°', description: 'Ä°Ã§inden sadece GÃ¼mÃ¼ÅŸ nadirlikte bir koleksiyon kartÄ± Ã§Ä±kar.' },
        { icon: 'ğŸ', title: '250 PUAN', description: 'HesabÄ±na anÄ±nda 250 Puan eklenir.' },
        { icon: 'ğŸ›¡ï¸', title: 'Ä°FLAS KALKANI', description: 'Kutu oyununda "Bomba" bulursan puanlarÄ±nÄ± bir defaya mahsus korur.' },
        { icon: 'ğŸŸï¸', title: '+1 T-Y BÄ°LETÄ°', description: 'TÄ±kla-Yakala mini oyununa bir giriÅŸ hakkÄ± kazandÄ±rÄ±r.' },
        { icon: 'ğŸ¡', title: 'BEDAVA Ã‡EVÄ°RME', description: 'ÅansÄ±nÄ± tekrar denemen iÃ§in +1 Ã‡ark Bileti kazandÄ±rÄ±r.' },
        { icon: 'ğŸ“¦', title: '+1 KUTU HAKKI', description: 'Kutu oyununda kullanmak Ã¼zere bir adet kutu aÃ§ma hakkÄ± kazandÄ±rÄ±r.' },
        { icon: 'ğŸ´', title: 'STANDART KART PAKETÄ°', description: 'Ä°Ã§inden herhangi bir nadirlikte rastgele bir kart Ã§Ä±kar.' },
        { icon: 'ğŸ¥‰', title: 'BRONZ KART PAKETÄ°', description: 'Ä°Ã§inden sadece Normal nadirlikte bir koleksiyon kartÄ± Ã§Ä±kar.' },
        { icon: 'ğŸŒ', title: '100 PUAN', description: 'SÄ±kÃ§a gelen, gÃ¼zel bir puan Ã¶dÃ¼lÃ¼dÃ¼r.' },
        { icon: 'ğŸ†', title: '10 PUAN', description: 'En kÃ¼Ã§Ã¼k teselli puanÄ± Ã¶dÃ¼lÃ¼dÃ¼r.' },
        { icon: 'â˜ ï¸', title: 'PAS', description: 'ÅanssÄ±zlÄ±k! Bu dilimde herhangi bir Ã¶dÃ¼l yoktur.' }
    ];

    legendData.forEach(item => {
        const itemHtml = `
            <div class="flex items-start gap-4 p-3 bg-gray-900 rounded-lg text-left">
                <span class="text-3xl w-8 text-center mt-1">${item.icon}</span>
                <div class="flex-1">
                    <strong class="text-yellow-200 block">${item.title}</strong>
                    <p class="text-gray-400 text-sm">${item.description}</p>
                </div>
            </div>
        `;
        contentDiv.innerHTML += itemHtml;
    });
    
    document.getElementById('wheelLegendModal').style.display = 'flex';
}

function closeWheelLegendModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('wheelLegendModal').style.display = 'none';
}

    function listenForLastGameSummary() {
    const ref = db.ref('clickCatchLobbyLastGameSummary');
    const container = document.getElementById('lastWinnerContainer');
    const titleEl = document.getElementById('lastWinnerInfo');
    const detailsListEl = document.getElementById('lastGameDetailsList');

    const callback = snap => {
        const summaryData = snap.val();

        // EÄER VERÄ° VARSA VE KAZANAN BELLÄ° Ä°SE BÄ°LGÄ°LERÄ° GÃ–STER
        if (summaryData && summaryData.winner) {
            
            // 1. Oyun SÃ¼resini Hesapla
            let durationText = '';
            if (summaryData.startTimestamp && summaryData.endTimestamp) {
                const durationMs = summaryData.endTimestamp - summaryData.startTimestamp;
                const seconds = Math.floor(durationMs / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                durationText = ` (SÃ¼re: ${minutes}dk ${remainingSeconds}sn)`;
            }

            // 2. Ana BaÅŸlÄ±ÄŸÄ± GÃ¼ncelle (Admin iÃ§in silme butonuyla birlikte)
            let deleteButton = '';
            if (isAdmin) {
                deleteButton = `
                    <button onclick="clearLastWinner()" class="ml-2 text-gray-500 hover:text-red-500 transition-colors" title="Son KazananÄ± Sil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                `;
            }
            titleEl.innerHTML = `ğŸ† Son Lobi Galibi: <b class="text-white">${summaryData.winner}</b> (+${summaryData.prize} Puan)${durationText}${deleteButton}`;

            // 3. Oyuncu Listesini OluÅŸtur ve SÄ±rala
            const players = summaryData.players || {};
            const sortedPlayers = Object.entries(players).sort(([, a], [, b]) => b.score - a.score);
            
            let detailsHtml = '';
            sortedPlayers.forEach(([username, data], index) => {
                const isWinner = username === summaryData.winner;
                const rowClass = isWinner ? 'bg-green-800/50 border-green-500' : 'bg-gray-800/50 border-gray-700';
                const rankIcon = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : `${index + 1}.`));
                
                detailsHtml += `
                    <div class="flex justify-between items-center p-2 rounded border ${rowClass}">
                        <span class="font-bold">${rankIcon} ${username}</span>
                        <span class="text-gray-300">Skor: <b class="text-white">${data.score} / ${summaryData.target}</b></span>
                    </div>
                `;
            });
            
            detailsListEl.innerHTML = detailsHtml;
            container.classList.remove('hidden'); // Paneli gÃ¶rÃ¼nÃ¼r yap

        } else {
            // SORUNU Ã‡Ã–ZEN KISIM: EÄER VERÄ° SÄ°LÄ°NMÄ°ÅSE (NULL Ä°SE) PANELÄ° GÄ°ZLE
            container.classList.add('hidden');
        }
    };
    
    // Listener'Ä± tekrar tekrar eklememek iÃ§in kontrol
    if (activeListeners.lobbySummary) {
        activeListeners.lobbySummary.ref.off('value', activeListeners.lobbySummary.callback);
    }
    activeListeners.lobbySummary = { ref, event: 'value', callback };
    ref.on('value', callback);
}

    // YENÄ° EKLENECEK KOD BAÅLANGICI
  // GÃ¼nlÃ¼k Ã–dÃ¼l modalÄ±ndaki "Ã–dÃ¼l Tipi" dropdown'Ä±nÄ± dinler.
  document.getElementById('dailyRewardType').addEventListener('change', function() {
      const usesInput = document.getElementById('dailyRewardMultiplierUses');
      // EÄŸer seÃ§ilen tip "Ã‡arpan" (tempMultiplier) ise, KullanÄ±m HakkÄ± alanÄ±nÄ± gÃ¶ster.
      if (this.value === 'tempMultiplier') {
          usesInput.classList.remove('hidden');
      } else {
      // DeÄŸilse, KullanÄ±m HakkÄ± alanÄ±nÄ± gizle.
          usesInput.classList.add('hidden');
      }
  });

    function openClickCatchInfoModal() {
    document.body.classList.add('modal-open');
    document.getElementById('clickCatchInfoModal').style.display = 'flex';
}

function closeClickCatchInfoModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('clickCatchInfoModal').style.display = 'none';
}

    // YENÄ° EKLENECEK GERÄ° SAYIM FONKSÄ°YONU
let seasonCountdownInterval = null;

function listenForSeasonCountdown() {
    const countdownContainer = document.getElementById('seasonCountdownContainer');
    const countdownEl = document.getElementById('seasonCountdown');
    const countdownContainerCards = document.getElementById('seasonCountdownContainer_cards'); // Kartlar iÃ§in yeni container
    const countdownElCards = document.getElementById('seasonCountdown_cards'); // Kartlar iÃ§in yeni sayaÃ§
    const ref = db.ref('gameConfig/seasonEndDate');

    const callback = snap => {
        if (seasonCountdownInterval) {
            clearInterval(seasonCountdownInterval);
        }

        const endDateTimestamp = snap.val();

        if (!endDateTimestamp || endDateTimestamp < getSyncedTime()) {
            countdownContainer.classList.add('hidden');
            if (countdownContainerCards) countdownContainerCards.classList.add('hidden');
            return;
        }

        countdownContainer.classList.remove('hidden');
        if (countdownContainerCards) countdownContainerCards.classList.remove('hidden');

        const updateTimer = () => {
            const now = getSyncedTime();
            const timeLeft = endDateTimestamp - now;

            if (timeLeft <= 0) {
                countdownEl.textContent = "SEZON BÄ°TTÄ°!";
                if (countdownElCards) countdownElCards.textContent = "SEZON BÄ°TTÄ°!";
                clearInterval(seasonCountdownInterval);
                
                executeSeasonReset();
                
                return;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            const timeString = `${days} GÃ¼n ${hours} Saat ${minutes} Dakika ${seconds} Saniye`;
            countdownEl.textContent = timeString;
            if (countdownElCards) countdownElCards.textContent = timeString;
        };

        updateTimer();
        seasonCountdownInterval = setInterval(updateTimer, 1000);
    };

    if (activeListeners.seasonCountdown) {
        activeListeners.seasonCountdown.ref.off('value', activeListeners.seasonCountdown.callback);
    }
    activeListeners.seasonCountdown = { ref, event: 'value', callback };
    ref.on('value', callback);
}

   async function openSeasonManagementModal() {
    document.body.classList.add('modal-open');
    // KayÄ±tlÄ± ayarlarÄ± Ã§ek ve inputlarÄ± doldur
    const settingsSnap = await db.ref('gameConfig/seasonSettings').once('value');
    if (settingsSnap.exists()) {
        const settings = settingsSnap.val();
        if (settings.endDate) {
            const date = new Date(settings.endDate);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            // DEÄÄ°ÅEN SATIR: ArtÄ±k doÄŸru ve benzersiz ID'ye sahip input'u hedefliyoruz.
            document.getElementById('seasonManagementEndDateInput').value = date.toISOString().slice(0, 16);
        }
        document.getElementById('puanLeaderAvatarUrl').value = settings.rewards?.puanLeaderAvatarUrl || '';
        document.getElementById('rozetLeaderAvatarUrl').value = settings.rewards?.rozetLeaderAvatarUrl || '';
    }
    document.getElementById('seasonManagementModal').style.display = 'flex';
}

function closeSeasonManagementModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('seasonManagementModal').style.display = 'none';
}

// --- ESKÄ° saveAutomaticResetSettings FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR ---

async function saveAutomaticResetSettings() {
    if (!isAdmin) return;

    const dateInput = document.getElementById('seasonManagementEndDateInput').value;
    const puanAvatarUrl = document.getElementById('puanLeaderAvatarUrl').value.trim();
    const rozetAvatarUrl = document.getElementById('rozetLeaderAvatarUrl').value.trim();

    // --- YENÄ° EKLENEN KOD BAÅLANGICI ---
    // Hediye paketi input'larÄ±ndaki deÄŸerleri oku. DeÄŸer girilmemiÅŸse 0 kabul et.
    const giftPackage = {
        kutuHakki: parseInt(document.getElementById('rewardBoxRights').value) || 0,
        carkBileti: parseInt(document.getElementById('rewardWheelTickets').value) || 0,
        clickCatchTickets: parseInt(document.getElementById('rewardClickCatchTickets').value) || 0,
        iflasShieldUses: parseInt(document.getElementById('rewardIflasShields').value) || 0
    };
    // --- YENÄ° EKLENEN KOD SONU ---

    if (!dateInput) {
        displayMessage("LÃ¼tfen geÃ§erli bir sezon bitiÅŸ tarihi seÃ§in.");
        return;
    }
    
    const settings = {
        endDate: new Date(dateInput).getTime(),
        status: 'active',
        rewards: {
            puanLeaderAvatarUrl: puanAvatarUrl,
            rozetLeaderAvatarUrl: rozetAvatarUrl,
            general: giftPackage // OkuduÄŸumuz hediye paketini ayarlara ekle
        }
    };
    
    await db.ref('gameConfig/seasonSettings').set(settings);
    await db.ref('gameConfig/seasonEndDate').set(settings.endDate);
    
    displayMessage("Otomatik sezon sonu ayarlarÄ± kaydedildi. Geri sayÄ±m baÅŸlayacak.");
    closeSeasonManagementModal();
}

async function executeSeasonReset(isManual = false) {
    // Bu fonksiyon, bir oyuncunun tarayÄ±cÄ±sÄ± tarafÄ±ndan otomatik olarak tetiklenirse,
    // iÅŸlemin sadece bir kez yapÄ±lmasÄ±nÄ± saÄŸlamak iÃ§in bir durum kontrolÃ¼ yapar.
    if (!isAdmin) {
        const resetStatus = await db.ref('gameConfig/seasonResetStatus').once('value');
        if (resetStatus.val() === 'in_progress' || resetStatus.val() === 'completed') {
            console.log("Sezon sÄ±fÄ±rlama zaten baÅŸka bir tarayÄ±cÄ± tarafÄ±ndan baÅŸlatÄ±lmÄ±ÅŸ veya tamamlanmÄ±ÅŸ.");
            return;
        }
        await db.ref('gameConfig/seasonResetStatus').set('in_progress');
    }
    
    // Admin manuel olarak tetiklerse onay istenir.
    const confirmationText = isManual 
        ? "Sezonu ÅÄ°MDÄ° MANUEL olarak bitirmek Ã¼zeresiniz. TÃ¼m puanlar, istatistikler ve KART KOLEKSÄ°YONU sÄ±fÄ±rlanacak, Ã¶dÃ¼ller daÄŸÄ±tÄ±lacak. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?"
        : "Sezon sonu iÃ§in SON ONAY. SÄ±fÄ±rlama iÅŸlemi baÅŸlayacak ve geri alÄ±namayacak. OnaylÄ±yor musunuz?";

    if (isManual) {
        const confirmed = await customConfirm(confirmationText);
        if (!confirmed) return;
    }

    displayMessage("Sezon sonu iÅŸlemleri baÅŸlatÄ±ldÄ±... Bu iÅŸlem birkaÃ§ saniye sÃ¼rebilir. LÃ¼tfen bekleyin.");

    // Gerekli tÃ¼m verileri topla
    const allUsersSnap = await db.ref('users').once('value');
    const allUsersData = allUsersSnap.val();
    const leaders = await calculateAllLeaders(allUsersData);
    const settingsSnap = await db.ref('gameConfig/seasonSettings').once('value');
    const seasonSettings = settingsSnap.val();

    // Liderleri belirle
    const puanLeader = leaders.highEverBalanceUser;
    const rozetLeader = (await getTopBadgeHolder(allUsersData, leaders)).username;
    
    // Ã–dÃ¼lleri hazÄ±rla
    const puanAvatar = seasonSettings?.rewards?.puanLeaderAvatarUrl;
    const rozetAvatar = seasonSettings?.rewards?.rozetLeaderAvatarUrl;
    const giftPackage = seasonSettings?.rewards?.general || {
        kutuHakki: 0, carkBileti: 0, clickCatchTickets: 0, iflasShieldUses: 0
    };

    // TÃ¼m veritabanÄ± gÃ¼ncellemelerini tek bir objede topla
    const updates = {};
    
    // Ana kart koleksiyonu ayarlarÄ±nÄ± sÄ±fÄ±rla
    updates['/gameConfig/cardCollection'] = null;
    updates['/gameConfig/collectionWinner'] = null;
    updates['/gameConfig/collectionGrandPrize'] = null;
    updates['/gameConfig/cardCollectionStatus'] = 'inactive';

    // Her bir kullanÄ±cÄ± iÃ§in iÅŸlemleri yap
    for (const username in allUsersData) {
        if (username.toLowerCase() === 'weizendtv' || !allUsersData[username].approved) continue;
        
        const userPath = `users/${username}`;
        const userData = allUsersData[username];

        // 1. Genel hediye paketini her kullanÄ±cÄ±ya ekle
        updates[`${userPath}/kutuHakki`] = (userData.kutuHakki || 0) + giftPackage.kutuHakki;
        updates[`${userPath}/carkBileti`] = (userData.carkBileti || 0) + giftPackage.carkBileti;
        updates[`${userPath}/clickCatchTickets`] = (userData.clickCatchTickets || 0) + giftPackage.clickCatchTickets;
        updates[`${userPath}/iflasShieldUses`] = (userData.iflasShieldUses || 0) + giftPackage.iflasShieldUses;

        // 2. Åampiyon Ã¶dÃ¼llerini ve kalÄ±cÄ± ÅŸampiyonluk sayaÃ§larÄ±nÄ± gÃ¼ncelle
        if (username === puanLeader) {
            if(puanAvatar) updates[`${userPath}/selectedAvatar`] = { id: `sezon_odul_puan_${Date.now()}`, url: puanAvatar };
            updates[`${userPath}/puanChampionshipsWon`] = (userData.puanChampionshipsWon || 0) + 1;
        }
        if (username === rozetLeader) {
            if(rozetAvatar) updates[`${userPath}/selectedAvatar`] = { id: `sezon_odul_rozet_${Date.now()}`, url: rozetAvatar };
            updates[`${userPath}/rozetChampionshipsWon`] = (userData.rozetChampionshipsWon || 0) + 1;
        }
        // Ã–NEMLÄ°: KalÄ±cÄ± ÅŸampiyonluk sayaÃ§larÄ± (`puanChampionshipsWon`, `rozetChampionshipsWon`
        // ve daha Ã¶nce eklediÄŸimiz `collectionChampionshipsWon`) burada SIFIRLANMAZ! Sadece artÄ±rÄ±lÄ±r.
        
        // 3. Sezonluk ilerlemeyi ve istatistikleri sÄ±fÄ±rla
        updates[`${userPath}/balance`] = 0;
        updates[`${userPath}/kariyerPuani`] = 0;
        updates[`${userPath}/totalSpentPoints`] = 0;
        updates[`${userPath}/boxesOpenedCount`] = 0;
        updates[`${userPath}/surpriseBoxesOpened`] = 0;
        updates[`${userPath}/iflasCount`] = 0;
        updates[`${userPath}/multiplierFoundCount`] = 0;
        updates[`${userPath}/iflasShieldUsedCount`] = 0;
        updates[`${userPath}/wheelSpinsCount`] = 0;
        updates[`${userPath}/clickCatchHighestScore`] = 0;
        
        // Sezonluk kart ilerlemesi ve tamamlanma durumu sÄ±fÄ±rlanÄ±r.
        updates[`${userPath}/cardCollection`] = null;
        updates[`${userPath}/completedCollection`] = null;
    }

    // DiÄŸer genel sezonluk verileri sÄ±fÄ±rla
    updates['purchaseHistory'] = null;
    updates['clickCatchWeeklyScores'] = null;
    updates['gameStats'] = null;

    // MaÄŸazadaki Ã¼rÃ¼nlerin "satÄ±n alÄ±nma sayÄ±sÄ±nÄ±" sÄ±fÄ±rla
    const storeItemsSnap = await db.ref('storeItems').once('value');
    if (storeItemsSnap.exists()) {
        storeItemsSnap.forEach(itemSnap => {
            updates[`storeItems/${itemSnap.key}/purchaseCount`] = 0;
        });
    }

    // Sezon sonu duyurusunu oluÅŸtur
    const seasonName = new Date().toLocaleString('tr-TR', { month: 'long', year: 'numeric' }) + " Sezonu";
    updates[`seasonAnnouncements/${Date.now()}`] = {
        title: `${seasonName} Sona Erdi!`,
        message: `ğŸ† Kariyer Puan Lideri: <b>${puanLeader}</b><br>ğŸ‘‘ Rozet Lideri: <b>${rozetLeader}</b><br><br>Åampiyonlar Ã¶zel avatarlarÄ±nÄ± kazandÄ±! TÃ¼m katÄ±lÄ±mcÄ±lara ise hediye paketleri gÃ¶nderildi! Yeni sezon baÅŸladÄ±, herkese bol ÅŸans!`,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    // TÃ¼m gÃ¼ncellemeleri tek seferde veritabanÄ±na uygula
    await db.ref().update(updates);
    
    // Yeni sezon iÃ§in kutularÄ± yeniden oluÅŸtur
    await createBoxes();
    
    // Sezon ayarlarÄ±nÄ± temizle
    await db.ref('gameConfig/seasonSettings').remove();
    await db.ref('gameConfig/seasonEndDate').remove();
    
    if (isAdmin) {
        await db.ref('gameConfig/seasonResetStatus').remove();
    } else {
        await db.ref('gameConfig/seasonResetStatus').set('completed');
    }

    displayMessage("SEZON BAÅARIYLA SIFIRLANDI! Ã–dÃ¼ller daÄŸÄ±tÄ±ldÄ± ve yeni sezon baÅŸladÄ±.");
    if (isManual) closeSeasonManagementModal();
}

async function stopSeasonCountdown() {
    if (!isAdmin) return; // Sadece adminin kullanabildiÄŸinden emin ol.

    const confirmed = await customConfirm("Mevcut otomatik sezon sonu geri sayÄ±mÄ±nÄ± durdurmak ve ayarlarÄ± silmek istediÄŸinizden emin misiniz?");
    if (!confirmed) return; // KullanÄ±cÄ± "HayÄ±r" derse iÅŸlemi iptal et.

    try {
        // Geri sayÄ±mÄ± ve ayarlarÄ± kontrol eden veritabanÄ± yollarÄ±nÄ± sil.
        await db.ref('gameConfig/seasonEndDate').remove();
        await db.ref('gameConfig/seasonSettings').remove();

        displayMessage("Otomatik aylÄ±k sezon sÄ±fÄ±rlama baÅŸarÄ±yla iptal edildi. Geri sayÄ±m durduruldu.");
        closeSeasonManagementModal(); // Ä°ÅŸlem bittikten sonra pencereyi kapat.

    } catch (error) {
        console.error("Sezon sayacÄ± durdurulurken hata:", error);
        displayMessage("Geri sayÄ±m iptal edilirken bir hata oluÅŸtu. LÃ¼tfen konsolu kontrol edin.");
    }
}

// --- YENÄ° EKLENECEK FONKSÄ°YON SONU ---

// Oyuncular iÃ§in kalÄ±cÄ± duyuru sistemini dinler
let currentPersistentAnnId = null;
function listenForPersistentAnnouncement() {
    const ref = db.ref('seasonAnnouncements').orderByChild('timestamp').limitToLast(1);
    
    const callback = async (snap) => {
        if (!snap.exists()) return;
        
        currentPersistentAnnId = Object.keys(snap.val())[0];
        const ann = snap.val()[currentPersistentAnnId];

        const userSeenRef = db.ref(`users/${currentUser}/seenAnnouncements/${currentPersistentAnnId}`);
        const userSeenSnap = await userSeenRef.once('value');

        if (!userSeenSnap.exists()) {
            document.getElementById('persistentAnnTitle').textContent = ann.title;
            document.getElementById('persistentAnnMessage').innerHTML = ann.message;
            document.getElementById('persistentAnnouncementModal').style.display = 'flex';
        }
    };
    
    if (activeListeners.persistentAnn) {
        activeListeners.persistentAnn.ref.off('value', activeListeners.persistentAnn.callback);
    }
    activeListeners.persistentAnn = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// Oyuncu duyuruyu kapattÄ±ÄŸÄ±nda iÅŸaretler
async function markPersistentAnnouncementAsSeen() {
    if (currentPersistentAnnId) {
        await db.ref(`users/${currentUser}/seenAnnouncements/${currentPersistentAnnId}`).set(true);
    }
    document.getElementById('persistentAnnouncementModal').style.display = 'none';
    document.body.classList.remove('modal-open');
}

// Rozet liderini bulan yardÄ±mcÄ± fonksiyon
async function getTopBadgeHolder(allUsersData, leaders) {
    let topUser = { username: null, badgeCount: -1 };
    
    for (const username in allUsersData) {
        if (username.toLowerCase() === 'weizendtv' || !allUsersData[username].approved) continue;

        let count = 0;
        if (username === leaders.currentBalanceUser) count++;
        if (username === leaders.highEverBalanceUser) count++;
        if (username === leaders.surpriseBoxUser) count++;
        if (username === leaders.bombUser) count++;
        if (username === leaders.spentPointsUser) count++;
        if (username === leaders.multiplierUser) count++;
        if (username === leaders.boxUser) count++;
        if (username === leaders.shieldUser) count++;
        if (username === leaders.clickCatchLeaderUser) count++;
        if (username === leaders.wheelSpinUser) count++;
        
        if (count > topUser.badgeCount) {
            topUser = { username: username, badgeCount: count };
        }
    }
    return topUser;
}

    // MEVCUT openSeasonInfoModal FONKSÄ°YONUNU SÄ°LÄ°P BUNUNLA DEÄÄ°ÅTÄ°RÄ°N

async function openSeasonInfoModal() {
    document.body.classList.add('modal-open');
    const giftDetailsContainer = document.getElementById('seasonGiftPackageDetails');
    const championPrizesContainer = document.getElementById('seasonChampionPrizes');
    
    giftDetailsContainer.innerHTML = '<p class="text-gray-400">Genel Ã¶dÃ¼l paketi yÃ¼kleniyor...</p>';
    championPrizesContainer.innerHTML = '<p class="text-gray-400">Åampiyon Ã¶dÃ¼lleri yÃ¼kleniyor...</p>';

    try {
        const settingsSnap = await db.ref('gameConfig/seasonSettings/rewards').once('value');
        
        // Genel Hediye Paketi KÄ±smÄ±
        let rewardsHtml = '<strong class="text-yellow-200 block mb-2">TÃ¼m KatÄ±lÄ±mcÄ±lar Ä°Ã§in Hediye Paketi:</strong><ul class="list-disc list-inside space-y-1 text-gray-300">';
        let hasRewards = false;
        
        const generalRewards = settingsSnap.exists() ? settingsSnap.val().general : null;
        if (generalRewards) {
            if (generalRewards.kutuHakki > 0) { rewardsHtml += `<li>ğŸ ${generalRewards.kutuHakki} Adet Kutu HakkÄ±</li>`; hasRewards = true; }
            if (generalRewards.carkBileti > 0) { rewardsHtml += `<li>ğŸ¡ ${generalRewards.carkBileti} Adet Ã‡ark Bileti</li>`; hasRewards = true; }
            if (generalRewards.clickCatchTickets > 0) { rewardsHtml += `<li>ğŸ¯ ${generalRewards.clickCatchTickets} Adet TÄ±kla-Yakala Bileti</li>`; hasRewards = true; }
            if (generalRewards.iflasShieldUses > 0) { rewardsHtml += `<li>ğŸ›¡ï¸ ${generalRewards.iflasShieldUses} Adet Ä°flas KalkanÄ±</li>`; hasRewards = true; }
        }
        if (!hasRewards) {
            rewardsHtml += '<li>Bu sezon iÃ§in henÃ¼z genel bir Ã¶dÃ¼l paketi belirlenmedi.</li>';
        }
        rewardsHtml += '</ul>';
        giftDetailsContainer.innerHTML = rewardsHtml;

        // Åampiyon Ã–dÃ¼lleri KÄ±smÄ±
        let championPrizesHtml = '<strong class="text-yellow-300 block mb-2">SÄ±ralama Liderleri Ä°Ã§in Ã–zel Ã–dÃ¼ller:</strong><ul class="list-disc list-inside space-y-1 text-gray-300">';
        let hasChampionPrizes = false;

        const championRewards = settingsSnap.val();
        if (championRewards) {
            if (championRewards.puanLeaderAvatarUrl) {
                // --- DEÄÄ°ÅEN SATIR: Profile iÅŸleneceÄŸi bilgisi eklendi ---
                championPrizesHtml += `<li>ğŸ† Kariyer Puan SÄ±ralamasÄ± 1.'si <b class="text-white">Ã–zel Åampiyon AvatarÄ±</b> kazanacak ve bu baÅŸarÄ± profiline kalÄ±cÄ± olarak iÅŸlenecektir.</li>`;
                hasChampionPrizes = true;
            }
            if (championRewards.rozetLeaderAvatarUrl) {
                // --- DEÄÄ°ÅEN SATIR: Profile iÅŸleneceÄŸi bilgisi eklendi ---
                championPrizesHtml += `<li>ğŸ‘‘ Liderler SÄ±ralamasÄ± 1.'si <b class="text-white">Ã–zel Åampiyon AvatarÄ±</b> kazanacak ve bu baÅŸarÄ± profiline kalÄ±cÄ± olarak iÅŸlenecektir.</li>`;
                hasChampionPrizes = true;
            }
        }

        if (!hasChampionPrizes) {
            championPrizesHtml += '<li>Bu sezon iÃ§in henÃ¼z Ã¶zel bir ÅŸampiyon Ã¶dÃ¼lÃ¼ belirlenmedi.</li>';
        }
        championPrizesHtml += '</ul>';
        championPrizesContainer.innerHTML = championPrizesHtml;

    } catch (error) {
        console.error("Sezon Ã¶dÃ¼lleri alÄ±nÄ±rken hata:", error);
        giftDetailsContainer.innerHTML = '<p class="text-red-500">Genel Ã¶dÃ¼l bilgileri yÃ¼klenemedi.</p>';
        championPrizesContainer.innerHTML = '<p class="text-red-500">Åampiyon Ã¶dÃ¼l bilgileri yÃ¼klenemedi.</p>';
    }

    document.getElementById('seasonInfoModal').style.display = 'flex';
}

function closeSeasonInfoModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('seasonInfoModal').style.display = 'none';
}

// --- YENÄ° EKLENECEK HAFTALIK BÄ°LGÄ° PENCERESÄ° FONKSÄ°YONLARI ---

async function openWeeklyResetInfoModal() {
    document.body.classList.add('modal-open');
    const detailsContainer = document.getElementById('weeklyWinnerPrizeDetails');
    detailsContainer.innerHTML = '<p class="text-gray-400">Åampiyon Ã¶dÃ¼lÃ¼ yÃ¼kleniyor...</p>';

    try {
        const settingsSnap = await db.ref('gameConfig/weeklyClickCatchReset/prize').once('value');
        let prizeHtml = '';

        if (settingsSnap.exists()) {
            const prize = settingsSnap.val();
            const prizeNames = { boxRights: "Kutu HakkÄ±", points: "Puan", wheelTicket: "Ã‡ark Bileti", iflasShield: "Ä°flas KalkanÄ±" };
            const prizeName = prizeNames[prize.type] || prize.type;
            
            prizeHtml = `<strong>ğŸ† Åampiyon Ã–dÃ¼lÃ¼:</strong> <span class="text-white font-bold">${prize.amount} ${prizeName}</span>`;
        } else {
            prizeHtml = '<strong>ğŸ† Åampiyon Ã–dÃ¼lÃ¼:</strong> <span class="text-gray-400">HenÃ¼z admin tarafÄ±ndan belirlenmedi.</span>';
        }
        detailsContainer.innerHTML = prizeHtml;

    } catch (error) {
        console.error("HaftalÄ±k Ã¶dÃ¼l bilgisi alÄ±nÄ±rken hata:", error);
        detailsContainer.innerHTML = '<p class="text-red-500">Ã–dÃ¼l bilgileri yÃ¼klenemedi.</p>';
    }

    document.getElementById('weeklyResetInfoModal').style.display = 'flex';
}

function closeWeeklyResetInfoModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('weeklyResetInfoModal').style.display = 'none';
}

async function kasaTransferEt() {
    if (isAdmin) {
        displayMessage("Adminler bu iÅŸlemi yapamaz.");
        return;
    }
    const miktar = parseInt(document.getElementById('kasaTransferInput').value);
    if (isNaN(miktar) || miktar <= 0) {
        displayMessage("LÃ¼tfen geÃ§erli bir miktar girin.");
        return;
    }

    // YENÄ° EKLENEN KONTROL MEKANÄ°ZMASI
    const settingsSnap = await db.ref('gameConfig/kasaSettings').once('value');
    const minAmount = settingsSnap.val()?.minTransferAmount || 0;

    if (minAmount > 0 && miktar < minAmount) {
        displayMessage(`Kasaya aktarÄ±m iÃ§in minimum tutar ${minAmount} PuandÄ±r.`);
        return;
    }
    // KONTROL SONU

    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();
    const mevcutPuan = userData.balance || 0;

    if (miktar > mevcutPuan) {
        displayMessage("Kasaya aktarmak iÃ§in yeterli puanÄ±nÄ±z yok.");
        return;
    }

    const confirmed = await customConfirm(`<b>${miktar}</b> Puan, Kasa'ya aktarÄ±lacak. Bu iÅŸlem geri alÄ±namaz ve Kasa PuanlarÄ± sadece Ã–zel ÃœrÃ¼n MaÄŸazasÄ±'nda kullanÄ±labilir. OnaylÄ±yor musunuz?`);
    if (!confirmed) return;

    const yeniPuan = mevcutPuan - miktar;
    const yeniKasaPuani = (userData.kasaPuani || 0) + miktar;

    await userRef.update({
        balance: yeniPuan,
        kasaPuani: yeniKasaPuani
    });

    logActivity('kasaTransfer', currentUser, { amount: miktar, newKasaBalance: yeniKasaPuani });
    displayMessage(`BaÅŸarÄ±lÄ±! <b>${miktar} Puan</b>, Kasa'ya aktarÄ±ldÄ±.`);
    document.getElementById('kasaTransferInput').value = '';
}

async function loadCollectionAlbum() {
    const albumContainer = document.getElementById('cardCollectionAlbum');
    const statusOverlay = document.getElementById('collectionStatusOverlay');
    const statusTitle = document.getElementById('collectionStatusTitle');
    const statusMessage = document.getElementById('collectionStatusMessage');
    const grandPrizeDisplay = document.getElementById('grandPrizeDisplay');

    const statusRef = db.ref('gameConfig/cardCollectionStatus');
    const statusSnap = await statusRef.once('value');
    const currentStatus = statusSnap.val() || 'inactive';

    if(isAdmin) {
        const statusTextEl = document.getElementById('collectionStatusText');
        const pauseBtn = document.getElementById('pauseResumeButton');
        if (statusTextEl && pauseBtn) {
            statusTextEl.textContent = {
                'active': 'Aktif',
                'paused': 'DuraklatÄ±ldÄ± (BakÄ±mda)',
                'inactive': 'Bitti / BaÅŸlamadÄ±'
            }[currentStatus];
            
            if(currentStatus === 'paused') {
                pauseBtn.textContent = 'Sezonu Devam Ettir';
                pauseBtn.classList.replace('bg-orange-600', 'bg-green-600');
                pauseBtn.classList.replace('hover:bg-orange-500', 'hover:bg-green-500');
            } else {
                pauseBtn.textContent = 'Sezonu Duraklat';
                pauseBtn.classList.replace('bg-green-600', 'bg-orange-600');
                pauseBtn.classList.replace('hover:bg-green-500', 'hover:bg-orange-500');
            }
        }
    }

    if (!isAdmin) {
        if (currentStatus === 'paused') {
            statusTitle.textContent = 'ğŸ”§ BakÄ±mdayÄ±z ğŸ”§';
            statusMessage.textContent = 'Kart Koleksiyonu sezonu ÅŸu anda kÄ±sa bir bakÄ±mda. LÃ¼tfen daha sonra tekrar kontrol et.';
            statusOverlay.classList.remove('hidden');
            albumContainer.classList.add('hidden');
            grandPrizeDisplay.classList.add('hidden');
            return;
        }
        if (currentStatus === 'inactive') {
            statusTitle.textContent = 'ğŸš€ Yeni Sezon Ã‡ok YakÄ±nda! ğŸš€';
            statusMessage.textContent = 'Adminin yeni kartlarÄ± hazÄ±rlayÄ±p yeni sezonu baÅŸlatmasÄ±nÄ± bekle. Takipte kal!';
            statusOverlay.classList.remove('hidden');
            albumContainer.classList.add('hidden');
            grandPrizeDisplay.classList.add('hidden');
            return;
        }
    }
    
    statusOverlay.classList.add('hidden');
    albumContainer.classList.remove('hidden');
    
    const progressSpan = document.getElementById('collectionProgress');
    albumContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">Koleksiyon yÃ¼kleniyor...</p>';

    const masterListRef = db.ref('gameConfig/cardCollection');
    const masterListSnap = await masterListRef.orderByChild('order').once('value');
    
    if (!masterListSnap.exists()) {
        albumContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">YÃ¶netici henÃ¼z bir koleksiyon oluÅŸturmadÄ±.</p>';
        if(progressSpan) progressSpan.textContent = '0/0';
        return;
    }
    const masterList = masterListSnap.val();
    const totalCardCount = Object.keys(masterList).length;

    const userRef = db.ref(`users/${currentUser}`);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val() || {};
    const userCards = userData.cardCollection || {};
    
    // --- JOKER KARTI SAYACINI GÃœNCELLEYEN YENÄ° KOD ---
    const wildcardIndicator = document.getElementById('wildcardIndicator');
    const wildcardCountSpan = document.getElementById('wildcardCount');
    const userWildcards = userData.wildcards || 0;

    if (wildcardIndicator) { // Elementin var olduÄŸundan emin ol
        if (userWildcards > 0 || isAdmin) { // EÄŸer kullanÄ±cÄ±nÄ±n kartÄ± varsa VEYA sen adminsen (test iÃ§in)
            wildcardCountSpan.textContent = userWildcards;
            wildcardIndicator.classList.remove('hidden'); // SayacÄ± gÃ¶rÃ¼nÃ¼r yap
        } else {
            wildcardIndicator.classList.add('hidden'); // KartÄ± yoksa gizli kalsÄ±n
        }
    }
    // --- YENÄ° KOD BÄ°TÄ°ÅÄ° ---

    const userOwnedCardCount = Object.keys(userCards).length;
    if(progressSpan) progressSpan.textContent = `${userOwnedCardCount}/${totalCardCount}`;
    
    albumContainer.innerHTML = ''; 

    for (const cardId in masterList) {
        const cardInfo = masterList[cardId];
        const userHasCard = userCards[cardId];

        const slot = document.createElement('div');
        slot.className = 'card-slot';

        if (userHasCard || isAdmin) { 
            const cardItem = document.createElement('div');
            cardItem.className = `card-item rarity-${cardInfo.rarity || 'normal'}`;
            
            let newBadge = '';
            if (newlyAcquiredCards.has(cardId)) {
                newBadge = `<div class="new-card-badge">YENÄ°</div>`;
            }
            
            let duplicateBadge = userHasCard && userHasCard.count > 1 ? `<div class="duplicate-badge">x${userHasCard.count}</div>` : '';
            let adminCardControls = isAdmin ? `<div class="card-admin-buttons"><button onclick="openCardCreatorModal('${cardId}')" title="DÃ¼zenle">âœï¸</button><button onclick="deleteCard('${cardId}')" title="Sil">ğŸ—‘ï¸</button></div>` : '';
            
            cardItem.innerHTML = `
                ${newBadge}
                ${duplicateBadge}
                ${adminCardControls}
                <img class="card-image" src="${cardInfo.imageUrl}">
                <h4 class="card-name">${cardInfo.cardName}</h4>
            `;
            if (userHasCard && userHasCard.count > 1) { cardItem.onclick = () => openTradeMenu(cardId, cardInfo.cardName); }
            slot.appendChild(cardItem);

        } else {
            let wildcardButton = '';
            if (userWildcards > 0) {
                wildcardButton = `<button class="absolute bottom-2 left-1/2 -translate-x-1/2 w-11/12 py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold text-xs rounded-lg animate-pulse" onclick="useWildcard('${cardId}', '${cardInfo.cardName}')">Joker Kullan</button>`;
            }

            slot.innerHTML = `
                <div class="card-item missing relative">
                    <div class="card-image flex items-center justify-center">
                         <span class="missing-text">?</span>
                    </div>
                    <h4 class="card-name text-gray-500">${cardInfo.cardName}</h4>
                    ${wildcardButton}
                </div>
            `;
        }
        albumContainer.appendChild(slot);
    }
}

// KullanÄ±cÄ± koleksiyonundaki fazla karta tÄ±kladÄ±ÄŸÄ±nda teklif oluÅŸturma penceresini aÃ§ar
function openTradeMenu(cardId, cardName) {
    if (!cardId) return;
    // Teklif penceresini, bu kart Ã¶nceden seÃ§ili olacak ÅŸekilde aÃ§
    openCreateOfferModal(cardId);
}

// JOKER KART KULLANMA FONKSÄ°YONU

async function useWildcard(cardIdToGet, cardNameToGet) {
    if (isAdmin) return;

    const confirmed = await customConfirm(`'${cardNameToGet}' kartÄ±nÄ± tamamlamak iÃ§in 1 Joker Kart kullanmak istediÄŸine emin misin? Bu iÅŸlem geri alÄ±namaz!`);
    if (!confirmed) return;

    const userRef = db.ref('users/' + currentUser);
    
    // GÃ¼venli iÅŸlem iÃ§in transaction kullanÄ±yoruz
    await userRef.transaction(userData => {
        if (userData) {
            // KullanÄ±cÄ±nÄ±n joker kartÄ± olup olmadÄ±ÄŸÄ±nÄ± tekrar kontrol et
            if ((userData.wildcards || 0) > 0) {
                // Joker kart sayÄ±sÄ±nÄ± 1 azalt
                userData.wildcards = userData.wildcards - 1;

                // Koleksiyona yeni kartÄ± ekle
                if (!userData.cardCollection) {
                    userData.cardCollection = {};
                }
                // EÄŸer bu karttan daha Ã¶nce (baÅŸka yolla) kazanmÄ±ÅŸsa sayÄ±sÄ±nÄ± artÄ±r, yoksa 1 olarak ekle
                if (userData.cardCollection[cardIdToGet]) {
                    userData.cardCollection[cardIdToGet].count = (userData.cardCollection[cardIdToGet].count || 0) + 1;
                } else {
                    userData.cardCollection[cardIdToGet] = { count: 1 };
                }
                return userData;
            }
        }
        // EÄŸer joker kartÄ± yoksa veya kullanÄ±cÄ± verisi bulunamazsa, iÅŸlemi iptal et
        return; 
    });

    displayMessage(`Tebrikler! Joker Kart kullanarak '${cardNameToGet}' kartÄ±nÄ± koleksiyonuna ekledin!`);
    loadCollectionAlbum(); // DeÄŸiÅŸikliÄŸi anÄ±nda gÃ¶rmek iÃ§in albÃ¼mÃ¼ yenile
}

let editingCardId = null; // Hangi kartÄ±n dÃ¼zenlendiÄŸini tutar

// Kart oluÅŸturma/dÃ¼zenleme penceresini aÃ§ar
async function openCardCreatorModal(cardId = null) {
    const modal = document.getElementById('cardCreatorModal');
    const title = document.getElementById('cardFormTitle');
    const saveBtn = document.getElementById('saveCardBtn');

    // Formu temizle
    document.getElementById('cardNameInput').value = '';
    document.getElementById('cardImageUrlInput').value = '';
    document.getElementById('cardRarityInput').value = 'normal';

    if (cardId) {
        // EÄŸer bir cardId geldiyse, bu DÃœZENLEME modudur
        editingCardId = cardId;
        title.textContent = 'KartÄ± DÃ¼zenle';
        saveBtn.textContent = 'KARTI GÃœNCELLE';

        // KartÄ±n mevcut bilgilerini Firebase'den Ã§ek ve formu doldur
        const cardSnap = await db.ref(`gameConfig/cardCollection/${cardId}`).once('value');
        const cardData = cardSnap.val();
        if (cardData) {
            document.getElementById('cardNameInput').value = cardData.cardName;
            document.getElementById('cardImageUrlInput').value = cardData.imageUrl;
            document.getElementById('cardRarityInput').value = cardData.rarity;
            // YENÄ° EKLENEN SATIR
            document.getElementById('cardChanceInput').value = cardData.chance || 100; // EÄŸer ÅŸans belirtilmemiÅŸse varsayÄ±lan 100 olsun
        }
    } else {
        // EÄŸer cardId gelmediyse, bu YENÄ° KART EKLEME modudur
        editingCardId = null;
        title.textContent = 'Yeni Kart OluÅŸtur';
        saveBtn.textContent = 'KARTI KAYDET';
    }

    modal.style.display = 'flex';
}

// Kart oluÅŸturma/dÃ¼zenleme penceresini kapatÄ±r
function closeCardCreatorModal() {
    document.getElementById('cardCreatorModal').style.display = 'none';
    editingCardId = null;
}

// Formdaki bilgileri alÄ±p Firebase'e kaydeder veya gÃ¼nceller
async function saveCard() {
    if (!isAdmin) return;

    const cardData = {
        cardName: document.getElementById('cardNameInput').value.trim(),
        imageUrl: document.getElementById('cardImageUrlInput').value.trim(),
        rarity: document.getElementById('cardRarityInput').value,
        // YENÄ° EKLENEN SATIR
        chance: parseInt(document.getElementById('cardChanceInput').value) || 100 // EÄŸer boÅŸ bÄ±rakÄ±lÄ±rsa varsayÄ±lan 100
    };

    if (!cardData.cardName || !cardData.imageUrl) {
        displayMessage("Kart AdÄ± ve Resim URL'si boÅŸ bÄ±rakÄ±lamaz.");
        return;
    }

    if (editingCardId) {
        // Var olan kartÄ± gÃ¼ncelle
        await db.ref(`gameConfig/cardCollection/${editingCardId}`).update(cardData);
        displayMessage("Kart baÅŸarÄ±yla gÃ¼ncellendi.");
    } else {
        // Yeni kart oluÅŸtur
        // KartlarÄ±n sÄ±ralÄ± gÃ¶rÃ¼nmesi iÃ§in bir 'order' alanÄ± ekleyelim
        const collectionRef = db.ref('gameConfig/cardCollection');
        const lastCardSnap = await collectionRef.orderByChild('order').limitToLast(1).once('value');
        let nextOrder = 0;
        if (lastCardSnap.exists()) {
            nextOrder = Object.values(lastCardSnap.val())[0].order + 1;
        }
        cardData.order = nextOrder;

        await collectionRef.push(cardData);
        displayMessage("Yeni kart baÅŸarÄ±yla koleksiyona eklendi.");
    }

    closeCardCreatorModal();
    loadCollectionAlbum(); // DeÄŸiÅŸikliÄŸi anÄ±nda gÃ¶rmek iÃ§in albÃ¼mÃ¼ yenile
}

// Bir kartÄ± koleksiyondan kalÄ±cÄ± olarak siler
async function deleteCard(cardId) {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Bu kartÄ± koleksiyondan kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz? (Bu iÅŸlem kullanÄ±cÄ±larÄ±n ilerlemesini etkilemez, sadece ana listeden kaldÄ±rÄ±r)");
    if (confirmed) {
        await db.ref(`gameConfig/cardCollection/${cardId}`).remove();
        displayMessage("Kart baÅŸarÄ±yla silindi.");
        loadCollectionAlbum(); // DeÄŸiÅŸikliÄŸi anÄ±nda gÃ¶rmek iÃ§in albÃ¼mÃ¼ yenile
    }
}

async function resetWholeCollection() {
    if (!isAdmin) return;
    // Onay mesajÄ± aynÄ± kalabilir, kullanÄ±cÄ± zaten bunu gÃ¶rÃ¼yor.
    const confirmed = await customConfirm("Bu iÅŸlem mevcut tÃ¼m kartlarÄ±, kullanÄ±cÄ± ilerlemelerini ve ÅŸampiyonluklarÄ± SÄ°LEREK yepyeni bir sezon baÅŸlatacaktÄ±r. Emin misiniz?");
    if (confirmed) {
        const updates = {};
        // updates['/gameConfig/cardCollection'] = null; // <<<--- BU SATIR SÄ°LÄ°NDÄ°! ANA KART LÄ°STESÄ° ARTIK GÃœVENDE.
        updates['/gameConfig/collectionWinner'] = null;
        // Ã–dÃ¼lÃ¼ silmek yerine sÄ±fÄ±rlanmasÄ±nÄ± beklemek daha mantÄ±klÄ± olabilir, ama ÅŸimdilik kalsÄ±n.
        // updates['/gameConfig/collectionGrandPrize'] = null; 
        updates['/gameConfig/cardCollectionStatus'] = 'inactive'; 

        const usersSnap = await db.ref('users').once('value');
        if (usersSnap.exists()) {
            usersSnap.forEach(userSnap => {
                const username = userSnap.key;
                // Sadece kullanÄ±cÄ±larÄ±n kart ilerlemesini ve durumunu sÄ±fÄ±rlÄ±yoruz.
                updates[`/users/${username}/cardCollection`] = null;
                updates[`/users/${username}/completedCollection`] = null;
                // Åampiyonluklar bir baÅŸarÄ± olduÄŸu iÃ§in kalÄ±cÄ± olabilir, ama isteÄŸe gÃ¶re bu satÄ±r da kalabilir.
                updates[`/users/${username}/achievements/collectionChampion`] = null;
            });
        }
        await db.ref().update(updates);
        displayMessage("TÃ¼m kullanÄ±cÄ±larÄ±n koleksiyon ilerlemeleri baÅŸarÄ±yla sÄ±fÄ±rlandÄ±. Yeni sezon hazÄ±rlanÄ±yor...");
        loadCollectionAlbum();
    }
}

// =======================================================
// YENÄ° Ã–ZELLÄ°K: PAZAR YÃ–NETÄ°M FONKSÄ°YONLARI
// =======================================================

// Admin, Kartlar sekmesine girdiÄŸinde mevcut pazar ayarlarÄ±nÄ± input'lara yÃ¼kler
async function loadMarketSettingsForAdmin() {
    if (!isAdmin) return;
    const settingsRef = db.ref('gameConfig/marketSettings');
    const settingsSnap = await settingsRef.once('value');
    const settings = settingsSnap.val() || {};

    document.getElementById('tradeFeeInput').value = settings.tradeFee || 0;

    const lockBtn = document.getElementById('marketLockBtn');
    if (settings.isLocked) {
        lockBtn.textContent = 'PazarÄ±n Kilidini AÃ§';
        lockBtn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
        lockBtn.classList.add('bg-green-600', 'hover:bg-green-500');
    } else {
        lockBtn.textContent = 'PazarÄ± Kilitle';
        lockBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
        lockBtn.classList.add('bg-gray-600', 'hover:bg-gray-500');
    }
}

// Input'taki ayarlarÄ± Firebase'e kaydeder
async function saveMarketSettings() {
    if (!isAdmin) return;
    const tradeFee = parseInt(document.getElementById('tradeFeeInput').value);

    if (isNaN(tradeFee) || tradeFee < 0) {
        displayMessage("LÃ¼tfen geÃ§erli bir takas Ã¼creti girin (0 veya daha bÃ¼yÃ¼k bir sayÄ±).");
        return;
    }

    await db.ref('gameConfig/marketSettings/tradeFee').set(tradeFee);
    displayMessage("Pazar ayarlarÄ± baÅŸarÄ±yla kaydedildi.");
}

// PazarÄ±n kilitli olup olmadÄ±ÄŸÄ±nÄ± deÄŸiÅŸtirir
async function toggleMarketLock() {
    if (!isAdmin) return;
    const lockRef = db.ref('gameConfig/marketSettings/isLocked');
    const lockSnap = await lockRef.once('value');
    const isCurrentlyLocked = lockSnap.val() || false;

    await lockRef.set(!isCurrentlyLocked);
    displayMessage(`Takas PazarÄ± baÅŸarÄ±yla ${!isCurrentlyLocked ? 'kilitlendi' : 'aÃ§Ä±ldÄ±'}.`);
    loadMarketSettingsForAdmin(); // Butonun rengini ve yazÄ±sÄ±nÄ± gÃ¼ncelle
}

// Takas geÃ§miÅŸi penceresini aÃ§ar ve kayÄ±tlarÄ± yÃ¼kler
function openTradeHistoryModal() {
    loadTradeHistory();
    document.getElementById('tradeHistoryModal').style.display = 'flex';
}

// Takas geÃ§miÅŸi penceresini kapatÄ±r
function closeTradeHistoryModal() {
    document.getElementById('tradeHistoryModal').style.display = 'none';
}

// Firebase'den takas geÃ§miÅŸini Ã§eker ve listeler
async function loadTradeHistory() {
    const listEl = document.getElementById('tradeHistoryList');
    listEl.innerHTML = '<p class="text-center text-gray-400">YÃ¼kleniyor...</p>';

    const historyRef = db.ref('tradeHistory').orderByChild('timestamp').limitToLast(100);
    const historySnap = await historyRef.once('value');
    const history = historySnap.val();

    if (!history) {
        listEl.innerHTML = '<p class="text-center text-gray-400">HenÃ¼z tamamlanmÄ±ÅŸ bir takas yok.</p>';
        return;
    }

    const sortedHistory = Object.values(history).sort((a, b) => b.timestamp - a.timestamp);

    let html = '';
    sortedHistory.forEach(trade => {
        const date = new Date(trade.timestamp).toLocaleString('tr-TR');
        html += `
            <div class="p-3 bg-gray-900 rounded-lg mb-3">
                <p class="text-white">
                    <b class="text-green-400">${trade.accepter}</b>, 
                    <b class="text-yellow-400">${trade.offerer}</b> adlÄ± kullanÄ±cÄ±dan 
                    <span class="text-cyan-300">'${trade.offeredCardName}'</span> kartÄ±nÄ± alÄ±p karÅŸÄ±lÄ±ÄŸÄ±nda 
                    <span class="text-pink-300">'${trade.requestedCardName}'</span> kartÄ±nÄ± verdi.
                </p>
                <div class="text-xs text-gray-500 mt-1 text-right">${date}</div>
            </div>
        `;
    });
    listEl.innerHTML = html;
}

// =======================================================
// YENÄ° Ã–ZELLÄ°K: TAKAS PAZARI SÄ°STEMÄ° FONKSÄ°YONLARI
// =======================================================

// Takas pazarÄ± ana penceresini aÃ§ar
async function openTradeMarket() {
    // Ã–nce pazarÄ±n kilitli olup olmadÄ±ÄŸÄ±nÄ± kontrol et
    const lockSnap = await db.ref('gameConfig/marketSettings/isLocked').once('value');
    if (lockSnap.val() === true && !isAdmin) {
        displayMessage("Takas PazarÄ± ÅŸu anda bakÄ±m nedeniyle geÃ§ici olarak kapalÄ±dÄ±r.");
        return;
    }

    document.getElementById('tradeMarketModal').style.display = 'flex';
    // VarsayÄ±lan olarak her zaman "Pazardaki Teklifler" sekmesini aÃ§
    switchMarketTab('all');
}

// Takas pazarÄ± ana penceresini kapatÄ±r
function closeTradeMarketModal() {
    // Pazar kapatÄ±ldÄ±ÄŸÄ±nda, arka planda veri Ã§ekmeye devam etmemesi iÃ§in dinleyiciyi durdur.
    if (activeListeners.marketOffers) {
        activeListeners.marketOffers.ref.off('value', activeListeners.marketOffers.callback);
        delete activeListeners.marketOffers;
    }
    document.getElementById('tradeMarketModal').style.display = 'none';
}

// "Pazardaki Teklifler" ve "Benim Tekliflerim" sekmeleri arasÄ±nda geÃ§iÅŸ yapar
function switchMarketTab(tabName) {
    const allTab = document.getElementById('marketTabAll');
    const mineTab = document.getElementById('marketTabMine');
    
    if (tabName === 'all') {
        allTab.classList.add('border-purple-500', 'text-white');
        allTab.classList.remove('border-transparent', 'text-gray-400');
        mineTab.classList.add('border-transparent', 'text-gray-400');
        mineTab.classList.remove('border-purple-500', 'text-white');
        loadMarketOffers('all'); // Herkesin tekliflerini yÃ¼kle
    } else { // 'mine'
        mineTab.classList.add('border-purple-500', 'text-white');
        mineTab.classList.remove('border-transparent', 'text-gray-400');
        allTab.classList.add('border-transparent', 'text-gray-400');
        allTab.classList.remove('border-purple-500', 'text-white');
        loadMarketOffers('mine'); // Sadece benim tekliflerimi yÃ¼kle
    }
}

// Bir takas teklifini kabul eder
async function acceptTradeOffer(tradeId) {
    if (isAdmin) return; // Adminler takas yapamaz

    // 1. AdÄ±m: PazarÄ±n aÃ§Ä±k olup olmadÄ±ÄŸÄ±nÄ± ve takas Ã¼cretini kontrol et
    const marketSettingsSnap = await db.ref('gameConfig/marketSettings').once('value');
    const marketSettings = marketSettingsSnap.val() || {};

    if (marketSettings.isLocked) {
        displayMessage("Takas PazarÄ± ÅŸu anda bakÄ±m nedeniyle geÃ§ici olarak kapalÄ±dÄ±r.");
        return;
    }

    const tradeFee = marketSettings.tradeFee || 0;
    const tradeRef = db.ref(`trades/${tradeId}`);
    const tradeSnap = await tradeRef.once('value');
    const trade = tradeSnap.val();

    // Teklifin hala geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± kontrol et
    if (!trade) {
        displayMessage("Bu takas teklifi artÄ±k geÃ§erli deÄŸil.");
        loadMarketOffers('all'); // Pazar listesini yenile
        return;
    }

    // 2. AdÄ±m: KullanÄ±cÄ±nÄ±n takas iÃ§in yeterli karta ve puana sahip olup olmadÄ±ÄŸÄ±nÄ± kontrol et
    const userRef = db.ref(`users/${currentUser}`);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();
    const userCards = userData.cardCollection || {};

    if (!userCards[trade.requestedCardId] || userCards[trade.requestedCardId].count < 1) {
        displayMessage(`Bu takasÄ± yapabilmek iÃ§in istenen karta sahip olmalÄ±sÄ±n.`);
        return;
    }

    if ((userData.balance || 0) < tradeFee) {
        displayMessage(`Takas iÃ§in gereken ${tradeFee} Puan iÅŸlem Ã¼cretine sahip deÄŸilsin.`);
        return;
    }

    // 3. AdÄ±m: KullanÄ±cÄ±ya onayÄ± iÃ§in bir Ã¶zet gÃ¶ster
    const masterCardsSnap = await db.ref('gameConfig/cardCollection').once('value');
    const masterCards = masterCardsSnap.val();
    const offeredCard = masterCards[trade.offeredCardId];
    const requestedCard = masterCards[trade.requestedCardId];

    const confirmationMessage = `
        <b>${trade.offerer}</b> adlÄ± kullanÄ±cÄ± ile takas yapacaksÄ±n.<br><br>
        VereceÄŸin Kart: <b class="text-red-400">${requestedCard.cardName}</b><br>
        AlacaÄŸÄ±n Kart: <b class="text-green-400">${offeredCard.cardName}</b><br>
        <hr class="border-gray-600 my-2">
        Ä°ÅŸlem Ãœcreti: <b class="text-yellow-400">${tradeFee} Puan</b><br><br>
        OnaylÄ±yor musun?
    `;

    const confirmed = await customConfirm(confirmationMessage);
    if (!confirmed) return;

    // 4. AdÄ±m: GÃ¼venli Takas Ä°ÅŸlemi (Firebase Transaction)
    try {
        await db.ref().transaction(data => {
            if (!data.trades || !data.trades[tradeId]) {
                return; // Teklif artÄ±k mevcut deÄŸilse iÅŸlemi iptal et
            }

            const currentTrade = data.trades[tradeId];
            const accepter = data.users[currentUser];
            const offerer = data.users[currentTrade.offerer];

            // Son kritik kontroller
            if (!accepter || !offerer) return;
            if (!accepter.cardCollection?.[currentTrade.requestedCardId]?.count >= 1) return;
            if (!offerer.cardCollection?.[currentTrade.offeredCardId]?.count > 1) return;
            if ((accepter.balance || 0) < tradeFee) return;

            // KartlarÄ± Transfer Et (Kabul Eden)
            accepter.cardCollection[currentTrade.requestedCardId].count--;
            if (accepter.cardCollection[currentTrade.requestedCardId].count === 0) {
                accepter.cardCollection[currentTrade.requestedCardId] = null;
            }
            if (!accepter.cardCollection[currentTrade.offeredCardId]) {
                accepter.cardCollection[currentTrade.offeredCardId] = { count: 0 };
            }
            accepter.cardCollection[currentTrade.offeredCardId].count++;

            // KartlarÄ± Transfer Et (Teklif Eden)
            offerer.cardCollection[currentTrade.offeredCardId].count--;
            if (!offerer.cardCollection[currentTrade.requestedCardId]) {
                offerer.cardCollection[currentTrade.requestedCardId] = { count: 0 };
            }
            offerer.cardCollection[currentTrade.requestedCardId].count++;

            // Ä°ÅŸlem Ã¼cretini dÃ¼ÅŸ
            accepter.balance = (accepter.balance || 0) - tradeFee;

            // Teklifi sil
            data.trades[tradeId] = null;
            
            return data;
        });

        // 5. AdÄ±m: Aktiviteyi ve geÃ§miÅŸi kaydet
        logActivity('tradeOfferAccepted', currentUser, {
            offerer: trade.offerer,
            offeredCardName: offeredCard.cardName,
            requestedCardName: requestedCard.cardName
        });

        const historyRef = db.ref('tradeHistory').push();
        await historyRef.set({
            offerer: trade.offerer,
            accepter: currentUser,
            offeredCardId: trade.offeredCardId,
            requestedCardId: trade.requestedCardId,
            offeredCardName: offeredCard.cardName,
            requestedCardName: requestedCard.cardName,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        displayMessage("Takas baÅŸarÄ±yla tamamlandÄ±!");
        loadMarketOffers('all');
        if (currentActiveSection === 'cardCollection') {
            loadCollectionAlbum();
        }

    } catch (error) {
        console.error("Takas sÄ±rasÄ±nda hata:", error);
        displayMessage("Takas sÄ±rasÄ±nda bir hata oluÅŸtu veya teklif artÄ±k geÃ§erli deÄŸil. LÃ¼tfen tekrar deneyin.");
        loadMarketOffers('all');
    }
}

// Pazara konulmuÅŸ takas tekliflerini Firebase'den CANLI olarak Ã§eker ve listeler
async function loadMarketOffers(mode) {
    const listEl = document.getElementById('marketOffersList');
    listEl.innerHTML = '<p class="text-center text-gray-400">Teklifler yÃ¼kleniyor...</p>';

    // Ã–nceki "canlÄ±" dinleyiciyi kapat (sekme deÄŸiÅŸtirirken Ã¶nemlidir)
    if (activeListeners.marketOffers) {
        activeListeners.marketOffers.ref.off('value', activeListeners.marketOffers.callback);
    }

    let tradesRef = db.ref('trades');
    if (mode === 'mine') {
        tradesRef = tradesRef.orderByChild('offerer').equalTo(currentUser);
    }

    // Yeni "canlÄ±" dinleyiciyi oluÅŸtur
    const callback = async (tradesSnap) => {
        const [masterCardsSnap, userCardsSnap] = await Promise.all([
            db.ref('gameConfig/cardCollection').once('value'),
            db.ref(`users/${currentUser}/cardCollection`).once('value')
        ]);

        const trades = tradesSnap.val();
        const masterCards = masterCardsSnap.val();
        const userCards = userCardsSnap.val() || {};

        if (!trades || Object.keys(trades).length === 0) {
            listEl.innerHTML = `<p class="text-center text-gray-400">${mode === 'all' ? 'Åu anda pazarda aktif bir takas teklifi bulunmuyor.' : 'HenÃ¼z bir takas teklifi oluÅŸturmadÄ±n.'}</p>`;
            return;
        }

        listEl.innerHTML = ''; // Listeyi temizle
        const sortedTrades = Object.entries(trades).sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));

        for (const [tradeId, trade] of sortedTrades) {
            const offeredCard = masterCards[trade.offeredCardId];
            const requestedCard = masterCards[trade.requestedCardId];

            if (!offeredCard || !requestedCard) continue;

            let actionButton = '';
            if (mode === 'all') {
                const userHasRequestedCard = userCards[trade.requestedCardId] && userCards[trade.requestedCardId].count > 0;
                const isMyOwnOffer = trade.offerer === currentUser;
                
                if (isMyOwnOffer) {
                     actionButton = `<button disabled class="py-2 px-5 bg-gray-600 text-gray-400 rounded-lg text-sm font-bold cursor-not-allowed">Kendi Teklifin</button>`;
                } else {
                     actionButton = `
                        <button onclick="acceptTradeOffer('${tradeId}')" 
                                class="py-2 px-5 rounded-lg text-sm font-bold transition-colors ${userHasRequestedCard ? 'bg-green-600 hover:bg-green-500 text-white' : 'bg-gray-600 text-gray-400 cursor-not-allowed'}"
                                ${!userHasRequestedCard ? 'disabled' : ''}>
                            TakasÄ± Yap
                        </button>
                    `;
                }
            } else { // mode === 'mine'
                actionButton = `<button onclick="cancelTradeOffer('${tradeId}')" class="py-2 px-5 bg-red-700 hover:bg-red-600 rounded-lg font-bold text-sm">Teklifi Ä°ptal Et</button>`;
            }
            
            if (isAdmin && mode === 'all' && trade.offerer !== currentUser) {
                 actionButton += `<button onclick="cancelTradeOffer('${tradeId}', true)" class="ml-2 py-2 px-3 bg-red-800 hover:bg-red-700 rounded-lg text-xs" title="Admin Olarak Ä°ptal Et">X</button>`;
            }

            const offerHtml = `
                <div class="market-offer-card">
                    <div class="market-card-info">
                        <img src="${offeredCard.imageUrl}" alt="${offeredCard.cardName}">
                        <div>
                            <p class="card-name">${offeredCard.cardName}</p>
                            <p class="card-owner">Teklif Sahibi: <b class="text-yellow-400">${trade.offerer}</b></p>
                        </div>
                    </div>
                    <span class="text-2xl font-bold text-gray-500 mx-4">â‡„</span>
                    <div class="market-card-info">
                        <img src="${requestedCard.imageUrl}" alt="${requestedCard.cardName}">
                        <div>
                            <p class="card-name">${requestedCard.cardName}</p>
                            <p class="card-owner">Ä°stenen Kart</p>
                        </div>
                    </div>
                    <div class="ml-auto pl-4">${actionButton}</div>
                </div>
            `;
            listEl.innerHTML += offerHtml;
        }
    };
    
    // Yeni dinleyiciyi aktif dinleyiciler listesine kaydet
    activeListeners.marketOffers = { ref: tradesRef, event: 'value', callback };
    tradesRef.on('value', callback);
}

// Yeni teklif oluÅŸturma penceresini aÃ§ar
async function openCreateOfferModal(preselectedCardId = null) {
    const myCardSelect = document.getElementById('offerMyCardSelect');
    const requestCardSelect = document.getElementById('offerRequestCardSelect');
    myCardSelect.innerHTML = '<option>YÃ¼kleniyor...</option>';
    requestCardSelect.innerHTML = '<option>YÃ¼kleniyor...</option>';

    // Pazar ayarlarÄ±ndan takas Ã¼cretini Ã§ek
    const feeSnap = await db.ref('gameConfig/marketSettings/tradeFee').once('value');
    const tradeFee = feeSnap.val() || 0;
    document.getElementById('tradeFeeInfo').textContent = tradeFee > 0 
        ? `Not: Bu teklifi kabul eden oyuncudan ${tradeFee} Puan iÅŸlem Ã¼creti alÄ±nacaktÄ±r.`
        : `Not: Takas iÅŸlemleri ÅŸu anda Ã¼cretsizdir.`;

    // KullanÄ±cÄ±nÄ±n fazla kartlarÄ±nÄ± ve tÃ¼m kartlarÄ±n listesini aynÄ± anda Ã§ek
    const [userCardsSnap, masterCardsSnap] = await Promise.all([
        db.ref(`users/${currentUser}/cardCollection`).once('value'),
        db.ref('gameConfig/cardCollection').orderByChild('order').once('value')
    ]);

    const userCards = userCardsSnap.val() || {};
    const masterCards = masterCardsSnap.val() || {};

    // 1. "Teklif EttiÄŸim Kart" listesini doldur (sadece count > 1 olanlar)
    myCardSelect.innerHTML = '';
    let hasDuplicates = false;
    for (const cardId in userCards) {
        if (userCards[cardId].count > 1) {
            const cardInfo = masterCards[cardId];
            if (cardInfo) {
                const option = document.createElement('option');
                option.value = cardId;
                option.textContent = cardInfo.cardName;
                myCardSelect.appendChild(option);
                hasDuplicates = true;
            }
        }
    }
    if (!hasDuplicates) {
        myCardSelect.innerHTML = '<option value="">Takas edilecek kartÄ±n yok</option>';
    }
    // EÄŸer koleksiyondan bir kart seÃ§ilerek gelinmiÅŸse, onu otomatik olarak seÃ§ili yap
    if (preselectedCardId) {
        myCardSelect.value = preselectedCardId;
    }

    // 2. "Ä°stediÄŸim Kart" listesini doldur (tÃ¼m kartlar)
    requestCardSelect.innerHTML = '';
    for (const cardId in masterCards) {
        const cardInfo = masterCards[cardId];
        const option = document.createElement('option');
        option.value = cardId;
        option.textContent = cardInfo.cardName;
        requestCardSelect.appendChild(option);
    }
    
    document.getElementById('createOfferModal').style.display = 'flex';
}


// Yeni teklif oluÅŸturma penceresini kapatÄ±r
function closeCreateOfferModal() {
    document.getElementById('createOfferModal').style.display = 'none';
}

// Formdaki bilgileri alÄ±p yeni bir takas teklifi oluÅŸturur
async function submitTradeOffer() {
    const offeredCardId = document.getElementById('offerMyCardSelect').value;
    const requestedCardId = document.getElementById('offerRequestCardSelect').value;

    if (!offeredCardId) {
        displayMessage("Teklif etmek iÃ§in en az bir karttan 2 adet veya daha fazlasÄ±na sahip olmalÄ±sÄ±n.");
        return;
    }

    if (offeredCardId === requestedCardId) {
        displayMessage("Bir kartÄ± kendisiyle takas edemezsin.");
        return;
    }

    const newTrade = {
        offerer: currentUser,
        offeredCardId: offeredCardId,
        requestedCardId: requestedCardId,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    // Yeni loglama fonksiyonunu Ã§aÄŸÄ±rmadan Ã¶nce kart isimlerini almamÄ±z lazÄ±m
    const masterCardsSnap = await db.ref('gameConfig/cardCollection').once('value');
    const masterCards = masterCardsSnap.val();
    const offeredCardName = masterCards[offeredCardId]?.cardName || 'Bilinmeyen Kart';
    const requestedCardName = masterCards[requestedCardId]?.cardName || 'Bilinmeyen Kart';

    // Aktiviteyi logla
    logActivity('tradeOfferCreated', currentUser, {
        offeredCardName: offeredCardName,
        requestedCardName: requestedCardName
    });

    await db.ref('trades').push(newTrade);
    displayMessage("Takas teklifin baÅŸarÄ±yla pazara eklendi!");
    closeCreateOfferModal();
    // PazarÄ± yenilemek iÃ§in "Benim Tekliflerim" sekmesine geÃ§
    switchMarketTab('mine');
}


// Bir takas teklifini iptal eder
async function cancelTradeOffer(tradeId, asAdmin = false) {
    if (!tradeId) return;
    
    const tradeRef = db.ref(`trades/${tradeId}`);
    const tradeSnap = await tradeRef.once('value');
    const tradeData = tradeSnap.val();

    // EÄŸer teklif zaten silinmiÅŸse bir ÅŸey yapma
    if (!tradeData) {
        displayMessage("Bu teklif zaten pazarda mevcut deÄŸil.");
        loadMarketOffers(asAdmin ? 'all' : 'mine');
        return;
    }
    
    if (asAdmin) {
        if (!isAdmin) return; // Sadece adminler bu iÅŸlemi yapabilir
        const confirmed = await customConfirm("Bu teklifi admin olarak zorla iptal etmek istediÄŸinize emin misiniz?");
        if (!confirmed) return;
        
        // Adminin iptal ettiÄŸini logla
        const masterCardsSnap = await db.ref('gameConfig/cardCollection').once('value');
        const masterCards = masterCardsSnap.val();
        const offeredCardName = masterCards[tradeData.offeredCardId]?.cardName || 'Bilinmeyen Kart';
        
        logActivity('tradeOfferCancelledByAdmin', 'WeizendTv', { 
            offerer: tradeData.offerer, 
            offeredCardName: offeredCardName 
        });
        
        await tradeRef.remove();
        displayMessage("Teklif admin tarafÄ±ndan iptal edildi.");
        loadMarketOffers('all'); // Admin olduÄŸu iÃ§in tÃ¼m pazar listesini yenile

    } else {
        // KullanÄ±cÄ±nÄ±n kendi teklifini iptal etmesi
        if (tradeData.offerer === currentUser) {
            const confirmed = await customConfirm("Bu takas teklifini pazardan kaldÄ±rmak istediÄŸinizden emin misiniz?");
            if (!confirmed) return;
            
            // Not: Kart oluÅŸturulduÄŸunda envanterden dÃ¼ÅŸÃ¼lmediÄŸi iÃ§in, iptal edildiÄŸinde de iadeye gerek yoktur.
            // Sadece teklifin kendisi silinir.
            
            await tradeRef.remove();
            displayMessage("Teklifin pazardan kaldÄ±rÄ±ldÄ±.");
            loadMarketOffers('mine'); // KullanÄ±cÄ±nÄ±n kendi teklif listesini yenile
        }
    }
}

// =======================================================
// YENÄ° Ã–ZELLÄ°K: KART PAKETÄ° AÃ‡MA SEREMONÄ°SÄ°
// =======================================================
let packsToReveal = [];
let packsRevealedCount = 0;

async function startCardPackOpening(packCount, source = 'Bilinmeyen Kaynak', multiplier = 1, packType = 'card_pack') {
    if (packCount <= 0) return;
    
    if (packType === 'card_pack') {
        const userSnapCheck = await db.ref(`users/${currentUser}`).once('value');
        const userDataCheck = userSnapCheck.val();
        if (userDataCheck.completedCollection === true) {
            const pointsToGain = packCount * 500;
            const newBalance = (userDataCheck.balance || 0) + pointsToGain;
            const newKariyerPuani = (userDataCheck.kariyerPuani || 0) + pointsToGain;

            await db.ref(`users/${currentUser}`).update({
                balance: newBalance,
                kariyerPuani: newKariyerPuani
            });
            logActivity('cardPackConverted', currentUser, { 
                source: source, packs: packCount, points: pointsToGain, 
                newBalance: newBalance, multiplier: multiplier
            });
            displayMessage(`Tebrikler! Koleksiyonu zaten tamamladÄ±ÄŸÄ±n iÃ§in kazandÄ±ÄŸÄ±n ${packCount} Kart Paketi, hesabÄ±na <b class="text-green-400">+${pointsToGain} Puan</b> olarak eklendi!`);
            return;
        }
    }

    const masterCardsSnap = await db.ref('gameConfig/cardCollection').once('value');
    const masterCards = masterCardsSnap.val();
    if (!masterCards) {
        displayMessage("Kart paketi aÃ§Ä±lamadÄ±: Oyunda hiÃ§ kart tanÄ±mlanmamÄ±ÅŸ.");
        return;
    }

    let cardPool = [];
    const rarityMap = {
        'card_pack_efsanevi': 'efsanevi',
        'card_pack_altin': 'altin',
        'card_pack_gumus': 'gumus',
        'card_pack_normal': 'normal'
    };
    const targetRarity = rarityMap[packType];

    for (const cardId in masterCards) {
        const card = { id: cardId, ...masterCards[cardId] };
        if (targetRarity) {
            if (card.rarity === targetRarity) {
                cardPool.push(card);
            }
        } else {
            cardPool.push(card);
        }
    }
    
    if (cardPool.length === 0) {
        displayMessage(`Bu paketten kart Ã§Ä±kmadÄ± Ã§Ã¼nkÃ¼ oyunda hiÃ§ '${targetRarity}' nadirlikte kart tanÄ±mlanmamÄ±ÅŸ. Telafi olarak +500 Puan kazandÄ±n!`);
        const userRef = db.ref(`users/${currentUser}`);
        await userRef.transaction(user => {
            if (user) {
                user.balance = (user.balance || 0) + 500;
                user.kariyerPuani = (user.kariyerPuani || 0) + 500;
            }
            return user;
        });
        return;
    }

    const weightedCardList = [];
    let totalWeight = 0;
    cardPool.forEach(card => {
        const chance = card.chance || 1;
        weightedCardList.push({ ...card, chance: chance });
        totalWeight += chance;
    });

    if (totalWeight === 0) {
        displayMessage("Kart paketi aÃ§Ä±lamadÄ±: KartlarÄ±n ÅŸans aÄŸÄ±rlÄ±klarÄ± toplamÄ± sÄ±fÄ±r.");
        return;
    }

    packsToReveal = [];
    packsRevealedCount = 0;

    for (let i = 0; i < packCount; i++) {
        let randomWeight = Math.random() * totalWeight;
        let chosenCard = null;
        for (const card of weightedCardList) {
            randomWeight -= card.chance;
            if (randomWeight <= 0) {
                chosenCard = card;
                break;
            }
        }
        packsToReveal.push(chosenCard || weightedCardList[weightedCardList.length - 1]);
    }

    const modal = document.getElementById('cardPackOpeningModal');
    const area = document.getElementById('cardPackOpeningArea');
    const title = document.getElementById('cardPackOpeningTitle');
    title.textContent = `${packCount} Kart Paketini AÃ§!`;
    area.innerHTML = '';

    // --- YENÄ° GÃ–RSEL OLUÅTURMA MANTIÄI BURADA ---
    const packInfoMap = {
        'card_pack_efsanevi': { className: 'pack-front-efsanevi', icon: 'ğŸ†' },
        'card_pack_altin': { className: 'pack-front-altin', icon: 'ğŸ¥‡' },
        'card_pack_gumus': { className: 'pack-front-gumus', icon: 'ğŸ¥ˆ' },
        'card_pack_normal': { className: 'pack-front-normal', icon: 'ğŸ¥‰' },
        'card_pack': { className: 'pack-front-standart', icon: 'ğŸ´' }
    };
    const packInfo = packInfoMap[packType] || packInfoMap['card_pack'];

    for (let i = 0; i < packCount; i++) {
        const cardHtml = `
            <div class="card-flip-container" data-index="${i}" onclick="revealCard(this)">
                <div class="card-flipper">
                    <div class="card-front ${packInfo.className}">
                        <span class="pack-icon">${packInfo.icon}</span>
                    </div>
                    <div class="card-back"></div>
                </div>
            </div>
        `;
        area.innerHTML += cardHtml;
    }
    // --- YENÄ° GÃ–RSEL OLUÅTURMA SONU ---

    modal.style.display = 'flex';
}

async function revealCard(cardElement) {
    if (cardElement.classList.contains('flipped')) return; 

    cardElement.classList.add('flipped');
    const index = cardElement.getAttribute('data-index');
    const wonCard = packsToReveal[index];

    const cardBack = cardElement.querySelector('.card-back');
    const cardItemHtml = `
        <div class="card-item rarity-${wonCard.rarity || 'normal'}" style="width:100%; height:100%;">
            <img class="card-image" src="${wonCard.imageUrl}">
            <h4 class="card-name">${wonCard.cardName}</h4>
        </div>
    `;
    cardBack.innerHTML = cardItemHtml;

    // --- YENÄ° EKLENEN KISIM BAÅLANGICI ---
    // KullanÄ±cÄ±nÄ±n ilk kartÄ±nÄ± aldÄ±ÄŸÄ± anÄ± kaydetmek iÃ§in Transaction kullanÄ±yoruz.
    const userRef = db.ref(`users/${currentUser}`);
    await userRef.transaction(userData => {
        if (userData) {
            // EÄŸer kullanÄ±cÄ±nÄ±n daha Ã¶nce hiÃ§ kartÄ± yoksa, ilk kart zaman damgasÄ±nÄ± ekle
            if (!userData.cardCollection) {
                userData.cardCollection = {};
                // SÄ±ralama iÃ§in gereken zaman damgasÄ±nÄ± ekliyoruz
                if (!userData.collectionInfo) {
                    userData.collectionInfo = {};
                }
                userData.collectionInfo.firstCardTimestamp = firebase.database.ServerValue.TIMESTAMP;
            }
            
            // Kart sayÄ±sÄ±nÄ± artÄ±r
            if (!userData.cardCollection[wonCard.id]) {
                userData.cardCollection[wonCard.id] = { count: 0 };
            }
            userData.cardCollection[wonCard.id].count++;
        }
        return userData;
    });
    // --- YENÄ° EKLENEN KISIM SONU ---
    
    newlyAcquiredCards.add(wonCard.id); // KartÄ± "yeni" olarak iÅŸaretle

    packsRevealedCount++;
    
    if (packsRevealedCount >= packsToReveal.length) {
        checkAndGrantPrize(currentUser); 
        setTimeout(() => {
            document.getElementById('cardPackOpeningModal').style.display = 'none';
            if (currentActiveSection === 'cardCollection') {
                loadCollectionAlbum();
            }
        }, 2000); 
    }
}

async function saveGrandPrize() {
    if (!isAdmin) return;
    const prizeData = {
        points: parseInt(document.getElementById('prizePoints').value) || 0,
        boxRights: parseInt(document.getElementById('prizeBoxRights').value) || 0,
        iflasShields: parseInt(document.getElementById('prizeIflasShields').value) || 0, // DEÄÄ°ÅTÄ°
        wheelTickets: parseInt(document.getElementById('prizeWheelTickets').value) || 0,
        clickCatchTickets: parseInt(document.getElementById('prizeClickCatchTickets').value) || 0,
        avatarName: document.getElementById('prizeAvatarName').value.trim() || '', // YENÄ° EKLENDÄ°
        avatarImageUrl: document.getElementById('prizeAvatarImageUrl').value.trim() || '', // YENÄ° EKLENDÄ°
        description: document.getElementById('prizeDescription').value.trim() || ''
    };

    await db.ref('gameConfig/collectionGrandPrize').set(prizeData);
    displayMessage("BÃ¼yÃ¼k Ã–dÃ¼l baÅŸarÄ±yla kaydedildi!");
    loadGrandPrizeDisplay();
}

async function loadPrizeSettingsForAdmin() {
    if (!isAdmin) return;
    const prizeSnap = await db.ref('gameConfig/collectionGrandPrize').once('value');
    const prizeData = prizeSnap.val() || {};
    
    document.getElementById('prizePoints').value = prizeData.points || '';
    document.getElementById('prizeBoxRights').value = prizeData.boxRights || '';
    document.getElementById('prizeIflasShields').value = prizeData.iflasShields || ''; // DEÄÄ°ÅTÄ°
    document.getElementById('prizeWheelTickets').value = prizeData.wheelTickets || '';
    document.getElementById('prizeClickCatchTickets').value = prizeData.clickCatchTickets || '';
    document.getElementById('prizeAvatarName').value = prizeData.avatarName || ''; // YENÄ° EKLENDÄ°
    document.getElementById('prizeAvatarImageUrl').value = prizeData.avatarImageUrl || ''; // YENÄ° EKLENDÄ°
    document.getElementById('prizeDescription').value = prizeData.description || '';
}

async function loadGrandPrizeDisplay() {
    const prizeRef = db.ref('gameConfig/collectionGrandPrize');
    const prizeSnap = await prizeRef.once('value');
    const prizeData = prizeSnap.val();
    
    const displayContainer = document.getElementById('grandPrizeDisplay');
    const prizeList = document.getElementById('prizeList');

    // DEÄÄ°ÅEN KONTROL: Yeni alanlarÄ± da kontrol et
    if (!prizeData || (prizeData.points === 0 && prizeData.boxRights === 0 && prizeData.iflasShields === 0 && prizeData.wheelTickets === 0 && prizeData.clickCatchTickets === 0 && prizeData.avatarName === '' && prizeData.description === '')) {
        displayContainer.classList.add('hidden');
        return;
    }

    prizeList.innerHTML = '';
    if (prizeData.points > 0) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ’° ${formatNumber(prizeData.points)} Puan</div>`;
    if (prizeData.boxRights > 0) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ ${formatNumber(prizeData.boxRights)} Kutu HakkÄ±</div>`;
    if (prizeData.iflasShields > 0) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ›¡ï¸ ${formatNumber(prizeData.iflasShields)} Ä°flas KalkanÄ±</div>`; // DEÄÄ°ÅTÄ°
    if (prizeData.wheelTickets > 0) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ¡ ${formatNumber(prizeData.wheelTickets)} Ã‡ark Bileti</div>`;
    if (prizeData.clickCatchTickets > 0) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸŸï¸ ${formatNumber(prizeData.clickCatchTickets)} T-Y Bileti</div>`;
    if (prizeData.avatarName) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ‘¤ Ã–zel Avatar: ${prizeData.avatarName}</div>`; // YENÄ° EKLENDÄ°
    if (prizeData.description) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ† ${prizeData.description}</div>`;
    
    displayContainer.classList.remove('hidden');
}

async function checkAndGrantPrize(username) {
    const userRef = db.ref(`users/${username}`);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();

    if (userData.completedCollection === true) {
        return; 
    }

    const userCards = userData.cardCollection || {};
    const ownedCardCount = Object.keys(userCards).length;

    const masterListSnap = await db.ref('gameConfig/cardCollection').once('value');
    const masterList = masterListSnap.val();
    if (!masterList) return;
    const totalCardCount = Object.keys(masterList).length;

    if (ownedCardCount >= totalCardCount) {
        const prizeSnap = await db.ref('gameConfig/collectionGrandPrize').once('value');
        const prizeData = prizeSnap.val();
        if (!prizeData) return;

        // --- YENÄ° EKLENEN KISIM BAÅLANGICI ---
        // Koleksiyonu tamamlayan ilk kiÅŸi mi, onu kontrol et
        const finishersRef = db.ref('gameStats/collectionFinishers');
        const finishersSnap = await finishersRef.once('value');
        const isFirstWinner = !finishersSnap.exists();

        // Her bitireni listeye ekle
        await finishersRef.push({
            username: username,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        // --- YENÄ° EKLENEN KISIM SONU ---

        const updates = {};
        updates.balance = (userData.balance || 0) + (prizeData.points || 0);
        updates.kutuHakki = (userData.kutuHakki || 0) + (prizeData.boxRights || 0);
        updates.iflasShieldUses = (userData.iflasShieldUses || 0) + (prizeData.iflasShields || 0);
        updates.carkBileti = (userData.carkBileti || 0) + (prizeData.wheelTickets || 0);
        updates.clickCatchTickets = (userData.clickCatchTickets || 0) + (prizeData.clickCatchTickets || 0);
        updates.completedCollection = true;

        if (prizeData.avatarName && prizeData.avatarImageUrl) {
            const newAvatarId = db.ref().push().key; 
            updates[`avatars/${newAvatarId}`] = {
                id: newAvatarId,
                name: prizeData.avatarName,
                imageUrl: prizeData.avatarImageUrl
            };
        }
        
        await userRef.child('collectionChampionshipsWon').transaction(currentCount => {
            return (currentCount || 0) + 1;
        });

        await userRef.update(updates);

        let prizeMessage = ``;
        if (isFirstWinner) {
            prizeMessage += `Ä°NANILMAZ! Koleksiyonu tamamlayan Ä°LK KÄ°ÅÄ° oldun ve bÃ¼yÃ¼k Ã¶dÃ¼lleri kazandÄ±n:`;
        } else {
            prizeMessage += `TEBRÄ°KLER! TÃ¼m koleksiyonu tamamladÄ±n ve bÃ¼yÃ¼k Ã¶dÃ¼lleri kazandÄ±n:`;
        }
        
        let prizeParts = [];
        if (prizeData.points > 0) prizeParts.push(` ${formatNumber(prizeData.points)} Puan`);
        if (prizeData.boxRights > 0) prizeParts.push(` ${formatNumber(prizeData.boxRights)} Kutu HakkÄ±`);
        if (prizeData.iflasShields > 0) prizeParts.push(` ${formatNumber(prizeData.iflasShields)} Ä°flas KalkanÄ±`);
        if (prizeData.wheelTickets > 0) prizeParts.push(` ${formatNumber(prizeData.wheelTickets)} Ã‡ark Bileti`);
        if (prizeData.clickCatchTickets > 0) prizeParts.push(` ${formatNumber(prizeData.clickCatchTickets)} T-Y Bileti`);
        if (prizeData.avatarName) prizeParts.push(` '${prizeData.avatarName}' AvatarÄ±`);
        
        prizeMessage += prizeParts.join(',');

        if (prizeData.description) {
            prizeMessage += ` ve "${prizeData.description}" unvanÄ±!`;
        } else {
            prizeMessage += `!`;
        }
        
        displayMessage(prizeMessage);

        logActivity('collectionCompleted', username, { 
            prizeText: prizeData.description || 'BÃ¼yÃ¼k Ã–dÃ¼l',
            isFirst: isFirstWinner 
        });
    }
}

async function loadCollectionFinishers() {
    const leaderboardContainer = document.getElementById('collectionFinishersLeaderboard');
    const listEl = document.getElementById('finishersList');
    listEl.innerHTML = '<p class="text-gray-400">SÄ±ralama yÃ¼kleniyor...</p>';

    const finishersRef = db.ref('gameStats/collectionFinishers').orderByChild('timestamp');

    finishersRef.on('value', async (snapshot) => {
        if (!snapshot.exists()) {
            leaderboardContainer.classList.add('hidden');
            return;
        }

        // Gerekli tÃ¼m verileri tek seferde ve en baÅŸta Ã§ekiyoruz
        const [masterCardsSnap, allUsersSnap] = await Promise.all([
            db.ref('gameConfig/cardCollection').once('value'),
            db.ref('users').once('value')
        ]);
        
        const masterCards = masterCardsSnap.val() || {};
        const allUsersData = allUsersSnap.val() || {};
        const totalCardCount = Object.keys(masterCards).length;

        leaderboardContainer.classList.remove('hidden');
        const finishers = [];
        snapshot.forEach(childSnapshot => {
            finishers.push(childSnapshot.val());
        });

        let html = '';
        finishers.forEach((finisher, index) => {
            const rank = index + 1;
            const rankIcon = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : `${rank}.`));
            const rowClass = rank === 1 ? 'bg-amber-800/50 border-amber-500' : 'bg-gray-700/50 border-gray-600';
            
            // KullanÄ±cÄ±nÄ±n kart bilgilerini al
            const userData = allUsersData[finisher.username] || {};
            const ownedCardCount = Object.keys(userData.cardCollection || {}).length;

            let progressHtml = '';
            // TamamlamÄ±ÅŸsa "TamamlandÄ±" yaz
            if (ownedCardCount >= totalCardCount) {
                progressHtml = `<span class="font-bold text-green-400">TamamlandÄ±</span>`;
            } else {
            // TamamlamamÄ±ÅŸsa ilerlemesini gÃ¶ster ve tÄ±klanabilir yap
                progressHtml = `
                    <span class="font-bold text-yellow-300 cursor-pointer hover:underline" onclick="openMissingCardsModal('${finisher.username}')">
                        ${ownedCardCount}/${totalCardCount}
                    </span>
                `;
            }

            html += `
                <div class="flex items-center justify-between p-3 rounded-lg border ${rowClass}">
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-xl w-8 text-center">${rankIcon}</span>
                        <span class="text-lg text-white cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${finisher.username}')">
                            ${finisher.username}
                        </span>
                    </div>
                    <div class="text-right">
                        ${progressHtml}
                        <div class="text-xs text-gray-400 mt-1">${new Date(finisher.timestamp).toLocaleString('tr-TR')}</div>
                    </div>
                </div>
            `;
        });
        listEl.innerHTML = html;
    });
}

// YENÄ° EKLENECEK FONKSÄ°YONLAR BAÅLANGICI

// Eksik kartlar penceresini kapatÄ±r
function closeMissingCardsModal() {
    document.getElementById('missingCardsModal').style.display = 'none';
}

// Bir kullanÄ±cÄ±nÄ±n eksik kartlarÄ±nÄ± gÃ¶steren pencereyi aÃ§ar
async function openMissingCardsModal(username) {
    const modal = document.getElementById('missingCardsModal');
    const title = document.getElementById('missingCardsTitle');
    const listEl = document.getElementById('missingCardsList');
    
    title.textContent = `${username}'nin Eksik KartlarÄ±`;
    listEl.innerHTML = '<p class="text-center col-span-full text-gray-400">YÃ¼kleniyor...</p>';
    modal.style.display = 'flex';

    try {
        // Gerekli tÃ¼m verileri aynÄ± anda Ã§ekelim
        const [masterCardsSnap, userSnap] = await Promise.all([
            db.ref('gameConfig/cardCollection').orderByChild('order').once('value'),
            db.ref(`users/${username}`).once('value')
        ]);

        if (!masterCardsSnap.exists()) {
            listEl.innerHTML = '<p class="text-center col-span-full text-red-500">Hata: Ana kart listesi bulunamadÄ±.</p>';
            return;
        }

        const masterCards = masterCardsSnap.val();
        const userData = userSnap.val() || {};
        const userCards = userData.cardCollection || {};
        
        const missingCards = [];
        // Ana listedeki her kartÄ± kontrol et
        for (const cardId in masterCards) {
            // EÄŸer kart kullanÄ±cÄ±nÄ±n koleksiyonunda yoksa, eksik listesine ekle
            if (!userCards[cardId]) {
                missingCards.push(masterCards[cardId]);
            }
        }
        
        if (missingCards.length === 0) {
            listEl.innerHTML = '<p class="text-center col-span-full text-green-400 font-bold text-xl">Bu kullanÄ±cÄ± koleksiyonu tamamlamÄ±ÅŸ!</p>';
            return;
        }

        let html = '';
        missingCards.forEach(cardInfo => {
            // Eksik kartlarÄ± da albÃ¼mdeki gibi gÃ¶sterelim
            html += `
                <div class="card-slot">
                    <div class="card-item missing relative" style="border-style: solid; background-color: #1f2937;">
                        <img class="card-image" src="${cardInfo.imageUrl}">
                        <h4 class="card-name">${cardInfo.cardName}</h4>
                    </div>
                </div>
            `;
        });
        listEl.innerHTML = html;

    } catch (error) {
        console.error("Eksik kartlar yÃ¼klenirken hata:", error);
        listEl.innerHTML = '<p class="text-center col-span-full text-red-500">Veriler yÃ¼klenirken bir hata oluÅŸtu.</p>';
    }
}
// YENÄ° EKLENECEK FONKSÄ°YONLAR SONU

function openCollectionInfoModal() {
    document.getElementById('collectionInfoModal').style.display = 'flex';
}

function closeCollectionInfoModal() {
    document.getElementById('collectionInfoModal').style.display = 'none';
}

// MEVCUT openUserProfile FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
async function openUserProfile(username) {
    if (!username) {
        console.error("Profil aÃ§ma hatasÄ±: KullanÄ±cÄ± adÄ± belirtilmedi.");
        return;
    }

    const modal = document.getElementById('userProfileModal');
    if (!modal) {
        console.error("Profil aÃ§ma hatasÄ±: userProfileModal elementi bulunamadÄ±.");
        return;
    }

    // Modal iÃ§eriÄŸini temizle ve yÃ¼kleniyor gÃ¶stergesi ekle
    document.getElementById('profileUsername').textContent = 'YÃ¼kleniyor...';
    document.getElementById('profileAvatar').src = 'default_avatar.png'; // VarsayÄ±lan avatar
    document.getElementById('profileBalance').textContent = '...';
    document.getElementById('profileKutuHakki').textContent = '...';
    document.getElementById('profileCarkBileti').textContent = '...';
    document.getElementById('profileClickCatchTickets').textContent = '...';
    document.getElementById('profileIflasShield').textContent = '...';
    document.getElementById('profileKariyerPuani').textContent = '...';
    document.getElementById('profileAchievementsSection').classList.add('hidden');
    document.getElementById('profileAchievementsList').innerHTML = '';
    
    modal.style.display = 'flex'; // Ã–nce modalÄ± gÃ¶ster

    const userSnap = await db.ref('users/' + username).once('value');
    const user = userSnap.val();

    if (!user) {
        displayMessage(`${username} adlÄ± kullanÄ±cÄ± bulunamadÄ±.`);
        closeUserProfileModal(); // KullanÄ±cÄ± yoksa modalÄ± kapat
        return;
    }

    document.getElementById('profileUsername').textContent = username;
    document.getElementById('profileAvatar').src = user.avatarUrl || 'default_avatar.png';
    document.getElementById('profileBalance').textContent = formatNumber(user.balance || 0);
    document.getElementById('profileKutuHakki').textContent = formatNumber(user.kutuHakki || 0);
    document.getElementById('profileCarkBileti').textContent = formatNumber(user.carkBileti || 0);
    document.getElementById('profileClickCatchTickets').textContent = formatNumber(user.clickCatchTickets || 0);
    document.getElementById('profileIflasShield').textContent = formatNumber(user.iflasShieldUses || 0);
    document.getElementById('profileKariyerPuani').textContent = formatNumber(user.kariyerPuani || 0);

    // BaÅŸarÄ±mlar bÃ¶lÃ¼mÃ¼nÃ¼ yÃ¶net
    const achievementsSection = document.getElementById('profileAchievementsSection');
    const achievementsList = document.getElementById('profileAchievementsList');
    if (user.achievements && Object.keys(user.achievements).length > 0) {
        achievementsList.innerHTML = '';
        for(const key in user.achievements) {
            achievementsList.innerHTML += `<li>${user.achievements[key]}</li>`;
        }
        achievementsSection.classList.remove('hidden');
    } else {
        achievementsSection.classList.add('hidden');
    }

    // Admin kontrol butonlarÄ±nÄ± ayarla
    const adminControls = document.getElementById('adminProfileControls');
    if (isAdmin && adminControls) {
        adminControls.classList.remove('hidden');
        adminControls.innerHTML = `
            <input type="number" id="adminPointsInput" class="box-setting-input" placeholder="Puan Ekle/Ã‡Ä±kar">
            <button onclick="adjustUserPoints('${username}')" class="py-2 px-4 bg-green-600 rounded-lg">Uygula</button>
            <input type="number" id="adminKasaPointsInput" class="box-setting-input" placeholder="Kasa PuanÄ± Ekle/Ã‡Ä±kar">
            <button onclick="adjustUserKasaPoints('${username}')" class="py-2 px-4 bg-blue-600 rounded-lg">Uygula</button>
        `;
    }
}

// BÃ¼yÃ¼k Ã–dÃ¼l AyarlarÄ± modalÄ±nÄ± aÃ§ar
function openGrandPrizeSettings() {
    if (!isAdmin) return;
    loadPrizeSettingsForAdmin(); // KayÄ±tlÄ± ayarlarÄ± input'lara yÃ¼kle
    document.getElementById('grandPrizeSettingsModal').style.display = 'flex';
}

// BÃ¼yÃ¼k Ã–dÃ¼l AyarlarÄ± modalÄ±nÄ± kapatÄ±r
function closeGrandPrizeSettingsModal() {
    document.getElementById('grandPrizeSettingsModal').style.display = 'none';
}

// Ã–dÃ¼lÃ¼ kaydeder VE modalÄ± kapatÄ±r
async function saveGrandPrizeAndCloseModal() {
    await saveGrandPrize(); // Zaten var olan kaydetme fonksiyonunu Ã§aÄŸÄ±r
    closeGrandPrizeSettingsModal(); // ModalÄ± kapat
}

// Yeni sezonu baÅŸlatÄ±r. Ã–nce her ÅŸeyi sÄ±fÄ±rlar, sonra sezonu "aktif" yapar.
async function startNewCollection() {
    if(!isAdmin) return;
    const confirmed = await customConfirm("Bu iÅŸlem mevcut tÃ¼m kartlarÄ±, kullanÄ±cÄ± ilerlemelerini ve ÅŸampiyonluklarÄ± SÄ°LEREK yepyeni bir sezon baÅŸlatacaktÄ±r. Emin misiniz?");
    if(!confirmed) return;
    
    // resetWholeCollection fonksiyonu artÄ±k her ÅŸeyi siliyor ve durumu 'inactive' yapÄ±yor.
    await resetWholeCollection();
    
    // Åimdi yeni sezonu 'aktif' olarak iÅŸaretleyelim.
    await db.ref('gameConfig/cardCollectionStatus').set('active');
    displayMessage("YENÄ° KOLEKSÄ°YON SEZONU BAÅLATILDI!");
}

// Sezonu duraklatÄ±r veya devam ettirir.
async function toggleCollectionPause() {
    if(!isAdmin) return;
    const statusRef = db.ref('gameConfig/cardCollectionStatus');
    const statusSnap = await statusRef.once('value');
    const currentStatus = statusSnap.val();

    if(currentStatus === 'active') {
        await statusRef.set('paused');
        displayMessage("Koleksiyon sezonu duraklatÄ±ldÄ±. Oyuncular bakÄ±m bilgilendirmesi gÃ¶recek.");
    } else if (currentStatus === 'paused') {
        await statusRef.set('active');
        displayMessage("Koleksiyon sezonu devam ettiriliyor.");
    } else {
        displayMessage("Sezon sadece 'aktif' veya 'duraklatÄ±lmÄ±ÅŸ' durumdayken bu iÅŸlem yapÄ±labilir.");
    }
}

// EKSÄ°K OLAN VE EKLENMESÄ° GEREKEN FONKSÄ°YON
function formatNumber(num) {
  // Bu fonksiyon sayÄ±larÄ± 1.000, 10.000 gibi daha okunaklÄ± hale getirir.
  if (num === null || num === undefined) {
    return 0;
  }
  return num.toLocaleString('tr-TR');
}

      // YENÄ° EKLENEN SEZONU BÄ°TÄ°RME FONKSÄ°YONU
async function endCurrentSeason() {
    if (!isAdmin) return;

    const confirmed = await customConfirm("Bu iÅŸlem mevcut sezonu sonlandÄ±racak. TÃ¼m kullanÄ±cÄ±larÄ±n topladÄ±ÄŸÄ± kartlar, joker kartlarÄ± ve koleksiyon tamamlama durumlarÄ± sÄ±fÄ±rlanacak. ANA KART LÄ°STENÄ°Z SÄ°LÄ°NMEZ. Emin misiniz?");
    if (!confirmed) return;

    try {
        const updates = {};
        
        updates['/gameConfig/cardCollectionStatus'] = 'inactive';
        updates['/gameConfig/collectionWinner'] = null;

        const usersSnap = await db.ref('users').once('value');
        if (usersSnap.exists()) {
            usersSnap.forEach(userSnap => {
                const username = userSnap.key;
                updates[`/users/${username}/cardCollection`] = null;
                updates[`/users/${username}/completedCollection`] = null;
                // EKSÄ°K OLANI EKLEDÄ°K: Joker kartlarÄ± da sÄ±fÄ±rlanÄ±yor
                updates[`/users/${username}/wildcards`] = 0; 
            });
        }
        
        await db.ref().update(updates);

        displayMessage("Sezon baÅŸarÄ±yla bitirildi! TÃ¼m kullanÄ±cÄ±larÄ±n kart ilerlemesi sÄ±fÄ±rlandÄ±.");
        loadCollectionAlbum();

    } catch (error) {
        console.error("Sezon bitirilirken hata oluÅŸtu:", error);
        displayMessage("Sezon bitirilirken bir hata meydana geldi.");
    }
}

// Kasa AyarlarÄ± penceresini aÃ§ar ve mevcut ayarÄ± input'a yazar
async function openKasaSettingsModal() {
    if (!isAdmin) return;
    const settingsSnap = await db.ref('gameConfig/kasaSettings').once('value');
    const minAmount = settingsSnap.val()?.minTransferAmount || 0;
    document.getElementById('minKasaTransferInput').value = minAmount;
    document.getElementById('kasaSettingsModal').style.display = 'flex';
}

// Kasa AyarlarÄ± penceresini kapatÄ±r
function closeKasaSettingsModal() {
    document.getElementById('kasaSettingsModal').style.display = 'none';
}

// Kasa AyarlarÄ±nÄ± Firebase'e kaydeder
async function saveKasaSettings() {
    if (!isAdmin) return;
    const minAmount = parseInt(document.getElementById('minKasaTransferInput').value);

    if (isNaN(minAmount) || minAmount < 0) {
        displayMessage("LÃ¼tfen geÃ§erli bir minimum tutar girin (0 veya daha bÃ¼yÃ¼k bir sayÄ±).");
        return;
    }

    await db.ref('gameConfig/kasaSettings/minTransferAmount').set(minAmount);
    displayMessage(`Minimum kasa transfer tutarÄ± baÅŸarÄ±yla ${minAmount} olarak ayarlandÄ±.`);
    closeKasaSettingsModal();
}

// --- YENÄ° Ã‡ARPAN SEÃ‡Ä°M SÄ°STEMÄ° FONKSÄ°YONLARI ---

// Hangi seÃ§imin beklendiÄŸini tutan global deÄŸiÅŸken
let pendingMultiplierChoice = null;

// SeÃ§im penceresini aÃ§ar ve iÃ§ini doldurur
function openMultiplierChoiceModal(existingMultiplier, foundMultiplier, boxId) {
    const modal = document.getElementById('multiplierChoiceModal');
    const infoEl = document.getElementById('multiplierChoiceInfo');
    const convertBtn = document.getElementById('choiceConvertBtn');
    const combineBtn = document.getElementById('choiceCombineBtn');

    // Bekleyen seÃ§imi global deÄŸiÅŸkene kaydet
    pendingMultiplierChoice = {
        existing: existingMultiplier,
        found: foundMultiplier,
        boxId: boxId
    };

    // SeÃ§eneklerin metinlerini oluÅŸtur
    const convertText = `Yeni ${foundMultiplier.value}x Ã‡arpanÄ±, <b>+${foundMultiplier.value} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼r. (Mevcut ${existingMultiplier.value}x Ã§arpanÄ±n korunur)`;
    const combineValue = existingMultiplier.value + foundMultiplier.value;
    const combineText = `Ä°ki Ã§arpanÄ± birleÅŸtirip <b>1 kullanÄ±mlÄ±k ${combineValue}x</b> elde et. (Mevcut tÃ¼m ${existingMultiplier.value}x haklarÄ±n gider)`;

    infoEl.innerHTML = `Kutudan <b class="text-yellow-300">${foundMultiplier.value}x Ã‡arpan</b> buldun! Mevcut <b class="text-purple-300">${existingMultiplier.uses} adet ${existingMultiplier.value}x</b> Ã§arpanÄ±n var. Ne yapmak istersin?`;
    convertBtn.innerHTML = convertText;
    combineBtn.innerHTML = combineText;

    // ButonlarÄ±n onclick olaylarÄ±nÄ± ayarla
    convertBtn.onclick = () => resolveMultiplierChoice('convert');
    combineBtn.onclick = () => resolveMultiplierChoice('combine');

    modal.style.display = 'flex';
}

// SeÃ§im penceresini aÃ§ar ve senaryoya gÃ¶re iÃ§ini doldurur
function openMultiplierChoiceModal(context) {
    const modal = document.getElementById('multiplierChoiceModal');
    const infoEl = document.getElementById('multiplierChoiceInfo');
    const convertBtn = document.getElementById('choiceConvertBtn');
    const combineBtn = document.getElementById('choiceCombineBtn');

    // Bekleyen seÃ§imi global deÄŸiÅŸkene kaydet
    pendingMultiplierChoice = context;

    const { hasMultiplier, existing, found } = context;

    if (hasMultiplier) {
        // Senaryo: KullanÄ±cÄ±nÄ±n zaten bir Ã§arpanÄ± var ve FARKLI bir tane buldu
        const boxRightsFromFound = found.value;
        const convertText = `Yeni ${found.value}x Ã‡arpanÄ±, <b>+${boxRightsFromFound} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼r. <br><small>(Mevcut ${existing.value}x Ã§arpanÄ±n korunur)</small>`;
        
        const combineValue = existing.value + found.value;
        // DÃœZENLENEN KISIM: Buton metninden Kutu HakkÄ± Ã¶dÃ¼lÃ¼ Ã§Ä±karÄ±ldÄ± ve uyarÄ± eklendi.
        const acceptNewText = `Ä°ki Ã§arpanÄ± birleÅŸtirip <b>1 kullanÄ±mlÄ±k ${combineValue}x</b> elde et. <br><small>(DÄ°KKAT: Mevcut ${existing.uses} adet ${existing.value}x Ã§arpan hakkÄ±n kaybolacak!)</small>`;

        infoEl.innerHTML = `Kutudan <b class="text-yellow-300">${found.value}x Ã‡arpan</b> buldun! Mevcut <b class="text-purple-300">${existing.uses} adet ${existing.value}x</b> Ã§arpanÄ±n var. Stratejik bir karar ver!`;
        convertBtn.innerHTML = convertText;
        combineBtn.innerHTML = acceptNewText;
        
        convertBtn.onclick = () => resolveMultiplierChoice('convert_new');
        combineBtn.onclick = () => resolveMultiplierChoice('combine_and_upgrade');

    } else {
        // Senaryo: KullanÄ±cÄ±nÄ±n hiÃ§ Ã§arpanÄ± yok ve ilk defa buldu
        const boxRightsFromFound = found.value;
        const convertText = `BulduÄŸun ${found.value}x Ã‡arpanÄ±, <b>+${boxRightsFromFound} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼r.`;
        const acceptText = `BulduÄŸun ${found.value}x Ã‡arpanÄ± <b>1 kullanÄ±mlÄ±k</b> olarak envanterine ekle.`;

        infoEl.innerHTML = `Kutudan <b class="text-yellow-300">${found.value}x Ã‡arpan</b> buldun! Ne yapmak istersin?`;
        convertBtn.innerHTML = convertText;
        combineBtn.innerHTML = acceptText;

        convertBtn.onclick = () => resolveMultiplierChoice('convert_found');
        combineBtn.onclick = () => resolveMultiplierChoice('accept_found');
    }

    modal.style.display = 'flex';
}

// SeÃ§im penceresini kapatÄ±r
function closeMultiplierChoiceModal() {
    document.getElementById('multiplierChoiceModal').style.display = 'none';
    pendingMultiplierChoice = null; // Bekleyen seÃ§imi temizle
}

// KullanÄ±cÄ±nÄ±n seÃ§imine gÃ¶re veritabanÄ±nÄ± gÃ¼ncelleyen ana fonksiyon
async function resolveMultiplierChoice(choice) {
    if (!pendingMultiplierChoice) return;

    const { existing, found } = pendingMultiplierChoice;
    const userRef = db.ref('users/' + currentUser);
    const updates = {};
    let message = '';
    
    const userSnap = await userRef.once('value');
    const user = userSnap.val();

    switch (choice) {
        case 'convert_found': // Ã‡arpanÄ± yoktu, bulduÄŸunu Kutu HakkÄ±'na Ã§evirdi
            updates.kutuHakki = (user.kutuHakki || 0) + found.value;
            message = `SeÃ§imin Ã¼zerine, ${found.value}x Ã§arpan <b>+${found.value} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼!`;
            logActivity('multiplierConvertedToBoxRights', currentUser, { rewardValue: found.value, boxRights: found.value });
            break;
            
        case 'accept_found': // Ã‡arpanÄ± yoktu, bulduÄŸunu kabul etti
            updates.activeMultiplier = found.value;
            updates.multiplierSource = 'box';
            updates.multiplierRemainingUses = 0;
            message = `Yeni <b>${found.value}x</b> Ã§arpanÄ±n bir sonraki kutu aÃ§Ä±lÄ±ÅŸÄ±nda kullanÄ±lmak Ã¼zere envanterine eklendi!`;
            logActivity('multiplierFound', currentUser, { value: found.value });
            break;

        case 'convert_new': // Ã‡arpanÄ± vardÄ±, yeni bulduÄŸunu Kutu HakkÄ±'na Ã§evirdi
            updates.kutuHakki = (user.kutuHakki || 0) + found.value;
            message = `Mevcut ${existing.value}x Ã§arpanÄ±nÄ± korudun ve yeni Ã§Ä±kan ${found.value}x Ã§arpanÄ± <b>+${found.value} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼!`;
            logActivity('multiplierConvertedToBoxRights', currentUser, { rewardValue: found.value, boxRights: found.value, keptMultiplierValue: existing.value });
            break;

        case 'combine_and_upgrade':
            // DÃœZENLENEN KISIM: ArtÄ±k Kutu HakkÄ± eklenmiyor.
            const combinedValue = existing.value + found.value;
            updates.activeMultiplier = combinedValue;
            updates.multiplierSource = 'box';
            updates.multiplierRemainingUses = 0;
            
            message = `SeÃ§im yapÄ±ldÄ±! Mevcut Ã§arpan haklarÄ±n feda edilerek envanterine <b>1 kullanÄ±mlÄ±k ${combinedValue}x</b> eklendi!`;
            logActivity('multiplierUpgraded', currentUser, { newValue: combinedValue, oldValue: existing.value, boxRights: 0 }); // boxRights: 0 olarak loglanÄ±r.
            break;
    }

    await userRef.update(updates);

    displayMessage(message);
    closeMultiplierChoiceModal();
    db.ref('gameLock').set(false);
}

// ESKÄ°SÄ°NÄ° SÄ°LÄ°P BUNU YAPIÅTIR
async function forceClientUpdate() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("TÃ¼m aktif kullanÄ±cÄ±lara 'GÃ¼ncelleme Mevcut' penceresini gÃ¶stermek istediÄŸinize emin misiniz?");
    if (confirmed) {
        // VeritabanÄ±na "gÃ¼ncelleme gerekli" iÅŸareti olarak o anki sunucu zamanÄ±nÄ± yazÄ±yoruz.
        await db.ref('gameConfig/updateRequiredTimestamp').set(firebase.database.ServerValue.TIMESTAMP);
        displayMessage("GÃ¼ncelleme sinyali tÃ¼m kullanÄ±cÄ±lara gÃ¶nderildi.");
    }
}

 // ESKÄ°SÄ°NÄ° SÄ°LÄ°P BUNU YAPIÅTIR
async function performForceReload() {
    // Ã–nce sunucudaki gÃ¼ncel gÃ¼ncelleme zaman damgasÄ±nÄ± al
    const updateTimestampSnap = await db.ref('gameConfig/updateRequiredTimestamp').once('value');
    const updateTimestamp = updateTimestampSnap.val();

    if (updateTimestamp) {
        // Bu zaman damgasÄ±nÄ± kullanÄ±cÄ±nÄ±n kendi profiline "gÃ¶rdÃ¼ÄŸÃ¼ son gÃ¼ncelleme" olarak kaydet
        await db.ref(`users/${currentUser}/lastSeenUpdateTimestamp`).set(updateTimestamp);
    }
    
    // SayfayÄ±, Ã¶nbelleÄŸi atlayacak ÅŸekilde yeniden yÃ¼kle
    window.location.href = window.location.pathname + '?v=' + Date.now();
}

// ESKÄ°SÄ°NÄ° SÄ°LÄ°P BUNU YAPIÅTIR
function listenForForceUpdateSignal() {
    if (isAdmin) return; // Adminler bu pencereyi gÃ¶rmez

    const updateRef = db.ref('gameConfig/updateRequiredTimestamp');
    
    updateRef.on('value', async (snapshot) => {
        const requiredUpdateTimestamp = snapshot.val();

        // EÄŸer bir gÃ¼ncelleme sinyali yoksa hiÃ§bir ÅŸey yapma
        if (!requiredUpdateTimestamp) {
            return;
        }

        // KullanÄ±cÄ±nÄ±n en son gÃ¶rdÃ¼ÄŸÃ¼ gÃ¼ncellemenin zamanÄ±nÄ± kendi profilinden al
        const userSeenTimestampSnap = await db.ref(`users/${currentUser}/lastSeenUpdateTimestamp`).once('value');
        const userSeenTimestamp = userSeenTimestampSnap.val() || 0;

        // Sadece sunucudaki gÃ¼ncelleme, kullanÄ±cÄ±nÄ±n gÃ¶rdÃ¼ÄŸÃ¼nden daha YENÄ° ise pencereyi gÃ¶ster
        if (requiredUpdateTimestamp > userSeenTimestamp) {
            document.getElementById('forceUpdateModal').style.display = 'flex';
        }
    });
}

// YENÄ° LÄ°DERLÄ°K TABLOSU FONKSÄ°YONU
async function loadCollectionLeaderboard() {
    const leaderboardContainer = document.getElementById('collectionFinishersLeaderboard');
    const listEl = document.getElementById('finishersList');
    listEl.innerHTML = '<p class="text-gray-400">SÄ±ralama yÃ¼kleniyor...</p>';
    listEl.classList.add('scrollable-list'); // TutarlÄ± kaydÄ±rma Ã§ubuÄŸu stili iÃ§in

    const usersRef = db.ref('users');

    // Bu listener, birisi yeni bir kart aldÄ±ÄŸÄ±nda veya ilerlediÄŸinde listenin anÄ±nda gÃ¼ncellenmesini saÄŸlar.
    usersRef.on('value', async (snapshot) => {
        const allUsersData = snapshot.val() || {};
        
        // Gerekli tÃ¼m verileri tek seferde Ã§ekiyoruz
        const masterCardsSnap = await db.ref('gameConfig/cardCollection').once('value');
        const masterCards = masterCardsSnap.val() || {};
        const totalCardCount = Object.keys(masterCards).length;

        // Sadece koleksiyona baÅŸlamÄ±ÅŸ kullanÄ±cÄ±larÄ± filtrele
        const playersWithCards = Object.values(allUsersData).filter(user => 
            user.cardCollection && user.collectionInfo && user.collectionInfo.firstCardTimestamp
        );

        if (playersWithCards.length === 0) {
            leaderboardContainer.classList.add('hidden');
            return;
        }

        leaderboardContainer.classList.remove('hidden');

        // OyuncularÄ± ilk kartÄ± alma zamanlarÄ±na gÃ¶re sÄ±rala (en eskiden en yeniye)
        playersWithCards.sort((a, b) => a.collectionInfo.firstCardTimestamp - b.collectionInfo.firstCardTimestamp);

        let html = '';
        playersWithCards.forEach((userData, index) => {
            const username = Object.keys(allUsersData).find(key => allUsersData[key] === userData);
            const rank = index + 1;
            const rankIcon = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : `${rank}.`));
            const rowClass = rank === 1 ? 'bg-amber-800/50 border-amber-500' : 'bg-gray-700/50 border-gray-600';
            
            const ownedCardCount = Object.keys(userData.cardCollection || {}).length;

            let progressHtml = '';
            if (ownedCardCount >= totalCardCount && totalCardCount > 0) {
                progressHtml = `<span class="font-bold text-green-400">TamamlandÄ±</span>`;
            } else {
                progressHtml = `
                    <span class="font-bold text-yellow-300 cursor-pointer hover:underline" onclick="openMissingCardsModal('${username}')">
                        ${ownedCardCount}/${totalCardCount}
                    </span>
                `;
            }

            html += `
                <div class="flex items-center justify-between p-3 rounded-lg border ${rowClass}">
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-xl w-8 text-center">${rankIcon}</span>
                        <span class="text-lg text-white cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${username}')">
                            ${username}
                        </span>
                    </div>
                    <div class="text-right">
                        ${progressHtml}
                    </div>
                </div>
            `;
        });
        listEl.innerHTML = html;
    });
}

</script>
</body>
</html>
