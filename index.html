// MEVCUT acceptTradeOffer FONKSİYONUNU BU YENİ VE DÜZELTİLMİŞ VERSİYONLA DEĞİŞTİR

let isTradeInProgress = false;

async function acceptTradeOffer(tradeId, buttonElement) {
    if (isTradeInProgress) {
        return; // Zaten bir işlem varsa ikincisini başlatma
    }
    if (isAdmin) return;

    isTradeInProgress = true; // İşlemi kilitle
    if (buttonElement) {
        buttonElement.disabled = true;
        buttonElement.textContent = 'İşleniyor...';
    }

    try {
        const marketSettingsSnap = await db.ref('gameConfig/marketSettings').once('value');
        const marketSettings = marketSettingsSnap.val() || {};

        if (marketSettings.isLocked) {
            displayMessage("Takas Pazarı şu anda bakım nedeniyle geçici olarak kapalıdır.");
            return;
        }

        const tradeFee = marketSettings.tradeFee || 0;
        const tradeRef = db.ref(`trades/${tradeId}`);
        const tradeSnap = await tradeRef.once('value');
        const trade = tradeSnap.val();

        if (!trade) {
            displayMessage("Bu takas teklifi artık geçerli değil.");
            loadMarketOffers('all');
            return;
        }

        const userRef = db.ref(`users/${currentUser}`);
        const userSnap = await userRef.once('value');
        const userData = userSnap.val();
        const userCards = userData.cardCollection || {};

        if (!userCards[trade.requestedCardId] || userCards[trade.requestedCardId].count <= 1) {
            displayMessage(`Bu takası yapabilmek için istenen karttan en az 2 adete sahip olmalısın.`);
            return;
        }
        if ((userData.balance || 0) < tradeFee) {
            displayMessage(`Takas için gereken ${tradeFee} Puan işlem ücretine sahip değilsin.`);
            return;
        }

        const masterCardsSnap = await db.ref('gameConfig/cardCollection').once('value');
        const masterCards = masterCardsSnap.val();
        const offeredCard = masterCards[trade.offeredCardId];
        const requestedCard = masterCards[trade.requestedCardId];

        const confirmed = await customConfirm(`<b>${trade.offerer}</b> ile takas yapacaksın. Vereceğin kart: <b class="text-red-400">${requestedCard.cardName}</b>, Alacağın kart: <b class="text-green-400">${offeredCard.cardName}</b>. İşlem ücreti: <b class="text-yellow-400">${tradeFee} Puan</b>. Onaylıyor musun?`);
        if (!confirmed) {
            return;
        }

        let finalAccepterBalance = 0;
        const transactionResult = await db.ref().transaction(data => {
            if (!data.trades || !data.trades[tradeId]) { return; }
            
            const currentTrade = data.trades[tradeId];
            const accepter = data.users[currentUser];
            const offerer = data.users[currentTrade.offerer];

            if (!accepter || !offerer) { return; }
            if (!accepter.cardCollection?.[currentTrade.requestedCardId]?.count || accepter.cardCollection[currentTrade.requestedCardId].count <= 1) { return; }
            if ((accepter.balance || 0) < tradeFee) { return; }

            // === DÜZELTİLMİŞ KART ALIŞVERİŞ MANTIĞI ===
            
            // 1. KABUL EDEN KULLANICI İÇİN:
            // Vereceği kartın sayısını 1 azalt.
            accepter.cardCollection[currentTrade.requestedCardId].count--;
            // Alacağı kart envanterinde yoksa, önce oluştur.
            if (!accepter.cardCollection[currentTrade.offeredCardId]) {
                accepter.cardCollection[currentTrade.offeredCardId] = { count: 0 };
            }
            // Alacağı kartın sayısını 1 artır.
            accepter.cardCollection[currentTrade.offeredCardId].count++;

            // 2. TEKLİFİ VEREN KULLANICI İÇİN:
            // HATALI KISIM BURADAYDI VE KALDIRILDI! Teklif verenin kartı zaten pazara koyulurken düşülmüştü.
            // Burada tekrar düşmeye GEREK YOK. Sadece istediği kartı alacak.
            
            // Aldığı (karşılığında istediği) kart envanterinde yoksa, önce oluştur.
            if (!offerer.cardCollection[currentTrade.requestedCardId]) {
                offerer.cardCollection[currentTrade.requestedCardId] = { count: 0 };
            }
            // Aldığı kartın sayısını 1 artır.
            offerer.cardCollection[currentTrade.requestedCardId].count++;

            // 3. İşlem ücretini düş ve takası kaldır.
            accepter.balance = (accepter.balance || 0) - tradeFee;
            finalAccepterBalance = accepter.balance;
            data.trades[tradeId] = null;

            return data;
        });

        if (transactionResult.committed) {
            // İşlem başarılıysa loglama ve bildirimler...
            logActivity('tradeOfferAccepted', currentUser, {
                offerer: trade.offerer, fee: tradeFee, newBalance: finalAccepterBalance,
                offeredCardName: offeredCard.cardName, requestedCardName: requestedCard.cardName
            });
            if (trade.activityId) {
                await db.ref(`activityFeed/${trade.activityId}/details/status`).set('completed');
            }
            const notificationMessage = `<b>${currentUser}</b>, '${offeredCard.cardName}' kartı karşılığında verdiğiniz '${requestedCard.cardName}' takasını onayladı. Yeni kartınız albümünüze eklendi!`;
            await db.ref(`tradeNotifications/${trade.offerer}`).push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
            await db.ref('tradeHistory').push().set({
                offerer: trade.offerer, accepter: currentUser, offeredCardId: trade.offeredCardId,
                requestedCardId: trade.requestedCardId, offeredCardName: offeredCard.cardName,
                requestedCardName: requestedCard.cardName, timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            displayMessage("Takas başarıyla tamamlandı!");
            loadMarketOffers('all');
            if (currentActiveSection === 'cardCollection') loadCollectionAlbum();
        } else {
            displayMessage("Takas yapılamadı. Muhtemelen teklif sahibi kartı pazardan çekti veya başka bir sorun oluştu.");
            loadMarketOffers('all');
        }
    } catch (error) {
        console.error("Takas işlemi hatası:", error);
        displayMessage("Beklenmedik bir hata oluştu. Lütfen konsolu kontrol edin.");
    } finally {
        // İşlem ne olursa olsun (başarılı, başarısız, iptal) sonunda kilidi kaldır ve butonu normale döndür.
        isTradeInProgress = false;
        if (buttonElement) {
            buttonElement.disabled = false;
            buttonElement.textContent = 'Takası Yap';
        }
    }
}
