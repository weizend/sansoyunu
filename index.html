// ESKİ setWinner FONKSİYONUNU SİLİP, YENİ ÖDÜL MANTIĞI İÇEREN BUNU YAPIŞTIR

async function setWinner(username) {
    const lobbyRef = db.ref('clickCatchLobby');
    const lobbySnap = await lobbyRef.once('value');
    const lobbyData = lobbySnap.val();
    if (!lobbyData || lobbyData.state !== 'active') return;

    const gameSummary = {
        winner: username,
        prize: lobbyData.prize,
        target: lobbyData.target,
        startTimestamp: lobbyData.startTimestamp || null,
        endTimestamp: firebase.database.ServerValue.TIMESTAMP,
        players: lobbyData.players || {}
    };
    
    logActivity('clickCatchLobby', username, { prize: lobbyData.prize });
    
    await db.ref('clickCatchLobbyLastGameSummary').set(gameSummary);
    
    const updates = {
        state: 'finished',
        winner: username
    };
    await lobbyRef.update(updates);
    
    const winnerRef = db.ref(`users/${username}`);
    await winnerRef.transaction(user => {
        if (user) {
            // ================== YENİ ÖDÜL MANTIĞI BURADA ==================
            let finalPrize = lobbyData.prize;

            // Eğer admin ödülü 500 olarak ayarladıysa...
            if (lobbyData.prize === 500) {
                // Eğer oyuna biletle girildiyse, biletleri iade et.
                if (lobbyData.entryTickets > 0) {
                    user.clickCatchTickets = (user.clickCatchTickets || 0) + lobbyData.entryTickets;
                } 
                // Eğer puanla girildiyse, giriş puanını da ödüle ekle.
                else {
                    finalPrize += lobbyData.entryFee;
                }
            }
            // =============================================================

            // Toplam ödülü kullanıcının bakiyesine ekle.
            user.balance = (user.balance || 0) + finalPrize;
            if (user.balance > (user.highestBalanceEver || 0)) {
                user.highestBalanceEver = user.balance;
            }
        }
        return user;
    });

    // 5 saniye sonra lobi verisini temizle
    setTimeout(() => {
        db.ref('clickCatchLobby').remove();
    }, 5000);
}
