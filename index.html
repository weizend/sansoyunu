<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weizend Oyun DÃ¼nyasÄ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
/* --- YENÄ° EKLENECEK KOD: Ã–NCEKÄ° ÅAMPÄ°YON PANELÄ° STÄ°LÄ° --- */
#lastChampionPanel .champion-avatar {
    width: 64px; /* w-16 */
    height: 64px; /* h-16 */
    border-radius: 50%; /* rounded-full */
    border: 3px solid #fde047; /* border-4 border-yellow-300 */
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.2s ease-in-out;
}
#lastChampionPanel .champion-avatar:hover {
    transform: scale(1.1);
}
/* --- YENÄ° EKLENECEK KOD SONU --- */
/* --- CANAVAR SAVAÅI STÄ°LLERÄ° --- */
.health-bar-container {
    width: 100%;
    background-color: #374151; /* bg-gray-700 */
    border-radius: 9999px;
    border: 2px solid black;
    height: 24px;
    padding: 2px;
}
.health-bar {
    height: 100%;
    border-radius: 9999px;
    transition: width 0.5s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px black;
}
.leaderboard-item {
    display: flex;
    align-items: center;
    gap: 0.75rem; /* 12px */
    padding: 0.5rem; /* 8px */
    background-color: rgba(31, 41, 55, 0.5); /* bg-gray-800/50 */
    border-radius: 0.5rem; /* rounded-lg */
    cursor: pointer;
    transition: background-color 0.2s;
}
.leaderboard-item:hover {
    background-color: rgba(55, 65, 81, 0.7); /* bg-gray-600/70 */
}
.leaderboard-item .rank {
    font-weight: bold;
    font-size: 1.125rem; /* text-lg */
    width: 2rem; /* w-8 */
    text-align: center;
    flex-shrink: 0;
}
.leaderboard-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #4b5563; /* border-gray-600 */
}
.potion-button {
    background-color: #4c1d95; /* bg-purple-900 */
    border: 1px solid #a78bfa; /* border-purple-400 */
    border-radius: 0.5rem;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}
.potion-button:hover {
    background-color: #5b21b6; /* hover:bg-purple-800 */
    transform: translateY(-2px);
}
.potion-count {
    position: absolute;
    bottom: -5px;
    right: -5px;
    background-color: #fde047; /* bg-yellow-400 */
    color: #111827; /* text-gray-900 */
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
    border: 1px solid white;
}
#attackMonsterBtn:disabled {
    background-color: #4b5563; /* bg-gray-600 */
    cursor: not-allowed;
    animation: pulse-disabled 2s infinite;
}
@keyframes pulse-disabled {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; }
}
/* --- YENÄ°LENMÄ°Å VE CANLI GÄ°RÄ°Å SERÄ°SÄ° Ã–DÃœL KARTI STÄ°LLERÄ° --- */

/* TÃ¼m kartlar iÃ§in temel stil */
.streak-card {
    background: linear-gradient(145deg, #2c3e50, #1a2530);
    border: 2px solid #4b5563;
    border-radius: 0.75rem;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    transition: all 0.3s ease;
    margin-top: 15px;
}

/* GÃ¼n NumarasÄ± (BÃ¼yÃ¼tÃ¼lmÃ¼ÅŸ ve RenklendirilmiÅŸ) */
.streak-card .day-number {
    position: absolute;
    top: -22px; /* YÃ¼ksekliÄŸin yarÄ±sÄ± kadar yukarÄ± kaydÄ±rdÄ±k */
    left: 50%;
    transform: translateX(-50%);
    background-color: #4b5563;
    color: #fde047; /* YazÄ± rengini canlÄ± bir sarÄ± yaptÄ±k */
    font-weight: bold;
    width: 44px;  /* GeniÅŸliÄŸi artÄ±rdÄ±k */
    height: 44px; /* YÃ¼ksekliÄŸi artÄ±rdÄ±k */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #111827;
    z-index: 10;
    font-size: 1rem; /* YazÄ± boyutunu netleÅŸtirdik */
}

/* DiÄŸer temel stiller */
.streak-card .reward-image {
    width: 80px;
    height: 80px;
    object-fit: contain;
    margin-top: 1.25rem;
    margin-bottom: 0.75rem;
}
.streak-card .reward-name {
    font-weight: bold;
    color: #f3f4f6;
    font-size: 1.1rem;
}
.streak-card .reward-description {
    font-size: 0.875rem;
    color: #9ca3af;
    flex-grow: 1;
    margin-bottom: 1rem;
}
.claim-button {
    width: 100%;
    padding: 0.75rem;
    border-radius: 0.5rem;
    font-weight: bold;
    transition: all 0.2s; /* GeÃ§iÅŸi 'all' olarak deÄŸiÅŸtirdik */
    font-size: 0.9rem;
    line-height: 1.25rem;
    min-height: 46px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* AlÄ±nabilir Kartlar Ä°Ã§in Nefes Alma Animasyonu */
@keyframes pulse-claimable {
  0%, 100% {
    box-shadow: 0 0 15px rgba(20, 210, 220, 0.5);
    transform: scale(1.02);
  }
  50% {
    box-shadow: 0 0 25px rgba(20, 210, 220, 0.8);
    transform: scale(1.04);
  }
}

/* AlÄ±nabilir Durum (Daha CanlÄ± ve Animasyonlu) */
.streak-card.claimable {
    background: linear-gradient(145deg, #145369, #0891b2);
    border-color: #22d3ee;
    transform: scale(1.02);
    animation: pulse-claimable 2s infinite ease-in-out;
}
.streak-card.claimable .day-number {
    background-color: #22d3ee;
    color: #083344;
}
.streak-card.claimable .claim-button {
    background-color: #0d9488;
    color: white;
    cursor: pointer;
}
.streak-card.claimable .claim-button:hover {
    background-color: #0f766e;
}

/* AlÄ±nmÄ±ÅŸ Durum (Daha Net ve Onay Ä°konlu) */
.streak-card.claimed {
    background-color: #111827;
    border-color: #374151;
}
.streak-card.claimed .day-number {
    background-color: #4b5563;
}
.streak-card.claimed .claim-button {
    background-color: #22c55e; /* Onay iÃ§in YEÅÄ°L */
    color: white;
    font-weight: bold;
    cursor: not-allowed;
}
.streak-card.claimed::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 5rem;
    color: rgba(34, 197, 94, 0.3); /* Daha soft bir yeÅŸil */
    font-weight: bold;
    z-index: 5;
}

/* Kilitli Durum (Renkli ZamanlayÄ±cÄ±lÄ±) */
.streak-card.locked {
    /* filter ve opacity'yi kaldÄ±rarak renkleri geri getirdik */
    position: relative; /* Karartma efekti iÃ§in gerekli */
}

/* YENÄ°: Renkleri korurken kartÄ±n kilitli olduÄŸunu belli eden karartma efekti */
.streak-card.locked::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.55); /* %55 oranÄ±nda siyah overlay */
    border-radius: 0.75rem; /* KartÄ±n kÃ¶ÅŸe yuvarlaklÄ±ÄŸÄ± ile aynÄ± olmalÄ± */
    z-index: 1; /* Ä°Ã§eriÄŸin arkasÄ±nda, kartÄ±n Ã¶nÃ¼nde */
}

/* YENÄ°: Kart iÃ§eriÄŸinin karartma efektinin Ã¼zerinde kalmasÄ±nÄ± saÄŸlar */
.streak-card.locked > * {
    position: relative;
    z-index: 2;
}

/* GÃœNCELLENMÄ°Å: Kilitli buton stili */
.streak-card.locked .claim-button {
    background-color: #374151; /* Koyu gri arkaplan */
    border: 1px solid #4b5563; /* Hafif parlak kenarlÄ±k */
    cursor: not-allowed;
    
    /* GÃœNCELLEME: YazÄ± rengini beyaz yaptÄ±k (sÃ¼re iÃ§in) */
    color: white; 
    
    /* GÃœNCELLEME: KÄ±rmÄ±zÄ± vurguyu yazÄ±ya gÃ¶lge olarak ekledik */
    text-shadow: 0 0 8px rgba(239, 68, 68, 0.9); /* KÄ±rmÄ±zÄ± parlama efekti */
}

/* --- YENÄ° EKLENECEK KOD: Kutu AyarlarÄ± Mobil DÃ¼zeltmesi --- */
@media (max-width: 640px) { /* sm breakpoint'i (640px) altÄ±ndaki ekranlar iÃ§in */
    .box-setting-row {
        flex-direction: column; /* Elementleri dikeyde hizala */
        align-items: stretch;   /* Elementleri tam geniÅŸliÄŸe yay */
        gap: 0.75rem;           /* AralarÄ±ndaki boÅŸluÄŸu ayarla */
    }
    .box-setting-row .setting-value,
    .box-setting-row .setting-count {
        width: 100%; /* GeniÅŸlikleri %100 yap */
    }
}
/* --- YENÄ° EKLENECEK KOD --- */
#finishersList {
    max-height: 450px; /* YaklaÅŸÄ±k 5 satÄ±r + boÅŸluklar iÃ§in bir yÃ¼kseklik */
    overflow-y: auto;
}
#updateOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    text-align: center;
}
/* --- SÃœRPRÄ°Z KART SEÃ‡Ä°M STÄ°LÄ° --- */
#cardSelectionModal .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#cardSelectionModal .card:hover {
    transform: translateY(-10px) scale(1.05);
    box-shadow: 0 15px 30px rgba(255, 50, 50, 0.4);
}

.new-card-badge {
    position: absolute;
    top: -10px;
    left: -10px;
    background-color: #22c55e; /* bg-green-500 */
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    padding: 3px 8px;
    border-radius: 12px;
    border: 2px solid white;
    transform: rotate(-15deg);
    animation: pulse-new 1.5s infinite;
}

@keyframes pulse-new {
    0%, 100% { transform: rotate(-15deg) scale(1); }
    50% { transform: rotate(-15deg) scale(1.1); }
}
/* --- BÄ°LGÄ° BUTONU STÄ°LÄ° --- */
.info-button {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #3b82f6; /* bg-blue-600 */
    color: white;
    font-weight: bold;
    font-size: 1.1rem;
    border: 2px solid white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
}
.info-button:hover {
    transform: scale(1.1);
    background-color: #2563eb; /* bg-blue-700 */
}
/* --- YENÄ° KART PAKETÄ° STÄ°LLERÄ° --- */

/* Normal (Bronz) Kart Paketi iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.card_pack_normal {
    background: linear-gradient(145deg, #a16207, #854d0e); /* amber-700 to amber-800 */
    border-color: #fcd34d; /* amber-300 */
}
.box.opened.card_pack_normal .box-content::before {
    content: 'ğŸ¥‰';
    font-size: 2.5rem;
}

/* GÃ¼mÃ¼ÅŸ Kart Paketi iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.card_pack_gumus {
    background: linear-gradient(145deg, #71717a, #52525b); /* zinc-600 to zinc-700 */
    border-color: #e5e7eb; /* gray-200 */
}
.box.opened.card_pack_gumus .box-content::before {
    content: 'ğŸ¥ˆ';
    font-size: 2.5rem;
}

/* AltÄ±n Kart Paketi iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.card_pack_altin {
    background: linear-gradient(145deg, #f59e0b, #d97706); /* amber-500 to amber-600 */
    border-color: #fde047; /* yellow-300 */
}
.box.opened.card_pack_altin .box-content::before {
    content: 'ğŸ¥‡';
    font-size: 2.5rem;
}

/* Efsanevi Kart Paketi iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.card_pack_efsanevi {
    background: linear-gradient(145deg, #7e22ce, #6b21a8); /* purple-700 to purple-800 */
    border-color: #d8b4fe; /* purple-300 */
    animation: glow 2s ease-in-out infinite; /* Efsanevi Ä±ÅŸÄ±ltÄ±sÄ± */
}
.box.opened.card_pack_efsanevi .box-content::before {
    content: 'ğŸ†';
    font-size: 2.5rem;
}

/* Joker Kart iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.wildcard {
    background: linear-gradient(145deg, #a855f7, #7e22ce); /* purple */
    border-color: #d8b4fe;
}
.box.opened.wildcard .box-content::before {
    content: 'ğŸƒ'; /* GÃœNCELLENDÄ° */
    font-size: 2.5rem;
}

/* Kart Paketi iÃ§eren aÃ§Ä±lmÄ±ÅŸ kutu stili */
.box.opened.card_pack {
    background: linear-gradient(145deg, #6d28d9, #4c1d95); /* purple */
    border-color: #a78bfa;
}
.box.opened.card_pack .box-content::before {
    content: 'ğŸ´'; /* GÃœNCELLENDÄ° */
    font-size: 2.5rem;
}
/* --- KART Ã‡EVÄ°RME ANÄ°MASYONU STÄ°LLERÄ° --- */
.card-flip-container {
    perspective: 1000px;
    width: 150px;
    height: 210px;
    cursor: pointer;
}

.card-flipper {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s;
    transform-style: preserve-3d;
}

.card-flip-container.flipped .card-flipper {
    transform: rotateY(180deg);
}

.card-front, .card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    border-radius: 12px;
}

/* --- YENÄ°: KAPALI KART PAKETÄ° Ã–N YÃœZ STÄ°LLERÄ° --- */

/* TÃ¼m kapalÄ± paket Ã¶n yÃ¼zleri iÃ§in temel stil */
.card-front {
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* Efsanevi animasyonu iÃ§in Ã¶nemli */
}

.pack-icon {
    font-size: 5rem;
    opacity: 0.8;
    filter: drop-shadow(0 0 10px rgba(0,0,0,0.7));
}

/* Standart Paket Ã–n YÃ¼zÃ¼ (Mor/Gizemli) */
.pack-front-standart {
    background: linear-gradient(145deg, #4c1d95, #3730a3); /* Koyu Mor */
    border: 4px solid #a78bfa;
}
.pack-front-standart .pack-icon {
    color: #c4b5fd;
}

/* Bronz Paket Ã–n YÃ¼zÃ¼ */
.pack-front-normal {
    background: linear-gradient(145deg, #4a2c0f, #3a1e0b);
    border: 4px solid;
    border-image: linear-gradient(145deg, #d3a17c, #b37e5c, #d3a17c) 1;
}
.pack-front-normal .pack-icon {
    color: #d3a17c;
}

/* GÃ¼mÃ¼ÅŸ Paket Ã–n YÃ¼zÃ¼ */
.pack-front-gumus {
    background: linear-gradient(145deg, #4a5568, #2d3748);
    border: 4px solid;
    border-image: linear-gradient(145deg, #e5e7eb, #9ca3af, #e5e7eb) 1;
}
.pack-front-gumus .pack-icon {
    color: #e5e7eb;
}

/* AltÄ±n Paket Ã–n YÃ¼zÃ¼ */
.pack-front-altin {
    background: linear-gradient(145deg, #6a4f2b, #4a371e);
    border: 4px solid;
    border-image: linear-gradient(145deg, #ffee00, #ffd700, #ffb300) 1;
    box-shadow: 0 0 15px #ffd700;
}
.pack-front-altin .pack-icon {
    color: #ffee00;
}

/* Efsanevi Paket Ã–n YÃ¼zÃ¼ (Animasyonlu) */
.pack-front-efsanevi {
    position: relative;
    z-index: 1;
    background: #111;
}
.pack-front-efsanevi::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    z-index: 1;
    background: conic-gradient(#ff1b1b, #ff7f00, #ffee00, #ff7f00, #ff1b1b);
    animation: spin-around 4s linear infinite;
}
.pack-front-efsanevi::after {
    content: '';
    position: absolute;
    top: 4px; left: 4px; right: 4px; bottom: 4px;
    border-radius: 8px; /* Ä°Ã§ Ã§erÃ§eve iÃ§in daha az yuvarlaklÄ±k */
    z-index: 2;
    background: linear-gradient(145deg, #e43642, #b11f29);
    animation: breathing-bg 3s infinite ease-in-out;
}
.pack-front-efsanevi > * {
    position: relative;
    z-index: 3;
}
.pack-front-efsanevi .pack-icon {
    color: #ffee00;
    animation: badge-pulse 2s infinite ease-in-out;
}

/* AÃ§Ä±lmÄ±ÅŸ KartÄ±n GÃ¶rÃ¼nÃ¼mÃ¼ (Ã–n YÃ¼zÃ¼) */
.card-back {
    transform: rotateY(180deg);
}
/* --- TAKAS PAZARI STÄ°LLERÄ° (MOBÄ°L UYUMLU) --- */
.market-offer-card {
    background-color: #1f2937; /* bg-gray-800 */
    border-radius: 0.75rem;
    border: 1px solid #374151; /* border-gray-700 */
    padding: 1rem;
    display: flex;
    /* VarsayÄ±lan (Mobil): Dikey olarak alt alta */
    flex-direction: column;
    gap: 0.75rem; /* 12px */
}

/* Orta boy ve Ã¼zeri ekranlar iÃ§in (MasaÃ¼stÃ¼ gÃ¶rÃ¼nÃ¼mÃ¼) */
@media (min-width: 768px) {
    .market-offer-card {
        /* Yatay olarak yan yana */
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
    }
}

/* Pazardaki kÃ¼Ã§Ã¼k kartlarÄ±n Ã§erÃ§eve ve boyut stili */
.market-card-item {
    width: 50px; /* Mobil iÃ§in biraz daha kÃ¼Ã§Ã¼lttÃ¼k */
    aspect-ratio: 7 / 10;
    border-radius: 6px;
    padding: 3px;
    background-color: #111827; /* bg-gray-900 */
    position: relative;
    box-shadow: 0 4px 6px rgba(0,0,0,0.4);
    flex-shrink: 0;
}

/* MasaÃ¼stÃ¼ iÃ§in kart boyutunu eski haline getir */
@media (min-width: 768px) {
    .market-card-item {
        width: 60px;
    }
}

/* Pazardaki kartlarÄ±n iÃ§indeki resim stili */
.market-card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 3px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.market-card-info .card-name {
    font-weight: bold;
    color: white;
    font-size: 0.9rem; /* Fontu biraz kÃ¼Ã§Ã¼lttÃ¼k */
    line-height: 1.2; /* SatÄ±r aralÄ±ÄŸÄ± */
}
.market-card-info .card-owner {
    font-size: 0.75rem; /* 12px */
    color: #9ca3af; /* text-gray-400 */
}
/* --- KART YÃ–NETÄ°M BUTONLARI STÄ°LÄ° --- */
.card-admin-buttons {
    position: absolute;
    top: 4px;
    right: 4px;
    z-index: 2;
    display: flex;
    gap: 4px;
    background: rgba(0,0,0,0.5);
    padding: 4px;
    border-radius: 8px;
}
.card-admin-buttons button {
    background: #4a5568;
    border: none;
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    cursor: pointer;
    font-size: 16px;
    line-height: 28px;
    transition: background-color 0.2s;
}
.card-admin-buttons button:hover {
    background: #718096;
}
/* --- YENÄ°: KART KOLEKSÄ°YONU SÄ°STEMÄ° STÄ°LLERÄ° --- */

/* Kart albÃ¼mÃ¼nÃ¼n genel yerleÅŸimi (Mobil Uyumlu) */
#cardCollectionAlbum {
    display: grid;
    /* Mobil iÃ§in: min 100px, MasaÃ¼stÃ¼ (md) iÃ§in: min 150px */
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 1rem; /* Mobilde boÅŸluÄŸu biraz azalttÄ±k */
    padding: 1rem;
}

/* Orta boy ve Ã¼zeri ekranlar iÃ§in (MasaÃ¼stÃ¼ gÃ¶rÃ¼nÃ¼mÃ¼) */
@media (min-width: 768px) {
    #cardCollectionAlbum {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1.5rem;
    }
}

/* Tek bir kartÄ±n (hem dolu hem boÅŸ) kapladÄ±ÄŸÄ± alan */
.card-slot {
    perspective: 1000px;
}

/* KartÄ±n kendisi - temel stil */
.card-item {
    width: 100%;
    aspect-ratio: 7 / 10; /* Kart en boy oranÄ± */
    border-radius: 12px;
    padding: 8px;
    /* background-color satÄ±rÄ± buradan kaldÄ±rÄ±ldÄ± */
    position: relative;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.4);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
}

.card-item:hover {
    transform: translateY(-10px) rotateX(5deg);
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
}

/* KartÄ±n iÃ§indeki resim */
.card-image {
    width: 100%;
    height: 70%;
    object-fit: cover;
    border-radius: 6px;
    border: 2px solid rgba(255, 255, 255, 0.1);
}

/* KartÄ±n adÄ± */
.card-name {
    text-align: center;
    font-weight: bold;
    color: white;
    font-size: 0.9rem;
    padding: 8px 4px 0 4px;
    text-shadow: 1px 1px 2px black;
}

/* Fazla kartlarÄ± gÃ¶steren rozet */
.duplicate-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    background-color: #fde047; /* yellow-400 */
    color: #111827; /* gray-900 */
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
    border: 2px solid white;
}

/* --- NADÄ°RLÄ°K Ã‡ERÃ‡EVELERÄ° (GÃœNCELLENMÄ°Å) --- */

/* Normal Kart (Bronz GÃ¶rÃ¼nÃ¼m) */
.rarity-normal {
    background: linear-gradient(145deg, #4a2c0f, #3a1e0b); /* Koyu bronz arkaplan */
    border: 4px solid;
    border-image: linear-gradient(145deg, #d3a17c, #b37e5c, #d3a17c) 1; /* Bronz Ã§erÃ§eve */
    box-shadow: 0 0 10px rgba(205, 127, 50, 0.3); /* Hafif bronz Ä±ÅŸÄ±ltÄ± */
}

/* GÃ¼mÃ¼ÅŸ Kart */
.rarity-gumus {
    background: linear-gradient(145deg, #4a5568, #2d3748);
    border: 4px solid;
    border-image: linear-gradient(145deg, #e5e7eb, #9ca3af, #e5e7eb) 1;
    box-shadow: 0 0 15px rgba(200, 200, 220, 0.4);
}

/* AltÄ±n Kart (Daha Koyu Arkaplan ve CanlÄ± Ã‡erÃ§eve) */
.rarity-altin {
    /* ArkaplanÄ± daha koyu ve zengin bir tona Ã§ektik */
    background: linear-gradient(145deg, #6a4f2b, #4a371e);
    border: 4px solid;
    /* Ã‡erÃ§eve renklerini daha parlak ve canlÄ± sarÄ±/altÄ±n tonlarÄ± yaptÄ±k */
    border-image: linear-gradient(145deg, #ffee00, #ffd700, #ffb300) 1;
    /* Ã‡erÃ§evenin dÄ±ÅŸÄ±ndaki Ä±ÅŸÄ±ltÄ±yÄ± daha belirgin hale getirdik */
    box-shadow: 0 0 20px #ffd700;
}

/* Efsanevi Kart (AteÅŸli Ã‡erÃ§eve + Efsanevi Ä°ÅŸareti) */
@keyframes breathing-bg {
    0% {
        opacity: 1;
    }
    50% {
        opacity: 0.6; /* IÅŸÄ±ÄŸÄ±n ne kadar kÄ±sÄ±lacaÄŸÄ±nÄ± buradan ayarlayabilirsin */
    }
    100% {
        opacity: 1;
    }
}

.rarity-efsanevi {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    z-index: 1;
    background: #111;
}

.rarity-efsanevi::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    z-index: 1;

    /* 1. Ä°STEK: Ã‡erÃ§eveyi kÄ±rmÄ±zÄ±-turuncu-sarÄ± yaptÄ±k */
    background: conic-gradient(
        #ff1b1b, #ff7f00, #ffee00, #ff7f00, #ff1b1b
    );
    
    animation: spin-around 4s linear infinite;
}

.rarity-efsanevi::after {
    content: '';
    position: absolute;
    top: 4px;
    left: 4px;
    right: 4px;
    bottom: 4px;
    border-radius: 12px;
    z-index: 2;
    background: linear-gradient(145deg, #e43642, #b11f29);

    /* Animasyonu buraya ekliyoruz (3 saniyede bir nefes alÄ±p verecek) */
    animation: breathing-bg 3s infinite ease-in-out;
}

.rarity-efsanevi > * {
    position: relative;
    z-index: 3;
}

/* 2. Ä°STEK: Efsanevi iÅŸaretinin stili */
@keyframes badge-pulse {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 4px #ffee00); }
    50% { transform: scale(1.15); filter: drop-shadow(0 0 8px #ffee00); }
}

.legendary-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 4; /* Her ÅŸeyin en Ã¼stÃ¼nde */
    font-size: 1.5rem; /* 24px */
    /* Emojiye parlama efekti veriyoruz */
    filter: drop-shadow(0 0 4px #ffee00);
    /* HafifÃ§e sallanma ve parlama animasyonu */
    animation: badge-pulse 2s infinite ease-in-out;
}


/* Eksik Kart Stili */
.card-item.missing {
    background-color: #374151; /* gray-700 */
    border: 4px dashed #6b7280; /* gray-500 */
    align-items: center;
    justify-content: center;
    cursor: default;
}

.card-item.missing:hover {
    transform: none;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.4);
}

.missing-text {
    font-size: 4rem;
    color: #4b5563; /* gray-600 */
    font-weight: bold;
}

/* --- MOBÄ°L Ä°ZLEME PENCERESÄ° DÃœZELTMESÄ° --- */
#spectatorModal .modal-content {
    max-height: 85vh !important;
    overflow-y: auto !important;
}

  .floating-text {
      position: absolute;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      text-shadow: 1px 1px 3px black;
      animation: floatUp 1.5s ease-out forwards;
      pointer-events: none; /* TÄ±klanamaz yapar */
      z-index: 100;
  }
  @keyframes floatUp {
      0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
      }
      100% {
          opacity: 0;
          transform: translate(-50%, -150%) scale(1.2);
      }
  }
  body {
    font-family: 'Inter', sans-serif;
  }
  .inline-badge {
    margin-left: 4px; /* Rozetlerin soluna boÅŸluk ekler */
    vertical-align: middle; /* Dikey olarak ortalar */
}
  .scrollable-list::-webkit-scrollbar {
    width: 8px;
  }
  .scrollable-list::-webkit-scrollbar-track {
    background: #333;
    border-radius: 10px;
  }
  .scrollable-list::-webkit-scrollbar-thumb {
    background: #b71c1c;
    border-radius: 10px;
  }
  .scrollable-list::-webkit-scrollbar-thumb:hover {
    background: #ff4444;
  }
  @keyframes glow {
    0%, 100% { box-shadow: 0 0 5px #fde047, 0 0 10px #fde047, 0 0 15px #fde047; }
    50% { box-shadow: 0 0 10px #facc15, 0 0 20px #facc15, 0 0 30px #facc15; }
  }
  .glowing-border {
    animation: glow 2.5s ease-in-out infinite;
  }
  /* --- KART Ã‡EVÄ°RME ANÄ°MASYONU STÄ°LLERÄ° --- */
.card-flip-container {
    perspective: 1000px;
    width: 150px; /* Veya kartlarÄ±nÄ±zÄ±n geniÅŸliÄŸi ne ise */
    height: 210px; /* Veya kartlarÄ±nÄ±zÄ±n yÃ¼ksekliÄŸi ne ise */
    cursor: pointer;
}

.card-flipper {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s;
    transform-style: preserve-3d;
}

/* Bu sÄ±nÄ±f JS tarafÄ±ndan eklendiÄŸinde kart dÃ¶necek */
.card-flip-container.flipped .card-flipper {
    transform: rotateY(180deg);
}

.card-front, .card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    border-radius: 12px;
}

/* KartÄ±n arka yÃ¼zÃ¼ baÅŸlangÄ±Ã§ta arkaya dÃ¶nÃ¼k olacak */
.card-back {
    transform: rotateY(180deg);
}
  .user-mention {
    background-color: #4a5568;
    color: #a0aec0;
    padding: 2px 5px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .user-mention:hover {
    background-color: #718096;
  }
  .user-mention.highlighted {
    background-color: #f59e0b;
    color: #1a202c;
    font-weight: bold;
  }
  .admin-controls button:disabled svg {
    fill: #4a5568;
    cursor: not-allowed;
  }
  #gameDiv.modal-is-open .admin-controls,
  #gameDiv.modal-is-open .best-seller-badge {
    visibility: hidden;
  }
  /* ÅANS Ã‡ARKI STÄ°LLERÄ° BAÅLANGIÃ‡ */
#wheelContainer {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 2rem auto;
}

/* Sadece renkli dilimleri iÃ§eren dÃ¶nen arka plan */
#wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 10px solid #4a5568;
    transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
    position: relative;
    /* Arka plan JS tarafÄ±ndan 'conic-gradient' ile doldurulacak */
}

  /* YazÄ±yÄ± taÅŸÄ±yan ve merkezden dÃ¶nen gÃ¶rÃ¼nmez "Ã§ubuk" */
.wheel-text-container {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 50%; /* Ã‡arkÄ±n yarÄ±Ã§apÄ± kadar */
    height: 1px;
    transform-origin: left center; /* Merkezden dÃ¶nmesini saÄŸlar */
    z-index: 6; /* YazÄ±larÄ±n renklerin Ã¼stÃ¼nde olmasÄ±nÄ± saÄŸlar */
}

/* YazÄ±nÄ±n kendisi */
.wheel-text {
    display: block;
    position: absolute;
    left: 70%; 
    top: 70%;
    
    /* Bu transform, yazÄ±yÄ± kendi boyutlarÄ±na gÃ¶re tam olarak ortalar. */
    transform: translate(-80%, -80%);
    
    /* GÃ¶rsel Stiller */
    color: white;
    font-size: 25px;
    font-weight: bold;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 1);
    white-space: nowrap;
}
  
  .wheel-image {
    display: block;
    position: absolute;
    left: 60%; 
    top: 50%;
    /* BoyutlarÄ± ayarla */
    width: 45px;
    height: 45px;
    object-fit: contain; /* Resmin orantÄ±sÄ±nÄ± bozmadan sÄ±ÄŸdÄ±r */
    /* Ortalamak iÃ§in transformu ayarla */
    transform: translate(-50%, -50%);
}
  
/* Ãœstteki sabit sarÄ± ok iÅŸareti */
#wheelMarker {
    position: absolute;
    top: -5px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    border-top: 30px solid #fde047;
    z-index: 10;
}
/* ÅANS Ã‡ARKI STÄ°LLERÄ° BÄ°TÄ°Å */
   /* TÄ±kla Yakala Stilleri */
   #clickCatchGameArea {
    width: 100%;
    max-width: 600px;
    height: 400px;
    background-color: #1a202c;
    border: 3px solid #b71c1c;
    border-radius: 10px;
    position: relative;
    overflow: hidden;
    cursor: crosshair;
  }
  .catch-item {
    position: absolute;
    width: 50px;
    height: 50px;
    background-size: contain;
    background-repeat: no-repeat;
    cursor: pointer;
    transition: transform 0.1s ease;
    -webkit-user-select: none; /* Mevcut kod */
    -moz-user-select: none;    /* Mevcut kod */
    -ms-user-select: none;     /* Mevcut kod */
    user-select: none;         /* Mevcut kod */
    -webkit-tap-highlight-color: transparent; /* YENÄ° EKLENECEK SATIR */
}
  .catch-item:hover {
      transform: scale(1.1);
  }
  /* Modal BaÅŸlÄ±ÄŸÄ± AlanÄ± (GÃ¼ncellendi) */
  .modal-header {
    /* Butonu saÄŸa yaslama komutunu kaldÄ±rÄ±yoruz, artÄ±k kendi baÅŸÄ±na ortalanacak */
    padding-bottom: 1rem;
    border-bottom: 1px solid #4a5568;
    margin-bottom: 1rem;
  }

 /* ...VE BU ORÄ°JÄ°NAL HALÄ°YLE DEÄÄ°ÅTÄ°R */
.modal-close-button {
    position: absolute;
    top: 10px; /* YukarÄ±dan boÅŸluk */
    right: 15px; /* SaÄŸdan boÅŸluk */
    color: white; /* Buton rengi */
    font-size: 28px; /* Buton yazÄ± boyutu */
    line-height: 1; /* SatÄ±r yÃ¼ksekliÄŸi */
    background: none; /* Arka planÄ± transparan yapar */
    border: none; /* KenarlÄ±ÄŸÄ± kaldÄ±rÄ±r */
    cursor: pointer; /* Ãœzerine gelince fare iÅŸaretÃ§isini deÄŸiÅŸtirir */
    opacity: 0.7; /* BaÅŸlangÄ±Ã§ta biraz saydam yapar */
    transition: all 0.2s ease-in-out; /* GeÃ§iÅŸ efekti */
    z-index: 10; /* DiÄŸer iÃ§eriklerin Ã¼stÃ¼nde kalmasÄ±nÄ± saÄŸlar */
}

.modal-close-button:hover {
    opacity: 1; /* Ãœzerine gelince tam gÃ¶rÃ¼nÃ¼r yapar */
    transform: scale(1.1); /* HafifÃ§e bÃ¼yÃ¼tÃ¼r */
    color: #ffdddd; /* Ãœzerine gelince renk deÄŸiÅŸimi */
}

/* Modal aÃ§Ä±kken body'nin kaymasÄ±nÄ± engelleyen sÄ±nÄ±f */
body.modal-open {
    overflow: hidden;
}

/* Modal iÃ§erisindeki kaydÄ±rÄ±labilir alanlarÄ±n kaymasÄ±nÄ± engellememek iÃ§in */
body.modal-open .modal-content {
    overflow-y: auto;
}
  .box-setting-input {
    width: 100%;
    padding: 10px;
    background-color: #374151; /* bg-gray-700 */
    border: 1px solid #4b5563; /* border-gray-600 */
    border-radius: 8px; /* rounded-lg */
    color: white;
  }
  .box-setting-input:focus {
    outline: none;
    border-color: #8b5cf6; /* focus:border-purple-500 */
    box-shadow: 0 0 0 2px #a78bfa; /* focus:ring-2 focus:ring-purple-400 */
  }
  body.modal-open {
    overflow: hidden;
}

</style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center py-8 px-4">
  <div id="globalAdminNotification" class="fixed top-5 left-1/2 -translate-x-1/2 w-auto max-w-md bg-blue-600 text-white px-6 py-3 rounded-lg shadow-xl text-center font-bold z-[100000] transition-all duration-500 ease-in-out opacity-0 -translate-y-20">
      </div>

  <header class="w-full max-w-4xl bg-gradient-to-r from-red-700 to-black text-white text-3xl font-extrabold tracking-wider py-4 rounded-xl shadow-xl mb-8 text-center relative">
    WEÄ°ZEND OYUN DÃœNYASI
    
    <div id="seasonCountdownContainer" class="text-base font-normal mt-2 text-yellow-300 hidden flex justify-center items-center gap-2">
    <span>AylÄ±k Sezonun Bitmesine: <span id="seasonCountdown" class="font-bold text-white tracking-wider"></span></span>
    <button onclick="openSeasonInfoModal()" class="text-blue-400 hover:text-blue-300 transition-colors" title="AylÄ±k Sezon SÄ±fÄ±rlamasÄ± HakkÄ±nda Bilgi">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>
</div>
</header>

<div id="activityFeedPanel" class="fixed top-0 right-0 h-full w-full max-w-md bg-gray-800 border-l-2 border-red-700 shadow-2xl z-[10000] transform translate-x-full transition-transform duration-300 ease-in-out hidden">
      <div class="flex flex-col h-full">
          <div class="flex justify-between items-center p-4 border-b border-gray-700">
              <h4 class="text-yellow-400 text-2xl font-bold">Son Eylemler</h4>
              <button onclick="closeActivityFeed()" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
              </button>
          </div>
          <div id="activityFeedList" class="flex-grow overflow-y-auto p-4 scrollable-list">
              </div>
      </div>
</div>

<div id="loginContainer" class="bg-gray-800 p-8 rounded-xl shadow-lg border border-red-700 w-full max-w-md">
    <div class="flex border-b border-gray-600 mb-6">
        <button id="loginTabBtn" onclick="switchAuthTab('login')" class="flex-1 py-3 text-lg font-bold border-b-2 border-red-500 text-white transition-colors duration-300">GiriÅŸ Yap</button>
        <button id="registerTabBtn" onclick="switchAuthTab('register')" class="flex-1 py-3 text-lg font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors duration-300">KayÄ±t Ol</button>
    </div>

    <div id="loginDiv">
        <input type="text" id="loginUsername" placeholder="Kick KullanÄ±cÄ± AdÄ±" autocomplete="username"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="password" id="loginPassword" placeholder="Åifre" autocomplete="current-password"
               class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <button onclick="login()"
                class="w-full py-3 mb-4 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
          GiriÅŸ Yap
        </button>
        <p class="mt-4 text-center">
          <a href="#" onclick="openPasswordResetModal()" class="text-red-500 hover:text-red-400 font-bold transition duration-200">
            Åifremi Unuttum
          </a>
        </p>
    </div>

    <div id="registerDiv" class="hidden">
        <div id="kickWarning" class="bg-yellow-900/50 border border-yellow-400 text-yellow-300 px-4 py-3 rounded-lg relative mb-4 text-center">
            <strong class="font-bold">Kick KullanÄ±cÄ± AdÄ± Zorunludur!</strong>
            <span class="block sm:inline">LÃ¼tfen Kick platformundaki kullanÄ±cÄ± adÄ±nÄ±z ile kayÄ±t olunuz.</span>
            <br>
            <span class="block sm:inline font-bold text-red-400 mt-2">Ã–NEMLÄ°: LÃ¼tfen Kick ÅŸifrenizi deÄŸil, bu siteye Ã¶zel yeni bir ÅŸifre oluÅŸturun!</span>
        </div>
        <input type="text" id="registerUsername" placeholder="Kick KullanÄ±cÄ± AdÄ±" autocomplete="username"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="password" id="registerPassword" placeholder="Åifre (Yeni Bir Åifre OluÅŸturun)" autocomplete="new-password"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="password" id="registerPasswordConfirm" placeholder="Åifre Tekrar" autocomplete="new-password"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="text" id="registerPin" placeholder="6 Haneli Unutulmaz Rakam (PIN)" maxlength="6"
               class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />

        <button onclick="register()"
                class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
          KayÄ±t Ol
        </button>
    </div>
</div>
<div id="gameDiv" class="w-full max-w-4xl hidden pb-16">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 mb-8 relative">
        <div class="flex flex-col items-center mb-4">
            <img id="currentUserAvatar" src="" class="w-24 h-24 rounded-full border-4 border-yellow-400 mb-3 object-cover shadow-lg cursor-pointer transition-opacity hover:opacity-80" onclick="openAvatarStatsModal(currentUser)">
            <div id="currentUserBadges" class="h-6 mb-1 flex items-center justify-center space-x-1"></div>
            <h3 class="text-yellow-400 text-2xl font-bold flex items-center justify-center">
                <span id="currentUser" class="inline-flex items-center cursor-pointer transition-opacity hover:opacity-80" onclick="openPublicUserDetailModal(currentUser)"></span> 
                <span id="role" class="text-base text-gray-400 ml-2"></span>
            </h3>
        </div>
        <p id="balance" class="text-lg text-gray-300 mb-4 text-center"></p>
        <div class="flex justify-center flex-wrap gap-4 mt-4">
            <button onclick="logout()" class="py-2 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md">Ã‡Ä±kÄ±ÅŸ Yap</button>
            <button id="loginStreakButton" onclick="openLoginStreakModal()" class="py-2 px-6 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-lg shadow-md relative flex items-center gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
    </svg>
    GiriÅŸ Serisi
    <span id="loginStreakIndicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
</button>
            <button id="dailyRewardButton" onclick="openDailyRewardModal()" class="py-2 px-6 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg shadow-md relative">
                GÃ¼nlÃ¼k Ã–dÃ¼l
                <span id="dailyRewardIndicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
            </button>
            <button id="inventoryButton" onclick="openInventoryModal()" class="py-2 px-6 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md">Envanter</button>
            <button id="adminPanelToggleButton" onclick="openAdminPanelModal()" class="py-2 px-6 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md hidden">Admin Paneli</button>
            <button id="helpButton" onclick="openHelpModal()" class="py-2 px-6 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">YardÄ±m</button>
        </div>
        <div id="activityBellContainer" class="absolute top-3 right-3 hidden">
            <button onclick="toggleActivityFeed()" class="relative p-2 rounded-full hover:bg-white/20 transition-colors" title="Son Eylemler">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <span id="activityCounter" class="absolute top-0 right-0 h-5 w-5 bg-yellow-400 text-black text-xs font-bold rounded-full flex items-center justify-center hidden"></span>
            </button>
        </div>
    </div>

    <div class="flex justify-center flex-wrap gap-4 mb-8">
      <button id="gameTabBtn" onclick="showSection('game')"
              class="relative py-3 px-8 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Kutu Oyunu
      </button>
      <button id="cardCollectionTabBtn" onclick="showSection('cardCollection')"
        class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
  Kart Koleksiyonu
</button>
<button id="monsterBattleTabBtn" onclick="showSection('monsterBattle')"
        class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
  Canavar SavaÅŸÄ±
</button>
       <button id="chanceWheelTabBtn" onclick="showSection('chanceWheel')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Åans Ã‡arkÄ±
      </button>
       <button id="clickCatchTabBtn" onclick="showSection('clickCatch')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        TÄ±kla-Yakala
      </button>
      <button id="storeTabBtn" onclick="showSection('store')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Puan AlÄ±ÅŸveriÅŸi
        <span id="storeIndicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
      </button>
      <button id="announcementsTabBtn" onclick="showSection('announcements')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Duyurular
        <span id="announcementIndicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
      </button>
    </div>
    
    <div id="cardCollectionContent" class="w-full hidden">

    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-4 px-4">

      <div class="flex items-center gap-4">
          <div>
              <div class="flex items-center gap-3">
                  <h3 class="text-yellow-400 text-3xl font-bold">Kart Koleksiyonu AlbÃ¼mÃ¼</h3>
                  <button onclick="openCollectionInfoModal()" class="info-button" title="Oyun HakkÄ±nda Bilgi">?</button>
                  <button id="collectionAdminBtn" onclick="openCollectionAdminModal()" class="hidden py-1 px-3 ml-4 text-sm bg-purple-600 hover:bg-purple-500 rounded-lg">YÃ¶netim Paneli</button>
              </div>
              <div id="seasonCountdownContainer_cards" class="text-sm font-normal mt-2 text-yellow-300 hidden flex justify-center items-center gap-2">
                  <span>Sezonun Bitmesine: <span id="seasonCountdown_cards" class="font-bold text-white tracking-wider"></span></span>
              </div>
          </div>
      </div>

      <div class="w-full md:w-auto text-center md:text-right">
          <div class="flex justify-center md:justify-end gap-x-4 gap-y-1 flex-wrap mb-2">
              <p class="text-lg text-white">Tamamlanan: <span id="collectionProgress" class="font-bold text-green-400">0/0</span></p>
              <div id="wildcardIndicator" class="text-lg text-purple-400 hidden items-center gap-2">
    <span>Joker Kart: <span id="wildcardCount" class="font-bold text-white">0</span> ğŸƒ</span>
    <button id="convertWildcardBtn" onclick="convertWildcard()" class="hidden py-1 px-3 bg-green-600 hover:bg-green-500 rounded-lg text-xs font-bold">DÃ¶nÃ¼ÅŸtÃ¼r</button>
</div>
              <div id="wildcardIndicator" class="text-lg text-purple-400 hidden items-center gap-2">
                  <span>Joker Kart: <span id="wildcardCount" class="font-bold text-white">0</span> ğŸƒ</span>
                  <button id="convertWildcardBtn" onclick="convertWildcard()" class="hidden py-1 px-3 bg-green-600 hover:bg-green-500 rounded-lg text-xs font-bold">DÃ¶nÃ¼ÅŸtÃ¼r</button>
              </div>
          </div>
          <button onclick="openTradeMarket()" class="w-full sm:w-auto py-2 px-4 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-bold">Takas PazarÄ±</button>
      </div>

    </div>

    <div id="collectionStatusOverlay" class="hidden w-full text-center bg-gray-800 border-2 border-yellow-500 rounded-xl p-12 my-6 max-w-4xl mx-auto">
        <h3 id="collectionStatusTitle" class="text-3xl font-bold text-yellow-300 mb-4"></h3>
        <p id="collectionStatusMessage" class="text-lg text-gray-300"></p>
    </div>

    <div id="grandPrizeDisplay" class="my-6 p-6 bg-gradient-to-br from-yellow-500/80 to-amber-600/80 rounded-xl shadow-lg border-2 border-yellow-300 max-w-4xl mx-auto text-center hidden">
        <h3 class="text-2xl font-bold text-white mb-4 text-shadow-lg">TÃ¼m KartlarÄ± Topla ve Bu Ã–dÃ¼lleri Kazan!</h3>
        <div id="prizeList" class="flex flex-wrap justify-center items-center gap-x-8 gap-y-4">
            </div>
    </div>

    <div id="collectionFinishersLeaderboard" class="hidden my-6 p-6 bg-gray-800 rounded-xl shadow-lg border-2 border-green-400 max-w-4xl mx-auto text-center">
    <h3 class="text-2xl font-bold text-green-300 mb-4">ğŸ† Koleksiyon Liderlik SÄ±ralamasÄ± ğŸ†</h3>
    <div id="finishersList" class="space-y-3 text-left">
        </div>
</div>

<div id="collectionCompleteModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[100002] hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-8 rounded-xl shadow-2xl border-4 border-amber-500 w-11/12 max-w-lg text-center relative">
    <h4 id="collectionCompleteTitle" class="text-amber-400 text-3xl font-bold mb-4"></h4>
    <div id="collectionCompleteMessage" class="text-lg text-gray-200 space-y-3 bg-gray-800 p-4 rounded-lg"></div>
    <button onclick="closeCollectionCompleteModal()" class="mt-8 w-full py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">
      Harika!
    </button>
  </div>
</div>

        <div id="collectionAdminModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[50000] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-4xl text-left relative max-h-[90vh] overflow-y-auto scrollable-list">
    <button class="modal-close-button" onclick="closeCollectionAdminModal()">&times;</button>

    <div id="collectionAdminModalContent">
      <h4 class="text-lg font-bold text-purple-300 mb-4 text-center border-b border-gray-700 pb-2">KOLEKSÄ°YON SEZON YÃ–NETÄ°MÄ°</h4>
      <p class="text-center text-gray-400 text-sm mb-4">Mevcut Sezon Durumu: <b id="collectionStatusText" class="text-white">Bilinmiyor</b></p>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="space-y-3">
              <button onclick="openCardCreatorModal()" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg">Kart Ekle/DÃ¼zenle</button>
              <button onclick="openGrandPrizeSettings()" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg">BÃ¼yÃ¼k Ã–dÃ¼lÃ¼ Ayarla</button>
          </div>

          <div class="space-y-3">
              <button onclick="toggleCollectionPause()" id="pauseResumeButton" class="w-full py-3 bg-orange-600 hover:bg-orange-500 text-white font-bold rounded-lg">Sezonu Duraklat</button>
              <button onclick="openTradeHistoryModal()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg">Takas GeÃ§miÅŸi</button>
          </div>

          <div class="space-y-3">
              <button id="toggleSeasonBtn" onclick="toggleCardSeason()" class="w-full h-full py-3 bg-gray-700 text-white font-bold rounded-lg text-lg">
                  YÃ¼kleniyor...
              </button>
          </div>
      </div>

      <div class="mt-6 pt-4 border-t border-gray-700">
          <h4 class="text-lg font-bold text-purple-300 mb-3 text-center">PAZAR AYARLARI</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
              <div class="md:col-span-1">
                  <label for="tradeFeeInput" class="block text-sm font-medium text-gray-300 mb-1">Takas Ä°ÅŸlem Ãœcreti (Puan)</label>
                  <input type="number" id="tradeFeeInput" value="0" class="box-setting-input">
              </div>
              <div class="md:col-span-2 flex flex-col sm:flex-row gap-3 mt-4">
                  <button onclick="saveMarketSettings()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">Ãœcreti Kaydet</button>
                  <button onclick="toggleMarketLock()" id="marketLockBtn" class="w-full py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg">PazarÄ± Kilitle</button>
              </div>
          </div>
      </div>
    </div>

  </div>
</div>

    <div id="cardCollectionAlbum" class="grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-6 p-4 bg-gray-900/50 rounded-xl border border-gray-700">
        </div>

</div>
<div id="monsterBattleContent" class="w-full hidden">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 text-center">
        <div class="flex justify-center items-center gap-4 mb-6">
            <h3 class="text-yellow-400 text-3xl font-bold">Canavar SavaÅŸÄ± ArenasÄ±</h3>
            <button onclick="openMonsterBattleInfoModal()" class="info-button" title="Canavar SavaÅŸÄ± HakkÄ±nda Bilgi">?</button>
            <div id="monsterBattleAdminToggles" class="hidden">
                <button onclick="toggleMonsterAdminPanel()" class="py-1 px-3 text-sm bg-purple-600 hover:bg-purple-500 rounded-lg">Canavar AyarlarÄ±</button>
                <button onclick="toggleAvatarAdminPanel()" class="py-1 px-3 text-sm bg-blue-600 hover:bg-blue-500 rounded-lg">Avatar AyarlarÄ±</button>
            </div>
        </div>

        <div id="monsterAdminControls" class="hidden bg-gray-900/50 p-4 rounded-lg border border-purple-500 mb-6 text-left space-y-3">
    <h4 class="text-purple-300 text-xl font-bold text-center mb-2">Canavar YÃ¶netim Paneli</h4>
    <input type="text" id="adminMonsterName" class="box-setting-input" placeholder="Canavar AdÄ±">
    <input type="text" id="adminMonsterImageUrl" class="box-setting-input" placeholder="Canavar Resim URL">
    <input type="number" id="adminMonsterMaxHP" class="box-setting-input" placeholder="Canavar Maksimum Can">
    <div class="grid grid-cols-2 gap-2">
        <input type="number" id="adminMonsterMinDamage" class="box-setting-input" placeholder="Min Hasar">
        <input type="number" id="adminMonsterMaxDamage" class="box-setting-input" placeholder="Max Hasar">
    </div>
    <input type="number" id="adminMonsterDefense" class="box-setting-input" placeholder="Savunma (%)">
    <div class="grid grid-cols-2 gap-2">
        <input type="number" id="adminMonsterCritChance" class="box-setting-input" placeholder="Kritik ÅansÄ± (%)">
        <input type="number" id="adminMonsterCritDamage" class="box-setting-input" placeholder="Kritik Hasar (%)">
    </div>
    <div class="grid grid-cols-2 gap-2">
        <input type="number" id="adminMonsterDodgeChance" class="box-setting-input" placeholder="SÄ±yrÄ±lma ÅansÄ± (%)">
        <input type="number" id="adminMonsterPierceChance" class="box-setting-input" placeholder="Delici ÅansÄ± (%)">
    </div>
    <hr class="border-gray-600">
    <h5 class="text-yellow-300 font-bold">Ã–dÃ¼ller</h5>
    <label class="block text-sm font-medium text-gray-300 mb-1">Canavar Ã–lÃ¼nce Lidere Verilecek Ã–dÃ¼l:</label>
    <div class="grid grid-cols-2 gap-2">
        <select id="adminMonsterKillRewardType" class="box-setting-input">
            <option value="points">ğŸ’° Puan</option>
            <option value="boxRights">ğŸ“¦ Kutu HakkÄ±</option>
            <option value="wheelTicket">ğŸ« Ã‡ark Bileti</option>
            <option value="clickCatchTicket">ğŸŸï¸ TÄ±kla-Yakala Bileti</option>
            <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
            <option value="wildcard">ğŸƒ Joker Kart</option>
            <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
            <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
            <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
            <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
            <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
            <option value="health_regen_potion">ğŸ§ª Can Yenileme Ä°ksiri</option>
            <option value="revival_stone">ğŸ’ Dirilme TaÅŸÄ±</option>
            <option value="health_potion">ğŸ§ª Can Ä°ksiri</option>
            <option value="damage_potion">âš”ï¸ Hasar Ä°ksiri</option>
            <option value="defense_potion">ğŸ›¡ï¸ Savunma Ä°ksiri</option>
            <option value="crit_potion">ğŸ’¥ Kritik VuruÅŸ Ä°ksiri</option>
            <option value="crit_damage_potion">ğŸ¯ Kritik Hasar Ä°ksiri</option>
            <option value="dodge_potion">ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± Ä°ksiri</option>
            <option value="pierce_potion">ğŸ“Œ Delici ÅansÄ± Ä°ksiri</option>
        </select>
        <input type="number" id="adminMonsterKillReward" class="box-setting-input" placeholder="Miktar">
    </div>
    <button onclick="saveAndSpawnMonster()" class="w-full py-2 bg-green-700 hover:bg-green-600 rounded-lg font-bold">Kaydet ve CanavarÄ± Ã‡aÄŸÄ±r</button>
    <hr class="border-gray-600 mt-4">
    <h5 class="text-yellow-300 font-bold mt-2">Hasar BaÅŸÄ±na Rastgele Ã–dÃ¼ller</h5>
    <p class="text-xs text-gray-400 mb-2">Hasar eÅŸiÄŸini geÃ§en oyunculara aÅŸaÄŸÄ±daki Ã¶dÃ¼llerden BÄ°RÄ°, belirtilen ÅŸansla verilir.</p>
    <div id="damageTiersContainer" class="space-y-3">
    </div>
    <button onclick="addDamageTierRow()" class="w-full py-2 mt-2 bg-blue-700 hover:bg-blue-600 rounded-lg text-sm font-bold">Yeni Hasar AralÄ±ÄŸÄ± Ekle</button>
</div>
        <div id="avatarAdminControls" class="hidden bg-gray-900/50 p-4 rounded-lg border border-blue-500 mb-6 text-left space-y-3">
            <h4 class="text-blue-300 text-xl font-bold text-center mb-2">Avatar Ä°statistik YÃ¶netimi</h4>
            <div id="avatarStatEditor" class="space-y-4 max-h-96 overflow-y-auto scrollable-list pr-2">
                </div>
                <div class="mt-4 pt-4 border-t border-gray-600">
    <h4 class="text-blue-300 text-xl font-bold text-center mb-3">Ä°ksir Bonus Limitleri (Caps)</h4>
    <p class="text-xs text-gray-400 text-center mb-3">
        KullanÄ±cÄ±larÄ±n kalÄ±cÄ± iksir bonuslarÄ± ile ulaÅŸabileceÄŸi maksimum deÄŸerleri buradan ayarlayÄ±n. BoÅŸ bÄ±rakÄ±lÄ±rsa limitsiz olur.
    </p>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <input type="number" id="potionCapHp" class="box-setting-input" placeholder="Can Limiti">
        <input type="number" id="potionCapDamage" class="box-setting-input" placeholder="Hasar Limiti">
        <input type="number" id="potionCapDefense" class="box-setting-input" placeholder="Savunma Limiti">
        <input type="number" id="potionCapCritDamage" class="box-setting-input" placeholder="Kritik Hasar %">
        <input type="number" id="potionCapDodge" class="box-setting-input" placeholder="SÄ±yrÄ±lma %">
        <input type="number" id="potionCapPierce" class="box-setting-input" placeholder="Delici VuruÅŸ %">
        <input type="number" id="potionCapCrit" class="box-setting-input" placeholder="Kritik VuruÅŸ %">
    </div>
    <button onclick="savePotionCaps()" class="w-full py-2 bg-blue-700 hover:bg-blue-600 rounded-lg font-bold mt-3">Bonus Limitlerini Kaydet</button>
</div>
            <button onclick="saveAvatarStats()" class="w-full py-2 bg-green-700 hover:bg-green-600 rounded-lg font-bold mt-2">TÃ¼m Avatar Ä°statistiklerini Kaydet</button>
        </div>
        <div id="lastChampionPanel" class="hidden w-full max-w-2xl mx-auto mb-6 bg-gray-800 p-4 rounded-xl shadow-lg border-2 border-amber-500 text-center relative">
    </div>

        <div id="battleArenaContainer">
    <div id="battleArena" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="monster-container lg:col-span-1 bg-gray-900/50 p-4 rounded-lg flex flex-col items-center relative">
            <div id="monsterInstanceAdminControls" class="absolute top-2 right-2 flex gap-2 hidden">
                <button onclick="editCurrentMonster()" class="p-2 bg-blue-600 hover:bg-blue-500 rounded-full text-white" title="Mevcut CanavarÄ± DÃ¼zenle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a1 1 0 011-1h2.586l-2 2H6v3h3v-1.586l2-2H13a1 1 0 011 1v5a1 1 0 01-1 1H6a1 1 0 01-1-1v-2z" /></svg>
                </button>
                <button onclick="deleteCurrentMonster()" class="p-2 bg-red-700 hover:bg-red-600 rounded-full text-white" title="Bu CanavarÄ± KaldÄ±r">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            
            <h4 id="monsterName" class="text-2xl font-bold text-red-400">Canavar YÃ¼kleniyor...</h4>
            <img id="monsterImage" src="https://i.hizliresim.com/n01dnz4.png" class="w-48 h-48 my-4 object-contain cursor-pointer transition-transform hover:scale-105" onclick="openMonsterInfoModal()">
            <div class="w-full bg-gray-700 rounded-full h-6 border-2 border-black">
                <div id="monsterHealthBar" class="bg-red-600 h-full rounded-full text-center text-white text-xs font-bold transition-all duration-500" style="width: 100%;">100%</div>
            </div>
            <p id="monsterHealthText" class="text-sm mt-1 text-gray-300">YÃ¼kleniyor...</p>
        </div>

        <div class="leaderboard-container lg:col-span-2 bg-gray-900/50 p-4 rounded-lg">
            <h4 class="text-xl font-bold text-yellow-300 mb-3 border-b border-gray-600 pb-2">En Ã‡ok Hasar Verenler</h4>
            <div id="monsterLeaderboard" class="space-y-2 max-h-80 overflow-y-auto scrollable-list pr-2 mb-4">
            </div>

            <div class="player-controls bg-gray-800 p-4 rounded-lg mt-4">
                <h5 class="text-lg font-bold text-green-400" id="playerBattleName">Oyuncu YÃ¼kleniyor...</h5>
                <a onclick="openAvatarStatsModal(currentUser)" class="text-xs text-cyan-400 hover:text-cyan-300 cursor-pointer underline">
    Avatar Ã–zellikleri
</a>
                <div class="w-full bg-gray-700 rounded-full h-5 my-2 border border-black">
                     <div id="playerHealthBar" class="bg-green-500 h-full rounded-full text-center text-black text-xs font-bold transition-all duration-500" style="width: 100%;">100%</div>
                </div>
                <p id="playerHealthText" class="text-sm text-gray-300 mb-3">YÃ¼kleniyor...</p>

                <div id="playerBuffs" class="flex justify-center items-center gap-4 mb-3 min-h-[30px]"></div>
                
                <div id="defeatMessageContainer" class="hidden text-center mb-3"></div>
                <div id="potionStoreBtnContainer" class="my-3">
    <button onclick="goToMonsterStore()" class="w-full py-2 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-lg shadow-md">
        ğŸ‘¹ Canavar MaÄŸazasÄ±na Git
    </button>
</div>
<div id="regenPotionContainer" class="mb-3"></div>
<div id="revivalStoneContainer" class="hidden text-center mb-3"></div>

<button id="attackMonsterBtn" onclick="attackMonster()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold text-lg rounded-lg shadow-lg disabled:bg-gray-600 disabled:cursor-not-allowed">
    SALDIR!
</button>
<button id="reviveBtn" class="hidden w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold text-lg rounded-lg shadow-lg">
    ğŸ’ Dirilme TaÅŸÄ± Kullan
</button>

<div id="playerRankInfo" class="mt-4 text-center bg-gray-900/50 p-3 rounded-lg border border-gray-700">
    <p class="text-gray-400">SÄ±ralama ve hasar bilgin iÃ§in Ã¶nce canavara saldÄ±rmalÄ±sÄ±n.</p>
</div>
            </div>
        </div>
    </div>
    <div id="monsterDefeatedScreen" class="hidden bg-gray-800 p-8 rounded-xl text-center">
        <h3 id="monsterDefeatedTitle" class="text-3xl font-bold text-green-300 mb-4"></h3>
        <p id="monsterDefeatedMessage" class="text-lg text-gray-300"></p>
    </div>
</div>
    </div>
</div>
    <div id="mainContentArea" class="w-full">
    <div id="gameContent" class="w-full">
      <div class="text-lg text-gray-300 mb-6 text-center flex flex-wrap justify-center items-center gap-4">
        <button id="boxSettingsButton" onclick="openBoxSettingsModal()" class="hidden py-1 px-3 text-sm bg-purple-600 hover:bg-purple-500 rounded-lg">Kutu AyarlarÄ±</button>
        <span>Toplam AÃ§Ä±lan: <b id="totalOpenedBoxesCount" class="font-bold text-yellow-400">0</b></span>
        <button onclick="openBoxStatsModal()" class="py-1 px-3 text-sm bg-blue-600 hover:bg-blue-500 rounded-lg">AÃ§anlar Detay</button>
        <button onclick="openUnopenedBoxContentsModal()" class="py-1 px-3 text-sm bg-green-600 hover:bg-green-500 rounded-lg">Kalan Ä°Ã§erikler</button>
        <button onclick="openSolveProblemsModal()" class="py-1 px-3 text-sm bg-orange-600 hover:bg-orange-500 rounded-lg">SorunlarÄ± Ã‡Ã¶z</button>
      </div>

      <div id="boxContainer" class="grid grid-cols-[repeat(auto-fill,minmax(80px,1fr))] gap-2 w-full mx-auto mb-8 p-2">
      </div>
      <div id="lastSurpriseFinderPanel" class="hidden w-full max-w-2xl mx-auto mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border-2 border-amber-400 text-center space-y-3">
        </div>
      <div id="tablesWrapper" class="flex flex-wrap justify-center gap-6 mb-8">
        <div class="tableBox bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 w-full md:flex-1 min-w-[280px] md:max-w-md">
            <h3 class="text-yellow-400 text-xl font-bold border-b border-gray-600 pb-3 mb-4">KARÄ°YER PUANI SIRALAMASI ğŸ†</h3>
            <p class="text-gray-300 mb-3">Toplam KullanÄ±cÄ±: <span id="totalUsers" class="font-bold text-yellow-400">0</span></p>
            <input type="text" id="searchUserRanking" oninput="renderUserRankings()" placeholder="SÄ±ralamada KullanÄ±cÄ± Ara..." class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <div id="allUserRankings" class="scrollable-list max-h-80 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-900 text-sm leading-relaxed">YÃ¼kleniyor...</div>
        </div>
        <div class="tableBox bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 w-full md:flex-1 min-w-[280px] md:max-w-md">
           <h3 class="text-yellow-400 text-xl font-bold border-b border-gray-600 pb-3 mb-4 flex justify-between items-center">
                <span>LÄ°DERLER SIRALAMASI ğŸ‘‘</span>
                <button onclick="openBadgeInfoModal()" class="text-xl text-blue-400 hover:text-blue-300 transition-colors" title="Rozet Bilgileri">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
            </h3>
          <div id="badgedUsersRanking" class="scrollable-list max-h-80 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-900 text-sm leading-relaxed">YÃ¼kleniyor...</div>
          
        </div>
      </div>
    </div>

        <div id="chanceWheelContent" class="w-full hidden">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 text-center">
        <div class="flex justify-center items-center gap-4 mb-4">
            <h3 class="text-yellow-400 text-3xl font-bold">Åans Ã‡arkÄ±</h3>
            <button onclick="openWheelLegendModal()" class="info-button" title="Simge AnlamlarÄ±">?</button>
            <button id="wheelSettingsButton" onclick="openWheelSettingsModal()" class="hidden py-1 px-3 text-sm bg-teal-600 hover:bg-teal-500 rounded-lg">Ã‡ark AyarlarÄ±</button>
        </div>
        
        <p class="text-gray-300 mb-2">Ã‡arkÄ± Ã§evirerek harika Ã¶dÃ¼ller kazanma ÅŸansÄ± yakala!</p>
        <p class="text-lg font-semibold mb-4">Ã‡evirme Bedeli: <span class="text-green-400">1 Ã‡ark Bileti</span> | Mevcut Biletlerin: <span id="wheelTicketBalance" class="text-yellow-400 font-bold">0</span></p>
        
        <div id="wheelContainer">
            <div id="wheel"></div>
            <div id="wheelMarker"></div>
        </div>

        <button id="spinWheelBtn" onclick="spinWheel()" class="py-3 px-10 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
            Ã‡arkÄ± Ã‡evir!
        </button>
        
        <div id="lastWheelSurprisePanel" class="hidden w-full max-w-lg mx-auto mt-6 bg-gray-900/50 p-4 rounded-xl shadow-lg border-2 border-amber-400 text-center space-y-2">
        </div>
            
        <div class="mt-8 bg-gray-900/50 p-4 rounded-lg border border-gray-700 max-w-lg mx-auto">
            <h4 class="text-yellow-300 text-lg font-semibold mb-3">Son Kazananlar</h4>
            <div id="wheelHistoryList" class="scrollable-list max-h-40 overflow-y-auto text-left">
            </div>
        </div>
    </div>
</div>
<div id="solveProblemsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-orange-500 w-11/12 max-w-lg text-center relative">
    <button class="modal-close-button" onclick="closeSolveProblemsModal()">&times;</button>
    <h4 class="text-orange-300 text-2xl font-bold mb-6">Sorun Giderme MenÃ¼sÃ¼</h4>
    <p class="text-gray-400 mb-6">Buradaki araÃ§larÄ± kullanarak oyunda oluÅŸabilecek genel sorunlarÄ± Ã§Ã¶zebilirsiniz.</p>
    <div class="space-y-4">
        <button onclick="manualUnlockGame()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">
            Kutu aÃ§maya devam et. (Kutu aÃ§Ä±lmÄ±yorsa)
        </button>
        <button onclick="manualResetAfterSurprise()" class="w-full py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">
            KutularÄ± sÄ±fÄ±rla (SÃ¼rpriz Kutu Bulunduysa)
        </button>
    </div>
  </div>
</div>
<div id="cardCreatorModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[50001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-yellow-500 w-11/12 max-w-lg text-left relative">
    <button class="modal-close-button" onclick="closeCardCreatorModal()">&times;</button>
    <h3 id="cardFormTitle" class="text-yellow-300 text-3xl font-bold mb-6 text-center">Yeni Kart OluÅŸtur</h3>
    <div class="space-y-4">
      <input type="text" id="cardNameInput" placeholder="Kart AdÄ± (Ã–rn: Efsanevi Mikrofon)" class="box-setting-input">
      <input type="text" id="cardImageUrlInput" placeholder="Kart Resim URL'si (hizliresim.com linki)" class="box-setting-input">

      <div>
        <label class="block text-sm font-medium text-gray-300 mb-1">Nadirlik Seviyesi:</label>
        <select id="cardRarityInput" class="box-setting-input">
          <option value="normal">Bronz (Bronz Ã‡erÃ§eve)</option>
          <option value="gumus">GÃ¼mÃ¼ÅŸ (GÃ¼mÃ¼ÅŸ Ã‡erÃ§eve)</option>
          <option value="altin">AltÄ±n (AltÄ±n Ã‡erÃ§eve)</option>
          <option value="efsanevi">Efsanevi (Hareketli Ã‡erÃ§eve)</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-300 mb-1">Åans AÄŸÄ±rlÄ±ÄŸÄ±:</label>
        <input type="number" id="cardChanceInput" placeholder="Ã–rn: Normal=100, Efsanevi=5" class="box-setting-input">
        <p class="text-xs text-gray-500 mt-1">Bu sayÄ±nÄ±n yÃ¼ksek olmasÄ±, kartÄ±n paketten Ã§Ä±kma ihtimalini artÄ±rÄ±r.</p>
      </div>
      </div>
    <div class="mt-6">
      <button id="saveCardBtn" onclick="saveCard()" class="w-full py-3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded-lg shadow-md">KARTI KAYDET</button>
    </div>
  </div>
</div>
      <div id="lobbyNotificationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-blue-500 w-11/12 max-w-md text-center relative">
    <h4 class="text-blue-400 text-3xl font-bold mb-4">ğŸ“¢ TÄ±kla-Yakala Lobisi Kuruldu! ğŸ“¢</h4>
    <div id="lobbyNotificationInfo" class="text-lg text-gray-200 space-y-3 bg-gray-900 p-4 rounded-lg">
        </div>
    <div class="flex gap-4 mt-8">
        <button onclick="closeLobbyNotificationModal()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">
          Kapat
        </button>
        <button onclick="goToLobbySection()" class="flex-1 py-3 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md">
          Lobiye Git
        </button>
    </div>
  </div>
</div>

        <div id="clickCatchContent" class="w-full hidden">

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 text-center">
            <div class="flex justify-center items-center gap-4 mb-4">
    <h3 class="text-yellow-400 text-3xl font-bold">TÄ±kla-Yakala</h3>
    <button onclick="openClickCatchInfoModal()" class="info-button" title="Oyun ModlarÄ± HakkÄ±nda Bilgi">?</button>
</div>
            <div id="weeklyWinnerContainer" class="hidden w-full max-w-2xl mx-auto mt-6 mb-4 bg-gray-800 p-4 rounded-xl shadow-lg border-2 border-green-500 text-center relative">
<h4 class="text-green-300 text-xl font-bold mb-3">ğŸ† HaftanÄ±n TÄ±kla-Yakala Åampiyonu ğŸ†</h4>
<div id="weeklyWinnerInfo" class="text-lg text-gray-200 space-y-2">
    </div>
<button id="clearWeeklyWinnerBtn" onclick="clearWeeklyWinnerDisplay()" class="hidden absolute -top-3 -right-3 bg-red-600 hover:bg-red-500 text-white rounded-full h-8 w-8 flex items-center justify-center text-lg font-bold" title="Kazanan Panelini Gizle">&times;</button>
</div>

            <div id="clickCatchAdminButtonsContainer" class="hidden bg-gray-900/50 p-4 rounded-lg border border-yellow-500 mb-6 flex justify-center gap-4">
                <button onclick="openSoloGameSettingsModal()" class="py-3 px-6 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-md">
                    Tekli Oyun AyarlarÄ±
                </button>
                <button onclick="openLobbySettingsModal()" class="py-3 px-6 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">
                    Lobi YÃ¶netim Paneli
                </button>
            </div>

            <div id="lastWinnerContainer" class="hidden bg-gray-900/50 p-4 rounded-lg border border-yellow-400 mb-6 text-left">
<h4 id="lastWinnerInfo" class="text-yellow-300 text-xl font-semibold mb-3 border-b border-gray-700 pb-2"></h4>
<div id="lastGameDetailsList" class="space-y-2">
    </div>
</div>

            <div id="lobbyStatusContainer" class="hidden bg-blue-900/50 p-4 rounded-lg border border-blue-400 mb-6">
                <h4 id="lobbyStatusTitle" class="text-blue-300 text-xl font-semibold animate-pulse">Lobi KatÄ±lÄ±ma AÃ§Ä±k!</h4>
                <p id="lobbyStatusInfo" class="mt-2 text-gray-200"></p>
                <div id="lobbyPlayerList" class="mt-2 text-sm text-gray-400"></div>
            </div>

            <div class="flex justify-around items-center flex-wrap gap-y-2 mb-4 bg-gray-900 p-3 rounded-lg">
                <div id="displayScore" class="hidden">
                    <p class="text-gray-400 text-sm">Toplanan Skor</p>
                    <p id="clickCatchScore" class="text-green-400 font-bold text-lg">0</p>
                </div>
                <div id="displaySpecials" class="hidden">
                    <p class="text-gray-400 text-sm">AlÄ±nan Ã–dÃ¼ller</p>
                    <div id="collectedSpecials" class="h-[28px] flex items-center justify-center gap-2"></div>
                </div>
                <div id="displayTarget" class="hidden">
                    <p class="text-gray-400 text-sm">Hedef</p>
                    <p id="clickCatchTarget" class="text-purple-400 font-bold text-lg">0 / 10</p>
                </div>
                <div id="displayTimer" class="hidden">
                    <p class="text-gray-400 text-sm">Kalan SÃ¼re</p>
                    <p id="clickCatchTimer" class="text-yellow-400 font-bold text-lg">30</p>
                </div>
            </div>
            <div id="clickCatchGameAreaContainer" class="flex justify-center mb-4">
                <div id="clickCatchGameArea">
                     <div id="clickCatchStartScreen" class="w-full h-full flex flex-col justify-center items-center bg-black bg-opacity-50">
                        <p class="text-xl mb-6">Oyun Modunu SeÃ§</p>
                        <div class="flex gap-4">
                           <button id="startSoloGameBtn" onclick="startSoloClickCatchGame()" class="py-3 px-10 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-md">Tek Oyna</button>
                           <button id="joinLobbyBtn" onclick="joinLobby()" class="py-3 px-10 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Lobiye KatÄ±l</button>
                        </div>
                    </div>

                    <div id="gameCountdownOverlay" class="absolute inset-0 bg-gray-900/90 hidden flex-col justify-center items-center text-center z-20">
                        <p class="text-6xl font-extrabold text-yellow-400 animate-pulse" id="countdownText"></p>
                    </div>

                    <div id="lobbyGameOverScreen" class="absolute inset-0 bg-gray-900/95 rounded-lg hidden flex flex-col items-center justify-center p-8 text-center border-4 border-gray-700">
                        <h4 id="lobbyGameOverTitle" class="text-white text-3xl font-bold mb-4">Oyun Bitti!</h4>
                        <p id="lobbyGameOverInfo" class="text-xl text-gray-200 mb-6"></p>
                        <button onclick="closeLobbyGameOverScreen()" class="mt-4 py-2 px-6 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
                            Oyun EkranÄ±na DÃ¶n
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tableBox bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 w-full md:flex-1 min-w-[280px] mt-6 mx-auto max-w-2xl">
<h3 class="text-yellow-400 text-xl font-bold border-b border-gray-600 pb-3 mb-4">TIKLA-YAKALA HAFTALIK SKOR SIRALAMASI ğŸ¯</h3>
<input type="text" id="searchClickCatchRanking" oninput="loadClickCatchRankings()" placeholder="SÄ±ralamada KullanÄ±cÄ± Ara..." class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">

<div id="weeklyResetCountdownContainer" class="hidden text-center bg-purple-900/50 border border-purple-400 text-purple-200 p-3 rounded-lg mb-4">
    <div class="flex justify-center items-center gap-2">
        <span>HaftalÄ±k Liderin Belirlenmesine: <span id="weeklyResetCountdown" class="font-bold text-white tracking-wider"></span></span>
        <button onclick="openWeeklyResetInfoModal()" class="text-blue-400 hover:text-blue-300 transition-colors" title="HaftalÄ±k SÄ±fÄ±rlama HakkÄ±nda Bilgi">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>
    </div>
</div>

<div id="clickCatchRankings" class="scrollable-list max-h-80 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-900 text-sm leading-relaxed">YÃ¼kleniyor...</div>
</div>

        </div>
            
        <div id="storeSection" class="w-full hidden">
          <h3 class="text-yellow-400 text-3xl font-bold mb-2 text-center">MaÄŸaza</h3>
          <div id="storeUserPointInfo" class="text-center mb-6 bg-gray-800 p-3 rounded-lg border border-gray-700 max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
    <div class="text-lg">
        <span class="text-green-400">Puan: <b id="storeCurrentUserBalance">0</b></span> |
        <span class="text-red-400">Harcanan: <b id="storeCurrentUserSpent">0</b></span>
    </div>
    <div class="text-lg">
        <span class="text-purple-400"> Kasa PuanÄ±: <b id="storeCurrentUserKasaBalance">0</b></span>
    </div>
    <button onclick="openPurchaseHistoryModal()" class="py-1 px-4 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg text-sm w-full md:w-auto justify-self-center">
        AlÄ±ÅŸveriÅŸ GeÃ§miÅŸim
    </button>
</div>
          
          <div id="adminStoreManagementButtonContainer" class="text-center mb-6 hidden">
             <button onclick="openNewItemForm()" class="py-2 px-6 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
               Yeni ÃœrÃ¼n Ekle
             </button>
          </div>
        
          <div class="flex border-b border-gray-600 mb-6 max-w-md mx-auto">
            <button id="gameStoreTabBtn" onclick="switchStoreTab('game')" class="flex-1 py-3 text-lg font-bold border-b-2 border-red-500 text-white transition-colors duration-300">Oyun MaÄŸazasÄ±</button>
            <button id="specialStoreTabBtn" onclick="switchStoreTab('special')" class="flex-1 py-3 text-lg font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors duration-300">Ã–zel ÃœrÃ¼n MaÄŸazasÄ±</button>
          </div>
          
          <div id="kasaTransferBolumu" class="bg-gray-900/50 p-6 rounded-xl border-2 border-purple-500 text-center mb-8 max-w-lg mx-auto">
    <div class="flex justify-center items-center gap-4 mb-3">
        <h4 class="text-purple-300 text-2xl font-bold">Puan KasasÄ±</h4>
        <button id="kasaSettingsBtn" onclick="openKasaSettingsModal()" class="hidden py-1 px-3 text-sm bg-gray-600 hover:bg-gray-500 rounded-lg">Ayarlar</button>
    </div>
    <p class="text-gray-400 mb-4">Sezon sÄ±fÄ±rlamasÄ±ndan etkilenmeyecek puanlarÄ±nÄ± buraya aktar. Bu puanlar sadece <b class="text-white">Ã–zel ÃœrÃ¼n MaÄŸazasÄ±'nda</b> kullanÄ±labilir ve sÄ±ralamaya etki etmez.</p>
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
    <input type="number" id="kasaTransferInput" min="1" placeholder="MiktarÄ± Girin" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500">
    <button onclick="kasaTransferEt()" class="py-3 px-6 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md whitespace-nowrap">Kasaya Aktar</button>
</div>
</div>

<div id="kasaSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeKasaSettingsModal()">&times;</button>
    <h4 class="text-purple-300 text-2xl font-bold mb-6">Kasa Transfer AyarlarÄ±</h4>
    <div>
      <label for="minKasaTransferInput" class="block text-sm font-medium text-gray-300 mb-2">Minimum Transfer TutarÄ±</label>
      <input type="number" id="minKasaTransferInput" placeholder="Ã–rn: 1000 (0 yazÄ±lÄ±rsa limit olmaz)" class="box-setting-input">
      <p class="text-xs text-gray-500 mt-1">Bu tutarÄ±n altÄ±ndaki transferlere izin verilmez.</p>
    </div>
    <div class="mt-6">
      <button onclick="saveKasaSettings()" class="w-full py-3 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md">AyarlarÄ± Kaydet</button>
    </div>
  </div>
</div>

<div id="multiplierChoiceModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-yellow-500 w-11/12 max-w-lg text-center relative">
    <h4 class="text-yellow-400 text-2xl font-bold mb-4">âš¡ Ã‡arpan YÃ¼kseltmesi! âš¡</h4>
    <p class="text-gray-300 mb-6" id="multiplierChoiceInfo">YÃ¼kleniyor...</p>
    <div class="flex flex-col sm:flex-row gap-4">
        <button id="choiceConvertBtn" class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">
            </button>
        <button id="choiceCombineBtn" class="flex-1 py-3 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md">
            </button>
    </div>
  </div>
</div>
          
          <div id="gameStoreItemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
            </div>
        
          <div id="specialStoreItemsContainer" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
            </div>
        </div>
        
        <div id="announcementsContent" class="w-full hidden">
            <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">Duyurular</h3>
            
            <div id="adminAnnouncementControls" class="hidden bg-gray-800 p-6 rounded-lg border border-gray-700 mb-8 max-w-2xl mx-auto">
              <h4 id="announcementFormTitle" class="text-yellow-300 text-xl font-semibold mb-4">Yeni Duyuru Yap</h4>
              <textarea id="announcementText" placeholder="Duyuru metnini buraya yazÄ±n... KullanÄ±cÄ±larÄ± etiketlemek iÃ§in @kullaniciadi formatÄ±nÄ± kullanÄ±n." rows="4" class="w-full p-2 mb-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500"></textarea>
              <div class="flex gap-4">
                <button id="postAnnouncementBtn" onclick="postAnnouncement()" class="flex-1 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">DUYURU YAP</button>
                <button id="cancelEditAnnouncementBtn" onclick="resetAnnouncementForm()" class="hidden py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg">Ä°ptal</button>
              </div>
            </div>

            <div id="announcementsList" class="space-y-6 max-w-2xl mx-auto">
                <p class="text-center text-gray-400">Duyurular yÃ¼kleniyor...</p>
            </div>
        </div>
    </div>
</div>
  
<div id="adminStoreModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-60 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-3xl text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button" onclick="closeAdminStoreModal()">&times;</button>
      <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">ÃœrÃ¼n Ekle / DÃ¼zenle</h3>
      <div id="adminStoreControls" class="bg-gray-900 p-6 rounded-lg border border-gray-700 mb-6">
          <div class="mb-4">
            <input type="text" id="newItemName" placeholder="ÃœrÃ¼n AdÄ±" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <textarea id="newItemDescription" placeholder="ÃœrÃ¼n AÃ§Ä±klamasÄ±" rows="3" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300"></textarea>
            <input type="number" id="newItemCost" placeholder="Maliyet (Puan)" min="1" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <input type="number" id="newItemStock" placeholder="Stok Durumu (Opsiyonel, boÅŸ bÄ±rakÄ±lÄ±rsa sÄ±nÄ±rsÄ±z)" min="0" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <select id="newItemType" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-yellow-500" onchange="handleStoreItemTypeChange()">
              <option value="">ÃœrÃ¼n Tipi SeÃ§in</option>
              <option value="boxRights">ğŸ“¦ Kutu HakkÄ±</option>
              <option value="wheelTicket">ï¸ğŸ« Ã‡ark Bileti</option>
              <option value="clickCatchTicket">ğŸŸï¸ TÄ±kla-Yakala Bileti</option>
              <option value="tempMultiplier">âœ–ï¸ GeÃ§ici Ã‡arpan</option>
              <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
              <option value="wildcard">ğŸƒ Joker Kart</option>
              <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
              <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
              <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
              <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
              <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
              <option value="health_regen_potion">ğŸ§ª Can Yenileme Ä°ksiri</option> <option value="revival_stone">ğŸ’ Dirilme TaÅŸÄ±</option>
              <option value="health_potion">ğŸ§ª Can Ä°ksiri</option>
              <option value="defense_potion">ğŸ›¡ï¸ Savunma Ä°ksiri</option>
              <option value="damage_potion">âš”ï¸ Hasar Ä°ksiri</option>
              <option value="crit_damage_potion">ğŸ¯ Kritik Hasar Ä°ksiri</option>
              <option value="dodge_potion">ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± Ä°ksiri</option>
              <option value="pierce_potion">ğŸ“Œ Delici ÅansÄ± Ä°ksiri</option>
              <option value="crit_potion">ğŸ’¥ Kritik ÅansÄ± Ä°ksiri</option>
              <option value="special">ğŸš€ Ã–zel ÃœrÃ¼n (Onay Gerektirir)</option>
            </select>
            <input type="text" id="newItemValue" placeholder="DeÄŸer (Kutu HakkÄ± Adedi / Ã‡arpan DeÄŸeri / Kalkan SayÄ±sÄ±)" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <input type="number" id="newItemMultiplierDuration" placeholder="Ã‡arpan SÃ¼resi (Kutu SayÄ±sÄ±)" min="1" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white hidden focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <input type="number" id="newItemPriceIncrease" placeholder="Her AlÄ±mda Fiyat ArtÄ±ÅŸÄ± (Puan)" min="0" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white hidden focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            
            <label class="text-gray-300 text-sm block mt-2 mb-1 text-left">Geri SayÄ±m SÃ¼resi (BoÅŸ BÄ±rakÄ±lÄ±rsa SÃ¼resiz):</label>
            <div class="flex gap-2 mb-4">
                <input type="number" id="storeItemCountdownDays" placeholder="GÃ¼n" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <input type="number" id="storeItemCountdownHours" placeholder="Saat" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <input type="number" id="storeItemCountdownMinutes" placeholder="Dakika" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <input type="number" id="storeItemCountdownSeconds" placeholder="Saniye" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>

            <input type="text" id="newItemImageUrl" placeholder="Resim URL (Opsiyonel)" class="w-full p-2 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <button onclick="saveStoreItem()" id="addUpdateStoreItemBtn" class="w-full py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">ÃœRÃœN EKLE</button>
            <button onclick="resetStoreItemForm()" class="w-full py-2 mt-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md hover:-translate-y-1 transition duration-300">Formu Temizle</button>
          </div>
        </div>
  </div>
</div>

<div id="purchaseHistoryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-2xl text-center relative max-h-[90vh]">
        <button class="modal-close-button absolute top-2 right-4 text-white text-4xl leading-none bg-transparent border-none cursor-pointer hover:text-red-500 transition duration-200" onclick="closePurchaseHistoryModal()">&times;</button>
        <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">SatÄ±n Alma GeÃ§miÅŸi</h3>
        <div id="purchaseHistoryList" class="scrollable-list max-h-[70vh] overflow-y-auto">
            <div class='text-center text-gray-400'>SatÄ±n alma geÃ§miÅŸi yÃ¼kleniyor...</div>
        </div>
    </div>
</div>

<div id="boxStatsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-lg text-center relative max-h-[90vh]">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl" onclick="closeBoxStatsModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-4">GÃ¼ncel Tur Kutu AÃ§ma Ä°statistikleri</h4>
      <p class="text-sm text-gray-400 mb-6">Bu istatistikler oyun sÄ±fÄ±rlandÄ±ÄŸÄ±nda temizlenir.</p>
      <div id="boxStatsList" class="scrollable-list max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-lg">
          YÃ¼kleniyor...
      </div>
  </div>
</div>

<div id="globalSurpriseBoxModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-md text-center relative">
        <h4 class="text-yellow-400 text-3xl font-bold mb-4">ğŸ‰ SÃœRPRÄ°Z KUTU! ğŸ‰</h4>
        <div class="text-lg text-gray-200 space-y-3">
            <p><span id="surpriseOpener" class="text-green-400 font-bold text-2xl"></span> adlÄ± kullanÄ±cÄ±,</p>
            <p id="surpriseSourceInfo"></p>
            <p class="text-3xl text-yellow-300 font-extrabold my-4">
                <span id="surprisePoints"></span> Puan
            </p>
            <p id="surpriseMultiplierInfo" class="text-base text-gray-400 -mt-2"></p>
            <p>kazandÄ±!</p>
        </div>
        <button onclick="closeGlobalSurpriseBoxModal()" class="mt-8 w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">
            Tamam
        </button>
    </div>
</div>

<div id="adminPanelModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[5000] hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-2xl border border-yellow-500 w-full max-w-7xl h-[95vh] text-white relative flex flex-col">
    <button class="modal-close-button" onclick="closeAdminPanelModal()">&times;</button>
    
    <div class="flex-shrink-0 mb-4">
      <h3 class="text-yellow-300 text-3xl font-bold text-center">YÃ¶netim Paneli</h3>
      <p class="text-center text-gray-400">TÃ¼m yÃ¶netim araÃ§larÄ± elinizin altÄ±nda.</p>
    </div>

    <div class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto scrollable-list pr-2">
      
      <div class="flex flex-col gap-6">
        <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700">
          <h4 class="text-yellow-200 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Onay Bekleyenler</h4>
          <div class="space-y-4">
            <div>
              <h5 class="text-gray-300 font-bold mb-2">KullanÄ±cÄ±lar</h5>
              <div id="pendingUsers" class="scrollable-list max-h-48 overflow-y-auto p-2 bg-gray-900/50 rounded-md">YÃ¼kleniyor...</div>
            </div>
            <div>
              <h5 class="text-gray-300 font-bold mb-2">Ã–zel ÃœrÃ¼n AlÄ±mlarÄ±</h5>
              <div id="pendingSpecialPurchasesList" class="scrollable-list max-h-48 overflow-y-auto p-2 bg-gray-900/50 rounded-md">YÃ¼kleniyor...</div>
            </div>
          </div>
        </div>

        <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700">
          <h4 class="text-red-400 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Tehlikeli BÃ¶lge</h4>
          <div class="flex flex-wrap gap-3 justify-center">
            <div class="bg-gray-800/80 p-6 rounded-xl border border-green-500">
    <h4 class="text-green-300 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">ğŸ† AylÄ±k Sezon YÃ¶netimi ğŸ‘‘</h4>
    <button onclick="openSeasonManagementModal()" class="w-full py-3 bg-green-800 hover:bg-green-700 text-white font-bold rounded-lg">Sezon AyarlarÄ±nÄ± AÃ§</button>
</div>
<button id="maintenanceModeBtn" onclick="toggleMaintenanceMode()" class="flex-1 py-2 px-3 bg-yellow-700 hover:bg-yellow-600 text-white font-bold rounded-lg text-sm">
    BakÄ±mÄ± BaÅŸlat
</button>
<button onclick="forceClientUpdate()" class="w-full py-3 bg-teal-700 hover:bg-teal-600 text-white font-bold rounded-lg text-sm">
    TÃ¼m KullanÄ±cÄ±lara GÃ¼ncellemeyi Zorla
</button>

            <button onclick="restartSystem()" class="flex-1 py-2 px-3 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg text-sm">Sistemi SÄ±fÄ±rla</button>
            <button onclick="clearAllTotalSpentPoints()" class="flex-1 py-2 px-3 bg-purple-800 hover:bg-purple-700 text-white font-bold rounded-lg text-sm">Harcanan PuanlarÄ± Temizle</button>
            <button onclick="clearPurchaseHistory()" class="flex-1 py-2 px-3 bg-pink-800 hover:bg-pink-700 text-white font-bold rounded-lg text-sm">SatÄ±n Alma GeÃ§miÅŸini Sil</button>
          </div>
        </div>
      </div>
      
      <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700 flex flex-col">
        <h4 class="text-yellow-200 text-xl font-semibold mb-4 border-b border-gray-600 pb-2 flex-shrink-0">KullanÄ±cÄ± YÃ¶netimi</h4>
        <div class="flex-shrink-0 mb-4">
          <input type="text" id="searchUser" placeholder="KullanÄ±cÄ± Ara..." oninput="searchUsers()" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500 transition duration-300">
        </div>
        <div id="allUsers" class="flex-grow scrollable-list overflow-y-auto bg-gray-900/50 p-2 rounded-md max-h-[568px]">YÃ¼kleniyor...</div>
      </div>
      
      <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700">
    <h4 class="text-yellow-200 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Toplu EÅŸya GÃ¶nderimi</h4>
    <div class="space-y-4">
        <div>
            <label for="bulkSendItemType" class="block text-sm font-medium text-gray-300 mb-1">TÃ¼m KullanÄ±cÄ±lara GÃ¶nderilecek EÅŸya:</label>
            <select id="bulkSendItemType" class="box-setting-input" onchange="handleBulkSendItemTypeChange(this)">
    <option value="">-- Tip SeÃ§in --</option>
    <option value="points">ğŸ’° Puan</option>
    <option value="kasaPuani">ğŸ¦ Kasa PuanÄ±</option>
    <option value="boxRights">ğŸ“¦ Kutu HakkÄ±</option>
    <option value="wheelTicket">ğŸ« Ã‡ark Bileti</option>
    <option value="clickCatchTicket">ğŸŸï¸ TÄ±kla-Yakala Bileti</option>
    <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
    <option value="tempMultiplier">âœ–ï¸ Ã‡arpan</option>
    <option value="wildcard">ğŸƒ Joker Kart</option>
    <option value="health_regen_potion">ğŸ§ª Can Yenileme Ä°ksiri</option> <option value="revival_stone">ğŸ’ Dirilme TaÅŸÄ±</option>
    <option value="health_potion">ğŸ§ª Can Ä°ksiri</option>
    <option value="damage_potion">âš”ï¸ Hasar Ä°ksiri</option>
    <option value="defense_potion">ğŸ›¡ï¸ Savunma Ä°ksiri</option>
    <option value="crit_potion">ğŸ’¥ Kritik VuruÅŸ Ä°ksiri</option>
    <option value="crit_damage_potion">ğŸ¯ Kritik Hasar Ä°ksiri</option>
    <option value="dodge_potion">ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± Ä°ksiri</option>
    <option value="pierce_potion">ğŸ“Œ Delici ÅansÄ± Ä°ksiri</option>
</select>
        </div>
        <div id="bulkSendItemFieldsContainer" class="space-y-3">
            </div>
        <div class="mt-4 flex gap-4">
    <div class="mt-4 flex flex-col sm:flex-row gap-4">
    <button onclick="confirmBulkSendItem(false)" class="flex-1 py-3 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg shadow-md">TÃœM KULLANICILARDAN SÄ°L</button>
    <button onclick="confirmBulkSendItem(true)" class="flex-1 py-3 bg-green-800 hover:bg-green-700 text-white font-bold rounded-lg shadow-md">TÃœM KULLANICILARA GÃ–NDER</button>
</div>

<div class="mt-4 pt-4 border-t border-gray-600">
    <button onclick="resetAllPotionBonuses()" class="w-full py-3 bg-pink-800 hover:bg-pink-700 text-white font-bold rounded-lg shadow-md">
        ğŸ§ª TÃ¼m KullanÄ±cÄ±larÄ±n Ä°ksir BonuslarÄ±nÄ± SÄ±fÄ±rla
    </button>
</div>
    </div>
</div>
      </div>
    </div>
  </div>
</div>
  <div id="pointAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closePointAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± Puan AyarÄ±: <span id="adjUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut PuanÄ±: <span id="adjUserBalance" class="font-bold"></span></p>
      <input type="number" id="adjAmount" placeholder="Puan MiktarÄ±" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserPoints(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Puan Ekle</button>
        <button onclick="adjustUserPoints(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Puan Ã‡Ä±kar</button>
      </div>
    </div>
</div>

<div id="boxRightAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeBoxRightAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± Kutu HakkÄ± AyarÄ±: <span id="adjBoxRightUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Kutu HakkÄ±: <span id="adjUserBoxRight" class="font-bold"></span></p>
      <input type="number" id="adjBoxRightAmount" placeholder="Kutu HakkÄ± MiktarÄ±" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserBoxRights(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Kutu HakkÄ± Ekle</button>
        <button onclick="adjustUserBoxRights(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Kutu HakkÄ± Ã‡Ä±kar</button>
      </div>
    </div>
</div>

<div id="wheelTicketAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeWheelTicketAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± Ã‡ark Bileti AyarÄ±: <span id="adjWheelTicketUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Ã‡ark Bileti: <span id="adjUserWheelTicket" class="font-bold"></span></p>
      <input type="number" id="adjWheelTicketAmount" placeholder="Bilet MiktarÄ±" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserWheelTickets(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Bilet Ekle</button>
        <button onclick="adjustUserWheelTickets(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Bilet Ã‡Ä±kar</button>
      </div>
    </div>
</div>

<div id="clickCatchTicketAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeClickCatchTicketAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± TÄ±kla-Yakala Bileti AyarÄ±: <span id="adjClickCatchTicketUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Bilet SayÄ±sÄ±: <span id="adjUserClickCatchTicket" class="font-bold"></span></p>
      <input type="number" id="adjClickCatchTicketAmount" placeholder="Bilet MiktarÄ±" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserClickCatchTickets(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Bilet Ekle</button>
        <button onclick="adjustUserClickCatchTickets(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Bilet Ã‡Ä±kar</button>
      </div>
    </div>
</div>

<div id="iflasShieldAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeIflasShieldAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± Ä°flas KalkanÄ± AyarÄ±: <span id="adjIflasShieldUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Ä°flas KalkanÄ±: <span id="adjUserIflasShield" class="font-bold"></span></p>
      <input type="number" id="adjIflasShieldAmount" placeholder="Ä°flas KalkanÄ± MiktarÄ±" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserIflasShields(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Kalkan Ekle</button>
        <button onclick="adjustUserIflasShields(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Kalkan Ã‡Ä±kar</button>
      </div>
    </div>
</div>

<div id="multiplierAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeMultiplierAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ± Ã‡arpan AyarÄ±: <span id="adjMultiplierUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Ã‡arpan: <span id="adjUserMultiplier" class="font-bold"></span> (Kalan KullanÄ±m: <span id="adjUserMultiplierUses" class="font-bold"></span>)</p>
      <div class="mb-4">
        <label for="setMultiplierValue" class="block text-left text-gray-300 mb-1">Ã‡arpan DeÄŸeri:</label>
        <input type="number" id="setMultiplierValue" placeholder="Ã‡arpan DeÄŸeri (Ã¶rn: 2, 3, 5)" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
      </div>
      <div class="mb-4">
        <label for="setMultiplierSource" class="block text-left text-gray-300 mb-1">Ã‡arpan KaynaÄŸÄ±:</label>
        <select id="setMultiplierSource" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
          <option value="none">Yok</option>
          <option value="store">MaÄŸaza</option>
          <option value="box">Kutu</option>
        </select>
      </div>
      <div class="mb-6">
        <label for="setMultiplierUses" class="block text-left text-gray-300 mb-1">Kalan KullanÄ±m (Sadece MaÄŸaza Ä°Ã§in):</label>
        <input type="number" id="setMultiplierUses" placeholder="Kalan KullanÄ±m" min="0" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
      </div>
      <div class="flex gap-4 justify-center">
        <button onclick="setMultiplier()" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Ã‡arpanÄ± Ayarla</button>
        <button onclick="resetMultiplier()" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Ã‡arpanÄ± SÄ±fÄ±rla</button>
      </div>
    </div>
</div>

<div id="blockDurationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeBlockDurationModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">KullanÄ±cÄ±yÄ± Engelle: <span id="blockUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Engelleme SÃ¼resi (Dakika):</p>
      <input type="number" id="blockDuration" placeholder="SÃ¼re (dakika)" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <button onclick="confirmBlockUser()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Engellemeyi Onayla</button>
    </div>
</div>

<div id="blockedMessageModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <h4 class="text-red-500 text-3xl font-bold mb-6">HESABINIZ ENGELLENDÄ°</h4>
      <p id="blockedReason" class="text-lg text-gray-300 mb-4"></p>
      <p id="blockedCountdown" class="text-2xl text-yellow-400 font-semibold"></p>
    </div>
</div>

<div id="kickVerificationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeKickVerificationModal()">&times;</button>
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">Kick KullanÄ±cÄ± AdÄ± DoÄŸrulamasÄ±</h4>
    <p class="text-lg text-gray-300 mb-6">
      KayÄ±t iÅŸleminin son adÄ±mÄ± olarak, hesabÄ±nÄ±zÄ± doÄŸrulamak iÃ§in Kick sohbet kanalÄ±mÄ±za gidip
      <span class="text-green-400 font-bold p-1 bg-gray-900 rounded">!doÄŸrula</span>
      yazarak gÃ¶ndermeniz gerekmektedir. OnaylandÄ±ktan sonra giriÅŸ yapabilirsiniz.
    </p>
    <button onclick="window.open('https://kick.com/popout/weizendtv/chat', '_blank'); closeKickVerificationModal();" class="w-full py-3 bg-green-500 hover:bg-green-400 text-gray-900 font-bold rounded-lg">
      Kick Sohbete Git
    </button>
  </div>
</div>

<div id="passwordResetModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closePasswordResetModal()">&times;</button>
      <div id="resetStep1">
          <h4 class="text-yellow-400 text-2xl font-bold mb-6">Åifre SÄ±fÄ±rlama (AdÄ±m 1/2)</h4>
          <input type="text" id="resetUsername" placeholder="Kick KullanÄ±cÄ± AdÄ±" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <input type="text" id="resetPin" placeholder="6 Haneli PIN" maxlength="6" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <button onclick="verifyResetInfo()" class="w-full py-3 mt-4 bg-red-700 hover:bg-red-600 rounded-lg font-bold">Bilgileri DoÄŸrula</button>
      </div>
      <div id="resetStep3" class="hidden">
          <h4 class="text-yellow-400 text-2xl font-bold mb-6">Yeni Åifre Belirle (AdÄ±m 2/2)</h4>
          <input type="password" id="newPassword" placeholder="Yeni Åifre" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <input type="password" id="newPasswordConfirm" placeholder="Yeni Åifre Tekrar" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <button onclick="updatePassword()" class="w-full py-3 mt-4 bg-red-700 hover:bg-red-600 rounded-lg font-bold">Åifreyi GÃ¼ncelle</button>
      </div>
  </div>
</div>

<div id="generalMessageModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeGeneralMessageModal()">&times;</button>
    <p id="generalMessageContent" class="text-lg text-gray-300 mb-6"></p>
    <button onclick="closeGeneralMessageModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Tamam</button>
  </div>
</div>

<div id="welcomeGiftModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <h4 class="text-yellow-400 text-3xl font-bold mb-4">AramÄ±za HoÅŸ Geldin!</h4>
    <p class="text-lg text-gray-300 mb-6">Weizend Oyun DÃ¼nyasÄ±'na katÄ±ldÄ±ÄŸÄ±n iÃ§in teÅŸekkÃ¼rler! BaÅŸlangÄ±Ã§ olarak sana Ã¶zel bir hediyemiz var.</p>
    <p class="text-2xl text-green-400 font-bold mb-8">ğŸ 3 Kutu AÃ§ma HakkÄ± KazandÄ±n!</p>
    <button onclick="closeWelcomeGiftModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Harika!</button>
  </div>
</div>

<div id="cardSelectionModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-2xl text-center relative">
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">SÃ¼rpriz Kutu! Bir Kart SeÃ§in</h4>
    
    <h4 id="cardSelectionCountdown" class="text-red-500 text-2xl font-bold mb-4">60</h4>

    <div id="playerCardContainer" class="card-container grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 justify-center items-center"></div>
  </div>
</div>

<div id="openedBoxInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeOpenedBoxInfoModal()">&times;</button>
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">AÃ§Ä±lan Kutu Bilgisi</h4>
    <div id="openedBoxInfoContent" class="text-lg text-gray-300 mb-6"></div>
    <button onclick="closeOpenedBoxInfoModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Tamam</button>
  </div>
</div>

<div id="globalOpenedBoxInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[100000] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">KUTU AÃ‡ILDI!</h4>
    <div id="globalOpenedBoxInfoContent" class="text-lg text-gray-300 mb-4"></div>
    <p id="globalOpenedBoxCountdown" class="text-xl text-yellow-400 font-semibold"></p>
  </div>
</div>

<div id="userManagementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[6000] hidden">
  <div class="modal-content bg-gray-800 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-xl text-center relative max-h-[90vh] flex flex-col">
    
    <div class="p-8 pb-4 flex-shrink-0">
        <button class="modal-close-button absolute top-2 right-4 text-white text-4xl leading-none bg-transparent border-none cursor-pointer hover:text-red-500 transition duration-200" onclick="closeUserManagementModal()">&times;</button>
        <img id="managedUserAvatar" src="" class="w-24 h-24 rounded-lg mx-auto mb-4 object-contain">
        <h4 class="text-yellow-400 text-2xl font-bold">KullanÄ±cÄ± YÃ¶netimi: <span id="managedUserName"></span></h4>
    </div>

    <div class="overflow-y-auto px-8 pb-8">
        <div id="managedUserDetails" class="text-left text-gray-300 mb-6 space-y-1">
            <p>Kasa PuanÄ±: <span id="managedUserKasaBalance" class="font-bold text-purple-400"></span></p>
          <p>Joker Kart: <span id="managedUserWildcards" class="font-bold text-purple-400"></span></p>
            <p><span id="managedBadgeBalance" class="inline-block w-6 text-center"></span>Mevcut PuanÄ±: <span id="managedUserBalance" class="font-bold text-yellow-300"></span></p>
            <p><span id="managedBadgeHighest" class="inline-block w-6 text-center"></span>Kariyer PuanÄ±: <span id="managedUserHighestBalance" class="font-bold text-green-400"></span></p>
            <p>Kutu HakkÄ±: <span id="managedUserBoxRight" class="font-bold text-green-400"></span></p>
            <p>Åans Ã‡arkÄ± Bileti: <span id="managedUserWheelTickets" class="font-bold text-yellow-400"></span></p>
            <p>TÄ±kla-Yakala Bileti: <span id="managedUserClickCatchTickets" class="font-bold text-fuchsia-400"></span></p>
            <p>Ä°flas KalkanÄ±: <span id="managedUserIflasShield" class="font-bold text-blue-400"></span></p>
            <p>Aktif Ã‡arpan: <span id="managedUserMultiplier" class="font-bold text-purple-400"></span></p>
            <p>Ã‡arpan Kalan KullanÄ±m: <span id="managedUserMultiplierUses" class="font-bold text-purple-400"></span></p>
            <p>Engelli Durumu: <span id="managedUserBlockedStatus" class="font-bold"></span></p>
            <p id="managedUserBlockedCountdownContainer" class="hidden text-red-400">Kalan SÃ¼re: <span id="managedUserBlockedCountdown" class="font-bold"></span></p>
            <hr class="my-3 border-gray-600">
            <p><span id="managedBadgeBox" class="inline-block w-6 text-center"></span>AÃ§Ä±lan Kutu (TÃ¼m Zamanlar): <span id="managedUserBoxesOpened" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeSurprise" class="inline-block w-6 text-center"></span>SÃ¼rpriz Kutu Buldu: <span id="managedUserSurpriseBoxes" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeBomb" class="inline-block w-6 text-center"></span>Bulunan Bomba SayÄ±sÄ±: <span id="managedUserBombCount" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeMultiplier" class="inline-block w-6 text-center"></span>Bulunan Ã‡arpan SayÄ±sÄ±: <span id="managedUserMultiplierFoundCount" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeStore" class="inline-block w-6 text-center"></span>MaÄŸazada Harcanan Puan: <span id="managedUserTotalSpent" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeShield" class="inline-block w-6 text-center"></span>KullanÄ±lan Kalkan SayÄ±sÄ±: <span id="managedUserShieldUsedCount" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeClickCatch" class="inline-block w-6 text-center"></span>TÄ±kla-Yakala Rekoru: <span id="managedUserClickCatchScore" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeWheel" class="inline-block w-6 text-center"></span>Ã‡evrilen Ã‡ark SayÄ±sÄ±: <span id="managedUserWheelSpins" class="font-bold text-fuchsia-400"></span></p>
        </div>

        <div id="adminSendItemModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-green-500 w-11/12 max-w-lg text-left relative">
    <button class="modal-close-button" onclick="closeAdminSendItemModal()">&times;</button>
    <h4 class="text-green-300 text-2xl font-bold mb-6 text-center">KullanÄ±cÄ±ya EÅŸya GÃ¶nder: <span id="sendItemUserName"></span></h4>
    
    <div class="space-y-4">
      <div>
        <label for="sendItemType" class="block text-sm font-medium text-gray-300 mb-1">GÃ¶nderilecek EÅŸya/Ã–dÃ¼l:</label>
        <select id="sendItemType" class="box-setting-input" onchange="handleSendItemTypeChange(this)">
    <option value="">-- Tip SeÃ§in --</option>
    <option value="points">ğŸ’° Puan</option>
    <option value="kasaPuani">ğŸ¦ Kasa PuanÄ±</option>
    <option value="boxRights">ğŸ“¦ Kutu HakkÄ±</option>
    <option value="wheelTicket">ğŸ« Ã‡ark Bileti</option>
    <option value="clickCatchTicket">ğŸŸï¸ TÄ±kla-Yakala Bileti</option>
    <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
    <option value="tempMultiplier">âœ–ï¸ Ã‡arpan</option>
    <option value="avatar">ğŸ‘¤ Avatar</option>
    <option value="wildcard">ğŸƒ Joker Kart</option>
    <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
    <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
    <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
    <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
    <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
    <option value="health_regen_potion">ğŸ§ª Can Yenileme Ä°ksiri</option> <option value="revival_stone">ğŸ’ Dirilme TaÅŸÄ±</option>
    <option value="health_potion">ğŸ§ª Can Ä°ksiri</option>
    <option value="damage_potion">âš”ï¸ Hasar Ä°ksiri</option>
    <option value="crit_damage_potion">ğŸ¯ Kritik Hasar Ä°ksiri</option>
    <option value="defense_potion">ğŸ›¡ï¸ Savunma Ä°ksiri</option>
    <option value="dodge_potion">ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± Ä°ksiri</option>
    <option value="pierce_potion">ğŸ“Œ Delici ÅansÄ± Ä°ksiri</option>
    <option value="crit_potion">ğŸ’¥ Kritik ÅansÄ± Ä°ksiri</option>
</select>
      </div>
      
      <div id="sendItemFieldsContainer" class="space-y-3">
        </div>
    </div>

    <div class="mt-6 flex gap-4">
  <button onclick="confirmSendItem(false)" class="flex-1 py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">SÄ°L (-)</button>
  <button onclick="confirmSendItem(true)" class="flex-1 py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">GÃ–NDER (+)</button>
</div>
  </div>
</div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    <button onclick="openAdminSendItemModal(selectedUserForManagement)" class="py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-md lg:col-span-3">ğŸ EÅŸya/Puan GÃ¶nder</button>
    <button id="toggleBlockUserBtn" class="py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg shadow-md">Engelle / Engeli KaldÄ±r</button>
    <button onclick="resetUser(selectedUserForManagement)" class="py-3 bg-orange-600 hover:bg-orange-500 text-white font-bold rounded-lg shadow-md">KullanÄ±cÄ±yÄ± SÄ±fÄ±rla</button>
    <button onclick="denyUser(selectedUserForManagement, false, true)" class="py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">KullanÄ±cÄ±yÄ± Sil</button>
    
    <button onclick="resetUserPotionBonuses(selectedUserForManagement)" class="py-3 bg-pink-600 hover:bg-pink-500 text-white font-bold rounded-lg shadow-md lg:col-span-3">ğŸ§ª Ä°ksir BonuslarÄ±nÄ± SÄ±fÄ±rla</button>
</div>
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 mt-6">
            <h4 class="text-yellow-300 text-xl font-semibold mb-4">Avatar YÃ¶netimi</h4>
            <div id="managedUserAvatarGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 scrollable-list max-h-60 overflow-y-auto p-3 bg-gray-800 rounded-md">
            </div>
        </div>
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 mt-6">
            <h4 class="text-yellow-300 text-xl font-semibold mb-4">KullanÄ±cÄ±nÄ±n SatÄ±n Alma GeÃ§miÅŸi</h4>
            <div id="managedUserPurchaseHistory" class="scrollable-list max-h-60 overflow-y-auto p-3 bg-gray-800 rounded-md">
                <div class='text-center text-gray-400'>SatÄ±n alma geÃ§miÅŸi yÃ¼kleniyor...</div>
            </div>
        </div>
    </div>

  </div>
</div>

<div id="publicUserDetailModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[10001] hidden" onclick="closeModalOnClickOutside(event)">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm rounded-2xl shadow-2xl border border-yellow-500 w-11/12 max-w-2xl text-center relative max-h-[90vh] flex flex-col">
    
    <div class="p-6 pb-4 flex-shrink-0 relative">
        <button class="modal-close-button absolute top-4 right-4 text-gray-400 hover:text-white text-4xl transition-colors" onclick="closePublicUserDetailModal()">&times;</button>

        <div class="flex flex-col items-center gap-4">
            <img id="publicUserAvatar" src="" class="w-28 h-28 rounded-full border-4 border-yellow-400 object-cover">
            <div class="flex flex-col items-center text-center">
                <div id="publicUserProfileBadges" class="flex items-center justify-center gap-2 h-8 mb-2"></div>
                <h4 id="publicUserName" class="text-yellow-300 text-3xl font-bold"></h4>
            </div>
        </div>
        
        <div id="publicUserChampionships" class="hidden w-full max-w-lg mx-auto bg-yellow-900/50 border-2 border-yellow-500 text-yellow-200 p-4 rounded-xl mt-4 space-y-2 text-center shadow-lg">
        </div>
    </div>

    <div class="flex-grow overflow-y-auto scrollable-list p-6 pt-2">
        <div id="publicUserBlockedInfo" class="hidden bg-red-900/50 border border-red-500 text-red-300 p-3 rounded-lg mb-4">
            Bu kullanÄ±cÄ± engellidir. Kalan sÃ¼re: <span id="publicUserBlockedCountdown" class="font-bold"></span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
            <div class="bg-gray-800/70 p-4 rounded-xl border border-gray-700">
                <h5 class="font-bold text-yellow-200 text-xl mb-3 border-b border-gray-600 pb-2">Puan & Envanter</h5>
                <div class="space-y-3 text-gray-300">
                    <p class="flex justify-between items-center"><span> Kasa PuanÄ±:</span> <span id="publicUserKasaBalance" class="font-bold text-purple-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span id="publicBadgeBalance" class="inline-block w-6 text-center"></span>Mevcut PuanÄ±:</span> <span id="publicUserBalance" class="font-bold text-yellow-300 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span id="publicBadgeHighest" class="inline-block w-6 text-center"></span>Kariyer PuanÄ±:</span> <span id="publicUserHighestBalance" class="font-bold text-green-400 text-lg"></span></p>
                    <hr class="border-gray-600 !my-2">
                    <p class="flex justify-between items-center"><span> Kutu HakkÄ±:</span> <span id="publicUserBoxRight" class="font-bold text-green-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span> Åans Ã‡arkÄ± Bileti:</span> <span id="publicUserWheelTickets" class="font-bold text-yellow-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span> TÄ±kla-Yakala Bileti:</span> <span id="publicUserClickCatchTickets" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span> Ä°flas KalkanÄ±:</span> <span id="publicUserIflasShield" class="font-bold text-blue-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span> Aktif Ã‡arpan:</span> <span id="publicUserMultiplier" class="font-bold text-purple-400 text-lg text-right"></span></p>
                </div>
            </div>

            <div class="bg-gray-800/70 p-4 rounded-xl border border-gray-700">
                <h5 class="font-bold text-yellow-200 text-xl mb-3 border-b border-gray-600 pb-2">Oyun Ä°statistikleri</h5>
                <div class="space-y-3 text-gray-300">
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-box"></span>Toplam AÃ§Ä±lan Kutu:</span> <span id="publicUserBoxesOpened" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-wheel"></span>Toplam Ã‡evrilen Ã‡ark:</span> <span id="publicUserWheelSpins" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-clickcatch"></span>TÄ±kla-Yakala Skoru:</span> <span id="publicUserClickCatchScore" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <hr class="border-gray-600 !my-2">
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-surprise"></span>Bulunan SÃ¼rpriz Kutu:</span> <span id="publicUserSurpriseBoxes" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-bomb"></span>Bulunan Bomba SayÄ±sÄ±:</span> <span id="publicUserBombCount" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-multiplier"></span>Bulunan Ã‡arpan SayÄ±sÄ±:</span> <span id="publicUserMultiplierFoundCount" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-shield"></span>KullanÄ±lan Kalkan SayÄ±sÄ±:</span> <span id="publicUserShieldUsedCount" class="font-bold text-fuchsia-400 text-lg"></span></p>
                    <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-store"></span>MaÄŸazada Harcanan Puan:</span> <span id="publicUserTotalSpent" class="font-bold text-fuchsia-400 text-lg"></span></p>
                </div>
            </div>
        </div>
        <button onclick="closePublicUserDetailModal()" class="mt-6 w-full max-w-xs mx-auto py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg transition-colors">Kapat</button>
    </div>
  </div>
</div>
  <div id="inventoryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeInventoryModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Envanterin</h4>
      <div id="inventoryDetails" class="text-left text-gray-300 mb-6 space-y-3 bg-gray-900 p-4 rounded-lg border border-gray-700">
          <p class="flex justify-between items-center"><span>ğŸ“¦ Kutu HakkÄ±:</span> <strong id="inventoryBoxRights" class="text-green-400 text-lg">0</strong></p>
          <p class="flex justify-between items-center"><span>ï¸ğŸ« Åans Ã‡arkÄ± Bileti:</span> <strong id="inventoryWheelTickets" class="text-yellow-400 text-lg">0</strong></p>
          <p class="flex justify-between items-center"><span>ğŸŸï¸ TÄ±kla-Yakala Bileti:</span> <strong id="inventoryClickCatchTickets" class="text-fuchsia-400 text-lg">0</strong></p>
          <p class="flex justify-between items-center"><span>ğŸ›¡ï¸ Ä°flas KalkanÄ±:</span> <strong id="inventoryIflasShields" class="text-blue-400 text-lg">0</strong></p>
          <hr class="border-gray-600 my-2">
          <div id="inventoryMultiplierDetails">
              <p>âœ–ï¸ Aktif Ã§arpan yok.</p>
          </div>
      </div>
      <div class="flex gap-4 mt-6">
        <button onclick="openAvatarSelectionModal()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">AvatarlarÄ±m</button>
        <button onclick="closeInventoryModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Kapat</button>
      </div>
  </div>
</div>

<div id="badgeInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-lg text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button" onclick="closeBadgeInfoModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Rozetler ve AnlamlarÄ±</h4>
      <div class="space-y-4 text-left">
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ‘‘</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Kral TacÄ±</strong>
                <p class="text-gray-400">TÃ¼m liderlik rozetlerine (ğŸ¥‡, ğŸ†, ğŸ‰, ğŸ’£, ğŸ›’, âœ–ï¸, ğŸ“¦, ğŸ›¡ï¸, ğŸ¯, ğŸ¡) aynÄ± anda sahip olan kullanÄ±cÄ±ya verilir. En prestijli rozettir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ¥‡</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Mevcut Puan Lideri</strong>
                <p class="text-gray-400">AnlÄ±k olarak en yÃ¼ksek puana sahip olan kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
    <span class="text-3xl w-8 text-center">ğŸ†</span>
    <div>
        <strong class="text-yellow-200 block text-lg">Kariyer Puan Lideri</strong>
        <p class="text-gray-400">Sezon iÃ§inde kazanÄ±lan tÃ¼m puanlarÄ±n toplamÄ±ndan oluÅŸan Kariyer PuanÄ±'nda lider olan kullanÄ±cÄ±ya verilir.</p>
    </div>
</div>
         <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ¯</span>
            <div>
                <strong class="text-yellow-200 block text-lg">TÄ±kla-Yakala Lideri</strong>
                <p class="text-gray-400">TÄ±kla-Yakala puan sÄ±ralamasÄ±nda lider olan oyuncuya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ¡</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Ã‡ark Lideri</strong>
                <p class="text-gray-400">TÃ¼m zamanlarda en Ã§ok Åans Ã‡arkÄ± Ã§eviren kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ“¦</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Kutu AÃ§ma Lideri</strong>
                <p class="text-gray-400">TÃ¼m zamanlarda en Ã§ok kutu aÃ§an kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ‰</span>
            <div>
                <strong class="text-yellow-200 block text-lg">SÃ¼rpriz Kutu Lideri</strong>
                <p class="text-gray-400">TÃ¼m zamanlarda en Ã§ok "SÃ¼rpriz Kutu" bulan kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ’£</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Bomba Lideri</strong>
                <p class="text-gray-400">TÃ¼m zamanlarda en Ã§ok "Ä°flas (Bomba)" kutusu bulan ÅŸanssÄ±z kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">âœ–ï¸</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Ã‡arpan Lideri</strong>
                <p class="text-gray-400">TÃ¼m zamanlarda en Ã§ok "Ã‡arpan" kutusu bulan kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ›’</span>
            <div>
                <strong class="text-yellow-200 block text-lg">AlÄ±ÅŸveriÅŸ Lideri</strong>
                <p class="text-gray-400">MaÄŸazada en Ã§ok puan harcayan kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ›¡ï¸</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Kalkan Lideri</strong>
                <p class="text-gray-400">En Ã§ok "Ä°flas KalkanÄ±" kullanan kullanÄ±cÄ±ya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">ğŸ</span>
            <div>
                <strong class="text-yellow-200 block text-lg">SÃ¼rpriz Kutu Rozeti</strong>
                <p class="text-gray-400">En az bir adet "SÃ¼rpriz Kutu" bulmuÅŸ olan tÃ¼m kullanÄ±cÄ±lara verilir (Liderlik gerektirmez).</p>
            </div>
        </div>
      </div>
  </div>
</div>

<div id="helpModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-3xl text-left relative max-h-[90vh] flex flex-col">
      
      <div class="flex-shrink-0 p-6 border-b border-gray-700 relative">
          <h3 class="text-yellow-400 text-3xl font-bold text-center">Weizend Oyun DÃ¼nyasÄ± Rehberi</h3>
          <button class="modal-close-button" onclick="closeHelpModal()">&times;</button>
      </div>
      
      <div class="overflow-y-auto scrollable-list p-6">
        <div class="space-y-8 text-gray-300">
    
    <div>
        <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ‘‹ Oyuna HoÅŸ Geldin!</h4>
        <p>Weizend Oyun DÃ¼nyasÄ±'na hoÅŸ geldin! BurasÄ±, Ã§eÅŸitli oyunlar oynayarak puan kazandÄ±ÄŸÄ±n, liderlik tablolarÄ±nda yarÄ±ÅŸtÄ±ÄŸÄ±n ve harika Ã¶dÃ¼ller iÃ§in koleksiyonunu tamamladÄ±ÄŸÄ±n bir platformdur. Bu rehber, oyundaki her ÅŸeyi anlaman iÃ§in hazÄ±rlandÄ±.</p>
    </div>

    <hr class="border-gray-700">

    <div>
        <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ† Oyunun Temel AmacÄ± Nedir?</h4>
        <p class="mb-2">Sitedeki nihai hedeflerin ÅŸunlardÄ±r:</p>
        <ul class="list-disc list-inside mt-2 space-y-2 pl-4">
            <li><b class="text-green-400">Liderlik TablolarÄ±nda YÃ¼kselmek:</b> "AylÄ±k Sezon SÄ±ralamasÄ±" ve "HaftalÄ±k TÄ±kla-Yakala SÄ±ralamasÄ±" gibi tablolarda en tepeye tÄ±rmanarak sezonun en iyisi olduÄŸunu kanÄ±tla ve Ã¶zel Ã¶dÃ¼ller kazan.</li>
            <li><b class="text-purple-400">Kart Koleksiyonu AlbÃ¼mÃ¼nÃ¼ Tamamlamak:</b> Oyunun en bÃ¼yÃ¼k ve en prestijli hedefi! Sezon bitmeden tÃ¼m kartlarÄ± toplayan herkes, admin tarafÄ±ndan belirlenen bÃ¼yÃ¼k Ã¶dÃ¼lleri kazanÄ±r.</li>
             <li><b class="text-yellow-200">GerÃ§ek Ã–dÃ¼ller Kazanmak:</b> Oyun iÃ§inde kazandÄ±ÄŸÄ±n puanlarÄ± biriktirerek "Ã–zel ÃœrÃ¼n MaÄŸazasÄ±"ndan gerÃ§ek dÃ¼nyada geÃ§erli Ã¶dÃ¼ller (oyun, hediye kartÄ± vb.) alabilirsin.</li>
            <li><b class="text-red-400">KalÄ±cÄ± BaÅŸarÄ±mlar Kazanmak:</b> Canavar SavaÅŸlarÄ± ve TÄ±kla-Yakala'da ÅŸampiyon olarak profiline kalÄ±cÄ±, artan seviyeli baÅŸarÄ±mlar ekleyerek adÄ±nÄ± efsaneler arasÄ±na yazdÄ±r.</li>
        </ul>
    </div>

    <hr class="border-gray-700">

    <div>
        <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ¦ Puan Sistemi ve Ekonomi</h4>
        <p class="mb-2">Oyundaki stratejini belirleyecek 3 farklÄ± puan tÃ¼rÃ¼ vardÄ±r:</p>
         <ul class="list-disc list-inside mt-2 space-y-2 pl-4">
            <li><b class="text-green-400">Mevcut Puan:</b> Bu, senin <b class="text-white">harcanabilir</b> puanÄ±ndÄ±r. MaÄŸazadan bir ÅŸey satÄ±n aldÄ±ÄŸÄ±nda veya lobi oyunlarÄ±na giriÅŸ Ã¼creti Ã¶dediÄŸinde bu puan dÃ¼ÅŸer. Kutu oyunundan kazandÄ±ÄŸÄ±n ana puan tÃ¼rÃ¼dÃ¼r.</li>
            <li><b class="text-yellow-200">Kariyer PuanÄ±:</b> Bu, senin <b class="text-white">sÄ±ralama</b> puanÄ±ndÄ±r. Sezon boyunca kazandÄ±ÄŸÄ±n tÃ¼m puanlarÄ±n toplamÄ±nÄ± gÃ¶sterir ve maÄŸazada harcama yapsan bile <b class="text-red-400">asla dÃ¼ÅŸmez</b>. AylÄ±k liderlik tablosu bu puana gÃ¶re sÄ±ralanÄ±r.</li>
            <li><b class="text-purple-300">Kasa PuanÄ±:</b> Sezon sÄ±fÄ±rlamasÄ±ndan etkilenmeyen Ã¶zel "banka" hesabÄ±ndÄ±r. PuanlarÄ±nÄ± buraya aktararak bir sonraki sezona taÅŸÄ±yabilirsin. Kasa puanlarÄ± sadece <b class="text-white">Ã–zel ÃœrÃ¼n MaÄŸazasÄ±'nda</b> kullanÄ±labilir ve sÄ±ralamaya etki etmez.</li>
        </ul>
    </div>

    <hr class="border-gray-700">

    <div>
        <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ² Oyun ModlarÄ± ve Ã–zellikler</h4>
        <div class="space-y-6">
            
            <div>
                <h5 class="text-xl font-semibold text-red-400 mb-2">ğŸ Kutu Oyunu</h5>
                <p>Oyunun kalbi ve ana kaynak motorudur. "Kutu HaklarÄ±" kullanarak kutularÄ± aÃ§ar ve iÃ§lerindeki sÃ¼rprizleri keÅŸfedersin. Puan, bilet, kalkan, Ã§arpan ve en Ã¶nemlisi <b class="text-purple-400">kart paketleri</b> buradan Ã§Ä±kar.</p>
            </div>

            <div>
                <h5 class="text-xl font-semibold text-teal-500 mb-2">ğŸ“… GiriÅŸ Serisi</h5>
                <p>Her gÃ¼n siteye giriÅŸ yaparak Ã¶zel Ã¶dÃ¼l paketleri kazanÄ±rsÄ±n. Seriyi ne kadar uzun sÃ¼re devam ettirirsen, Ã¶dÃ¼llerin o kadar deÄŸerli olur. Dikkat: Ä°ki gÃ¼n boyunca Ã¶dÃ¼l almazsan serin sÄ±fÄ±rlanÄ±r!</p>
            </div>
            
            <div>
                <h5 class="text-xl font-semibold text-orange-600 mb-2">ğŸ‘¹ Canavar SavaÅŸÄ±</h5>
                <p class="mb-2">TÃ¼m sunucunun ortak bir dÃ¼ÅŸmana karÅŸÄ± savaÅŸtÄ±ÄŸÄ± bir etkinliktir. AmaÃ§, canavar Ã¶lmeden Ã¶nce ona en Ã§ok hasarÄ± vererek liderlik tablosunda yÃ¼kselmek ve harika Ã¶dÃ¼ller kazanmaktÄ±r.</p>
                 <ul class="list-disc list-inside mt-2 space-y-2 pl-4">
                    <li><b>Avatar Kilidi:</b> Canavara ilk saldÄ±rÄ±nÄ± yaptÄ±ÄŸÄ±n anda, o an seÃ§ili olan avatarÄ±n bu savaÅŸ iÃ§in kilitlenir ve canavar Ã¶lene kadar deÄŸiÅŸtirilemez.</li>
                    <li><b>Ä°ksirler ve KalÄ±cÄ± GÃ¼Ã§lendirme:</b> MaÄŸazadan aldÄ±ÄŸÄ±n iksirler, seÃ§ili avatarÄ±nÄ±n istatistiklerini (Can, Hasar, Savunma vb.) <b class="text-red-400">kalÄ±cÄ± olarak</b> artÄ±rÄ±r.</li>
                     <li><b>Dirilme TaÅŸÄ±:</b> SavaÅŸta canÄ±n biterse, bu taÅŸ ile yeniden canlanÄ±p savaÅŸa dÃ¶nebilirsin.</li>
                </ul>
            </div>

            <div>
                <h5 class="text-xl font-semibold text-purple-400 mb-2">ğŸƒ Kart Koleksiyonu & Takas PazarÄ±</h5>
                <p class="mb-2">Koleksiyonu tamamlamak iÃ§in oyun iÃ§inden kazandÄ±ÄŸÄ±n <b class="text-white">Kart Paketlerini</b> aÃ§arak kart elde edersin. Fazla kartlarÄ±nÄ± <b class="text-green-400">Takas PazarÄ±</b>'nda diÄŸer oyuncularla takas ederek eksiklerini tamamlayabilirsin.</p>
            </div>

            <div>
                <h5 class="text-xl font-semibold text-teal-400 mb-2">ğŸ¡ Åans Ã‡arkÄ±</h5>
                <p>"Ã‡ark Biletleri" kullanarak Ã§arkÄ± Ã§evir ve birÃ§ok farklÄ± Ã¶dÃ¼lden birini anÄ±nda kazanma ÅŸansÄ± yakala!</p>
            </div>

            <div>
                <h5 class="text-xl font-semibold text-orange-400 mb-2">ğŸ¯ TÄ±kla-Yakala</h5>
                <p class="mb-2">Ä°ki modu vardÄ±r: <b class="text-white">Tekli Oyun</b> modunda haftalÄ±k liderlik iÃ§in yarÄ±ÅŸÄ±rsÄ±n. <b class="text-white">Lobi Oyunu</b> modunda ise admin tarafÄ±ndan kurulan anlÄ±k bir yarÄ±ÅŸa katÄ±larak bÃ¼yÃ¼k Ã¶dÃ¼lÃ¼ kazanmaya Ã§alÄ±ÅŸÄ±rsÄ±n.</p>
            </div>
        </div>
    </div>
    
    <hr class="border-gray-700">

    <div>
        <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ›’ MaÄŸaza Sistemi</h4>
        <div class="space-y-4">
            <div>
                <h5 class="text-xl font-semibold text-green-400 mb-2">Oyun MaÄŸazasÄ±</h5>
                <p>Normal <b class="text-white">Mevcut PuanlarÄ±nÄ±</b> kullanarak oyun iÃ§i avantajlar ve kozmetikler satÄ±n alabilirsin. Bunlar arasÄ±nda Kutu HakkÄ±, Biletler, Ä°ksirler ve Avatarlar bulunur.</p>
            </div>
             <div>
                <h5 class="text-xl font-semibold text-purple-400 mb-2">â­ Ã–zel ÃœrÃ¼n MaÄŸazasÄ± â­</h5>
                <p>BurasÄ± en deÄŸerli Ã¶dÃ¼llerin bulunduÄŸu yerdir. Sezon sÄ±fÄ±rlamasÄ±ndan etkilenmeyen <b class="text-white">Kasa PuanlarÄ±nÄ±</b> kullanarak buradan alÄ±ÅŸveriÅŸ yapabilirsin. Bu maÄŸazadaki Ã¼rÃ¼nler, <b class="text-yellow-200">gerÃ§ek dÃ¼nyada geÃ§erli Ã¶dÃ¼ller (dijital oyun kodlarÄ±, hediye kartlarÄ± vb.) olabilir.</b> SatÄ±n alÄ±mlar admin onayÄ±na tabidir.</p>
            </div>
        </div>
    </div>

    <hr class="border-gray-700">

    <div>
        <h4 class="text-2xl font-bold text-yellow-300 mb-3">ğŸ“… HaftalÄ±k ve AylÄ±k SÄ±fÄ±rlamalar</h4>
        <p class="mb-2">Rekabeti taze tutmak iÃ§in dÃ¼zenli olarak sÄ±fÄ±rlamalar yapÄ±lÄ±r.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div class="bg-orange-900/50 p-4 rounded-lg">
                <h5 class="font-bold text-orange-300">HaftalÄ±k SÄ±fÄ±rlama (TÄ±kla-Yakala) ğŸ¯</h5>
                <p class="text-sm mt-2">Her hafta TÄ±kla-Yakala skor tablosu sÄ±fÄ±rlanÄ±r. HaftanÄ±n birincisi Ã¶zel bir Ã¶dÃ¼l kazanÄ±r ve o hafta oyuna katÄ±lmÄ±ÅŸ olan herkese +1 Bilet hediye edilir.</p>
            </div>
            <div class="bg-red-900/50 p-4 rounded-lg">
                <h5 class="font-bold text-red-300">AylÄ±k SÄ±fÄ±rlama (Ana Sezon) ğŸ†</h5>
                <p class="text-sm mt-2">Her ay ana oyun sÄ±fÄ±rlanÄ±r. Puanlar, kart koleksiyonlarÄ± ve liderlik tablolarÄ± sÄ±fÄ±rlanÄ±r. Sezonun ÅŸampiyonlarÄ± Ã¶zel Ã¶dÃ¼ller ve unvanlar kazanÄ±rken, tÃ¼m oyunculara yeni sezona baÅŸlangÄ±Ã§ iÃ§in bir hediye paketi verilir. <b class="text-white">Kasa PuanlarÄ±n ve AvatarlarÄ±n kalÄ±cÄ±dÄ±r.</b></p>
            </div>
        </div>
    </div>

    <hr class="border-gray-700">

    <div class="text-center">
        <p class="text-lg">Unutma, oyunun en Ã¶nemli amacÄ± eÄŸlenmek! Liderlik tablolarÄ±nda tÄ±rmanÄ±rken ve koleksiyonunu tamamlarken herkese bol ÅŸans ve iyi oyunlar dileriz!</p>
        <p class="text-2xl mt-2">ğŸ‰ğŸ†ğŸƒ</p>
    </div>

</div>
      </div>
  </div>
</div>

<div id="avatarSelectionModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-3xl text-center relative max-h-[90vh] flex flex-col">
      <button class="modal-close-button" onclick="closeAvatarSelectionModal()">&times;</button>
      <h3 class="text-blue-300 text-3xl font-bold mb-6">AvatarÄ±nÄ± SeÃ§</h3>
      <div id="avatarGrid" class="flex-grow grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 overflow-y-auto scrollable-list p-4 bg-gray-900 rounded-lg"></div>
  </div>
</div>
</div>
  <div id="boxSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-2xl text-center relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeBoxSettingsModal()">&times;</button>
    <h3 class="text-purple-300 text-3xl font-bold mb-6">Oyun Kutusu AyarlarÄ±</h3>
    
    <div class="flex-grow overflow-y-auto scrollable-list pr-4 space-y-2" id="boxSettingsRowsContainer">
      </div>

    <div class="mt-6 pt-4 border-t border-gray-700">
        <div class="text-lg text-white mb-4">Toplam Kutu SayÄ±sÄ±: <span id="totalBoxCountDisplay" class="font-bold text-yellow-300">0</span></div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <button onclick="addBoxSettingRow()" class="py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">Yeni SatÄ±r Ekle</button>
    <button onclick="resetBoxSettingsToDefault()" class="py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg shadow-md">VarsayÄ±lana DÃ¶ndÃ¼r</button>
    <button onclick="saveBoxSettings()" class="py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">Kaydet ve SÄ±fÄ±rla</button>
</div>
<div class="mt-4 pt-4 border-t border-gray-600 grid grid-cols-1 sm:grid-cols-3 gap-4">
    <button id="toggleGameLockBtn" onclick="toggleGameLock()" class="py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">Oyunu Kilitle</button>
    <button onclick="revealAll()" class="py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-md">TÃ¼m KutularÄ± AÃ§</button>
    <button onclick="resetGame()" class="py-3 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-md">Oyunu SÄ±fÄ±rla</button>
</div>
    </div>
  </div>
</div>
  <div id="soloGameSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-3xl text-left relative max-h-[90vh] flex flex-col">
        <button class="modal-close-button" onclick="closeSoloGameSettingsModal()">&times;</button>
        <h3 class="text-purple-300 text-3xl font-bold mb-6 text-center">TÄ±kla-Yakala YÃ¶netim Paneli</h3>
        <div class="flex-grow overflow-y-auto scrollable-list pr-4">
            <h4 class="text-lg font-semibold text-yellow-300 mb-3 text-center">Tekli Oyun AyarlarÄ±</h4>
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <div>
                        <h5 class="font-semibold text-gray-300 mb-2">SÃ¼re ve GÃ¶rÃ¼nÃ¼m</h5>
                        <label for="soloGameDuration" class="block text-sm font-medium text-gray-400">Oyun SÃ¼resi (saniye)</label>
                        <input type="number" id="soloGameDuration" class="box-setting-input mt-1 mb-3">
                        <label for="soloItemInterval" class="block text-sm font-medium text-gray-400">Yeni Hedef SÄ±klÄ±ÄŸÄ± (ms)</label>
                        <input type="number" id="soloItemInterval" class="box-setting-input mt-1 mb-3">
                        <label for="soloItemDisappearTime" class="block text-sm font-medium text-gray-400">Hedef Kaybolma SÃ¼resi (ms)</label>
                        <input type="number" id="soloItemDisappearTime" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-300 mb-2">Puan DeÄŸerleri</h5>
                        <label for="soloNormalValue" class="block text-sm font-medium text-gray-400">DÃ¼ÅŸÃ¼k Skor (ğŸ¥®)</label>
                        <input type="number" id="soloNormalValue" class="box-setting-input mt-1 mb-3">
                        <label for="soloGoldValue" class="block text-sm font-medium text-gray-400">YÃ¼ksek Skor (ğŸ’°)</label>
                        <input type="number" id="soloGoldValue" class="box-setting-input mt-1 mb-3">
                        <label for="soloBombValue" class="block text-sm font-medium text-gray-400">Bomba CezasÄ± (ğŸ’£)</label>
                        <input type="number" id="soloBombValue" class="box-setting-input mt-1 mb-3">
                        <label for="soloTimeValue" class="block text-sm font-medium text-gray-400">SÃ¼re Bonusu (â°)</label>
                        <input type="number" id="soloTimeValue" class="box-setting-input mt-1">
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 mt-4">
                <h5 class="font-semibold text-gray-300 mb-2">Ã‡Ä±kma Ä°htimalleri (ToplamÄ± 100 olmalÄ±)</h5>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div>
                        <label for="soloNormalChance" class="block text-sm font-medium text-gray-400">ğŸ¥® (%)</label>
                        <input type="number" id="soloNormalChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloGoldChance" class="block text-sm font-medium text-gray-400">ğŸ’° (%)</label>
                        <input type="number" id="soloGoldChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloBombChance" class="block text-sm font-medium text-gray-400">ğŸ’£ (%)</label>
                        <input type="number" id="soloBombChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloTimeChance" class="block text-sm font-medium text-gray-400">â° (%)</label>
                        <input type="number" id="soloTimeChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloSpecialChance" class="block text-sm font-medium text-gray-400">ğŸ (%)</label>
                        <input type="number" id="soloSpecialChance" class="box-setting-input mt-1">
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 mt-4">
                <h5 class="font-semibold text-gray-300 mb-2">Ã‡Ä±kacak Ã–zel Hedef</h5>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="soloSpecialItemType" class="box-setting-input md:col-span-1" onchange="handleSoloSpecialTypeChange()">
    <option value="boxRight">ğŸ“¦ Kutu HakkÄ±</option>
    <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±)</option>
    <option value="wheelTicket">ğŸ« Ã‡ark Bileti</option>
    <option value="tempMultiplier">âœ–ï¸ Ã‡arpan</option>
    <option value="wildcard">ğŸƒ Joker Kart</option>
    <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
    <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
    <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
    <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
    <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
    <option value="revival_stone">ğŸ’ Dirilme TaÅŸÄ±</option>
    <option value="health_potion">ğŸ§ª Can Ä°ksiri</option>
    <option value="defense_potion">ğŸ›¡ï¸ Savunma Ä°ksiri</option>
    <option value="damage_potion">âš”ï¸ Hasar Ä°ksiri</option>
    <option value="crit_potion">ğŸ’¥ Kritik VuruÅŸ Ä°ksiri</option>
    <option value="crit_damage_potion">ğŸ¯ Kritik Hasar Ä°ksiri</option>
    <option value="dodge_potion">ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± Ä°ksiri</option>
    <option value="pierce_potion">ğŸ“Œ Delici ÅansÄ± Ä°ksiri</option>
</select>
                    <div id="soloSpecialValueContainer" class="md:col-span-2 grid grid-cols-2 gap-4">
                        <input type="number" id="soloSpecialValue" class="box-setting-input" placeholder="Adet (Ã¶rn: 1, 5)">
                        <input type="number" id="soloSpecialMultiplierUses" class="box-setting-input hidden" placeholder="KullanÄ±m HakkÄ±">
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <button onclick="saveSoloGameSettings()" class="w-full py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">Tekli Oyun AyarlarÄ±nÄ± Kaydet</button>
            </div>
        </div>
        
        <div class="mt-6 pt-4 border-t-2 border-dashed border-purple-400">
            <h4 class="text-lg font-semibold text-purple-300 mb-3 text-center">ğŸ† HaftalÄ±k Otomatik SÄ±fÄ±rlama YÃ¶netimi</h4>
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-4">
    <div>
        <label for="weeklyResetEndDateInput" class="block text-sm font-medium text-gray-300 mb-1">HaftalÄ±k SÄ±fÄ±rlama BitiÅŸ Tarihi ve Saati:</label>
        <input type="datetime-local" id="weeklyResetEndDateInput" class="box-setting-input">
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-300 mb-1">Åampiyon Ã–dÃ¼lÃ¼:</label>
        <div class="grid grid-cols-2 gap-4">
            <select id="weeklyPrizeType" class="box-setting-input col-span-2 sm:col-span-1" onchange="handleWeeklyPrizeTypeChange()">
    <option value="points">ğŸ’° Puan</option>
    <option value="boxRights">ğŸ“¦ Kutu HakkÄ±</option>
    <option value="wheelTicket">ğŸ« Ã‡ark Bileti</option>
    <option value="clickCatchTicket">ğŸŸï¸ TÄ±kla-Yakala Bileti</option>
    <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
    <option value="tempMultiplier">âœ–ï¸ Ã‡arpan</option>
    <option value="avatar">ğŸ‘¤ Avatar</option>
    <option value="wildcard">ğŸƒ Joker Kart</option>
    <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
    <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
    <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
    <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
    <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
    <option value="health_regen_potion">ğŸ§ª Can Yenileme Ä°ksiri</option>
    <option value="revival_stone">ğŸ’ Dirilme TaÅŸÄ±</option>
    <option value="health_potion">ğŸ§ª Can Ä°ksiri</option>
    <option value="defense_potion">ğŸ›¡ï¸ Savunma Ä°ksiri</option>
    <option value="damage_potion">âš”ï¸ Hasar Ä°ksiri</option>
    <option value="crit_potion">ğŸ’¥ Kritik VuruÅŸ Ä°ksiri</option>
    <option value="crit_damage_potion">ğŸ¯ Kritik Hasar Ä°ksiri</option>
    <option value="dodge_potion">ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± Ä°ksiri</option>
    <option value="pierce_potion">ğŸ“Œ Delici ÅansÄ± Ä°ksiri</option>
</select>
            <div id="weeklyPrizeValueContainer" class="grid grid-cols-2 gap-4 col-span-2 sm:col-span-1">
                <input type="number" id="weeklyPrizeAmount" class="box-setting-input" placeholder="Miktar">
                <input type="number" id="weeklyPrizeMultiplierUses" class="box-setting-input hidden" placeholder="KullanÄ±m HakkÄ±">
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
         <button onclick="saveWeeklyResetSettings()" class="w-full py-2 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md">HaftalÄ±k Geri SayÄ±mÄ± BaÅŸlat/Kaydet</button>
         <button onclick="stopWeeklyReset()" class="w-full py-2 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-md">Geri SayÄ±mÄ± Ä°ptal Et</button>
    </div>
</div>
        </div>
    </div>
</div>

<div id="lobbySettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-lg text-left relative">
        <button class="modal-close-button" onclick="closeLobbySettingsModal()">&times;</button>
        <h3 class="text-blue-300 text-3xl font-bold mb-6 text-center">Lobi YÃ¶netim Paneli</h3>
        
        <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 mb-4">
            <h4 class="text-lg font-semibold text-yellow-300 mb-3">Lobi AyarlarÄ±</h4>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="lobbyEntryFee" class="block text-sm font-medium text-gray-300">GiriÅŸ Ãœcreti (Puan)</label>
                    <input type="number" id="lobbyEntryFee" value="100" class="box-setting-input mt-1">
                </div>
                 <div>
                    <label for="lobbyEntryTickets" class="block text-sm font-medium text-gray-300">GiriÅŸ Ãœcreti (Bilet)</label>
                    <input type="number" id="lobbyEntryTickets" value="0" class="box-setting-input mt-1">
                </div>
                <div>
                    <label for="lobbyTarget" class="block text-sm font-medium text-gray-300">Hedef Skor</label>
                    <input type="number" id="lobbyTarget" value="10" class="box-setting-input mt-1">
                </div>
                 <div>
                    <label for="lobbyPrize" class="block text-sm font-medium text-gray-300">Kazanan Ã–dÃ¼lÃ¼ (Puan)</label>
                    <input type="number" id="lobbyPrize" value="1000" class="box-setting-input mt-1">
                </div>
                 <div class="col-span-2">
                    <label for="lobbyItemInterval" class="block text-sm font-medium text-gray-300">Hedef Ã‡Ä±kma SÄ±klÄ±ÄŸÄ± (ms)</label>
                    <input type="number" id="lobbyItemInterval" value="800" class="box-setting-input mt-1">
                </div>
            </div>
             <button onclick="startLobbyGame()" class="w-full mt-4 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">Lobi Kur ve Beklemeye Al</button>
        </div>

        <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
            <h4 class="text-lg font-semibold text-yellow-300 mb-3">Oyun KontrolÃ¼</h4>
            <div class="flex gap-4">
                <button id="lobbyStartBtn" onclick="triggerLobbyGameStart()" class="flex-1 py-3 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Oyunu BaÅŸlat</button>
                <button onclick="endLobbyGame(true)" class="flex-1 py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">Lobi Ä°ptal Et ve Ãœcretleri Ä°ade Et</button>
            </div>
            <button onclick="resetClickCatchLeaderboard()" class="w-full mt-4 py-2 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-md">HaftalÄ±k SÄ±ralamayÄ± SÄ±fÄ±rla</button>
        </div>
    </div>
</div>
  <div id="spectatorModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-2xl text-center relative">
        <h4 id="spectatorTitle" class="text-yellow-400 text-3xl font-bold mb-4"></h4>
        <p class="text-gray-300 mb-2">KullanÄ±cÄ±nÄ±n bir kart seÃ§mesi bekleniyor...</p>
        <div class="text-2xl font-bold text-red-500 mb-6" id="spectatorCountdown">60</div>
        <div id="spectatorCardContainer" class="card-container grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 justify-center items-center">
            </div>
        <div id="spectatorResultContainer" class="mt-6 min-h-[60px]">
    <p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8"></p>
</div>
    </div>
</div>
  <div id="wheelSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-teal-500 w-11/12 max-w-4xl text-center relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeWheelSettingsModal()">&times;</button>
    <h3 class="text-teal-300 text-3xl font-bold mb-6">Åans Ã‡arkÄ± AyarlarÄ±</h3>
    
    <div class="flex-grow overflow-y-auto scrollable-list pr-4 space-y-2" id="wheelSettingsRowsContainer">
      </div>

    <div class="mt-6 pt-4 border-t border-gray-700">
        <div class="flex flex-col sm:flex-row gap-4">
            <button onclick="addWheelSettingRow()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">Yeni Dilim Ekle</button>
            <button onclick="resetWheelSettingsToDefault()" class="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg shadow-md">VarsayÄ±lana DÃ¶ndÃ¼r</button>
            <button onclick="saveWheelSettings()" class="flex-1 py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">AyarlarÄ± Kaydet</button>
        </div>
    </div>
  </div>
</div>
  <div id="unopenedBoxContentsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-green-700 w-11/12 max-w-lg text-center relative max-h-[90vh]">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl" onclick="closeUnopenedBoxContentsModal()">&times;</button>
      <h4 class="text-green-300 text-2xl font-bold mb-4">KapalÄ± Kutularda Kalanlar</h4>
      <p class="text-sm text-gray-400 mb-6">Bu listede sadece henÃ¼z aÃ§Ä±lmamÄ±ÅŸ kutularÄ±n iÃ§erikleri gÃ¶sterilir.</p>
      <div id="unopenedBoxContentsList" class="scrollable-list max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-lg text-left">
          YÃ¼kleniyor...
      </div>
  </div>
</div>

<div id="newAnnouncementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-md text-center relative">
    <h4 class="text-yellow-400 text-3xl font-bold mb-4">ğŸ“¢ YENÄ° DUYURU! ğŸ“¢</h4>
    <div class="text-lg text-gray-200 space-y-3 bg-gray-900 p-4 rounded-lg max-h-60 overflow-y-auto scrollable-list">
        <p id="newAnnouncementText"></p>
    </div>
    <div class="flex gap-4 mt-8">
        <button onclick="closeNewAnnouncementModal()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">
          Sonra Bak
        </button>
        <button onclick="goToAnnouncements()" class="flex-1 py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">
          Duyuruya Git
        </button>
    </div>
  </div>
</div>
  <div id="dailyRewardModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 rounded-xl shadow-2xl border border-yellow-500 w-11/12 max-w-4xl text-center relative max-h-[90vh] flex flex-col">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl z-20" onclick="closeDailyRewardModal()">&times;</button>
      
      <div class="flex-shrink-0 pt-8 px-8 pb-4">
          <h4 class="text-yellow-400 text-3xl font-bold mb-2">GÃ¼nlÃ¼k Ã–dÃ¼ller</h4>
          <p id="dailyRewardMessage" class="text-lg text-gray-300 mb-6">AÅŸaÄŸÄ±daki Ã¶dÃ¼llerden alabileceklerini topla. Bol ÅŸans!</p>
          <div id="adminDailyRewardManagementButtonContainer" class="text-center mb-6 hidden">
              <button onclick="openNewDailyRewardForm()" class="py-2 px-6 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md">
                  Yeni Ã–dÃ¼l Ekle
              </button>
          </div>
      </div>
      
      <div class="flex-grow overflow-y-auto scrollable-list px-8 pb-8">
          <div id="dailyRewardItemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              </div>
      </div>

  </div>
</div>
  <div id="announcementLikesModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative max-h-[90vh]">
    <button class="modal-close-button" onclick="closeAnnouncementLikesModal()">&times;</button>
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">BeÄŸenen KullanÄ±cÄ±lar</h4>
    <div id="announcementLikesList" class="scrollable-list max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-lg text-left">
      </div>
  </div>
</div>

<div id="adminDailyRewardModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[100] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-3xl text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl" onclick="closeAdminDailyRewardModal()">&times;</button>
      <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">GÃ¼nlÃ¼k Ã–dÃ¼l YÃ¶netimi</h3>
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700">
          <div class="mb-4 space-y-2">
              <input type="text" id="dailyRewardName" placeholder="Ã–dÃ¼l AdÄ± (Ã–rn: 100 Puan)" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              <textarea id="dailyRewardDescription" placeholder="Ã–dÃ¼l AÃ§Ä±klamasÄ±" rows="2" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white"></textarea>
              <select id="dailyRewardType" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
    <option value="">Ã–dÃ¼l Tipi SeÃ§in</option>
    <option value="points">ğŸ’° Puan</option>
    <option value="boxRights">ğŸ“¦ Kutu HakkÄ±</option>
    <option value="wheelTicket">ğŸ« Ã‡ark Bileti</option>
    <option value="clickCatchTicket">ğŸŸï¸ TÄ±kla-Yakala Bileti</option>
    <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
    <option value="tempMultiplier">âœ–ï¸ Ã‡arpan</option>
    <option value="avatar">ğŸ‘¤ Avatar</option>
    <option value="wildcard">ğŸƒ Joker Kart</option>
    <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
    <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
    <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
    <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
    <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
    <option value="health_regen_potion">ğŸ§ª Can Yenileme Ä°ksiri</option>
    <option value="revival_stone">ğŸ’ Dirilme TaÅŸÄ±</option>
    <option value="health_potion">ğŸ§ª Can Ä°ksiri</option>
    <option value="damage_potion">âš”ï¸ Hasar Ä°ksiri</option>
    <option value="crit_damage_potion">ğŸ¯ Kritik Hasar Ä°ksiri</option>
    <option value="defense_potion">ğŸ›¡ï¸ Savunma Ä°ksiri</option>
    <option value="dodge_potion">ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± Ä°ksiri</option>
    <option value="pierce_potion">ğŸ“Œ Delici ÅansÄ± Ä°ksiri</option>
    <option value="crit_potion">ğŸ’¥ Kritik ÅansÄ± Ä°ksiri</option>
</select>
              
              <div id="dailyRewardAvatarFields" class="hidden space-y-2">
                  <input type="text" id="dailyRewardAvatarName" placeholder="AvatarÄ±n AdÄ±" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="text" id="dailyRewardAvatarImageUrl" placeholder="AvatarÄ±n Resim URL'si" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              </div>
              <input type="number" id="dailyRewardValue" placeholder="DeÄŸer (Puan/Hak Adedi/Kalkan)" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              <input type="number" id="dailyRewardMultiplierUses" placeholder="Ã‡arpan KullanÄ±m HakkÄ±" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white hidden">
              
              <label class="text-gray-300 text-sm block text-left">Ã–dÃ¼l Bekleme SÃ¼resi:</label>
              <div class="flex gap-2">
                  <input type="number" id="dailyRewardCooldownDays" placeholder="GÃ¼n" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="number" id="dailyRewardCooldownHours" placeholder="Saat" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="number" id="dailyRewardCooldownMinutes" placeholder="Dakika" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="number" id="dailyRewardCooldownSeconds" placeholder="Saniye" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              </div>
              
              <input type="text" id="dailyRewardImageUrl" placeholder="Ã–dÃ¼l KartÄ± Resim URL (Opsiyonel)" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
          </div>
          <button onclick="saveDailyReward()" id="saveDailyRewardBtn" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">GÃœNLÃœK Ã–DÃœL OLUÅTUR</button>
          <button onclick="resetDailyRewardForm()" class="w-full py-2 mt-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md hover:-translate-y-1 transition duration-300">Formu Temizle</button>
      </div>
  </div>
</div>
  <div id="wheelLegendModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-md text-center relative max-h-[90vh]">
      <button class="modal-close-button" onclick="closeWheelLegendModal()">&times;</button>
      <h4 class="text-blue-300 text-2xl font-bold mb-6">Ã‡ark Simgeleri ve AnlamlarÄ±</h4>
      <div id="wheelLegendContent" class="space-y-3 text-left scrollable-list max-h-80 overflow-y-auto">
          </div>
  </div>
</div>

  <div id="clickCatchInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeClickCatchInfoModal()">&times;</button>
        <h4 class="text-blue-300 text-2xl font-bold text-center">TÄ±kla-Yakala Oyun Bilgileri</h4>
    </div>

    <div class="overflow-y-auto scrollable-list pr-4 space-y-6 text-gray-300">
        <div>
            <h5 class="text-xl font-bold text-purple-400 mb-2">Tekli Oyun (HaftalÄ±k Skor YarÄ±ÅŸmasÄ±)</h5>
            <p class="mb-2">Bu mod, haftalÄ±k liderlik tablosunda en yÃ¼ksek skoru elde etme yarÄ±ÅŸmasÄ±dÄ±r.</p>
            <ul class="list-disc list-inside space-y-1 pl-2">
                <li>Oyuna girmek <strong>1 TÄ±kla-Yakala Bileti</strong> gerektirir.</li>
                <li>Oyun sÄ±rasÄ±nda topladÄ±ÄŸÄ±nÄ±z skorlar, o haftaki toplam skorunuza eklenir.</li>
                <li>Hafta sonunda, en yÃ¼ksek skoru yapan oyuncu "HaftanÄ±n Åampiyonu" seÃ§ilir ve <strong>Ã¶zel bir Ã¶dÃ¼l</strong> kazanÄ±r.</li>
                <li><b class="text-amber-300">HaftalÄ±k Åampiyon BaÅŸarÄ±mÄ±:</b> HaftanÄ±n birincisi olan oyuncu, profiline kalÄ±cÄ± olarak iÅŸlenen "T-Y YakalayÄ±cÄ± Åampiyonu" baÅŸarÄ±mÄ±nÄ± kazanÄ±r. Bu baÅŸarÄ±m, her yeni ÅŸampiyonlukta seviye atlar.</li>
                <li>Kazanan seÃ§ildikten sonra, o hafta yarÄ±ÅŸmaya katÄ±lmÄ±ÅŸ olan <strong>tÃ¼m oyunculara +1 Bilet</strong> hediye edilir.</li>
            </ul>
        </div>
        
        ```

***

Ä°ÅŸte hepsi bu kadar kanka. Bu deÄŸiÅŸikliklerle birlikte tÃ¼m isteklerin tamamlanmÄ±ÅŸ olacak. KodlarÄ± dikkatlice deÄŸiÅŸtirirsen herhangi bir sorun yaÅŸamazsÄ±n. Bol ÅŸans!
        <div>
            <h5 class="text-xl font-bold text-green-400 mb-2">Lobi Oyunu (RekabetÃ§i Mod)</h5>
            <p class="mb-2">Admin tarafÄ±ndan kurulan bu mod, diÄŸer oyuncularla gerÃ§ek zamanlÄ± bir skor yarÄ±ÅŸÄ±dÄ±r.</p>
            <ul class="list-disc list-inside space-y-1 pl-2">
                <li>Lobiye katÄ±lmak iÃ§in admin tarafÄ±ndan belirlenen bir <strong>giriÅŸ Ã¼creti</strong> (Puan veya Bilet) Ã¶denir.</li>
                <li>Adminin belirlediÄŸi <strong>hedef skora ilk ulaÅŸan oyuncu</strong> oyunu anÄ±nda kazanÄ±r.</li>
                <li>Kazanan oyuncu, lobideki <strong>bÃ¼yÃ¼k Ã¶dÃ¼lÃ¼n</strong> sahibi olur.</li>
            </ul>
        </div>

        <div>
            <h5 class="text-xl font-bold text-yellow-300 mb-2">TÄ±klanabilir Hedefler ve AnlamlarÄ±</h5>
            <div class="space-y-3">
                <p class="font-semibold text-purple-400">-- Tekli Oyunda GeÃ§erli --</p>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ¥®</span><span><strong>DÃ¼ÅŸÃ¼k Skor:</strong> Oyundaki temel skor kaynaÄŸÄ±nÄ±zdÄ±r.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ’°</span><span><strong>YÃ¼ksek Skor:</strong> Normal hedeften daha fazla skor kazandÄ±rÄ±r.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ’£</span><span><strong>Bomba:</strong> DÄ°KKAT! TÄ±klanÄ±ldÄ±ÄŸÄ±nda toplam skorunuzdan -skor dÃ¼ÅŸÃ¼rÃ¼r.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">â°</span><span><strong>Ekstra SÃ¼re:</strong> Kalan oyun sÃ¼renize bonus saniyeler ekler.</span></div>
                <div class="flex items-start gap-3"><span class="text-2xl w-6 text-center pt-1">ğŸ</span>
                    <div>
                        <strong>Ã–zel Hedef:</strong> Nadiren belirir. AÅŸaÄŸÄ±daki Ã§ok deÄŸerli Ã¶dÃ¼llerden birini kazandÄ±rÄ±r:
                        <ul class="list-disc list-inside ml-4 mt-1 text-sm text-cyan-300">
                            <li>Kutu HakkÄ± (ğŸ“¦)</li>
                            <li>Ã‡ark Bileti (ğŸ«)</li>
                            <li>Ã‡arpan (âœ–ï¸)</li>
                            <li>Ä°flas KalkanÄ± (ğŸ›¡ï¸)</li>
                            <li>Joker Kart (ğŸƒ)</li>
                            <li>TÃ¼m Kart Paketleri (ğŸ´ğŸ¥‰ğŸ¥ˆğŸ¥‡ğŸ†)</li>
                            <li>TÃ¼m Canavar SavaÅŸÄ± Ä°ksirleri (ğŸ§ªâš”ï¸ğŸ›¡ï¸ğŸ’¥)</li>
                            <li>Dirilme TaÅŸÄ± (ğŸ’)</li>
                        </ul>
                    </div>
                </div>
                <hr class="border-gray-600">
                <p class="font-semibold text-green-400">-- Lobi Oyununda GeÃ§erli --</p>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ¯</span><span><strong>Hedef:</strong> Hedef skora ulaÅŸmak iÃ§in tÄ±klamanÄ±z gereken ana hedeftir. (+1 Skor)</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">ğŸ’£</span><span><strong>Bomba:</strong> Bu hedefe tÄ±klamak, o anki lobi skorunuzu bir azaltÄ±r. (-1 Skor)</span></div>
            </div>
        </div>
        </div>
  </div>
</div>
  <div id="seasonManagementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-green-500 w-11/12 max-w-3xl text-left relative max-h-[95vh] flex flex-col">
    
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeSeasonManagementModal()">&times;</button>
        <h4 class="text-green-300 text-2xl font-bold text-center">ğŸ† AylÄ±k Sezon YÃ¶netimi ğŸ‘‘</h4>
    </div>

    <div class="overflow-y-auto scrollable-list pr-4 space-y-6">
      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
  <h5 class="text-lg font-semibold text-yellow-300 mb-3">Otomatik Sezon Sonu AyarlarÄ±</h5>
  <div>
    <label for="seasonManagementEndDateInput" class="block text-gray-300 mb-1 text-sm">Sezon BitiÅŸ Tarih ve Saati:</label>
    <input type="datetime-local" id="seasonManagementEndDateInput" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
  </div>
</div>

      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
        <h5 class="text-lg font-semibold text-yellow-300 mb-3">Åampiyon Avatar Ã–dÃ¼lleri</h5>
        <p class="text-xs text-gray-400 mb-3">Bu alanlara URL girilirse, sezon sonunda liderlerin avatarlarÄ± otomatik olarak bu resimlerle gÃ¼ncellenir.</p>
        <div>
          <label for="puanLeaderAvatarUrl" class="block text-gray-300 mb-1 text-sm">Kariyer Puan SÄ±ralamasÄ± 1.'sinin Avatar URL'i:</label>
          <input type="text" id="puanLeaderAvatarUrl" placeholder="https://ornek.com/resim.png" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
        </div>
        <div class="mt-3">
          <label for="rozetLeaderAvatarUrl" class="block text-gray-300 mb-1 text-sm">Liderler SÄ±ralamasÄ± 1.'sinin Avatar URL'i:</label>
          <input type="text" id="rozetLeaderAvatarUrl" placeholder="https://ornek.com/resim.png" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
        </div>
      </div>

      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
        <h5 class="text-lg font-semibold text-yellow-300 mb-3">Genel KatÄ±lÄ±mcÄ± Ã–dÃ¼lleri</h5>
        <p class="text-xs text-gray-400 mb-3">SÄ±fÄ±rlama sonrasÄ± TÃœM KULLANICILARA (ÅŸampiyonlar dahil) verilecek hediye miktarlarÄ±. BoÅŸ bÄ±rakÄ±lÄ±rsa o hediye verilmez.</p>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div>
                <label for="rewardBoxRights" class="block text-gray-300 mb-1 text-sm">ğŸ“¦ Kutu HakkÄ±</label>
                <input type="number" id="rewardBoxRights" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label for="rewardWheelTickets" class="block text-gray-300 mb-1 text-sm">ï¸ğŸ« Ã‡ark Bileti</label>
                <input type="number" id="rewardWheelTickets" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label for="rewardClickCatchTickets" class="block text-gray-300 mb-1 text-sm">ğŸŸï¸ TÄ±kla-Yakala Bileti</label>
                <input type="number" id="rewardClickCatchTickets" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label for="rewardIflasShields" class="block text-gray-300 mb-1 text-sm">ğŸ›¡ï¸ Ä°flas KalkanÄ±</label>
                <input type="number" id="rewardIflasShields" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
        </div>
      </div>
      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
        <h5 class="text-lg font-semibold text-yellow-300 mb-3">Eylemler</h5>
        <div class="space-y-3">
            <button onclick="saveAutomaticResetSettings()" class="w-full py-2 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg">Otomatik SÄ±fÄ±rlamayÄ± Ayarla/Kaydet</button>
            <p class="text-xs text-gray-400 text-center">YukarÄ±daki ayarlarÄ± kaydeder ve geri sayÄ±mÄ± baÅŸlatÄ±r.</p>
            <hr class="border-gray-600">
            <button onclick="stopSeasonCountdown()" class="w-full py-2 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg">Otomatik SÄ±fÄ±rlamayÄ± Ä°ptal Et</button>
            <p class="text-xs text-gray-400 text-center">AyarlanmÄ±ÅŸ olan otomatik sÄ±fÄ±rlamayÄ± ve geri sayÄ±mÄ± durdurur.</p>
            <hr class="border-gray-600">
            <button onclick="executeSeasonReset(true)" class="w-full py-3 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg">SEZONU ÅÄ°MDÄ° BÄ°TÄ°R (MANUEL)</button>
            <p class="text-xs text-gray-400 text-center">Geri sayÄ±mÄ± beklemeden, anÄ±nda her ÅŸeyi sÄ±fÄ±rlar ve Ã¶dÃ¼lleri daÄŸÄ±tÄ±r.</p>
        </div>
      </div>
    </div>
  </div>
</div>
  <div id="persistentAnnouncementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[100002] hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-lg text-center relative">
    <h4 id="persistentAnnTitle" class="text-yellow-400 text-3xl font-bold mb-4"></h4>
    <div id="persistentAnnMessage" class="text-lg text-gray-200 space-y-3 bg-gray-800 p-4 rounded-lg max-h-80 overflow-y-auto scrollable-list"></div>
    <button onclick="markPersistentAnnouncementAsSeen()" class="mt-8 w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">
      AnladÄ±m, Kapat
    </button>
  </div>
</div>
  <div id="seasonInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeSeasonInfoModal()">&times;</button>
        <h4 class="text-blue-300 text-2xl font-bold text-center">ğŸ† AylÄ±k Sezon SÄ±fÄ±rlamasÄ± Nedir?</h4>
    </div>

    <div class="overflow-y-auto scrollable-list pr-4 space-y-4 text-gray-300">
        <p>Oyunumuz, her ay rekabeti tazelemek ve tÃ¼m oyunculara yeni bir baÅŸlangÄ±Ã§ ÅŸansÄ± sunmak iÃ§in <strong>Sezonluk SÄ±fÄ±rlama</strong> sistemini kullanÄ±r. Geri sayÄ±m sayacÄ± sona erdiÄŸinde, bir Ã¶nceki sezon biter ve yeni bir sezon baÅŸlar.</p>
        
        <div>
            <h5 class="text-xl font-bold text-yellow-300 mb-2">Sezon BittiÄŸinde Ne Olur?</h5>
            <ul class="list-disc list-inside space-y-2 pl-2">
                <li><strong>Ã–dÃ¼ller DaÄŸÄ±tÄ±lÄ±r:</strong>
                    <ul class="list-circle list-inside pl-4 mt-1 space-y-2">
                        <li>
                            <p>Åampiyonlar dahil, oyundaki <strong>tÃ¼m oyunculara</strong> admin tarafÄ±ndan belirlenen bir <strong>hediye paketi</strong> gÃ¶nderilir.</p>
                            <div id="seasonGiftPackageDetails" class="mt-3 bg-gray-900/50 p-4 rounded-lg border border-gray-600">
                                <p class="text-gray-400">Ã–dÃ¼l detaylarÄ± yÃ¼kleniyor...</p>
                            </div>
                        </li>
                        <li>
                            <p>AyrÄ±ca sÄ±ralamalarda 1. olan ÅŸampiyonlara Ã¶zel Ã¶dÃ¼ller verilir.</p>
                             <div id="seasonChampionPrizes" class="mt-3 bg-gray-900/50 p-4 rounded-lg border border-yellow-600">
                                <p class="text-gray-400">Åampiyon Ã¶dÃ¼lleri yÃ¼kleniyor...</p>
                            </div>
                        </li>
                    </ul>
                </li>
                <li><strong>Her Åey SÄ±fÄ±rlanÄ±r:</strong>
                    <ul class="list-circle list-inside pl-4 mt-1 text-red-400">
                        <li>TÃ¼m kullanÄ±cÄ±larÄ±n <strong>PuanlarÄ±</strong> sÄ±fÄ±rlanÄ±r.</li>
                        <li>TÃ¼m liderlik istatistikleri (aÃ§Ä±lan kutu sayÄ±sÄ±, harcanan puan vb.) sÄ±fÄ±rlanÄ±r.</li>
                        <li>MaÄŸaza satÄ±n alma geÃ§miÅŸleri ve Ã¼rÃ¼nlerin "kaÃ§ kez satÄ±n alÄ±ndÄ±ÄŸÄ±" bilgisi temizlenir.</li>
                        <li><strong class="text-amber-400">Kart Koleksiyonu AlbÃ¼mleri</strong> ve tÃ¼m kart ilerlemeleri sÄ±fÄ±rlanÄ±r.</li>
                    </ul>
                </li>
                 <li><strong>Neler KalÄ±r?</strong>
                    <ul class="list-circle list-inside pl-4 mt-1 text-green-400">
                        <li>KullanÄ±cÄ± hesaplarÄ±nÄ±z, ÅŸifreleriniz ve PIN'leriniz.</li>
                        <li>Kasaya aktarÄ±lan <strong>Kasa PuanlarÄ±</strong>.</li>
                        <li>MaÄŸazadan satÄ±n aldÄ±ÄŸÄ±nÄ±z <strong>Avatarlar</strong> gibi kalÄ±cÄ± kozmetikler.</li>
                        <li>KazanÄ±lan <strong>Koleksiyon ÅampiyonluÄŸu</strong> unvanlarÄ± profilde kalÄ±r.</li>
                        <li>Sezon sonunda hediye edilen envanter eÅŸyalarÄ± (Kutu HaklarÄ±, Biletler vb.) yeni sezona aktarÄ±lÄ±r.</li>
                    </ul>
                </li>
            </ul>
        </div>
        <p class="font-bold text-center text-yellow-200 pt-2 border-t border-gray-700">Yeni sezon, yeni bir baÅŸlangÄ±Ã§ demektir. Herkese bol ÅŸans!</p>
    </div>
  </div>
</div>
<div id="weeklyResetInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeWeeklyResetInfoModal()">&times;</button>
        <h4 class="text-purple-300 text-2xl font-bold text-center">ğŸ¯ HaftalÄ±k TÄ±kla-Yakala SÄ±fÄ±rlamasÄ± Nedir?</h4>
    </div>
    <div class="overflow-y-auto scrollable-list pr-4 space-y-4 text-gray-300">
        <p>TÄ±kla-Yakala oyununda rekabeti canlÄ± tutmak iÃ§in her hafta liderlik tablosu sÄ±fÄ±rlanÄ±r ve Ã¶dÃ¼ller daÄŸÄ±tÄ±lÄ±r. Geri sayÄ±m sayacÄ± sona erdiÄŸinde, bir Ã¶nceki hafta biter ve yeni bir hafta baÅŸlar.</p>
        <div>
            <h5 class="text-xl font-bold text-yellow-300 mb-2">Hafta BittiÄŸinde Ne Olur?</h5>
            <ul class="list-disc list-inside space-y-2 pl-2">
                <li><strong>Åampiyon Belirlenir:</strong> HaftalÄ±k skor tablosunda <strong>1. sÄ±rada</strong> olan oyuncu "HaftanÄ±n Åampiyonu" olur ve admin tarafÄ±ndan belirlenen Ã¶zel Ã¶dÃ¼lÃ¼ kazanÄ±r.</li>
                
                <div id="weeklyWinnerPrizeDetails" class="mt-2 mb-2 bg-gray-900/50 p-4 rounded-lg border border-gray-600">
                    <p class="text-gray-400">Åampiyon Ã¶dÃ¼lÃ¼ yÃ¼kleniyor...</p>
                </div>
                
                <li><strong>KatÄ±lÄ±m Ã–dÃ¼lÃ¼ DaÄŸÄ±tÄ±lÄ±r:</strong> O hafta en az bir kez TÄ±kla-Yakala oynamÄ±ÅŸ olan <strong>tÃ¼m katÄ±lÄ±mcÄ±lara</strong> (ÅŸampiyon dahil) <strong class="text-green-400">+1 TÄ±kla-Yakala Bileti</strong> hediye edilir.</li>
                <li><strong>SÄ±ralama SÄ±fÄ±rlanÄ±r:</strong> TÃ¼m oyuncularÄ±n o haftaki skorlarÄ± ve haftalÄ±k liderlik tablosu tamamen temizlenir. Herkes yeni haftaya eÅŸit ÅŸartlarda baÅŸlar.</li>
            </ul>
        </div>
        <p class="font-bold text-center text-yellow-200 pt-2 border-t border-gray-700">Yeni hafta, yeni bir ÅŸampiyonluk ÅŸansÄ± demektir. Bol ÅŸans!</p>
    </div>
  </div>
</div>

<div id="tradeHistoryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[50001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-indigo-500 w-11/12 max-w-3xl text-left relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeTradeHistoryModal()">&times;</button>
    <h3 class="text-indigo-300 text-3xl font-bold mb-6 text-center">Takas GeÃ§miÅŸi KayÄ±tlarÄ±</h3>
    <div id="tradeHistoryList" class="flex-grow overflow-y-auto scrollable-list pr-4">
      <p class="text-center text-gray-400">Takas kayÄ±tlarÄ± yÃ¼kleniyor...</p>
    </div>
  </div>
</div>

<div id="tradeMarketModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-2xl border border-purple-500 w-11/12 max-w-4xl h-[90vh] text-center relative flex flex-col">
    <button class="modal-close-button" onclick="closeTradeMarketModal()">&times;</button>
    <h3 class="text-purple-300 text-3xl font-bold mb-4 flex-shrink-0">Takas PazarÄ±</h3>
    
    <div class="flex-shrink-0 mb-4 flex flex-col sm:flex-row justify-between items-center gap-4 p-2 bg-gray-800/50 rounded-lg">
        <div class="flex border-b border-gray-700">
            <button id="marketTabAll" onclick="switchMarketTab('all')" class="market-tab-btn flex-1 py-2 px-6 text-base font-bold border-b-2 border-purple-500 text-white">Pazardaki Teklifler</button>
            <button id="marketTabMine" onclick="switchMarketTab('mine')" class="market-tab-btn flex-1 py-2 px-6 text-base font-bold border-b-2 border-transparent text-gray-400">Benim Tekliflerim</button>
        </div>
        <button id="create-new-offer-btn" onclick="openCreateOfferModal()" class="py-2 px-5 bg-green-600 hover:bg-green-500 rounded-lg font-bold text-sm">
    + Yeni Takas Teklifi OluÅŸtur
</button>
    </div>

    <div id="marketOffersList" class="flex-grow overflow-y-auto scrollable-list pr-2 space-y-3">
        </div>
  </div>
</div>

    <div id="tradeCompleteModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[10005] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-green-500 w-11/12 max-w-md text-center relative">
    <h4 class="text-green-300 text-3xl font-bold mb-4">ğŸ¤ Takas GerÃ§ekleÅŸti! ğŸ¤</h4>
    <div id="tradeCompleteMessage" class="text-lg text-gray-200 space-y-3">
        </div>
    <button onclick="closeTradeCompleteModal()" class="mt-8 w-full py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">
      Harika!
    </button>
  </div>
</div>


<div id="createOfferModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10002] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-green-500 w-11/12 max-w-xl text-left relative">
        <button class="modal-close-button" onclick="closeCreateOfferModal()">&times;</button>
        <h3 class="text-green-300 text-3xl font-bold mb-6 text-center">Takas Teklifi OluÅŸtur</h3>
        
        <div class="flex justify-around items-center gap-4">
            <div class="flex-1 text-center">
                <h4 class="font-bold text-yellow-300 mb-2">Teklif EttiÄŸim Kart:</h4>
                <select id="offerMyCardSelect" class="box-setting-input"></select>
            </div>
            
            <span class="text-3xl font-bold text-gray-500">â‡„</span>

            <div class="flex-1 text-center">
                <h4 class="font-bold text-yellow-300 mb-2">Ä°stediÄŸim Kart:</h4>
                <select id="offerRequestCardSelect" class="box-setting-input"></select>
            </div>
        </div>
        <p id="tradeFeeInfo" class="text-center text-sm text-gray-400 mt-6"></p>
        <button id="submit-trade-offer-btn" onclick="submitTradeOffer()" class="w-full mt-2 py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">TEKLÄ°FÄ° PAZARA KOY</button>
    </div>
</div>

<div id="cardPackOpeningModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex-col justify-center items-center z-[10003] hidden">
    <h2 id="cardPackOpeningTitle" class="text-3xl font-bold text-yellow-300 mb-8 animate-pulse">Kart Paketlerini AÃ§!</h2>
    <div id="cardPackOpeningArea" class="flex flex-wrap justify-center items-center gap-8">
        </div>
</div>

<div id="collectionInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeCollectionInfoModal()">&times;</button>
    <h3 class="text-blue-300 text-3xl font-bold mb-6 text-center">Kart Koleksiyonu Rehberi</h3>

    <div class="space-y-4 text-gray-300 overflow-y-auto scrollable-list pr-4">
        <div>
            <h4 class="font-bold text-lg text-yellow-300">ğŸ† AmaÃ§ Nedir?</h4>
            <p>Oyunun amacÄ±, tÃ¼m kartlarÄ± toplayarak koleksiyon albÃ¼mÃ¼nÃ¼ tamamlamaktÄ±r. AlbÃ¼mÃ¼ tamamlayan herkes, admin tarafÄ±ndan belirlenen bÃ¼yÃ¼k Ã¶dÃ¼lleri kazanÄ±r!</p>
        </div>

        <div>
            <h4 class="font-bold text-lg text-yellow-300">ğŸ´ NasÄ±l Kart KazanÄ±lÄ±r?</h4>
            <p>Koleksiyon kartlarÄ± doÄŸrudan bulunmaz. Bunun yerine, oyunun Ã§eÅŸitli yerlerinden **"Kart Paketi"** kazanÄ±rsÄ±n. Her paket, iÃ§inden rastgele bir koleksiyon kartÄ± Ã§Ä±karÄ±r.</p>
            <ul class="list-disc list-inside ml-4 mt-2">
                <li><b>Kutu Oyunu:</b> KutularÄ± aÃ§arak Kart Paketi bulabilirsin.</li>
                <li><b>Åans Ã‡arkÄ±:</b> Ã‡arkÄ± Ã§evirerek Kart Paketi kazanabilirsin.</li>
                <li><b>MaÄŸaza:</b> PuanlarÄ±nla MaÄŸaza'dan Kart Paketi satÄ±n alabilirsin.</li>
            </ul>
        </div>

        <div>
            <h4 class="font-bold text-lg text-yellow-300">â‡„ Fazla Kartlar ve Takas</h4>
            <p>AynÄ± karttan birden fazla kazandÄ±ÄŸÄ±nda, bu kartlar "fazla" olarak birikir. Fazla kartlarÄ±n en Ã¶nemli amacÄ± takas yapmaktÄ±r! **"Takas PazarÄ±"**'na giderek elindeki fazla kartlarÄ±, koleksiyonundaki eksik kartlar karÅŸÄ±lÄ±ÄŸÄ±nda diÄŸer oyuncularla takas edebilirsin.</p>
        </div>

        <div>
            <h4 class="font-bold text-lg text-yellow-300">ğŸƒ Joker Kart Nedir?</h4>
            <p>Joker Kart, oyundaki en nadir ve en Ã¶zel karttÄ±r. Bu kart, koleksiyonundaki herhangi bir eksik kartÄ±n yerine geÃ§er. Eksik bir kartÄ±n Ã¼zerine tÄ±klayarak Joker Kart'Ä±nÄ± kullanabilir ve o kartÄ± anÄ±nda koleksiyonuna ekleyebilirsin!</p>
        </div>

        <div class="mt-4 pt-4 border-t border-gray-600">
            <h4 class="font-bold text-lg text-amber-400">âš ï¸ Ã–nemli Bilgi: Koleksiyonu TamamladÄ±ktan Sonra</h4>
            <p>Koleksiyonu tamamladÄ±ktan sonra kazandÄ±ÄŸÄ±n fazla kartlar, takas edilemez. Bunun yerine, fazla kartlarÄ±n Ã¼zerine tÄ±klayÄ±p belirli bir miktar <b>Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rebilirsin. AynÄ± ÅŸekilde, kazandÄ±ÄŸÄ±n Joker KartlarÄ±da <b>10 kutu hakkÄ±n</b>'a dÃ¶nÃ¼ÅŸtÃ¼rebilirsin.</p>
        </div>

    </div>
  </div>
</div>

<div id="grandPrizeSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[50001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-yellow-500 w-11/12 max-w-2xl text-center relative">
    <button class="modal-close-button" onclick="closeGrandPrizeSettingsModal()">&times;</button>
    <h3 class="text-yellow-300 text-3xl font-bold mb-6">BÃ¼yÃ¼k Ã–dÃ¼l AyarlarÄ±</h3>
    
    <div class="space-y-4">
        <p class="text-sm text-gray-400">Koleksiyonu tamamlayan tÃ¼m oyunculara verilecek Ã¶dÃ¼lleri buradan ayarlayÄ±n.</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    <input type="number" id="prizePoints" placeholder="Puan" class="box-setting-input">
    <input type="number" id="prizeBoxRights" placeholder="Kutu HakkÄ±" class="box-setting-input">
    <input type="number" id="prizeIflasShields" placeholder="Ä°flas KalkanÄ±" class="box-setting-input">
    <input type="number" id="prizeWheelTickets" placeholder="Ã‡ark Bileti" class="box-setting-input">
    <input type="number" id="prizeClickCatchTickets" placeholder="T-Y Bileti" class="box-setting-input">
    
    <input type="text" id="prizeAvatarName" placeholder="Ã–dÃ¼l Avatar AdÄ±" class="box-setting-input">
    <input type="text" id="prizeAvatarImageUrl" placeholder="Ã–dÃ¼l Avatar Resim URL" class="box-setting-input lg:col-span-2">

    <input type="text" id="prizeDescription" placeholder="DiÄŸer Ã–dÃ¼l (Ã–rn: VIP)" class="box-setting-input sm:col-span-2 lg:col-span-3">
</div>
        <button onclick="saveGrandPrizeAndCloseModal()" class="w-full mt-3 py-3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded-lg">BÃ¼yÃ¼k Ã–dÃ¼lÃ¼ Kaydet</button>
    </div>
  </div>
</div>
<div id="updateOverlay" style="display: none;">
    <h2 class="text-3xl font-bold text-yellow-400 mb-4">Yeni bir gÃ¼ncelleme mevcut!</h2>
    <p class="text-lg">Oyunun en gÃ¼ncel sÃ¼rÃ¼mÃ¼ne geÃ§iriliyorsunuz...</p>
    <p class="mt-8 text-4xl animate-spin">â³</p>
</div>

<div id="missingCardsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[10002] hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-cyan-500 w-11/12 max-w-4xl h-[90vh] text-center relative flex flex-col">
    <button class="modal-close-button" onclick="closeMissingCardsModal()">&times;</button>
    <h3 id="missingCardsTitle" class="text-cyan-300 text-3xl font-bold mb-4 flex-shrink-0">KullanÄ±cÄ±nÄ±n Eksik KartlarÄ±</h3>
    
    <div id="missingCardsList" class="flex-grow overflow-y-auto scrollable-list pr-2 grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-6 p-4 bg-gray-900/50 rounded-xl border border-gray-700">
        </div>
  </div>
</div>

<div id="forceUpdateModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-90 flex-col justify-center items-center z-[999999] hidden text-center">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-md relative">
    <h2 class="text-3xl font-bold text-yellow-400 mb-4">Yeni GÃ¼ncelleme Mevcut!</h2>
    <p class="text-lg text-gray-200 mb-8">
      Oyunun en son sÃ¼rÃ¼mÃ¼ne ve yeni Ã¶zelliklere eriÅŸmek iÃ§in lÃ¼tfen sayfayÄ± yenileyin.
    </p>
    <button onclick="performForceReload()" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold text-xl rounded-lg shadow-md animate-pulse">
      Åimdi Yenile
    </button>
  </div>
</div>

    <div id="userAlbumViewerModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[10002] hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-teal-500 w-11/12 max-w-5xl h-[90vh] text-center relative flex flex-col">
    <button class="modal-close-button" onclick="closeUserAlbumViewerModal()">&times;</button>
    <h3 id="userAlbumViewerTitle" class="text-teal-300 text-3xl font-bold mb-2 flex-shrink-0">KullanÄ±cÄ±nÄ±n AlbÃ¼mÃ¼</h3>
    
    <p id="userAlbumViewerWildcardCount" class="text-lg text-purple-400 mb-4 hidden">Joker Kart: 0</p>
    
    <div id="userAlbumViewerGrid" class="flex-grow overflow-y-auto scrollable-list pr-2 grid grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-6 p-4 bg-gray-900/50 rounded-xl border border-gray-700">
        </div>
  </div>
</div>

<div id="maintenanceOverlay" class="fixed top-0 left-0 w-full h-full bg-gray-900 text-white flex-col justify-center items-center z-[999999] hidden text-center">
    <h2 class="text-4xl font-bold text-red-500 mb-4">SÄ°TE BAKIMDA</h2>
    <p class="text-xl">Oyun dÃ¼nyasÄ±nda bazÄ± gÃ¼ncellemeler yapÄ±yoruz. LÃ¼tfen daha sonra tekrar deneyin.</p>
    <div id="maintenanceIcon" class="mt-8 text-5xl animate-spin cursor-pointer" title="Admin GiriÅŸi">âš™ï¸</div>
</div>
<div id="loginStreakModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 rounded-xl shadow-2xl border border-teal-500 w-11/12 max-w-4xl text-center relative max-h-[90vh] flex flex-col">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl z-20" onclick="closeLoginStreakModal()">&times;</button>
      
      <div class="flex-shrink-0 pt-8 px-8 pb-4">
          <h4 class="text-teal-300 text-3xl font-bold mb-2">GiriÅŸ Serisi Ã–dÃ¼lleri</h4>
          <p id="loginStreakMessage" class="text-lg text-gray-300 mb-6"></p>
          <div id="adminLoginStreakManagementButtonContainer" class="text-center mb-6 hidden">
              <button onclick="openAdminLoginStreakModal()" class="py-2 px-6 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md">
                  GiriÅŸ Serisi AyarlarÄ±
              </button>
          </div>
      </div>
      
      <div class="flex-grow overflow-y-auto scrollable-list px-8 pb-8">
          <div id="loginStreakRewardsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-6">
              </div>
      </div>
  </div>
</div>

<div id="adminLoginStreakModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[100] hidden">
  <div class="modal-content bg-gray-900/95 p-6 rounded-2xl shadow-2xl border border-blue-500 w-11/12 max-w-5xl h-[95vh] text-left relative flex flex-col">
      <button class="modal-close-button" onclick="closeAdminLoginStreakModal()">&times;</button>
      <h3 class="text-blue-300 text-3xl font-bold mb-4 text-center">GiriÅŸ Serisi YÃ¶netim Paneli</h3>
      
      <div id="adminLoginStreakRowsContainer" class="flex-grow overflow-y-auto scrollable-list pr-4 space-y-4">
          </div>
      
      <div class="flex-shrink-0 mt-4 pt-4 border-t border-gray-700 flex flex-wrap gap-4 justify-center">
          <button onclick="addLoginStreakDay()" class="py-3 px-6 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg">Yeni GÃ¼n Ekle</button>
          <button onclick="saveLoginStreakRewards()" class="py-3 px-6 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg">TÃ¼m AyarlarÄ± Kaydet</button>
      </div>
  </div>
</div>
<div id="avatarStatsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10002] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-cyan-500 w-11/12 max-w-md text-left relative">
    <button class="modal-close-button" onclick="closeAvatarStatsModal()">&times;</button>
    <h3 id="statsModalUsername" class="text-cyan-300 text-3xl font-bold mb-6 text-center">KullanÄ±cÄ± Ä°statistikleri</h3>
    <div id="statsModalContent" class="space-y-3 text-lg">
      </div>
  </div>
</div>
<div id="monsterInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10003] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-500 w-11/12 max-w-lg text-left relative max-h-[90vh] overflow-y-auto scrollable-list">
    <button class="modal-close-button" onclick="closeMonsterInfoModal()">&times;</button>
    <h3 id="modalMonsterName" class="text-red-300 text-3xl font-bold mb-4 text-center">Canavar Bilgileri</h3>
    
    <img id="modalMonsterImage" src="" alt="Canavar Resmi" class="w-32 h-32 mx-auto mb-4 rounded-lg object-contain border-2 border-gray-600">
    <div id="modalMonsterStats" class="space-y-3 text-lg mb-6">
      </div>
    
    <div class="border-t border-gray-700 pt-4">
        <h4 class="text-yellow-300 text-xl font-bold mb-3">ğŸ† Liderlik Ã–dÃ¼lÃ¼</h4>
        <p id="modalKillReward" class="text-gray-300"></p>
    </div>

    <div class="mt-4 border-t border-gray-700 pt-4">
        <h4 class="text-yellow-300 text-xl font-bold mb-3">âœ¨ Hasar EÅŸiÄŸi Ã–dÃ¼lleri</h4>
        <p id="modalDamageTiers" class="text-gray-300 text-sm space-y-2"></p>
    </div>
  </div>
</div>
<div id="monsterBattleInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeMonsterBattleInfoModal()">&times;</button>
    <h3 class="text-blue-300 text-3xl font-bold mb-6 text-center">Canavar SavaÅŸÄ± Rehberi</h3>
    
    <div class="space-y-4 text-gray-300 overflow-y-auto scrollable-list pr-4">
        <div>
            <h4 class="font-bold text-lg text-yellow-300">âš”ï¸ AmaÃ§ Nedir?</h4>
            <p>Canavar SavaÅŸÄ±, tÃ¼m sunucunun ortak bir dÃ¼ÅŸmana karÅŸÄ± savaÅŸtÄ±ÄŸÄ± bir etkinliktir. AmaÃ§, canavar Ã¶lmeden Ã¶nce ona en Ã§ok hasarÄ± vererek liderlik tablosunda yÃ¼kselmek ve harika Ã¶dÃ¼ller kazanmaktÄ±r.</p>
        </div>
        
        <div class="border-t border-gray-700 pt-4">
            <h4 class="font-bold text-lg text-yellow-300 mb-2">ğŸ›¡ï¸ SavaÅŸ Mekanikleri ve Ä°statistikler</h4>
            <div class="space-y-3">
                <p><strong>â¤ï¸ Can (HP):</strong> AvatarÄ±nÄ±n hayatta kalma gÃ¼cÃ¼dÃ¼r. SÄ±fÄ±ra dÃ¼ÅŸerse maÄŸlup olursun.</p>
                <p><strong>âš”ï¸ Hasar:</strong> Her saldÄ±rÄ±da vereceÄŸin hasar, Minimum ve Maksimum hasar deÄŸerlerin arasÄ±nda rastgele belirlenir.</p>
                <p><strong>ğŸ›¡ï¸ Savunma:</strong> Gelen normal ve kritik saldÄ±rÄ±lardan alÄ±nan hasarÄ± <b class="text-white">yÃ¼zdelik olarak</b> azaltÄ±r. <b class="text-red-400">Delici VuruÅŸlara karÅŸÄ± etkisizdir.</b></p>
                <p><strong>ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± (%):</strong> Gelen normal ve kritik saldÄ±rÄ±lardan <b class="text-white">tamamen kaÃ§Ä±nma</b> ihtimalindir. <b class="text-red-400">Delici VuruÅŸlardan sÄ±yrÄ±lamazsÄ±n.</b></p>
                <p><strong>ğŸ“Œ Delici VuruÅŸ ÅansÄ± (%):</strong> SaldÄ±rÄ±nÄ±n, rakibin <b class="text-white">Savunma ve SÄ±yrÄ±lma</b> Ã¶zelliklerini <b class="text-white">yok sayma</b> ihtimalidir. Bu sayede engellenemez hasar verirsin.</p>
                <p><strong>ğŸ’¥ Kritik VuruÅŸ ÅansÄ± (%):</strong> SaldÄ±rÄ±nÄ±n "Kritik VuruÅŸ" olarak gerÃ§ekleÅŸme ihtimalidir. Kritik vuruÅŸlar Ã§ok daha fazla hasar verir.</p>
                <p><strong>ğŸ¯ Kritik Hasar Bonusu (+%):</strong> Bir kritik vuruÅŸun ne kadar <b class="text-white">ekstra hasar</b> vereceÄŸini belirler. Bu bonus, saldÄ±rganÄ±n <b class="text-yellow-300">Maksimum HasarÄ±</b> Ã¼zerinden hesaplanÄ±r. Ã–rneÄŸin: Maksimum hasarÄ±n 500 ve Kritik Hasar Bonusun +%150 ise, kritik vuruÅŸun normal hasarÄ±na ek olarak <b class="text-white">750 ekstra hasar</b> verir.</p>
            </div>
        </div>

        <div class="border-t border-gray-700 pt-4">
            <h4 class="font-bold text-lg text-yellow-300">ğŸ§ª Ä°ksirler ve KalÄ±cÄ± GÃ¼Ã§lendirmeler</h4>
            <p>MaÄŸazadan veya diÄŸer etkinliklerden kazandÄ±ÄŸÄ±n iksirler, hesabÄ±na <b class="text-red-400">KALICI OLARAK</b> bonuslar ekler. Bu gÃ¼Ã§lendirmeler tÃ¼m avatarlarÄ±nÄ±n temel istatistiklerini artÄ±rÄ±r.</p>
        </div>

        <div class="border-t border-gray-700 pt-4">
            <h4 class="font-bold text-lg text-yellow-300">ğŸ† Ã–dÃ¼ller ve BaÅŸarÄ±mlar</h4>
            <ul class="list-disc list-inside ml-4 mt-2 space-y-2">
                <li><b>Hasar EÅŸiÄŸi Ã–dÃ¼lleri:</b> Canavara belirli bir hasar miktarÄ±nÄ± tek seferde geÃ§tiÄŸinde, rastgele Ã¶dÃ¼ller kazanma ÅŸansÄ± yakalarsÄ±n.</li>
                <li><b>Liderlik Ã–dÃ¼lÃ¼:</b> Canavar Ã¶ldÃ¼ÄŸÃ¼nde, ona en Ã§ok toplam hasarÄ± vermiÅŸ olan oyuncu, bÃ¼yÃ¼k liderlik Ã¶dÃ¼lÃ¼nÃ¼ kazanÄ±r!</li>
                <li><b class="text-amber-300">Canavar Åampiyonu BaÅŸarÄ±mÄ±:</b> Canavara en Ã§ok hasarÄ± veren oyuncu, profiline kalÄ±cÄ± olarak iÅŸlenen "Canavar Åampiyonu" baÅŸarÄ±mÄ±nÄ± kazanÄ±r. Bu baÅŸarÄ±m, her yeni ÅŸampiyonlukta seviye atlar (1. Kez, 2. Kez vb.).</li>
            </ul>
        </div>
    </div>
  </div>
</div>
<div id="cardConversionModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10002] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-green-500 w-11/12 max-w-lg text-center relative">
        <button class="modal-close-button" onclick="closeCardConversionModal()">&times;</button>
        <h3 class="text-green-300 text-3xl font-bold mb-4">Fazla KartÄ± DÃ¶nÃ¼ÅŸtÃ¼r</h3>
        <p id="conversionInfoText" class="text-gray-300 mb-6"></p>
        <div class="flex gap-4">
            <button onclick="closeCardConversionModal()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">
              Ä°ptal
            </button>
            <button id="confirmConversionBtn" class="flex-1 py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">
              DÃ¶nÃ¼ÅŸtÃ¼r
            </button>
        </div>
    </div>
</div>
Â  <script>
Â      
Â      // YENÄ° EKLENECEK GÄ°ZLÄ° ADMÄ°N GÄ°RÄ°ÅÄ° KODU
const keyboardSecretCode = ['b', 'a', 'k', 'i', 'm'];
let keyboardKeySequence = [];

document.addEventListener('keydown', (e) => {
    const maintenanceOverlay = document.getElementById('maintenanceOverlay');
    if (maintenanceOverlay.style.display !== 'flex') {
        keyboardKeySequence = [];
        return;
    }
    const key = e.key.toLowerCase();
    keyboardKeySequence.push(key);
    if (keyboardKeySequence.length > keyboardSecretCode.length) {
        keyboardKeySequence.shift();
    }
    if (keyboardKeySequence.join('') === keyboardSecretCode.join('')) {
        console.log("Admin bakÄ±m modu (Klavye) bypass kodu girildi!");
        maintenanceOverlay.style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
        keyboardKeySequence = [];
    }
});

// --- MOBÄ°L (DOKUNMA) Ä°Ã‡Ä°N GÄ°RÄ°Å KODU ---
let tapCount = 0;
let firstTapTime = 0;
const requiredTaps = 5; // GiriÅŸ iÃ§in gereken dokunma sayÄ±sÄ±
const tapTimeLimit = 3000; // 3 saniye iÃ§inde dokunulmalÄ±

const maintenanceIcon = document.getElementById('maintenanceIcon');
if (maintenanceIcon) {
    maintenanceIcon.addEventListener('click', () => {
        const maintenanceOverlay = document.getElementById('maintenanceOverlay');
        if (maintenanceOverlay.style.display !== 'flex') return;

        const now = Date.now();
        if (now - firstTapTime > tapTimeLimit) {
            tapCount = 0;
        }
        if (tapCount === 0) {
            firstTapTime = now;
        }
        tapCount++;
        if (tapCount >= requiredTaps) {
            console.log("Admin bakÄ±m modu (Mobil) bypass kodu aktive edildi!");
            maintenanceOverlay.style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            tapCount = 0;
            firstTapTime = 0;
        }
    });
}
Â  // Firebase yapÄ±landÄ±rmasÄ±
Â  const firebaseConfig = {
    apiKey: "AIzaSyAVuyT2Hb7v9omKSgcwtoj0gzjTbXRtQn8",
    authDomain: "weizendtv-oyun.firebaseapp.com",
    databaseURL: "https://weizendtv-oyun-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "weizendtv-oyun",
    storageBucket: "weizendtv-oyun.appspot.com",
    messagingSenderId: "762409187638",
    appId: "1:762409187638:web:6e9888f4bdacfac017db97"
  };

  try {
    firebase.initializeApp(firebaseConfig);
  } catch (e) {
    if (!e.message.includes("already exists")) {
      console.error("Firebase baÅŸlatma hatasÄ±: ", e);
    }
  }

  const db = firebase.database()
  // BU YENÄ° KOD BLOÄUNU OLDUÄU GÄ°BÄ° EKLE

let serverTimeOffset = 0;
db.ref(".info/serverTimeOffset").on("value", function(snapshot) {
    serverTimeOffset = snapshot.val();
});

function getSyncedTime() {
    return Date.now() + serverTimeOffset;
};
  
  
  // --- YENÄ°: Listener (Dinleyici) YÃ¶netimi ---
  let activeListeners = {};
  function detachAllListeners() {
      console.log("TÃ¼m Firebase dinleyicileri kapatÄ±lÄ±yor...");
      for (const key in activeListeners) {
          const listener = activeListeners[key];
          if (listener && listener.ref && listener.event && listener.callback) {
              listener.ref.off(listener.event, listener.callback);
          }
      }
      activeListeners = {};
      console.log("Dinleyiciler kapatÄ±ldÄ±.");
  }
  // --- YENÄ° KOD BÄ°TÄ°Å ---
  const auth = firebase.auth();

  // Global deÄŸiÅŸkenler
  let monsterBattleData = {}; // Canavar ve liderlik tablosu verilerini tutacak
  let avatarBaseStats = {}; // AvatarlarÄ±n temel stat'larÄ±nÄ± tutacak
  let attackCooldown = false; // SaldÄ±rÄ± bekleme sÃ¼resi iÃ§in
  let hasShownLobbyNotification = false;
  let currentUser = null;
      let activeStreakTimers = {};
  let allUsersCache = [];
  let isAdmin = false;
  let boxes = [];
  const BOX_RIGHTS_COST_PER_BOX = 1;
  let isGameLocked = false; 
  let sessionStartTime = Date.now();
  let latestAnnouncementTimestamp = 0;
  let latestStoreItemTimestamp = 0;
  let newlyAcquiredCards = new Set();
  let ticketsUsedThisRound = 1;

  const defaultAvatarUrl = 'https://i.hizliresim.com/n01dnz4.png?_gl=1*11uaptm*_ga*NTE1MDc3ODEyLjE3Mzg5Mjg1MDk.*_ga_M9ZRXYS2YN*czE3NTQ2OTEwMTgkbzkkZzEkdDE3NTQ2OTEwMjYkajUyJGwwJGgw'; // VarsayÄ±lan profil resmi
  
  // â˜…â˜…â˜… SENÄ°N Ä°STEDÄ°ÄÄ°N YENÄ° VARSAYILAN AYARLAR â˜…â˜…â˜…
  const BOX_CONTENTS = [
    { type: 'surpriz', value: 0, count: 1 },
    { type: 'points', value: 1000, count: 2 },
    { type: 'points', value: 750, count: 3 },
    { type: 'points', value: 500, count: 4 },
    { type: 'points', value: 250, count: 5 },
    { type: 'points', value: 100, count: 10 },
    { type: 'points', value: 50, count: 15 },
    { type: 'points', value: 25, count: 20 },
    { type: 'iflas', value: 0, count: 10 },
    { type: 'multiplier', value: 2, count: 1 },
    { type: 'multiplier', value: 3, count: 1 },
    { type: 'card_pack', value: 1, count: 6 },
    { type: 'card_pack_normal', value: 1, count: 5 },
    { type: 'card_pack_gumus', value: 1, count: 4 },
    { type: 'card_pack_altin', value: 1, count: 3 },
    { type: 'card_pack_efsanevi', value: 1, count: 1 },
    { type: 'wheelTicket', value: 1, count: 5 },
    { type: 'clickCatchTicket', value: 1, count: 4 }
  ];
  const TOTAL_BOXES = BOX_CONTENTS.reduce((sum, item) => sum + item.count, 0);

  // Modal elementleri
  const pointAdjustmentModal = document.getElementById('pointAdjustmentModal');
  const boxRightAdjustmentModal = document.getElementById('boxRightAdjustmentModal');
  const iflasShieldAdjustmentModal = document.getElementById('iflasShieldAdjustmentModal');
  const multiplierAdjustmentModal = document.getElementById('multiplierAdjustmentModal');
  const blockDurationModal = document.getElementById('blockDurationModal');
  const blockedMessageModal = document.getElementById('blockedMessageModal');
  const kickVerificationModal = document.getElementById('kickVerificationModal');
  const passwordResetModal = document.getElementById('passwordResetModal');
  const generalMessageModal = document.getElementById('generalMessageModal');
  const welcomeGiftModal = document.getElementById('welcomeGiftModal');
  const cardSelectionModal = document.getElementById('cardSelectionModal');
  const cardContainer = document.querySelector('#cardSelectionModal .card-container');
  const openedBoxInfoModal = document.getElementById('openedBoxInfoModal');
  const adminPanelModal = document.getElementById('adminPanelModal');
  const adminPanelToggleButton = document.getElementById('adminPanelToggleButton');
  const userManagementModal = document.getElementById('userManagementModal');
  const publicUserDetailModal = document.getElementById('publicUserDetailModal'); 
  const inventoryModal = document.getElementById('inventoryModal');
  const globalOpenedBoxInfoModal = document.getElementById('globalOpenedBoxInfoModal');
  const badgeInfoModal = document.getElementById('badgeInfoModal');
  const purchaseHistoryModal = document.getElementById('purchaseHistoryModal');
  const boxStatsModal = document.getElementById('boxStatsModal');
  const spectatorModal = document.getElementById('spectatorModal');
  const dailyRewardModal = document.getElementById('dailyRewardModal');
  const newAnnouncementModal = document.getElementById('newAnnouncementModal');
  const announcementLikesModal = document.getElementById('announcementLikesModal');
  const adminStoreModal = document.getElementById('adminStoreModal');
  const adminDailyRewardModal = document.getElementById('adminDailyRewardModal');
  const wheelTicketAdjustmentModal = document.getElementById('wheelTicketAdjustmentModal');
  const clickCatchTicketAdjustmentModal = document.getElementById('clickCatchTicketAdjustmentModal');
  const boxSettingsModal = document.getElementById('boxSettingsModal');
  const helpModal = document.getElementById('helpModal');
  const avatarSelectionModal = document.getElementById('avatarSelectionModal');

  let targetUserForAdjustment = null;
  let targetUserForBoxRightAdjustment = null;
  let targetUserForIflasShieldAdjustment = null;
  let targetUserForMultiplierAdjustment = null;
  let targetUserForBlock = null;
  let targetUserForWheelTicket = null;
  let targetUserForClickCatchTicket = null;
  let userForPasswordReset = null;
  let selectedUserForManagement = null;
  let countdownInterval = null;
  let cardValues = [1000, 2000, 3000, 4000, 5000];
  let activeBlockedUserTimers = {};
  let activeDailyRewardTimers = {};
  
  let currentCardsToOpen = 0;
  let cardsOpenedInCurrentSurpriseSession = 0;
  let totalPointsGainedInSurpriseSession = 0;
  let surpriseBoxMultiplier = 1;

  let editingItemId = null;
  let currentActiveSection = 'game';

  let storeCountdownInterval = null;
  let activeStoreCountdowns = {};
  
  let editingDailyRewardId = null;
  let editingAnnouncementId = null;
  let activeUserProfileListener = null;
  
  // Åans Ã‡arkÄ± DeÄŸiÅŸkenleri
  const wheel = document.getElementById('wheel');
  const spinBtn = document.getElementById('spinWheelBtn');
  let isWheelSpinning = false;
  let wheelSegments = []; // Bu artÄ±k veritabanÄ±ndan doldurulacak

const defaultWheelSegments = [
    // SÄ±k Gelen Ã–dÃ¼ller (YÃ¼ksek Åans)
    { type: 'points', value: 100, label: 'ğŸŒ', prizeName: '+100 Puan', color: '#FF5733', weight: 20 },
    { type: 'points', value: 10, label: 'ğŸ†', prizeName: '+10 Puan', color: '#33FF57', weight: 20 },
    { type: 'boxRights', value: 1, label: 'ğŸ“¦', prizeName: '+1 Kutu HakkÄ±', color: '#3357FF', weight: 20 },
    { type: 'card_pack', value: 1, label: 'ğŸ´', prizeName: '+1 Standart Kart Paketi', color: '#FF33A6', weight: 18 },
    { type: 'card_pack_normal', value: 1, label: 'ğŸ¥‰', prizeName: '+1 Bronz Kart Paketi', color: '#33FFF3', weight: 15 },
    { type: 'boxRights', value: 3, label: 'ğŸ', prizeName: '+3 Kutu HakkÄ±', color: '#F3FF33', weight: 10 },
    { type: 'pas', label: 'â˜ ï¸', prizeName: 'Pas', color: '#8E44AD', weight: 20 },

    // Orta Seviye Ã–dÃ¼ller (Normal Åans)
    { type: 'card_pack_gumus', value: 1, label: 'ğŸ¥ˆ', prizeName: '+1 GÃ¼mÃ¼ÅŸ Kart Paketi', color: '#E67E22', weight: 7 },
    { type: 'points', value: 250, label: 'ğŸ', prizeName: '+250 Puan', color: '#2ECC71', weight: 9 },
    { type: 'iflasShield', value: 1, label: 'ğŸ›¡ï¸', prizeName: '+1 Ä°flas KalkanÄ±', color: '#3498DB', weight:  4},
    { type: 'clickCatchTicket', value: 1, label: 'ğŸŸï¸', prizeName: '+1 T-Y Bileti', color: '#E74C3C', weight: 5 },
    { type: 'wheelTicket', value: 1, label: 'ğŸ¡', prizeName: 'Bedava Ã‡evirme', color: '#1ABC9C', weight: 9 },
    { type: 'pas', label: 'â˜ ï¸', prizeName: 'Pas', color: '#9B59B6', weight: 20 },
    
    // Nadir ve Efsanevi Ã–dÃ¼ller (DÃ¼ÅŸÃ¼k Åans)
    { type: 'card_pack_altin', value: 1, label: 'ğŸ¥‡', prizeName: '+1 AltÄ±n Kart Paketi', color: '#F39C12', weight: 2 },
    { type: 'wildcard', value: 1, label: 'ğŸƒ', prizeName: '+1 Joker Kart', color: '#27AE60', weight: 1 },
    { type: 'tempMultiplier', value: 5, duration: 1, label: 'âœ–ï¸', prizeName: '5X Ã‡arpan', color: '#2980B9', weight: 2 },
    { type: 'points', value: 1000, label: 'ğŸ‚', prizeName: '+1000 Puan', color: '#D35400', weight: 3 },
    { type: 'card_pack_efsanevi', value: 1, label: 'ğŸ†', prizeName: '+1 Efsanevi Kart Paketi', color: '#16A085', weight: 1 },
    { type: 'surpriseBox', value: 1, label: 'ğŸ‰', prizeName: 'SÃ¼rpriz Kutu', color: '#C0392B', weight: 1 }
];
  
  // TÄ±kla Yakala DeÄŸiÅŸkenleri
  let clickCatchGameActive = false;
  let clickCatchScore = 0;
  let clickCatchTimer = 30; // Bu artÄ±k sadece bir baÅŸlangÄ±Ã§ deÄŸeri
  let clickCatchTimerInterval = null;
  let clickCatchItemInterval = null;
  
  // Oyun sonunda eklenecek Ã¶dÃ¼lleri tutan deÄŸiÅŸkenler
  let collectedBoxRights = 0;
  let collectedIflasShields = 0;
  let collectedWheelTickets = 0;
  let collectedCardPacks = [];
  
  // HaftanÄ±n liderini bu deÄŸiÅŸkende tutacaÄŸÄ±z. SÄ±ralama gÃ¼ncellendiÄŸinde bu da gÃ¼ncellenir.
  let clickCatchLeader = null; 
  
  // Tekli oyunun tÃ¼m ayarlarÄ±nÄ± bu obje iÃ§inde toplayacaÄŸÄ±z.
  let soloGameSettings = {
      duration: 30,
      itemDisappearTime: 1200,
      itemInterval: 600,
      bombChance: 40,
      timeChance: 8,
      goldChance: 6,
      specialChance: 4,
      timeValue: 3,
      bombValue: -75,
      goldValue: 100,
      normalValue: 50
  };
  
  // Her oyun baÅŸladÄ±ÄŸÄ±nda rastgele bir Ã¶zel eÅŸya seÃ§ip bu deÄŸiÅŸkene atayacaÄŸÄ±z.
  let specialItemForThisRound = null;

  // GÄ°RÄ°Å/KAYIT SÄ°STEMÄ°
  function switchAuthTab(tab) {
    const loginDiv = document.getElementById('loginDiv');
    const registerDiv = document.getElementById('registerDiv');
    const loginTabBtn = document.getElementById('loginTabBtn');
    const registerTabBtn = document.getElementById('registerTabBtn');

    if (tab === 'login') {
        loginDiv.classList.remove('hidden');
        registerDiv.classList.add('hidden');
        loginTabBtn.classList.add('border-red-500', 'text-white');
        loginTabBtn.classList.remove('border-transparent', 'text-gray-400');
        registerTabBtn.classList.add('border-transparent', 'text-gray-400');
        registerTabBtn.classList.remove('border-red-500', 'text-white');
    } else {
        loginDiv.classList.add('hidden');
        registerDiv.classList.remove('hidden');
        registerTabBtn.classList.add('border-red-500', 'text-white');
        registerTabBtn.classList.remove('border-transparent', 'text-gray-400');
        loginTabBtn.classList.add('border-transparent', 'text-gray-400');
        loginTabBtn.classList.remove('border-red-500', 'text-white');
    }
  }
  
  async function login() {
    const user = document.getElementById("loginUsername").value.trim().toLowerCase();
    const pass = document.getElementById("loginPassword").value.trim();

    if (!user || !pass) {
        displayMessage("KullanÄ±cÄ± adÄ± ve ÅŸifre boÅŸ bÄ±rakÄ±lamaz!");
        return;
    }

    if (user === "weizendtv") {
        const adminEmail = "weizendtv@weizendtvoyun.com";
        try {
            await auth.signInWithEmailAndPassword(adminEmail, pass);
        } catch (error) {
            displayMessage("Admin kullanÄ±cÄ± adÄ± veya ÅŸifresi yanlÄ±ÅŸ!");
        }
        return;
    }

    db.ref('users/' + user).once('value').then(snap => {
        if (!snap.exists()) {
            displayMessage("Hesap bulunamadÄ±. LÃ¼tfen 'KayÄ±t Ol' sekmesinden yeni bir hesap oluÅŸturun.");
            return;
        }
        
        const data = snap.val();
        
        if (data.approved && data.approvalNotified === false) {
            displayMessage(`<b>${user}</b>, hesabÄ±nÄ±z onaylandÄ±. ArtÄ±k giriÅŸ yapabilirsiniz!`);
            db.ref('users/' + user).update({ approvalNotified: true });
            return;
        }

        if (data.password !== pass) {
            displayMessage("Åifre yanlÄ±ÅŸ!");
            return;
        }
        if (!data.approved) {
            displayMessage("HesabÄ±nÄ±z henÃ¼z admin tarafÄ±ndan onaylanmamÄ±ÅŸ. LÃ¼tfen Kick Ã¼zerinden doÄŸrulamayÄ± tamamladÄ±ÄŸÄ±nÄ±zdan emin olun ve bekleyin.");
            return;
        }
        
        // --- YENÄ° EKLENEN SATIR BAÅLANGICI ---
        // KullanÄ±cÄ± adÄ± ve ÅŸifre doÄŸruysa, tarayÄ±cÄ±ya kullanÄ±cÄ± adÄ±nÄ± kaydet.
        localStorage.setItem('weizendOyunUser', user);
        // --- YENÄ° EKLENEN SATIR SONU ---

        checkAndProceedLogin(user, data);

    }).catch(error => {
        console.error("Firebase veritabanÄ± okuma hatasÄ±: ", error);
        displayMessage("GiriÅŸ yaparken bir sorun oluÅŸtu.");
    });
}
  // MEVCUT register fonksiyonunu bununla deÄŸiÅŸtir
async function register() {
    const username = document.getElementById("registerUsername").value.trim().toLowerCase();
    const password = document.getElementById("registerPassword").value.trim();
    const passwordConfirm = document.getElementById("registerPasswordConfirm").value.trim();
    const pin = document.getElementById("registerPin").value.trim();

    if (!username || !password || !passwordConfirm || !pin) {
        displayMessage("LÃ¼tfen tÃ¼m alanlarÄ± eksiksiz doldurun.");
        return;
    }
    if (username.length < 3) {
        displayMessage("KullanÄ±cÄ± adÄ± en az 3 karakter olmalÄ±!");
        return;
    }
    if (password.length < 6) {
        displayMessage("Åifre en az 6 karakter olmalÄ±!");
        return;
    }
    if (password !== passwordConfirm) {
        displayMessage("Åifreler uyuÅŸmuyor!");
        return;
    }
    if (!/^\d{6}$/.test(pin)) {
        displayMessage("PIN, 6 haneli bir rakam olmalÄ±dÄ±r!");
        return;
    }

    const existingUsernameSnap = await db.ref('users/' + username).once('value');
    if (existingUsernameSnap.exists()) {
        displayMessage("Bu Kick kullanÄ±cÄ± adÄ± zaten alÄ±nmÄ±ÅŸ.");
        return;
    }

    const confirmed = await customConfirm(`<b>${username}</b> kullanÄ±cÄ± adÄ±nÄ±n Kick hesabÄ±nÄ±zla aynÄ± olduÄŸuna emin misiniz? Onay sÃ¼reci bu isme gÃ¶re yapÄ±lacaktÄ±r.`);
    if (confirmed) {
        const newUser = {
            password: password,
            pin: pin,
            balance: 0,
            highestBalanceEver: 0,
            kariyerPuani: 0, // YENÄ° EKLENEN SATIR
            totalSpentPoints: 0,
            kutuHakki: 0,
            carkBileti: 0,
            clickCatchTickets: 0,
            clickCatchHighestScore: 0,
            approved: false,
            approvalNotified: null,
            blocked: false,
            blockedUntil: null,
            boxesOpenedCount: 0,
            surpriseBoxesOpened: 0,
            activeMultiplier: 1,
            multiplierSource: 'none',
            multiplierRemainingUses: 0,
            iflasShieldUses: 0,
            registeredAt: new Date().toLocaleString(),
            iflasCount: 0,
            iflasShieldUsedCount: 0,
            multiplierFoundCount: 0,
            storePurchasesCount: 0,
            hasReceivedWelcomeGift: false,
            notifications: {},
            dailyRewardsClaimed: {},
            lastSeenAnnouncementTimestamp: 0,
        };

        db.ref('users/' + username).set(newUser).then(() => {
            openKickVerificationModal();
        }).catch(error => {
            console.error("Firebase kayÄ±t hatasÄ±: ", error);
            displayMessage("KayÄ±t olurken bir hata oluÅŸtu.");
        });
    }
}

  // Åifre SÄ±fÄ±rlama
  function openPasswordResetModal() {
    document.getElementById('resetStep1').classList.remove('hidden');
    document.getElementById('resetStep3').classList.add('hidden');
    document.getElementById('resetUsername').value = '';
    document.getElementById('resetPin').value = '';
    passwordResetModal.style.display = 'flex';
  }

  async function verifyResetInfo() {
      const username = document.getElementById('resetUsername').value.trim().toLowerCase();
      const pin = document.getElementById('resetPin').value.trim();
      
      if (!username || !pin) {
          displayMessage("KullanÄ±cÄ± adÄ± ve PIN gereklidir.");
          return;
      }

      const userSnap = await db.ref('users/' + username).once('value');
      if (!userSnap.exists()) {
          displayMessage("KullanÄ±cÄ± bulunamadÄ±.");
          return;
      }

      const userData = userSnap.val();
      if (userData.pin !== pin) {
          displayMessage("Girilen PIN, kullanÄ±cÄ± ile eÅŸleÅŸmiyor.");
          return;
      }
      
      userForPasswordReset = username;
      document.getElementById('resetStep1').classList.add('hidden');
      document.getElementById('resetStep3').classList.remove('hidden');
  }

  async function updatePassword() {
      const newPass = document.getElementById('newPassword').value.trim();
      const newPassConfirm = document.getElementById('newPasswordConfirm').value.trim();

      if (newPass.length < 6) {
          displayMessage("Yeni ÅŸifre en az 6 karakter olmalÄ±dÄ±r.");
          return;
      }
      if (newPass !== newPassConfirm) {
          displayMessage("Yeni ÅŸifreler uyuÅŸmuyor.");
          return;
      }
      await db.ref('users/' + userForPasswordReset).update({ password: newPass });
      displayMessage("Åifreniz baÅŸarÄ±yla gÃ¼ncellendi. ArtÄ±k giriÅŸ yapabilirsiniz.");
      closePasswordResetModal();
  }
  
  function closePasswordResetModal() {
      passwordResetModal.style.display = 'none';
      userForPasswordReset = null;
  }
  
  function openKickVerificationModal() { kickVerificationModal.style.display = 'flex'; }
  function closeKickVerificationModal() { 
      kickVerificationModal.style.display = 'none'; 
      switchAuthTab('login');
  }
  function closeWelcomeGiftModal() { welcomeGiftModal.style.display = 'none'; }


  // MEVCUT checkAndProceedLogin FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR
async function checkAndProceedLogin(username, userData) {
    // 1. GÄ°RÄ°Å YAPMADAN Ã–NCE BAKIM MODUNU KONTROL ET
    const maintenanceSnap = await db.ref('gameConfig/isMaintenanceMode').once('value');
    const isMaintenanceOn = maintenanceSnap.val() === true;

    if (isMaintenanceOn) {
        // BakÄ±m modu aÃ§Ä±ksa, oyun yerine bakÄ±m ekranÄ±nÄ± gÃ¶ster.
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('gameDiv').style.display = 'none';
        document.getElementById('maintenanceOverlay').style.display = 'flex';
        return; // Fonksiyonu burada bitir, oyuna giriÅŸ yapma.
    }

    // 2. BakÄ±m modu kapalÄ±ysa, eski normal kontrollere devam et.
    // Engelli kullanÄ±cÄ± kontrolÃ¼
    if (userData.blocked && userData.blockedUntil && Date.now() < userData.blockedUntil) {
        displayBlockedMessage(userData.blockedUntil, username);
        return; // Engelliyse oyuna giriÅŸ yapma
    }

    // Engel sÃ¼resi dolmuÅŸ ama veritabanÄ±nda kalmÄ±ÅŸsa temizle
    if (userData.blocked && userData.blockedUntil && Date.now() >= userData.blockedUntil) {
        await db.ref('users/' + username).update({ blocked: false, blockedUntil: null });
    }
    
    // Her ÅŸey yolundaysa oyuna giriÅŸ yap
    currentUser = username;
    isAdmin = false;
    afterLogin();
}

 /// MEVCUT "DOMContentLoaded" KOD BLOÄUNU KOMPLE SÄ°LÄ°P BUNUNLA DEÄÄ°ÅTÄ°R

document.addEventListener('DOMContentLoaded', () => {
    const loginContainer = document.getElementById("loginContainer");
    const gameDiv = document.getElementById("gameDiv");
    const maintenanceOverlay = document.getElementById("maintenanceOverlay");

    let isFirebaseUserChecked = false;
    let isMaintenanceChecked = false;
    let isMaintenanceMode = false;
    let loggedInFirebaseUser = null;

    // 1. BakÄ±m modunu dinle
    db.ref('gameConfig/isMaintenanceMode').on('value', snap => {
        isMaintenanceMode = snap.val() === true;
        isMaintenanceChecked = true;
        checkInitialLoad();
    });

    // 2. KullanÄ±cÄ± giriÅŸ durumunu dinle
    auth.onAuthStateChanged(user => {
        loggedInFirebaseUser = user;
        isFirebaseUserChecked = true;
        checkInitialLoad();
    });

    // 3. Ä°ki bilgi de geldikten sonra siteyi yÃ¼kle
    function checkInitialLoad() {
        if (!isFirebaseUserChecked || !isMaintenanceChecked) {
            return; // HenÃ¼z her iki bilgiyi de almadÄ±ysak bekle
        }

        const isAdminLoggedIn = loggedInFirebaseUser && loggedInFirebaseUser.email.startsWith('weizendtv');
        const savedUser = localStorage.getItem('weizendOyunUser');

        // BakÄ±m modu aktifse VE giriÅŸ yapan admin deÄŸilse, bakÄ±m ekranÄ±nÄ± gÃ¶ster
        if (isMaintenanceMode && !isAdminLoggedIn) {
            loginContainer.style.display = "none";
            gameDiv.style.display = "none";
            maintenanceOverlay.style.display = "flex";
            detachAllListeners(); // Herkes iÃ§in dinleyicileri kapat
            return;
        }
        
        // BakÄ±m modu kapalÄ±ysa veya admin giriÅŸ yaptÄ±ysa, normal iÅŸlemlere devam et
        maintenanceOverlay.style.display = "none";

        if (isAdminLoggedIn) {
            currentUser = "WeizendTv";
            isAdmin = true;
            afterLogin();
        } else if (savedUser) {
            db.ref('users/' + savedUser).once('value').then(snap => {
                if (snap.exists()) {
                    checkAndProceedLogin(savedUser, snap.val());
                } else {
                    localStorage.removeItem('weizendOyunUser');
                    loginContainer.style.display = "block";
                    gameDiv.style.display = "none";
                }
            });
        } else {
            loginContainer.style.display = "block";
            gameDiv.style.display = "none";
            switchAuthTab('login');
            detachAllListeners();
        }
    }
});

// Adminin bakÄ±m modunu aÃ§Ä±p kapatacaÄŸÄ± fonksiyon
async function toggleMaintenanceMode() {
    if (!isAdmin) return;
    const ref = db.ref('gameConfig/isMaintenanceMode');
    const snap = await ref.once('value');
    const isCurrentlyActive = snap.val() === true;
    
    const newState = !isCurrentlyActive;
    await ref.set(newState);
    
    const btn = document.getElementById('maintenanceModeBtn');
    if (newState) {
        btn.textContent = 'BakÄ±mÄ± Bitir';
        btn.classList.remove('bg-yellow-700', 'hover:bg-yellow-600');
        btn.classList.add('bg-green-700', 'hover:bg-green-600');
        displayMessage("BakÄ±m modu BAÅLATILDI. Adminler hariÃ§ kimse siteye giremez.");
    } else {
        btn.textContent = 'BakÄ±mÄ± BaÅŸlat';
        btn.classList.remove('bg-green-700', 'hover:bg-green-600');
        btn.classList.add('bg-yellow-700', 'hover:bg-yellow-600');
        displayMessage("BakÄ±m modu BÄ°TTÄ°. Site tÃ¼m kullanÄ±cÄ±lara aÃ§Ä±ldÄ±.");
    }
}

// YENÄ° KODU YAPIÅTIR
async function saveWeeklyResetSettings() {
    if (!isAdmin) return;

    const dateInput = document.getElementById('weeklyResetEndDateInput').value;
    if (!dateInput) {
        displayMessage("LÃ¼tfen geÃ§erli bir bitiÅŸ tarihi girin.");
        return;
    }

    const prizeType = document.getElementById('weeklyPrizeType').value;
    const prizeAmount = parseInt(document.getElementById('weeklyPrizeAmount').value);
    const prizeUses = parseInt(document.getElementById('weeklyPrizeMultiplierUses').value);

    const prizeData = {};

    if (prizeType === 'tempMultiplier') {
        if (isNaN(prizeAmount) || isNaN(prizeUses) || prizeAmount <= 1 || prizeUses <= 0) {
            displayMessage("LÃ¼tfen geÃ§erli bir Ã‡arpan DeÄŸeri (1'den bÃ¼yÃ¼k) ve KullanÄ±m HakkÄ± girin.");
            return;
        }
        prizeData.type = prizeType;
        prizeData.amount = prizeAmount;
        prizeData.uses = prizeUses;
    } else {
        if (isNaN(prizeAmount) || prizeAmount <= 0) {
            displayMessage("LÃ¼tfen geÃ§erli bir Ã¶dÃ¼l miktarÄ± girin.");
            return;
        }
        prizeData.type = prizeType;
        prizeData.amount = prizeAmount;
    }
    
    const settings = {
        endDate: new Date(dateInput).getTime(),
        prize: prizeData
    };
    
    await db.ref('gameConfig/weeklyClickCatchReset').set(settings);
    
    displayMessage("HaftalÄ±k otomatik sÄ±fÄ±rlama ayarlarÄ± kaydedildi. Geri sayÄ±m baÅŸlayacak.");
    closeSoloGameSettingsModal();
}

async function stopWeeklyReset() {
    if (!isAdmin) return;

    const confirmed = await customConfirm("Mevcut haftalÄ±k geri sayÄ±mÄ± durdurmak ve ayarlarÄ± silmek istediÄŸinizden emin misiniz?");
    if (!confirmed) return;

    await db.ref('gameConfig/weeklyClickCatchReset').remove();
    displayMessage("HaftalÄ±k otomatik sÄ±fÄ±rlama iptal edildi.");
    closeSoloGameSettingsModal();
}

function listenForWeeklyCountdown() {
    const countdownContainer = document.getElementById('weeklyResetCountdownContainer');
    const countdownEl = document.getElementById('weeklyResetCountdown');
    const startSoloBtn = document.getElementById('startSoloGameBtn'); // Butonu deÄŸiÅŸkene al
    const ref = db.ref('gameConfig/weeklyClickCatchReset');

    const callback = snap => {
        if (weeklyCountdownInterval) clearInterval(weeklyCountdownInterval);

        const settings = snap.val();

        // YENÄ° KONTROL: EÄŸer ayarlar yoksa, oyun butonunu devre dÄ±ÅŸÄ± bÄ±rak
        if (!settings || !settings.endDate) {
            countdownContainer.classList.add('hidden');
            if (startSoloBtn && !isAdmin) {
                startSoloBtn.disabled = true;
                startSoloBtn.title = "YÃ¶neticinin yeni haftayÄ± baÅŸlatmasÄ± bekleniyor.";
            }
            return;
        }

        // Ayarlar varsa, butonu aktif et
        if (startSoloBtn && !isAdmin) {
            startSoloBtn.disabled = false;
            startSoloBtn.title = "";
        }

        countdownContainer.classList.remove('hidden');

        const updateTimer = () => {
            const now = getSyncedTime();
            const timeLeft = settings.endDate - now;

            if (timeLeft <= 0) {
                countdownEl.textContent = "HAFTA BÄ°TTÄ°!";
                clearInterval(weeklyCountdownInterval);
                executeWeeklyReset(); 
                return;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            countdownEl.textContent = `${days}g ${hours}s ${minutes}d ${seconds}sn`;
        };

        updateTimer();
        weeklyCountdownInterval = setInterval(updateTimer, 1000);
    };

    if (activeListeners.weeklyCountdown) {
        activeListeners.weeklyCountdown.ref.off('value', activeListeners.weeklyCountdown.callback);
    }
    activeListeners.weeklyCountdown = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// MEVCUT executeWeeklyReset FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
async function executeWeeklyReset() {
    console.log("HaftalÄ±k sÄ±fÄ±rlama iÅŸlemi tetiklendi...");
    const seasonEndDateSnap = await db.ref('gameConfig/seasonEndDate').once('value');
    if (seasonEndDateSnap.exists()) {
        const seasonEndDate = seasonEndDateSnap.val();
        if (seasonEndDate - getSyncedTime() < 5 * 60 * 1000) {
            console.log("AylÄ±k sezon sÄ±fÄ±rlamasÄ± yakÄ±n. HaftalÄ±k sÄ±fÄ±rlama atlandÄ±.");
            await db.ref('gameConfig/weeklyClickCatchReset').remove();
            return;
        }
    }
    const weeklyScoresSnap = await db.ref('clickCatchWeeklyScores').once('value');
    if (!weeklyScoresSnap.exists()) {
        console.log("SÄ±ralama boÅŸ, sÄ±fÄ±rlama iÅŸlemi iptal edildi.");
        await db.ref('gameConfig/weeklyClickCatchReset').remove();
        return;
    }
    const scores = [];
    weeklyScoresSnap.forEach(child => {
        scores.push({ username: child.key, score: child.val() });
    });
    scores.sort((a, b) => b.score - a.score);
    const winner = scores[0];
    const participants = scores.map(s => s.username);
    const settingsSnap = await db.ref('gameConfig/weeklyClickCatchReset').once('value');
    const settings = settingsSnap.val();
    if (!settings || !settings.prize) {
        console.error("Ã–dÃ¼l ayarlarÄ± bulunamadÄ±, sÄ±fÄ±rlama iptal edildi.");
        return;
    }
    const prize = settings.prize;
    
    let prizeAwardedText = '';
    if (prize.type === 'tempMultiplier') {
        prizeAwardedText = `${prize.amount}x Ã‡arpan (${prize.uses} kullanÄ±m)`;
    } else {
        const prizeName = typeToName[prize.type] || prize.type;
        prizeAwardedText = `${prize.amount} ${prizeName}`;
    }

    logActivity('weeklyChampion', 'WeizendTv', {
        winner: winner.username,
        score: winner.score,
        prize: prizeAwardedText
    });

    await db.ref('gameStats/weeklyClickCatchWinner').set({
        winnerName: winner.username,
        winningScore: winner.score,
        prizeAwarded: prizeAwardedText,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    const allUsersSnap = await db.ref('users').once('value');
    const allUsers = allUsersSnap.val();
    const updates = {};
    for (const username in allUsers) {
        if (!allUsers[username].approved) continue;
        const userPath = `/users/${username}`;
        
        if (allUsers[username].clickCatchHighestScore) {
            updates[`${userPath}/clickCatchHighestScore`] = 0;
        }
        updates[`${userPath}/clickCatchTickets`] = 0;

        if (participants.includes(username)) {
            updates[`${userPath}/clickCatchTickets`] = 1;
        }
        
        if (username === winner.username) {
            if (prize.type.endsWith('_potion')) {
                const statKeyMap = { health_potion: 'hp', damage_potion: 'damage', defense_potion: 'defense', crit_potion: 'critChance', crit_damage_potion: 'critDamage', dodge_potion: 'dodgeChance', pierce_potion: 'pierceChance' };
                const statKey = statKeyMap[prize.type];
                if (statKey) {
                    const currentBuff = allUsers[username]?.globalPotionBuffs?.[statKey] || 0;
                    updates[`${userPath}/globalPotionBuffs/${statKey}`] = currentBuff + prize.amount;
                }
            } else if (prize.type === 'points') {
                updates[`${userPath}/balance`] = (allUsers[username].balance || 0) + prize.amount;
                updates[`${userPath}/kariyerPuani`] = (allUsers[username].kariyerPuani || 0) + prize.amount;
            } else if (prize.type === 'tempMultiplier') {
                updates[`${userPath}/activeMultiplier`] = prize.amount;
                updates[`${userPath}/multiplierRemainingUses`] = prize.uses;
                updates[`${userPath}/multiplierSource`] = 'store'; 
            } else {
                const prizeKey = prize.type === 'iflasShield' ? 'iflasShieldUses' : prize.type;
                updates[`${userPath}/${prizeKey}`] = (allUsers[username][prizeKey] || 0) + prize.amount;
            }

            // â˜…â˜…â˜… YENÄ° BAÅARIM EKLEME KODU â˜…â˜…â˜…
            const tyChampionships = allUsers[username].tyChampionships || [];
            tyChampionships.push({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                score: winner.score
            });
            updates[`${userPath}/tyChampionships`] = tyChampionships;
            // â˜…â˜…â˜… BAÅARIM KODU SONU â˜…â˜…â˜…
        }
    }
    updates['/clickCatchWeeklyScores'] = null;
    updates['/gameConfig/weeklyClickCatchReset'] = null;
    await db.ref().update(updates);
    const notificationMessage = `TÄ±kla-Yakala haftasÄ±nÄ±n ÅŸampiyonu ${winner.username} oldu! Yeni hafta baÅŸladÄ± ve tÃ¼m katÄ±lÄ±mcÄ±lara +1 bilet hediye edildi!`;
    db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
    console.log("HaftalÄ±k sÄ±fÄ±rlama baÅŸarÄ±yla tamamlandÄ±.");
}
      
  async function afterLogin() {
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("gameDiv").style.display = "block";
    
    document.getElementById("currentUser").textContent = currentUser;
    document.getElementById("role").textContent = isAdmin ? "(Admin)" : "";
    document.getElementById("inventoryButton").style.display = isAdmin ? 'none' : 'inline-block';

    if (isAdmin) {
      document.getElementById('adminPanelToggleButton').classList.remove('hidden');
      document.getElementById('boxSettingsButton').classList.remove('hidden');
      document.getElementById('currentUserAvatar').src = 'https://i.hizliresim.com/mtwdr1x.png?_gl=1*1vzhmma*_ga*MTA2NTkzNzE4OC4xNzQ3MTQ1Mzk0*_ga_M9ZRXYS2YN*czE3NTUxNzY3MTckbzEwJGcxJHQxNzU1MTc3NTAwJGozNyRsMCRoMA..';
    } else {
      document.getElementById('adminPanelToggleButton').classList.add('hidden');
      document.getElementById('boxSettingsButton').classList.add('hidden');
      
      const userSnap = await db.ref('users/' + currentUser).once('value');
      const userData = userSnap.val();
      const avatarUrl = userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;
      document.getElementById('currentUserAvatar').src = avatarUrl;
    }

    showSection('game');
    await loadWheelSettingsFromDB();
    renderWheel();
    
    loadBalanceAndBoxRights();
    loadUserRankingsAndBoxCounts();
    loadLeaderboardRanking();
    loadBoxes();
    loadTotalOpenedBoxesCount();
    loadAnnouncements();
    loadClickCatchRankings();
    listenForGameChanges();
    listenForSurpriseBox();
    listenForDailyRewardChanges();
    initActivityFeed();
    listenForGlobalNotifications();
    listenForLobbyChanges();
    listenForWeeklyWinner(); 
    listenForSeasonCountdown();
    listenForWeeklyCountdown();
    listenForPersistentAnnouncement();
    listenForLastSurpriseFinderPanel();
    listenForLastWheelSurprisePanel();
    listenForForceUpdateSignal();
    listenForTradeNotifications();
    checkLoginStreakIndicator();
    listenForPendingActions();
    listenForMonsterBattleData();
    listenForAvatarBaseStats();
    listenForPersistentNotifications(); // â˜…â˜…â˜… BU SATIRI EKLE â˜…â˜…â˜…
    db.ref('gameConfig/potionCaps').on('value', snap => { potionCapsCache = snap.val() || {}; });
    
    if (!isAdmin) {
        listenForAdminNotifications();
        listenForNewAnnouncements(); 
        listenForNewStoreItems(); 
        checkAvailableDailyRewards();

        const userRef = db.ref('users/' + currentUser);
        userRef.once('value').then(snap => {
            const userData = snap.val();
            if (userData && userData.hasReceivedWelcomeGift === false) {
                welcomeGiftModal.style.display = 'flex';
                userRef.update({
                    kutuHakki: (userData.kutuHakki || 0) + 3,
                    hasReceivedWelcomeGift: true
                });
            }
        });
    }
}

  function switchStoreTab(tab) {
    const gameStoreContainer = document.getElementById('gameStoreItemsContainer');
    const specialStoreContainer = document.getElementById('specialStoreItemsContainer');
    const gameTabBtn = document.getElementById('gameStoreTabBtn');
    const specialTabBtn = document.getElementById('specialStoreTabBtn');

    if (tab === 'game') {
        gameStoreContainer.classList.remove('hidden');
        specialStoreContainer.classList.add('hidden');
        gameTabBtn.classList.add('border-red-500', 'text-white');
        gameTabBtn.classList.remove('border-transparent', 'text-gray-400');
        specialTabBtn.classList.add('border-transparent', 'text-gray-400');
        specialTabBtn.classList.remove('border-red-500', 'text-white');
    } else { // special
        gameStoreContainer.classList.add('hidden');
        specialStoreContainer.classList.remove('hidden');
        specialTabBtn.classList.add('border-red-500', 'text-white');
        specialTabBtn.classList.remove('border-transparent', 'text-gray-400');
        gameTabBtn.classList.add('border-transparent', 'text-gray-400');
        gameTabBtn.classList.remove('border-red-500', 'text-white');
    }
  }

// MEVCUT showSection FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR
function showSection(sectionId) {
    // YENÄ° EKLENEN KISIM: EÄŸer kullanÄ±cÄ± maÄŸaza dÄ±ÅŸÄ± bir sekmeye tÄ±klarsa, filtreyi temizle.
    if (sectionId !== 'store') {
        storeFilter = null;
    }
    // YENÄ° EKLENEN KISIM SONU

    if (currentActiveSection === 'cardCollection' && sectionId !== 'cardCollection') {
        newlyAcquiredCards.clear();
    }

    const contentIds = ['gameContent', 'storeSection', 'announcementsContent', 'chanceWheelContent', 'clickCatchContent', 'cardCollectionContent', 'monsterBattleContent'];
    const tabButtonIds = ['gameTabBtn', 'storeTabBtn', 'announcementsTabBtn', 'chanceWheelTabBtn', 'clickCatchTabBtn', 'cardCollectionTabBtn', 'monsterBattleTabBtn'];

    contentIds.forEach(id => document.getElementById(id)?.classList.add('hidden'));
    tabButtonIds.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.classList.remove('bg-red-700', 'hover:bg-red-600');
            btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
        }
    });

    hideAllAdminControls();

    const contentToShow = document.getElementById(`${sectionId}Content`) || document.getElementById(`${sectionId}Section`);
    if(contentToShow) contentToShow.classList.remove('hidden');

    const activeBtn = document.getElementById(`${sectionId}TabBtn`);
    if (activeBtn) {
        activeBtn.classList.add('bg-red-700', 'hover:bg-red-600');
        activeBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
    }

    if (sectionId === 'game' && isAdmin) {
        document.getElementById('boxSettingsButton').classList.remove('hidden');
    }

    if (sectionId === 'store') {
        loadStoreItems();
        if (isAdmin) {
            document.getElementById('adminStoreManagementButtonContainer').classList.remove('hidden');
            document.getElementById('kasaSettingsBtn').classList.remove('hidden');
        } else {
            document.getElementById('storeIndicator').classList.add('hidden');
            db.ref(`users/${currentUser}/lastSeenStoreTimestamp`).set(latestStoreItemTimestamp);
        }
        // EÄŸer filtre aktif deÄŸilse, varsayÄ±lan olarak oyun maÄŸazasÄ±nÄ± aÃ§.
        if (!storeFilter) {
            switchStoreTab('game');
        }
    } else if (sectionId === 'announcements') {
        loadAnnouncements();
        if (isAdmin) {
            document.getElementById('adminAnnouncementControls').classList.remove('hidden');
        } else {
            document.getElementById('announcementIndicator').classList.add('hidden');
            db.ref(`users/${currentUser}/lastSeenAnnouncementTimestamp`).set(latestAnnouncementTimestamp);
        }
    } else if (sectionId === 'clickCatch') {
        loadClickCatchRankings();
        listenForLastGameSummary();
        if (isAdmin) {
            document.getElementById('clickCatchAdminButtonsContainer').classList.remove('hidden');
            loadSoloGameSettings();
        }
    } else if (sectionId === 'chanceWheel') {
        loadWheelHistory();
        const wheelSettingsBtn = document.getElementById('wheelSettingsButton');
        if (isAdmin) {
            wheelSettingsBtn.classList.remove('hidden');
        } else {
            wheelSettingsBtn.classList.add('hidden');
        }
    } else if (sectionId === 'cardCollection') {
        loadCollectionAlbum();
        loadGrandPrizeDisplay();
        loadCollectionLeaderboard();
        if (isAdmin) {
            document.getElementById('collectionAdminBtn').classList.remove('hidden');
            loadMarketSettingsForAdmin();
            loadPrizeSettingsForAdmin();
        }
    } else if (sectionId === 'monsterBattle') {
        renderMonsterBattleUI();
        if (isAdmin) {
            document.getElementById('monsterBattleAdminToggles')?.classList.remove('hidden');
        }
    }
    
    currentActiveSection = sectionId;
}
  
  // Admin panel
  function openAdminPanelModal() { 
    document.body.classList.add('modal-open'); // BU SATIRI EKLE
    adminPanelModal.style.display = 'flex'; 
    loadPendingUsers(); 
    loadAllUsers(); 
    loadPendingSpecialPurchases();
  }
  function closeAdminPanelModal() { 
    document.body.classList.remove('modal-open'); // BU SATIRI EKLE
    adminPanelModal.style.display = 'none'; 
  }
    
// YENÄ° FONKSÄ°YON: Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±ÄŸÄ±nda tÃ¼m global deÄŸiÅŸkenleri ve Ã¶nbellekleri sÄ±fÄ±rlar.
// â˜…â˜…â˜… YENÄ° FONKSÄ°YON: Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±ÄŸÄ±nda tÃ¼m global deÄŸiÅŸkenleri ve Ã¶nbellekleri sÄ±fÄ±rlar. â˜…â˜…â˜…
function resetGlobalState() {
    // Aktif zamanlayÄ±cÄ±larÄ± temizle
    if (countdownInterval) clearInterval(countdownInterval);
    if (globalCountdownInterval) clearInterval(globalCountdownInterval);
    if (spectatorCountdownInterval) clearInterval(spectatorCountdownInterval);
    if (storeCountdownInterval) clearInterval(storeCountdownInterval);
    if (clickCatchTimerInterval) clearInterval(clickCatchTimerInterval);
    if (clickCatchItemInterval) clearInterval(clickCatchItemInterval);
    if (seasonCountdownInterval) clearInterval(seasonCountdownInterval);
    if (weeklyCountdownInterval) clearInterval(weeklyCountdownInterval);
    Object.values(activeDailyRewardTimers).forEach(clearInterval);
    Object.values(activeStreakTimers).forEach(clearInterval);
    
    // KullanÄ±cÄ±ya Ã¶zel verileri ve Ã¶nbellekleri sÄ±fÄ±rla
    currentUser = null;
    isAdmin = false;
    allUsersCache = [];
    boxes = [];
    isGameLocked = false;
    latestAnnouncementTimestamp = 0;
    latestStoreItemTimestamp = 0;
    newlyAcquiredCards = new Set();
    packsToReveal = [];
    packsRevealedCount = 0;
    clickCatchScore = 0;
    clickCatchLeader = null;
    
    // UI elementlerini (arayÃ¼zdeki yazÄ±larÄ±) varsayÄ±lan durumuna dÃ¶ndÃ¼r
    document.getElementById("balance").textContent = "";
    document.getElementById("currentUserBadges").innerHTML = "";
    document.getElementById("allUserRankings").innerHTML = "YÃ¼kleniyor...";
    document.getElementById("badgedUsersRanking").innerHTML = "YÃ¼kleniyor...";
    document.getElementById("clickCatchRankings").innerHTML = "YÃ¼kleniyor...";
    document.getElementById("boxContainer").innerHTML = "";
    // MAÄAZA PUANLARI DA BURADA SIFIRLANIYOR
    document.getElementById('storeCurrentUserBalance').textContent = '0';
    document.getElementById('storeCurrentUserSpent').textContent = '0';
    document.getElementById('storeCurrentUserKasaBalance').textContent = '0';
}
      
// â˜…â˜…â˜… MEVCUT logout FONKSÄ°YONUNU SÄ°L VE BU GÃœNCEL VERSÄ°YONU YAPIÅTIR â˜…â˜…â˜…
async function logout() {
    const confirmed = await customConfirm("Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?");
    if (!confirmed) return;

    localStorage.removeItem('weizendOyunUser');

    // 1. Ã–NCE tÃ¼m dinleyicileri kapat
    detachAllListeners();
    
    // 2. SONRA tÃ¼m geÃ§ici verileri ve deÄŸiÅŸkenleri temizle
    resetGlobalState();
    
    // 3. TÃ¼m admin kontrollerini gizle
    hideAllAdminControls();
    document.getElementById('adminPanelToggleButton')?.classList.add('hidden');

    // 4. UI'Ä± (arayÃ¼zÃ¼) gÃ¼ncelle
    document.getElementById("gameDiv").style.display = "none";
    document.getElementById("loginContainer").style.display = "block";
    
    const activityFeedPanel = document.getElementById('activityFeedPanel');
    if (activityFeedPanel) {
        activityFeedPanel.classList.add('hidden', 'translate-x-full');
    }
    const activityBellContainer = document.getElementById('activityBellContainer');
    if (activityBellContainer) {
        activityBellContainer.classList.add('hidden');
    }

    // 5. En son Firebase oturumunu kapat
    auth.signOut().catch((error) => {
        console.error("Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken hata oluÅŸtu: ", error);
        displayMessage("Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken bir hata oluÅŸtu.");
    });
}

// --- BU GÃœNCEL FONKSÄ°YONU ESKÄ°SÄ°NÄ°N YERÄ°NE YAPIÅTIRIN ---
function loadBalanceAndBoxRights() {
    if (isAdmin) {
        document.getElementById("balance").textContent = "Admin Paneli Aktif";
        document.getElementById("currentUser").innerHTML = `${currentUser}`;
        return;
    }
    const ref = db.ref('users/' + currentUser);
    const allUsersRef = db.ref('users');

    const callback = async snap => {
        const userData = snap.val();
        if (!userData) return;

        if (userData.blocked && userData.blockedUntil && Date.now() < userData.blockedUntil) {
            displayBlockedMessage(userData.blockedUntil, currentUser);
        } else if (userData.blocked) {
            db.ref('users/' + currentUser).update({ blocked: false, blockedUntil: null });
        }

        let statusText = `ğŸ’° Mevcut PuanÄ±: ${userData.balance || 0} | ğŸ“¦ Kutu HakkÄ±: ${userData.kutuHakki || 0}`;
        if ((userData.carkBileti || 0) > 0) statusText += ` | ï¸ğŸ« Ã‡ark Bileti: ${userData.carkBileti}`;
        if ((userData.clickCatchTickets || 0) > 0) statusText += ` | ğŸŸ T-Y Bileti: ${userData.clickCatchTickets}`;
        if (userData.iflasShieldUses > 0) statusText += ` | ğŸ›¡ï¸ Kalkan: ${userData.iflasShieldUses}`;
        if (userData.multiplierSource === 'store' && userData.multiplierRemainingUses > 0) statusText += ` | âœ–ï¸ Ã‡arpan: ${userData.activeMultiplier}x (${userData.multiplierRemainingUses} kullanÄ±m)`;
        else if (userData.multiplierSource === 'box') statusText += ` | âœ–ï¸ Ã‡arpan: ${userData.activeMultiplier}x (Otomatik)`;

        document.getElementById("balance").textContent = statusText;
        document.getElementById('storeCurrentUserBalance').textContent = userData.balance || 0;
        document.getElementById('storeCurrentUserSpent').textContent = userData.totalSpentPoints || 0;
        document.getElementById('storeCurrentUserKasaBalance').textContent = userData.kasaPuani || 0;
        document.getElementById('wheelTicketBalance').textContent = userData.carkBileti || 0;

        if (currentActiveSection === 'cardCollection') {
            loadCollectionAlbum();
        }
        if (currentActiveSection === 'monsterBattle') {
            renderMonsterBattleUI();
        }

        const allUsersSnap = await allUsersRef.once('value');
        const leaders = await calculateAllLeaders(allUsersSnap.val());
        const userLeaderStatus = {
            isCurrentLeader: currentUser === leaders.currentBalanceUser,
            isHighLeader: currentUser === leaders.highEverBalanceUser,
            isSurpriseLeader: currentUser === leaders.surpriseBoxUser,
            isBombLeader: currentUser === leaders.bombUser,
            isStoreLeader: currentUser === leaders.spentPointsUser,
            isMultiplierLeader: currentUser === leaders.multiplierUser,
            isBoxLeader: currentUser === leaders.boxUser,
            isShieldLeader: currentUser === leaders.shieldUser,
            isClickCatchLeader: currentUser === leaders.clickCatchLeaderUser,
            isWheelSpinLeader: currentUser === leaders.wheelSpinUser
        };
        const badgesHtml = getInlineBadgesHtmlFromStatus(userLeaderStatus);
        document.getElementById("currentUserBadges").innerHTML = badgesHtml;
        document.getElementById("currentUser").innerHTML = `${currentUser}`;
    };
    
    if(activeListeners.balance) activeListeners.balance.ref.off('value', activeListeners.balance.callback);
    activeListeners.balance = { ref, event: 'value', callback };
    ref.on('value', callback);
}
      
// --- YENÄ° EKLENECEK SÄ°HÄ°RLÄ° ROZET FONKSÄ°YONU ---
function getInlineBadgesHtmlFromStatus(userLeaderStatus) {
    if (!userLeaderStatus) return '';

    const hasKingCrown = userLeaderStatus.isCurrentLeader && userLeaderStatus.isHighLeader && userLeaderStatus.isSurpriseLeader &&
                         userLeaderStatus.isBombLeader && userLeaderStatus.isStoreLeader && userLeaderStatus.isMultiplierLeader &&
                         userLeaderStatus.isBoxLeader && userLeaderStatus.isShieldLeader && userLeaderStatus.isClickCatchLeader && userLeaderStatus.isWheelSpinLeader;

    if (hasKingCrown) {
        return `<span class="inline-badge" title="TÃ¼m Liderlik Rozetlerinin Sahibi!">ğŸ‘‘</span>`;
    }

    const badges = [];
    if (userLeaderStatus.isCurrentLeader) badges.push(`<span class="inline-badge" title="Mevcut Puan Lideri">ğŸ¥‡</span>`);
    if (userLeaderStatus.isHighLeader) badges.push(`<span class="inline-badge" title="UlaÅŸÄ±lan En YÃ¼ksek Puan Lideri">ğŸ†</span>`);
    if (userLeaderStatus.isClickCatchLeader) badges.push(`<span class="inline-badge" title="TÄ±kla-Yakala Lideri">ğŸ¯</span>`);
    if (userLeaderStatus.isWheelSpinLeader) badges.push(`<span class="inline-badge" title="Ã‡ark Lideri">ğŸ¡</span>`);
    if (userLeaderStatus.isBoxLeader) badges.push(`<span class="inline-badge" title="Kutu Lideri">ğŸ“¦</span>`);
    if (userLeaderStatus.isSurpriseLeader) badges.push(`<span class="inline-badge" title="SÃ¼rpriz Kutu Lideri">ğŸ‰</span>`);
    if (userLeaderStatus.isBombLeader) badges.push(`<span class="inline-badge" title="Bomba Lideri">ğŸ’£</span>`);
    if (userLeaderStatus.isMultiplierLeader) badges.push(`<span class="inline-badge" title="Ã‡arpan Lideri">âœ–ï¸</span>`);
    if (userLeaderStatus.isStoreLeader) badges.push(`<span class="inline-badge" title="AlÄ±ÅŸveriÅŸ Lideri">ğŸ›’</span>`);
    if (userLeaderStatus.isShieldLeader) badges.push(`<span class="inline-badge" title="Kalkan Lideri">ğŸ›¡ï¸</span>`);
    
    return badges.join(''); // Rozetleri yanyana birleÅŸtirip dÃ¶ndÃ¼r
}
// --- YENÄ° FONKSÄ°YON BÄ°TÄ°Å ---
  
 function getUserBadgesHtml(u, leaders, forPublicProfile = false) {
    const hasKingCrown = leaders.isCurrentLeader && leaders.isHighLeader && leaders.isSurpriseLeader &&
                         leaders.isBombLeader && leaders.isStoreLeader && leaders.isMultiplierLeader &&
                         leaders.isBoxLeader && leaders.isShieldLeader && leaders.isClickCatchLeader && leaders.isWheelSpinLeader;

    if (forPublicProfile) {
        if (hasKingCrown) {
            return {
                crown: `<span class="text-3xl" title="TÃ¼m Liderlik Rozetlerinin Sahibi!">ğŸ‘‘</span>`,
                others: ''
            };
        }

        const allBadges = [];
        if (leaders.isCurrentLeader) allBadges.push(`<span class="text-2xl" title="Mevcut Puan Lideri">ğŸ¥‡</span>`);
        if (leaders.isHighLeader) allBadges.push(`<span class="text-2xl" title="UlaÅŸÄ±lan En YÃ¼ksek Puan Lideri">ğŸ†</span>`);
        if (leaders.isClickCatchLeader) allBadges.push(`<span class="text-2xl" title="TÄ±kla-Yakala Lideri">ğŸ¯</span>`);
        if (leaders.isWheelSpinLeader) allBadges.push(`<span class="text-2xl" title="Ã‡ark Lideri">ğŸ¡</span>`);
        if (leaders.isBoxLeader) allBadges.push(`<span class="text-2xl" title="Kutu Lideri">ğŸ“¦</span>`);
        if (leaders.isSurpriseLeader) allBadges.push(`<span class="text-2xl" title="SÃ¼rpriz Kutu Lideri">ğŸ‰</span>`);
        if (leaders.isBombLeader) allBadges.push(`<span class="text-2xl" title="Bomba Lideri">ğŸ’£</span>`);
        if (leaders.isMultiplierLeader) allBadges.push(`<span class="text-2xl" title="Ã‡arpan Lideri">âœ–ï¸</span>`);
        if (leaders.isStoreLeader) allBadges.push(`<span class="text-2xl" title="AlÄ±ÅŸveriÅŸ Lideri">ğŸ›’</span>`);
        if (leaders.isShieldLeader) allBadges.push(`<span class="text-2xl" title="Kalkan Lideri">ğŸ›¡ï¸</span>`);
        if (!leaders.isSurpriseLeader && (u.surpriseBoxesOpened || 0) > 0) {
            allBadges.push(`<span class="text-2xl" title="SÃ¼rpriz Kutu Rozeti">ğŸ</span>`);
        }
        
        return {
            crown: '',
            others: allBadges.join('')
        };
    }

    const rankingBadges = [];
    if (leaders.isCurrentLeader) rankingBadges.push(`<span class="text-xl" title="Mevcut Puan Lideri">ğŸ¥‡</span>`);
    if (leaders.isHighLeader) rankingBadges.push(`<span class="text-xl" title="UlaÅŸÄ±lan En YÃ¼ksek Puan Lideri">ğŸ†</span>`);
    if (leaders.isClickCatchLeader) rankingBadges.push(`<span class="text-xl" title="TÄ±kla-Yakala Lideri">ğŸ¯</span>`);
    if (leaders.isWheelSpinLeader) rankingBadges.push(`<span class="text-xl" title="Ã‡ark Lideri">ğŸ¡</span>`);
    if (leaders.isBoxLeader) rankingBadges.push(`<span class="text-xl" title="Kutu Lideri">ğŸ“¦</span>`);
    if (leaders.isSurpriseLeader) rankingBadges.push(`<span class="text-xl" title="SÃ¼rpriz Kutu Lideri">ğŸ‰</span>`);
    if (leaders.isBombLeader) rankingBadges.push(`<span class="text-xl" title="Bomba Lideri">ğŸ’£</span>`);
    if (leaders.isMultiplierLeader) rankingBadges.push(`<span class="text-xl" title="Ã‡arpan Lideri">âœ–ï¸</span>`);
    if (leaders.isStoreLeader) rankingBadges.push(`<span class="text-xl" title="AlÄ±ÅŸveriÅŸ Lideri">ğŸ›’</span>`);
    if (leaders.isShieldLeader) rankingBadges.push(`<span class="text-xl" title="Kalkan Lideri">ğŸ›¡ï¸</span>`);
    if (!leaders.isSurpriseLeader && (u.surpriseBoxesOpened || 0) > 0) {
        rankingBadges.push(`<span class="text-xl" title="SÃ¼rpriz Kutu Rozeti">ğŸ</span>`);
    }

    const crownHtml = hasKingCrown ? `<div class="flex justify-center w-full mb-1"><span class="text-3xl" title="TÃ¼m Liderlik Rozetlerinin Sahibi!">ğŸ‘‘</span></div>` : '';
    const otherBadgesHtml = `<div class="flex items-center justify-center gap-1 h-6">${rankingBadges.join('')}</div>`;

    return crownHtml + otherBadgesHtml;
}

  // === ESKÄ° loadUserRankingsAndBoxCounts FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR ===

function loadUserRankingsAndBoxCounts() {
    const ref = db.ref('users');

    // Ã–nceki dinleyiciyi temizle
    if (activeListeners.userRankings && activeListeners.userRankings.ref) {
        activeListeners.userRankings.ref.off();
    }
    
    // Dinleyiciyi kaydet
    activeListeners.userRankings = { ref: ref };
    
    // Sadece ilk yÃ¼klemede tÃ¼m veriyi Ã§ek
    ref.once('value', initialSnap => {
        allUsersCache = []; // Ã–nbelleÄŸi temizle
        const usersData = initialSnap.val();
        if (usersData) {
            allUsersCache = Object.entries(usersData)
                .filter(([username, userData]) => username.toLowerCase() !== 'weizendtv' && userData.approved)
                .map(([username, userData]) => ({ username, ...userData }));
        }
        renderUserRankings(); // Ä°lk sÄ±ralamayÄ± Ã§iz
    });

    // Yeni eklenen kullanÄ±cÄ±larÄ± dinle
    ref.on('child_added', snap => {
        const username = snap.key;
        const userData = snap.val();
        if (username.toLowerCase() !== 'weizendtv' && userData.approved) {
            // EÄŸer Ã¶nbellekte zaten varsa ekleme (ilk yÃ¼klemede gelebilir), yoksa ekle
            if (!allUsersCache.some(u => u.username === username)) {
                allUsersCache.push({ username, ...userData });
                renderUserRankings();
            }
        }
    });

    // DeÄŸiÅŸen kullanÄ±cÄ±larÄ± dinle
    ref.on('child_changed', snap => {
        const username = snap.key;
        const userData = snap.val();
        const userIndex = allUsersCache.findIndex(u => u.username === username);
        if (userIndex > -1) {
            // KullanÄ±cÄ±yÄ± Ã¶nbellekte gÃ¼ncelle
            allUsersCache[userIndex] = { username, ...userData };
            renderUserRankings(); // SÄ±ralamayÄ± yeniden Ã§iz
        }
    });

    // Silinen kullanÄ±cÄ±larÄ± dinle
    ref.on('child_removed', snap => {
        const username = snap.key;
        const userIndex = allUsersCache.findIndex(u => u.username === username);
        if (userIndex > -1) {
            // KullanÄ±cÄ±yÄ± Ã¶nbellekten sil
            allUsersCache.splice(userIndex, 1);
            renderUserRankings(); // SÄ±ralamayÄ± yeniden Ã§iz
        }
    });
}

// MEVCUT calculateAllLeaders fonksiyonunu bununla deÄŸiÅŸtir
async function calculateAllLeaders(allUsersData) {
    const currentClickCatchLeader = await getClickCatchLeaderUsername();
    let leaders = {
        highestCurrentBalance: -1, currentBalanceUser: null,
        highestEverBalance: -1, highEverBalanceUser: null, // Bu alan artÄ±k Kariyer PuanÄ± liderini tutuyor
        maxSurpriseBoxes: -1, surpriseBoxUser: null,
        maxBombCount: -1, bombUser: null,
        maxSpentPoints: -1, spentPointsUser: null,
        maxMultiplierFound: -1, multiplierUser: null,
        maxBoxesOpened: -1, boxUser: null,
        maxShieldUsed: -1, shieldUser: null,
        maxWheelSpins: -1, wheelSpinUser: null,
    };

    for (const username in allUsersData) {
        if (username.toLowerCase() === 'weizendtv' || !allUsersData[username].approved) continue;
        const userData = allUsersData[username];
        
        const userBalance = userData.balance || 0;
        if (userBalance > 0 && userBalance > leaders.highestCurrentBalance) {
            leaders.highestCurrentBalance = userBalance;
            leaders.currentBalanceUser = username;
        }

        // --- DÃœZELTME BURADA ---
        // ArtÄ±k sÄ±ralama iÃ§in 'highestBalanceEver' yerine doÄŸrudan 'kariyerPuani'nÄ± kullanÄ±yoruz.
        const userHighestBalance = userData.kariyerPuani || 0; 
        if (userHighestBalance > 0 && userHighestBalance > leaders.highestEverBalance) {
            leaders.highestEverBalance = userHighestBalance;
            leaders.highEverBalanceUser = username; // Kariyer PuanÄ± Lideri bu deÄŸiÅŸkende saklanÄ±r.
        }

        const userSurpriseBoxes = userData.surpriseBoxesOpened || 0;
        if (userSurpriseBoxes > 0 && userSurpriseBoxes > leaders.maxSurpriseBoxes) {
            leaders.maxSurpriseBoxes = userSurpriseBoxes;
            leaders.surpriseBoxUser = username;
        }

        const userBombCount = userData.iflasCount || 0;
        if (userBombCount > 0 && userBombCount > leaders.maxBombCount) {
            leaders.maxBombCount = userBombCount;
            leaders.bombUser = username;
        }

        const userSpentPoints = userData.totalSpentPoints || 0;
        if (userSpentPoints > 0 && userSpentPoints > leaders.maxSpentPoints) {
            leaders.maxSpentPoints = userSpentPoints;
            leaders.spentPointsUser = username;
        }

        const userMultiplierFound = userData.multiplierFoundCount || 0;
        if (userMultiplierFound > 0 && userMultiplierFound > leaders.maxMultiplierFound) {
            leaders.maxMultiplierFound = userMultiplierFound;
            leaders.multiplierUser = username;
        }

        const userBoxesOpened = userData.boxesOpenedCount || 0;
        if (userBoxesOpened > 0 && userBoxesOpened > leaders.maxBoxesOpened) {
            leaders.maxBoxesOpened = userBoxesOpened;
            leaders.boxUser = username;
        }

        const userShieldUsed = userData.iflasShieldUsedCount || 0;
        if (userShieldUsed > 0 && userShieldUsed > leaders.maxShieldUsed) {
            leaders.maxShieldUsed = userShieldUsed;
            leaders.shieldUser = username;
        }
        
        const userWheelSpins = userData.wheelSpinsCount || 0;
        if (userWheelSpins > 0 && userWheelSpins > leaders.maxWheelSpins) {
            leaders.maxWheelSpins = userWheelSpins;
            leaders.wheelSpinUser = username;
        }
    }
    
    leaders.clickCatchLeaderUser = currentClickCatchLeader;
    
    return leaders;
}

  async function renderUserRankings() {
    const searchTerm = document.getElementById('searchUserRanking').value.trim().toLowerCase();
    
    let filteredUsers = allUsersCache;
    if (searchTerm) {
        filteredUsers = allUsersCache.filter(u => u.username.toLowerCase().includes(searchTerm));
    }

    const allUsersSnap = await db.ref('users').once('value');
    const allUsersData = allUsersSnap.val() || {};
    
    const leaders = await calculateAllLeaders(allUsersData);

    // SIRALAMA Kriteri: 'kariyerPuani' oldu.
    filteredUsers.sort((a, b) => (b.kariyerPuani || 0) - (a.kariyerPuani || 0));

    let html = filteredUsers.map((u, i) => {
        const userLeaderStatus = {
            isCurrentLeader: u.username === leaders.currentBalanceUser,
            isHighLeader: u.username === leaders.highEverBalanceUser,
            isSurpriseLeader: u.username === leaders.surpriseBoxUser,
            isBombLeader: u.username === leaders.bombUser,
            isStoreLeader: u.username === leaders.spentPointsUser,
            isMultiplierLeader: u.username === leaders.multiplierUser,
            isBoxLeader: u.username === leaders.boxUser,
            isShieldLeader: u.username === leaders.shieldUser,
            isClickCatchLeader: u.username === leaders.clickCatchLeaderUser,
            isWheelSpinLeader: u.username === leaders.wheelSpinUser
        };

        const userIcons = getUserBadgesHtml(u, userLeaderStatus);
        const avatarUrl = u.selectedAvatar ? u.selectedAvatar.url : defaultAvatarUrl;
        
        let blockedInfo = '';
        const isBlocked = u.blocked && u.blockedUntil && Date.now() < u.blockedUntil;
        if (isBlocked) {
            blockedInfo = `<div class="text-red-400 font-bold mt-2">Engelli - Kalan SÃ¼re: <span id="countdown-${u.username}">--:--</span></div>`;
        }

        const scoreToShow = u.kariyerPuani || 0;

        return `<div class="relative mb-3 p-3 bg-gray-800 rounded-xl border border-gray-700 cursor-pointer hover:bg-gray-700/70 transition-colors" onclick="openPublicUserDetailModal('${u.username}')">
            <div class="flex items-center w-full gap-3">
                <span class="font-bold text-xl text-gray-400 w-8 text-center flex-shrink-0">${i + 1}.</span>
                <img src="${avatarUrl}" class="w-14 h-14 rounded-full object-cover flex-shrink-0 border-2 border-gray-600" onclick="event.stopPropagation(); openAvatarStatsModal('${u.username}')">
                
                <div class="flex flex-col min-w-0 flex-grow">
                    <div class="h-6 min-h-[24px] flex items-center">${userIcons}</div>
                    <p class="font-bold text-lg text-white truncate" title="${u.username}">${u.username}</p>
                    <p class="text-sm font-semibold text-yellow-400/80">${scoreToShow} (Kariyer Puan)</p>
                </div>
            </div>
            ${blockedInfo ? `<div class="text-center mt-2">${blockedInfo}</div>` : ''}
        </div>`;

    }).join("");

    document.getElementById("allUserRankings").innerHTML = html || "<div class='text-center text-gray-400'>Aramayla eÅŸleÅŸen kullanÄ±cÄ± bulunamadÄ±.</div>";
    document.getElementById("totalUsers").textContent = allUsersCache.length;
}

async function loadLeaderboardRanking() {
    const ref = db.ref('users');

    if (activeListeners.leaderboard && activeListeners.leaderboard.ref) {
        activeListeners.leaderboard.ref.off();
    }

    activeListeners.leaderboard = { ref: ref };

    const renderLeaders = async (snap) => {
        const usersData = snap.val() || {};

        if (Object.keys(usersData).length === 0) {
            document.getElementById("badgedUsersRanking").innerHTML = "<div class='text-center text-gray-400'>HenÃ¼z lider kullanÄ±cÄ± yok.</div>";
            return;
        }

        const leaders = await calculateAllLeaders(usersData);
        
        const leaderUsernames = new Set([
            leaders.currentBalanceUser, leaders.highEverBalanceUser, leaders.surpriseBoxUser,
            leaders.bombUser, leaders.spentPointsUser, leaders.multiplierUser,
            leaders.boxUser, leaders.shieldUser, leaders.clickCatchLeaderUser, leaders.wheelSpinUser
        ]);
        leaderUsernames.delete(null);
        
        const allUsersAsArray = Object.entries(usersData).map(([username, data]) => ({ username, ...data }));
        const leaderUsers = allUsersAsArray.filter(u => leaderUsernames.has(u.username));

        leaderUsers.sort((a, b) => {
            const getBadgeCount = (user) => {
                let count = 0;
                if (user.username === leaders.currentBalanceUser) count++;
                if (user.username === leaders.highEverBalanceUser) count++;
                if (user.username === leaders.surpriseBoxUser) count++;
                if (user.username === leaders.bombUser) count++;
                if (user.username === leaders.spentPointsUser) count++;
                if (user.username === leaders.multiplierUser) count++;
                if (user.username === leaders.boxUser) count++;
                if (user.username === leaders.shieldUser) count++;
                if (user.username === leaders.clickCatchLeaderUser) count++;
                if (user.username === leaders.wheelSpinUser) count++;
                return count;
            };

            const aBadgeCount = getBadgeCount(a);
            const bBadgeCount = getBadgeCount(b);
            
            if (bBadgeCount !== aBadgeCount) return bBadgeCount - aBadgeCount;
            return (b.balance || 0) - (a.balance || 0);
        });

        const html = leaderUsers.map((u, i) => {
            const userLeaderStatus = {
                isCurrentLeader: u.username === leaders.currentBalanceUser,
                isHighLeader: u.username === leaders.highEverBalanceUser,
                isSurpriseLeader: u.username === leaders.surpriseBoxUser,
                isBombLeader: u.username === leaders.bombUser,
                isStoreLeader: u.username === leaders.spentPointsUser,
                isMultiplierLeader: u.username === leaders.multiplierUser,
                isBoxLeader: u.username === leaders.boxUser,
                isShieldLeader: u.username === leaders.shieldUser,
                isClickCatchLeader: u.username === leaders.clickCatchLeaderUser,
                isWheelSpinLeader: u.username === leaders.wheelSpinUser
            };
            const badgesHtml = getUserBadgesHtml(u, userLeaderStatus);
            const avatarUrl = u.selectedAvatar ? u.selectedAvatar.url : defaultAvatarUrl;

            return `<div class="mb-3 p-3 bg-gray-800 rounded-md border border-gray-700 cursor-pointer hover:bg-gray-700" onclick="openPublicUserDetailModal('${u.username}')">
                <div class="text-center">${badgesHtml}</div>
                <div class="flex items-center justify-start mt-1">
                    <span class="font-semibold text-lg text-yellow-300 mr-3 w-8 text-left">${i + 1}.</span>
                    <img src="${avatarUrl}" class="w-12 h-12 rounded-md mr-3 object-contain" onclick="event.stopPropagation(); openAvatarStatsModal('${u.username}')">
                    <span class="font-semibold text-lg">${u.username}</span>
                </div>
            </div>`;
        }).join("");

        document.getElementById("badgedUsersRanking").innerHTML = html || "<div class='text-center text-gray-400'>HenÃ¼z lider kullanÄ±cÄ± yok.</div>";
    };

    ref.on('value', renderLeaders);
}
  
  function loadPendingUsers() {
    const ref = db.ref('users');
    const callback = snap => {
      const data = snap.val();
      let html = "";
      if (data) {
          for (const u in data) {
            if (data[u].approved === false) {
              html += `<div class="flex justify-between items-center p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-red-500">
                <span class="text-gray-200">${u}</span>
                <div class="flex space-x-2">
                <button onclick="approveUser('${u}')" class="py-1 px-3 bg-green-600 hover:bg-green-500 text-white text-sm font-bold rounded-md">Onayla</button>
                <button onclick="denyUser('${u}', true)" class="py-1 px-3 bg-red-600 hover:bg-red-500 text-white text-sm font-bold rounded-md">Sil</button></div></div>`;
            }
          }
      }
      document.getElementById("pendingUsers").innerHTML = html || "<div class='text-center text-gray-400'>Onay bekleyen kullanÄ±cÄ± yok.</div>";
    };
    activeListeners.pendingUsers = { ref, event: 'value', callback };
    ref.on('value', callback);
  }

  function loadAllUsers() {
    const ref = db.ref('users');
    const callback = snap => {
      const data = snap.val();
      let html = "";
      if (data) {
          for (const u in data) {
            if (u.toLowerCase() === "weizendtv") continue;
            const user = data[u];
            let blockedStatusHtml = '';
            const isCurrentlyBlocked = user.blocked && user.blockedUntil && Date.now() < user.blockedUntil;
            if (isCurrentlyBlocked) {
                blockedStatusHtml = `<span class="text-red-400">(Engelli - <span id="admin-countdown-${u}">--:--</span>)</span>`;
                if (!activeBlockedUserTimers[u]) {
                    const timerId = setInterval(() => {
                        const timeLeft = user.blockedUntil - Date.now();
                        const el = document.getElementById(`admin-countdown-${u}`);
                        if (timeLeft <= 0) {
                            clearInterval(timerId);
                            if(el) el.parentElement.innerHTML = '<span class="text-green-400">(Engel KalktÄ±)</span>';
                        } else {
                            const minutes = Math.floor(timeLeft / 60000);
                            const seconds = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, '0');
                            if(el) el.textContent = `${minutes}:${seconds}`;
                        }
                    }, 1000);
                    activeBlockedUserTimers[u] = timerId;
                }
            } else if (user.blocked) {
                blockedStatusHtml = `<span class="text-green-400">(Engel SÃ¼resi Doldu)</span>`;
            }

            const avatarUrl = user.selectedAvatar ? user.selectedAvatar.url : defaultAvatarUrl;
            // --- DEÄÄ°ÅÄ°KLÄ°K BURADA: onclick event'ine "event" parametresi eklendi ---
            html += `<div class="flex items-center justify-between p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-blue-500 cursor-pointer hover:bg-gray-600 transition-colors" onclick="openUserManagementModal(event, '${u}')">
                        <div class="flex items-center">
                            <img src="${avatarUrl}" class="w-12 h-12 rounded-md mr-3 object-contain">
                            <span class="text-gray-200">${u} ${blockedStatusHtml}</span>
                        </div>
                        <span class="text-yellow-300">Puan: ${user.balance || 0}</span>
                    </div>`;
            // --------------------------------------------------------------------
          }
      }
      document.getElementById("allUsers").innerHTML = html || "<div class='text-center text-gray-400'>KullanÄ±cÄ± yok.</div>";
    };
    activeListeners.allUsers = { ref, event: 'value', callback };
    ref.on('value', callback);
}
  
  function displayMessage(message) { document.getElementById('generalMessageContent').innerHTML = message; generalMessageModal.style.display = 'flex'; }
  function closeGeneralMessageModal() { generalMessageModal.style.display = 'none'; }
  // --- YENÄ° KOD (BUNU YAPIÅTIR) ---
function customConfirm(message, callback) {
    return new Promise(resolve => {
        const confirmBox = document.createElement('div');
        confirmBox.className = 'fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999]';
        confirmBox.innerHTML = `
          <div class="bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
            <p class="text-lg text-gray-300 mb-6">${message}</p>
            <div class="flex gap-4 justify-center">
              <button id="confirmYes" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Evet</button>
              <button id="confirmNo" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">HayÄ±r</button>
            </div>
          </div>
        `;
        document.body.appendChild(confirmBox);
        
        // DÃœZELTME BURADA: Butonlara "event" parametresi ekleyip preventDefault Ã§aÄŸÄ±rÄ±yoruz.
        document.getElementById('confirmYes').onclick = (event) => { 
            event.preventDefault(); 
            confirmBox.remove(); 
            resolve(true); 
        };
        document.getElementById('confirmNo').onclick = (event) => { 
            event.preventDefault(); 
            confirmBox.remove(); 
            resolve(false); 
        };
    });
}

  // BU 3 YARDIMCI FONKSÄ°YONU KODUNUZDA BULUNAN ESKÄ° VERSÄ°YONLARIYLA DEÄÄ°ÅTÄ°RÄ°N

function notifyUser(username, message) {
      if (!username || !message) return;
      // KullanÄ±cÄ±nÄ±n 'notifications' yoluna yeni bir bildirim ekliyoruz.
      // push() ile benzersiz bir ID oluÅŸturulur.
      const notifRef = db.ref(`users/${username}/notifications`).push();
      notifRef.set({
          message: message,
          timestamp: firebase.database.ServerValue.TIMESTAMP
      });
}

// MEVCUT listenForAdminNotifications FONKSÄ°YONUNU SÄ°L VE BU YENÄ° VERSÄ°YONU YAPIÅTIR

function listenForAdminNotifications() {
      // Sadece o anki kullanÄ±cÄ±yÄ± dinler.
      const ref = db.ref(`users/${currentUser}/notifications`);
      
      const callback = snap => {
          const notification = snap.val();
          // Yeni bir bildirim geldiÄŸinde...
          if (notification && notification.message) {
              // HATA BURADAYDI: Pop-up gÃ¶steren 'displayMessage' yerine mavi bandÄ± gÃ¶steren 'displayGlobalNotification' kullanÄ±lacak.
              displayGlobalNotification(notification.message);
              // ...gÃ¶sterdikten sonra veritabanÄ±ndan sil ki tekrar gÃ¶rÃ¼nmesin.
              snap.ref.remove();
          }
      };
      
      // Dinleyiciyi tekrar tekrar eklememek iÃ§in kontrol
      if (activeListeners.adminNotifications) {
        activeListeners.adminNotifications.ref.off('child_added', activeListeners.adminNotifications.callback);
      }
      activeListeners.adminNotifications = { 
          ref: ref.orderByChild('timestamp').startAt(sessionStartTime), 
          event: 'child_added', 
          callback 
      };
      // 'child_added' ile sadece YENÄ° eklenen bildirimleri yakalarÄ±z.
      ref.orderByChild('timestamp').startAt(sessionStartTime).on('child_added', callback);
}
      
// MEVCUT listenForPendingActions FONKSÄ°YONUNU SÄ°L VE BU YENÄ° VERSÄ°YONU YAPIÅTIR

// MEVCUT listenForPendingActions FONKSÄ°YONUNU SÄ°L VE BU YENÄ° VERSÄ°YONU YAPIÅTÄ°R

async function listenForPendingActions() {
    if (isAdmin) return;

    const ref = db.ref(`users/${currentUser}/pendingActions/cardPacks`);
    
    // Fonksiyonu 'async' olarak gÃ¼ncelledik Ã§Ã¼nkÃ¼ artÄ±k iÃ§inde 'await' kullanacaÄŸÄ±z.
    const callback = async (snapshot) => {
        const action = snapshot.val(); 
        
        if (action && action.type && action.count > 0) {
            // Ã–NEMLÄ°: GÃ¶revi, tekrar tetiklenmemesi iÃ§in en baÅŸta kuyruktan siliyoruz.
            await snapshot.ref.remove();

            // KullanÄ±cÄ±ya gÃ¶sterilecek mesajÄ± oluÅŸturuyoruz.
            const packName = typeToName[action.type] || 'Kart Paketi';
            const message = `YÃ¶netici size <b>${action.count} adet ${packName}</b> hediye etti. Paketi aÃ§mak iÃ§in tamama tÄ±klayÄ±n.`;
            
            // Yeni customAlert fonksiyonumuzu Ã§aÄŸÄ±rÄ±yoruz ve kullanÄ±cÄ±nÄ±n "Tamam" butonuna basmasÄ±nÄ± BEKLÄ°YORUZ.
            await customAlert(message);

            // KullanÄ±cÄ± butona bastÄ±ktan SONRA paket aÃ§ma ekranÄ±nÄ± tetikliyoruz.
            startCardPackOpening(action.count, 'Admin Hediyesi', 1, action.type);
        }
    };

    if (activeListeners.pendingActions) {
        activeListeners.pendingActions.ref.off('child_added', activeListeners.pendingActions.callback);
    }
    activeListeners.pendingActions = { ref, event: 'child_added', callback };
    ref.on('child_added', callback);
}
      
// --- YENÄ° BÄ°LET YÃ–NETÄ°M FONKSÄ°YONLARI BÄ°TÄ°Å ---
  // Admin iÅŸlemleri
  function openBlockDurationModal(username) { targetUserForBlock = username; document.getElementById('blockUserName').textContent = username; blockDurationModal.style.display = 'flex'; }
  function closeBlockDurationModal() { blockDurationModal.style.display = 'none'; document.getElementById('blockDuration').value = ''; targetUserForBlock = null; if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement); }
  function confirmBlockUser() { const duration = parseInt(document.getElementById('blockDuration').value); if (isNaN(duration) || duration <= 0) { displayMessage("GeÃ§erli sÃ¼re girin."); return; } const blockedUntil = Date.now() + duration * 60 * 1000; db.ref('users/' + targetUserForBlock).update({ blocked: true, blockedUntil: blockedUntil }).then(() => { displayMessage(`${targetUserForBlock} ${duration} dakika engellendi.`); closeBlockDurationModal(); }); }
  async function toggleBlockUser(user, currentStatus, blockedUntil) { 
    const isCurrentlyBlocked = currentStatus && blockedUntil && Date.now() < blockedUntil;
    if (isCurrentlyBlocked) { 
      const confirmed = await customConfirm(user + " engelini kaldÄ±rmak istiyor musunuz?"); 
      if(confirmed) db.ref('users/' + user).update({ blocked: false, blockedUntil: null }).then(() => { displayMessage(user + " engeli kaldÄ±rÄ±ldÄ±."); if(selectedUserForManagement) openUserManagementModal(user); }); 
    } else { 
      openBlockDurationModal(user); 
    } 
  }
  async function approveUser(user) { const confirmed = await customConfirm(user + " kullanÄ±cÄ±sÄ±nÄ± onaylamak istiyor musunuz?"); if(confirmed) { db.ref('users/' + user).update({ approved: true, approvalNotified: false }); displayMessage(`${user} onaylandÄ±.`); } }
  async function denyUser(user, fromPending = false, fromManagementModal = false) {
    const confirmed = await customConfirm(`<b>${user}</b> kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinize emin misiniz? Bu iÅŸlem, kullanÄ±cÄ±ya ait tÃ¼m puan, bilet, skor ve istatistikleri kalÄ±cÄ± olarak silecektir!`);
    if (confirmed) {
        // Silinecek tÃ¼m verilerin yollarÄ±nÄ± bir obje iÃ§inde topluyoruz.
        const updates = {};

        // 1. Ana kullanÄ±cÄ± verisini silmek iÃ§in hazÄ±rlÄ±yoruz.
        updates[`users/${user}`] = null;

        // 2. HaftalÄ±k "TÄ±kla-Yakala" skor tablosundaki kaydÄ±nÄ± siliyoruz.
        // Rozetlerin geri gelmesinin ana sebebi bu kaydÄ±n kalmasÄ±ydÄ±.
        updates[`clickCatchWeeklyScores/${user}`] = null;
        
        // (Gelecekte baÅŸka tablolar eklenirse, buraya o tablolardaki silme yolu da eklenebilir)

        // TÃ¼m silme iÅŸlemlerini tek seferde ve gÃ¼venli bir ÅŸekilde yapÄ±yoruz.
        await db.ref().update(updates);

        displayMessage(`${user} kullanÄ±cÄ±sÄ± ve iliÅŸkili tÃ¼m verileri baÅŸarÄ±yla silindi.`);
        
        // EÄŸer liderlik tablosundaki lider silindiyse, lider deÄŸiÅŸkenini sÄ±fÄ±rla
        if (clickCatchLeader === user) {
            clickCatchLeader = null;
        }

        if (fromManagementModal) {
            closeUserManagementModal();
        }
    }
}

      // =====================================================================
// YENÄ° EÅYA GÃ–NDERME SÄ°STEMÄ° (TEKLÄ° VE TOPLU)
// =====================================================================

let targetUserForSend = null;

// Tekli EÅŸya GÃ¶nderme ModalÄ±nÄ± AÃ§ar
function openAdminSendItemModal(username) {
    targetUserForSend = username;
    document.getElementById('sendItemUserName').textContent = username;
    document.getElementById('sendItemType').value = '';
    document.getElementById('sendItemFieldsContainer').innerHTML = '';
    document.getElementById('adminSendItemModal').style.display = 'flex';
}

// Tekli EÅŸya GÃ¶nderme ModalÄ±nÄ± KapatÄ±r
function closeAdminSendItemModal() {
    document.getElementById('adminSendItemModal').style.display = 'none';
    targetUserForSend = null;
    if (selectedUserForManagement) openUserManagementModal(event, selectedUserForManagement);
}

// Tekli EÅŸya GÃ¶nderme formunda tip seÃ§imine gÃ¶re inputlarÄ± deÄŸiÅŸtirir
function handleSendItemTypeChange(selectElement) {
    const type = selectElement.value;
    const container = document.getElementById('sendItemFieldsContainer');
    container.innerHTML = ''; // Ã–nceki alanlarÄ± temizle

    if (type === 'tempMultiplier') {
        container.innerHTML = `
            <input type="number" id="sendItemValue" class="box-setting-input" placeholder="Ã‡arpan DeÄŸeri (Ã¶rn: 2, 3)">
            <input type="number" id="sendItemUses" class="box-setting-input" placeholder="KullanÄ±m HakkÄ±">
        `;
    } else if (type === 'avatar') {
        container.innerHTML = `
            <input type="text" id="sendItemAvatarName" class="box-setting-input" placeholder="AvatarÄ±n AdÄ±">
            <input type="text" id="sendItemAvatarImageUrl" class="box-setting-input" placeholder="Avatar Resim URL">
        `;
    } else if (type) { // DiÄŸer tÃ¼m tipler iÃ§in sadece miktar yeterli
        container.innerHTML = `<input type="number" id="sendItemValue" class="box-setting-input" placeholder="Miktar / Adet">`;
    }
}
      
// Toplu EÅŸya GÃ¶nderme formunda tip seÃ§imine gÃ¶re inputlarÄ± deÄŸiÅŸtirir
function handleBulkSendItemTypeChange(selectElement) {
    const type = selectElement.value;
    const container = document.getElementById('bulkSendItemFieldsContainer');
    container.innerHTML = ''; 

    if (type === 'tempMultiplier') {
        container.innerHTML = `
            <input type="number" id="bulkSendItemValue" class="box-setting-input" placeholder="Ã‡arpan DeÄŸeri (Ã¶rn: 2, 3)">
            <input type="number" id="bulkSendItemUses" class="box-setting-input" placeholder="KullanÄ±m HakkÄ±">
        `;
    } else if (type) {
        container.innerHTML = `<input type="number" id="bulkSendItemValue" class="box-setting-input" placeholder="Miktar / Adet">`;
    }
}

// MEVCUT confirmSendItem FONKSÄ°YONUNU SÄ°L VE YERÄ°NE BUNU YAPIÅTIR

async function confirmSendItem(isAdding = true) {
    if (!isAdmin || !targetUserForSend) return;

    const type = document.getElementById('sendItemType').value;
    if (!type) {
        displayMessage("LÃ¼tfen bir eÅŸya tipi seÃ§in.");
        return;
    }

    let value, uses, avatarName, avatarImageUrl;
    const actionText = isAdding ? "gÃ¶nderilecek" : "silinecek";
    const actionVerb = isAdding ? "ekledi" : "Ã§Ä±kardÄ±";

    try {
        if (type === 'tempMultiplier') {
            value = parseInt(document.getElementById('sendItemValue').value);
            uses = parseInt(document.getElementById('sendItemUses').value);
            if (isNaN(value) || isNaN(uses) || value <= 1 || uses <= 0) throw new Error("LÃ¼tfen geÃ§erli bir Ã‡arpan DeÄŸeri (>1) ve KullanÄ±m HakkÄ± (>0) girin.");
        } else if (type === 'avatar') {
            avatarName = document.getElementById('sendItemAvatarName').value.trim();
            avatarImageUrl = document.getElementById('sendItemAvatarImageUrl').value.trim();
            if (!avatarName || !avatarImageUrl) throw new Error("LÃ¼tfen Avatar AdÄ± ve Resim URL'si girin.");
        } else if (type) {
            value = parseInt(document.getElementById('sendItemValue').value);
            if (isNaN(value) || value <= 0) throw new Error("LÃ¼tfen geÃ§erli bir Miktar/Adet girin.");
        }
    } catch (error) {
        displayMessage(error.message);
        return;
    }
    
    const confirmed = await customConfirm(`${targetUserForSend} kullanÄ±cÄ±sÄ±na seÃ§ilen eÅŸya ${actionText}. OnaylÄ±yor musunuz?`);
    if(!confirmed) return;

    const userRef = db.ref(`users/${targetUserForSend}`);
    let successMessage = '';
    let notificationMessage = '';

    try {
        if (type === 'health_regen_potion') {
            if (!isAdding) throw new Error("Can Yenileme Ä°ksirleri sadece gÃ¶nderilebilir, silinemez.");
            const potionRef = userRef.child(`inventory/health_regen_potion/${value}`);
            await potionRef.transaction(currentValue => (currentValue || 0) + 1);
            successMessage = `${targetUserForSend} kullanÄ±cÄ±sÄ±na %${value} Can Yenileme Ä°ksiri baÅŸarÄ±yla gÃ¶nderildi.`;
            notificationMessage = `YÃ¶netici envanterine %${value} Can Yenileme Ä°ksiri ekledi.`;
        }
        // --- DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR: Dirilme taÅŸÄ± iÃ§in Ã¶zel ve hatasÄ±z bir blok eklendi ---
        else if (type === 'revival_stone') {
            const stoneRef = userRef.child('inventory/revival_stone');
            const op = isAdding ? 1 : -1;
            await stoneRef.transaction(currentValue => Math.max(0, (currentValue || 0) + (value * op)));
            successMessage = `${targetUserForSend} kullanÄ±cÄ±sÄ±nÄ±n Dirilme TaÅŸÄ± envanteri baÅŸarÄ±yla gÃ¼ncellendi.`;
            notificationMessage = `YÃ¶netici envanterin${isAdding ? 'e' : 'den'} ${value} adet ${typeToName[type]} ${actionVerb}.`;
        }
        // --- DEÄÄ°ÅÄ°KLÄ°K SONU ---
        else if (type.endsWith('_potion')) {
            const statKeyMap = { 
                'health_potion': { key: 'hp', name: 'Can' }, 
                'damage_potion': { key: 'damage', name: 'Hasar' }, 
                'defense_potion': { key: 'defense', name: 'Savunma' }, 
                'crit_potion': { key: 'critChance', name: 'Kritik VuruÅŸ ÅansÄ±' },
                'dodge_potion': { key: 'dodgeChance', name: 'SÄ±yrÄ±lma ÅansÄ±' },
                'crit_damage_potion': { key: 'critDamage', name: 'Kritik Hasar' },
                'pierce_potion': { key: 'pierceChance', name: 'Delici VuruÅŸ ÅansÄ±' }
            };
            const statInfo = statKeyMap[type];
            if (!statInfo) throw new Error("GeÃ§ersiz iksir tipi.");

            const statRef = userRef.child(`globalPotionBuffs/${statInfo.key}`);
            const op = isAdding ? 1 : -1;
            await statRef.transaction(currentValue => Math.max(0, (currentValue || 0) + (value * op)));
            
            successMessage = `${targetUserForSend} kullanÄ±cÄ±sÄ±nÄ±n genel '${statInfo.name}' bonusu baÅŸarÄ±yla gÃ¼ncellendi.`;
            notificationMessage = `YÃ¶netici, genel bonuslarÄ±na iÅŸlem yaptÄ± ve ${value} iksir etkisi ${actionVerb}.`;
        
        } 
        else if (type.startsWith('card_pack')) {
            if (!isAdding) throw new Error("Kart paketleri sadece gÃ¶nderilebilir, silinemez.");
            await db.ref(`users/${targetUserForSend}/pendingActions/cardPacks`).push({ type: type, count: value });
            successMessage = `${targetUserForSend} kullanÄ±cÄ±sÄ±na ${value} adet ${typeToName[type]} gÃ¶nderildi ve aÃ§masÄ± iÃ§in bildirim iletildi.`;
            notificationMessage = null; 
        
        } else if (type === 'avatar') {
            if (!isAdding) throw new Error("Avatarlar sadece gÃ¶nderilebilir, silinemez.");
            const newAvatarId = db.ref().push().key;
            await userRef.child('avatars').child(newAvatarId).set({ id: newAvatarId, name: avatarName, imageUrl: avatarImageUrl });
            successMessage = `${targetUserForSend} kullanÄ±cÄ±sÄ±na '${avatarName}' avatarÄ± baÅŸarÄ±yla eklendi.`;
            notificationMessage = `YÃ¶netici sana '${avatarName}' avatarÄ±nÄ± hediye etti! Envanterinden seÃ§ebilirsin.`;
        
        } else {
            await userRef.transaction(userData => {
                if (userData) {
                    const op = isAdding ? 1 : -1;
                    const keyMap = {
                        points: 'balance', kasaPuani: 'kasaPuani', boxRights: 'kutuHakki',
                        wheelTicket: 'carkBileti', clickCatchTicket: 'clickCatchTickets',
                        iflasShield: 'iflasShieldUses', wildcard: 'wildcards'
                    };
                    const dbKey = keyMap[type];

                    if (type === 'points') {
                        userData.balance = (userData.balance || 0) + (value * op);
                        if (isAdding) userData.kariyerPuani = (userData.kariyerPuani || 0) + value;
                        notificationMessage = `YÃ¶netici hesabÄ±n${isAdding ? 'a' : 'dan'} ${value} Puan ${actionVerb}.`;
                    } else if (dbKey) {
                        userData[dbKey] = Math.max(0, (userData[dbKey] || 0) + (value * op));
                        notificationMessage = `YÃ¶netici envanterin${isAdding ? 'e' : 'den'} ${value} adet ${typeToName[type]} ${actionVerb}.`;
                    } else if (type === 'tempMultiplier') {
                         if (isAdding) {
                            userData.activeMultiplier = value;
                            userData.multiplierRemainingUses = uses;
                            userData.multiplierSource = 'store';
                            notificationMessage = `YÃ¶netici sana ${uses} adet ${value}x Ã‡arpan hediye etti.`;
                        } else {
                            userData.activeMultiplier = 1;
                            userData.multiplierRemainingUses = 0;
                            userData.multiplierSource = 'none';
                            notificationMessage = `YÃ¶netici aktif Ã§arpanÄ±nÄ± sildi.`;
                        }
                    }
                }
                return userData;
            });
            successMessage = `${targetUserForSend} kullanÄ±cÄ±sÄ±nÄ±n envanteri baÅŸarÄ±yla gÃ¼ncellendi.`;
        }

        if (notificationMessage) {
            notifyUser(targetUserForSend, notificationMessage);
        }
        displayMessage(successMessage);
        closeAdminSendItemModal();

    } catch (error) {
        console.error("EÅŸya gÃ¶nderme hatasÄ±:", error);
        displayMessage("Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu: " + error.message);
    }
}

// ESKÄ° confirmBulkSendItem FONKSÄ°YONUNU SÄ°L VE YERÄ°NE BUNU YAPIÅTIR
async function confirmBulkSendItem(isAdding = true) {
    if (!isAdmin) return;

    const type = document.getElementById('bulkSendItemType').value;
    if (!type) {
        displayMessage("LÃ¼tfen bir eÅŸya tipi seÃ§in.");
        return;
    }
    
    const value = parseInt(document.getElementById('bulkSendItemValue').value);
    const usesInput = document.getElementById('bulkSendItemUses');
    const uses = usesInput ? parseInt(usesInput.value) : 0;

    if (isNaN(value) || value <= 0) {
        displayMessage("LÃ¼tfen geÃ§erli bir Miktar/Adet girin.");
        return;
    }
    if (type === 'tempMultiplier' && (isNaN(uses) || uses <= 0)) {
        displayMessage("LÃ¼tfen geÃ§erli bir KullanÄ±m HakkÄ± girin.");
        return;
    }

    const itemText = (type === 'tempMultiplier') 
        ? `${uses} adet ${value}x Ã‡arpan`
        : `${value} ${typeToName[type]}`;
    
    const actionText = isAdding ? "eklenecek" : "silinecek";
    const targetText = isAdding ? "TÃ¼m aktif kullanÄ±cÄ±lara" : "TÃ¼m aktif kullanÄ±cÄ±lardan";

    const confirmed = await customConfirm(`${targetText} <b>${itemText}</b> ${actionText}. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?`);
    if (!confirmed) return;

    const usersSnap = await db.ref('users').once('value');
    const allUsers = usersSnap.val();
    const updates = {};
    const op = isAdding ? 1 : -1;

    for (const username in allUsers) {
        const user = allUsers[username];
        if (user.approved && !user.blocked && username !== "weizendtv") {
            const userPath = `/users/${username}`;
            
            if (type === 'health_regen_potion') {
                 if(isAdding) {
                    const currentPotions = user.inventory?.health_regen_potion?.[value] || 0;
                    updates[`${userPath}/inventory/health_regen_potion/${value}`] = currentPotions + 1;
                 }
            }
            else if (type.endsWith('_potion')) {
                const statKeyMap = { health_potion: 'hp', damage_potion: 'damage', defense_potion: 'defense', crit_potion: 'critChance', crit_damage_potion: 'critDamage', dodge_potion: 'dodgeChance', pierce_potion: 'pierceChance' };
                const statKey = statKeyMap[type];
                if (statKey) {
                    const currentBuff = user.globalPotionBuffs?.[statKey] || 0;
                    updates[`${userPath}/globalPotionBuffs/${statKey}`] = Math.max(0, currentBuff + (value * op));
                }
            } else if (type === 'revival_stone') {
                 if (!user.inventory) user.inventory = {};
                 updates[`${userPath}/inventory/revival_stone`] = Math.max(0, (user.inventory.revival_stone || 0) + (value * op));
            } else {
                const keyMap = {
                    points: 'balance', kasaPuani: 'kasaPuani', boxRights: 'kutuHakki',
                    wheelTicket: 'carkBileti', clickCatchTicket: 'clickCatchTickets',
                    iflasShield: 'iflasShieldUses', wildcard: 'wildcards'
                };
                const dbKey = keyMap[type];
                
                if (dbKey) {
                    updates[`${userPath}/${dbKey}`] = Math.max(0, (user[dbKey] || 0) + (value * op));
                    if (type === 'points' && isAdding) {
                        updates[`${userPath}/kariyerPuani`] = (user.kariyerPuani || 0) + value;
                    }
                } 
                else if (type === 'tempMultiplier') {
                    if (isAdding) {
                        updates[`${userPath}/activeMultiplier`] = value;
                        updates[`${userPath}/multiplierRemainingUses`] = uses;
                        updates[`${userPath}/multiplierSource`] = 'store';
                    } else {
                        updates[`${userPath}/activeMultiplier`] = 1;
                        updates[`${userPath}/multiplierRemainingUses`] = 0;
                        updates[`${userPath}/multiplierSource`] = 'none';
                    }
                }
            }
            
            const individualTargetText = isAdding ? 'hesabÄ±na' : 'hesabÄ±ndan';
            const individualVerb = isAdding ? 'eklendi' : 'sildi';
            const notificationMessage = `YÃ¶netici, tÃ¼m kullanÄ±cÄ±larÄ±n ${individualTargetText} ${itemText} ${individualVerb}.`;
            const notifKey = db.ref().push().key;
            updates[`${userPath}/notifications/${notifKey}`] = { message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP };
        }
    }
    
    await db.ref().update(updates);
    
    const globalVerb = isAdding ? 'ekledi' : 'sildi';
    const globalNotificationMessage = `YÃ¶netici, tÃ¼m kullanÄ±cÄ±lara ${itemText} ${globalVerb}.`;
    
    displayGlobalNotification(globalNotificationMessage);
}
      
    // YENÄ° AVATAR SÄ°LME FONKSÄ°YONU
async function deleteUserAvatar(username, avatarId) {
    if (!isAdmin) return;

    const confirmed = await customConfirm(`<b>${username}</b> adlÄ± kullanÄ±cÄ±nÄ±n bu avatarÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?`);
    if (!confirmed) return;

    try {
        const userRef = db.ref(`users/${username}`);
        const userSnap = await userRef.once('value');
        const userData = userSnap.val();

        // Silme iÅŸlemleri iÃ§in bir gÃ¼ncelleme objesi hazÄ±rlÄ±yoruz
        const updates = {};
        updates[`/users/${username}/avatars/${avatarId}`] = null; // AvatarÄ± koleksiyondan sil

        // EÄŸer silinen avatar, kullanÄ±cÄ±nÄ±n o an seÃ§tiÄŸi avatarsa, seÃ§ili avatarÄ± da sÄ±fÄ±rla
        if (userData.selectedAvatar && userData.selectedAvatar.id === avatarId) {
            updates[`/users/${username}/selectedAvatar`] = null;
        }

        // TÃ¼m gÃ¼ncellemeleri tek seferde yap
        await db.ref().update(updates);

        displayMessage("Avatar baÅŸarÄ±yla kullanÄ±cÄ±dan silindi.");
        
        // YÃ¶netim penceresini gÃ¼ncel bilgilerle yeniden aÃ§arak anÄ±nda deÄŸiÅŸikliÄŸi gÃ¶ster
        openUserManagementModal(username);

    } catch (error) {
        console.error("Avatar silinirken hata oluÅŸtu:", error);
        displayMessage("Avatar silinirken bir hata meydana geldi.");
    }
}
  // Kutu iÅŸlemleri
  async function createBoxes() {
    // 1. VeritabanÄ±ndan Ã¶zel kutu ayarlarÄ±nÄ± Ã§ek
    const settingsRef = db.ref('gameConfig/boxContents');
    const snapshot = await settingsRef.once('value');
    
    // 2. EÄŸer veritabanÄ±nda ayar yoksa, kodun en baÅŸÄ±ndaki global BOX_CONTENTS listesini kullan.
    const currentBoxConfig = snapshot.exists() ? snapshot.val() : BOX_CONTENTS;

    // 3. Ayarlara gÃ¶re kutu iÃ§eriÄŸini oluÅŸtur
    boxes = []; 
    let allContents = []; 
    currentBoxConfig.forEach(item => { 
        for (let i = 0; i < item.count; i++) { 
            allContents.push({ type: item.type, value: item.value || 0 }); 
        } 
    }); 
    
    // 4. Kutu iÃ§eriÄŸini karÄ±ÅŸtÄ±r
    for (let i = allContents.length - 1; i > 0; i--) { 
        const j = Math.floor(Math.random() * (i + 1)); 
        [allContents[i], allContents[j]] = [allContents[j], allContents[i]]; 
    } 
    
    // 5. KarÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ iÃ§erikle yeni kutu listesini oluÅŸtur
    const TOTAL_BOXES = allContents.length;
    for (let i = 0; i < TOTAL_BOXES; i++) { 
        boxes.push({ 
            id: i + 1, 
            content: allContents[i].type, 
            value: allContents[i].value, 
            opened: false, 
            opener: '' 
        }); 
    } 
    
    // 6. Yeni kutu listesini veritabanÄ±na yaz
    db.ref('boxes').set(boxes); 
    db.ref('gameStats/boxesOpenedByUsers').remove(); 
}
  
  function loadBoxes() {
    const ref = db.ref('boxes');
    const callback = snap => {
        if (!snap.exists()) {
            createBoxes();
        } else {
            boxes = snap.val();
            renderBoxes();
        }
    };
    activeListeners.boxes = { ref, event: 'value', callback };
    ref.on('value', callback);
  }
  
  function renderBoxes() { 
    const container = document.getElementById("boxContainer"); 
    container.innerHTML = ''; 
    boxes.forEach((box, i) => { 
        let div = document.createElement('div'); 
        div.className = `box bg-gray-700 border-2 border-red-700 aspect-square flex flex-col items-center justify-center cursor-pointer font-bold text-lg rounded-lg relative transition-all duration-200 shadow-md hover:shadow-lg`;
        
        if (box.opened) {
            div.classList.add('opened', 'bg-gray-600', 'cursor-default', 'border-gray-500', 'shadow-inner');
            
            let openedContentHtml = '';

            // --- DÃœZELTÄ°LEN KISIM BAÅLANGICI ---
            // ArtÄ±k JS ile ikon eklemiyoruz, sadece CSS'in iÅŸini yapmasÄ± iÃ§in doÄŸru sÄ±nÄ±fÄ± ve gerekli div'i ekliyoruz.
            if (box.content && (box.content.startsWith('card_pack') || box.content === 'wildcard')) {
                div.classList.add(box.content);
                openedContentHtml = `<div class="box-content"></div>`; // Bu div, CSS'in ikonu gÃ¶stermesi iÃ§in gerekli
            }
            // --- DÃœZELTÄ°LEN KISIM SONU ---
            else if (box.content === 'points') { 
                openedContentHtml = `<span class="box-content text-green-400 text-xl">+${box.finalPoints || box.value}</span>`; 
                div.classList.add('bg-green-700', 'border-green-500', 'animate-pulse'); 
            } else if (box.content === 'surpriz') { 
                openedContentHtml = `<div class="box-content text-yellow-400 text-2xl">ğŸ‰</div>`;
                div.classList.add('bg-yellow-700', 'border-yellow-500', 'animate-pulse'); 
            } else if (box.content === 'iflas') { 
                openedContentHtml = `<div class="box-content text-red-400 text-2xl">ğŸ’£</div>`;
                div.classList.add('bg-red-700', 'border-red-500'); 
            } else if (box.content === 'multiplier') { 
                openedContentHtml = `<span class="box-content text-blue-400 text-xl">${box.value}X</span>`; 
                div.classList.add('bg-blue-700', 'border-blue-500', 'animate-pulse'); 
            } else if (box.content === 'wheelTicket') {
                openedContentHtml = `<div class="box-content text-pink-400 text-2xl">ğŸ«ï¸</div>`;
                div.classList.add('bg-pink-700', 'border-pink-500', 'animate-pulse'); 
            } else if (box.content === 'clickCatchTicket') {
                openedContentHtml = `<div class="box-content text-orange-400 text-2xl">ğŸŸï¸</div>`;
                div.classList.add('bg-orange-700', 'border-orange-500', 'animate-pulse');
            } else if (box.content === 'iflasShield') {
                openedContentHtml = `<div class="box-content text-cyan-400 text-2xl">ğŸ›¡ï¸</div>`;
                div.classList.add('bg-cyan-700', 'border-cyan-500', 'animate-pulse');
            }
            
            div.innerHTML = openedContentHtml;
          
            if (box.opener) {
                let openerDiv = document.createElement('div'); 
                openerDiv.className = 'opener absolute bottom-1 left-0 right-0 text-center text-xs text-gray-400 truncate px-1'; 
                openerDiv.textContent = box.opener; 
                div.appendChild(openerDiv); 
            }

            if (box.multiplierApplied && box.multiplierApplied > 1) {
                let multiplierIcon = document.createElement('div');
                multiplierIcon.className = 'absolute top-0 right-1 text-yellow-300 font-bold text-xs bg-black bg-opacity-50 px-1 rounded-bl';
                multiplierIcon.textContent = `âœ–ï¸${box.multiplierApplied}`;
                multiplierIcon.title = `Bu kutu ${box.multiplierApplied}x Ã§arpan ile aÃ§Ä±ldÄ±.`;
                div.appendChild(multiplierIcon);
            }
        } else {
            div.innerHTML = `<span class="box-content text-gray-300">${box.id}</span>`;
        }
        
        div.onclick = () => { 
            if (box.opened) { 
                showOpenedBoxInfo(box); 
            } else { 
                openBox(i); 
            } 
        }; 
        container.appendChild(div); 
    }); 
}

function showOpenedBoxInfo(box) {
    let contentDisplay = '';

    const itemNames = {
        wheelTicket: 'Åans Ã‡arkÄ± Bileti',
        clickCatchTicket: 'TÄ±kla-Yakala Bileti',
        iflasShield: 'Ä°flas KalkanÄ±',
        wildcard: 'Joker Kart',
        card_pack: 'Standart Kart Paketi',
        card_pack_normal: 'Bronz Kart Paketi',
        card_pack_gumus: 'GÃ¼mÃ¼ÅŸ Kart Paketi',
        card_pack_altin: 'AltÄ±n Kart Paketi',
        card_pack_efsanevi: 'Efsanevi Kart Paketi'
    };

    if (box.content === 'points') {
        let multiplierText = ` (Ã‡arpan kullanÄ±lmadÄ±)`;
        if (box.multiplierApplied && box.multiplierApplied > 1) {
            multiplierText = ` (${box.basePoints} Puan x ${box.multiplierApplied} Ã‡arpan)`;
        }
        contentDisplay = `<b>+${box.finalPoints} Puan</b><br><span class="text-sm text-gray-400">${multiplierText}</span>`;
    }
    else if (box.content === 'iflas') {
        contentDisplay = box.shieldUsed ? 'Ä°flas (Kalkanla Korundu)' : (box.lostPoints ? `Ä°flas (-${box.lostPoints} Puan)` : 'Ä°flas');
    }
    else if (box.content === 'multiplier') {
        contentDisplay = `<b>${box.value}X Ã‡arpan</b>`;
    }
    else if (box.content === 'surpriz') {
        contentDisplay = 'SÃ¼rpriz Kutu';
    }
    // --- KESÄ°N Ã‡Ã–ZÃœMÃœ Ä°Ã‡EREN BLOK ---
    else if (itemNames[box.content]) {
        const itemName = itemNames[box.content];
        
        // DEÄÄ°ÅÄ°KLÄ°K 1: DeÄŸeri al ve her ihtimale karÅŸÄ± temizle
        let finalValue = box.finalValue || box.value || 1;
        // Bu satÄ±r, finalValue'nin "+1" gibi bir string olmasÄ± ihtimaline karÅŸÄ±
        // onu temizleyip saf bir sayÄ±ya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve '++' hatasÄ±nÄ± engeller.
        finalValue = Math.abs(parseInt(String(finalValue).replace('+', '')));

        contentDisplay = `<b>+${finalValue} ${itemName}</b>`;

        if (box.multiplierApplied && box.multiplierApplied > 1) {
            // DEÄÄ°ÅÄ°KLÄ°K 2: AynÄ± temizleme iÅŸlemini Ã§arpan aÃ§Ä±klamasÄ± iÃ§in de yap
            let baseValue = box.baseValue || 1;
            baseValue = Math.abs(parseInt(String(baseValue).replace('+', '')));
            
            contentDisplay += `<br><span class="text-sm text-gray-400">(${baseValue} x ${box.multiplierApplied} Ã‡arpan)</span>`;
        }
    }
    // --- DÃœZELTME SONU ---

    const contentHtml = `<div class='text-center mb-4'><p class='text-gray-400'>${box.id} Nolu Kutuyu AÃ§an</p><p class='text-2xl font-bold text-green-400 py-2'>${box.opener}</p></div><hr class="border-gray-600 my-3"><p class="text-xl"><b>Ä°Ã§erik:</b> ${contentDisplay}</p>`;
    document.getElementById('openedBoxInfoContent').innerHTML = contentHtml;
    openedBoxInfoModal.style.display = 'flex';
}

function addBoxSettingRow(item = {}) {
    const container = document.getElementById('boxSettingsRowsContainer');
    const row = document.createElement('div');
    row.className = 'box-setting-row flex items-center gap-3 p-3 bg-gray-900 rounded-lg';

    const type = item.type || 'points';
    const value = item.value === 0 ? 0 : (item.value || '');
    const count = item.count || '';

    // DEÄÄ°ÅÄ°KLÄ°K: Select menÃ¼sÃ¼ne "Dirilme TaÅŸÄ±" eklendi.
    row.innerHTML = `
        <select class="setting-type flex-grow bg-gray-700 p-2 rounded-md text-white border border-gray-600" onchange="handleRowTypeChange(this)">
            <option value="points" ${type === 'points' ? 'selected' : ''}>ğŸ’° Puan</option>
            <option value="iflas" ${type === 'iflas' ? 'selected' : ''}>ğŸ’£ Ä°flas (Bomba)</option>
            <option value="surpriz" ${type === 'surpriz' ? 'selected' : ''}>ğŸ‰ SÃ¼rpriz Kutu</option>
            <option value="multiplier" ${type === 'multiplier' ? 'selected' : ''}>âœ–ï¸ Ã‡arpan</option>
            <option value="wheelTicket" ${type === 'wheelTicket' ? 'selected' : ''}>ğŸ« Ã‡ark Bileti</option>
            <option value="clickCatchTicket" ${type === 'clickCatchTicket' ? 'selected' : ''}>ğŸŸï¸ T-Y Bileti</option>
            <option value="iflasShield" ${type === 'iflasShield' ? 'selected' : ''}>ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
            <option value="wildcard" ${type === 'wildcard' ? 'selected' : ''}>ğŸƒ Joker Kart</option>
            <option value="card_pack" ${type === 'card_pack' ? 'selected' : ''}>ğŸ´ Standart Kart Paketi</option>
            <option value="card_pack_normal" ${type === 'card_pack_normal' ? 'selected' : ''}>ğŸ¥‰ Bronz Kart Paketi</option>
            <option value="card_pack_gumus" ${type === 'card_pack_gumus' ? 'selected' : ''}>ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
            <option value="card_pack_altin" ${type === 'card_pack_altin' ? 'selected' : ''}>ğŸ¥‡ AltÄ±n Kart Paketi</option>
            <option value="card_pack_efsanevi" ${type === 'card_pack_efsanevi' ? 'selected' : ''}>ğŸ† Efsanevi Kart Paketi</option>
            <option value="revival_stone" ${type === 'revival_stone' ? 'selected' : ''}>ğŸ’ Dirilme TaÅŸÄ±</option>
            <option value="health_potion" ${type === 'health_potion' ? 'selected' : ''}>ğŸ§ª Can Ä°ksiri</option>
            <option value="defense_potion" ${type === 'defense_potion' ? 'selected' : ''}>ğŸ›¡ï¸ Savunma Ä°ksiri</option>
            <option value="damage_potion" ${type === 'damage_potion' ? 'selected' : ''}>âš”ï¸ Hasar Ä°ksiri</option>
            <option value="crit_potion" ${type === 'crit_potion' ? 'selected' : ''}>ğŸ’¥ Kritik VuruÅŸ Ä°ksiri</option>
            <option value="crit_damage_potion" ${type === 'crit_damage_potion' ? 'selected' : ''}>ğŸ¯ Kritik Hasar Ä°ksiri</option>
            <option value="dodge_potion" ${type === 'dodge_potion' ? 'selected' : ''}>ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± Ä°ksiri</option>
            <option value="pierce_potion" ${type === 'pierce_potion' ? 'selected' : ''}>ğŸ“Œ Delici ÅansÄ± Ä°ksiri</option>
        </select>
        <input type="number" value="${value}" class="setting-value w-28 bg-gray-700 p-2 rounded-md text-white border border-gray-600" placeholder="DeÄŸer">
        <input type="number" value="${count}" class="setting-count w-28 bg-gray-700 p-2 rounded-md text-white border border-gray-600" placeholder="Adet" oninput="updateTotalBoxCount()">
        <button class="bg-red-700 hover:bg-red-600 text-white p-2 rounded-md" onclick="this.parentElement.remove(); updateTotalBoxCount();">Sil</button>
    `;
    
    container.appendChild(row);
    handleRowTypeChange(row.querySelector('.setting-type'));
    updateTotalBoxCount();
}
      
// 2. Kutu AyarlarÄ±'nda seÃ§ilen tÃ¼re gÃ¶re "DeÄŸer" alanÄ±nÄ± yÃ¶netir (Joker Kart VE Kart Paketi dahil)
function handleRowTypeChange(selectElement) {
    const row = selectElement.parentElement;
    const valueInput = row.querySelector('.setting-value');
    const selectedType = selectElement.value;

    const typesWithValue = ['points', 'multiplier'];
    const typesWithAutoValue = ['wheelTicket', 'clickCatchTicket', 'iflasShield', 'wildcard', 'card_pack'];

    if (typesWithValue.includes(selectedType)) {
        valueInput.disabled = false;
        valueInput.placeholder = 'DeÄŸer';
        if(selectedType === 'multiplier') valueInput.placeholder = 'DeÄŸer (2, 3 vb.)';
    } else {
        valueInput.disabled = true;
        valueInput.placeholder = 'N/A';
        if(typesWithAutoValue.includes(selectedType)){
             valueInput.value = 1;
        } else {
             valueInput.value = 0;
        }
    }
}

// --- BU GÃœNCEL FONKSÄ°YONU ESKÄ°SÄ°NÄ°N YERÄ°NE YAPIÅTIRIN ---
async function openBox(index) {
    const lastSurpriseSnap = await db.ref('gameStats/lastSurpriseInfo').once('value');
    const lastSurpriseData = lastSurpriseSnap.val();
    if (lastSurpriseData && lastSurpriseData.resettled === false) {
        const continueOpening = await customConfirm(
            'SÃ¼rpriz kutu bulundu, yine de kutu aÃ§maya devam etmek istiyor musun?<br><br><small>Oyunu sÄ±fÄ±rlamak iÃ§in ana ekrandaki "SorunlarÄ± Ã‡Ã¶z" menÃ¼sÃ¼nÃ¼ kullanabilirsin.</small>'
        );
        if (!continueOpening) {
            return;
        }
    }

    if (isGameLocked) {
        displayMessage("Kutular 1 saniye arayla aÃ§Ä±lÄ±yor. LÃ¼tfen tekrar deneyin. Sorun devam ediyorsa, 'SorunlarÄ± Ã‡Ã¶z' menÃ¼sÃ¼ne gÃ¶z atabilirsiniz.");
        return;
    }
    if (boxes[index].opened) return;
    if (isAdmin) {
        displayMessage("Adminler oyun oynamaz, sadece izler.");
        return;
    }

    const userRef = db.ref('users/' + currentUser);
    let userSnap = await userRef.once('value');
    let user = userSnap.val();

    if (!user) {
        displayMessage("KullanÄ±cÄ± verisi bulunamadÄ±.");
        return;
    }

    if ((user.kutuHakki || 0) < BOX_RIGHTS_COST_PER_BOX) {
        displayMessage("Yetersiz kutu hakkÄ±.");
        return;
    }

    const initialConfirm = await customConfirm(`<b>${boxes[index].id}</b> numaralÄ± kutuyu aÃ§mak istediÄŸinize emin misiniz?`);
    if (!initialConfirm) {
        return;
    }

    let useMultiplier = false;
    if (user.multiplierSource === 'store' && (user.multiplierRemainingUses || 0) > 0) {
        const confirmed = await customConfirm(`Mevcut <b>${user.activeMultiplier}x</b> Ã§arpanÄ±nÄ±zÄ± kullanmak ister misiniz?`);
        if (confirmed) {
            useMultiplier = true;
        }
    }

    const boxRef = db.ref('boxes/' + index);
    const transactionResult = await boxRef.transaction(currentBoxData => {
        if (currentBoxData && currentBoxData.opened) {
            return;
        }
        if (currentBoxData) {
            currentBoxData.opened = true;
            currentBoxData.opener = currentUser;
        }
        return currentBoxData;
    });

    if (!transactionResult.committed) {
        displayMessage(`SeÃ§tiÄŸiniz kutu <b>${transactionResult.snapshot.val().opener}</b> tarafÄ±ndan aÃ§Ä±ldÄ±. HaklarÄ±nÄ±z ve Ã§arpanÄ±nÄ±z kullanÄ±lmadÄ±.`);
        return;
    }

    await db.ref('gameLock').set(true);
    isGameLocked = true;

    userSnap = await userRef.once('value');
    user = userSnap.val();

    const box = boxes[index];
    const updates = {};
    let message = '';

    updates['kutuHakki'] = (user.kutuHakki || 0) - BOX_RIGHTS_COST_PER_BOX;
    updates['boxesOpenedCount'] = (user.boxesOpenedCount || 0) + 1;
    await db.ref(`gameStats/boxesOpenedByUsers/${currentUser}`).transaction(currentValue => (currentValue || 0) + 1);
    
    let finalMultiplier = 1;
    const multiplierWasActive = useMultiplier || user.multiplierSource === 'box';

    if (multiplierWasActive && box.content !== 'surpriz') {
        finalMultiplier = user.activeMultiplier;
        if (user.multiplierSource === 'box') {
            updates['activeMultiplier'] = 1;
            updates['multiplierSource'] = 'none';
        } else if (user.multiplierSource === 'store') {
            updates['multiplierRemainingUses'] = (user.multiplierRemainingUses || 0) - 1;
            if (updates['multiplierRemainingUses'] <= 0) {
                updates['activeMultiplier'] = 1;
                updates['multiplierSource'] = 'none';
                updates['activeStoreMultiplierItemId'] = null;
            }
        }
    } else if (multiplierWasActive && box.content === 'surpriz') {
        finalMultiplier = user.activeMultiplier;
    }

    const boxUpdate = {
        opened: true, opener: currentUser, id: box.id,
        content: box.content, value: box.value
    };
    if (finalMultiplier > 1) {
        boxUpdate.multiplierApplied = finalMultiplier;
    }

    if (box.content === 'surpriz') {
        updates['surpriseBoxesOpened'] = (user.surpriseBoxesOpened || 0) + 1;
        const openedInTurnSnap = await db.ref(`gameStats/boxesOpenedByUsers/${currentUser}`).once('value');
        const openedBoxesThisRound = openedInTurnSnap.val() || 1;
        const sessionRef = db.ref('surprise_box_session');
        await sessionRef.set({ active: true, user: currentUser, boxId: box.id, multiplier: finalMultiplier, cards: shuffleArray([...cardValues]), selection: null, result: null, timestamp: firebase.database.ServerValue.TIMESTAMP, boxesOpenedThisRound: openedBoxesThisRound });
        const snap = await sessionRef.once('value');
        await sessionRef.update({ expirationTimestamp: snap.val().timestamp + 60000 });
    }
    else if (box.content === 'multiplier') {
        updates['multiplierFoundCount'] = (user.multiplierFoundCount || 0) + 1;
        const foundMultiplierValue = box.value;
        const existingMultiplierValue = user.activeMultiplier || 1;
        const existingMultiplierUses = user.multiplierRemainingUses || 0;
        const existingMultiplierSource = user.multiplierSource || 'none';

        if (existingMultiplierSource === 'none') {
            updates.activeMultiplier = foundMultiplierValue;
            updates.multiplierSource = 'box';
            message = `Harika! <b>${foundMultiplierValue}x Ã‡arpan</b> buldun. Bir sonraki kutu aÃ§Ä±lÄ±ÅŸÄ±nda otomatik olarak kullanÄ±lacak!`;
            logActivity('multiplierFound', currentUser, { boxId: box.id, value: foundMultiplierValue, multiplier: finalMultiplier });
        } else if (foundMultiplierValue === existingMultiplierValue) {
            // --- HATA DÃœZELTMESÄ° BAÅLANGICI ---
            // 1. KullanÄ±m hakkÄ±nÄ± doÄŸru ÅŸekilde artÄ±r. (Ã–nceki 1 eksiltmeyi telafi edip +1 ekle)
            updates.multiplierRemainingUses = existingMultiplierUses + 1;
            // 2. BaÅŸlangÄ±Ã§ta yapÄ±lan silme iÅŸlemini geri al.
            updates.activeMultiplier = existingMultiplierValue;
            updates.multiplierSource = existingMultiplierSource;
            // --- HATA DÃœZELTMESÄ° SONU ---

            message = `SÃ¼per! Mevcut <b>${existingMultiplierValue}x</b> Ã§arpanÄ±nla aynÄ± deÄŸerde bir tane daha buldun. KullanÄ±m hakkÄ±n <b class="text-teal-300">+1</b> artarak <b>${updates.multiplierRemainingUses}</b> oldu!`;
            logActivity('multiplierStacked', currentUser, { boxId: box.id, value: foundMultiplierValue, uses: 1, multiplier: finalMultiplier });
        } else if (foundMultiplierValue > existingMultiplierValue) {
            const combinedValue = existingMultiplierValue + foundMultiplierValue;
            updates.activeMultiplier = combinedValue;
            updates.multiplierSource = 'box';
            updates.multiplierRemainingUses = 0;
            const refundedBoxRights = multiplierWasActive ? existingMultiplierUses + 1 : existingMultiplierUses;
            updates.kutuHakki += refundedBoxRights;
            
            message = `Ä°NANILMAZ! Mevcut ${existingMultiplierValue}x Ã§arpanÄ±n, bulduÄŸun ${foundMultiplierValue}x ile birleÅŸerek tek kullanÄ±mlÄ±k <b class="text-purple-400">${combinedValue}x</b> gÃ¼cÃ¼ne ulaÅŸtÄ±! Eski Ã§arpan haklarÄ±n iÃ§in <b class="text-green-400">+${refundedBoxRights} Kutu HakkÄ±</b> iade edildi!`;
            logActivity('multiplierCombined', currentUser, { boxId: box.id, foundValue: foundMultiplierValue, combinedValue: combinedValue, refundedRights: refundedBoxRights, multiplier: finalMultiplier });
        } else { // foundMultiplierValue < existingMultiplierValue
            const boxRightsFromMultiplier = foundMultiplierValue;
            updates.kutuHakki += boxRightsFromMultiplier;
            message = `Mevcut <b>${existingMultiplierValue}x</b> Ã§arpanÄ±n daha gÃ¼Ã§lÃ¼ olduÄŸu iÃ§in korundu. BulduÄŸun ${foundMultiplierValue}x Ã§arpan ise <b class="text-green-400">+${boxRightsFromMultiplier} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼!`;
            logActivity('multiplierConvertedToBoxRights', currentUser, { boxId: box.id, rewardValue: foundMultiplierValue, boxRights: boxRightsFromMultiplier, source: 'Kutudan', multiplier: finalMultiplier });
        }
    }
    else if (box.content === 'points') {
        const pointsGained = box.value * finalMultiplier;
        updates['balance'] = (user.balance || 0) + pointsGained;
        updates['kariyerPuani'] = (user.kariyerPuani || 0) + pointsGained;
        message = `+${pointsGained} puan kazandÄ±nÄ±z!`;
        boxUpdate.basePoints = box.value;
        boxUpdate.finalPoints = pointsGained;
        logActivity('openBox', currentUser, { boxId: box.id, points: pointsGained, multiplier: finalMultiplier, newBalance: updates['balance'] });
    } else if (box.content === 'iflas') {
        const shieldWasUsed = (user.iflasShieldUses || 0) > 0;
        const lostPoints = user.balance || 0;
        
        updates['iflasCount'] = (user.iflasCount || 0) + 1;

        if (shieldWasUsed) {
            updates['iflasShieldUses'] = user.iflasShieldUses - 1;
            updates['iflasShieldUsedCount'] = (user.iflasShieldUsedCount || 0) + 1;
            message = `Ä°flas! ğŸ›¡ï¸ KalkanÄ±n seni korudu!`;
            boxUpdate.shieldUsed = true;
            boxUpdate.lostPoints = 0;
            logActivity('iflas', currentUser, { shieldUsed: true, lostPoints: 0, boxId: box.id, multiplier: finalMultiplier, newBalance: user.balance });
        } else {
            updates['balance'] = 0;
            message = `Ä°flas! TÃ¼m puanlarÄ±n (-${lostPoints} puan) silindi.`;
            boxUpdate.shieldUsed = false;
            boxUpdate.lostPoints = lostPoints;
            logActivity('iflas', currentUser, { shieldUsed: false, lostPoints: lostPoints, boxId: box.id, multiplier: finalMultiplier, newBalance: 0 });
        }
    } 
    else if (box.content.endsWith('_potion')) {
        const itemsGained = (box.value || 1) * finalMultiplier;
        const statKeyMap = { health_potion: 'hp', damage_potion: 'damage', defense_potion: 'defense', crit_potion: 'critChance', crit_damage_potion: 'critDamage', dodge_potion: 'dodgeChance', pierce_potion: 'pierceChance' };
        const statKey = statKeyMap[box.content];
        
        if(statKey) {
            if (!user.globalPotionBuffs) user.globalPotionBuffs = {};
            updates[`globalPotionBuffs/${statKey}`] = (user.globalPotionBuffs[statKey] || 0) + itemsGained;
        }
        
        message = `Kutudan kalÄ±cÄ± bonus veren <b>+${itemsGained} ${typeToName[box.content]}</b> kazandÄ±n!`;
        boxUpdate.baseValue = box.value || 1;
        boxUpdate.finalValue = itemsGained;
        logActivity('newItemFound', currentUser, { itemName: `+${itemsGained} ${typeToName[box.content]}`, itemType: box.content, boxId: box.id, multiplier: finalMultiplier });
    }
    // YENÄ° EKLENEN KISIM: Dirilme taÅŸÄ± iÃ§in Ã¶zel kontrol
    else if (box.content === 'revival_stone') {
        const itemsGained = (box.value || 1) * finalMultiplier;
        if (!user.inventory) user.inventory = {};
        updates['inventory/revival_stone'] = (user.inventory?.revival_stone || 0) + itemsGained;
        
        message = `Kutudan <b>+${itemsGained} ${typeToName[box.content]}</b> kazandÄ±n!`;
        boxUpdate.baseValue = box.value || 1;
        boxUpdate.finalValue = itemsGained;
        logActivity('newItemFound', currentUser, { itemName: `+${itemsGained} ${typeToName[box.content]}`, itemType: box.content, boxId: box.id, multiplier: finalMultiplier });
    }
    else {
        const itemsGained = (box.value || 1) * finalMultiplier;
        const dbKeys = { wheelTicket: 'carkBileti', clickCatchTicket: 'clickCatchTickets', iflasShield: 'iflasShieldUses', wildcard: 'wildcards' };
        const itemName = typeToName[box.content] || 'EÅŸya';
        
        if (box.content.startsWith('card_pack')) {
            startCardPackOpening(itemsGained, `${box.id} numaralÄ± kutu`, finalMultiplier, box.content);
            message = `Tebrikler! Kutudan ${itemsGained} adet ${itemName} buldun!`;
        } else {
            updates[dbKeys[box.content]] = (user[dbKeys[box.content]] || 0) + itemsGained;
            message = `Kutudan <b>+${itemsGained} ${itemName}</b> kazandÄ±n!`;
        }
        
        boxUpdate.baseValue = box.value || 1;
        boxUpdate.finalValue = itemsGained;
        logActivity('newItemFound', currentUser, { itemName: `+${itemsGained} ${itemName}`, itemType: box.content, boxId: box.id, multiplier: finalMultiplier });
    }

    await userRef.update(updates);
    await db.ref('boxes/' + index).update(boxUpdate);

    if (box.content !== 'surpriz') {
        displayMessage(message);
    }
    
    await db.ref('gameLock').set(false);
    isGameLocked = false;
}
      
// Senaryo A: Ã‡arpanla kutu aÃ§arken yeni bir Ã§arpan bulma seÃ§eneÄŸi
function openMultiplierUpgradeChoiceModal(existing, found, boxId) {
    const modal = document.getElementById('multiplierChoiceModal');
    const infoEl = document.getElementById('multiplierChoiceInfo');
    const convertBtn = document.getElementById('choiceConvertBtn');
    const combineBtn = document.getElementById('choiceCombineBtn');

    pendingMultiplierChoice = { existing, found, boxId };

    const boxRightsFromFound = found.value;
    const convertText = `Yeni ${found.value}x Ã‡arpanÄ±, <b>+${boxRightsFromFound} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼r. <br><small>(Mevcut ${existing.value}x Ã§arpanÄ±n korunur)</small>`;
    
    const combinedValue = existing.value + found.value;
    const combineText = `Ä°ki Ã§arpanÄ± birleÅŸtirip <b>1 kullanÄ±mlÄ±k ${combinedValue}x</b> elde et. <br><small>(KullandÄ±ÄŸÄ±n 1 Kutu HakkÄ± iade edilecek!)</small>`;

    infoEl.innerHTML = `Ã‡arpanla aÃ§tÄ±ÄŸÄ±n kutudan yeni bir <b class="text-yellow-300">${found.value}x Ã‡arpan</b> daha Ã§Ä±ktÄ±! Ne yapmak istersin?`;
    convertBtn.innerHTML = convertText;
    combineBtn.innerHTML = combineText;
    
    convertBtn.onclick = () => resolveMultiplierUpgradeChoice('convert');
    combineBtn.onclick = () => resolveMultiplierUpgradeChoice('upgrade');
    
    modal.style.display = 'flex';
}

// Senaryo A'nÄ±n seÃ§im sonucunu iÅŸleyen fonksiyon
async function resolveMultiplierUpgradeChoice(choice) {
    if (!pendingMultiplierChoice) return;

    const { existing, found, boxId } = pendingMultiplierChoice;
    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const user = userSnap.val();
    const updates = {};
    let message = '';
    
    if (choice === 'convert') {
        updates.kutuHakki = (user.kutuHakki || 0) + found.value;
        message = `SeÃ§imin Ã¼zerine, yeni ${found.value}x Ã§arpan <b>+${found.value} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼ ve mevcut Ã§arpanlarÄ±n korundu!`;
        logActivity('multiplierConvertedOnUsedOpen', currentUser, { 
            boxId: boxId,
            foundValue: found.value,
            existingValue: existing.value,
            existingUses: existing.uses,
            boxRights: found.value
        });
    } else if (choice === 'upgrade') {
        const combinedValue = existing.value + found.value;
        updates.activeMultiplier = combinedValue;
        updates.multiplierSource = 'box';
        updates.multiplierRemainingUses = 0;
        updates.kutuHakki = (user.kutuHakki || 0) + 1;
        message = `Harika seÃ§im! Mevcut Ã§arpanlarÄ±n birleÅŸtirilerek <b>tek kullanÄ±mlÄ±k ${combinedValue}x</b> gÃ¼cÃ¼ne ulaÅŸtÄ± ve 1 Kutu HakkÄ±n iade edildi!`;
        logActivity('multiplierUpgradedWithRefund', currentUser, {
            boxId: boxId,
            foundValue: found.value,
            existingValue: existing.value,
            existingUses: existing.uses,
            combinedValue: combinedValue
        });
    }

    await userRef.update(updates);
    displayMessage(message);
    closeMultiplierChoiceModal();
    db.ref('gameLock').set(false);
    isGameLocked = false;
}

// Senaryo B: Normal kutu aÃ§arken yeni bir Ã§arpan bulma seÃ§eneÄŸi
function openMultiplierSwapChoiceModal(existing, found, boxId) {
    const modal = document.getElementById('multiplierChoiceModal');
    const infoEl = document.getElementById('multiplierChoiceInfo');
    const convertBtn = document.getElementById('choiceConvertBtn');
    const combineBtn = document.getElementById('choiceCombineBtn');

    pendingMultiplierChoice = { existing, found, boxId };
    
    const boxRightsFromFound = found.value;
    const convertText = `Yeni ${found.value}x Ã‡arpanÄ±, <b>+${boxRightsFromFound} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼r. <br><small>(Mevcut ${existing.value}x Ã§arpanÄ±n korunur)</small>`;
    
    const boxRightsFromExisting = existing.uses;
    const acceptNewText = `Yeni <b>tek kullanÄ±mlÄ±k ${found.value}x</b> Ã§arpanÄ± al. <br><small>(Mevcut ${existing.value}x Ã§arpanÄ±nÄ±n ${existing.uses} hakkÄ±, +${boxRightsFromExisting} Kutu HakkÄ±'na dÃ¶nÃ¼ÅŸecek)</small>`;

    infoEl.innerHTML = `Kutudan <b class="text-yellow-300">${found.value}x Ã‡arpan</b> buldun! Mevcut <b class="text-purple-300">${existing.uses} adet ${existing.value}x</b> Ã§arpanÄ±n var. Ne yapmak istersin?`;
    convertBtn.innerHTML = convertText;
    combineBtn.innerHTML = acceptNewText;
    
    convertBtn.onclick = () => resolveMultiplierSwapChoice('convert');
    combineBtn.onclick = () => resolveMultiplierSwapChoice('swap');
    
    modal.style.display = 'flex';
}

// Senaryo B'nin seÃ§im sonucunu iÅŸleyen fonksiyon
async function resolveMultiplierSwapChoice(choice) {
    if (!pendingMultiplierChoice) return;

    const { existing, found, boxId } = pendingMultiplierChoice;
    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const user = userSnap.val();
    const updates = {};
    let message = '';

    if (choice === 'convert') {
        updates.kutuHakki = (user.kutuHakki || 0) + found.value;
        message = `Mevcut Ã§arpanÄ±nÄ± korudun ve yeni Ã§Ä±kan ${found.value}x Ã§arpanÄ± <b>+${found.value} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼!`;
        logActivity('multiplierConvertedOnUnusedOpen', currentUser, {
            boxId: boxId,
            foundValue: found.value,
            existingValue: existing.value,
            existingUses: existing.uses,
            boxRights: found.value
        });
    } else if (choice === 'swap') {
        const boxRightsFromExisting = existing.uses;
        updates.kutuHakki = (user.kutuHakki || 0) + boxRightsFromExisting;
        updates.activeMultiplier = found.value;
        updates.multiplierSource = 'box';
        updates.multiplierRemainingUses = 0;
        updates.activeStoreMultiplierItemId = null; // MaÄŸaza Ã§arpanÄ± iptal olduÄŸu iÃ§in ID'sini temizle
        message = `Takas baÅŸarÄ±lÄ±! Mevcut Ã§arpan haklarÄ±n <b>+${boxRightsFromExisting} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼ ve envanterine yeni <b>tek kullanÄ±mlÄ±k ${found.value}x</b> Ã§arpan eklendi!`;
        logActivity('multiplierSwappedOnUnusedOpen', currentUser, {
            boxId: boxId,
            foundValue: found.value,
            existingValue: existing.value,
            refundedUses: existing.uses,
            boxRights: boxRightsFromExisting
        });
    }
    
    await userRef.update(updates);
    displayMessage(message);
    closeMultiplierChoiceModal();
    db.ref('gameLock').set(false);
    isGameLocked = false;
}

// --- GÃœNCELLENMÄ°Å FONKSÄ°YON ---
// Bu artÄ±k sadece seÃ§im pencerelerini kapatmak iÃ§in kullanÄ±lacak
function closeMultiplierChoiceModal() {
    document.getElementById('multiplierChoiceModal').style.display = 'none';
    pendingMultiplierChoice = null; 
}

function getActivityIcon(type, details = {}) {
    let icon = 'ğŸ””';
    let bgColor = 'bg-gray-500';

    switch (type) {
        case 'collectionCompleted':
            icon = 'ğŸƒ';
            bgColor = 'bg-purple-600';
            break;
        // â˜…â˜…â˜… YENÄ° EKLENEN KOD BAÅLANGICI â˜…â˜…â˜…
        case 'wildcardConvertedToBoxRights':
            icon = 'ğŸƒ'; // Joker kart ikonu
            bgColor = 'bg-purple-600'; // Mor arkaplan
            break;
        // â˜…â˜…â˜… YENÄ° EKLENEN KOD SONU â˜…â˜…â˜…
        case 'useRegenPotion':
            icon = 'ğŸ§ª';
            bgColor = 'bg-cyan-600';
            break;
        case 'monsterDefeated': 
            icon = 'â˜ ï¸';
            bgColor = 'bg-red-900';
            break;
        case 'monsterAttack': 
            icon = details.playerDied ? 'â˜ ï¸' : 'âš”ï¸';
            bgColor = details.playerDied ? 'bg-black' : 'bg-orange-600';
            break;
        case 'weeklyChampion': 
            icon = 'ğŸ‘‘';
            bgColor = 'bg-amber-500';
            break;
        case 'wildcardConvertedToPoints':
            icon = 'ğŸƒ';
            bgColor = 'bg-purple-600';
            break;
        case 'loginStreakClaim':
            icon = 'â°';
            bgColor = 'bg-teal-600';
            break;
        case 'tradeOfferCreated':
            icon = 'ğŸ“¤';
            bgColor = 'bg-blue-500';
            break;
        case 'tradeOfferAccepted':
            icon = 'ğŸ¤';
            bgColor = 'bg-green-600';
            break;
        case 'openBox':
            icon = 'ğŸ’°';
            bgColor = 'bg-green-500';
            break;
        case 'surpriseBox':
            icon = 'ğŸ‰';
            bgColor = 'bg-yellow-500';
            break;
        case 'iflas':
            if (details.shieldUsed) {
                icon = 'ğŸ›¡ï¸';
                bgColor = 'bg-blue-500';
            } else if (details.multiplier && details.multiplier > 1) {
                icon = 'âŒ'; 
                bgColor = 'bg-red-800';
            } else {
                icon = 'ğŸ’£';
                bgColor = 'bg-red-600';
            }
            break;
        case 'kasaTransfer':
            icon = 'ğŸ¦';
            bgColor = 'bg-purple-600';
            break;
        case 'multiplierUpgraded':
        case 'multiplierUpgradedFromStore':
        case 'multiplierStacked':
        case 'dailyRewardMultiplierStacked':
            icon = 'âœ¨';
            bgColor = 'bg-teal-500';
            break;
        case 'multiplierFound':
        case 'multiplierRefund':
            icon = 'âœ–ï¸';
            bgColor = 'bg-purple-500';
            break;
        case 'buyItem':
            icon = 'ğŸ›’';
            bgColor = 'bg-indigo-500';
            break;
        case 'multiplierDiscarded':
        case 'multiplierCombined': 
            icon = 'â';
            bgColor = 'bg-teal-500';
            break;
        case 'multiplierConvertedToBoxRights':
        case 'multiplierConvertedOnUsedOpen':
        case 'multiplierConvertedOnUnusedOpen':
        case 'dailyRewardMultiplierConverted':
            icon = 'â™»ï¸';
            bgColor = 'bg-lime-600'; 
            break;
        case 'multiplierSwappedOnUnusedOpen':
            icon = 'ğŸ”„';
            bgColor = 'bg-sky-500';
            break;
        case 'newItemFound':
            const itemType = details.itemType;
            if (itemType === 'card_pack_efsanevi') { icon = 'ğŸ†'; bgColor = 'bg-purple-600'; } 
            else if (itemType === 'card_pack_altin') { icon = 'ğŸ¥‡'; bgColor = 'bg-yellow-500'; } 
            else if (itemType === 'card_pack_gumus') { icon = 'ğŸ¥ˆ'; bgColor = 'bg-gray-500'; } 
            else if (itemType === 'card_pack_normal') { icon = 'ğŸ¥‰'; bgColor = 'bg-amber-600'; } 
            else if (itemType === 'card_pack') { icon = 'ğŸ´'; bgColor = 'bg-indigo-500'; } 
            else if (itemType === 'wildcard') { icon = 'ğŸƒ'; bgColor = 'bg-purple-500'; } 
            else if (itemType === 'iflasShield') { icon = 'ğŸ›¡ï¸'; bgColor = 'bg-cyan-500'; } 
            else if (itemType === 'wheelTicket') { icon = 'ğŸ«'; bgColor = 'bg-cyan-500'; } 
            else if (itemType === 'clickCatchTicket') { icon = 'ğŸŸï¸'; bgColor = 'bg-cyan-500'; } 
            else { icon = 'ğŸ“¦'; bgColor = 'bg-cyan-500'; }
            break;
        case 'spinWheel':
            icon = 'ğŸ¡';
            bgColor = 'bg-pink-500';
            break;
        case 'lobbyJoined':
            icon = 'ğŸ®';
            bgColor = 'bg-blue-600';
            break;
        case 'clickCatchSolo':
        case 'clickCatchLobby':
            icon = 'ğŸ¯';
            bgColor = 'bg-orange-500';
            break;
        case 'dailyReward':
            if (details.rewardType === 'avatar') { icon = 'ğŸ‘¤'; bgColor = 'bg-sky-500'; } 
            else if (details.rewardType === 'wildcard') { icon = 'ğŸƒ'; bgColor = 'bg-purple-600'; } 
            else if (details.rewardType === 'card_pack') { icon = 'ğŸ´'; bgColor = 'bg-indigo-600'; } 
            else { icon = 'ğŸ“…'; bgColor = 'bg-teal-500'; }
            break;
        case 'surpriseBoxTimeout':
            icon = 'â°';
            bgColor = 'bg-gray-600';
            break;
    }

    return `
        <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center ${bgColor} shadow-lg">
            <span class="text-2xl">${icon}</span>
        </div>
    `;
}
      
// MEVCUT renderActivityFeed FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIRIN
function renderActivityFeed(activities) {
    const activityFeedList = document.getElementById('activityFeedList');
    activityFeedList.innerHTML = '';

    if (isAdmin) {
        const clearButtonHtml = `
            <div class="px-2 mb-2 text-center">
                <button onclick="clearAllActivities()" class="w-full py-2 px-4 bg-red-800/50 hover:bg-red-700 text-white font-bold rounded-lg shadow-md text-sm border border-red-600">
                    Eylem GeÃ§miÅŸini Temizle
                </button>
            </div>
        `;
        activityFeedList.innerHTML += clearButtonHtml;
    }

    if (!activities || activities.length === 0) {
        activityFeedList.innerHTML += '<p class="text-center text-gray-400 p-4">GÃ¶sterilecek eylem bulunamadÄ±.</p>';
        return;
    }

    const percentPotions = ['defense_potion', 'crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion', 'health_regen_potion'];

    activities.forEach(activity => {
        try {
            if (!activity || !activity.username || !activity.type) { 
                return; 
            }

            const details = activity.details || {};
            let iconHtml = getActivityIcon(activity.type, details);
            let message = '';
            const timeAgo = formatTimeAgo(activity.timestamp);
            const deleteButtonHtml = isAdmin ? `<button onclick="deleteActivity('${activity.id}')" class="ml-2 p-1 rounded-full text-gray-500 hover:text-red-500 hover:bg-white/10 transition-colors" title="Bu Eylemi Sil"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>` : '';
            
            const userHtml = `<b class="text-yellow-300 cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${activity.username}')">${activity.username}</b>`;

            switch (activity.type) {
                case 'monsterAttack':
                    const monsterNameHtml = `<b class="text-red-300 cursor-pointer hover:underline" onclick="openMonsterInfoModal()">${details.monsterName}</b>`;
                    let attackSummary = `${userHtml}, ${monsterNameHtml}'a saldÄ±rdÄ±. `;
                    
                    if (details.didMonsterDodge) {
                        attackSummary += `Canavar <b class="text-cyan-400">sÄ±yrÄ±ldÄ±!</b>`;
                    } else if (details.playerAttackType === 'pierce') {
                        attackSummary += `ğŸ“Œ <b class="text-purple-400">Delici VuruÅŸ</b> ile <b class="text-green-300">${details.damageDealt} hasar</b> verdi. `;
                    } else if (details.playerAttackType === 'crit') {
                        attackSummary += `ğŸ’¥ <b class="text-green-300">Kritik VuruÅŸ</b> ile <b class="text-green-300">${details.damageDealt} hasar</b> verdi. `;
                    } else {
                        attackSummary += `<b class="text-green-300">${details.damageDealt} hasar</b> verdi. `;
                    }
                    
                    if (details.didPlayerDodge) {
                        attackSummary += `CanavarÄ±n saldÄ±rÄ±sÄ±ndan <b class="text-cyan-300">sÄ±yrÄ±ldÄ±!</b>`;
                    } else {
                        let monsterAttackText = 'saldÄ±rÄ±sÄ±yla';
                        if (details.monsterAttackType === 'crit') {
                            monsterAttackText = `ğŸ’¥ <b class="text-red-600">kritik saldÄ±rÄ±sÄ±yla</b>`;
                        } else if (details.monsterAttackType === 'pierce') {
                            monsterAttackText = `ğŸ“Œ <b class="text-purple-500">delici saldÄ±rÄ±sÄ±yla</b>`;
                        }
                        attackSummary += ` CanavarÄ±n ${monsterAttackText} <b class="text-red-400">${details.damageTaken} hasar</b> aldÄ±.`;
                    }

                    attackSummary += `<div class="text-xs mt-1 text-gray-400">
                        Canavar CanÄ±: ${formatNumber(details.monsterRemainingHP)}/${formatNumber(details.monsterMaxHP)} | 
                        ${activity.username} CanÄ±: ${formatNumber(details.playerRemainingHP)}/${formatNumber(details.playerMaxHP)} | 
                        Toplam Hasar: ${formatNumber(details.playerTotalDamage)}
                    </div>`;
                    
                    if (details.rewardWon) {
                        attackSummary += ` Ek olarak <b class="text-yellow-300">${details.rewardWon}</b> kazandÄ±.`;
                    }

                    if (details.playerDied) attackSummary += ` <b class="text-black bg-red-500 px-1 rounded">MAÄLUP OLDU!</b>`;

                    message = attackSummary;
                    break;

                case 'monsterDefeated':
                    const winnerHtml = `<b class="text-yellow-300 cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${details.winner}')">${details.winner}</b>`;
                    const defeatedMonsterNameHtml = `<b class="text-red-400 cursor-pointer hover:underline" onclick="openMonsterInfoModal()">${details.monsterName}</b>`;
                    message = `${defeatedMonsterNameHtml} maÄŸlup edildi! En Ã§ok hasarÄ± veren ${winnerHtml} (<b class="text-white">${formatNumber(details.totalDamage)} Hasar</b>), <b class="text-green-300">${details.prize}</b> Ã¶dÃ¼lÃ¼nÃ¼ kazandÄ±.`;
                    break;
                
                case 'collectionCompleted':
                    if (details.isFirst) {
                        message = `${userHtml}, koleksiyonu tamamlayan <b class="text-amber-400">Ä°LK KÄ°ÅÄ°</b> oldu ve bÃ¼yÃ¼k Ã¶dÃ¼lÃ¼ kazandÄ±!`;
                    } else {
                        message = `${userHtml}, koleksiyonu tamamlayan <b class="text-amber-400">${details.rank}. KÄ°ÅÄ°</b> oldu. Tebrikler!`;
                    }
                    break;

                case 'useRegenPotion':
                     message = `${userHtml}, <b class="text-cyan-300">%${details.percentage} Can Yenileme Ä°ksiri</b> kullanarak <b class="text-green-300">${details.healed} can</b> yeniledi. <span class="text-gray-400">(Can: ${formatNumber(details.newHP)}/${formatNumber(details.playerMaxHP)})</span>`;
                     break;

                case 'wildcardConvertedToBoxRights':
                    message = `${userHtml}, 1 Joker Kart'Ä± <b class="text-cyan-300 font-bold">+${details.boxRights} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rdÃ¼.`;
                    break;
                
                case 'clickCatchSolo':
                    const { baseScore, finalScore, ticketsUsed, specialItems, newWeeklyScore } = details;
                    message = `${userHtml}, TÄ±kla-Yakala oyununda <b class="text-white">${ticketsUsed} bilet</b> kullandÄ± ve <span class="text-green-300 font-bold">${finalScore} Skor</span> topladÄ±. <small class="text-gray-400">(Skor: ${baseScore} x ${ticketsUsed} Bilet)</small>`;

                    if (specialItems && specialItems.length > 0) {
                        const itemsText = specialItems.map(item => `<b class="text-cyan-300">+${item.amount} ${item.name}</b>`).join(', ');
                        message += ` - (AyrÄ±ca, ${itemsText}) kazandÄ±.`;
                    } else {
                        message += ' - (Ã–zel eÅŸya yakalanmadÄ±)';
                    }
                    const weeklyScoreText = (newWeeklyScore !== undefined) ? ` <span class="text-gray-400">(HaftalÄ±k Skor: ${newWeeklyScore})</span>` : '';
                    message += weeklyScoreText;
                    break;
                case 'weeklyChampion':
                    const championHtml = `<b class="text-amber-300 cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${details.winner}')">${details.winner}</b>`;
                    message = `TÄ±kla-Yakala haftasÄ± sona erdi! ${championHtml}, <b class="text-white">${details.score} skorla</b> ÅŸampiyon oldu ve <b class="text-green-300">${details.prize}</b> kazandÄ±. TÃ¼m katÄ±lÄ±mcÄ±lara +1 bilet hediye edildi.`;
                    break; 
                case 'loginStreakClaim':
                    message = `${userHtml}, giriÅŸ serisinde <b class="text-teal-300 font-bold">${details.day}. gÃ¼n</b> <b class="text-white">'${details.packageName}'</b> Ã¶dÃ¼lÃ¼nÃ¼ aldÄ±.`;
                    break;
                case 'tradeOfferCreated':
                    message = `${userHtml}, <b class="text-red-400">-${details.fee} Puan</b> Ã¶deyip pazara yeni bir takas teklifi koydu: <b class="text-cyan-300">${details.offeredCardName}</b> karÅŸÄ±lÄ±ÄŸÄ±nda <b class="text-pink-300">${details.requestedCardName}</b> istiyor.`;
                    if (details.status === 'completed') { message += ` <span class="text-green-400 font-bold">(Takas YapÄ±ldÄ±)</span>`; } 
                    else if (details.status === 'cancelled') { message += ` <span class="text-red-500 font-bold">(Ä°ÅŸlem Ä°ptal Edildi)</span>`; }
                    break;
                case 'tradeOfferAccepted':
                    message = `${userHtml}, <b class="text-red-400">-${details.fee} Puan</b> Ã¶deyip, ${details.offerer}'in <b class="text-cyan-300">'${details.offeredCardName}'</b> kartÄ± teklifini kabul etti ve karÅŸÄ±lÄ±ÄŸÄ±nda <b class="text-pink-300">'${details.requestedCardName}'</b> kartÄ±nÄ± verdi. <span class="text-gray-400">(Kalan Puan: ${formatNumber(details.newBalance)})</span>`;
                    break;
                case 'newItemFound':
                    let newItemMultiplierText = (details.multiplier && details.multiplier > 1) ? ` <span class="text-xs text-purple-400">(${details.multiplier}x Ã§arpan kullandÄ±)</span>` : ` <span class="text-xs text-gray-400">(Ã§arpan kullanmadÄ±)</span>`;
                    let displayItemName = details.itemType ? typeToName[details.itemType] : details.itemName;
                    let displayItemAmount = details.itemName ? details.itemName.split(' ')[0] : '+1'; 
                    
                    let valuePrefixNewItem = '+';
                    if (percentPotions.includes(details.itemType)) {
                        valuePrefixNewItem = '+%';
                    } else if (details.itemType === 'health_regen_potion') {
                        valuePrefixNewItem = '%';
                    }
                    if (details.itemValue) {
                        displayItemAmount = `${valuePrefixNewItem}${details.itemValue}`;
                    }

                    message = `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan <span class="text-cyan-300 font-bold">${displayItemAmount} ${displayItemName}</span> buldu.${newItemMultiplierText}`;
                    break;
                case 'multiplierStackedFromStore':
                     message = `${userHtml}, maÄŸazadan aldÄ±ÄŸÄ± Ã§arpan ile mevcut <b>${details.multiplierValue}x</b> Ã§arpanÄ±nÄ±n kullanÄ±m hakkÄ±nÄ± <b class="text-teal-300 font-bold">+${details.usesAdded}</b> artÄ±rarak toplam <b class="text-teal-300 font-bold">${details.newTotalUses}</b> adete Ã§Ä±kardÄ±.`;
                    break;
                case 'dailyRewardMultiplierStacked':
                    const sourceTextStack = details.source || "GÃ¼nlÃ¼k Ã–dÃ¼l'den";
                    message = `${userHtml}, ${sourceTextStack} mevcut <b>${details.multiplierValue}x</b> Ã§arpanÄ±yla aynÄ± deÄŸerde bir Ã§arpan daha aldÄ±. KullanÄ±m hakkÄ± <b class="text-teal-300 font-bold">+${details.usesAdded}</b> artÄ±rÄ±larak toplam <b class="text-teal-300 font-bold">${details.newTotalUses}</b> oldu.`;
                    break;
                case 'multiplierStacked':
                    message = `${userHtml}, <b>${details.boxId} numaralÄ± kutudan</b> mevcut <b>${details.value}x</b> Ã§arpanÄ±yla aynÄ± deÄŸerde bir Ã§arpan daha buldu. KullanÄ±m hakkÄ± <b class="text-teal-300 font-bold">+1</b> artÄ±rÄ±ldÄ±.`;
                    break;
                case 'multiplierUpgraded':
                case 'multiplierUpgradedFromStore':
                    const upgradeSource = details.source || 'MaÄŸazadan';
                    message = `${userHtml}, ${upgradeSource} aldÄ±ÄŸÄ± <b>${details.newValue}x (${details.newUses} kullanÄ±m)</b> Ã§arpan ile mevcut <b>${details.oldValue}x (${details.oldUses} kullanÄ±m)</b> Ã§arpanÄ±nÄ± yÃ¼kseltti. Eski Ã§arpanÄ± iÃ§in <b class="text-green-300 font-bold">+${details.boxRights} Kutu HakkÄ±</b> iade edildi.`;
                    break;
                case 'wildcardConverted':
                    message = `${userHtml}, Koleksiyonu tamamladÄ±ÄŸÄ± iÃ§in ${details.source}'dan aldÄ±ÄŸÄ± ${details.wildcards} Joker Kart'Ä± <b class="text-cyan-300 font-bold">+${details.boxRights} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rdÃ¼.`;
                    break;
                case 'cardPackConverted':
                    message = `${userHtml}, Koleksiyonu tamamladÄ±ÄŸÄ± iÃ§in ${details.source}'dan aldÄ±ÄŸÄ± ${details.packs} Kart Paketi'ni <b class="text-green-300 font-bold">+${details.points} Puana</b> dÃ¶nÃ¼ÅŸtÃ¼rdÃ¼.`;
                    break;
                case 'multiplierCombined':
                    message = `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan <b>${details.foundValue}x Ã§arpan</b> buldu. Mevcut Ã§arpanÄ±yla birleÅŸtirerek tek kullanÄ±mlÄ±k <b class="text-teal-300 font-bold">${details.combinedValue}x</b> gÃ¼cÃ¼ne ulaÅŸtÄ± ve <span class="text-green-300 font-bold">+1 Kutu HakkÄ±</span> iade aldÄ±.`;
                    break;
                 case 'multiplierSwappedOnUnusedOpen':
                     message = `${userHtml}, mevcut <b>${details.existingValue}x (${details.refundedUses} kullanÄ±m)</b> Ã§arpanÄ±nÄ±, kutudan Ã§Ä±kan yeni <b>${details.foundValue}x (1 kullanÄ±m)</b> Ã§arpanÄ± ile takas etti. Eski Ã§arpanÄ± iÃ§in <b class="text-green-300 font-bold">+${details.boxRights} Kutu HakkÄ±</b> iade edildi.`;
                     break;
                case 'multiplierConvertedToBoxRights':
                case 'multiplierConvertedOnUsedOpen':
                case 'multiplierConvertedOnUnusedOpen':
                case 'dailyRewardMultiplierConverted':
                    let conversionSourceText = details.source ? `${details.source}'dan` : 'bir yerden';
                    if (activity.type.includes('OnUsedOpen') || activity.type.includes('OnUnusedOpen')) {
                        conversionSourceText = `kutudan`;
                    }
                    const keptMultiplierText = details.keptMultiplierValue ? ` mevcut <b>${details.keptMultiplierValue}x</b> Ã§arpanÄ±nÄ± koruyarak` : '';
                    message = `${userHtml}, ${conversionSourceText} kazandÄ±ÄŸÄ± <b>${details.rewardValue || details.foundValue}x</b> Ã§arpanÄ±,${keptMultiplierText} <span class="text-lime-300 font-bold">+${details.boxRights} Kutu HakkÄ±</span>'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼.`;
                    break;
                case 'openBox':
                    let openBoxMultiplierText = (details.multiplier && details.multiplier > 1) ? ` <span class="text-xs text-purple-400">(${details.multiplier}x Ã§arpan kullandÄ±)</span>` : ` <span class="text-xs text-gray-400">(Ã§arpan kullanmadÄ±)</span>`;
                    message = `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan <span class="text-green-300 font-bold">+${details.points} Puan</span> kazandÄ±.${openBoxMultiplierText} <span class="text-gray-400">(Mevcut Puan: ${details.newBalance})</span>`;
                    break;
                case 'iflas':
                    let iflasMultiplierText = (details.multiplier && details.multiplier > 1) ? ` <span class="text-xs text-purple-400">(${details.multiplier}x Ã§arpan kullandÄ±)</span>` : ` <span class="text-xs text-gray-400">(Ã§arpan kullanmadÄ±)</span>`;
                    message = details.shieldUsed ? `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan bomba buldu ama iflas kalkanÄ± onu korudu.${iflasMultiplierText}` : `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan bomba buldu <span class="text-red-400 font-bold">-${details.lostPoints} Puan</span> kaybetti.${iflasMultiplierText} <span class="text-gray-400">(Kalan Puan: ${details.newBalance})</span>`;
                    break;
                case 'kasaTransfer':
                    message = `${userHtml}, Kasa'sÄ±na <b class="text-purple-300 font-bold">${details.amount} Puan</b> aktardÄ±. <span class="text-gray-400">(Yeni Kasa PuanÄ±: ${details.newKasaBalance})</span>`;
                    break;
                case 'surpriseBox':
                    let surpriseMultiplierText = (details.multiplier && details.multiplier > 1) ? ` <span class="text-xs text-purple-400">(${details.multiplier}x Ã§arpan kullandÄ±)</span>` : ` <span class="text-xs text-gray-400">(Ã§arpan kullanmadÄ±)</span>`;
                    const source = details.boxId === 'Ã‡ark' ? 'Åans Ã‡arkÄ±\'ndan' : `<b>${details.boxId}</b> numaralÄ± kutudan`;
                    message = `${userHtml}, ${source} SÃ¼rpriz Kutu buldu ve <span class="text-green-300 font-bold">+${details.points} Puan</span> kazandÄ±!${surpriseMultiplierText} <span class="text-gray-400">(Mevcut Puan: ${details.newBalance})</span>`;
                    break;
                case 'multiplierFound':
                    message = `${userHtml}, <b>${details.boxId}</b> numaralÄ± kutudan <span class="text-purple-300 font-bold">${details.value}x Ã‡arpan</span> buldu.`;
                    break;
                case 'buyItem':
                    const isKP = details.itemCost.toString().includes('KP');
                    const costText = isKP ? details.itemCost : `${formatNumber(details.itemCost)} Puan`;
                    const balance = isKP ? details.newKasaBalance : details.newBalance;
                    const balanceUnit = isKP ? 'KP' : 'PuanÄ±';
                    message = `${userHtml}, Ã¶zel Ã¼rÃ¼n maÄŸazasÄ±ndan <b class="text-red-500">-${costText}</b> harcayarak <b class="text-green-400">${details.itemName}</b> aldÄ±. (Mevcut ${balanceUnit}: ${formatNumber(balance)})`;
                    break;
                case 'lobbyJoined':
                    message = `${userHtml}, TÄ±kla-Yakala lobisine <span class="text-red-400 font-bold">-${details.cost} Puan</span> karÅŸÄ±lÄ±ÄŸÄ±nda katÄ±ldÄ±. <span class="text-gray-400">(Kalan Puan: ${details.newBalance})</span>`;
                    break;
                case 'spinWheel':
                    let prizeText = '';
                    const prizeType = details.type;
                    const prizeValue = details.value;
                    let wheelBalanceText = prizeType === 'points' ? ` <span class="text-gray-400">(Mevcut Puan: ${details.newBalance})</span>` : '';
                    if (prizeType === 'pas') { message = `${userHtml}, Ã§arkÄ± Ã§evirdi ve <span class="text-gray-400 font-bold">Pas</span> geÃ§ti.`; } 
                    else {
                        const isPercentSpin = percentPotions.includes(prizeType);
                        const valuePrefixSpin = isPercentSpin ? `+%` : `+`;
                        if (prizeType === 'points') { prizeText = `+${prizeValue} Puan`; } 
                        else if (prizeType === 'tempMultiplier') { prizeText = `${prizeValue}X Ã‡arpan`; } 
                        else { prizeText = `${valuePrefixSpin}${prizeValue} ${typeToName[prizeType] || prizeType}`; }
                        message = `${userHtml}, Ã§arkÄ± Ã§evirerek <span class="text-pink-300 font-bold">${prizeText}</span> kazandÄ±.${wheelBalanceText}`;
                    }
                    break;
                case 'clickCatchLobby':
                    message = `${userHtml}, lobi oyununu kazanarak <span class="text-yellow-300 font-bold">+${details.prize} Puan</span> Ã¶dÃ¼l aldÄ±! <span class="text-gray-400">(Mevcut Puan: ${details.newBalance})</span>`;
                    break;
                case 'dailyReward':
                    let rewardText = '';
                    const rewardType = details.rewardType;
                    const rewardValue = details.rewardValue;
                    let dailyBalanceText = rewardType === 'points' ? ` <span class="text-gray-400">(Mevcut Puan: ${details.newBalance})</span>` : '';
                    if (rewardType === 'avatar') { 
                        rewardText = `<span class="text-sky-300 font-bold">'${rewardValue}' avatarÄ±nÄ±</span>`;
                        message = `${userHtml}, gÃ¼nlÃ¼k Ã¶dÃ¼l olarak ${rewardText} kazandÄ±.`;
                    } else {
                        const isPercentDaily = percentPotions.includes(rewardType);
                        const valuePrefixDaily = isPercentDaily ? `+%` : `+`;
                        if (rewardType === 'tempMultiplier') { 
                            rewardText = `${rewardValue}x Ã‡arpan (${details.rewardUses} kullanÄ±m)`;
                        } else { 
                            rewardText = `${valuePrefixDaily}${rewardValue} ${typeToName[rewardType] || details.rewardName}`;
                        }
                        message = `${userHtml}, gÃ¼nlÃ¼k Ã¶dÃ¼l olarak <span class="text-teal-300 font-bold">${rewardText}</span> aldÄ±.${dailyBalanceText}`;
                    }
                    break;
                default:
                    message = `${userHtml} bir eylem gerÃ§ekleÅŸtirdi. (Tip: ${activity.type})`;
                    break;
            }

            const activityHtml = `
                <div class="bg-gray-800/70 p-3 rounded-xl flex items-center gap-4 border border-transparent hover:border-gray-700 transition-all duration-200">
                    ${iconHtml}
                    <div class="flex-1 min-w-0">
                        <p class="text-gray-200 text-sm leading-relaxed">${message}</p>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500">${timeAgo}</span>
                            ${deleteButtonHtml}
                        </div>
                    </div>
                </div>`;
            
            activityFeedList.innerHTML += activityHtml;
        } catch (error) {
            console.error("Bir aktivite iÅŸlenirken hata oluÅŸtu, bu eylem atlandÄ±:", error);
            console.error("HatalÄ± aktivite verisi:", activity);
        }
    });
}
      
// MEVCUT parseStatValue FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
/**
 * Verilen deÄŸere gÃ¶re bir deÄŸeri tamsayÄ± veya ondalÄ±klÄ± sayÄ±ya Ã§evirir.
 * YÃ¼zdelik iksirler iÃ§in ondalÄ±klÄ±, diÄŸerleri iÃ§in tamsayÄ± kullanÄ±lÄ±r.
 * @param {string} type - Ã–dÃ¼l veya eÅŸya tipi.
 * @param {string|number} valueString - Ã‡evrilecek deÄŸer.
 * @returns {number} Ä°ÅŸlenmiÅŸ sayÄ±sal deÄŸer.
 */
function parseStatValue(type, valueString) {
    // â˜…â˜…â˜… YÃœZDE Ä°LE VERÄ°LEN TÃœM Ä°KSÄ°R TÃœRLERÄ° BURAYA EKLENDÄ° â˜…â˜…â˜…
    const isPercentPotion = ['crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion', 'defense_potion', 'health_regen_potion'].includes(type);
    if (isPercentPotion) {
        // VirgÃ¼lÃ¼ noktaya Ã§evirerek uluslararasÄ± uyumluluk saÄŸlar ve ondalÄ±klÄ± sayÄ±ya Ã§evirir.
        return parseFloat(String(valueString).replace(',', '.'));
    }
    // DiÄŸer tÃ¼m tipler iÃ§in tamsayÄ±ya Ã§evirir.
    return parseInt(valueString);
}
      
// MEVCUT listenForActivityFeed FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
function listenForActivityFeed() {
    const ref = db.ref('activityFeed').orderByChild('timestamp').limitToLast(15);
    const callback = (snapshot) => {
        const feed = document.getElementById('activityFeed');
        feed.innerHTML = '';
        const activities = [];
        snapshot.forEach(child => {
            activities.push({ key: child.key, ...child.val() });
        });
        
        activities.reverse().forEach(activity => {
            let message = '';
            const details = activity.details || {};
            const timeAgo = formatTimeAgo(activity.timestamp);
            let icon = 'ğŸ’¬';

            switch (activity.type) {
                case 'buyItem':
                    icon = 'ğŸ›’';
                    const isKP = details.itemCost.toString().includes('KP');
                    const costText = isKP ? details.itemCost : `${formatNumber(details.itemCost)} Puan`;
                    const balance = isKP ? details.newKasaBalance : details.newBalance;
                    const balanceUnit = isKP ? 'KP' : 'PuanÄ±';
                    message = `<b class="text-yellow-300">${activity.username}</b>, maÄŸazadan <b class="text-red-500">-${costText}</b> harcayarak <b class="text-green-400">${details.itemName}</b> aldÄ±. (Mevcut ${balanceUnit}: ${formatNumber(balance)})`;
                    break;

                case 'spinWheel':
                    icon = 'ğŸ¡';
                    let prizeText = '';
                    let wheelBalanceText = details.type === 'points' ? ` <span class="text-gray-400">(Mevcut Puan: ${details.newBalance})</span>` : '';

                    // EÄŸer kazanÄ±lan Ã¶dÃ¼l Ã§arpan ise ve kullanÄ±m hakkÄ± bilgisi varsa, Ã¶zel metin oluÅŸtur
                    if (details.type === 'tempMultiplier' && details.duration > 0) {
                        prizeText = `<span class="text-pink-300 font-bold">${details.value}x Ã‡arpan (${details.duration} kullanÄ±m)</span> kazandÄ±.`;
                    } 
                    // EÄŸer pas geÃ§ildiyse
                    else if (details.type === 'pas') {
                        prizeText = `<span class="text-gray-400 font-bold">Pas</span> geÃ§ti.`;
                    } 
                    // DiÄŸer tÃ¼m Ã¶dÃ¼ller iÃ§in genel metin
                    else {
                        prizeText = `<span class="text-pink-300 font-bold">${details.result}</span> kazandÄ±.`;
                    }

                    message = `${userHtml}, Ã§arkÄ± Ã§evirerek ${prizeText}${wheelBalanceText}`;
                    break;
                
                // KUTU EYLEMLERÄ° Ä°Ã‡Ä°N STANDART FORMAT
                case 'openBox':
                case 'iflas':
                case 'multiplierFound':
                case 'newItemFound':
                    const multiplierText = details.multiplier > 1 
                        ? `(<b>${details.multiplier}x</b> Ã§arpan kullandÄ±)` 
                        : `(Ã§arpan kullanmadÄ±)`;
                    let prizeHtml = '';

                    if (activity.type === 'openBox') {
                        icon = 'ğŸ“¦';
                        prizeHtml = `<b class="text-green-400">+${details.points} Puan</b>`;
                    } else if (activity.type === 'iflas') {
                        icon = 'ğŸ“¦';
                        prizeHtml = details.shieldUsed ? '<b class="text-blue-400">Ä°flas etti ama kalkanÄ± korudu</b>' : '<b class="text-red-500">Ä°flas etti</b>';
                    } else if (activity.type === 'multiplierFound') {
                        icon = 'ğŸ“¦';
                        prizeHtml = `<b class="text-yellow-400">${details.value}x Ã‡arpan</b>`;
                    } else if (activity.type === 'newItemFound') {
                        icon = 'ğŸ“¦';
                        if (details.itemType === 'wildcard') icon = 'ğŸƒ';
                        if (details.itemType === 'card_pack') icon = 'ğŸ´';
                        prizeHtml = `<b class="text-cyan-400">${details.itemName}</b>`;
                    }
                    
                    message = `<b class="text-yellow-300">${activity.username}</b>, ${details.boxId} numaralÄ± kutudan ${prizeHtml} kazandÄ±. ${multiplierText}`;
                    break;
                
                // DÃ–NÃœÅÃœM EYLEMLERÄ° Ä°Ã‡Ä°N YENÄ° FORMATLAR
                case 'cardPackConverted':
                    icon = 'ğŸ´';
                    const packsMultiplierText = details.multiplier > 1 
                        ? `(<b>${details.multiplier}x</b> Ã§arpan kullandÄ±)` 
                        : `(Ã§arpan kullanmadÄ±)`;
                    message = `<b class="text-yellow-300">${activity.username}</b>, ${details.source}'dan <b class="text-purple-400">+${details.packs} Kart Paketi</b> buldu. AlbÃ¼mÃ¼ tamamladÄ±ÄŸÄ± iÃ§in <b class="text-green-400">+${formatNumber(details.points)} Puana</b> dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼. ${packsMultiplierText}`;
                    break;
                case 'wildcardConverted':
                    icon = 'ğŸƒ';
                    const wildcardsMultiplierText = details.multiplier > 1 
                        ? `(<b>${details.multiplier}x</b> Ã§arpan kullandÄ±)` 
                        : `(Ã§arpan kullanmadÄ±)`;
                    message = `<b class="text-yellow-300">${activity.username}</b>, ${details.source}'dan <b class="text-purple-400">+${details.wildcards} Joker Kart</b> buldu. AlbÃ¼mÃ¼ tamamladÄ±ÄŸÄ± iÃ§in <b class="text-cyan-400">+${details.boxRights} Kutu HakkÄ±</b> ile deÄŸiÅŸtirildi. ${wildcardsMultiplierText}`;
                    break;

                case 'collectionCompleted':
                    icon = 'ğŸ†';
                    if (details.isFirst) {
                        message = `<b class="text-yellow-300">${activity.username}</b>, koleksiyonu tamamlayan <b class="text-amber-400">Ä°LK KÄ°ÅÄ°</b> oldu ve bÃ¼yÃ¼k Ã¶dÃ¼lÃ¼ kazandÄ±!`;
                    } else {
                        message = `<b class="text-yellow-300">${activity.username}</b>, koleksiyonu tamamlayarak bÃ¼yÃ¼k Ã¶dÃ¼lÃ¼ kazandÄ±!`;
                    }
                    break;
                default:
                    message = ``; 
            }
            
            if (message) {
                feed.innerHTML += `
                    <div class="activity-item">
                        <div class="activity-icon">${icon}</div>
                        <div class="activity-text">${message}</div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>`;
            }
        });
    };
    activeListeners.activityFeed = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// MEVCUT listenForLastOpenedBox FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
function listenForLastOpenedBox() {
    const ref = db.ref('lastOpenedBox');
    const callback = (snap) => {
        const data = snap.val();
        const infoDiv = document.getElementById('lastOpenedBoxInfo');
        if (data && data.opener) {
            let contentHtml = '';
            if (data.content === 'points') {
                contentHtml = `<span class="text-green-400 font-bold">${data.finalPoints} Puan</span> kazandÄ±!`;
            } else if (data.content === 'iflas') {
                contentHtml = data.shieldUsed 
                    ? `<span class="text-blue-400 font-bold">Ä°flas etti ama KalkanÄ± onu korudu!</span>`
                    : `<span class="text-red-500 font-bold">Ä°flas etti!</span>`;
            } else if (data.content === 'multiplier') {
                contentHtml = `<span class="text-yellow-400 font-bold">${data.value}X Ã‡arpan</span> buldu!`;
            } 
            else if (data.content === 'card_pack') {
                 contentHtml = `<span class="text-purple-400 font-bold">${data.value}</span> buldu!`;
            }
            else {
                const itemsGained = data.finalValue || data.value;
                const itemNames = { wheelTicket: 'Ã‡ark Bileti', clickCatchTicket: 'T-Y Bileti', iflasShield: 'Ä°flas KalkanÄ±', wildcard: 'Joker Kart' };
                const friendlyName = itemNames[data.content] || 'bir eÅŸya';
                contentHtml = `<span class="text-cyan-400 font-bold">+${itemsGained} ${friendlyName}</span> kazandÄ±!`;
            }

            infoDiv.innerHTML = `
                <span class="font-bold text-yellow-300">${data.opener}</span> adlÄ± oyuncu 
                <span class="font-bold text-gray-300">${data.boxId}</span> numaralÄ± kutudan 
                ${contentHtml}
            `;
        } else {
            infoDiv.textContent = 'HenÃ¼z kimse kutu aÃ§madÄ±.';
        }
    };
    activeListeners.lastOpenedBox = { ref, event: 'value', callback };
    ref.on('value', callback);
}

  async function revealAll() { const confirmed = await customConfirm("TÃ¼m kutularÄ± aÃ§mak istiyor musunuz?"); if(confirmed) { boxes.forEach(b => { if (!b.opened) { b.opened = true; b.opener = 'Admin'; } }); db.ref('boxes').set(boxes).then(() => displayMessage("TÃ¼m kutular baÅŸarÄ±yla aÃ§Ä±ldÄ±.")) } }
  
  async function resetGameBoard() {
    console.log("resetGameBoard fonksiyonu Ã§alÄ±ÅŸtÄ±! Oyun sÄ±fÄ±rlanÄ±yor...");
    
    // 1. Yeni kutularÄ± oluÅŸturur
    await createBoxes();
    
    // --- DÃœZELTME BURADA ---
    // Sadece kutu aÃ§ma istatistiklerini sÄ±fÄ±rlar, lastSurpriseInfo'ya dokunmaz.
    await db.ref('gameStats/boxesOpenedByUsers').remove(); 
    
    // 3. DiÄŸer geÃ§ici verileri temizler
    await db.ref('lastOpenedBox').remove();
    await db.ref('gameLock').set(false);
}

async function handleSurpriseBoxCleanup(sessionData) {
    if (!sessionData) return;
    
    // ArtÄ±k bu fonksiyon oyunu sÄ±fÄ±rlamÄ±yor, sadece oturumu temizliyor.
    // SÄ±fÄ±rlama iÅŸlemi manuel olarak "manualResetAfterSurprise" fonksiyonu ile yapÄ±lacak.
    await db.ref('surprise_box_session').remove();
}

  async function resetGame() {
      const confirmed = await customConfirm("Oyunu sÄ±fÄ±rlamak istiyor musunuz? (TÃ¼m kutular kapatÄ±lÄ±r, karÄ±ÅŸtÄ±rÄ±lÄ±r ve kutu aÃ§ma istatistikleri sÄ±fÄ±rlanÄ±r)");
      if (confirmed) {
          await resetGameBoard();
          displayMessage("Oyun yÃ¶neticisi tarafÄ±ndan sÄ±fÄ±rlandÄ±.");
      }
  }

  async function restartSystem() {
    const confirmed = await customConfirm("Sistemi baÅŸtan baÅŸlatmak istediÄŸinize emin misiniz? Avatarlar ve Sezon BaÅŸarÄ±mlarÄ± HARÄ°Ã‡, Kasa PuanlarÄ± ve Rozetleri belirleyen tÃ¼m istatistikler dahil her ÅŸey kalÄ±cÄ± olarak sÄ±fÄ±rlanacak!");
    if (confirmed) {
        
        // TÃ¼m gÃ¼ncellemeleri tek bir objede toplayacaÄŸÄ±z
        const updates = {};

        const userSnap = await db.ref('users').once('value');
        const usersData = userSnap.val();
        
        if (usersData) {
            for (const u in usersData) {
                if (u !== "weizendtv") {
                    const userPath = 'users/' + u;
                    
                    // KullanÄ±cÄ± verilerini sÄ±fÄ±rlama kÄ±smÄ±
                    updates[userPath + '/balance'] = 0;
                    updates[userPath + '/kasaPuani'] = 0;
                    updates[userPath + '/kariyerPuani'] = 0;
                    updates[userPath + '/highestBalanceEver'] = 0;
                    updates[userPath + '/totalSpentPoints'] = 0;
                    updates[userPath + '/kutuHakki'] = 0;
                    updates[userPath + '/carkBileti'] = 0;
                    updates[userPath + '/clickCatchTickets'] = 0;
                    updates[userPath + '/clickCatchHighestScore'] = 0;
                    updates[userPath + '/boxesOpenedCount'] = 0;
                    updates[userPath + '/surpriseBoxesOpened'] = 0;
                    updates[userPath + '/activeMultiplier'] = 1;
                    updates[userPath + '/multiplierSource'] = 'none';
                    updates[userPath + '/multiplierRemainingUses'] = 0;
                    updates[userPath + '/activeStoreMultiplierItemId'] = null;
                    updates[userPath + '/iflasShieldUses'] = 0;
                    updates[userPath + '/iflasCount'] = 0;
                    updates[userPath + '/iflasShieldUsedCount'] = 0;
                    updates[userPath + '/multiplierFoundCount'] = 0;
                    updates[userPath + '/storePurchasesCount'] = 0;
                    updates[userPath + '/wheelSpinsCount'] = 0;
                    updates[userPath + '/hasReceivedWelcomeGift'] = false;
                    updates[userPath + '/approvalNotified'] = null;
                    updates[userPath + '/notifications'] = null;
                    updates[userPath + '/dailyRewardsClaimed'] = null;
                    updates[userPath + '/lastSeenAnnouncementTimestamp'] = null;
                    updates[userPath + '/lastSeenGlobalNotifTimestamp'] = null;
                    updates[userPath + '/cardCollection'] = null;
                    updates[userPath + '/completedCollection'] = null;
                    updates[userPath + '/wildcards'] = 0;
                }
            }
        }
        
        // --- YENÄ° EKLENEN KISIM BAÅLANGICI ---
        // MaÄŸazadaki Ã¼rÃ¼nlerin "satÄ±n alÄ±nma sayÄ±sÄ±nÄ±" sÄ±fÄ±rla
        const storeItemsSnap = await db.ref('storeItems').once('value');
        if (storeItemsSnap.exists()) {
            storeItemsSnap.forEach(itemSnap => {
                updates[`storeItems/${itemSnap.key}/purchaseCount`] = 0;
            });
        }
        // --- YENÄ° EKLENEN KISIM SONU ---

        // Toplanan tÃ¼m kullanÄ±cÄ± ve maÄŸaza gÃ¼ncellemelerini tek seferde uygula
        await db.ref().update(updates);
        
        // Geri kalan genel verileri ve ayarlarÄ± temizle
        await db.ref('gameConfig/seasonSettings').remove();
        await db.ref('gameConfig/seasonEndDate').remove();
        await db.ref('gameConfig/seasonResetStatus').remove();
        await db.ref('gameConfig/updateRequiredTimestamp').remove();
        await db.ref('gameConfig/collectionWinner').remove();
        await db.ref('gameConfig/collectionGrandPrize').remove();
        await db.ref('gameConfig/cardCollectionStatus').set('inactive');

        await createBoxes();
        await db.ref('purchaseHistory').remove();
        await db.ref('pendingSpecialPurchases').remove();
        await db.ref('gameStats').remove();
        await db.ref('announcements').remove();
        await db.ref('dailyRewardOptions').remove();
        await db.ref('trades').remove();
        await db.ref('tradeHistory').remove();
        await db.ref('activityFeed').remove();

        displayMessage("Sistem baÅŸarÄ±yla baÅŸtan baÅŸlatÄ±ldÄ±! TÃ¼m rozetler ve istatistikler sÄ±fÄ±rlandÄ±. Sayfa 2 saniye iÃ§inde yenilenecek...");
        
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    }
}
      
  function loadTotalOpenedBoxesCount() {
    const ref = db.ref('boxes');
    const callback = snap => {
        const allBoxes = snap.val();
        let openedCount = 0;
        if (allBoxes) {
            openedCount = allBoxes.filter(box => box.opened).length;
        }
        document.getElementById('totalOpenedBoxesCount').textContent = openedCount;
    };
    activeListeners.totalOpenedBoxes = { ref, event: 'value', callback };
    ref.on('value', callback);
  }
  
  // YENÄ° VE DÃœZGÃœN Ã‡ALIÅAN KOD (Bununla deÄŸiÅŸtir)
function searchUsers() {
    const term = document.getElementById("searchUser").value.trim().toLowerCase();
    db.ref('users').once('value').then(snap => {
        const data = snap.val();
        let html = "";
        if (data) {
            for (const u in data) {
                if (u.toLowerCase() === "weizendtv") continue;

                // Arama terimine gÃ¶re filtreleme
                if (u.toLowerCase().includes(term)) {
                    const user = data[u];
                    let blockedStatusHtml = '';
                    const isCurrentlyBlocked = user.blocked && user.blockedUntil && Date.now() < user.blockedUntil;

                    if (isCurrentlyBlocked) {
                        blockedStatusHtml = `<span class="text-red-400">(Engelli - <span id="admin-countdown-${u}">--:--</span>)</span>`;
                        // Not: Bu arama fonksiyonu anlÄ±k olduÄŸu iÃ§in geri sayÄ±m sayacÄ±nÄ± burada yeniden baÅŸlatmak 
                        // karmaÅŸÄ±k olabilir, ancak en azÄ±ndan "Engelli" durumu doÄŸru gÃ¶rÃ¼necektir.
                    } else if (user.blocked) {
                        blockedStatusHtml = `<span class="text-green-400">(Engel SÃ¼resi Doldu)</span>`;
                    }

                    const avatarUrl = user.selectedAvatar ? user.selectedAvatar.url : defaultAvatarUrl;
                    html += `<div class="flex items-center justify-between p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-blue-500 cursor-pointer hover:bg-gray-600 transition-colors" onclick="openUserManagementModal(event, '${u}')">
                        <div class="flex items-center">
                            <img src="${avatarUrl}" class="w-12 h-12 rounded-md mr-3 object-contain">
                            <span class="text-gray-200">${u} ${blockedStatusHtml}</span>
                        </div>
                        <span class="text-yellow-300">Puan: ${user.balance || 0}</span>
                    </div>`;
                }
            }
        }
        document.getElementById("allUsers").innerHTML = html || "<div class='text-center text-gray-400'>Aramayla eÅŸleÅŸen kullanÄ±cÄ± bulunamadÄ±.</div>";
    });
}
  
  function displayBlockedMessage(blockedUntil, username) {
      blockedMessageModal.style.display = 'flex';
      document.getElementById('blockedReason').textContent = "HesabÄ±nÄ±z geÃ§ici olarak engellendi. SÃ¼re dolduÄŸunda devam edebilirsiniz.";
      
      if(countdownInterval) clearInterval(countdownInterval);

      const updateCountdown = () => {
          const timeLeft = blockedUntil - Date.now();
          if (timeLeft <= 0) {
              document.getElementById('blockedCountdown').textContent = "Engel sÃ¼reniz doldu!";
              clearInterval(countdownInterval);
              setTimeout(() => {
                 blockedMessageModal.style.display = 'none';
                 if (username === currentUser) {
                    db.ref('users/' + username).update({ blocked: false, blockedUntil: null });
                 }
              }, 2000);
              return;
          }
          const minutes = Math.floor(timeLeft / 60000);
          const seconds = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, '0');
          document.getElementById('blockedCountdown').textContent = `Kalan sÃ¼re: ${minutes}:${seconds}`;
      };
      countdownInterval = setInterval(updateCountdown, 1000);
      updateCountdown();
  }
  
  function closeOpenedBoxInfoModal() { openedBoxInfoModal.style.display = 'none'; }
  function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
  
  function openCardSelectionModal(userId) {
    if (countdownInterval) clearInterval(countdownInterval);

    const cardContainer = document.getElementById('playerCardContainer');
    cardContainer.innerHTML = '';
    const sessionRef = db.ref('surprise_box_session');

    sessionRef.once('value').then(snap => {
        const sessionData = snap.val();
        if (!sessionData || !sessionData.active || sessionData.result || !sessionData.expirationTimestamp) return;

        sessionData.cards.forEach((cardValue, index) => {
            const containerDiv = document.createElement('div');
            containerDiv.className = 'card-flip-container';
            containerDiv.dataset.value = cardValue;
            containerDiv.dataset.index = index;
            
            containerDiv.innerHTML = `
                <div class="card-flipper">
                    <div class="card-front bg-gradient-to-br from-red-700 to-red-900 flex items-center justify-center text-white text-6xl font-bold rounded-xl">
                        ?
                    </div>
                    <div class="card-back bg-gray-900 flex flex-col items-center justify-center text-yellow-400 text-3xl rounded-xl">
                        
                    </div>
                </div>
            `;

            containerDiv.onclick = () => selectCard(containerDiv, userId);
            cardContainer.appendChild(containerDiv);
        });
        
        cardSelectionModal.style.display = 'flex';

        const countdownEl = document.getElementById('cardSelectionCountdown');
        let timeLeft = Math.round((sessionData.expirationTimestamp - getSyncedTime()) / 1000);

        const handleTimeout = () => {
            if (cardSelectionModal.style.display === 'flex') {
                const sessionResultRef = db.ref('surprise_box_session/result');
                sessionResultRef.once('value').then(snap => {
                    if(!snap.exists()){
                        displayMessage("SÃ¼re dolduÄŸu iÃ§in kart seÃ§emedin!");
                        closeCardSelectionModal();
                        db.ref('surprise_box_session').remove();
                    }
                });
            }
        };

        if (timeLeft <= 0) {
            handleTimeout();
            return;
        }

        countdownEl.textContent = timeLeft;
        countdownInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft >= 0) {
                countdownEl.textContent = timeLeft;
            } else {
                clearInterval(countdownInterval);
                handleTimeout();
            }
        }, 1000);
    });
}


function revealMyCardChoice(sessionData) {
    if (countdownInterval) clearInterval(countdownInterval);
    document.getElementById('cardSelectionCountdown').textContent = 'SeÃ§im YapÄ±ldÄ±!';

    const selectedCardIndex = sessionData.selection.cardIndex;
    
    const cardContainer = document.querySelector('#cardSelectionModal .card-container');
    const allCards = cardContainer.querySelectorAll('.card-flip-container');

    sessionData.cards.forEach((cardValue, index) => {
        const cardEl = allCards[index];
        if (cardEl) {
            const cardBack = cardEl.querySelector('.card-back');
            const realPoints = cardValue * (sessionData.multiplier || 1);
            
            cardBack.innerHTML = `<div class="w-full h-full flex items-center justify-center text-3xl font-bold text-yellow-300 bg-gray-900 rounded-xl border-2 border-gray-700">+${realPoints}</div>`;
            
            cardEl.classList.add('flipped');
            
            if (index == selectedCardIndex) {
                cardEl.querySelector('.card-flipper').classList.add('border-4', 'border-yellow-400', 'rounded-xl', 'shadow-lg', 'shadow-yellow-400/50');
            }
        }
    });
}

// MEVCUT selectCard FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR
async function selectCard(selectedCardDiv, userId) {
    // AnÄ±nda koruma: Bir kart seÃ§ildiÄŸi anda diÄŸer tÃ¼m kartlarÄ±n tÄ±klanmasÄ±nÄ± engelle.
    const cardContainer = document.getElementById('playerCardContainer');
    const allCards = cardContainer.querySelectorAll('.card-flip-container');
    allCards.forEach(card => {
        card.onclick = null;
        card.style.cursor = 'default';
    });

    if (countdownInterval) clearInterval(countdownInterval);

    const cardIndex = selectedCardDiv.dataset.index;
    const sessionRef = db.ref('surprise_box_session');

    // Garantili koruma: Firebase Transaction ile sunucu tarafÄ±nda sadece Ä°LK isteÄŸi kabul et.
    const transactionResult = await sessionRef.transaction(sessionData => {
        if (!sessionData || sessionData.selection) {
            return; // Ä°ÅŸlemi iptal et, Ã§Ã¼nkÃ¼ zaten bir seÃ§im yapÄ±lmÄ±ÅŸ.
        }
        sessionData.selection = { user: userId, cardIndex: cardIndex };
        return sessionData;
    });

    // Sadece iÅŸlem baÅŸarÄ±lÄ± olduysa (yani ilk seÃ§imi bu kullanÄ±cÄ± yaptÄ±ysa) devam et.
    if (!transactionResult.committed) {
        console.log("Bu kart zaten seÃ§ilmiÅŸ veya oturum sÃ¼resi dolmuÅŸ.");
        return;
    }

    const updatedSessionData = transactionResult.snapshot.val();
    
    // â˜…â˜…â˜… HATAYI GÄ°DEREN GÃœNCELLEME BURADA BAÅLIYOR â˜…â˜…â˜…
    
    // 1. KartÄ±n temel (Ã§arpansÄ±z) puanÄ±nÄ± alÄ±yoruz.
    const basePoints = parseInt(selectedCardDiv.dataset.value);
    // 2. Aktif olan Ã§arpanÄ± alÄ±yoruz (yoksa 1).
    const multiplier = updatedSessionData.multiplier || 1;
    // 3. KullanÄ±cÄ±nÄ±n gerÃ§ekten kazanacaÄŸÄ±, Ã§arpÄ±lmÄ±ÅŸ nihai puanÄ± hesaplÄ±yoruz.
    const finalMultipliedPoints = basePoints * multiplier;

    const userRef = db.ref('users/' + userId);

    // 4. PuanlarÄ± eklerken, Ã§arpÄ±lmÄ±ÅŸ olan 'finalMultipliedPoints' deÄŸerini kullanÄ±yoruz.
    await userRef.transaction(user => {
        if (user) {
            user.balance = (user.balance || 0) + finalMultipliedPoints;
            user.kariyerPuani = (user.kariyerPuani || 0) + finalMultipliedPoints;
        }
        return user;
    });

    const finalUserSnap = await userRef.once('value');
    const newBalance = finalUserSnap.val().balance || 0;
 
    // 5. Sonucu Firebase'e yazarken, loglarÄ±n doÄŸru gÃ¶rÃ¼nmesi iÃ§in 'points' alanÄ±na TEMEL (Ã§arpansÄ±z) puanÄ± kaydediyoruz.
    // Puan zaten hesaba doÄŸru eklendiÄŸi iÃ§in bu sadece gÃ¶rsel bir dÃ¼zeltmedir.
    await sessionRef.child('result').set({ points: basePoints, newBalance: newBalance });

    // â˜…â˜…â˜… GÃœNCELLEME BURADA BÄ°TÄ°YOR â˜…â˜…â˜…
}

// --- YENÄ° VE GÃœNCEL SÃœRPRÄ°Z KUTU DÄ°NLEME FONKSÄ°YONU ---

let isProcessingSurpriseResult = false;
let spectatorViewingResult = false;

// MEVCUT listenForSurpriseBox FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR
function listenForSurpriseBox() {
    const sessionRef = db.ref('surprise_box_session');
    
    if (activeListeners.surpriseBox) {
        activeListeners.surpriseBox.ref.off(activeListeners.surpriseBox.event, activeListeners.surpriseBox.callback);
    }

    const callback = snap => {
        const sessionData = snap.val();

        if (sessionData && sessionData.active && !sessionData.result) {
            const sessionAge = getSyncedTime() - sessionData.timestamp;
            if (sessionAge > 70000) {
                console.log("Zaman aÅŸÄ±mÄ±na uÄŸramÄ±ÅŸ SÃ¼rpriz Kutu oturumu temizleniyor...");
                sessionRef.remove();
                return; 
            }
        }

        if (sessionData && sessionData.active) {
            if (sessionData.user === currentUser && !sessionData.result && cardSelectionModal.style.display !== 'flex') {
                openCardSelectionModal(currentUser);
            }
            
            if (sessionData.user !== currentUser && !sessionData.result && sessionData.expirationTimestamp && spectatorModal.style.display !== 'flex' && !isProcessingSurpriseResult) {
                openSpectatorModal(sessionData);
            }
            
            if (sessionData.result) {
                if (sessionData.user === currentUser && cardSelectionModal.style.display === 'flex') {
                    revealMyCardChoice(sessionData);
                } else if (spectatorModal.style.display === 'flex') {
                    updateSpectatorView(sessionData);
                }
            }

            if (sessionData.result && !sessionData.logged && !isProcessingSurpriseResult) {
                isProcessingSurpriseResult = true; 

                sessionRef.transaction(currentData => {
                    if (currentData && currentData.result && !currentData.logged) {
                        currentData.logged = true; 
                        return currentData;
                    }
                    return; 
                }, (error, committed, snapshot) => {
                    if (error) {
                        console.error('SÃ¼rpriz kutu iÅŸlemi sÄ±rasÄ±nda transaction hatasÄ±: ', error);
                        isProcessingSurpriseResult = false;
                    } else if (committed) {
                        const finalSessionData = snapshot.val();

                        // â˜…â˜…â˜… LOGLAMA Ä°Ã‡Ä°N GÃœNCELLENEN KISIM BAÅLANGICI â˜…â˜…â˜…
                        // GerÃ§ekten kazanÄ±lan, Ã§arpÄ±lmÄ±ÅŸ puanÄ± hesaplÄ±yoruz.
                        const finalPointsForLog = finalSessionData.result.points * (finalSessionData.multiplier || 1);
                        // â˜…â˜…â˜… GÃœNCELLENEN KISIM SONU â˜…â˜…â˜…

                        const surpriseInfo = {
                            finder: finalSessionData.user,
                            boxId: finalSessionData.boxId,
                            points: finalSessionData.result.points, // Ana panele temel puanÄ± gÃ¶nderiyoruz
                            newBalance: finalSessionData.result.newBalance,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            multiplier: finalSessionData.multiplier || 1
                        };

                        if (finalSessionData.boxId === 'Ã‡ark') {
                            db.ref('gameStats/lastWheelSurpriseInfo').set(surpriseInfo);
                        } else {
                            surpriseInfo.boxesOpenedThisRound = finalSessionData.boxesOpenedThisRound || null;
                            surpriseInfo.resettledBy = null;
                            surpriseInfo.resettled = false;
                            db.ref('gameStats/lastSurpriseInfo').set(surpriseInfo);
                        }
                        
                        logActivity('surpriseBox', finalSessionData.user, { 
                            boxId: finalSessionData.boxId,
                            points: finalPointsForLog, // "Son Eylemler" paneline Ã‡ARPILMIÅ puanÄ± gÃ¶nderiyoruz
                            multiplier: finalSessionData.multiplier,
                            newBalance: finalSessionData.result.newBalance
                        });
                        
                        setTimeout(() => {
                            if (finalSessionData.user === currentUser) {
                                closeCardSelectionModal();
                            } else {
                                showGlobalSurpriseBoxNotification(finalSessionData);
                            }
                            
                            setTimeout(() => {
                                closeGlobalSurpriseBoxModal(); 
                                handleSurpriseBoxCleanup(finalSessionData);
                                isProcessingSurpriseResult = false;
                            }, 4000);
                        }, 3000);
                    } else {
                        isProcessingSurpriseResult = false;
                    }
                });
            }
        } else {
            if (!spectatorViewingResult) {
                closeSpectatorModal();
            }
        }
    };

    activeListeners.surpriseBox = { ref: sessionRef, event: 'value', callback };
    sessionRef.on('value', callback);
}
      
// SÃ¼rpriz Kutu bilgilendirme penceresini GÃ–STEREN fonksiyon
function showGlobalSurpriseBoxNotification(data) {
    document.getElementById('surpriseOpener').textContent = data.user;
    
    const sourceInfoEl = document.getElementById('surpriseSourceInfo');
    if (data.boxId === 'Ã‡ark') {
        sourceInfoEl.innerHTML = `<b>Åans Ã‡arkÄ±</b>'ndan SÃ¼rpriz Kutu elde etti ve kart seÃ§iminden`;
    } else {
        sourceInfoEl.innerHTML = `<span class="text-red-400 font-bold">${data.boxId}</span> numaralÄ± kutuyu aÃ§tÄ± ve kart seÃ§iminden`;
    }

    document.getElementById('surprisePoints').textContent = data.result.points;
    
    let multiplierText = '';
    if (data.boxId !== 'Ã‡ark') {
        if (data.multiplier && data.multiplier > 1) {
            const basePoints = Math.round(data.result.points / data.multiplier);
            multiplierText = `kazandÄ±! <br><span class="text-base text-gray-400">(${basePoints} Puan x ${data.multiplier} Ã‡arpan)</span>`;
        } else {
            multiplierText = 'kazandÄ±! (Ã‡arpan kullanÄ±lmadÄ±)';
        }
    } else {
        multiplierText = 'kazandÄ±!';
    }

    document.getElementById('surpriseMultiplierInfo').innerHTML = multiplierText;

    document.getElementById('globalSurpriseBoxModal').style.display = 'flex';
}

// --- SORUNU Ã‡Ã–ZEN EKSÄ°K FONKSÄ°YON ---
// SÃ¼rpriz Kutu bilgilendirme penceresini KAPATAN fonksiyon
function closeGlobalSurpriseBoxModal() {
    const modal = document.getElementById('globalSurpriseBoxModal');
    if (modal) {
        modal.style.display = 'none';
    }
}
      
  function closeCardSelectionModal() { 
    cardSelectionModal.style.display = 'none'; 
  }
  
  const storeItemsRef = db.ref('storeItems');

  function openNewItemForm() {
    resetStoreItemForm();
    openAdminStoreModal();
  }

  function openAdminStoreModal() {
    document.getElementById('gameDiv').classList.add('modal-is-open');
    adminStoreModal.style.display = 'flex';
  }

  // Bu fonksiyon, "ÃœrÃ¼n Ekle / DÃ¼zenle" panelini kapatÄ±r.
function closeAdminStoreModal() {
    document.getElementById('gameDiv').classList.remove('modal-is-open');
    adminStoreModal.style.display = 'none';
    resetStoreItemForm();
}
  
  // ESKÄ° loadStoreItems FONKSÄ°YONUNU SÄ°LÄ°N VE BUNU EKLEYÄ°N

function loadStoreItems() {
    // Ã–nceki dinleyicileri temizle
    if (activeListeners.storeItems) {
        activeListeners.storeItems.ref.off('value', activeListeners.storeItems.callback);
    }
    if (activeListeners.userPotionCounts) {
        activeListeners.userPotionCounts.ref.off('value', activeListeners.userPotionCounts.callback);
    }

    const itemsRef = db.ref('storeItems');
    const userRef = db.ref(`users/${currentUser}`);

    // TÃ¼m verileri tek bir yerde tutmak iÃ§in bir obje
    let combinedData = {
        items: null,
        userData: null
    };

    // Her iki veri de yÃ¼klendiÄŸinde maÄŸazayÄ± yeniden Ã§izen fonksiyon
    const renderIfReady = () => {
        if (combinedData.items !== null && combinedData.userData !== null) {
            renderStoreItems(combinedData.items, combinedData.userData);
        }
    };
    
    // 1. MaÄŸaza Ã¼rÃ¼nlerini dinle
    const itemsCallback = snap => {
        combinedData.items = snap.val();
        renderIfReady();
    };
    activeListeners.storeItems = { ref: itemsRef, event: 'value', callback: itemsCallback };
    itemsRef.on('value', itemsCallback);

    // 2. KullanÄ±cÄ±nÄ±n iksir satÄ±n alma sayÄ±larÄ±nÄ± dinle
    const userCallback = snap => {
        combinedData.userData = snap.val();
        renderIfReady();
    };
    activeListeners.userPotionCounts = { ref: userRef, event: 'value', callback: userCallback };
    userRef.on('value', userCallback);
}


  
  function updateStoreCountdowns() {
      const now = Date.now();
      for (const itemId in activeStoreCountdowns) {
          const { endTime } = activeStoreCountdowns[itemId];
          const countdownEl = document.getElementById(`countdown-${itemId}`);
          const buyButton = document.getElementById(`buy-btn-${itemId}`);
          
          if (!countdownEl) continue;

          const timeLeft = endTime - now;

          if (timeLeft > 0) {
              const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
              const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
              const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
              const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
              
              let parts = [];
              if (days > 0) parts.push(`${days}g`);
              if (hours > 0) parts.push(`${hours}sa`);
              if (minutes > 0) parts.push(`${minutes}d`);
              if (seconds >= 0) parts.push(`${seconds}sn`);
              
              const timeString = parts.join(' ');

              countdownEl.innerHTML = `Kalan SÃ¼re: <b class="text-white">${timeString}</b>`;
          } else {
              countdownEl.innerHTML = `<span class="text-red-500 font-bold">SÃ¼re Doldu</span>`;
              if (buyButton) {
                  buyButton.disabled = true;
                  buyButton.classList.add('bg-gray-600', 'cursor-not-allowed');
                  buyButton.classList.remove('bg-red-700', 'hover:bg-red-600');
              }
              delete activeStoreCountdowns[itemId];
          }
      }
  }

  // MEVCUT renderStoreItems FONKSÄ°YONUNU SÄ°LÄ°P BU YENÄ° VERSÄ°YONU YAPIÅTIRIN
async function renderStoreItems(items, userData = {}) {
    const gameContainer = document.getElementById('gameStoreItemsContainer');
    const specialContainer = document.getElementById('specialStoreItemsContainer');
    const gameTabBtn = document.getElementById('gameStoreTabBtn');
    const specialTabBtn = document.getElementById('specialStoreTabBtn');

    gameContainer.innerHTML = '';
    specialContainer.innerHTML = '';

    if (storeCountdownInterval) clearInterval(storeCountdownInterval);
    activeStoreCountdowns = {};

    if (!items) {
        const placeholder = '<p class="text-center col-span-full text-gray-400">MaÄŸazada ÅŸu an Ã¼rÃ¼n bulunmamaktadÄ±r.</p>';
        gameContainer.innerHTML = placeholder;
        specialContainer.innerHTML = placeholder;
        return;
    }

    const renderItem = (itemData, container) => {
        const [itemId, item] = itemData;
        const isSpecial = item.type === 'special';
        const potionPurchaseCounts = (userData && userData.potionPurchaseCounts) ? userData.potionPurchaseCounts : {};

        const monsterStoreItemTypes = [
            'revival_stone', 'health_potion', 'damage_potion', 'defense_potion',
            'crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion',
            'health_regen_potion'
        ];
        const isPotion = monsterStoreItemTypes.includes(item.type);
        let currentCost = item.cost;

        // â˜…â˜…â˜… HATA BURADAYDI VE DÃœZELTÄ°LDÄ° â˜…â˜…â˜…
        // ArtÄ±k fiyat hesaplanÄ±rken, Ã¼rÃ¼nÃ¼n kendi 'priceIncrease' deÄŸeri okunuyor.
        // Bu sayede, admin panelinde 0 olarak ayarlanan artÄ±ÅŸlar doÄŸru bir ÅŸekilde fiyata yansÄ±tÄ±lÄ±yor.
        if (isPotion && !isSpecial) {
            const purchaseCount = potionPurchaseCounts[itemId] || 0;
            // 'hasOwnProperty' ile fiyat artÄ±ÅŸÄ±nÄ±n 0 olup olmadÄ±ÄŸÄ±nÄ± doÄŸru kontrol ediyoruz.
            const priceIncrease = item.hasOwnProperty('priceIncrease') ? item.priceIncrease : 1000;
            currentCost = item.cost + (purchaseCount * priceIncrease);
        }

        const outOfStock = item.stock !== undefined && item.stock <= 0;
        let isExpired = false;
        let countdownHtml = '';

        let adminControlsHtml = '';
        if (isAdmin) {
            const allItemsArray = Object.entries(items);
            const listForReorder = isSpecial ? allItemsArray.filter(i => i[1].type === 'special') : allItemsArray.filter(i => i[1].type !== 'special' && !monsterStoreItemTypes.includes(i[1].type));
            const index = listForReorder.findIndex(([id]) => id === itemId);
            const leftArrowDisabled = index === 0 ? 'disabled' : '';
            const rightArrowDisabled = index === listForReorder.length - 1 ? 'disabled' : '';
            adminControlsHtml = `
            <div class="admin-controls absolute top-0 right-0 p-1 bg-gray-900 bg-opacity-70 rounded-bl-lg flex gap-1 z-10">
                <button onclick="reorderStoreItem('${itemId}', ${index - 1})" ${leftArrowDisabled} title="Sola TaÅŸÄ±" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/></svg>
                </button>
                <button onclick="editStoreItem('${itemId}')" title="DÃ¼zenle" class="p-1 rounded-full hover:bg-gray-700">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a1 1 0 011-1h2.586l-2 2H6v3h3v-1.586l2-2H13a1 1 0 011 1v5a1 1 0 01-1 1H6a1 1 0 01-1-1v-2z"/></svg>
                </button>
                 <button onclick="deleteStoreItem('${itemId}')" title="Sil" class="p-1 rounded-full hover:bg-gray-700">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"/></svg>
                </button>
                <button onclick="reorderStoreItem('${itemId}', ${index + 1})" ${rightArrowDisabled} title="SaÄŸa TaÅŸÄ±" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>
                </button>
            </div>`;
        }

        if (item.countdownDurationMinutes && item.createdAt) {
            const endTime = item.createdAt + item.countdownDurationMinutes * 60 * 1000;
            if (Date.now() > endTime) {
                isExpired = true;
            } else {
                activeStoreCountdowns[itemId] = { endTime: endTime };
                countdownHtml = `<div id="countdown-${itemId}" class="text-sm text-yellow-300 font-bold mb-2 h-5"></div>`;
            }
        } else {
            countdownHtml = `<div class="h-5 mb-2"></div>`;
        }

        const disabled = outOfStock || isExpired;
        
        const priceText = isSpecial ? `${formatNumber(currentCost)} KP` : `${formatNumber(currentCost)} Puan`;

        const cardDiv = document.createElement('div');
        cardDiv.className = `relative bg-gray-800 p-6 rounded-xl shadow-lg border-2 border-red-700 text-center flex flex-col justify-between`;
        cardDiv.innerHTML = `
            ${adminControlsHtml}
            <div class="flex-grow">
              <img src="${item.imageUrl || 'https://via.placeholder.com/150'}" alt="${item.name}" class="w-24 h-24 mx-auto mb-4 rounded-lg object-cover">
              <h4 class="text-yellow-400 text-xl font-bold">${item.name}</h4>
              <p class="text-gray-300 mb-2 flex-grow">${item.description}</p>
            </div>
            <div>
              ${countdownHtml}
              <p class="text-gray-400 text-sm mb-2">Stok: ${item.stock !== undefined && item.stock !== null ? item.stock : 'SÄ±nÄ±rsÄ±z'}</p>
              <p class="text-green-400 text-2xl font-bold mb-4" id="price-${itemId}">${priceText}</p>
              <button id="buy-btn-${itemId}" onclick="buyItem('${itemId}')" ${disabled ? 'disabled' : ''} class="w-full py-3 mt-auto ${disabled ? 'bg-gray-600 cursor-not-allowed' : 'bg-red-700 hover:bg-red-600'} text-white font-bold rounded-lg transition duration-300">
                ${isExpired ? 'SÃ¼re Doldu' : (outOfStock ? 'Stok TÃ¼kendi' : 'SatÄ±n Al')}
              </button>
            </div>
          `;
        container.appendChild(cardDiv);
    };

    let allItemsArray = Object.entries(items);

    const monsterStoreItemTypes = [
        'revival_stone', 'health_potion', 'damage_potion', 'defense_potion',
        'crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion',
        'health_regen_potion'
    ];

    if (storeFilter === 'monster_battle') {
        const monsterItems = allItemsArray
            .filter(([, item]) => monsterStoreItemTypes.includes(item.type))
            .sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

        if (monsterItems.length > 0) {
            monsterItems.forEach(itemData => renderItem(itemData, gameContainer));
        } else {
            gameContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">Canavar MaÄŸazasÄ±\'nda Ã¼rÃ¼n bulunmamaktadÄ±r.</p>';
        }

        if (specialTabBtn) specialTabBtn.style.display = 'none';
        if (specialContainer) specialContainer.style.display = 'none';

        if (gameTabBtn) {
            gameTabBtn.classList.add('border-red-500', 'text-white');
            gameTabBtn.classList.remove('border-transparent', 'text-gray-400');
        }
        document.getElementById('gameStoreItemsContainer').classList.remove('hidden');

    } else {
        const gameItems = allItemsArray
            .filter(([, item]) => item.type !== 'special' && !monsterStoreItemTypes.includes(item.type))
            .sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

        const specialItems = allItemsArray
            .filter(([, item]) => item.type === 'special')
            .sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

        if (specialTabBtn) specialTabBtn.style.display = 'flex';

        if (gameItems.length > 0) {
            gameItems.forEach(itemData => renderItem(itemData, gameContainer));
        } else {
            gameContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">Oyun MaÄŸazasÄ±\'nda Ã¼rÃ¼n bulunmamaktadÄ±r.</p>';
        }

        if (specialItems.length > 0) {
            specialItems.forEach(itemData => renderItem(itemData, specialContainer));
        } else {
            specialContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">Ã–zel ÃœrÃ¼n MaÄŸazasÄ±\'nda Ã¼rÃ¼n bulunmamaktadÄ±r.</p>';
        }
    }
    
    if (Object.keys(activeStoreCountdowns).length > 0) {
        updateStoreCountdowns();
        storeCountdownInterval = setInterval(updateStoreCountdowns, 1000);
    }
}
  
  // DEÄÄ°ÅTÄ°RÄ°LECEK FONKSÄ°YON
async function reorderStoreItem(itemId, newIndex) {
    if (!isAdmin) return;
    const itemsRef = db.ref('storeItems');
    const itemsSnap = await itemsRef.once('value');
    const items = itemsSnap.val();
    if (!items) return;

    const itemType = items[itemId].type;

    let allItemsArray = Object.entries(items);
    let gameItems = allItemsArray.filter(([, item]) => item.type !== 'special').sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));
    let specialItems = allItemsArray.filter(([, item]) => item.type === 'special').sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

    let listToModify = (itemType === 'special') ? specialItems : gameItems;

    const itemToMoveIndex = listToModify.findIndex(([id]) => id === itemId);
    if (itemToMoveIndex === -1) return;

    if (newIndex < 0 || newIndex >= listToModify.length) return;

    const [movedItem] = listToModify.splice(itemToMoveIndex, 1);
    listToModify.splice(newIndex, 0, movedItem);

    const finalCombinedList = [...gameItems, ...specialItems];

    const updates = {};
    finalCombinedList.forEach(([id], index) => {
        updates[`storeItems/${id}/order`] = index;
    });

    await db.ref().update(updates);
}

// YENÄ° YARDIMCI FONKSÄ°YON: Admin panelinde seÃ§ilen Ã¼rÃ¼n tÃ¼rÃ¼ne gÃ¶re inputlarÄ± ayarlar.
function handleStoreItemTypeChange() {
    const type = document.getElementById('newItemType').value;
    const durationInput = document.getElementById('newItemMultiplierDuration');
    const priceIncreaseInput = document.getElementById('newItemPriceIncrease');
    const valueInput = document.getElementById('newItemValue');

    const percentPotions = ['defense_potion', 'crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion'];
    
    // VarsayÄ±lan placeholder'Ä± ayarla
    valueInput.placeholder = 'DeÄŸer (Adet / Ã‡arpan DeÄŸeri)';

    if (type === 'tempMultiplier') {
        durationInput.classList.remove('hidden');
        priceIncreaseInput.classList.add('hidden');
    } else if (type.endsWith('_potion')) { // TÃ¼m iksir tÃ¼rleri iÃ§in
        durationInput.classList.add('hidden');
        priceIncreaseInput.classList.remove('hidden'); // Fiyat artÄ±ÅŸ alanÄ±nÄ± gÃ¶ster
        if (percentPotions.includes(type)) {
            valueInput.placeholder = 'DeÄŸer (Ã¶rn: 2.5)'; // YÃ¼zdelikse placeholder'Ä± deÄŸiÅŸtir
        }
    } else {
        durationInput.classList.add('hidden');
        priceIncreaseInput.classList.add('hidden');
    }
}

// GÃœNCELLENMÄ°Å FONKSÄ°YON
function resetStoreItemForm() {
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemDescription').value = '';
    document.getElementById('newItemCost').value = '';
    document.getElementById('newItemStock').value = '';
    document.getElementById('newItemType').value = '';
    document.getElementById('newItemValue').value = '';
    document.getElementById('newItemMultiplierDuration').value = '';
    document.getElementById('newItemPriceIncrease').value = ''; // Yeni alanÄ± da temizle
    
    document.getElementById('storeItemCountdownDays').value = '';
    document.getElementById('storeItemCountdownHours').value = '';
    document.getElementById('storeItemCountdownMinutes').value = '';
    document.getElementById('storeItemCountdownSeconds').value = '';

    document.getElementById('newItemImageUrl').value = '';
    document.getElementById('addUpdateStoreItemBtn').textContent = 'ÃœRÃœN EKLE';
    
    // Formu gÃ¶rsel olarak sÄ±fÄ±rla
    handleStoreItemTypeChange();
    
    editingItemId = null; 
}

// GÃœNCELLENMÄ°Å FONKSÄ°YON
async function saveStoreItem() {
    if (!isAdmin) return;

    try {
        const name = document.getElementById('newItemName').value.trim();
        const description = document.getElementById('newItemDescription').value.trim();
        const cost = parseInt(document.getElementById('newItemCost').value);
        const type = document.getElementById('newItemType').value;
        const imageUrl = document.getElementById('newItemImageUrl').value.trim();
        let stockInput = document.getElementById('newItemStock').value;

        const days = parseInt(document.getElementById('storeItemCountdownDays').value) || 0;
        const hours = parseInt(document.getElementById('storeItemCountdownHours').value) || 0;
        const minutes = parseInt(document.getElementById('storeItemCountdownMinutes').value) || 0;
        const seconds = parseInt(document.getElementById('storeItemCountdownSeconds').value) || 0;
        const totalMinutes = (days * 24 * 60) + (hours * 60) + minutes + Math.round(seconds / 60);

        if (!name || !description || isNaN(cost) || !type) {
            displayMessage("LÃ¼tfen Ad, AÃ§Ä±klama, Maliyet ve Tip alanlarÄ±nÄ± doldurun.");
            return;
        }

        const stock = (stockInput === '' || stockInput === null) ? null : parseInt(stockInput);
        const itemData = { name, description, cost, stock, type, imageUrl: imageUrl || 'https://via.placeholder.com/150' };

        // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA: Fiyat artÄ±ÅŸÄ± 0 olduÄŸunda bile Ã§alÄ±ÅŸacak ÅŸekilde dÃ¼zeltildi â˜…â˜…â˜…
        if (type.endsWith('_potion')) {
            const priceIncreaseInput = document.getElementById('newItemPriceIncrease').value;
            // Input boÅŸsa 0, doluysa sayÄ±sal deÄŸerini al.
            const priceIncrease = priceIncreaseInput === '' ? 0 : parseInt(priceIncreaseInput);
            if (isNaN(priceIncrease) || priceIncrease < 0) {
                throw new Error("Ä°ksirler iÃ§in geÃ§erli bir 'Fiyat ArtÄ±ÅŸÄ±' (0 veya daha bÃ¼yÃ¼k) girmelisiniz.");
            }
            itemData.priceIncrease = priceIncrease;
        }

        if (type === 'tempMultiplier') {
            const value = parseInt(document.getElementById('newItemValue').value);
            const multiplierDuration = parseInt(document.getElementById('newItemMultiplierDuration').value);
            if (isNaN(value) || value <= 0) { throw new Error("Ã‡arpan iÃ§in geÃ§erli bir 'DeÄŸer' (2x, 3x gibi) girmelisiniz."); }
            if (isNaN(multiplierDuration) || multiplierDuration <= 0) { throw new Error("Ã‡arpan iÃ§in geÃ§erli bir 'KullanÄ±m SayÄ±sÄ±' girmelisiniz."); }
            itemData.value = value;
            itemData.duration = multiplierDuration;
        } else {
            const typesThatNeedValue = [
                'boxRights', 'wheelTicket', 'clickCatchTicket', 'iflasShield', 'wildcard', 
                'card_pack', 'card_pack_normal', 'card_pack_gumus', 'card_pack_altin', 'card_pack_efsanevi',
                'health_regen_potion', 'revival_stone', 'health_potion', 'damage_potion', 'defense_potion', 
                'crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion'
            ];

            if (typesThatNeedValue.includes(type)) {
                // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA: ArtÄ±k ondalÄ±klÄ± sayÄ±larÄ± doÄŸru iÅŸleyen 'parseStatValue' fonksiyonunu kullanÄ±yoruz. â˜…â˜…â˜…
                const value = parseStatValue(type, document.getElementById('newItemValue').value);
                if (isNaN(value) || value <= 0) {
                    const friendlyName = typeToName[type] || type;
                    throw new Error(`'${friendlyName}' tipi iÃ§in geÃ§erli bir 'DeÄŸer/Adet' girmelisiniz.`);
                }
                itemData.value = value;
            }
        }

        if (totalMinutes > 0) { itemData.countdownDurationMinutes = totalMinutes; } 
        else { itemData.countdownDurationMinutes = null; }

        if (editingItemId) {
            const existingItemSnap = await storeItemsRef.child(editingItemId).once('value');
            const existingItem = existingItemSnap.val();
            itemData.createdAt = existingItem.createdAt || firebase.database.ServerValue.TIMESTAMP;
            itemData.order = existingItem.order;
            itemData.purchaseCount = existingItem.purchaseCount || 0;
            await storeItemsRef.child(editingItemId).update(itemData);
            displayMessage(`'${name}' Ã¼rÃ¼nÃ¼ baÅŸarÄ±yla gÃ¼ncellendi!`);
        } else {
            itemData.createdAt = firebase.database.ServerValue.TIMESTAMP;
            itemData.purchaseCount = 0;
            const maxOrderSnap = await storeItemsRef.orderByChild('order').limitToLast(1).once('value');
            let maxOrder = -1;
            if (maxOrderSnap.exists()) { maxOrder = Object.values(maxOrderSnap.val())[0].order || 0; }
            itemData.order = maxOrder + 1;
            await storeItemsRef.push(itemData);
            displayMessage(`'${name}' Ã¼rÃ¼nÃ¼ baÅŸarÄ±yla eklendi!`);
        }
        
        closeAdminStoreModal();
        loadStoreItems();

    } catch (error) {
        console.error("MaÄŸaza Ã¼rÃ¼nÃ¼ kaydetme hatasÄ±:", error);
        displayMessage("ÃœrÃ¼n kaydedilirken bir hata oluÅŸtu: " + error.message);
    }
}

  async function deleteStoreItem(itemId) {
      if (!isAdmin) return;
      if (await customConfirm("Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!")) {
          try {
              await storeItemsRef.child(itemId).remove();
              displayMessage("ÃœrÃ¼n baÅŸarÄ±yla silindi.");
          } catch (error) {
              console.error("ÃœrÃ¼n silme hatasÄ±:", error);
              displayMessage("ÃœrÃ¼n silinirken bir hata oluÅŸtu.");
          }
      }
  }

  function openPurchaseHistoryModal() {
      loadPurchaseHistory();
      purchaseHistoryModal.style.display = 'flex';
  }
  function closePurchaseHistoryModal() {
      purchaseHistoryModal.style.display = 'none';
  }
  
  function loadPurchaseHistory() {
      const list = document.getElementById('purchaseHistoryList');
      list.innerHTML = "<div class='text-center text-gray-400'>YÃ¼kleniyor...</div>";
      let ref = db.ref('purchaseHistory');
      
      // Admin deÄŸilse sadece kendi geÃ§miÅŸini gÃ¶rsÃ¼n
      if (!isAdmin) {
          ref = ref.orderByChild('username').equalTo(currentUser);
      }

      ref.once('value').then(snap => {
          const history = snap.val();
          let html = '';
          if (!history || Object.keys(history).length === 0) {
              list.innerHTML = `<div class='text-center text-gray-400'>${isAdmin ? 'HiÃ§bir satÄ±n alma iÅŸlemi yapÄ±lmamÄ±ÅŸ.' : 'HenÃ¼z bir satÄ±n alma iÅŸlemi yapmadÄ±nÄ±z.'}</div>`;
              return;
          }
          
          // YENÄ°: AnahtarlarÄ± (ID'leri) kaybetmemek iÃ§in Object.entries kullanÄ±yoruz
          const sorted = Object.entries(history).sort(([, a], [, b]) => b.timestamp - a.timestamp);

          sorted.forEach(([key, r]) => { // key = purchaseId
              let statusBadge = '';
              if (r.status === 'pending') {
                  statusBadge = '<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200">Beklemede</span>';
              } else if (r.status === 'denied') {
                  statusBadge = '<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-red-600 bg-red-200">Reddedildi</span>';
              }

              // YENÄ°: Admin ise silme butonu ekliyoruz
              const deleteButton = isAdmin ? `
                <button onclick="deletePurchase('${key}')" class="ml-4 p-2 text-gray-400 hover:text-red-500 rounded-full transition-colors" title="Bu alÄ±mÄ± sil ve iade et">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
              ` : '';

              html += `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 mb-3 bg-gray-700 rounded-lg border-l-4 border-red-500">
                    <div class="flex items-center mb-2 sm:mb-0">
                        <img src="${r.imageUrl || 'https://via.placeholder.com/150'}" alt="${r.itemName}" class="w-12 h-12 rounded-md mr-4 object-cover">
                        <div>
                            <p class="font-bold text-lg text-yellow-300">${r.itemName}</p>
                            <p class="text-sm text-gray-300">Maliyet: ${r.itemCost} ${r.purchaseType === 'kasaPuani' ? 'KP' : 'Puan'}</p>
                        </div>
                    </div>
                    <div class="flex items-center w-full sm:w-auto">
                        <div class="text-xs text-gray-400 text-right flex-grow">
                            ${new Date(r.timestamp).toLocaleString()}
                            ${isAdmin ? `<br><span class="font-semibold text-white">${r.username}</span>` : ''}
                            ${statusBadge ? `<br class="mt-1">${statusBadge}` : ''}
                        </div>
                        ${deleteButton}
                    </div>
                </div>
              `;
          });
          list.innerHTML = html;
      });
  }

    // DEÄÄ°ÅTÄ°RÄ°LECEK FONKSÄ°YON
async function deletePurchase(purchaseId) {
    if (!isAdmin) return;

    const confirmed = await customConfirm("Bu satÄ±n alÄ±mÄ± silmek istediÄŸinizden emin misiniz? Puanlar kullanÄ±cÄ±ya iade edilecek, Ã¼rÃ¼n istatistikleri gÃ¼ncellenecektir.");
    if (!confirmed) return;

    try {
        const purchaseRef = db.ref(`purchaseHistory/${purchaseId}`);
        const purchaseSnap = await purchaseRef.once('value');
        const purchaseData = purchaseSnap.val();

        if (!purchaseData) {
            displayMessage("Hata: Silinecek satÄ±n alÄ±m kaydÄ± bulunamadÄ±.");
            return;
        }

        const { username, itemName, itemCost } = purchaseData;
        const userRef = db.ref(`users/${username}`);
        const storeItemsRef = db.ref('storeItems');

        const itemsSnap = await storeItemsRef.orderByChild('name').equalTo(itemName).once('value');
        let originalItemId = null;
        let originalItem = null;
        if (itemsSnap.exists()) {
            originalItemId = Object.keys(itemsSnap.val())[0];
            originalItem = itemsSnap.val()[originalItemId];
        }

        const userSnap = await userRef.once('value');
        const userData = userSnap.val();
        if (!userData) {
            displayMessage(`Hata: ${username} adlÄ± kullanÄ±cÄ± bulunamadÄ±.`);
            await purchaseRef.remove(); // KullanÄ±cÄ± yoksa bile geÃ§miÅŸi sil
            return;
        }

        const updates = {};
        
        updates[`/users/${username}/balance`] = (userData.balance || 0) + itemCost;
        updates[`/users/${username}/totalSpentPoints`] = Math.max(0, (userData.totalSpentPoints || 0) - itemCost);
        
        if (originalItemId && originalItem) {
            updates[`/storeItems/${originalItemId}/purchaseCount`] = Math.max(0, (originalItem.purchaseCount || 0) - 1);
            if (originalItem.stock !== null && originalItem.stock !== undefined) {
                updates[`/storeItems/${originalItemId}/stock`] = (originalItem.stock || 0) + 1;
            }
        }

        updates[`/purchaseHistory/${purchaseId}`] = null;

        await db.ref().update(updates);

        displayMessage(`'${itemName}' alÄ±mÄ± baÅŸarÄ±yla silindi. ${username} adlÄ± kullanÄ±cÄ±ya ${itemCost} puan iade edildi.`);
        // EÄŸer modal aÃ§Ä±ksa, listeyi yenile
        if (purchaseHistoryModal.style.display === 'flex') {
            loadPurchaseHistory();
        }

    } catch (error) {
        console.error("SatÄ±n alÄ±m silinirken hata oluÅŸtu: ", error);
        displayMessage("Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu. LÃ¼tfen konsolu kontrol edin.");
    }
}
  async function clearPurchaseHistory() { if(await customConfirm("TÃ¼m satÄ±n alma geÃ§miÅŸini silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!")) { db.ref('purchaseHistory').remove().then(() => displayMessage("SatÄ±n alma geÃ§miÅŸi baÅŸarÄ±yla temizlendi.")) } }
  async function clearAllTotalSpentPoints() { if(await customConfirm("TÃ¼m kullanÄ±cÄ±larÄ±n harcadÄ±ÄŸÄ± puanlarÄ± sÄ±fÄ±rlamak istediÄŸinize emin misiniz?")) { db.ref('users').once('value').then(snap => { const updates = {}; snap.forEach(c => { if(c.key !== 'weizendtv') updates[`users/${c.key}/totalSpentPoints`] = 0; }); db.ref().update(updates).then(() => displayMessage("TÃ¼m kullanÄ±cÄ±larÄ±n harcanan puanlarÄ± sÄ±fÄ±rlandÄ±.")) }); } }
  
  function openInventoryModal() {
      const userRef = db.ref('users/' + currentUser);
      userRef.once('value').then(snap => {
          const user = snap.val();
          if (user) {
              document.getElementById('inventoryBoxRights').textContent = user.kutuHakki || 0;
              document.getElementById('inventoryWheelTickets').textContent = user.carkBileti || 0;
              // YENÄ° EKLENEN SATIR
              document.getElementById('inventoryClickCatchTickets').textContent = user.clickCatchTickets || 0;
              // YENÄ° EKLENEN SATIR BÄ°TÄ°Å
              document.getElementById('inventoryIflasShields').textContent = user.iflasShieldUses || 0;
              
              let multiplierHtml = '<p>âœ–ï¸ Aktif Ã§arpan yok.</p>';
              if (user.multiplierSource === 'store' && user.multiplierRemainingUses > 0) {
                  multiplierHtml = `<p><b>âœ–ï¸ Aktif Ã‡arpan:</b> </b> [ ${user.activeMultiplier}X - ${user.multiplierRemainingUses} ADET ] </p>`;
              } else if (user.multiplierSource === 'box') {
                  multiplierHtml = `<p><b>âœ–ï¸ Aktif Ã‡arpan:</b> </b> [ ${user.activeMultiplier}X - [ </b> 1 ADET (Otomatik) ] </p>`;
              }
              document.getElementById('inventoryMultiplierDetails').innerHTML = multiplierHtml;
          }
      });
      inventoryModal.style.display = 'flex';
  }
  function closeInventoryModal() { inventoryModal.style.display = 'none'; }
  function openBadgeInfoModal() { badgeInfoModal.style.display = 'flex'; }
  function closeBadgeInfoModal() { badgeInfoModal.style.display = 'none'; }

// MEVCUT openPublicUserDetailModal FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR
async function openPublicUserDetailModal(username) {
    if (!username) return;

    const modal = document.getElementById('publicUserDetailModal');
    if (!modal) return;

    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
    
    document.getElementById('publicUserName').textContent = `${username} yÃ¼kleniyor...`;
    document.getElementById('publicUserAvatar').src = defaultAvatarUrl;

    if (activeUserProfileListener && activeUserProfileListener.ref) {
        activeUserProfileListener.ref.off('value', activeUserProfileListener.callback);
    }

    const userRef = db.ref('users/' + username);
    
    const userProfileCallback = async (userSnap) => {
        const userData = userSnap.val();
        if (!userData) {
            closePublicUserDetailModal();
            return;
        }

        const allUsersSnap = await db.ref('users').once('value');
        const leaders = await calculateAllLeaders(allUsersSnap.val());

        const userLeaderStatus = {
            isCurrentLeader: username === leaders.currentBalanceUser,
            isHighLeader: username === leaders.highEverBalanceUser,
            isBoxLeader: username === leaders.boxUser,
            isSurpriseLeader: username === leaders.surpriseBoxUser,
            isBombLeader: username === leaders.bombUser,
            isMultiplierLeader: username === leaders.multiplierUser,
            isStoreLeader: username === leaders.spentPointsUser,
            isShieldLeader: username === leaders.shieldUser,
            isClickCatchLeader: username === leaders.clickCatchLeaderUser,
            isWheelSpinLeader: username === leaders.wheelSpinUser
        };

        const badges = getUserBadgesHtml(userData, userLeaderStatus, true);
        document.getElementById('publicUserProfileBadges').innerHTML = badges.crown + badges.others;
        
        const avatarEl = document.getElementById('publicUserAvatar');
        avatarEl.src = userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;
        avatarEl.onclick = () => openAvatarStatsModal(username);

        document.getElementById('publicUserName').textContent = username;
        
        const puanVeEnvanterDiv = document.querySelector('#publicUserDetailModal .grid .bg-gray-800\\/70:first-child .space-y-3');
        if (puanVeEnvanterDiv) {
            // --- DEÄÄ°ÅÄ°KLÄ°K BURADA: Rozetler artÄ±k doÄŸrudan HTML'in iÃ§ine ekleniyor ---
            puanVeEnvanterDiv.innerHTML = `
                <p class="flex justify-between items-center"><span>ğŸƒ Joker Kart:</span> <span class="font-bold text-purple-400 text-lg">${formatNumber(userData.wildcards || 0)}</span></p>
                <p class="flex justify-between items-center"><span>ğŸ¦ Kasa PuanÄ±:</span> <span class="font-bold text-purple-400 text-lg">${formatNumber(userData.kasaPuani || 0)}</span></p>
                <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center">${userLeaderStatus.isCurrentLeader ? 'ğŸ¥‡' : ''}</span>Mevcut PuanÄ±:</span> <span class="font-bold text-yellow-300 text-lg">${formatNumber(userData.balance || 0)}</span></p>
                <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center">${userLeaderStatus.isHighLeader ? 'ğŸ†' : ''}</span>Kariyer PuanÄ±:</span> <span class="font-bold text-green-400 text-lg">${formatNumber(userData.kariyerPuani || 0)}</span></p>
                <hr class="border-gray-600 !my-2">
                <p class="flex justify-between items-center"><span>ğŸ“¦ Kutu HakkÄ±:</span> <span class="font-bold text-green-400 text-lg">${formatNumber(userData.kutuHakki || 0)}</span></p>
                <p class="flex justify-between items-center"><span>ï¸ğŸ« Åans Ã‡arkÄ± Bileti:</span> <span class="font-bold text-yellow-400 text-lg">${formatNumber(userData.carkBileti || 0)}</span></p>
                <p class="flex justify-between items-center"><span>ğŸŸï¸ TÄ±kla-Yakala Bileti:</span> <span class="font-bold text-fuchsia-400 text-lg">${formatNumber(userData.clickCatchTickets || 0)}</span></p>
                <p class="flex justify-between items-center"><span>ğŸ›¡ï¸ Ä°flas KalkanÄ±:</span> <span class="font-bold text-blue-400 text-lg">${formatNumber(userData.iflasShieldUses || 0)}</span></p>
                <p class="flex justify-between items-center"><span>âœ–ï¸ Aktif Ã‡arpan:</span> <span id="publicUserMultiplier" class="font-bold text-purple-400 text-lg text-right"></span></p>
            `;
        }
        
        document.getElementById('badge-stat-box').innerHTML = userLeaderStatus.isBoxLeader ? 'ğŸ“¦' : '';
        document.getElementById('badge-stat-wheel').innerHTML = userLeaderStatus.isWheelSpinLeader ? 'ğŸ¡' : '';
        document.getElementById('badge-stat-clickcatch').innerHTML = userLeaderStatus.isClickCatchLeader ? 'ğŸ¯' : '';
        document.getElementById('badge-stat-surprise').innerHTML = userLeaderStatus.isSurpriseLeader ? 'ğŸ‰' : '';
        document.getElementById('badge-stat-bomb').innerHTML = userLeaderStatus.isBombLeader ? 'ğŸ’£' : '';
        document.getElementById('badge-stat-multiplier').innerHTML = userLeaderStatus.isMultiplierLeader ? 'âœ–ï¸' : '';
        document.getElementById('badge-stat-shield').innerHTML = userLeaderStatus.isShieldLeader ? 'ğŸ›¡ï¸' : '';
        document.getElementById('badge-stat-store').innerHTML = userLeaderStatus.isStoreLeader ? 'ğŸ›’' : '';

        document.getElementById('publicUserBoxesOpened').textContent = formatNumber(userData.boxesOpenedCount || 0);
        document.getElementById('publicUserWheelSpins').textContent = formatNumber(userData.wheelSpinsCount || 0);
        document.getElementById('publicUserClickCatchScore').textContent = formatNumber(userData.clickCatchHighestScore || 0);
        document.getElementById('publicUserSurpriseBoxes').textContent = formatNumber(userData.surpriseBoxesOpened || 0);
        document.getElementById('publicUserBombCount').textContent = formatNumber(userData.iflasCount || 0);
        document.getElementById('publicUserMultiplierFoundCount').textContent = formatNumber(userData.multiplierFoundCount || 0);
        document.getElementById('publicUserShieldUsedCount').textContent = formatNumber(userData.iflasShieldUsedCount || 0);
        document.getElementById('publicUserTotalSpent').textContent = formatNumber(userData.totalSpentPoints || 0);

        let multiplierText = 'Yok';
        if (userData.multiplierSource === 'store' && userData.multiplierRemainingUses > 0) {
          multiplierText = `${userData.activeMultiplier}x (MaÄŸaza - ${userData.multiplierRemainingUses} kullanÄ±m)`;
        } else if (userData.multiplierSource === 'box') {
          multiplierText = `${userData.activeMultiplier}x (Kutu - Otomatik)`;
        }
        document.getElementById('publicUserMultiplier').textContent = multiplierText;

        const championshipsDiv = document.getElementById('publicUserChampionships');
        let championshipsHtml = '';

        if (userData.puanChampionships && userData.puanChampionships.length > 0) {
            const count = userData.puanChampionships.length;
            const lastWin = userData.puanChampionships[count - 1];
            championshipsHtml += `<p>ğŸ† ${count}. Kez 'KARÄ°YER PUANI' aylÄ±k sezon ÅŸampiyonu oldu. <small class="text-gray-400">(${formatNumber(lastWin.score)} Puan ile)</small></p>`;
        }
        if (userData.rozetChampionships && userData.rozetChampionships.length > 0) {
            const count = userData.rozetChampionships.length;
            const lastWin = userData.rozetChampionships[count - 1];
            championshipsHtml += `<p>ğŸ‘‘ ${count}. Kez 'LÄ°DERLER SIRALAMASI' aylÄ±k sezon ÅŸampiyonu oldu. <small class="text-gray-400">(${lastWin.badgeCount} Rozet ile)</small></p>`;
        }
        if (userData.collectionChampionshipsWon > 0) {
             championshipsHtml += `<p>ğŸƒ ${userData.collectionChampionshipsWon} kez 'KART KOLEKSÄ°YONU' ÅŸampiyonu oldu.</p>`;
        }
        if (userData.monsterChampionships && userData.monsterChampionships.length > 0) {
            const count = userData.monsterChampionships.length;
            const lastWin = userData.monsterChampionships[count - 1];
            championshipsHtml += `<p>ğŸ‘¹ ${count}. kez 'CANAVAR SAVAÅI' ÅŸampiyonu oldu. <small class="text-gray-400">(${formatNumber(lastWin.damage)} Hasar)</small></p>`;
        }
        if (userData.tyChampionships && userData.tyChampionships.length > 0) {
            const count = userData.tyChampionships.length;
            const lastWin = userData.tyChampionships[count - 1];
            championshipsHtml += `<p>ğŸ¯ ${count}. kez 'T-Y SKOR SIRALAMASI' haftalÄ±k yakalayÄ±cÄ± ÅŸampiyonu oldu. <small class="text-gray-400">(${formatNumber(lastWin.score)} Skor ile)</small></p>`;
        }
        
        if (championshipsHtml) {
            championshipsDiv.innerHTML = championshipsHtml;
            championshipsDiv.classList.remove('hidden');
        } else {
            championshipsDiv.classList.add('hidden');
        }
    };
    
    userRef.on('value', userProfileCallback);
    activeUserProfileListener = { ref: userRef, callback: userProfileCallback };
}

async function openUserManagementModal(event, username) {
    if (event) event.stopPropagation();

    if (activeBlockedUserTimers[username]) {
        clearInterval(activeBlockedUserTimers[username]);
        delete activeBlockedUserTimers[username];
    }
    selectedUserForManagement = username;

    const [userSnap, allUsersSnap] = await Promise.all([
        db.ref('users/' + username).once('value'),
        db.ref('users').once('value')
    ]);

    const userData = userSnap.val();
    if (!userData) {
        displayMessage("KullanÄ±cÄ± bulunamadÄ±.");
        return;
    }

    const leaders = await calculateAllLeaders(allUsersSnap.val());
    const userLeaderStatus = {
        isCurrentLeader: username === leaders.currentBalanceUser,
        isHighLeader: username === leaders.highEverBalanceUser,
        isBoxLeader: username === leaders.boxUser,
        isSurpriseLeader: username === leaders.surpriseBoxUser,
        isBombLeader: username === leaders.bombUser,
        isMultiplierLeader: username === leaders.multiplierUser,
        isStoreLeader: username === leaders.spentPointsUser,
        isShieldLeader: username === leaders.shieldUser,
        isClickCatchLeader: username === leaders.clickCatchLeaderUser,
        isWheelSpinLeader: username === leaders.wheelSpinUser
    };
    
    document.getElementById('managedBadgeBalance').innerHTML = userLeaderStatus.isCurrentLeader ? 'ğŸ¥‡' : '';
    document.getElementById('managedBadgeHighest').innerHTML = userLeaderStatus.isHighLeader ? 'ğŸ†' : '';
    const avatarUrl = userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;
    document.getElementById('managedUserAvatar').src = avatarUrl;
    document.getElementById('managedUserName').textContent = username;
    document.getElementById('managedUserBalance').textContent = formatNumber(userData.balance || 0);
    document.getElementById('managedUserHighestBalance').textContent = formatNumber(userData.kariyerPuani || 0);
    document.getElementById('managedUserKasaBalance').textContent = formatNumber(userData.kasaPuani || 0);
    document.getElementById('managedUserWildcards').textContent = formatNumber(userData.wildcards || 0);
    document.getElementById('managedUserBoxRight').textContent = formatNumber(userData.kutuHakki || 0);
    document.getElementById('managedUserWheelTickets').textContent = formatNumber(userData.carkBileti || 0);
    document.getElementById('managedUserClickCatchTickets').textContent = formatNumber(userData.clickCatchTickets || 0);
    document.getElementById('managedUserIflasShield').textContent = formatNumber(userData.iflasShieldUses || 0);
    let multiplierText = 'Yok';
    if (userData.multiplierSource === 'store') multiplierText = `${userData.activeMultiplier}x (MaÄŸaza - ${userData.multiplierRemainingUses} kullanÄ±m)`;
    else if (userData.multiplierSource === 'box') multiplierText = `${userData.activeMultiplier}x (Kutu - Otomatik)`;
    document.getElementById('managedUserMultiplier').textContent = multiplierText;
    document.getElementById('managedUserMultiplierUses').textContent = userData.multiplierRemainingUses || 0;

    const isCurrentlyBlocked = userData.blocked && userData.blockedUntil && Date.now() < userData.blockedUntil;
    const countdownContainer = document.getElementById('managedUserBlockedCountdownContainer');
    const countdownEl = document.getElementById('managedUserBlockedCountdown');
    document.getElementById('managedUserBlockedStatus').textContent = isCurrentlyBlocked ? 'Engelli' : 'Aktif';
    if (isCurrentlyBlocked) {
        countdownContainer.classList.remove('hidden');
        const updateCountdown = () => {
            const timeLeft = userData.blockedUntil - Date.now();
            if (timeLeft <= 0) {
                clearInterval(activeBlockedUserTimers[username]);
                delete activeBlockedUserTimers[username];
                countdownEl.textContent = 'Engel KalktÄ±';
            } else {
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, '0');
                countdownEl.textContent = `${minutes}:${seconds}`;
            }
        };
        updateCountdown();
        activeBlockedUserTimers[username] = setInterval(updateCountdown, 1000);
    } else {
        countdownContainer.classList.add('hidden');
    }
    const toggleBtn = document.getElementById('toggleBlockUserBtn');
    toggleBtn.textContent = isCurrentlyBlocked ? 'Engeli KaldÄ±r' : 'Engelle';
    toggleBtn.onclick = () => toggleBlockUser(username, userData.blocked, userData.blockedUntil);

    document.getElementById('managedUserBoxesOpened').textContent = formatNumber(userData.boxesOpenedCount || 0);
    document.getElementById('managedUserSurpriseBoxes').textContent = formatNumber(userData.surpriseBoxesOpened || 0);
    document.getElementById('managedUserBombCount').textContent = formatNumber(userData.iflasCount || 0);
    document.getElementById('managedUserMultiplierFoundCount').textContent = formatNumber(userData.multiplierFoundCount || 0);
    document.getElementById('managedUserTotalSpent').textContent = formatNumber(userData.totalSpentPoints || 0);
    document.getElementById('managedUserShieldUsedCount').textContent = formatNumber(userData.iflasShieldUsedCount || 0);
    document.getElementById('managedUserClickCatchScore').textContent = formatNumber(userData.clickCatchHighestScore || 0);
    document.getElementById('managedUserWheelSpins').textContent = formatNumber(userData.wheelSpinsCount || 0);

    ['managedBadgeWheel', 'managedBadgeBox', 'managedBadgeSurprise', 'managedBadgeBomb', 'managedBadgeMultiplier', 'managedBadgeStore', 'managedBadgeShield', 'managedBadgeClickCatch'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });

    if (userLeaderStatus.isBoxLeader) document.getElementById('managedBadgeBox').innerHTML = 'ğŸ“¦';
    if (userLeaderStatus.isSurpriseLeader) document.getElementById('managedBadgeSurprise').innerHTML = 'ğŸ‰';
    if (userLeaderStatus.isBombLeader) document.getElementById('managedBadgeBomb').innerHTML = 'ğŸ’£';
    if (userLeaderStatus.isMultiplierLeader) document.getElementById('managedBadgeMultiplier').innerHTML = 'âœ–ï¸';
    if (userLeaderStatus.isStoreLeader) document.getElementById('managedBadgeStore').innerHTML = 'ğŸ›’';
    if (userLeaderStatus.isShieldLeader) document.getElementById('managedBadgeShield').innerHTML = 'ğŸ›¡ï¸';
    if (userLeaderStatus.isClickCatchLeader) document.getElementById('managedBadgeClickCatch').innerHTML = 'ğŸ¯';
    if (userLeaderStatus.isWheelSpinLeader) document.getElementById('managedBadgeWheel').innerHTML = 'ğŸ¡';
    
    // â˜…â˜…â˜… YENÄ° EKLENEN BAÅARIM YÃ–NETÄ°M BÃ–LÃœMÃœ BAÅLANGICI â˜…â˜…â˜…
    // Ã–nce mevcut bir bÃ¶lÃ¼m varsa onu bul, yoksa oluÅŸtur ve ekle.
    let achievementsSection = document.getElementById('managedUserAchievementsSection');
    if (!achievementsSection) {
        achievementsSection = document.createElement('div');
        achievementsSection.id = 'managedUserAchievementsSection';
        achievementsSection.className = 'bg-gray-900 p-6 rounded-lg border border-gray-700 mt-6';
        // Bu bÃ¶lÃ¼mÃ¼, kullanÄ±cÄ± yÃ¶netim penceresinin uygun bir yerine ekleyelim. Mesela avatar grid'inin altÄ±na.
        document.getElementById('managedUserAvatarGrid').parentElement.insertAdjacentElement('afterend', achievementsSection);
    }

    let achievementsHtml = `<h4 class="text-yellow-300 text-xl font-semibold mb-4">KalÄ±cÄ± BaÅŸarÄ±mlar YÃ¶netimi</h4><div class="space-y-3">`;
    let hasAchievements = false;

    // Her bir baÅŸarÄ±m tÃ¼rÃ¼nÃ¼ kontrol et ve silme butonu ekle
    if (userData.puanChampionships && userData.puanChampionships.length > 0) {
        achievementsHtml += `<div class="flex justify-between items-center"><p>ğŸ† Kariyer PuanÄ± ÅampiyonluÄŸu: ${userData.puanChampionships.length} Kez</p><button onclick="removePuanChampionship('${username}')" class="py-1 px-3 bg-red-800 hover:bg-red-700 rounded-md text-xs">Sonuncuyu Sil</button></div>`;
        hasAchievements = true;
    }
    if (userData.rozetChampionships && userData.rozetChampionships.length > 0) {
        achievementsHtml += `<div class="flex justify-between items-center"><p>ğŸ‘‘ Rozet LiderliÄŸi ÅampiyonluÄŸu: ${userData.rozetChampionships.length} Kez</p><button onclick="removeRozetChampionship('${username}')" class="py-1 px-3 bg-red-800 hover:bg-red-700 rounded-md text-xs">Sonuncuyu Sil</button></div>`;
        hasAchievements = true;
    }
    if (userData.collectionChampionshipsWon > 0) {
        achievementsHtml += `<div class="flex justify-between items-center"><p>ğŸƒ Koleksiyon ÅampiyonluÄŸu: ${userData.collectionChampionshipsWon} Kez</p><button onclick="removeCollectionChampionship('${username}')" class="py-1 px-3 bg-red-800 hover:bg-red-700 rounded-md text-xs">Sonuncuyu Sil</button></div>`;
        hasAchievements = true;
    }
    if (userData.monsterChampionships && userData.monsterChampionships.length > 0) {
        achievementsHtml += `<div class="flex justify-between items-center"><p>ğŸ‘¹ Canavar SavaÅŸÄ± ÅampiyonluÄŸu: ${userData.monsterChampionships.length} Kez</p><button onclick="removeMonsterChampionship('${username}')" class="py-1 px-3 bg-red-800 hover:bg-red-700 rounded-md text-xs">Sonuncuyu Sil</button></div>`;
        hasAchievements = true;
    }
    if (userData.tyChampionships && userData.tyChampionships.length > 0) {
        achievementsHtml += `<div class="flex justify-between items-center"><p>ğŸ¯ T-Y YakalayÄ±cÄ± ÅampiyonluÄŸu: ${userData.tyChampionships.length} Kez</p><button onclick="removeTyChampionship('${username}')" class="py-1 px-3 bg-red-800 hover:bg-red-700 rounded-md text-xs">Sonuncuyu Sil</button></div>`;
        hasAchievements = true;
    }

    if (!hasAchievements) {
        achievementsHtml += '<p class="text-center text-gray-500">Bu kullanÄ±cÄ±nÄ±n henÃ¼z kalÄ±cÄ± bir baÅŸarÄ±mÄ± yok.</p>';
    }
    achievementsHtml += `</div>`;
    achievementsSection.innerHTML = achievementsHtml;
    // â˜…â˜…â˜… YENÄ° EKLENEN BAÅARIM YÃ–NETÄ°M BÃ–LÃœMÃœ SONU â˜…â˜…â˜…

    const historyList = document.getElementById('managedUserPurchaseHistory');
    historyList.innerHTML = 'YÃ¼kleniyor...';
    db.ref('purchaseHistory').orderByChild('username').equalTo(username).once('value').then(snap => {
        const history = snap.val();
        let html = '';
        if (!history) {
            historyList.innerHTML = '<div class="text-center text-gray-400">Bu kullanÄ±cÄ±nÄ±n satÄ±n alma geÃ§miÅŸi yok.</div>';
            return;
        }
        const sorted = Object.values(history).sort((a, b) => b.timestamp - a.timestamp);
        sorted.forEach(r => {
            html += `<div class="p-2 bg-gray-900 mb-2 rounded text-sm"><b>ÃœrÃ¼n:</b> ${r.itemName}, <b>Maliyet:</b> ${r.itemCost} Puan, <b>Tarih:</b> ${new Date(r.timestamp).toLocaleString()}</div>`;
        });
        historyList.innerHTML = html;
    });

    const avatarGrid = document.getElementById('managedUserAvatarGrid');
    avatarGrid.innerHTML = '';
    if (userData.avatars && Object.keys(userData.avatars).length > 0) {
        for (const avatarId in userData.avatars) {
            const avatar = userData.avatars[avatarId];
            const avatarCard = document.createElement('div');
            avatarCard.className = 'relative p-2 bg-gray-700 rounded-lg text-center';
            avatarCard.innerHTML = `<img src="${avatar.imageUrl}" alt="${avatar.name}" class="w-full h-auto rounded-md object-cover aspect-square"><p class="text-xs mt-2 text-white truncate" title="${avatar.name}">${avatar.name}</p><button onclick="deleteUserAvatar('${username}', '${avatarId}')" class="absolute -top-2 -right-2 bg-red-600 hover:bg-red-500 text-white rounded-full h-7 w-7 flex items-center justify-center text-lg font-bold" title="Bu AvatarÄ± Sil">&times;</button>`;
            avatarGrid.appendChild(avatarCard);
        }
    } else {
        avatarGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Bu kullanÄ±cÄ±nÄ±n satÄ±n alÄ±nmÄ±ÅŸ avatarÄ± yok.</p>';
    }

    userManagementModal.style.display = 'flex';
}

// â˜…â˜…â˜… YENÄ° EKLENECEK BAÅARIM SÄ°LME FONKSÄ°YONLARI BAÅLANGICI â˜…â˜…â˜…

// Puan ÅampiyonluÄŸu'nun son kaydÄ±nÄ± siler
async function removePuanChampionship(username) {
    if (!isAdmin || !username) return;
    const confirmed = await customConfirm(`<b>${username}</b> adlÄ± kullanÄ±cÄ±nÄ±n son 'Kariyer PuanÄ± ÅampiyonluÄŸu' baÅŸarÄ±mÄ±nÄ± silmek istediÄŸinize emin misiniz?`);
    if (!confirmed) return;

    const userRef = db.ref(`users/${username}/puanChampionships`);
    await userRef.transaction(championships => {
        if (championships && Array.isArray(championships) && championships.length > 0) {
            championships.pop(); // Son elemanÄ± diziden Ã§Ä±kar
        }
        return championships;
    });
    displayMessage("KullanÄ±cÄ±nÄ±n son Puan ÅampiyonluÄŸu baÅŸarÄ±mÄ± silindi.");
    openUserManagementModal(event, username); // Pencereyi yenile
}

// Rozet LiderliÄŸi ÅampiyonluÄŸu'nun son kaydÄ±nÄ± siler
async function removeRozetChampionship(username) {
    if (!isAdmin || !username) return;
    const confirmed = await customConfirm(`<b>${username}</b> adlÄ± kullanÄ±cÄ±nÄ±n son 'Rozet LiderliÄŸi ÅampiyonluÄŸu' baÅŸarÄ±mÄ±nÄ± silmek istediÄŸinize emin misiniz?`);
    if (!confirmed) return;

    const userRef = db.ref(`users/${username}/rozetChampionships`);
    await userRef.transaction(championships => {
        if (championships && Array.isArray(championships) && championships.length > 0) {
            championships.pop();
        }
        return championships;
    });
    displayMessage("KullanÄ±cÄ±nÄ±n son Rozet LiderliÄŸi baÅŸarÄ±mÄ± silindi.");
    openUserManagementModal(event, username);
}

// Koleksiyon ÅampiyonluÄŸu sayÄ±sÄ±nÄ± bir azaltÄ±r
async function removeCollectionChampionship(username) {
    if (!isAdmin || !username) return;
    const confirmed = await customConfirm(`<b>${username}</b> adlÄ± kullanÄ±cÄ±nÄ±n 'Koleksiyon ÅampiyonluÄŸu' sayÄ±sÄ±nÄ± bir azaltmak istediÄŸinize emin misiniz?`);
    if (!confirmed) return;

    const userRef = db.ref(`users/${username}/collectionChampionshipsWon`);
    await userRef.transaction(count => {
        return (count || 0) > 0 ? count - 1 : 0;
    });
    displayMessage("KullanÄ±cÄ±nÄ±n Koleksiyon ÅampiyonluÄŸu sayÄ±sÄ± bir azaltÄ±ldÄ±.");
    openUserManagementModal(event, username);
}

// Canavar SavaÅŸÄ± ÅampiyonluÄŸu'nun son kaydÄ±nÄ± siler
async function removeMonsterChampionship(username) {
    if (!isAdmin || !username) return;
    const confirmed = await customConfirm(`<b>${username}</b> adlÄ± kullanÄ±cÄ±nÄ±n son 'Canavar SavaÅŸÄ± ÅampiyonluÄŸu' baÅŸarÄ±mÄ±nÄ± silmek istediÄŸinize emin misiniz?`);
    if (!confirmed) return;

    const userRef = db.ref(`users/${username}/monsterChampionships`);
    await userRef.transaction(championships => {
        if (championships && Array.isArray(championships) && championships.length > 0) {
            championships.pop();
        }
        return championships;
    });
    displayMessage("KullanÄ±cÄ±nÄ±n son Canavar SavaÅŸÄ± baÅŸarÄ±mÄ± silindi.");
    openUserManagementModal(event, username);
}

// TÄ±kla-Yakala ÅampiyonluÄŸu'nun son kaydÄ±nÄ± siler
async function removeTyChampionship(username) {
    if (!isAdmin || !username) return;
    const confirmed = await customConfirm(`<b>${username}</b> adlÄ± kullanÄ±cÄ±nÄ±n son 'T-Y YakalayÄ±cÄ± ÅampiyonluÄŸu' baÅŸarÄ±mÄ±nÄ± silmek istediÄŸinize emin misiniz?`);
    if (!confirmed) return;

    const userRef = db.ref(`users/${username}/tyChampionships`);
    await userRef.transaction(championships => {
        if (championships && Array.isArray(championships) && championships.length > 0) {
            championships.pop();
        }
        return championships;
    });
    displayMessage("KullanÄ±cÄ±nÄ±n son T-Y YakalayÄ±cÄ± baÅŸarÄ±mÄ± silindi.");
    openUserManagementModal(event, username);
}

// â˜…â˜…â˜… YENÄ° EKLENECEK BAÅARIM SÄ°LME FONKSÄ°YONLARI SONU â˜…â˜…â˜…

    function closePublicUserDetailModal() {
    const publicUserDetailModal = document.getElementById('publicUserDetailModal');
    publicUserDetailModal.style.display = 'none';
    document.body.classList.remove('modal-open');

    // --- DEÄÄ°ÅEN KISIM BAÅLANGICI ---
    // EÄŸer aktif bir profil dinleyicisi varsa, onu kapatÄ±yoruz.
    if (activeUserProfileListener && activeUserProfileListener.ref && activeUserProfileListener.callback) {
        // Dinleyiciyi 'value' event'i iÃ§in ve sakladÄ±ÄŸÄ±mÄ±z callback ile kapatÄ±yoruz.
        activeUserProfileListener.ref.off('value', activeUserProfileListener.callback);
        activeUserProfileListener = null; // DeÄŸiÅŸkeni temizliyoruz ki tekrar kullanÄ±lmasÄ±n.
    }
    // --- DEÄÄ°ÅEN KISIM SONU ---

    const viewingUser = publicUserDetailModal.dataset.viewingUser;
    if (viewingUser && activeBlockedUserTimers[viewingUser]) {
        clearInterval(activeBlockedUserTimers[viewingUser]);
        delete activeBlockedUserTimers[viewingUser];
    }
}
  
  function closeUserManagementModal() {
    if (selectedUserForManagement && activeBlockedUserTimers[selectedUserForManagement]) {
        clearInterval(activeBlockedUserTimers[selectedUserForManagement]);
        delete activeBlockedUserTimers[selectedUserForManagement];
    }
    userManagementModal.style.display = 'none'; 
    selectedUserForManagement = null; 
  }

  function loadPendingSpecialPurchases() {
    const list = document.getElementById('pendingSpecialPurchasesList');
    const ref = db.ref('pendingSpecialPurchases');
    const callback = snap => {
        const purchases = snap.val();
        let html = '';
        if (!purchases || Object.keys(purchases).length === 0) {
            list.innerHTML = "<div class='text-center text-gray-400'>Onay bekleyen Ã¶zel Ã¼rÃ¼n alÄ±mÄ± yok.</div>";
            return;
        }
        for (const key in purchases) {
            const purchase = purchases[key];
            html += `
                <div class="flex flex-col items-start justify-between p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-yellow-500">
                    <div>
                        <span class="text-gray-200 font-bold">${purchase.username}</span>
                        <span class="text-gray-300">- ${purchase.itemName}</span>
                    </div>
                    <div class="flex space-x-2 mt-2 self-end">
                        <button onclick="approveSpecialPurchase('${key}', '${purchase.username}')" class="py-1 px-3 bg-green-600 hover:bg-green-500 text-white text-sm font-bold rounded-md">Onayla</button>
                        <button onclick="denySpecialPurchase('${key}', '${purchase.username}', ${purchase.itemCost})" class="py-1 px-3 bg-red-600 hover:bg-red-500 text-white text-sm font-bold rounded-md">Reddet</button>
                    </div>
                </div>
            `;
        }
        list.innerHTML = html;
    };
    activeListeners.pendingPurchases = { ref, event: 'value', callback };
    ref.on('value', callback);
  }

  async function approveSpecialPurchase(purchaseId, username) {
      const purchaseItemSnap = await db.ref(`/pendingSpecialPurchases/${purchaseId}`).once('value');
      const purchaseItem = purchaseItemSnap.val();
      if (!purchaseItem) {
        displayMessage("Onaylanacak Ã¶ÄŸe bulunamadÄ±.");
        return;
      }
      
      if (!await customConfirm(`${username} kullanÄ±cÄ±sÄ±nÄ±n '${purchaseItem.itemName}' alÄ±mÄ±nÄ± onaylamak istediÄŸinize emin misiniz?`)) return;

      const updates = {};
      updates[`/pendingSpecialPurchases/${purchaseId}`] = null; 
      updates[`/purchaseHistory/${purchaseId}/status`] = 'completed'; 

      db.ref().update(updates).then(() => {
          notifyUser(username, `'${purchaseItem.itemName}' adlÄ± Ã¶zel Ã¼rÃ¼n alÄ±mÄ±nÄ±z onaylandÄ±!`);
          displayMessage("Ã–zel Ã¼rÃ¼n alÄ±mÄ± baÅŸarÄ±yla onaylandÄ±.");
      }).catch(err => {
          console.error("Onaylama hatasÄ±: ", err);
          displayMessage("Onaylama sÄ±rasÄ±nda bir hata oluÅŸtu.");
      });
  }

  // MEVCUT denySpecialPurchase fonksiyonunu bununla deÄŸiÅŸtir
async function denySpecialPurchase(purchaseId, username, itemCost) {
      const purchaseItemSnap = await db.ref(`/pendingSpecialPurchases/${purchaseId}`).once('value');
      const purchaseItem = purchaseItemSnap.val();
       if (!purchaseItem) {
        displayMessage("Reddedilecek Ã¶ÄŸe bulunamadÄ±.");
        return;
      }

      if (!await customConfirm(`${username} kullanÄ±cÄ±sÄ±nÄ±n '${purchaseItem.itemName}' alÄ±mÄ±nÄ± reddetmek istediÄŸinize emin misiniz? Puan iadesi yapÄ±lacaktÄ±r.`)) return;
      
      const userRef = db.ref(`users/${username}`);
      const updates = {};

      const userSnap = await userRef.once('value');
      const userData = userSnap.val();
      if (userData) {
          // Ä°ade edilen puan hem balance'a hem de kariyer puanÄ±na eklenmeli
          // Ã§Ã¼nkÃ¼ bu bir "kazanÄ±m" deÄŸil, "kaybÄ±n geri alÄ±nmasÄ±" durumudur.
          // Sistemin tutarlÄ±lÄ±ÄŸÄ± iÃ§in kariyer puanÄ±nÄ± etkilememesi daha doÄŸru olur.
          // Bu yÃ¼zden burada kariyer puanÄ±na dokunmuyoruz. SADECE KASA PUANI'nÄ± iade ediyoruz.
          updates[`users/${username}/kasaPuani`] = (userData.kasaPuani || 0) + itemCost;
          // NOT: 'totalSpentPoints' Kasa PuanÄ± harcamalarÄ±nÄ± saymÄ±yor, o yÃ¼zden ona dokunmaya gerek yok.
      }

      updates[`/pendingSpecialPurchases/${purchaseId}`] = null;
      updates[`/purchaseHistory/${purchaseId}/status`] = 'denied';

      db.ref().update(updates).then(() => {
          notifyUser(username, `'${purchaseItem.itemName}' adlÄ± Ã¶zel Ã¼rÃ¼n alÄ±mÄ±nÄ±z reddedildi. ${itemCost} Kasa PuanÄ± hesabÄ±nÄ±za iade edildi.`);
          displayMessage("Ã–zel Ã¼rÃ¼n alÄ±mÄ± reddedildi ve Kasa PuanÄ± iadesi yapÄ±ldÄ±.");
      }).catch(err => {
          console.error("Reddetme hatasÄ±: ", err);
          displayMessage("Reddetme sÄ±rasÄ±nda bir hata oluÅŸtu.");
      });
  }

  let globalCountdownInterval = null;
    let spectatorCountdownInterval = null;

  // MEVCUT listenForGameChanges FONKSÄ°YONUNU SÄ°L VE BUNUNLA DEÄÄ°ÅTÄ°R
function listenForGameChanges() {
    const gameLockRef = db.ref('gameLock');
    const gameLockCallback = snap => {
        isGameLocked = snap.val() === true;
        const toggleBtn = document.getElementById('toggleGameLockBtn');
        if (toggleBtn) {
            if (isGameLocked) {
                toggleBtn.textContent = 'Oyun Kilidini AÃ§';
                toggleBtn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
                toggleBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            } else {
                toggleBtn.textContent = 'Oyunu Kilitle';
                toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
                toggleBtn.classList.add('bg-gray-600', 'hover:bg-gray-500');
            }
        }
    };
    activeListeners.gameLock = { ref: gameLockRef, event: 'value', callback: gameLockCallback };
    gameLockRef.on('value', gameLockCallback);

    const lastOpenedBoxRef = db.ref('lastOpenedBox');
    const lastOpenedBoxCallback = snap => {
        const info = snap.val();
        if (info && (Date.now() - info.timestamp < 10000)) {
            if (info.content !== 'surpriz') {
                showGlobalOpenedBoxInfo(info);
            }
        }
    };
    activeListeners.lastOpenedBox = { ref: lastOpenedBoxRef, event: 'value', callback: lastOpenedBoxCallback };
    lastOpenedBoxRef.on('value', lastOpenedBoxCallback);
}

// YENÄ° EKLENEN SORUN GÄ°DERME FONKSÄ°YONLARI
function openSolveProblemsModal() {
    document.getElementById('solveProblemsModal').style.display = 'flex';
}

function closeSolveProblemsModal() {
    document.getElementById('solveProblemsModal').style.display = 'none';
}

// Oyuncunun kendi oyun kilidini manuel olarak aÃ§masÄ±nÄ± saÄŸlar.
async function manualUnlockGame() {
    const gameLockRef = db.ref('gameLock');
    const lockSnap = await gameLockRef.once('value');
    if (lockSnap.val() === true) {
        await gameLockRef.set(false);
        displayMessage("Oyun kilidi baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±. ArtÄ±k kutu aÃ§abilirsiniz.");
    } else {
        displayMessage("Oyun zaten kilitli deÄŸil, kutular ÅŸu anda aÃ§Ä±labilir durumda.");
    }
    closeSolveProblemsModal();
}

async function manualResetAfterSurprise() {
    const lastSurpriseSnap = await db.ref('gameStats/lastSurpriseInfo').once('value');
    const lastSurpriseData = lastSurpriseSnap.val();

    if (lastSurpriseData && lastSurpriseData.resettled === false) {
        
        // SÄ±fÄ±rlama iÅŸlemini veritabanÄ±na kaydet
        await db.ref('gameStats/lastSurpriseInfo').update({
            resettled: true,
            resettledBy: currentUser 
        });
        
        // Oyunu sÄ±fÄ±rla (kutularÄ± yeniden oluÅŸtur ve istatistikleri temizle)
        await resetGameBoard();
        
        displayMessage("AÃ§Ä±lmÄ±ÅŸ sÃ¼rpriz kutu tespit edildi ve oyun senin tarafÄ±ndan baÅŸarÄ±yla sÄ±fÄ±rlandÄ±!");

    } else {
        displayMessage("Bu Ã¶zellik sadece sÃ¼rpriz kutu bulunduktan sonra kullanÄ±labilir.");
    }
    
    closeSolveProblemsModal();
}

async function silSonSurprizKutusu() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Son SÃ¼rpriz Kutu panelini kalÄ±cÄ± olarak gizlemek istediÄŸinizden emin misiniz?");
    if (confirmed) {
        await db.ref('gameStats/lastSurpriseInfo').remove();
    }
}
/**
 * "Ã‡arktan Son Ã‡Ä±kan SÃ¼rpriz" panelini temizlemeden Ã¶nce onay sorar.
 */
async function silSonCarkSurprizi() {
    if (!isAdmin) {
        console.error("Bu iÅŸlem sadece adminler tarafÄ±ndan yapÄ±labilir.");
        return;
    }
    // --- YENÄ° EKLENEN KOD BAÅLANGICI ---
    const confirmed = await customConfirm("Son Ã‡ark SÃ¼rprizi panelini silmek istediÄŸinden emin misin?");
    if (confirmed) {
    // --- YENÄ° EKLENEN KOD SONU ---
        await db.ref('gameStats/lastWheelSurpriseInfo').remove();
        console.log("BaÅŸarÄ±lÄ±: 'Ã‡arktan Son Ã‡Ä±kan SÃ¼rpriz' paneli temizlendi.");
    } // --- if bloÄŸunu kapatan parantez
}

function listenForLastSurpriseFinderPanel() {
    const ref = db.ref('gameStats/lastSurpriseInfo');
    const panel = document.getElementById('lastSurpriseFinderPanel');

    const callback = snap => {
        const data = snap.val();
        if (!data || !data.finder) {
            panel.classList.add('hidden');
            return;
        }

        let adminDeleteButton = '';
        if (isAdmin) {
            adminDeleteButton = `
                <button onclick="silSonSurprizKutusu()" class="absolute -top-3 -right-3 bg-red-600 hover:bg-red-500 text-white rounded-full h-8 w-8 flex items-center justify-center text-lg font-bold transition-transform hover:scale-110" title="Bu Paneli Gizle">
                    &times;
                </button>
            `;
        }
        
        let boxesOpenedText = '';
        if (data.boxesOpenedThisRound) {
            boxesOpenedText = `<p class="text-sm text-gray-300">Bu tur toplam <b class="text-white">${data.boxesOpenedThisRound}</b> kutu aÃ§tÄ±.</p>`;
        }
        
        // --- YENÄ° GÃ–RÃœNÃœM Ä°Ã‡Ä°N DÃœZENLENEN KOD ---
        let detailsText = '';
        // EÄŸer Ã§arpan kullanÄ±ldÄ±ysa
        if (data.multiplier && data.multiplier > 1) {
            const finalPoints = data.points * data.multiplier; // Nihai puanÄ± hesapla
            detailsText = `<p class="text-xs text-purple-400">(${formatNumber(finalPoints)} Puan / ${data.multiplier}x Ã‡arpan KullanÄ±ldÄ±)
            <p class="text-xs text-gray-400">(Mevcut PuanÄ±: ${formatNumber(data.newBalance)})</p>`;
        } 
        // Ã‡arpan kullanÄ±lmadÄ±ysa
        else {
            detailsText = `<p class="text-xs text-gray-400">(Mevcut PuanÄ±: ${formatNumber(data.newBalance)})</p>`;
        }
        // --- DÃœZENLEME SONU ---

        let messageHtml = `
            ${adminDeleteButton}
            <h4 class="text-amber-300 text-xl font-bold">ğŸ‰ SON SÃœRPRÄ°Z KUTUSU BULUNDU! ğŸ‰</h4>
            <p><b class="text-white text-lg">${data.finder}</b>, ${data.boxId} numaralÄ± kutudan SÃ¼rpriz Kutu buldu!</p>
            ${boxesOpenedText} 
            <p>Kart seÃ§iminden <b class="text-green-400">+${formatNumber(data.points)} Puan</b> kazandÄ±.</p>
            ${detailsText} 
        `;

        if (data.resettled === true && data.resettledBy) {
             messageHtml += `
                <hr class="border-gray-600 my-2">
                <p class="text-sm text-lime-400">KutularÄ± <b class="text-white">${data.resettledBy}</b> sÄ±fÄ±rladÄ± ve oyun yeniden baÅŸladÄ±.</p>
            `;
        } else {
             messageHtml += `
                <hr class="border-gray-600 my-2">
                <p class="text-sm text-yellow-400 animate-pulse">Oyunun yeniden baÅŸlamasÄ± iÃ§in bir oyuncunun 'SorunlarÄ± Ã‡Ã¶z' menÃ¼sÃ¼nden kutularÄ± sÄ±fÄ±rlamasÄ± gerekiyor.</p>
            `;
        }

        panel.innerHTML = messageHtml;
        panel.classList.add('relative');
        panel.classList.remove('hidden');
    };

    if (activeListeners.surprisePanel) {
        activeListeners.surprisePanel.ref.off('value', activeListeners.surprisePanel.callback);
    }
    activeListeners.surprisePanel = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// YEPYENÄ° FONKSÄ°YON - BU KOD BLOÄUNU OLDUÄU GÄ°BÄ° EKLE
async function toggleGameLock() {
    if (!isAdmin) return;
    const gameLockRef = db.ref('gameLock');
    const lockSnap = await gameLockRef.once('value');
    const isCurrentlyLocked = lockSnap.val() === true;
    await gameLockRef.set(!isCurrentlyLocked);
    displayMessage(`Oyun kilidi baÅŸarÄ±yla ${!isCurrentlyLocked ? 'aktif edildi' : 'kaldÄ±rÄ±ldÄ±'}.`);
}

  function showGlobalOpenedBoxInfo(info) {
    const isPlayingClickCatch = clickCatchGameActive || (lobbyGameSettings && lobbyGameSettings.state === 'active');
    if (isPlayingClickCatch) return;

    // YENÄ° EKLENEN KISIM: Modal yerine Ã¼stte Ã§Ä±kan bildirim bandÄ±nÄ± kullanacaÄŸÄ±z.
    const notificationMessage = `${info.opener}, ${info.boxId} numaralÄ± kutuyu aÃ§tÄ±.`;
    displayGlobalNotification(notificationMessage);

    // DEÄÄ°ÅEN SATIR: ZamanlayÄ±cÄ± 3 saniyeye dÃ¼ÅŸÃ¼rÃ¼ldÃ¼.
    let countdown = 1; // <--- BU SATIRI 1 OLARAK DEÄÄ°ÅTÄ°R

    // Geri kalan zamanlayÄ±cÄ± mantÄ±ÄŸÄ± aynÄ± kalÄ±yor, Ã§Ã¼nkÃ¼ oyun kilidini bu yÃ¶netiyor.
    const countdownEl = document.getElementById('globalOpenedBoxCountdown'); // Bu element artÄ±k gÃ¶rÃ¼nmese de sayaÃ§ Ã§alÄ±ÅŸmaya devam eder.

    if(globalCountdownInterval) clearInterval(globalCountdownInterval);

    globalCountdownInterval = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
            clearInterval(globalCountdownInterval);
            // SÄ°LÄ°NEN SATIR: Modal artÄ±k olmadÄ±ÄŸÄ± iÃ§in kapatmaya gerek yok.
            // globalOpenedBoxInfoModal.style.display = 'none';

            // En Ã¶nemli kÄ±sÄ±m: SÃ¼re dolduÄŸunda oyun kilidini aÃ§ar.
            db.ref('gameLock').set(false);
        }
    }, 1000);
}

    // YENÄ° DUYURU SÄ°STEMÄ°
    function resetAnnouncementForm() {
        document.getElementById('announcementText').value = '';
        document.getElementById('announcementFormTitle').textContent = 'Yeni Duyuru Yap';
        document.getElementById('postAnnouncementBtn').textContent = 'DUYURU YAP';
        document.getElementById('cancelEditAnnouncementBtn').classList.add('hidden');
        editingAnnouncementId = null;
    }

    async function postAnnouncement() {
        if (!isAdmin) return;
        const text = document.getElementById('announcementText').value.trim();
        if (!text) {
            displayMessage("Duyuru metni boÅŸ olamaz.");
            return;
        }

        const announcementData = {
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            likes: editingAnnouncementId ? (await db.ref(`announcements/${editingAnnouncementId}/likes`).once('value')).val() || 0 : 0,
            likedBy: editingAnnouncementId ? (await db.ref(`announcements/${editingAnnouncementId}/likedBy`).once('value')).val() || {} : {}
        };

        if (editingAnnouncementId) {
            await db.ref('announcements/' + editingAnnouncementId).update(announcementData);
            displayMessage("Duyuru baÅŸarÄ±yla gÃ¼ncellendi.");
        } else {
            await db.ref('announcements').push(announcementData);
            displayMessage("Duyuru baÅŸarÄ±yla yayÄ±nlandÄ±.");
        }
        resetAnnouncementForm();
    }
    
    async function editAnnouncement(id) {
        const annSnap = await db.ref(`announcements/${id}`).once('value');
        const ann = annSnap.val();
        if (ann) {
            editingAnnouncementId = id;
            document.getElementById('announcementText').value = ann.text;
            document.getElementById('announcementFormTitle').textContent = 'Duyuruyu DÃ¼zenle';
            document.getElementById('postAnnouncementBtn').textContent = 'GÃœNCELLE';
            document.getElementById('cancelEditAnnouncementBtn').classList.remove('hidden');
            document.getElementById('adminAnnouncementControls').scrollIntoView({ behavior: 'smooth' });
        }
    }

    async function deleteAnnouncement(id) {
        if (!isAdmin) return;
        if (await customConfirm("Bu duyuruyu silmek istediÄŸinizden emin misiniz?")) {
            await db.ref('announcements/' + id).remove();
            displayMessage("Duyuru silindi.");
        }
    }
    
    // --- YENÄ° KOD (BUNU YAPIÅTIR) ---
function loadAnnouncements() {
    const listEl = document.getElementById('announcementsList');
    const userRef = db.ref(`users/${currentUser}`);
    const ref = db.ref('announcements').orderByChild('timestamp');

    // DÃœZELTME BURADA: Ã–nceki dinleyiciyi temizliyoruz.
    if (activeListeners.announcements && activeListeners.announcements.ref) {
        activeListeners.announcements.ref.off('value', activeListeners.announcements.callback);
    }

    const callback = async (snap) => {
        listEl.innerHTML = '';
        const announcements = snap.val();

        if (!announcements) {
            listEl.innerHTML = '<p class="text-center text-gray-400">HenÃ¼z yayÄ±nlanmÄ±ÅŸ bir duyuru yok.</p>';
            return;
        }
        
        const userSnap = await userRef.once('value');
        const userData = userSnap.val() || {};
        const likedAnnouncements = userData.likedAnnouncements || {};
        
        const sortedAnnouncements = Object.entries(announcements).sort((a, b) => b[1].timestamp - a[1].timestamp);
        
        sortedAnnouncements.forEach(([id, ann]) => {
            const date = new Date(ann.timestamp).toLocaleString('tr-TR');
            const processedText = ann.text.replace(/@(\w+)/g, (match, username) => {
                const isCurrentUserMention = username.toLowerCase() === (currentUser || '').toLowerCase();
                const highlightClass = isCurrentUserMention ? 'user-mention highlighted' : 'user-mention';
                return `<span class="${highlightClass}" data-username="${username}">${match}</span>`;
            });
            
            let adminButtons = '';
            if(isAdmin) {
                adminButtons = `
                    <button onclick="editAnnouncement('${id}')" class="py-1 px-3 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-md">DÃ¼zenle</button>
                    <button onclick="deleteAnnouncement('${id}')" class="py-1 px-3 bg-red-600 hover:bg-red-500 text-white text-xs font-bold rounded-md">Sil</button>
                `;
            }

            const isLiked = likedAnnouncements[id] && !isAdmin;
            const likeButtonClass = isLiked ? 'bg-blue-600 text-white' : 'bg-gray-600 hover:bg-gray-500 text-gray-300';
            const likeButtonText = isLiked ? 'BeÄŸenildi' : 'BeÄŸen';

            const div = document.createElement('div');
            div.className = 'bg-gray-800 p-6 rounded-lg border-l-4 border-yellow-500 shadow-lg';
            div.innerHTML = `
                <p class="text-lg text-gray-200 mb-4 whitespace-pre-wrap">${processedText}</p>
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-700">
                    <p class="text-xs text-gray-500">${date}</p>
                    <div class="flex items-center gap-4">
                         <a onclick="showAnnouncementLikes('${id}')" class="cursor-pointer font-bold text-yellow-400 hover:text-yellow-300">${ann.likes || 0} BeÄŸeni</a>
                         ${!isAdmin ? `
                         <button id="likeBtn-${id}" onclick="likeAnnouncement('${id}')" class="${likeButtonClass} px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.562 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.82 2.316l-1.09 1.817c-.381.636-.632 1.356-.632 2.146z" /></svg>
                            ${likeButtonText}
                        </button>
                         ` : adminButtons}
                    </div>
                </div>
            `;
            listEl.appendChild(div);
        });
        
        listEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('user-mention')) {
                const usernameToView = e.target.dataset.username;
                if (usernameToView) {
                    openPublicUserDetailModal(usernameToView.toLowerCase());
                }
            }
        });
    };

    activeListeners.announcements = { ref, event: 'value', callback };
    ref.on('value', callback);
}

    async function likeAnnouncement(announcementId) {
        if (isAdmin) {
            displayMessage("Adminler beÄŸeni yapamaz.");
            return;
        }

        const userLikeRef = db.ref(`users/${currentUser}/likedAnnouncements/${announcementId}`);
        const userLikeSnap = await userLikeRef.once('value');
        const announcementRef = db.ref(`announcements/${announcementId}`);

        if (userLikeSnap.exists()) {
            await userLikeRef.remove();
            await db.ref(`announcements/${announcementId}/likedBy/${currentUser}`).remove();
            await announcementRef.child('likes').transaction(currentLikes => (currentLikes || 0) - 1);
        } else {
            await userLikeRef.set(true);
            await db.ref(`announcements/${announcementId}/likedBy/${currentUser}`).set(true);
            await announcementRef.child('likes').transaction(currentLikes => (currentLikes || 0) + 1);
        }
    }
    
    function listenForNewAnnouncements() {
    const ref = db.ref('announcements').orderByChild('timestamp').limitToLast(1);
    const userRef = db.ref(`users/${currentUser}`);

    const callback = async (snap) => {
        if (!snap.exists()) return;

        const latestAnnKey = Object.keys(snap.val())[0];
        const latestAnn = snap.val()[latestAnnKey];
        latestAnnouncementTimestamp = latestAnn.timestamp;
        
        const userSnap = await userRef.once('value');
        const userData = userSnap.val();
        
        if (userData && latestAnn.timestamp > (userData.lastSeenAnnouncementTimestamp || 0)) {
            // Sadece modal kapalÄ±ysa ve duyuru sekmesinde deÄŸilsek gÃ¶ster
            const isModalHidden = document.getElementById('newAnnouncementModal').style.display !== 'flex';
            if (currentActiveSection !== 'announcements' && isModalHidden) {
                document.getElementById('newAnnouncementText').textContent = latestAnn.text.substring(0, 250) + (latestAnn.text.length > 250 ? '...' : '');
                newAnnouncementModal.style.display = 'flex';
            }
            document.getElementById('announcementIndicator').classList.remove('hidden');
        }
    };

    if (activeListeners.newAnnouncements) {
        activeListeners.newAnnouncements.ref.off(activeListeners.newAnnouncements.event, activeListeners.newAnnouncements.callback);
    }
    activeListeners.newAnnouncements = { ref, event: 'value', callback };
    ref.on('value', callback);
}

    function listenForNewStoreItems() {
    const ref = db.ref('storeItems').orderByChild('createdAt').limitToLast(1);
    const userRef = db.ref(`users/${currentUser}`);

    const callback = async (snap) => {
        if (!snap.exists()) return;

        const latestItemKey = Object.keys(snap.val())[0];
        const latestItem = snap.val()[latestItemKey];
        latestStoreItemTimestamp = latestItem.createdAt;

        const userSnap = await userRef.once('value');
        const userData = userSnap.val();

        if (userData && latestItem.createdAt > (userData.lastSeenStoreTimestamp || 0)) {
            document.getElementById('storeIndicator').classList.remove('hidden');
        }
    };

    if (activeListeners.newStoreItems) {
        activeListeners.newStoreItems.ref.off(activeListeners.newStoreItems.event, activeListeners.newStoreItems.callback);
    }
    activeListeners.newStoreItems = { ref, event: 'value', callback };
    ref.on('value', callback);
}

    function closeNewAnnouncementModal() {
    newAnnouncementModal.style.display = 'none';
    if (!isAdmin) {
        db.ref(`users/${currentUser}/lastSeenAnnouncementTimestamp`).set(latestAnnouncementTimestamp);
    }
}
    
    function goToAnnouncements() {
    closeNewAnnouncementModal();
    showSection('announcements');
}

    async function openUnopenedBoxContentsModal() {
    const listEl = document.getElementById('unopenedBoxContentsList');
    listEl.innerHTML = 'YÃ¼kleniyor...';
    
    try {
        const configSnap = await db.ref('gameConfig/boxContents').once('value');
        const defaultBoxConfig = [ { type: 'surpriz', value: 0, count: 1 }, { type: 'points', value: 1000, count: 2 }, { type: 'iflas', count: 2 }, { type: 'points', value: 750, count: 4 }, { type: 'points', value: 500, count: 6 }, { type: 'points', value: 250, count: 8 }, { type: 'points', value: 100, count: 10 }, { type: 'points', value: 50, count: 15 }, { type: 'points', value: 10, count: 20 }, { type: 'points', value: 1, count: 30 }, { type: 'multiplier', value: 2, count: 1 }, { type: 'multiplier', value: 3, count: 1 } ];
        const boxConfig = configSnap.exists() ? configSnap.val() : defaultBoxConfig;

        const boxesSnap = await db.ref('boxes').once('value');
        const currentBoxes = boxesSnap.val();

        const remainingContents = {};

        boxConfig.forEach(item => {
            const key = `${item.type}-${item.value}`;
            remainingContents[key] = (remainingContents[key] || 0) + item.count;
        });

        if (currentBoxes) {
            currentBoxes.forEach(box => {
                if (box.opened) {
                    const key = `${box.content}-${box.value}`;
                    if (remainingContents[key]) {
                        remainingContents[key]--;
                    }
                }
            });
        }
        
        listEl.innerHTML = '';
        let html = '';
        Object.entries(remainingContents).forEach(([key, count]) => {
            if (count > 0) {
                const [type, value] = key.split('-');
                let label = '';
                let icon = 'â“';
                switch(type) {
                    case 'points': label = `${value} Puan`; icon = 'ğŸ’°'; break;
                    case 'iflas': label = 'Ä°flas (Bomba)'; icon = 'ğŸ’£'; break;
                    case 'surpriz': label = 'SÃ¼rpriz Kutu'; icon = 'ğŸ‰'; break;
                    case 'multiplier': label = `${value}x Ã‡arpan`; icon = 'âœ–ï¸'; break;
                    case 'iflasShield': label = 'Ä°flas KalkanÄ±'; icon = 'ğŸ›¡ï¸'; break;
                    case 'wheelTicket': label = 'Ã‡ark Bileti'; icon = 'ï¸ğŸ«'; break;
                    case 'clickCatchTicket': label = 'TÄ±kla-Yakala Bileti'; icon = 'ğŸŸï¸'; break;
                    case 'wildcard': label = 'Joker Kart'; icon = 'ğŸƒ'; break;
                    case 'card_pack': label = 'Standart Kart Paketi'; icon = 'ğŸ´'; break;
                    case 'card_pack_normal': label = 'Bronz Kart Paketi'; icon = 'ğŸ¥‰'; break;
                    case 'card_pack_gumus': label = 'GÃ¼mÃ¼ÅŸ Kart Paketi'; icon = 'ğŸ¥ˆ'; break;
                    case 'card_pack_altin': label = 'AltÄ±n Kart Paketi'; icon = 'ğŸ¥‡'; break;
                    case 'card_pack_efsanevi': label = 'Efsanevi Kart Paketi'; icon = 'ğŸ†'; break;
                }
                html += `<p class="flex justify-between items-center p-2 bg-gray-800 rounded mb-2 text-white"><span>${icon} ${label}</span> <span class="font-bold text-yellow-300">${count} Adet</span></p>`;
            }
        });

        listEl.innerHTML = html || '<p class="text-center text-gray-400">TÃ¼m kutular aÃ§Ä±lmÄ±ÅŸ!</p>';

    } catch (error) {
        console.error("Kalan iÃ§erik yÃ¼klenirken hata:", error);
        listEl.innerHTML = '<p class="text-red-500">Ä°Ã§erik yÃ¼klenemedi.</p>';
    }

    document.getElementById('unopenedBoxContentsModal').style.display = 'flex';
}

    function closeUnopenedBoxContentsModal() {
    document.getElementById('unopenedBoxContentsModal').style.display = 'none';
}

    async function showAnnouncementLikes(announcementId) {
        const likesRef = db.ref(`announcements/${announcementId}/likedBy`);
        const likesSnap = await likesRef.once('value');
        const likers = likesSnap.val();
        
        const listEl = document.getElementById('announcementLikesList');
        listEl.innerHTML = '';

        if (!likers) {
            listEl.innerHTML = '<p class="text-gray-400">Bu duyuruyu henÃ¼z kimse beÄŸenmedi.</p>';
        } else {
            const usernames = Object.keys(likers);
            usernames.forEach(username => {
                listEl.innerHTML += `<div class="p-2 bg-gray-800 rounded mb-2 text-white">${username}</div>`;
            });
        }
        
        announcementLikesModal.style.display = 'flex';
    }

    function closeAnnouncementLikesModal() {
        announcementLikesModal.style.display = 'none';
    }


    // YENÄ° GÃœNLÃœK Ã–DÃœL SÄ°STEMÄ° (ZAMAN AYARLI)
    function openNewDailyRewardForm() {
        resetDailyRewardForm();
        openAdminDailyRewardModal();
    }

    function openAdminDailyRewardModal() {
        adminDailyRewardModal.style.display = 'flex';
    }
    function closeAdminDailyRewardModal() {
        adminDailyRewardModal.style.display = 'none';
    }

    // DEÄÄ°ÅTÄ°RÄ°LECEK FONKSÄ°YON
function closeDailyRewardModal() { 
    Object.values(activeDailyRewardTimers).forEach(clearInterval);
    activeDailyRewardTimers = {};
    const dailyRewardModal = document.getElementById('dailyRewardModal');
    if (dailyRewardModal) {
        dailyRewardModal.style.display = 'none'; 
    }
}
    
    async function checkAvailableDailyRewards() {
    if (isAdmin) {
        document.getElementById('dailyRewardIndicator').classList.add('hidden');
        return;
    }

    const userSnap = await db.ref('users/' + currentUser).once('value');
    const user = userSnap.val();
    const rewardsSnap = await db.ref('dailyRewardOptions').once('value');
    const rewards = rewardsSnap.val();

    if (!rewards || !user) {
        document.getElementById('dailyRewardIndicator').classList.add('hidden');
        return;
    }

    const userClaims = user.dailyRewardsClaimed || {};
    let hasAvailableReward = false;

    for (const rewardId in rewards) {
        const reward = rewards[rewardId];
        const cooldown = reward.cooldownMs || 0;
        const lastClaim = userClaims[rewardId] || 0;

        // --- DEÄÄ°ÅTÄ°RÄ°LEN VE DÃœZELTÄ°LEN MANTIK BAÅLANGICI ---
        let isAvailable = false;
        // 1. Durum: Ã–dÃ¼l tek seferlik ise (bekleme sÃ¼resi 0 ise)
        if (cooldown === 0) {
            // Sadece daha Ã¶nce hiÃ§ alÄ±nmadÄ±ysa (lastClaim === 0) mÃ¼saittir.
            isAvailable = (lastClaim === 0);
        }
        // 2. Durum: Ã–dÃ¼lÃ¼n bekleme sÃ¼resi varsa
        else {
            // Sadece bekleme sÃ¼resi dolduysa mÃ¼saittir.
            isAvailable = (Date.now() > lastClaim + cooldown);
        }

        if (isAvailable) {
            hasAvailableReward = true;
            break; // MÃ¼sait bir Ã¶dÃ¼l bulduk, dÃ¶ngÃ¼yÃ¼ sonlandÄ±rabiliriz.
        }
        // --- DEÄÄ°ÅTÄ°RÄ°LEN VE DÃœZELTÄ°LEN MANTIK SONU ---
    }
    
    if (hasAvailableReward) {
        document.getElementById('dailyRewardIndicator').classList.remove('hidden');
    } else {
        document.getElementById('dailyRewardIndicator').classList.add('hidden');
    }
}
    
async function openDailyRewardModal() {
    const dailyRewardModal = document.getElementById('dailyRewardModal');
    if (!dailyRewardModal) {
        console.error("HATA: 'dailyRewardModal' elementi HTML'de bulunamadÄ±!");
        displayMessage("GÃ¼nlÃ¼k Ã¶dÃ¼l penceresi aÃ§Ä±lamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.");
        return;
    }

    dailyRewardModal.style.display = 'flex';
    const container = document.getElementById('dailyRewardItemsContainer');
    container.innerHTML = '<p class="text-center col-span-full text-gray-400">Ã–dÃ¼ller yÃ¼kleniyor...</p>';
    document.getElementById('dailyRewardMessage').textContent = 'AÅŸaÄŸÄ±daki Ã¶dÃ¼llerden alabileceklerini topla. Bol ÅŸans!';

    if (isAdmin) {
        document.getElementById('adminDailyRewardManagementButtonContainer').classList.remove('hidden');
    } else {
        document.getElementById('adminDailyRewardManagementButtonContainer').classList.add('hidden');
    }

    try {
        const userSnap = await db.ref('users/' + currentUser).once('value');
        const user = userSnap.val();
        const rewardsRef = db.ref('dailyRewardOptions');
        const rewardsSnap = await rewardsRef.orderByChild('order').once('value');
        
        if (!rewardsSnap.exists()) {
            container.innerHTML = '<p class="text-center col-span-full">Åu anda mevcut bir gÃ¼nlÃ¼k Ã¶dÃ¼l bulunmamaktadÄ±r.</p>';
            return;
        }

        container.innerHTML = ''; 

        const rewardsArray = [];
        rewardsSnap.forEach(childSnap => {
            rewardsArray.push([childSnap.key, childSnap.val()]);
        });

        const userClaims = user ? (user.dailyRewardsClaimed || {}) : {};
        
        rewardsArray.forEach(([rewardId, reward], index) => {
            const lastClaim = userClaims[rewardId] || 0;
            const cooldown = reward.cooldownMs || 0;
            const nextAvailableTime = lastClaim + cooldown;

            // --- DEÄÄ°ÅTÄ°RÄ°LEN KONTROL MANTIÄI BAÅLANGICI ---
            let canClaim = false;
            if (!isAdmin) {
                // EÄŸer bekleme sÃ¼resi 0 ise (tek seferlik) VE daha Ã¶nce alÄ±nmamÄ±ÅŸsa (lastClaim === 0), alÄ±nabilir.
                if (cooldown === 0) {
                    canClaim = (lastClaim === 0);
                } 
                // EÄŸer bekleme sÃ¼resi varsa, normal zaman kontrolÃ¼ yapÄ±lÄ±r.
                else {
                    canClaim = (Date.now() > nextAvailableTime);
                }
            }
            // --- DEÄÄ°ÅTÄ°RÄ°LEN KONTROL MANTIÄI SONU ---


            const card = document.createElement('div');
            card.className = 'relative bg-gray-900 p-4 rounded-xl shadow-lg border border-yellow-600 text-center flex flex-col justify-between';
            
            let adminControlsHtml = '';
            if(isAdmin){
                const leftArrowDisabled = index === 0 ? 'disabled' : '';
                const rightArrowDisabled = index === rewardsArray.length - 1 ? 'disabled' : '';
                
                adminControlsHtml = `
                  <div class="admin-controls absolute top-0 right-0 p-1 bg-gray-900 bg-opacity-70 rounded-bl-lg flex gap-1 z-10">
                      <button onclick="reorderDailyRewardItem('${rewardId}', ${index - 1})" ${leftArrowDisabled} title="Sola TaÅŸÄ±" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/></svg></button>
                      <button onclick="editDailyReward('${rewardId}')" title="DÃ¼zenle" class="p-1 rounded-full hover:bg-gray-700"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a1 1 0 011-1h2.586l-2 2H6v3h3v-1.586l2-2H13a1 1 0 011 1v5a1 1 0 01-1 1H6a1 1 0 01-1-1v-2z"/></svg></button>
                      <button onclick="removeDailyReward('${rewardId}')" title="Sil" class="p-1 rounded-full hover:bg-gray-700"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"/></svg></button>
                      <button onclick="reorderDailyRewardItem('${rewardId}', ${index + 1})" ${rightArrowDisabled} title="SaÄŸa TaÅŸÄ±" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg></button>
                  </div>`;
            }
            
            let buttonHTML = '<button id="claim-reward-btn-' + rewardId + '" onclick="claimDailyReward(\'' + rewardId + '\')" class="w-full py-2 mt-auto bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition duration-300">Ã–dÃ¼lÃ¼ Al</button>';
            let cooldownHTML = '<div class="text-sm text-gray-500 font-bold mb-3 h-5">SÃ¼re: ' + (reward.cooldownText || 'Tek Seferlik') + '</div>';

            if (isAdmin || !canClaim) {
                const disabledState = isAdmin ? 'disabled' : '';
                buttonHTML = '<button ' + disabledState + ' class="w-full py-2 mt-auto bg-gray-600 cursor-not-allowed text-white font-bold rounded-lg transition duration-300">' + (isAdmin ? 'Admin' : 'AlÄ±ndÄ±') + '</button>';

                if (!isAdmin) {
                   cooldownHTML = '<div id="reward-cooldown-' + rewardId + '" class="text-sm text-yellow-300 font-bold mb-3 h-5"></div>';
                    
                    if (activeDailyRewardTimers[rewardId]) clearInterval(activeDailyRewardTimers[rewardId]);

                    const timerId = setInterval(() => {
                        const now = Date.now();
                        const timeLeft = nextAvailableTime - now;
                        const el = document.getElementById('reward-cooldown-' + rewardId);
                        if (!el) {
                            clearInterval(timerId);
                            return;
                        }

                        if (timeLeft <= 0) {
                            // DEÄÄ°ÅTÄ°RÄ°LEN KISIM: Tek seferlik Ã¶dÃ¼ller iÃ§in bu blok Ã§alÄ±ÅŸmamalÄ±.
                            if(cooldown > 0){
                                el.innerHTML = '<span class="text-green-400">Åimdi AlÄ±nabilir!</span>';
                                const claimButton = el.closest('.relative').querySelector('button');
                                if (claimButton) {
                                    claimButton.id = 'claim-reward-btn-' + rewardId;
                                    claimButton.disabled = false;
                                    claimButton.onclick = () => claimDailyReward(rewardId);
                                    claimButton.classList.replace('bg-gray-600', 'bg-green-600');
                                    claimButton.classList.add('hover:bg-green-500');
                                    claimButton.textContent = 'Ã–dÃ¼lÃ¼ Al';
                                }
                            } else {
                                el.innerHTML = '<span class="text-red-400">Bu Ã¶dÃ¼l zaten alÄ±ndÄ±.</span>';
                            }
                            clearInterval(timerId);
                        } else {
                            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                            
                            let parts = [];
                            if (days > 0) parts.push(days + 'g');
                            if (hours > 0) parts.push(hours + 'sa');
                            if (minutes > 0) parts.push(minutes + 'd');
                            if (seconds >= 0) parts.push(seconds + 'sn');

                            el.textContent = 'Kalan SÃ¼re: ' + parts.join(' ');
                        }
                    }, 1000);
                    activeDailyRewardTimers[rewardId] = timerId;
                }
            }

            card.innerHTML = `
                ${adminControlsHtml}
                <div>
                    <img src="${reward.imageUrl || 'https://via.placeholder.com/150'}" alt="${reward.name}" class="w-20 h-20 mx-auto mb-3 rounded-lg object-cover">
                    <h4 class="text-yellow-300 text-lg font-bold">${reward.name}</h4>
                    <p class="text-gray-400 text-sm mb-3">${reward.description}</p>
                    ${cooldownHTML}
                </div>
                ${buttonHTML}
            `;
            container.appendChild(card);
        });
    } catch (error) {
        console.error("GÃ¼nlÃ¼k Ã¶dÃ¼ller yÃ¼klenirken bir hata oluÅŸtu:", error);
        container.innerHTML = '<p class="text-center col-span-full text-red-500">Ã–dÃ¼ller yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen daha sonra tekrar deneyin.</p>';
    }
}
      
// MEVCUT claimDailyReward FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIRIN

async function claimDailyReward(rewardId) {
    if (isAdmin) {
        displayMessage("Adminler Ã¶dÃ¼l alamaz.");
        return;
    }

    const claimButton = document.getElementById(`claim-reward-btn-${rewardId}`);
    if (claimButton && claimButton.disabled) {
        return;
    }
    if (claimButton) {
        claimButton.disabled = true;
        claimButton.textContent = 'Ä°ÅŸleniyor...';
    }

    try {
        const userRef = db.ref(`users/${currentUser}`);
        const rewardRef = db.ref('dailyRewardOptions/' + rewardId);

        const [userSnap, rewardSnap] = await Promise.all([userRef.once('value'), rewardRef.once('value')]);
        const user = userSnap.val();
        const reward = rewardSnap.val();

        if (!reward) {
            throw new Error("Ã–dÃ¼l bulunamadÄ±.");
        }

        const lastClaim = (user.dailyRewardsClaimed && user.dailyRewardsClaimed[rewardId]) || 0;
        const cooldown = reward.cooldownMs || 0;
        if (cooldown === 0 && lastClaim > 0) {
            throw new Error("Bu tek seferlik Ã¶dÃ¼lÃ¼ zaten aldÄ±nÄ±z.");
        }
        if (cooldown > 0 && getSyncedTime() < lastClaim + cooldown) {
            throw new Error("Bu Ã¶dÃ¼l iÃ§in bekleme sÃ¼resi henÃ¼z dolmadÄ±.");
        }
        
        if (reward.type === 'tempMultiplier') {
            const hasActiveMultiplier = (user.multiplierSource === 'box') || (user.multiplierSource === 'store' && (user.multiplierRemainingUses || 0) > 0);
            if (hasActiveMultiplier) {
                const rewardValue = parseInt(reward.value);
                const userMultiplierValue = parseInt(user.activeMultiplier);
                
                if (rewardValue === userMultiplierValue) {
                    const confirmedStack = await customConfirm(`Zaten ${user.activeMultiplier}x Ã§arpanÄ±n var. Bu Ã¶dÃ¼l, mevcut Ã§arpanÄ±na <b>+${reward.uses} kullanÄ±m hakkÄ±</b> ekleyecek. OnaylÄ±yor musun?`);
                    if (!confirmedStack) throw new Error("KullanÄ±cÄ± iptal etti.");
                } else if (rewardValue > userMultiplierValue) {
                    const kutuHakkiDonusum = user.multiplierRemainingUses || 0;
                    const confirmedUpgrade = await customConfirm(`Mevcut ${user.activeMultiplier}x Ã§arpanÄ±nÄ± daha yÃ¼ksek olan <b>${rewardValue}x</b> ile deÄŸiÅŸtirmek Ã¼zeresin. Mevcut Ã§arpanÄ±nÄ±n kalan <b>${user.multiplierRemainingUses} kullanÄ±m hakkÄ±</b>, envanterine <b>+${kutuHakkiDonusum} Kutu HakkÄ±</b> olarak eklenecek. OnaylÄ±yor musun?`);
                    if (!confirmedUpgrade) throw new Error("KullanÄ±cÄ± iptal etti.");
                } else {
                    const kutuHakkiDonusum = reward.uses || 0;
                    const confirmedConvert = await customConfirm(`Mevcut <b>${user.activeMultiplier}x</b> Ã§arpanÄ±n bu <b>${rewardValue}x</b> Ã¶dÃ¼lÃ¼nden daha gÃ¼Ã§lÃ¼. Bu Ã¶dÃ¼lÃ¼ alÄ±rsan, Ã§arpanÄ±n deÄŸiÅŸmeyecek ancak Ã¶dÃ¼lÃ¼n <b>${reward.uses} kullanÄ±m hakkÄ±</b>, envanterine <b>+${kutuHakkiDonusum} Kutu HakkÄ±</b> olarak eklenecek. OnaylÄ±yor musun?`);
                    if (!confirmedConvert) throw new Error("KullanÄ±cÄ± iptal etti.");
                }
            }
        }
        
        const cardPacksToOpen = [];
        let activityLogDetails = {};

        const { committed, snapshot } = await userRef.transaction(userData => {
            if (userData) {
                if (!userData.dailyRewardsClaimed) {
                    userData.dailyRewardsClaimed = {};
                }
                
                const lastClaimCheck = userData.dailyRewardsClaimed[rewardId] || 0;
                if (reward.cooldownMs === 0 && lastClaimCheck > 0) return;
                if (reward.cooldownMs > 0 && getSyncedTime() < lastClaimCheck + reward.cooldownMs) return;

                userData.dailyRewardsClaimed[rewardId] = getSyncedTime();

                switch (reward.type) {
                    case 'points':
                        userData.balance = (userData.balance || 0) + reward.value;
                        userData.kariyerPuani = (userData.kariyerPuani || 0) + reward.value;
                        activityLogDetails = { newBalance: userData.balance };
                        break;
                    case 'boxRights': userData.kutuHakki = (userData.kutuHakki || 0) + reward.value; break;
                    case 'wheelTicket': userData.carkBileti = (userData.carkBileti || 0) + reward.value; break;
                    case 'clickCatchTicket': userData.clickCatchTickets = (userData.clickCatchTickets || 0) + reward.value; break;
                    case 'iflasShield': userData.iflasShieldUses = (userData.iflasShieldUses || 0) + reward.value; break;
                    case 'wildcard': userData.wildcards = (userData.wildcards || 0) + reward.value; break;
                    case 'tempMultiplier':
                        const hasActiveMultiplier = (userData.multiplierSource === 'box') || (userData.multiplierSource === 'store' && (userData.multiplierRemainingUses || 0) > 0);
                        if (hasActiveMultiplier) {
                            const rewardValue = parseInt(reward.value);
                            const userMultiplierValue = parseInt(userData.activeMultiplier);
                            if (rewardValue === userMultiplierValue) {
                                userData.multiplierRemainingUses = (userData.multiplierRemainingUses || 0) + reward.uses;
                                logActivity('dailyRewardMultiplierStacked', currentUser, { source: "GÃ¼nlÃ¼k Ã–dÃ¼l'den", usesAdded: reward.uses, newTotalUses: userData.multiplierRemainingUses, multiplierValue: rewardValue });
                            } else if (rewardValue > userMultiplierValue) {
                                const refundedBoxRights = userData.multiplierRemainingUses || 0;
                                logActivity('multiplierUpgraded', currentUser, { 
                                    source: "GÃ¼nlÃ¼k Ã–dÃ¼l", 
                                    oldValue: userMultiplierValue, 
                                    oldUses: refundedBoxRights, 
                                    newValue: rewardValue, 
                                    newUses: reward.uses, 
                                    boxRights: refundedBoxRights 
                                });
                                userData.kutuHakki = (userData.kutuHakki || 0) + refundedBoxRights;
                                userData.activeMultiplier = reward.value;
                                userData.multiplierRemainingUses = reward.uses;
                                userData.multiplierSource = 'store';
                            } else {
                                userData.kutuHakki = (userData.kutuHakki || 0) + (reward.uses || 0);
                                logActivity('dailyRewardMultiplierConverted', currentUser, { keptMultiplierValue: userMultiplierValue, boxRights: reward.uses, rewardValue: rewardValue, source: "GÃ¼nlÃ¼k Ã–dÃ¼l'den" });
                            }
                        } else {
                            userData.activeMultiplier = reward.value;
                            userData.multiplierRemainingUses = reward.uses;
                            userData.multiplierSource = 'store';
                        }
                        activityLogDetails = { rewardUses: reward.uses };
                        break;
                    case 'avatar':
                        const newAvatarId = db.ref().push().key;
                        if (!userData.avatars) userData.avatars = {};
                        userData.avatars[newAvatarId] = { id: newAvatarId, name: reward.avatarName, imageUrl: reward.avatarImageUrl };
                        break;
                    case 'card_pack':
                    case 'card_pack_normal':
                    case 'card_pack_gumus':
                    case 'card_pack_altin':
                    case 'card_pack_efsanevi':
                        cardPacksToOpen.push(reward);
                        break;
                    // --- DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR: ArtÄ±k inventory anahtarÄ± kontrol ediliyor ---
                    case 'revival_stone':
                        if (!userData.inventory) userData.inventory = {};
                        userData.inventory.revival_stone = (userData.inventory.revival_stone || 0) + reward.value;
                        break;
                    case 'health_regen_potion':
                        if(!userData.inventory) userData.inventory = {};
                        if(!userData.inventory.health_regen_potion) userData.inventory.health_regen_potion = {};
                        const currentPotions = userData.inventory.health_regen_potion[reward.value] || 0;
                        userData.inventory.health_regen_potion[reward.value] = currentPotions + 1;
                        break;
                    // --- DEÄÄ°ÅÄ°KLÄ°K SONU ---
                    case 'health_potion': case 'damage_potion': case 'defense_potion':
                    case 'crit_potion': case 'crit_damage_potion': case 'dodge_potion': case 'pierce_potion':
                        const statKeyMap = { 
                            'health_potion': 'hp', 'damage_potion': 'damage', 'defense_potion': 'defense', 
                            'crit_potion': 'critChance', 'crit_damage_potion': 'critDamage', 
                            'dodge_potion': 'dodgeChance', 'pierce_potion': 'pierceChance' 
                        };
                        const statKey = statKeyMap[reward.type];
                        if (statKey) {
                            if (!userData.globalPotionBuffs) userData.globalPotionBuffs = {};
                            userData.globalPotionBuffs[statKey] = (userData.globalPotionBuffs[statKey] || 0) + reward.value;
                        }
                        break;
                }
            }
            return userData;
        });

        if (committed) {
             const isPercent = ['defense_potion', 'crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion', 'health_regen_potion'].includes(reward.type);
             const valuePrefix = isPercent ? `+%${reward.value}` : `+${reward.value}`;
             const rewardNameForMessage = reward.type === 'avatar' ? `'${reward.avatarName}' AvatarÄ±` : `${valuePrefix} ${typeToName[reward.type] || 'Ã–dÃ¼l'}`;
             
            displayMessage(`Tebrikler! '${reward.name}' Ã¶dÃ¼lÃ¼nÃ¼ baÅŸarÄ±yla aldÄ±n: ${rewardNameForMessage}`);
            
            logActivity('dailyReward', currentUser, { 
                ...activityLogDetails, 
                rewardName: reward.name, 
                rewardType: reward.type, 
                rewardValue: reward.type === 'avatar' ? reward.avatarName : reward.value 
            });
            
            const hasPotion = reward.type.includes('_potion');
            if (hasPotion && currentActiveSection === 'monsterBattle') { renderMonsterBattleUI(); }

            for (const pack of cardPacksToOpen) {
                await startCardPackOpening(pack.value || 1, 'GÃ¼nlÃ¼k Ã–dÃ¼l', 1, pack.type);
            }
            
            await openDailyRewardModal();
            await checkAvailableDailyRewards();
        } else {
            throw new Error("Ã–dÃ¼l alÄ±namadÄ±. KoÅŸullar saÄŸlanmÄ±yor olabilir, lÃ¼tfen sayfayÄ± yenileyip tekrar deneyin.");
        }

    } catch (error) {
        if (error.message !== "KullanÄ±cÄ± iptal etti.") {
            console.error("GÃ¼nlÃ¼k Ã¶dÃ¼l alÄ±nÄ±rken hata:", error);
            displayMessage("Bir hata oluÅŸtu: " + error.message);
        }
    } finally {
        if (claimButton) {
            claimButton.disabled = false;
            claimButton.textContent = 'Ã–dÃ¼lÃ¼ Al';
        }
    }
}
      
function handleDailyRewardTypeChange() {
    const type = document.getElementById('dailyRewardType').value;
    const valueInput = document.getElementById('dailyRewardValue');
    const usesInput = document.getElementById('dailyRewardMultiplierUses');
    const avatarFields = document.getElementById('dailyRewardAvatarFields');

    // Ã–nce tÃ¼m Ã¶zel alanlarÄ± gizle
    valueInput.classList.remove('hidden');
    usesInput.classList.add('hidden');
    avatarFields.classList.add('hidden');

    if (type === 'tempMultiplier') {
        usesInput.classList.remove('hidden');
    } else if (type === 'avatar') {
        valueInput.classList.add('hidden'); // Avatar iÃ§in "DeÄŸer" alanÄ± gereksiz
        avatarFields.classList.remove('hidden');
    }
}
// Bu event listener'Ä± script'in en altÄ±na veya uygun bir yere ekleyin.
document.getElementById('dailyRewardType').addEventListener('change', handleDailyRewardTypeChange);

    function resetDailyRewardForm() {
    document.getElementById('dailyRewardName').value = '';
    document.getElementById('dailyRewardDescription').value = '';
    document.getElementById('dailyRewardType').value = '';
    document.getElementById('dailyRewardValue').value = '';
    document.getElementById('dailyRewardMultiplierUses').value = '';
    document.getElementById('dailyRewardCooldownDays').value = '';
    document.getElementById('dailyRewardCooldownHours').value = '';
    document.getElementById('dailyRewardCooldownMinutes').value = '';
    document.getElementById('dailyRewardCooldownSeconds').value = '';
    document.getElementById('dailyRewardImageUrl').value = '';
    
    // YENÄ° EKLENEN SATIRLAR
    document.getElementById('dailyRewardAvatarName').value = '';
    document.getElementById('dailyRewardAvatarImageUrl').value = '';
    
    document.getElementById('saveDailyRewardBtn').textContent = 'GÃœNLÃœK Ã–DÃœL OLUÅTUR';
    editingDailyRewardId = null;
    
    // Formun gÃ¶rsel durumunu da sÄ±fÄ±rla
    handleDailyRewardTypeChange();
}

    // MEVCUT saveDailyReward FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR
async function saveDailyReward() {
    if (!isAdmin) return;
    
    const name = document.getElementById('dailyRewardName').value.trim();
    const type = document.getElementById('dailyRewardType').value;
    const description = document.getElementById('dailyRewardDescription').value.trim();
    const imageUrl = document.getElementById('dailyRewardImageUrl').value.trim();
    
    const days = parseInt(document.getElementById('dailyRewardCooldownDays').value) || 0;
    const hours = parseInt(document.getElementById('dailyRewardCooldownHours').value) || 0;
    const minutes = parseInt(document.getElementById('dailyRewardCooldownMinutes').value) || 0;
    const seconds = parseInt(document.getElementById('dailyRewardCooldownSeconds').value) || 0;

    if (!name || !type || !description) {
        displayMessage("LÃ¼tfen Ã¶dÃ¼l iÃ§in tÃ¼m zorunlu alanlarÄ± (Ad, Tip, AÃ§Ä±klama) doldurun.");
        return;
    }

    const cooldownMs = (days * 24 * 3600 + hours * 3600 + minutes * 60 + seconds) * 1000;
    let cooldownText = '';
    if(days > 0) cooldownText += `${days}g `;
    if(hours > 0) cooldownText += `${hours}s `;
    if(minutes > 0) cooldownText += `${minutes}d `;
    if(seconds > 0) cooldownText += `${seconds}sn`;
    if (cooldownText === '') cooldownText = 'Tek Seferlik';

    const rewardData = { name, type, description, cooldownMs, cooldownText, imageUrl: imageUrl || 'https://via.placeholder.com/150' };

    if (editingDailyRewardId) {
        const existingRewardSnap = await db.ref('dailyRewardOptions/' + editingDailyRewardId).once('value');
        const existingReward = existingRewardSnap.val();
        rewardData.order = existingReward.order;
    } else {
        const maxOrderSnap = await db.ref('dailyRewardOptions').orderByChild('order').limitToLast(1).once('value');
        let maxOrder = -1;
        if(maxOrderSnap.exists()){ maxOrder = Object.values(maxOrderSnap.val())[0].order || 0; }
        rewardData.order = maxOrder + 1;
    }

    if (type === 'tempMultiplier') {
        const value = parseInt(document.getElementById('dailyRewardValue').value);
        const uses = parseInt(document.getElementById('dailyRewardMultiplierUses').value);
        if (isNaN(uses) || uses <= 0 || isNaN(value) || value <= 0) {
            displayMessage("Ã‡arpan iÃ§in geÃ§erli bir 'DeÄŸer' ve 'KullanÄ±m HakkÄ±' girin.");
            return;
        }
        rewardData.uses = uses;
        rewardData.value = value;
    } else if (type === 'avatar') {
        const avatarName = document.getElementById('dailyRewardAvatarName').value.trim();
        const avatarImageUrl = document.getElementById('dailyRewardAvatarImageUrl').value.trim();
        if (!avatarName || !avatarImageUrl) {
            displayMessage("Avatar Ã¶dÃ¼lÃ¼ iÃ§in Avatar AdÄ± ve Resim URL'si zorunludur.");
            return;
        }
        rewardData.avatarName = avatarName;
        rewardData.avatarImageUrl = avatarImageUrl;
    } else {
        // â˜…â˜…â˜… YÃœZDE DEÄERLERÄ° Ä°Ã‡Ä°N DEÄÄ°ÅEN KISIM BAÅLANGICI â˜…â˜…â˜…
        // ArtÄ±k ondalÄ±klÄ± sayÄ±larÄ± da doÄŸru iÅŸleyen parseStatValue fonksiyonunu kullanÄ±yoruz.
        const value = parseStatValue(type, document.getElementById('dailyRewardValue').value);
        if (isNaN(value) || value <= 0) {
            displayMessage("Bu Ã¶dÃ¼l tipi iÃ§in geÃ§erli bir 'DeÄŸer' girmelisiniz.");
            return;
        }
        rewardData.value = value;
        // â˜…â˜…â˜… DEÄÄ°ÅEN KISIM SONU â˜…â˜…â˜…
    }
    
    if (editingDailyRewardId) {
        await db.ref('dailyRewardOptions/' + editingDailyRewardId).update(rewardData);
        displayMessage("GÃ¼nlÃ¼k Ã¶dÃ¼l baÅŸarÄ±yla gÃ¼ncellendi.");
    } else {
        await db.ref('dailyRewardOptions').push(rewardData);
        displayMessage("Yeni gÃ¼nlÃ¼k Ã¶dÃ¼l baÅŸarÄ±yla oluÅŸturuldu.");
    }
    
    resetDailyRewardForm();
    closeAdminDailyRewardModal();
    openDailyRewardModal();
}
    
    // DEÄÄ°ÅTÄ°RÄ°LECEK FONKSÄ°YON
async function reorderDailyRewardItem(rewardId, newIndex) {
    if (!isAdmin) return;
    const rewardsRef = db.ref('dailyRewardOptions');
    const rewardsSnap = await rewardsRef.once('value');
    const rewards = rewardsSnap.val();
    if (!rewards) return;

    let sortedRewards = Object.entries(rewards).sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));
    
    const itemToMoveIndex = sortedRewards.findIndex(([id]) => id === rewardId);
    if (itemToMoveIndex === -1) return;

    if (newIndex < 0 || newIndex >= sortedRewards.length) return;

    const [movedItem] = sortedRewards.splice(itemToMoveIndex, 1);
    sortedRewards.splice(newIndex, 0, movedItem);

    const updates = {};
    sortedRewards.forEach(([id], index) => {
      updates[`dailyRewardOptions/${id}/order`] = index;
    });
    
    await db.ref().update(updates);
}

    async function editDailyReward(rewardId) {
    if (!isAdmin) return;
    
    const rewardSnap = await db.ref('dailyRewardOptions/' + rewardId).once('value');
    const reward = rewardSnap.val();
    if (!reward) {
        displayMessage("DÃ¼zenlenecek Ã¶dÃ¼l bulunamadÄ±.");
        return;
    }
    
    document.getElementById('dailyRewardName').value = reward.name;
    document.getElementById('dailyRewardDescription').value = reward.description;
    document.getElementById('dailyRewardType').value = reward.type;
    document.getElementById('dailyRewardImageUrl').value = reward.imageUrl || '';
    
    const cooldownMs = reward.cooldownMs || 0;
    const days = Math.floor(cooldownMs / (1000 * 60 * 60 * 24));
    const hours = Math.floor((cooldownMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((cooldownMs % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((cooldownMs % (1000 * 60)) / 1000);

    document.getElementById('dailyRewardCooldownDays').value = days;
    document.getElementById('dailyRewardCooldownHours').value = hours;
    document.getElementById('dailyRewardCooldownMinutes').value = minutes;
    document.getElementById('dailyRewardCooldownSeconds').value = seconds;

    // TÄ°PE GÃ–RE Ã–ZEL ALANLARI DOLDUR
    if (reward.type === 'tempMultiplier') {
        document.getElementById('dailyRewardValue').value = reward.value || '';
        document.getElementById('dailyRewardMultiplierUses').value = reward.uses || '';
    } else if (reward.type === 'avatar') {
        document.getElementById('dailyRewardAvatarName').value = reward.avatarName || '';
        document.getElementById('dailyRewardAvatarImageUrl').value = reward.avatarImageUrl || '';
    } else {
        document.getElementById('dailyRewardValue').value = reward.value || '';
    }

    document.getElementById('saveDailyRewardBtn').textContent = 'Ã–DÃœLÃœ GÃœNCELLE';
    editingDailyRewardId = rewardId;
    
    handleDailyRewardTypeChange(); // Formun gÃ¶rsel durumunu gÃ¼ncelle
    openAdminDailyRewardModal(); 
    document.querySelector('#adminDailyRewardModal .modal-content').scrollTop = 0;
}

    async function removeDailyReward(rewardId) {
        if (!isAdmin) return;
        if (await customConfirm("Bu gÃ¼nlÃ¼k Ã¶dÃ¼lÃ¼ silmek istediÄŸinizden emin misiniz?")) {
            await db.ref('dailyRewardOptions/' + rewardId).remove();
            displayMessage("GÃ¼nlÃ¼k Ã¶dÃ¼l kaldÄ±rÄ±ldÄ±.");
            openDailyRewardModal();
        }
    }
  
    function listenForDailyRewardChanges() {
        const ref = db.ref('dailyRewardOptions');
        const callback = snap => {
            if (dailyRewardModal.style.display === 'flex') {
                openDailyRewardModal();
            }
            checkAvailableDailyRewards();
        };
        activeListeners.dailyRewards = { ref, event: 'value', callback };
        ref.on('value', callback);
    }
  
    function openBoxStatsModal() {
      const listEl = document.getElementById('boxStatsList');
      listEl.innerHTML = 'YÃ¼kleniyor...';
      db.ref('gameStats/boxesOpenedByUsers').orderByValue().once('value').then(snap => {
          const stats = snap.val();
          if (!stats) {
              listEl.innerHTML = '<p class="text-center text-gray-400">Bu turda henÃ¼z kimse kutu aÃ§madÄ±.</p>';
          } else {
              let html = '';
              const sortedUsers = Object.entries(stats).sort(([, countA], [, countB]) => countB - countA);
              sortedUsers.forEach(([user, count]) => {
                  html += `<p class="p-2 bg-gray-800 rounded mb-2">${user}: <span class="font-bold text-yellow-300">${count}</span> kutu</p>`;
              });
              listEl.innerHTML = html;
          }
          boxStatsModal.style.display = 'flex';
      });
    }
    function closeBoxStatsModal() {
      boxStatsModal.style.display = 'none';
    }

    let surpriseSessionListener = null;

function openSpectatorModal(sessionData) {
    if (spectatorCountdownInterval) clearInterval(spectatorCountdownInterval);

    document.getElementById('spectatorTitle').innerHTML = `<span class="text-green-400 font-bold">${sessionData.user}</span> SÃ¼rpriz Kutu buldu!`;
    const cardContainer = document.getElementById('spectatorCardContainer');
    cardContainer.innerHTML = '';

    sessionData.cards.forEach((cardValue, index) => {
        const cardDiv = document.createElement('div');
        // --- DEÄÄ°ÅÄ°KLÄ°K BURADA: 'bg-gray-700' class'Ä± kaldÄ±rÄ±ldÄ±. ---
        cardDiv.className = 'card border-2 border-red-700 rounded-xl w-28 h-40 flex flex-col items-center justify-center font-bold text-2xl relative';
        cardDiv.id = `spectator-card-${index}`;
        cardDiv.innerHTML = `<div class="card-back absolute inset-0 bg-gradient-to-br from-red-700 to-red-900 flex items-center justify-center text-white text-5xl">?</div><div class="card-front absolute inset-0 bg-gray-900 flex items-center justify-center text-yellow-400 text-3xl"></div>`;
        cardContainer.appendChild(cardDiv);
    });

    const resultContainer = document.getElementById('spectatorResultContainer');
    resultContainer.innerHTML = '<p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8"></p>';

    const countdownEl = document.getElementById('spectatorCountdown');
    let timeLeft = Math.round((sessionData.expirationTimestamp - getSyncedTime()) / 1000);

    const handleTimeout = () => {
        countdownEl.textContent = 'SÃ¼re Doldu!';
        const resultP = document.getElementById('spectatorResult');
        if (resultP) {
            resultP.textContent = 'Kart seÃ§ilmedi, puan kazanÄ±lamadÄ±.';
            resultP.className = 'text-xl text-red-400 font-bold h-8';
        }
        resultContainer.innerHTML += `<button onclick="closeSpectatorModal()" class="mt-4 py-3 px-8 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg transition-colors">Oyuna DÃ¶n</button>`;
    };

    if (timeLeft <= 0) {
        handleTimeout();
        spectatorModal.style.display = 'flex';
        return;
    }

    countdownEl.textContent = timeLeft;
    spectatorCountdownInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft >= 0) {
            countdownEl.textContent = timeLeft;
        } else {
            clearInterval(spectatorCountdownInterval);
            handleTimeout();
        }
    }, 1000);

    spectatorModal.style.display = 'flex';
}

function updateSpectatorView(sessionData) {
    spectatorViewingResult = true;

    if (spectatorCountdownInterval) {
        clearInterval(spectatorCountdownInterval);
        spectatorCountdownInterval = null;
    }
    document.getElementById('spectatorCountdown').textContent = 'SeÃ§im YapÄ±ldÄ±!';

    const selectedCardIndex = sessionData.selection.cardIndex;
    const allCards = document.querySelectorAll('#spectatorCardContainer .card');
    
    sessionData.cards.forEach((cardValue, index) => {
        const cardEl = allCards[index];
        if (cardEl) {
            const cardFront = cardEl.querySelector('.card-front');
            const realPoints = cardValue * (sessionData.multiplier || 1);
            cardFront.textContent = `+${realPoints}`;

            setTimeout(() => {
                cardEl.classList.add('opened');
                if (index == selectedCardIndex) {
                    cardEl.classList.add('glowing-border');
                }
            }, 100);
        }
    });

    const resultContainer = document.getElementById('spectatorResultContainer');
    if (resultContainer) {
         resultContainer.innerHTML = `
            <button onclick="closeSpectatorModal()" class="mt-4 py-3 px-8 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg transition-colors">
                Oyuna Devam Et
            </button>
        `;
    }
}


// MEVCUT showGlobalSurpriseBoxNotification FONKSÄ°YONUNU BU BLOK Ä°LE DEÄÄ°ÅTÄ°RÄ°N

function showGlobalSurpriseBoxNotification(data) {
    document.getElementById('surpriseOpener').textContent = data.user;
    
    const sourceInfoEl = document.getElementById('surpriseSourceInfo');
    if (data.boxId === 'Ã‡ark') {
        sourceInfoEl.innerHTML = `<b>Åans Ã‡arkÄ±</b>'ndan SÃ¼rpriz Kutu elde etti ve kart seÃ§iminden`;
    } else {
        sourceInfoEl.innerHTML = `<span class="text-red-400 font-bold">${data.boxId}</span> numaralÄ± kutuyu aÃ§tÄ± ve kart seÃ§iminden`;
    }

    document.getElementById('surprisePoints').textContent = data.result.points;
    
    // *** Ä°STEÄÄ°NÄ°ZE GÃ–RE DÃœZENLENEN KISIM BAÅLANGICI ***
    let multiplierText = ''; // VarsayÄ±lan olarak metni boÅŸ yapÄ±yoruz.
    // Sadece kutudan geldiyse Ã§arpan metnini gÃ¶ster
    if (data.boxId !== 'Ã‡ark') {
        if (data.multiplier && data.multiplier > 1) {
            const basePoints = Math.round(data.result.points / data.multiplier);
            multiplierText = `kazandÄ±! <br><span class="text-base text-gray-400">(${basePoints} Puan x ${data.multiplier} Ã‡arpan)</span>`;
        } else {
            multiplierText = 'kazandÄ±! (Ã‡arpan kullanÄ±lmadÄ±)';
        }
    } else {
        // Ã‡arktan geldiyse sadece "kazandÄ±!" yazsÄ±n.
        multiplierText = 'kazandÄ±!';
    }
    // *** DÃœZENLENEN KISIM SONU ***

    document.getElementById('surpriseMultiplierInfo').innerHTML = multiplierText;

    document.getElementById('globalSurpriseBoxModal').style.display = 'flex';
}

// MEVCUT closeSpectatorModal FONKSÄ°YONUNU BU BLOK Ä°LE DEÄÄ°ÅTÄ°RÄ°N

function closeSpectatorModal() {
    if (spectatorCountdownInterval) {
        clearInterval(spectatorCountdownInterval);
        spectatorCountdownInterval = null;
    }
    const spectatorModal = document.getElementById('spectatorModal');
    spectatorModal.style.display = 'none';

    const resultContainer = document.getElementById('spectatorResultContainer');
    if (resultContainer) {
        resultContainer.innerHTML = '<p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8"></p>';
    }

    // *** YENÄ° EKLENEN SATIR ***
    // Ä°zleyici pencereyi kapattÄ±ÄŸÄ± iÃ§in bayraÄŸÄ± sÄ±fÄ±rla
    spectatorViewingResult = false;
}
    
// ...VE YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTÄ°R
function renderWheel() {
    const wheelElement = document.getElementById('wheel');
    if (!wheelElement) { return; }
    
    wheelElement.innerHTML = ''; 

    const segments = wheelSegments;
    const segmentCount = segments.length;
    if (segmentCount === 0) return;

    // --- MANUEL AYAR NOKTAN BURASI ---
    // Bu sayÄ±yÄ± deÄŸiÅŸtirerek tÃ¼m simgelerin yÃ¶nÃ¼nÃ¼ ayarla.
    // Pozitif sayÄ± = Saat yÃ¶nÃ¼nde kaydÄ±rÄ±r.
    // Negatif sayÄ± = Saat yÃ¶nÃ¼nÃ¼n tersine kaydÄ±rÄ±r.
    // 0 = Tam ortaya alÄ±r.
    const angleOffset = 193; 
    // ------------------------------------

    const segmentAngle = 360 / segmentCount;
    let gradientParts = [];

    segments.forEach((segment, i) => {
        const startAngle = segmentAngle * i;
        const endAngle = startAngle + segmentAngle;
        gradientParts.push(`${segment.color || '#cccccc'} ${startAngle}deg ${endAngle}deg`);

        // HESAPLAMA BURADA DEÄÄ°ÅTÄ°: ArtÄ±k angleOffset'i hesaba katÄ±yor.
        const textAngle = startAngle + (segmentAngle / 2) + angleOffset;
        
        const textHolder = document.createElement('div');
        textHolder.className = 'wheel-text-container';
        textHolder.style.transform = `rotate(${textAngle}deg)`;

        if (segment.imageUrl && segment.imageUrl.trim() !== '') {
            const imageEl = document.createElement('img');
            imageEl.src = segment.imageUrl;
            imageEl.className = 'wheel-image';
            
            if (textAngle > 90 && textAngle < 270) {
                imageEl.style.transform = 'translate(-50%, -50%) rotate(180deg)';
            } else {
                imageEl.style.transform = 'translate(-50%, -50%)';
            }
            textHolder.appendChild(imageEl);
        } else {
            const textSpan = document.createElement('span');
            textSpan.className = 'wheel-text';
            textSpan.textContent = segment.label;

            if (textAngle > 90 && textAngle < 270) {
                textSpan.style.transform = 'translate(-50%, -50%) rotate(180deg)';
            } else {
                textSpan.style.transform = 'translate(-50%, -50%)';
            }
            textHolder.appendChild(textSpan);
        }
        
        wheelElement.appendChild(textHolder);
    });

    wheelElement.style.background = `conic-gradient(${gradientParts.join(', ')})`;
}
    function listenForLastWheelSurprisePanel() {
    const ref = db.ref('gameStats/lastWheelSurpriseInfo');
    const panel = document.getElementById('lastWheelSurprisePanel');

    const callback = snap => {
        const data = snap.val();
        if (!data || !data.finder) {
            panel.classList.add('hidden');
            return;
        }

        // --- DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR ---
        let adminDeleteButton = '';
        if (isAdmin) {
            adminDeleteButton = `
                <button onclick="silSonCarkSurprizi()" class="absolute -top-3 -right-3 bg-red-600 hover:bg-red-500 text-white rounded-full h-8 w-8 flex items-center justify-center text-lg font-bold transition-transform hover:scale-110" title="Bu Paneli Gizle">
                    &times;
                </button>
            `;
        }
        // --- DEÄÄ°ÅÄ°KLÄ°K BURADA BÄ°TÄ°YOR ---

        const finderHtml = `<b class="text-white">${data.finder}</b>`;
        const messageHtml = `
            ${adminDeleteButton}
            <h4 class="text-amber-300 text-lg font-bold">ğŸ¡ Ã‡ARKTAN SON Ã‡IKAN SÃœRPRÄ°Z! ğŸ¡</h4>
            <p>${finderHtml}, Ã§arktan SÃ¼rpriz Kutu kazandÄ±!</p>
            <p>Kart seÃ§iminden <b class="text-green-400">+${data.points} Puan</b> elde etti. <span class="text-gray-400">(Mevcut PuanÄ±: ${data.newBalance})</span></p>
        `;

        panel.innerHTML = messageHtml;
        panel.classList.add('relative'); // Butonun konumlanmasÄ± iÃ§in gerekli
        panel.classList.remove('hidden');
    };

    if (activeListeners.wheelSurprisePanel) {
        activeListeners.wheelSurprisePanel.ref.off('value', activeListeners.wheelSurprisePanel.callback);
    }
    activeListeners.wheelSurprisePanel = { ref, event: 'value', callback };
    ref.on('value', callback);
}

async function spinWheel() {
    if (isWheelSpinning) return;
    if (isAdmin) {
        displayMessage("Adminler Ã§ark Ã§eviremez.");
        return;
    }

    await db.ref('gameLock').set(true);

    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();

    if (!userData || (userData.carkBileti || 0) < 1) {
        displayMessage("Ã‡arkÄ± Ã§evirmek iÃ§in yeterli biletiniz yok.");
        await db.ref('gameLock').set(false);
        return;
    }

    const hasActiveMultiplier =
        (userData.multiplierSource === 'store' && (userData.multiplierRemainingUses || 0) > 0) ||
        (userData.multiplierSource === 'box');

    if (hasActiveMultiplier) {
        const confirmSpin = await customConfirm("Aktif bir Ã§arpanÄ±nÄ±z var. Ã‡arktan yeni bir Ã§arpan Ã§Ä±karsa, mevcut Ã§arpanÄ±nÄ±zÄ±n Ã¼zerine yazÄ±lÄ±r. Devam etmek istiyor musunuz?");
        if (!confirmSpin) {
            await db.ref('gameLock').set(false);
            return;
        }
    }

    isWheelSpinning = true;
    spinBtn.disabled = true;
    spinBtn.textContent = 'DÃ¶nÃ¼yor...';

    await userRef.update({
        carkBileti: userData.carkBileti - 1,
        wheelSpinsCount: (userData.wheelSpinsCount || 0) + 1
    });

    const totalWeight = wheelSegments.reduce((sum, seg) => sum + (seg.weight || 1), 0);
    let randomWeight = Math.random() * totalWeight;
    let winningIndex = -1;
    for (let i = 0; i < wheelSegments.length; i++) {
        randomWeight -= (wheelSegments[i].weight || 1);
        if (randomWeight < 0) {
            winningIndex = i;
            break;
        }
    }
    if (winningIndex === -1) winningIndex = 0;
    const winningSegment = wheelSegments[winningIndex];

    const totalSegments = wheelSegments.length;
    const degreesPerSegment = 360 / totalSegments;
    const winningAngle = (winningIndex * degreesPerSegment) + (degreesPerSegment / 2);

    const spinCycles = 5 + Math.floor(Math.random() * 3);

    const finalRotation = (spinCycles * 360) - winningAngle + 80;

    wheel.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
    wheel.style.transform = `rotate(${finalRotation}deg)`;

    setTimeout(async () => {
        isWheelSpinning = false;
        spinBtn.disabled = false;
        spinBtn.textContent = 'Ã‡arkÄ± Ã‡evir!';

        const currentUserDataSnap = await userRef.once('value');
        const currentUserData = currentUserDataSnap.val();

        if (!currentUserData) {
            console.error("Ã‡ark sonucu iÅŸlenirken kullanÄ±cÄ± verisi bulunamadÄ±!");
            displayMessage("Bir hata oluÅŸtu, Ã¶dÃ¼lÃ¼nÃ¼z iÅŸlenemedi. LÃ¼tfen sayfayÄ± yenileyin.");
            await db.ref('gameLock').set(false);
            return;
        }

        let message = '';
        let updates = {};
        let shouldLogActivity = true;

        switch(winningSegment.type) {
            case 'points':
                message = `Tebrikler, Ã§arktan <b>+${winningSegment.value} Puan</b> kazandÄ±n!`;
                updates.balance = (currentUserData.balance || 0) + winningSegment.value;
                if(updates.balance > (currentUserData.highestBalanceEver || 0)) updates.highestBalanceEver = updates.balance;
                updates.kariyerPuani = (currentUserData.kariyerPuani || 0) + winningSegment.value;
                break;
            case 'boxRights':
                message = `Tebrikler, Ã§arktan <b>+${winningSegment.value} Kutu HakkÄ±</b> kazandÄ±n!`;
                updates.kutuHakki = (currentUserData.kutuHakki || 0) + winningSegment.value;
                break;
            case 'iflasShield':
                message = `Tebrikler, Ã§arktan <b>+${winningSegment.value} Ä°flas KalkanÄ±</b> kazandÄ±n!`;
                updates.iflasShieldUses = (currentUserData.iflasShieldUses || 0) + winningSegment.value;
                break;
            case 'clickCatchTicket':
                 message = `Tebrikler, Ã§arktan <b>+${winningSegment.value} TÄ±kla-Yakala Bileti</b> kazandÄ±n!`;
                updates.clickCatchTickets = (currentUserData.clickCatchTickets || 0) + winningSegment.value;
                break;
            case 'wheelTicket':
                 message = `Tebrikler, Ã§arktan <b>+${winningSegment.value} Ã‡ark Bileti</b> kazandÄ±n!`;
                 updates.carkBileti = (currentUserData.carkBileti || 0) + winningSegment.value;
                break;
            case 'tempMultiplier':
                message = `Tebrikler, Ã§arktan <b>${winningSegment.value}X Ã‡arpan</b> kazandÄ±n!`;
                updates.activeMultiplier = winningSegment.value;
                updates.multiplierSource = 'store';
                updates.multiplierRemainingUses = winningSegment.duration;
                break;
            case 'surpriseBox':
                 const sessionRef = db.ref('surprise_box_session');
                 await sessionRef.set({ 
                     active: true, user: currentUser, boxId: 'Ã‡ark', 
                     multiplier: 1, cards: shuffleArray([...cardValues]), 
                     selection: null, result: null, 
                     timestamp: firebase.database.ServerValue.TIMESTAMP
                 });
                 const snap = await sessionRef.once('value');
                 const serverTimestamp = snap.val().timestamp;
                 await sessionRef.update({ expirationTimestamp: serverTimestamp + 60000 });
                 openCardSelectionModal(currentUser);
                 message = "Vay canÄ±na! Ã‡arktan SÃ¼rpriz Kutu Ã§Ä±ktÄ±! Åimdi bir kart seÃ§.";
                 shouldLogActivity = false;
                 break;
            // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA: Joker Kart iÃ§in dÃ¶nÃ¼ÅŸÃ¼m kontrolÃ¼ kaldÄ±rÄ±ldÄ± â˜…â˜…â˜…
            case 'wildcard':
                message = `HARÄ°KA! Ã‡arktan en nadir Ã¶dÃ¼l olan <b class="text-purple-400">+${winningSegment.value} JOKER KART</b> kazandÄ±n!`;
                updates.wildcards = (currentUserData.wildcards || 0) + winningSegment.value;
                break;
            case 'card_pack':
            case 'card_pack_normal':
            case 'card_pack_gumus':
            case 'card_pack_altin':
            case 'card_pack_efsanevi':
                const packsToOpen = winningSegment.value || 1;
                const packNames = {
                    'card_pack': `+${packsToOpen} Standart Kart Paketi`,
                    'card_pack_normal': `+${packsToOpen} Bronz Kart Paketi`,
                    'card_pack_gumus': `+${packsToOpen} GÃ¼mÃ¼ÅŸ Kart Paketi`,
                    'card_pack_altin': `+${packsToOpen} AltÄ±n Kart Paketi`,
                    'card_pack_efsanevi': `+${packsToOpen} Efsanevi Kart Paketi`
                };
                const prizeText = packNames[winningSegment.type] || `+${packsToOpen} Kart Paketi`;

                message = `Tebrikler! Ã‡arktan <b class="text-yellow-300">${prizeText}</b> kazandÄ±n!`;
                winningSegment.prizeName = prizeText;

                startCardPackOpening(packsToOpen, 'Åans Ã‡arkÄ±', 1, winningSegment.type);
                break;
            case 'pas':
                message = "Bu seferlik pas! Bir dahaki sefere daha ÅŸanslÄ± olabilirsin.";
                break;
        }

        db.ref('wheelHistory').push().set({
            username: currentUser, 
            prize: winningSegment.prizeName || winningSegment.label,
            type: winningSegment.type,
            value: winningSegment.value !== undefined ? winningSegment.value : null,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        const historyRef = db.ref('wheelHistory');
        historyRef.orderByChild('timestamp').once('value', (snapshot) => {
            const totalCount = snapshot.numChildren();
            const limit = 10;
            if (totalCount > limit) {
                let itemsToDeleteCount = totalCount - limit;
                snapshot.forEach((childSnapshot) => {
                    if (itemsToDeleteCount <= 0) return true; 
                    childSnapshot.ref.remove();
                    itemsToDeleteCount--;
                });
            }
        });

        const logDetails = {
            result: winningSegment.prizeName || winningSegment.label,
            type: winningSegment.type,
            value: winningSegment.value !== undefined ? winningSegment.value : null,
            duration: winningSegment.duration !== undefined ? winningSegment.duration : null
        };
        if (winningSegment.type === 'points') {
            logDetails.newBalance = updates.balance;
        }

        if (shouldLogActivity) {
            logActivity('spinWheel', currentUser, logDetails);
        }

        if(Object.keys(updates).length > 0) await userRef.update(updates);

        displayMessage(message);

        const normalizedRotation = finalRotation % 360;
        wheel.style.transition = 'none';
        wheel.style.transform = `rotate(${normalizedRotation}deg)`;

        await db.ref('gameLock').set(false);

    }, 5100);
}
      
function closeSoloGameSettingsModal() {
    soloGameSettingsModal.style.display = 'none';
}

function openLobbySettingsModal() {
    lobbySettingsModal.style.display = 'flex';
}

function closeLobbySettingsModal() {
    lobbySettingsModal.style.display = 'none';
}

// --- YENÄ° FONKSÄ°YONLAR BÄ°TÄ°Å ---
  let lobbyGameSettings = {};
  let lobbyListener = null;

  function updateClickCatchTimer() {
    clickCatchTimer--;
    document.getElementById('clickCatchTimer').textContent = clickCatchTimer;
    if (clickCatchTimer <= 0) {
        endSoloClickCatchGame();
    }
  }
    
async function resetClickCatchLeaderboard() {
    if (!isAdmin) {
        displayMessage("Bu iÅŸlemi yapmaya yetkiniz yok.");
        return;
    }

    const confirmed = await customConfirm(
        "TÃ¼m 'TÄ±kla-Yakala' sÄ±ralamasÄ±nÄ± ve tÃ¼m kullanÄ±cÄ±larÄ±n kiÅŸisel rekorlarÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!"
    );

    if (!confirmed) {
        return;
    }

    try {
        // 1. HaftalÄ±k skor tablosunu tamamen sil.
        await db.ref('clickCatchWeeklyScores').remove();

        // 2. TÃ¼m kullanÄ±cÄ±larÄ±n kiÅŸisel rekorlarÄ±nÄ± sÄ±fÄ±rla.
        const usersRef = db.ref('users');
        const usersSnap = await usersRef.once('value');
        const usersData = usersSnap.val();
        
        const updates = {};
        if (usersData) {
            for (const username in usersData) {
                if (usersData[username].hasOwnProperty('clickCatchHighestScore')) {
                    updates[`/users/${username}/clickCatchHighestScore`] = 0;
                }
            }
        }

        if (Object.keys(updates).length > 0) {
            await db.ref().update(updates);
        }

        // 3. Global lider deÄŸiÅŸkenini temizle
        clickCatchLeader = null;

        // --- YENÄ° EKLENEN ARAYÃœZ YENÄ°LEME KODLARI ---
        // Bu kodlar, veritabanÄ± gÃ¼ncellendikten sonra ekrandaki
        // liderlik tablolarÄ±nÄ± anÄ±nda yeniden Ã§izer.
        console.log("TÄ±kla-Yakala sÄ±fÄ±rlandÄ±, liderlik tablolarÄ± yenileniyor...");
        await loadLeaderboardRanking(); // Rozetli Liderler SÄ±ralamasÄ±nÄ± yeniler.
        await renderUserRankings();     // Kariyer PuanÄ± SÄ±ralamasÄ±nÄ± (ve rozetleri) yeniler.
        // --- YENÄ° KODLARIN SONU ---

        displayMessage("TÃ¼m TÄ±kla-Yakala sÄ±ralamasÄ± ve kiÅŸisel rekorlar baÅŸarÄ±yla sÄ±fÄ±rlandÄ±.");
        
    } catch (error) {
        console.error("TÄ±kla-Yakala sÄ±ralamasÄ± sÄ±fÄ±rlanÄ±rken hata oluÅŸtu:", error);
        displayMessage("SÄ±fÄ±rlama iÅŸlemi sÄ±rasÄ±nda bir hata meydana geldi.");
    }
}
      
  function createCatchItem(gameMode) {
    if (!clickCatchGameActive && gameMode === 'solo') return;
    if (gameMode === 'lobby' && (!lobbyGameSettings.state || lobbyGameSettings.state !== 'active')) return;

    const gameArea = document.getElementById('clickCatchGameArea');
    const item = document.createElement('div');
    item.className = 'catch-item';
    
    item.addEventListener('mousedown', (event) => {
        event.preventDefault();
    });
    
    if (gameMode === 'solo') {
        const itemsWithChance = [
            { type: 'points', value: soloGameSettings.bombValue, emoji: 'ğŸ’£', chance: soloGameSettings.bombChance },
            { type: 'time', value: soloGameSettings.timeValue, emoji: 'â°', chance: soloGameSettings.timeChance },
            { type: 'points', value: soloGameSettings.goldValue, emoji: 'ğŸ’°', chance: soloGameSettings.goldChance },
            { type: 'special', value: null, emoji: null, chance: specialItemForThisRound ? soloGameSettings.specialChance : 0 },
            { type: 'points', value: soloGameSettings.normalValue, emoji: 'ğŸ¥®', chance: soloGameSettings.normalChance || 50 }
        ];
        
        const totalChance = itemsWithChance.reduce((sum, item) => sum + item.chance, 0);
        const random = Math.random() * totalChance;
        let cumulativeChance = 0;
        let itemToSpawn;

        for (const i of itemsWithChance) {
            cumulativeChance += i.chance;
            if (random < cumulativeChance) {
                itemToSpawn = i;
                break;
            }
        }
        
        if (!itemToSpawn) {
            itemToSpawn = { type: 'points', value: soloGameSettings.normalValue, emoji: 'ğŸ¥®' };
        }

        if (itemToSpawn.type === 'special') {
            itemToSpawn = specialItemForThisRound;
            specialItemForThisRound = null; 
        }
        
        item.textContent = itemToSpawn.emoji;
        item.dataset.type = itemToSpawn.type;
        item.dataset.value = itemToSpawn.value;
        item.dataset.emoji = itemToSpawn.emoji;
        
        // ==========================================================
        // EKLENMESÄ° GEREKEN SATIR BURADA
        // Bu satÄ±r, Ã§arpanÄ±n "kullanÄ±m hakkÄ±" bilgisini Ã¶ÄŸeye ekler.
        if (itemToSpawn.type === 'tempMultiplier') {
            item.dataset.uses = itemToSpawn.uses;
        }
        // ==========================================================


    } else { // Bu kÄ±sÄ±m lobi oyunu iÃ§in
        const isBomb = Math.random() < 0.2; // %20 ihtimalle bomba Ã§Ä±kar

        if (isBomb) {
            item.textContent = 'ğŸ’£';
            item.style.backgroundColor = 'transparent';
            item.style.fontSize = '30px';
            item.dataset.type = 'bomb';
        } else {
            item.textContent = 'ğŸ¯';
            item.style.backgroundColor = 'transparent';
            item.style.fontSize = '30px';
            item.dataset.type = 'target';
        }
    }

    item.style.left = `${Math.random() * (gameArea.clientWidth - 30)}px`;
    item.style.top = `${Math.random() * (gameArea.clientHeight - 30)}px`;
    
    item.onclick = gameMode === 'solo' ? handleSoloItemClick : handleLobbyItemClick;
    
    const disappearTime = gameMode === 'solo' ? soloGameSettings.itemDisappearTime : lobbyGameSettings.itemInterval;
    
    gameArea.appendChild(item);
    
    setTimeout(() => {
        if (item.parentNode) {
            item.remove();
        }
    }, disappearTime);
}
      
  function showFloatingText(text, x, y) {
      const gameArea = document.getElementById('clickCatchGameArea');
      const textEl = document.createElement('div');
      textEl.textContent = text;
      textEl.className = 'floating-text';
      
      const rect = gameArea.getBoundingClientRect();
      const relativeX = x - rect.left;
      const relativeY = y - rect.top;

      textEl.style.left = `${relativeX}px`;
      textEl.style.top = `${relativeY}px`;
      
      gameArea.appendChild(textEl);
      
      textEl.addEventListener('animationend', () => {
          textEl.remove();
      });
  }
    
async function clearLastWinner() {
    if (!isAdmin) {
        displayMessage("Bu iÅŸlemi yapmaya yetkiniz yok.");
        return;
    }
    const confirmed = await customConfirm("Son kazanan bilgisini silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!");
    if (confirmed) {
        await db.ref('clickCatchLobbyLastGameSummary').remove();
        displayMessage("Son kazanan bilgisi baÅŸarÄ±yla silindi.");
        // Not: ArayÃ¼zÃ¼n gÃ¼ncellenmesini listenForLastGameSummary fonksiyonu otomatik olarak yapacak.
    }
}
  
  async function handleSoloItemClick(event) {
    if (!clickCatchGameActive) return;
    
    // DÃ¼zeltilen kÄ±sÄ±m: TÄ±klanan element ne olursa olsun, en yakÄ±n ebeveyn catch-item'Ä± bulur
    const item = event.target.closest('.catch-item');
    if (!item) return; // EÄŸer doÄŸru element bulunamazsa iÅŸlemi durdur

    const type = item.dataset.type;
    const value = parseInt(item.dataset.value);
    const uses = parseInt(item.dataset.uses);
    const emoji = item.dataset.emoji;
    
    let floatingText = '';

    // Bu switch-case yapÄ±sÄ±, hangi tÃ¼rde eÅŸyanÄ±n tÄ±klandÄ±ÄŸÄ±nÄ± belirler ve ilgili iÅŸlemi yapar.
    switch(type) {
        case 'points':
            clickCatchScore = Number(clickCatchScore) + value;
            document.getElementById('clickCatchScore').textContent = clickCatchScore;
            floatingText = (value > 0 ? '+' : '') + value + ' Skor';
            break;
        case 'time':
            clickCatchTimer += value;
            document.getElementById('clickCatchTimer').textContent = clickCatchTimer;
            floatingText = `+${value} Saniye`;
            break;
        case 'boxRight':
            collectedBoxRights += value;
            floatingText = `+${value} Kutu HakkÄ±`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'iflasShield':
            collectedIflasShields += value;
            floatingText = `+${value} Ä°flas KalkanÄ±`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'wheelTicket':
            collectedWheelTickets += value;
            floatingText = `+${value} Ã‡ark Bileti`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'tempMultiplier':
            collectedMultipliers.push({ value: value, uses: uses });
            floatingText = `${value}x Ã‡arpan (${uses} kullanÄ±m)`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'wildcard':
            collectedWildcards += value; // collectedWildcards deÄŸiÅŸkenini globalde tanÄ±mlamayÄ± unutma
            floatingText = `+${value} ğŸƒ Joker Kart YakalandÄ±!`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        // TÃ¼m kart paketi tÃ¼rleri iÃ§in tek bir case
        case 'card_pack':
        case 'card_pack_normal':
        case 'card_pack_gumus':
        case 'card_pack_altin':
        case 'card_pack_efsanevi':
            const packName = typeToName[type] || 'Kart Paketi';
            collectedCardPacks.push({ type: type, value: value });
            floatingText = `+${value} ${packName} YakalandÄ±!`;
            // â˜…â˜…â˜… DÃœZELTME BURADA: ArtÄ±k doÄŸru emojiyi kullanÄ±yor â˜…â˜…â˜…
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        // TÃ¼m iksir tÃ¼rleri iÃ§in tek bir case
        case 'revival_stone':
        case 'health_potion':
        case 'damage_potion':
        case 'defense_potion':
        case 'crit_potion':
        case 'crit_damage_potion':
        case 'dodge_potion':
        case 'pierce_potion':
             const potionName = typeToName[type] || 'Ä°ksir';
             collectedPotions.push({ type: type, value: value }); // collectedPotions globalde tanÄ±mlanmalÄ±
             floatingText = `+${value} ${potionName} YakalandÄ±!`;
             document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
             break;
    }
    
    showFloatingText(floatingText, event.clientX, event.clientY);
    item.remove();
}
  
async function deleteUserFromLeaderboard(event, username) {
      event.stopPropagation(); // OlayÄ±n yayÄ±lmasÄ±nÄ± engeller
      if (!isAdmin) return;
      const confirmed = await customConfirm(`<b>${username}</b> adlÄ± kullanÄ±cÄ±yÄ± YakalayÄ±cÄ±lar listesinden silmek istediÄŸinize emin misiniz?`);
      if (confirmed) {
          await db.ref(`clickCatchWeeklyScores/${username}`).remove();
          displayMessage(`${username} skor tablosundan silindi.`);
          loadClickCatchRankings(); // Tabloyu anÄ±nda yenile
      }
  }
  // YENÄ° YARDIMCI FONKSÄ°YON: TÄ±kla-Yakala liderinin kullanÄ±cÄ± adÄ±nÄ± anlÄ±k Ã§eker.
async function getClickCatchLeaderUsername() {
    const scoresSnap = await db.ref('clickCatchWeeklyScores').orderByValue().limitToLast(1).once('value');
    if (!scoresSnap.exists()) {
        return null; // Lider yoksa null dÃ¶ner
    }
    const scores = [];
    scoresSnap.forEach(child => {
        scores.push({ username: child.key });
    });
    return scores.length > 0 ? scores[0].username : null;
}
   function loadClickCatchRankings() {
      const rankingsList = document.getElementById('clickCatchRankings');
      const searchTerm = document.getElementById('searchClickCatchRanking').value.trim().toLowerCase();
      const ref = db.ref('clickCatchWeeklyScores').orderByValue();
      
      const callback = snap => {
          rankingsList.innerHTML = 'YÃ¼kleniyor...';
          
          if (!snap.exists()) {
              rankingsList.innerHTML = '<p class="text-center text-gray-400">Bu hafta henÃ¼z skor kaydedilmedi.</p>';
              clickCatchLeader = null;
              return;
          }

          let html = '';
          const scores = [];
          snap.forEach(child => {
              scores.push({ username: child.key, score: child.val() });
          });
          scores.reverse();

          if(scores.length > 0) { clickCatchLeader = scores[0].username; } 
          else { clickCatchLeader = null; }

          let filteredScores = scores;
          if (searchTerm) {
              filteredScores = scores.filter(entry => entry.username.toLowerCase().includes(searchTerm));
          }

          filteredScores.forEach((entry, index) => {
              const leaderBadge = (index === 0 && !searchTerm) ? '<span title="TÄ±kla ve Yakala Lideri">ğŸ¯</span>' : '';
              const deleteButton = isAdmin 
? `<button onclick="deleteUserFromLeaderboard(event, '${entry.username}')" class="ml-3 text-gray-500 hover:text-red-500 transition-colors" title="Skor Tablosundan Sil">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
     </button>` : '';

              const userData = allUsersCache.find(user => user.username === entry.username);
              const avatarUrl = userData && userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;

              html += `
                <div onclick="openPublicUserDetailModal('${entry.username}')" class="flex justify-between items-center p-2 mb-2 bg-gray-800 rounded-md cursor-pointer hover:bg-gray-700 transition-colors">
                    <div class="flex items-center">
                        <span class="font-bold mr-2">${index + 1}.</span>
                        <img src="${avatarUrl}" class="w-10 h-10 rounded-md mr-3 object-contain">
                        <span>${leaderBadge} ${entry.username}</span>
                        ${deleteButton}
                    </div>
                    <span class="font-bold text-yellow-300">${entry.score} Skor</span>
                </div>`;
          });
          rankingsList.innerHTML = html || '<p class="text-center text-gray-400">Aramayla eÅŸleÅŸen kullanÄ±cÄ± bulunamadÄ±.</p>';
      };
      
      if (activeListeners.clickCatchRankings) {
          activeListeners.clickCatchRankings.ref.off('value', activeListeners.clickCatchRankings.callback);
      }
      activeListeners.clickCatchRankings = { ref, event: 'value', callback };
      ref.on('value', callback);
  }

    // === BU YENÄ° FONKSÄ°YONLARI DOSYANIN SONUNA EKLE ===

// Lobi bildirim penceresini gÃ¶sterir
function showLobbyNotification(lobbyData) {
    const infoDiv = document.getElementById('lobbyNotificationInfo');
    const useTickets = lobbyData.entryTickets > 0;
    const entryRequirement = useTickets ? `${lobbyData.entryTickets} Bilet` : `${lobbyData.entryFee} Puan`;

    infoDiv.innerHTML = `
        <p>GiriÅŸ Ãœcreti: <b class="text-white">${entryRequirement}</b></p>
        <p>Hedef: <b class="text-white">${lobbyData.target} Yakalama</b></p>
        <p>BÃ¼yÃ¼k Ã–dÃ¼l: <b class="text-green-400">${lobbyData.prize} Puan</b></p>
        <p class="mt-2 text-sm text-gray-400">Hemen TÄ±kla-Yakala sekmesine git ve lobiye katÄ±l!</p>
    `;
    document.getElementById('lobbyNotificationModal').style.display = 'flex';
}

// Lobi bildirim penceresini kapatÄ±r
function closeLobbyNotificationModal() {
    document.getElementById('lobbyNotificationModal').style.display = 'none';
}

// "Lobiye Git" butonuna basÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
function goToLobbySection() {
    closeLobbyNotificationModal();
    showSection('clickCatch');
}

  // ESKÄ° listenForLobbyChanges FONKSÄ°YONUNU SÄ°LÄ°P, BUNU YAPIÅTIR

function listenForLobbyChanges() {
    const lobbyRef = db.ref('clickCatchLobby');

    if (activeListeners.lobby) {
        activeListeners.lobby.ref.off(activeListeners.lobby.event, activeListeners.lobby.callback);
    }
    
    const startScreen = document.getElementById('clickCatchStartScreen');
    const lobbyStatusContainer = document.getElementById('lobbyStatusContainer');
    const lobbyGameOverScreen = document.getElementById('lobbyGameOverScreen');

    const callback = snap => {
        const lobbyData = snap.val();
        const joinLobbyBtn = document.getElementById('joinLobbyBtn');
        const startSoloGameBtn = document.getElementById('startSoloGameBtn');
        const lobbyStartBtn = document.getElementById('lobbyStartBtn');
        
        if (countdownInterval) clearInterval(countdownInterval);

        startSoloGameBtn.disabled = false;

        if (!lobbyData || !lobbyData.state) {
            lobbyGameSettings = {};
            hasShownLobbyNotification = false; 
            closeLobbyNotificationModal(); 
            lobbyStatusContainer.classList.add('hidden');
            lobbyGameOverScreen.classList.add('hidden');
            startScreen.style.display = 'flex';
            
            // Oyun bitince veya iptal olunca arayÃ¼zdeki zamanlayÄ±cÄ±larÄ± temizle
            if (clickCatchItemInterval) {
                clearInterval(clickCatchItemInterval);
                clickCatchItemInterval = null;
            }
            
            joinLobbyBtn.disabled = true;
            joinLobbyBtn.textContent = 'Lobiye KatÄ±l';
            joinLobbyBtn.onclick = () => joinLobby();
            joinLobbyBtn.classList.remove('bg-orange-600', 'hover:bg-orange-500');
            joinLobbyBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');

            if (isAdmin && lobbyStartBtn) lobbyStartBtn.disabled = true;
            document.getElementById('displayTarget').classList.add('hidden');
            return;
        }

        lobbyGameSettings = lobbyData;
        lobbyStatusContainer.classList.remove('hidden');
        lobbyGameOverScreen.classList.add('hidden');

        const useTickets = lobbyData.entryTickets > 0;
        const entryRequirement = useTickets ? `${lobbyData.entryTickets} Bilet` : `${lobbyData.entryFee} Puan`;
        
        document.getElementById('lobbyStatusInfo').textContent = `KatÄ±lÄ±m Ã¼creti: ${entryRequirement} | Hedef: ${lobbyData.target} Yakalama | Ã–dÃ¼l: ${lobbyData.prize} Puan`;
        
        const players = lobbyData.players || {};
        const hasPlayers = Object.keys(players).length > 0;
        const isCurrentUserInLobby = lobbyData.state !== 'finished' && players[currentUser] !== undefined;

        const playerListEl = document.getElementById('lobbyPlayerList');
        playerListEl.innerHTML = ``;
        if (hasPlayers) {
            const sortedPlayers = Object.entries(players).sort(([, a], [, b]) => b.score - a.score);
            playerListEl.innerHTML = `KatÄ±lÄ±mcÄ±lar: <br>`;
            sortedPlayers.forEach(([username, playerData]) => {
                playerListEl.innerHTML += `<b>${username}:</b> ${playerData.score} / ${lobbyData.target}<br>`;
            });
        } else {
            playerListEl.textContent = `HenÃ¼z katÄ±lan yok.`;
        }

        if (isAdmin) {
            startSoloGameBtn.disabled = true;
            joinLobbyBtn.disabled = true;
            if(lobbyStartBtn) lobbyStartBtn.disabled = !(lobbyData.state === 'waiting' && hasPlayers);
        } else {
            if (isCurrentUserInLobby) {
                joinLobbyBtn.disabled = lobbyData.state === 'active';
                joinLobbyBtn.textContent = 'Lobiden AyrÄ±l';
                joinLobbyBtn.onclick = () => leaveLobby();
                joinLobbyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                joinLobbyBtn.classList.add('bg-orange-600', 'hover:bg-orange-500');
            } else {
                joinLobbyBtn.disabled = lobbyData.state !== 'waiting';
                joinLobbyBtn.textContent = 'Lobiye KatÄ±l';
                joinLobbyBtn.onclick = () => joinLobby();
                joinLobbyBtn.classList.remove('bg-orange-600', 'hover:bg-orange-500');
                joinLobbyBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            }
        }
        
        if (lobbyData.state === 'waiting') {
            document.getElementById('lobbyStatusTitle').textContent = "Lobi KatÄ±lÄ±ma AÃ§Ä±k!";
            startScreen.style.display = 'flex';
            document.getElementById('displayTarget').classList.add('hidden');
            
            if (!isAdmin && !isCurrentUserInLobby && !hasShownLobbyNotification) {
                showLobbyNotification(lobbyData);
                hasShownLobbyNotification = true;
            }
            
        } else if (lobbyData.state === 'active') {
            document.getElementById('lobbyStatusTitle').textContent = "Oyun BaÅŸladÄ±! Hedefe Ä°lk UlaÅŸan KazanÄ±r!";
            startScreen.style.display = 'none';
            closeLobbyNotificationModal();
            document.getElementById('displayScore').classList.add('hidden');
            document.getElementById('displaySpecials').classList.add('hidden');
            document.getElementById('displayTimer').classList.add('hidden');
            document.getElementById('displayTarget').classList.remove('hidden');
            
            const currentUserScore = isCurrentUserInLobby ? (players[currentUser] ? players[currentUser].score : 0) : 0;
            document.getElementById('clickCatchTarget').textContent = `${currentUserScore} / ${lobbyData.target}`;

            if (isCurrentUserInLobby && currentActiveSection !== 'clickCatch') {
                showSection('clickCatch');
            }
            
            // ================== PERFORMANS DÃœZELTMESÄ° BURADA ==================
            // Bu blok artÄ±k sadece lobiye katÄ±lan oyuncularda Ã§alÄ±ÅŸacak.
            if (isCurrentUserInLobby) {
                if (!clickCatchItemInterval) {
                   showGameCountdown(() => {
                       // Hedef oluÅŸturma dÃ¶ngÃ¼sÃ¼ sadece katÄ±lÄ±mcÄ± iÃ§in baÅŸlar.
                       clickCatchItemInterval = setInterval(() => createCatchItem('lobby'), lobbyData.itemInterval);
                   });
                }
            }
            // =================================================================

        } else if (lobbyData.state === 'finished') {
            lobbyStatusContainer.classList.add('hidden');
            lobbyGameOverScreen.classList.remove('hidden');
            document.getElementById('lobbyGameOverInfo').innerHTML = `Kazanan: <b class="text-2xl text-yellow-300">${lobbyData.winner}</b>! Ã–dÃ¼l: ${lobbyData.prize} Puan!`;
            
            startScreen.style.display = 'none';
            document.getElementById('displayTarget').classList.add('hidden');
            if (clickCatchItemInterval) {
                clearInterval(clickCatchItemInterval);
                clickCatchItemInterval = null;
            }
        }
    };

    activeListeners.lobby = { ref: lobbyRef, event: 'value', callback };
    lobbyRef.on('value', callback);
}

    // === BU YENÄ° FONKSÄ°YONLARI DOSYANIN SONUNA EKLE ===

async function changeAllWheelTickets(add) {
    const amount = parseInt(document.getElementById("globalWheelTicket").value);
    if (isNaN(amount) || amount <= 0) {
        displayMessage("GeÃ§erli miktar girin.");
        return;
    }
    const confirmed = await customConfirm(`TÃ¼m kullanÄ±cÄ±lara ${amount} adet Ã‡ark Bileti ${add ? 'eklemek' : 'silmek'} istediÄŸinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let currentTickets = child.val().carkBileti || 0;
                    currentTickets = add ? currentTickets + amount : Math.max(0, currentTickets - amount);
                    updates['users/' + child.key + '/carkBileti'] = currentTickets;
                }
            });
            db.ref().update(updates).then(() => displayMessage("TÃ¼m kullanÄ±cÄ±lara Ã‡ark Bileti iÅŸlemi baÅŸarÄ±yla uygulandÄ±."));
        });
    }
}

let globalNotificationTimeout;

/**
 * Ekranda genel bir yÃ¶netici bildirimi gÃ¶sterir.
 * @param {string} message - GÃ¶sterilecek mesaj.
 */
function displayGlobalNotification(message) {
    const notificationEl = document.getElementById('globalAdminNotification');
    if (!notificationEl) return;

    // Ã–nceki bildirimin zaman aÅŸÄ±mÄ±nÄ± temizle
    if (globalNotificationTimeout) {
        clearTimeout(globalNotificationTimeout);
    }

    notificationEl.textContent = message;
    // Bildirimi gÃ¶rÃ¼nÃ¼r yap ve animasyonu tetikle
    notificationEl.classList.remove('opacity-0', '-translate-y-20');

    // 5 saniye sonra bildirimi gizle
    globalNotificationTimeout = setTimeout(() => {
        notificationEl.classList.add('opacity-0', '-translate-y-20');
    }, 5000);
}
    
// YUKARIDAKÄ° ESKÄ° KODU SÄ°LÄ°P, YERÄ°NE BU YENÄ° KODU YAPIÅTIR
async function listenForGlobalNotifications() {
    // Adminler iÃ§in bu fonksiyon Ã§alÄ±ÅŸmasÄ±n
    if (isAdmin) return;

    const userRef = db.ref(`users/${currentUser}`);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();
    
    // KullanÄ±cÄ±nÄ±n en son gÃ¶rdÃ¼ÄŸÃ¼ bildirimin zamanÄ±nÄ± al, yoksa 0 kullan.
    const lastSeenTimestamp = userData.lastSeenGlobalNotifTimestamp || 0;
    
    const notificationsRef = db.ref('globalNotifications');
    const listenerRef = notificationsRef.orderByChild('timestamp').startAt(lastSeenTimestamp + 1);

    const callback = (snap) => {
        const notification = snap.val();
        if (notification && notification.message) {
            // Bildirimi gÃ¶ster
            displayGlobalNotification(notification.message);
            
            // KullanÄ±cÄ±nÄ±n "son gÃ¶rme" zamanÄ±nÄ± bu yeni bildirimin zamanÄ±yla gÃ¼ncelle
            userRef.update({
                lastSeenGlobalNotifTimestamp: notification.timestamp
            });
        }
    };
    
    // Listener'Ä± tekrar tekrar eklememek iÃ§in kontrol
    if (activeListeners.globalNotifications) {
        activeListeners.globalNotifications.ref.off('child_added', activeListeners.globalNotifications.callback);
    }
    
    activeListeners.globalNotifications = { ref: listenerRef, event: 'child_added', callback };
    listenerRef.on('child_added', callback);
}
  
  async function startLobbyGame() {
    if (!isAdmin) return;
    
    // Ã–nceki lobi verilerini temizle
    await db.ref('clickCatchLobby').remove();
    
    // Yeni lobi verilerini kur
    const lobbyData = {
        entryFee: parseInt(document.getElementById('lobbyEntryFee').value) || 100,
        entryTickets: parseInt(document.getElementById('lobbyEntryTickets').value) || 0,
        target: parseInt(document.getElementById('lobbyTarget').value) || 10,
        prize: parseInt(document.getElementById('lobbyPrize').value) || 1000,
        itemInterval: parseInt(document.getElementById('lobbyItemInterval').value) || 800,
        state: 'waiting',
        players: {} // Yeni lobi her zaman boÅŸ oyuncu listesiyle baÅŸlar
    };
    await db.ref('clickCatchLobby').set(lobbyData);
    displayMessage("Lobi kuruldu. Oyuncular katÄ±ldÄ±ktan sonra 'Oyunu BaÅŸlat' butonuna bas.");
}

  async function endLobbyGame(isCancel = false) {
    if (!isAdmin) return;

    const lobbyRef = db.ref('clickCatchLobby');
    const lobbySnap = await lobbyRef.once('value');
    const lobbyData = lobbySnap.val();

    // Lobi zaten yoksa veya boÅŸsa iÅŸlemi bitir.
    if (!lobbyData) {
        if (isCancel) {
            displayMessage("Ä°ptal edilecek aktif bir lobi bulunmuyor.");
        }
        await lobbyRef.remove();
        return;
    }

    const currentState = lobbyData.state;
    const useTickets = lobbyData.entryTickets > 0;
    const updates = {};
    let messageForAdmin = "";

    // Senaryo 1: Lobi "beklemede" veya "aktif" durumdayken admin tarafÄ±ndan iptal ediliyor.
    // Bu durumda Ã¼cretler iade edilir ve bildirim gÃ¶nderilir.
    if (isCancel && (currentState === 'waiting' || currentState === 'active')) {
        const confirmed = await customConfirm("Lobi iptal edilecek ve tÃ¼m katÄ±lÄ±mcÄ±larÄ±n Ã¼cretleri iade edilecek. Emin misin?");
        if (!confirmed) return;

        // Lobide oyuncu varsa iade iÅŸlemlerini yap
        if (lobbyData.players) {
            for (const player in lobbyData.players) {
                const userRef = db.ref(`users/${player}`);
                const userSnap = await userRef.once('value');
                const userData = userSnap.val();

                if (userData) {
                    // Ãœcret tÃ¼rÃ¼ne gÃ¶re iadeyi hazÄ±rla
                    if (useTickets) {
                        const currentTickets = userData.clickCatchTickets || 0;
                        updates[`users/${player}/clickCatchTickets`] = currentTickets + (lobbyData.entryTickets || 0);
                    } else {
                        const currentBalance = userData.balance || 0;
                        updates[`users/${player}/balance`] = currentBalance + (lobbyData.entryFee || 0);
                    }
                    
                    // --- YENÄ° EKLENEN BÄ°LDÄ°RÄ°M KODU ---
                    const messageForUser = "Kurulu lobi admin tarafÄ±ndan iptal edildi. KatÄ±lÄ±m Ã¼cretiniz iade edildi.";
                    const notifKey = db.ref('users/' + player + '/notifications').push().key;
                    updates[`users/${player}/notifications/${notifKey}`] = { message: messageForUser, timestamp: firebase.database.ServerValue.TIMESTAMP };
                    // --- BÄ°LDÄ°RÄ°M KODU SONU ---
                }
            }
        }
        messageForAdmin = "Lobi iptal edildi ve tÃ¼m katÄ±lÄ±mcÄ±larÄ±n Ã¼cretleri iade edildi.";
    } 
    // Senaryo 2: Oyun zaten bitmiÅŸ veya baÅŸka bir durumda iptal ediliyor.
    // Bu durumda Ã¼cret iadesi yapÄ±lmaz.
    else {
        let confirmationMessage = "Lobi sonlandÄ±rÄ±lacak. Bu iÅŸlem geri alÄ±namaz.";
        if (isCancel) {
             confirmationMessage = "Oyun zaten tamamlanmÄ±ÅŸ. Lobiyi sonlandÄ±rmak, Ã¼cretlerin iade edilmemesine neden olur. Emin misin?";
        }
        const confirmed = await customConfirm(confirmationMessage);
        if (!confirmed) return;

        const winner = lobbyData.winner;
        messageForAdmin = winner 
            ? `Oyun sonlandÄ±rÄ±ldÄ±. Kazanan: ${winner}. Ãœcretler iade edilmedi.`
            : "Lobi sonlandÄ±rÄ±ldÄ±. Kazanan belirlenmediÄŸi iÃ§in Ã¼cretler iade edilmedi.";
    }
    
    // HazÄ±rlanan tÃ¼m gÃ¼ncellemeleri (iade ve bildirimler) tek seferde veritabanÄ±na yaz
    if (Object.keys(updates).length > 0) {
        await db.ref().update(updates);
    }
    
    // Son olarak lobiyi sil ve admine bilgi ver
    await lobbyRef.remove();
    displayMessage(messageForAdmin);
}
  // Yeni eklenecek fonksiyon: Ekranda geÃ§ici bildirim gÃ¶sterir
function displayNotification(message, color = 'bg-yellow-500') {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 p-4 rounded-lg shadow-lg text-white font-bold text-center ${color} animate-fade-in-out`;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 3000); // 3 saniye sonra bildirim kaybolur
}
  // BU FONKSÄ°YONU BUL VE AÅAÄIDAKÄ°YLE DEÄÄ°ÅTÄ°R
async function triggerLobbyGameStart() {
    if (!isAdmin) return;
    if (lobbyGameSettings.state !== 'waiting') {
        displayMessage("Oyun sadece 'beklemede' durumundayken baÅŸlatÄ±labilir.");
        return;
    }
    if (!lobbyGameSettings.players || Object.keys(lobbyGameSettings.players).length === 0) {
        displayMessage("Oyunu baÅŸlatmak iÃ§in en az bir katÄ±lÄ±mcÄ± olmalÄ±dÄ±r.");
        return;
    }
    // OYUNUN BAÅLAMA ZAMANINI KAYDETMEK Ä°Ã‡Ä°N startTimestamp EKLENDÄ°
    await db.ref('clickCatchLobby').update({ 
        state: 'active',
        startTimestamp: firebase.database.ServerValue.TIMESTAMP 
    });
    displayMessage("Oyun baÅŸlatÄ±ldÄ±!");
}
  async function joinLobby() {
      if (isAdmin) return;
      const userRef = db.ref('users/' + currentUser);
      const userSnap = await userRef.once('value');
      const userData = userSnap.val();
      const useTickets = lobbyGameSettings.entryTickets > 0;
      let confirmed = false;

      if (useTickets) {
          if ((!userData.clickCatchTickets || userData.clickCatchTickets < lobbyGameSettings.entryTickets)) {
              displayMessage(`Lobiye katÄ±lmak iÃ§in ${lobbyGameSettings.entryTickets} adet TÄ±kla-Yakala Biletin yok.`);
              return;
          }
          confirmed = await customConfirm(`Lobiye katÄ±lmak iÃ§in ${lobbyGameSettings.entryTickets} adet bilet harcanacak. OnaylÄ±yor musun?`);
          if (confirmed) {
              await userRef.update({ clickCatchTickets: (userData.clickCatchTickets || 0) - lobbyGameSettings.entryTickets });
          }
      } else {
          if ((userData.balance || 0) < lobbyGameSettings.entryFee) {
              displayMessage("Lobiye katÄ±lmak iÃ§in yeterli puanÄ±n yok.");
              return;
          }
          confirmed = await customConfirm(`Lobiye katÄ±lmak iÃ§in ${lobbyGameSettings.entryFee} puan harcanacak. OnaylÄ±yor musun?`);
          if (confirmed) {
              await userRef.update({ balance: (userData.balance || 0) - lobbyGameSettings.entryFee });
          }
      }
      
      if (confirmed) {
          await db.ref(`clickCatchLobby/players/${currentUser}`).set({ score: 0 });
          displayMessage("Lobiye baÅŸarÄ±yla katÄ±ldÄ±n! Adminin oyunu baÅŸlatmasÄ± bekleniyor.");
      }
  }
  async function leaveLobby() {
    if (isAdmin || !lobbyGameSettings || lobbyGameSettings.state !== 'waiting') return;

    const confirmed = await customConfirm("Lobiden ayrÄ±lmak istediÄŸine emin misin? KatÄ±lÄ±m Ã¼cretin iade edilecek.");
    if (!confirmed) return;

    const userRef = db.ref('users/' + currentUser);
    const useTickets = lobbyGameSettings.entryTickets > 0;

    // Ãœcreti iade et
    await userRef.transaction(user => {
        if (user) {
            if (useTickets) {
                user.clickCatchTickets = (user.clickCatchTickets || 0) + lobbyGameSettings.entryTickets;
            } else {
                user.balance = (user.balance || 0) + lobbyGameSettings.entryFee;
            }
        }
        return user;
    });

    // Oyuncuyu lobiden sil
    await db.ref(`clickCatchLobby/players/${currentUser}`).remove();

    displayMessage("Lobiden ayrÄ±ldÄ±n ve katÄ±lÄ±m Ã¼cretin iade edildi.");
  }

  async function handleLobbyItemClick(event) {
    if (lobbyGameSettings.state !== 'active') return;
    
    // DÃ¼zeltilen kÄ±sÄ±m: TÄ±klanan element ne olursa olsun, en yakÄ±n ebeveyn catch-item'Ä± bulur
    const item = event.target.closest('.catch-item');
    if (!item) return; // EÄŸer doÄŸru element bulunamazsa iÅŸlemi durdur

    const itemType = item.dataset.type;

    const lobbyPlayerRef = db.ref(`clickCatchLobby/players/${currentUser}`);
    
    const playerSnap = await lobbyPlayerRef.once('value');
    const playerData = playerSnap.val();
    if (!playerData) return;

    let newScore = playerData.score;

    if (itemType === 'bomb') {
        newScore = Math.max(0, newScore - 1); // Skoru 1 azalt, ama 0'Ä±n altÄ±na dÃ¼ÅŸmesin
        showFloatingText('-1', event.clientX, event.clientY);
    } else {
        newScore++;
        showFloatingText('+1', event.clientX, event.clientY);
    }

    await lobbyPlayerRef.update({ score: newScore });

    document.getElementById('clickCatchTarget').textContent = `${newScore} / ${lobbyGameSettings.target}`;

    if(newScore >= lobbyGameSettings.target) {
        db.ref('clickCatchLobby/state').once('value').then(snap => {
            if (snap.val() === 'active') {
                setWinner(currentUser);
            }
        });
    }

    item.remove();
}

// **** YENÄ° EKLENECEK FONKSÄ°YONLAR BAÅLANGICI ****

/**
 * Oyun baÅŸlamadan Ã¶nce ekranda 3'ten geriye sayÄ±m gÃ¶sterir.
 * @param {function} onComplete - Geri sayÄ±m bittiÄŸinde Ã§alÄ±ÅŸtÄ±rÄ±lacak olan fonksiyon.
 */
function showGameCountdown(onComplete) {
    const overlay = document.getElementById('gameCountdownOverlay');
    const countdownText = document.getElementById('countdownText');
    const startScreen = document.getElementById('clickCatchStartScreen');

    startScreen.style.display = 'none'; // Oyun modunu seÃ§me ekranÄ±nÄ± gizle
    overlay.style.display = 'flex';    // Geri sayÄ±m ekranÄ±nÄ± gÃ¶ster

    let count = 3;
    countdownText.textContent = count;

    const countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
            countdownText.textContent = count;
        } else if (count === 0) {
            countdownText.textContent = 'BAÅLA!';
        } else {
            clearInterval(countdownInterval);
            overlay.style.display = 'none'; // Geri sayÄ±m bitince ekranÄ± gizle
            if (onComplete) {
                onComplete(); // AsÄ±l oyunu baÅŸlatan fonksiyonu Ã§aÄŸÄ±r
            }
        }
    }, 1000);
}

/**
 * Geri sayÄ±m bittikten sonra Tekli Oyun'u gerÃ§ekten baÅŸlatan yardÄ±mcÄ± fonksiyon.
 */
function _actuallyStartSoloGame() {
    // Bu fonksiyonun iÃ§eriÄŸi, startSoloClickCatchGame fonksiyonundan taÅŸÄ±ndÄ±.
    clickCatchTimerInterval = setInterval(updateClickCatchTimer, 1000);
    clickCatchItemInterval = setInterval(() => createCatchItem('solo'), soloGameSettings.itemInterval);
}

let weeklyCountdownInterval = null

  // YENÄ° KODU YAPIÅTIR
async function openSoloGameSettingsModal() {
    // Mevcut tekli oyun ayarlarÄ±nÄ± yÃ¼kle
    await loadSoloGameSettings();

    // HaftalÄ±k otomatik sÄ±fÄ±rlama ayarlarÄ±nÄ± yÃ¼kle
    const settingsSnap = await db.ref('gameConfig/weeklyClickCatchReset').once('value');
    if (settingsSnap.exists()) {
        const settings = settingsSnap.val();
        if (settings.endDate) {
            const date = new Date(settings.endDate);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            document.getElementById('weeklyResetEndDateInput').value = date.toISOString().slice(0, 16);
        }
        if (settings.prize) {
            document.getElementById('weeklyPrizeType').value = settings.prize.type || 'points';
            // Ã‡arpan ise her iki alanÄ± da doldur, deÄŸilse sadece miktar alanÄ±nÄ± doldur
            if (settings.prize.type === 'tempMultiplier') {
                document.getElementById('weeklyPrizeAmount').value = settings.prize.amount || '';
                document.getElementById('weeklyPrizeMultiplierUses').value = settings.prize.uses || '';
            } else {
                document.getElementById('weeklyPrizeAmount').value = settings.prize.amount || 1000;
                document.getElementById('weeklyPrizeMultiplierUses').value = '';
            }
        }
    } else {
        // EÄŸer ayar yoksa alanlarÄ± temizle/varsayÄ±lana ayarla
        document.getElementById('weeklyResetEndDateInput').value = '';
        document.getElementById('weeklyPrizeType').value = 'points';
        document.getElementById('weeklyPrizeAmount').value = 1000;
        document.getElementById('weeklyPrizeMultiplierUses').value = '';
    }
    
    // ArayÃ¼zÃ¼ doÄŸru duruma getir
    handleWeeklyPrizeTypeChange();
    soloGameSettingsModal.style.display = 'flex';
}
  
  function closeSoloGameSettingsModal() {
      soloGameSettingsModal.style.display = 'none';
  }
  
  function closeSoloGameSettingsModal() {
    soloGameSettingsModal.style.display = 'none';
}

  function closeLobbySettingsModal() {
      lobbySettingsModal.style.display = 'none';
  }
  // YENÄ° EKLENECEK FONKSÄ°YON
// "Oyun Bitti" ekranÄ±nÄ± sadece tÄ±klayan kullanÄ±cÄ±nÄ±n ekranÄ±nda kapatÄ±r.
function closeLobbyGameOverScreen() {
    const gameOverScreen = document.getElementById('lobbyGameOverScreen');
    const startScreen = document.getElementById('clickCatchStartScreen');

    if (gameOverScreen) {
        gameOverScreen.classList.add('hidden');
    }
    if (startScreen) {
        startScreen.style.display = 'flex';
    }

    // --- YENÄ° EKLENEN SATIR BAÅLANGICI ---
    // Butona basÄ±ldÄ±ÄŸÄ± anda, bu oyuncu iÃ§in lobi durumunu yerel olarak sÄ±fÄ±rlÄ±yoruz.
    // Bu, kullanÄ±cÄ±nÄ±n butona bastÄ±ÄŸÄ± anda yeni bir oyuna baÅŸlayabilmesini saÄŸlar.
    // ArtÄ±k 5 saniye beklemesine gerek kalmaz.
    lobbyGameSettings = {};
    // --- YENÄ° EKLENEN SATIR SONU ---
}

async function saveSoloGameSettings() {
    if (!isAdmin) return;

    const settings = {
        duration: parseInt(document.getElementById('soloGameDuration').value) || 30,
        itemDisappearTime: parseInt(document.getElementById('soloItemDisappearTime').value) || 1200,
        itemInterval: parseInt(document.getElementById('soloItemInterval').value) || 600,
        bombChance: parseInt(document.getElementById('soloBombChance').value) || 40,
        timeChance: parseInt(document.getElementById('soloTimeChance').value) || 8,
        goldChance: parseInt(document.getElementById('soloGoldChance').value) || 6,
        specialChance: parseInt(document.getElementById('soloSpecialChance').value) || 4,
        normalChance: parseInt(document.getElementById('soloNormalChance').value) || 50,
        timeValue: parseInt(document.getElementById('soloTimeValue').value) || 3,
        bombValue: parseInt(document.getElementById('soloBombValue').value) || -75,
        goldValue: parseInt(document.getElementById('soloGoldValue').value) || 100,
        normalValue: parseInt(document.getElementById('soloNormalValue').value) || 50,
        specialItemType: document.getElementById('soloSpecialItemType').value || 'boxRight',
        specialValue: parseInt(document.getElementById('soloSpecialValue').value) || 1,
        specialMultiplierUses: parseInt(document.getElementById('soloSpecialMultiplierUses').value) || 1
    };

    const totalChance = settings.bombChance + settings.timeChance + settings.goldChance + settings.specialChance + settings.normalChance;

    await db.ref('gameSettings/clickCatchSolo').set(settings);

    if (totalChance !== 100) {
        displayMessage("UyarÄ±: Åans yÃ¼zdelerinin toplamÄ± 100 deÄŸil! LÃ¼tfen deÄŸerleri kontrol et. Ayarlar yine de kaydedildi.");
    } else {
        displayMessage("Tekli oyun ayarlarÄ± baÅŸarÄ±yla kaydedildi.");
    }
}

async function loadSoloGameSettings() {
    const settingsSnap = await db.ref('gameSettings/clickCatchSolo').once('value');
    if (settingsSnap.exists()) {
        soloGameSettings = settingsSnap.val();
    }
    document.getElementById('soloGameDuration').value = soloGameSettings.duration;
    document.getElementById('soloItemDisappearTime').value = soloGameSettings.itemDisappearTime;
    document.getElementById('soloItemInterval').value = soloGameSettings.itemInterval;
    document.getElementById('soloBombChance').value = soloGameSettings.bombChance;
    document.getElementById('soloTimeChance').value = soloGameSettings.timeChance;
    document.getElementById('soloGoldChance').value = soloGameSettings.goldChance;
    document.getElementById('soloSpecialChance').value = soloGameSettings.specialChance;
    document.getElementById('soloNormalChance').value = soloGameSettings.normalChance || 50;
    document.getElementById('soloTimeValue').value = soloGameSettings.timeValue || 3;
    document.getElementById('soloBombValue').value = soloGameSettings.bombValue || -75;
    document.getElementById('soloGoldValue').value = soloGameSettings.goldValue || 100;
    document.getElementById('soloNormalValue').value = soloGameSettings.normalValue || 50;
    document.getElementById('soloSpecialItemType').value = soloGameSettings.specialItemType || 'boxRight';
    document.getElementById('soloSpecialValue').value = soloGameSettings.specialValue || 1;
    document.getElementById('soloSpecialMultiplierUses').value = soloGameSettings.specialMultiplierUses || 1;
    
    // Ayarlar yÃ¼klendikten sonra input'larÄ±n gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ kontrol eden fonksiyonu Ã§aÄŸÄ±rÄ±r.
    handleSoloSpecialTypeChange();
}

// startSoloClickCatchGame fonksiyonunu bununla deÄŸiÅŸtir
async function startSoloClickCatchGame() {
    // YENÄ° KONTROL: HaftalÄ±k sÄ±fÄ±rlama ayarlarÄ± admin tarafÄ±ndan yapÄ±lmamÄ±ÅŸsa oyunu baÅŸlatma.
    const settingsSnap = await db.ref('gameConfig/weeklyClickCatchReset').once('value');
    if (!settingsSnap.exists() && !isAdmin) {
        displayMessage("YÃ¶netici yeni haftanÄ±n Ã¶dÃ¼llerini hazÄ±rlÄ±yor. LÃ¼tfen kÄ±sa bir sÃ¼re sonra tekrar deneyin.");
        return;
    }
    
    if (lobbyGameSettings && lobbyGameSettings.state && (lobbyGameSettings.state === 'waiting' || lobbyGameSettings.state === 'active')) {
        displayMessage("Åu anda aktif bir lobi var. Lobi sona erdiÄŸinde tekli oyun oynayabilirsiniz.");
        return;
    }
    if (clickCatchGameActive) return;
    if (isAdmin) {
        displayMessage("Adminler bu oyunu oynayamaz.");
        return;
    }
    await loadSoloGameSettings();
    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();
    
    const ticketCount = userData.clickCatchTickets || 0;
    if (ticketCount < 1) {
        displayMessage("Bu oyunu oynamak iÃ§in 'TÄ±kla-Yakala Bileti'ne ihtiyacÄ±n var. MaÄŸazadan alabilirsin.");
        return;
    }

    ticketsUsedThisRound = ticketCount; // KaÃ§ biletle oynandÄ±ÄŸÄ±nÄ± global deÄŸiÅŸkene kaydet

    const confirmed = await customConfirm(
        `Mevcut <b>${ticketsUsedThisRound}</b> biletinin tamamÄ± bu oyun iÃ§in kullanÄ±lacak. OnaylÄ±yor musun?<br><br>
        <small class="text-yellow-300">KazandÄ±ÄŸÄ±n skor ve tÃ¼m Ã¶zel eÅŸyalar, kullandÄ±ÄŸÄ±n bilet sayÄ±sÄ±yla (${ticketsUsedThisRound}x) Ã§arpÄ±lacaktÄ±r!</small>`
    );
    if (!confirmed) {
        ticketsUsedThisRound = 1; // KullanÄ±cÄ± iptal ederse, deÄŸiÅŸkeni sÄ±fÄ±rla
        return;
    }

    await userRef.update({ clickCatchTickets: 0 }); // TÃ¼m biletleri kullan
    
    const specialItemMapping = {
      'boxRight': { type: 'boxRight', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ“¦' },
      'iflasShield': { type: 'iflasShield', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ›¡ï¸' },
      'wheelTicket': { type: 'wheelTicket', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ«ï¸' },
      'tempMultiplier': { type: 'tempMultiplier', value: soloGameSettings.specialValue || 2, uses: soloGameSettings.specialMultiplierUses || 1, emoji: 'âœ–ï¸' },
      'wildcard': { type: 'wildcard', value: soloGameSettings.specialValue || 1, emoji: 'ğŸƒ' },
      'card_pack': { type: 'card_pack', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ´' },
      'card_pack_normal': { type: 'card_pack_normal', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ¥‰' },
      'card_pack_gumus': { type: 'card_pack_gumus', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ¥ˆ' },
      'card_pack_altin': { type: 'card_pack_altin', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ¥‡' },
      'card_pack_efsanevi': { type: 'card_pack_efsanevi', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ†' },
      'revival_stone': { type: 'revival_stone', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ’' },
      'health_potion': { type: 'health_potion', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ§ª' },
      'defense_potion': { type: 'defense_potion', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ›¡ï¸' },
      'damage_potion': { type: 'damage_potion', value: soloGameSettings.specialValue || 1, emoji: 'âš”ï¸' },
      'crit_potion': { type: 'crit_potion', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ’¥' },
      'crit_damage_potion': { type: 'crit_damage_potion', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ¯' },
      'dodge_potion': { type: 'dodge_potion', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ’¨' },
      'pierce_potion': { type: 'pierce_potion', value: soloGameSettings.specialValue || 1, emoji: 'ğŸ“Œ' },
    };

    specialItemForThisRound = specialItemMapping[soloGameSettings.specialItemType] || specialItemMapping['boxRight'];
    
    clickCatchGameActive = true;
    clickCatchScore = 0;
    clickCatchTimer = soloGameSettings.duration;
    collectedBoxRights = 0;
    collectedIflasShields = 0;
    collectedWheelTickets = 0;
    collectedMultipliers = [];
    collectedCardPacks = [];
    collectedPotions = []; // â˜…â˜…â˜… DÃœZELTME BURADA: Eksik deÄŸiÅŸken tanÄ±mlandÄ± â˜…â˜…â˜…

    document.getElementById('clickCatchScore').textContent = clickCatchScore;
    document.getElementById('clickCatchTimer').textContent = clickCatchTimer;
    document.getElementById('displayScore').classList.remove('hidden');
    document.getElementById('displaySpecials').classList.remove('hidden');
    document.getElementById('displayTimer').classList.remove('hidden');
    document.getElementById('displayTarget').classList.add('hidden');
    document.getElementById('collectedSpecials').innerHTML = '';
    showGameCountdown(_actuallyStartSoloGame);
}

// handleSoloItemClick fonksiyonunu bununla deÄŸiÅŸtir
async function handleSoloItemClick(event) {
    if (!clickCatchGameActive) return;
    
    const item = event.target.closest('.catch-item');
    if (!item) return;

    const type = item.dataset.type;
    const value = parseInt(item.dataset.value);
    const uses = parseInt(item.dataset.uses);
    const emoji = item.dataset.emoji;
    
    let floatingText = '';

    switch(type) {
        case 'points':
            clickCatchScore = Number(clickCatchScore) + value;
            document.getElementById('clickCatchScore').textContent = clickCatchScore;
            floatingText = (value > 0 ? '+' : '') + value + ' Skor';
            break;
        case 'time':
            clickCatchTimer += value;
            document.getElementById('clickCatchTimer').textContent = clickCatchTimer;
            floatingText = `+${value} Saniye`;
            break;
        case 'boxRight':
            collectedBoxRights += value;
            floatingText = `+${value} Kutu HakkÄ±`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'iflasShield':
            collectedIflasShields += value;
            floatingText = `+${value} Ä°flas KalkanÄ±`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'wheelTicket':
            collectedWheelTickets += value;
            floatingText = `+${value} Ã‡ark Bileti`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'tempMultiplier':
            collectedMultipliers.push({ value: value, uses: uses });
            floatingText = `${value}x Ã‡arpan (${uses} kullanÄ±m)`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'wildcard':
            collectedWildcards += value;
            floatingText = `+${value} ğŸƒ Joker Kart YakalandÄ±!`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'card_pack':
        case 'card_pack_normal':
        case 'card_pack_gumus':
        case 'card_pack_altin':
        case 'card_pack_efsanevi':
            const packName = typeToName[type] || 'Kart Paketi';
            collectedCardPacks.push({ type: type, value: value });
            floatingText = `+${value} ${packName} YakalandÄ±!`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        // â˜…â˜…â˜… DÃœZELTME BURADA: ArtÄ±k 'collectedPotions' tanÄ±mlÄ± olduÄŸu iÃ§in bu kod sorunsuz Ã§alÄ±ÅŸacak â˜…â˜…â˜…
        case 'revival_stone':
        case 'health_potion':
        case 'damage_potion':
        case 'defense_potion':
        case 'crit_potion':
        case 'crit_damage_potion':
        case 'dodge_potion':
        case 'pierce_potion':
             const potionName = typeToName[type] || 'Ä°ksir';
             collectedPotions.push({ type: type, value: value });
             floatingText = `+${value} ${potionName} YakalandÄ±!`;
             document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
             break;
    }
    
    showFloatingText(floatingText, event.clientX, event.clientY);
    item.remove();
}
      
async function endSoloClickCatchGame() {
    clickCatchGameActive = false;
    clearInterval(clickCatchTimerInterval);
    clearInterval(clickCatchItemInterval);
    clickCatchTimerInterval = null;
    clickCatchItemInterval = null;

    const gameArea = document.getElementById('clickCatchGameArea');
    const itemsToRemove = gameArea.querySelectorAll('.catch-item, .floating-text');
    itemsToRemove.forEach(item => item.remove());

    document.getElementById('clickCatchStartScreen').style.display = 'flex';
    document.getElementById('displayScore').classList.add('hidden');
    document.getElementById('displaySpecials').classList.add('hidden');
    document.getElementById('displayTimer').classList.add('hidden');

    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const user = userSnap.val();
    if (!user) return;

    // --- 1. ADIM: TÃœM NÄ°HAÄ° Ã–DÃœLLERÄ° HESAPLA ---
    const finalScore = clickCatchScore * ticketsUsedThisRound;
    const finalBoxRights = collectedBoxRights * ticketsUsedThisRound;
    const finalIflasShields = collectedIflasShields * ticketsUsedThisRound;
    const finalWheelTickets = collectedWheelTickets * ticketsUsedThisRound;

    // â˜…â˜…â˜… SORUNU Ã‡Ã–ZEN ANA MANTIK BAÅLANGICI â˜…â˜…â˜…
    // Yakalanan Ã§arpanlarÄ± deÄŸerlerine gÃ¶re gruplayalÄ±m (Ã¶rn: tÃ¼m 2x'leri bir arada topla)
    const aggregatedMultipliers = collectedMultipliers.reduce((acc, multiplier) => {
        const key = multiplier.value; // Anahtar olarak Ã§arpan deÄŸeri (2, 3 vb.)
        if (!acc[key]) {
            acc[key] = { value: key, totalUses: 0 };
        }
        acc[key].totalUses += multiplier.uses;
        return acc;
    }, {});
    // â˜…â˜…â˜… SORUNU Ã‡Ã–ZEN ANA MANTIK SONU â˜…â˜…â˜…

    // --- 2. ADIM: GÃœNCELLEME VE LOGLAMA Ä°Ã‡Ä°N VERÄ°LERÄ° HAZIRLA ---
    const updates = {};
    const specialItemsWonDetails = [];
    let finalUser = JSON.parse(JSON.stringify(user)); // KullanÄ±cÄ± verisinin derin bir kopyasÄ±nÄ± al

    // Basit Ã¶dÃ¼lleri ekle
    if (finalBoxRights > 0) {
        finalUser.kutuHakki = (finalUser.kutuHakki || 0) + finalBoxRights;
        specialItemsWonDetails.push({ name: 'Kutu HakkÄ±', amount: finalBoxRights });
    }
    if (finalIflasShields > 0) {
        finalUser.iflasShieldUses = (finalUser.iflasShieldUses || 0) + finalIflasShields;
        specialItemsWonDetails.push({ name: 'Ä°flas KalkanÄ±', amount: finalIflasShields });
    }
    if (finalWheelTickets > 0) {
        finalUser.carkBileti = (finalUser.carkBileti || 0) + finalWheelTickets;
        specialItemsWonDetails.push({ name: 'Ã‡ark Bileti', amount: finalWheelTickets });
    }

    // â˜…â˜…â˜… BÄ°RLEÅTÄ°RÄ°LMÄ°Å Ã‡ARPANLARI Ä°ÅLE â˜…â˜…â˜…
    for (const key in aggregatedMultipliers) {
        const multiplierGroup = aggregatedMultipliers[key];
        const finalTotalUses = multiplierGroup.totalUses * ticketsUsedThisRound; // Bilet sayÄ±sÄ±yla Ã§arp

        const hasActiveMultiplier = (finalUser.multiplierSource && finalUser.multiplierSource !== 'none') && (finalUser.multiplierRemainingUses > 0 || finalUser.multiplierSource === 'box');
        
        if (hasActiveMultiplier) {
            if (multiplierGroup.value === finalUser.activeMultiplier) {
                finalUser.multiplierRemainingUses = (finalUser.multiplierRemainingUses || 0) + finalTotalUses;
            } else {
                finalUser.kutuHakki = (finalUser.kutuHakki || 0) + finalTotalUses;
            }
        } else {
            finalUser.activeMultiplier = multiplierGroup.value;
            finalUser.multiplierRemainingUses = finalTotalUses;
            finalUser.multiplierSource = 'store';
        }
        specialItemsWonDetails.push({ name: `${multiplierGroup.value}x Ã‡arpan`, amount: `${finalTotalUses} KullanÄ±m` });
    }
    // â˜…â˜…â˜… Ä°ÅLEME SONU â˜…â˜…â˜…

    // Final gÃ¼ncellemelerini hazÄ±rla
    updates[`/users/${currentUser}/kutuHakki`] = finalUser.kutuHakki;
    updates[`/users/${currentUser}/iflasShieldUses`] = finalUser.iflasShieldUses;
    updates[`/users/${currentUser}/carkBileti`] = finalUser.carkBileti;
    updates[`/users/${currentUser}/activeMultiplier`] = finalUser.activeMultiplier;
    updates[`/users/${currentUser}/multiplierRemainingUses`] = finalUser.multiplierRemainingUses;
    updates[`/users/${currentUser}/multiplierSource`] = finalUser.multiplierSource;
    
    // SkorlarÄ± gÃ¼ncelle
    const weeklyScoreRef = db.ref(`clickCatchWeeklyScores/${currentUser}`);
    const currentWeeklyScore = (await weeklyScoreRef.once('value')).val() || 0;
    const newTotalWeeklyScore = currentWeeklyScore + Math.max(0, finalScore);
    updates[`/clickCatchWeeklyScores/${currentUser}`] = newTotalWeeklyScore;
    updates[`/users/${currentUser}/clickCatchHighestScore`] = newTotalWeeklyScore;

    // --- 3. ADIM: AKTÄ°VÄ°TE KAYDINI OLUÅTUR (TEK SEFERDE) ---
    logActivity('clickCatchSolo', currentUser, {
        baseScore: clickCatchScore,
        finalScore: finalScore,
        ticketsUsed: ticketsUsedThisRound,
        specialItems: specialItemsWonDetails, // ArtÄ±k birleÅŸtirilmiÅŸ liste
        newWeeklyScore: newTotalWeeklyScore
    });

    // --- 4. ADIM: KULLANICIYA BÄ°LDÄ°RÄ°M GÃ–NDER ---
    let endMessage = `Oyun bitti! Bu turdaki toplam skorun: <b>${finalScore}</b>. <br><small class="text-gray-400">(Skor: ${clickCatchScore} x ${ticketsUsedThisRound} Bilet)</small>`;
    if (specialItemsWonDetails.length > 0) {
        const itemsText = specialItemsWonDetails.map(item => `+${item.amount} ${item.name}`).join(', ');
        endMessage += `<br>AyrÄ±ca, <b>${itemsText}</b> kazandÄ±n!`;
    }
    if (collectedCardPacks.length > 0) {
        const totalPacks = collectedCardPacks.length * ticketsUsedThisRound;
        endMessage += `<br>Ve <b class="text-purple-400">${totalPacks} adet Kart Paketi</b> kazandÄ±n! Paketler ÅŸimdi aÃ§Ä±lacak...`;
    }
    displayMessage(endMessage);

    // --- 5. ADIM: TÃœM GÃœNCELLEMELERÄ° VERÄ°TABANINA YAZ ---
    await db.ref().update(updates);

    // --- 6. ADIM: KART PAKETLERÄ°NÄ° AÃ‡ ---
    if (collectedCardPacks.length > 0) {
        const totalPacks = collectedCardPacks.reduce((sum, pack) => sum + pack.value, 0) * ticketsUsedThisRound;
        const packType = collectedCardPacks[0].type; // VarsayalÄ±m ki tek tÃ¼r paket toplanÄ±yor
        await startCardPackOpening(totalPacks, 'TÄ±kla-Yakala Oyunu', 1, packType);
    }
    
    ticketsUsedThisRound = 1;
}


  // ... VE YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTIR
async function openSelectWinnerModal() {
    if (!isAdmin) return;

    const winnerInfoDiv = document.getElementById('winnerInfoForAdmin');
    winnerInfoDiv.innerHTML = '<p class="text-gray-400">Lider bilgisi yÃ¼kleniyor...</p>';
    
    const scoresSnap = await db.ref('clickCatchWeeklyScores').orderByValue().limitToLast(1).once('value');
    
    // --- DEÄÄ°ÅÄ°KLÄ°K BURADA ---
    // EÄŸer sÄ±ralama boÅŸsa (scoresSnap.exists() false ise)
    if (!scoresSnap.exists()) {
        // Ã–dÃ¼l penceresini aÃ§mak yerine genel bilgilendirme mesajÄ± gÃ¶ster
        displayMessage("Ã–dÃ¼l verilecek bir lider bulunamadÄ± Ã§Ã¼nkÃ¼ TÄ±kla-Yakala sÄ±ralamasÄ± ÅŸu anda boÅŸ.");
        // ve fonksiyonu burada bitir.
        return;
    }
    
    const scoresData = scoresSnap.val();
    const winnerUsername = Object.keys(scoresData)[0];
    const winnerScore = scoresData[winnerUsername];

    winnerInfoDiv.innerHTML = `
        <p>HaftanÄ±n Lideri: <b class="text-white text-lg">${winnerUsername}</b></p>
        <p>Toplam Skoru: <b class="text-yellow-300 text-lg">${winnerScore}</b></p>
    `;
    
    window.weeklyWinnerData = { username: winnerUsername, score: winnerScore };

    document.getElementById('selectWinnerPrizeModal').style.display = 'flex';
}

// Ã–dÃ¼l verme penceresini kapatÄ±r
function closeSelectWinnerModal() {
    document.getElementById('selectWinnerPrizeModal').style.display = 'none';
    window.weeklyWinnerData = null;
}

// ... VE YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTIR
async function confirmAndAwardPrize() {
    if (!isAdmin || !window.weeklyWinnerData) return;

    const { username, score } = window.weeklyWinnerData;
    const prizeType = document.getElementById('prizeType').value;
    const prizeAmount = parseInt(document.getElementById('prizeAmount').value);

    if (isNaN(prizeAmount) || prizeAmount <= 0) {
        displayMessage("LÃ¼tfen geÃ§erli bir Ã¶dÃ¼l miktarÄ± girin.");
        return;
    }

    const prizeNames = {
        boxRights: "Kutu HakkÄ±",
        points: "Puan",
        wheelTicket: "Ã‡ark Bileti",
        iflasShield: "Ä°flas KalkanÄ±"
    };
    const prizeName = prizeNames[prizeType];

    const confirmed = await customConfirm(
        `<b>${username}</b> adlÄ± kullanÄ±cÄ±ya <b>${prizeAmount} ${prizeName}</b> Ã¶dÃ¼lÃ¼ verilecek ve TÄ±kla-Yakala haftasÄ± sÄ±fÄ±rlanacak. OnaylÄ±yor musunuz?`
    );

    if (!confirmed) return;

    // --- YENÄ° ADIMLAR ---
    // Ã–nce o hafta oyuna katÄ±lan herkesi bulalÄ±m.
    const weeklyScoresSnap = await db.ref('clickCatchWeeklyScores').once('value');
    const participants = weeklyScoresSnap.exists() ? Object.keys(weeklyScoresSnap.val()) : [];
    // --- YENÄ° ADIMLAR BÄ°TÄ°Å ---

    // 1. KazananÄ±n bilgilerini kalÄ±cÄ± olarak kaydet
    const winnerDataToSave = {
        winnerName: username,
        winningScore: score,
        prizeAwarded: `${prizeAmount} ${prizeName}`,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    await db.ref('gameStats/weeklyClickCatchWinner').set(winnerDataToSave);

    // 2. Kazanan kullanÄ±cÄ±ya Ã¶dÃ¼lÃ¼nÃ¼ ver
    const winnerUserRef = db.ref(`users/${username}`);
    await winnerUserRef.transaction(user => {
        if (user) {
            if (prizeType === 'points') user.balance = (user.balance || 0) + prizeAmount;
            else if (prizeType === 'boxRights') user.kutuHakki = (user.kutuHakki || 0) + prizeAmount;
            else if (prizeType === 'wheelTicket') user.carkBileti = (user.carkBileti || 0) + prizeAmount;
            else if (prizeType === 'iflasShield') user.iflasShieldUses = (user.iflasShieldUses || 0) + prizeAmount;
        }
        return user;
    });

    // 3. HaftalÄ±k skor tablosunu sil
    await db.ref('clickCatchWeeklyScores').remove();

    // 4. TÃ¼m kullanÄ±cÄ±larÄ±n skorlarÄ±nÄ± ve BÄ°LET HEDÄ°YELERÄ°NÄ° gÃ¼ncelle
    const allUsersSnap = await db.ref('users').once('value');
    const allUsers = allUsersSnap.val();
    const updates = {};
    for (const u in allUsers) {
        // KiÅŸisel skoru sÄ±fÄ±rla (eÄŸer varsa)
        if (allUsers[u].clickCatchHighestScore) {
            updates[`/users/${u}/clickCatchHighestScore`] = 0;
        }
        // EÄŸer bu kullanÄ±cÄ± o hafta katÄ±lÄ±m gÃ¶sterdiyse +1 bilet hediye et
        if (participants.includes(u)) {
            const currentTickets = allUsers[u].clickCatchTickets || 0;
            updates[`/users/${u}/clickCatchTickets`] = currentTickets + 1;
        }
    }
    if (Object.keys(updates).length > 0) {
        await db.ref().update(updates);
    }
    
    // --- YENÄ° BÄ°LGÄ°LENDÄ°RME ADIMI ---
    // Global bir bildirim gÃ¶ndererek herkesi bilgilendir
    const notificationMessage = `TÄ±kla-Yakala haftasÄ±nÄ±n ÅŸampiyonu ${username} oldu! Kendisini tebrik ederiz. Yeni hafta baÅŸladÄ±!`;
    db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
    // --- YENÄ° BÄ°LGÄ°LENDÄ°RME BÄ°TÄ°Å ---


    displayMessage(`${username} Ã¶dÃ¼llendirildi ve TÄ±kla-Yakala haftasÄ± baÅŸarÄ±yla sÄ±fÄ±rlandÄ±! KatÄ±lÄ±mcÄ±lara +1 bilet hediye edildi.`);
    closeSelectWinnerModal();
}

// HaftanÄ±n kazananÄ± verisini dinler ve paneli gÃ¼nceller
function listenForWeeklyWinner() {
    const ref = db.ref('gameStats/weeklyClickCatchWinner');
    const container = document.getElementById('weeklyWinnerContainer');
    const infoDiv = document.getElementById('weeklyWinnerInfo');
    const clearBtn = document.getElementById('clearWeeklyWinnerBtn');

    const callback = snap => {
        const winnerData = snap.val();
        if (winnerData) {
            infoDiv.innerHTML = `
                <p>Kazanan: <b class="text-white">${winnerData.winnerName}</b></p>
                <p>Skor: <b class="text-white">${winnerData.winningScore}</b></p>
                <p>Ã–dÃ¼l: <b class="text-green-400">${winnerData.prizeAwarded}</b></p>
            `;
            container.classList.remove('hidden');
            if (isAdmin) {
                clearBtn.classList.remove('hidden');
            }
        } else {
            container.classList.add('hidden');
        }
    };
    
    // Listener'Ä± tekrar tekrar eklememek iÃ§in kontrol
    if (activeListeners.weeklyWinner) {
        activeListeners.weeklyWinner.ref.off('value', activeListeners.weeklyWinner.callback);
    }
    activeListeners.weeklyWinner = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// Adminin kazanan panelini kapatmasÄ±nÄ± saÄŸlar
async function clearWeeklyWinnerDisplay() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("HaftanÄ±n kazananÄ± panelini gizlemek istediÄŸinize emin misiniz? Bu iÅŸlem kazananÄ± veya Ã¶dÃ¼lÃ¼nÃ¼ silmez, sadece paneli gizler.");
    if (confirmed) {
        await db.ref('gameStats/weeklyClickCatchWinner').remove();
    }
}

// --- YENÄ° FONKSÄ°YONLAR BÄ°TÄ°Å ---

function initActivityFeed() {
    const activityBellContainer = document.getElementById('activityBellContainer');
    const activityCounter = document.getElementById('activityCounter');
    const activityFeedPanel = document.getElementById('activityFeedPanel');
    const activityFeedList = document.getElementById('activityFeedList');

    activityBellContainer.classList.remove('hidden');

    const userFeedStatusRef = db.ref(`users/${currentUser}/lastCheckedFeedTimestamp`);
    // initActivityFeed fonksiyonu iÃ§inde bu satÄ±rla deÄŸiÅŸtir:
const ref = db.ref('activityFeed').orderByChild('timestamp').limitToLast(20);

    const callback = async (snapshot) => {
        const feedData = snapshot.val();
        
        if (!feedData) {
            renderActivityFeed([]); 
            activityCounter.classList.add('hidden'); 
            return;
        }

        const userStatusSnap = await userFeedStatusRef.once('value');
        const lastChecked = userStatusSnap.val() || 0;
        
        let unreadCount = 0;
        
        const sortedActivities = Object.keys(feedData).map(key => {
            return { id: key, ...feedData[key] };
        }).sort((a, b) => b.timestamp - a.timestamp);

        sortedActivities.forEach(activity => {
            if (activity.timestamp > lastChecked) {
                unreadCount++;
            }
        });

        if (unreadCount > 0) {
            activityCounter.textContent = unreadCount > 9 ? '9+' : unreadCount;
            activityCounter.classList.remove('hidden');
        } else {
            activityCounter.classList.add('hidden');
        }
        
        renderActivityFeed(sortedActivities);
    };

    activeListeners.activityFeed = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// â˜…â˜…â˜… BU FONKSÄ°YONU KOMPLE DEÄÄ°ÅTÄ°R â˜…â˜…â˜…
function logActivity(type, username, details = {}, activityId = null) {
    // WeizendTv'nin kendi eylemlerini loglama (Ã¶rneÄŸin lobi iptali)
    if (username.toLowerCase() === 'weizendtv') {
        return;
    }
    const activityData = {
        type,
        username,
        details,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    // --- DÃœZELTME BURADA ---
    // EÄŸer dÄ±ÅŸarÄ±dan bir activityId geldiyse (takas oluÅŸturma gibi), o ID ile kayÄ±t oluÅŸtur.
    // Gelmediyse, eskisi gibi yeni bir ID oluÅŸtur.
    const activityRef = activityId
        ? db.ref(`activityFeed/${activityId}`)
        : db.ref('activityFeed').push();
    
    activityRef.set(activityData);

    const feedRef = db.ref('activityFeed');
    feedRef.orderByChild('timestamp').once('value', (snapshot) => {
        const totalCount = snapshot.numChildren();
        const limit = 20;

        if (totalCount > limit) {
            let itemsToDeleteCount = totalCount - limit;
            snapshot.forEach((childSnapshot) => {
                if (itemsToDeleteCount <= 0) {
                    return true; 
                }
                childSnapshot.ref.remove();
                itemsToDeleteCount--;
            });
        }
    });
}

function initActivityFeed() {
    const activityBellContainer = document.getElementById('activityBellContainer');
    const activityCounter = document.getElementById('activityCounter');
    
    activityBellContainer.classList.remove('hidden');

    const userFeedStatusRef = db.ref(`users/${currentUser}/lastCheckedFeedTimestamp`);
    const ref = db.ref('activityFeed').orderByChild('timestamp').limitToLast(20);

    const callback = async (snapshot) => {
        const feedData = snapshot.val();
        
        if (!feedData) {
            renderActivityFeed([]); 
            activityCounter.classList.add('hidden'); 
            return;
        }

        const userStatusSnap = await userFeedStatusRef.once('value');
        const lastChecked = userStatusSnap.val() || 0;
        
        let unreadCount = 0;
        
        const sortedActivities = Object.keys(feedData).map(key => {
            return { id: key, ...feedData[key] };
        }).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        sortedActivities.forEach(activity => {
            if (activity.timestamp > lastChecked) {
                unreadCount++;
            }
        });

        if (unreadCount > 0) {
            activityCounter.textContent = unreadCount > 9 ? '9+' : unreadCount;
            activityCounter.classList.remove('hidden');
        } else {
            activityCounter.classList.add('hidden');
        }
        
        renderActivityFeed(sortedActivities);
    };

    activeListeners.activityFeed = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// ...VE YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTIR
function openActivityFeed() {
    const activityFeedPanel = document.getElementById('activityFeedPanel'); // EKLENEN SATIR
    const activityCounter = document.getElementById('activityCounter');   // EKLENEN SATIR
    activityFeedPanel.classList.remove('hidden');
    setTimeout(() => {
        activityFeedPanel.classList.remove('translate-x-full');
    }, 10);
    activityCounter.classList.add('hidden');
    db.ref(`users/${currentUser}/lastCheckedFeedTimestamp`).set(Date.now());
}

function closeActivityFeed() {
    const activityFeedPanel = document.getElementById('activityFeedPanel'); // EKLENEN SATIR
    activityFeedPanel.classList.add('translate-x-full');
    setTimeout(() => {
        activityFeedPanel.classList.add('hidden');
    }, 300);
}

function toggleActivityFeed() {
    const activityFeedPanel = document.getElementById('activityFeedPanel'); // EKLENEN SATIR
    if (activityFeedPanel.classList.contains('hidden')) {
        openActivityFeed();
    } else {
        closeActivityFeed();
    }
}

async function deleteActivity(activityId) {
    if (!isAdmin || !activityId) return;
    const confirmed = await customConfirm("Bu eylemi kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?");
    if (confirmed) {
        await db.ref('activityFeed/' + activityId).remove();
    }
}

async function clearAllActivities() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("TÃ¼m eylem geÃ§miÅŸini kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!");
    if (confirmed) {
        await db.ref('activityFeed').remove();
        renderActivityFeed([]);
    }
}

function formatTimeAgo(timestamp) {
    const now = getSyncedTime();
    const seconds = Math.floor((now - timestamp) / 1000);

    if (seconds < 60) {
        return `az Ã¶nce`;
    }
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) {
        return `${minutes} dakika Ã¶nce`;
    }
    const hours = Math.floor(minutes / 60);
    if (hours < 24) {
        return `${hours} saat Ã¶nce`;
    }
    const days = Math.floor(hours / 24);
    if (days < 7) {
        return `${days} gÃ¼n Ã¶nce`;
    }
    
    return new Date(timestamp).toLocaleDateString('tr-TR');
}

// "Adet" inputlarÄ±ndan biri her deÄŸiÅŸtiÄŸinde toplam kutu sayÄ±sÄ±nÄ± hesaplar ve gÃ¶sterir.
function updateTotalBoxCount() {
    let total = 0;
    document.querySelectorAll('.box-setting-row .setting-count').forEach(input => {
        const count = parseInt(input.value);
        if (!isNaN(count) && count > 0) {
            total += count;
        }
    });
    document.getElementById('totalBoxCountDisplay').textContent = total;
}

// TÃ¼m satÄ±rlardaki verileri okur, yeni ayarlarÄ± veritabanÄ±na kaydeder ve oyunu sÄ±fÄ±rlar.
async function saveBoxSettings() {
    if (!isAdmin) return;

    const newConfig = [];
    let totalBoxes = 0;
    let hasError = false;

    document.querySelectorAll('.box-setting-row').forEach(row => {
        const type = row.querySelector('.setting-type').value;
        const value = parseInt(row.querySelector('.setting-value').value);
        const count = parseInt(row.querySelector('.setting-count').value);

        // DoÄŸrulama: Adet ve DeÄŸer alanlarÄ± geÃ§erli mi?
        if (isNaN(count) || count <= 0) {
            // Adet girilmemiÅŸse bu satÄ±rÄ± atla
            return;
        }
        if (isNaN(value) && (type === 'points' || type === 'multiplier')) {
            displayMessage(`Hata: ${type} tÃ¼rÃ¼ iÃ§in geÃ§erli bir 'DeÄŸer' girmelisiniz.`);
            hasError = true;
            return;
        }
        
        newConfig.push({ type, value, count });
        totalBoxes += count;
    });

    if (hasError) return; // Hata varsa iÅŸlemi durdur

    if (totalBoxes === 0) {
        displayMessage("En az bir kutu tÃ¼rÃ¼ iÃ§in adet girmelisiniz!");
        return;
    }

    const confirmed = await customConfirm(`Toplam ${totalBoxes} kutu ile yeni bir oyun baÅŸlatÄ±lacak. Mevcut oyun sÄ±fÄ±rlanacak. OnaylÄ±yor musunuz?`);
    if (confirmed) {
        await db.ref('gameConfig/boxContents').set(newConfig);
        await resetGameBoard(); 
        displayMessage("Kutu ayarlarÄ± baÅŸarÄ±yla kaydedildi ve oyun yeni ayarlarla yeniden baÅŸlatÄ±ldÄ±!");
        closeBoxSettingsModal();
    }
}

    // YENÄ°: Kutu ayarlarÄ±nÄ± kodda tanÄ±mlÄ± olan varsayÄ±lan deÄŸerlere dÃ¶ndÃ¼rÃ¼r.
async function resetBoxSettingsToDefault() {
    if (!isAdmin) return;
    
    const confirmed = await customConfirm("Mevcut ayarlarÄ± silip varsayÄ±lan kutu yapÄ±landÄ±rmasÄ±na dÃ¶nmek istediÄŸinize emin misiniz? <br><small>(Bu iÅŸlem, siz 'Kaydet' butonuna basana kadar kalÄ±cÄ± olmayacaktÄ±r.)</small>");
    if (!confirmed) return;

    const container = document.getElementById('boxSettingsRowsContainer');
    container.innerHTML = ''; // Paneli temizle

    // Script'in en baÅŸÄ±nda tanÄ±mlÄ± olan varsayÄ±lan BOX_CONTENTS listesini kullan
    BOX_CONTENTS.forEach(item => {
        addBoxSettingRow(item);
    });

    updateTotalBoxCount(); // Toplam kutu sayÄ±sÄ±nÄ± gÃ¼ncelle
}

    // Ã‡ark AyarlarÄ±nÄ± veritabanÄ±ndan YÃœKLEYEN ve sÄ±ralayan fonksiyon
async function loadWheelSettingsFromDB() {
    const settingsRef = db.ref('gameConfig/wheelSegments');
    const snapshot = await settingsRef.once('value');
    
    if (snapshot.exists() && snapshot.val() !== null) {
        const loadedData = snapshot.val();
        
        if (Array.isArray(loadedData)) {
            wheelSegments = loadedData.filter(item => item).sort((a, b) => (a.order || 0) - (b.order || 0));
        } else {
            wheelSegments = Object.values(loadedData).sort((a, b) => (a.order || 0) - (b.order || 0));
        }
    } else {
        // Firebase'de ayar yoksa varsayÄ±lanÄ± kullan
        wheelSegments = defaultWheelSegments;
    }
    
    renderWheel();
}
function openWheelSettingsModal() {
    if (!isAdmin) return;
    const container = document.getElementById('wheelSettingsRowsContainer');
    container.innerHTML = '';
    wheelSegments.forEach(item => addWheelSettingRow(item));
    wheelSettingsModal.style.display = 'flex';
}

function closeWheelSettingsModal() {
    wheelSettingsModal.style.display = 'none';
}

// Ã‡ark AyarlarÄ± iÃ§in yeni satÄ±r ekler
function addWheelSettingRow(item = {}) {
    const container = document.getElementById('wheelSettingsRowsContainer');
    const row = document.createElement('div');
    row.className = 'wheel-setting-row grid grid-cols-1 sm:grid-cols-7 items-center gap-3 p-3 bg-gray-900 rounded-lg';

    const type = item.type || 'points';
    const value = item.value !== undefined ? item.value : ''; // 0 deÄŸerini korumak iÃ§in kontrol
    const duration = item.duration || ''; // KullanÄ±m hakkÄ± iÃ§in 'duration'
    const label = item.label || '';
    const imageUrl = item.imageUrl || '';
    const color = item.color || '#f44336';
    const weight = item.weight || 10;

    row.innerHTML = `
        <select class="setting-type col-span-1 bg-gray-700 p-2 rounded-md text-white border border-gray-600" onchange="handleWheelRowTypeChange(this)">
            <option value="points">ğŸ’° Puan</option>
    <option value="boxRights">ğŸ“¦ Kutu HakkÄ±</option>
    <option value="wheelTicket">ğŸ« Ã‡ark Bileti</option>
    <option value="clickCatchTicket">ğŸŸï¸ TÄ±kla-Yakala Bileti</option>
    <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
    <option value="tempMultiplier">âœ–ï¸ Ã‡arpan</option>
    <option value="avatar">ğŸ‘¤ Avatar</option>
    <option value="wildcard">ğŸƒ Joker Kart</option>
    <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
    <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
    <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
    <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
    <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
    <option value="health_regen_potion">ğŸ§ª Can Yenileme Ä°ksiri</option>
<option value="revival_stone">ğŸ’ Dirilme TaÅŸÄ±</option>
<option value="health_potion">ğŸ§ª Can Ä°ksiri</option>
<option value="defense_potion">ğŸ›¡ï¸ Savunma Ä°ksiri</option>
<option value="damage_potion">âš”ï¸ Hasar Ä°ksiri</option>
<option value="crit_potion">ğŸ’¥ Kritik VuruÅŸ Ä°ksiri</option>
        </select>
        <input type="text" value="${label}" class="setting-label col-span-1 sm:col-span-2 bg-gray-700 p-2 rounded-md text-white" placeholder="Etiket (Ã–rn: JOKER!)">
        <input type="text" value="${imageUrl}" class="setting-image-url col-span-1 sm:col-span-2 bg-gray-700 p-2 rounded-md text-white" placeholder="Resim URL (Opsiyonel)">
        <input type="number" value="${value}" class="setting-value bg-gray-700 p-2 rounded-md text-white" placeholder="DeÄŸer">
        <input type="number" value="${duration}" class="setting-duration bg-gray-700 p-2 rounded-md text-white" placeholder="KullanÄ±m HakkÄ±">
        <div class="col-span-1 flex items-center gap-2">
            <input type="color" value="${color}" class="setting-color h-10 w-10 p-1 bg-gray-700 rounded-md">
            <input type="number" value="${weight}" class="setting-weight flex-grow bg-gray-700 p-2 rounded-md text-white" placeholder="Åans">
            <button class="bg-red-700 hover:bg-red-600 text-white p-2 rounded-md" onclick="this.parentElement.parentElement.remove();">Sil</button>
        </div>
    `;
    container.appendChild(row);
    handleWheelRowTypeChange(row.querySelector('.setting-type'));
}
    
/// Ã‡ark AyarlarÄ±'nda seÃ§ilen tÃ¼re gÃ¶re "DeÄŸer" ve "KullanÄ±m HakkÄ±" alanlarÄ±nÄ± yÃ¶netir
function handleWheelRowTypeChange(selectElement) {
    const row = selectElement.closest('.wheel-setting-row');
    const valueInput = row.querySelector('.setting-value');
    const durationInput = row.querySelector('.setting-duration'); // 'duration' bizim kullanÄ±m hakkÄ± alanÄ±mÄ±z
    const selectedType = selectElement.value;

    // Ã–nce tÃ¼m inputlarÄ± varsayÄ±lan durumuna getirelim
    valueInput.disabled = false;
    valueInput.placeholder = 'DeÄŸer';
    durationInput.disabled = true;
    durationInput.placeholder = 'KullanÄ±m HakkÄ±';
    
    // SORUNLU SATIR BUYDU, SÄ°LÄ°NDÄ°: durationInput.value = '';
    // Bu satÄ±r, input'a gelen doÄŸru deÄŸeri siliyordu. ArtÄ±k silmiyor.

    if (selectedType === 'pas' || selectedType === 'surpriseBox') {
        valueInput.disabled = true;
        valueInput.value = '';
        valueInput.placeholder = 'N/A';
        durationInput.value = ''; // Bu tipler iÃ§in kullanÄ±m hakkÄ± olmaz, temizleyelim.
    } else if (selectedType === 'tempMultiplier') {
        // EÄŸer Ã‡ARPAN seÃ§ildiyse:
        valueInput.placeholder = 'Ã‡arpan DeÄŸeri (2, 3...)';
        durationInput.disabled = false; // KullanÄ±m HakkÄ± alanÄ±nÄ± AKTÄ°F ET
        durationInput.placeholder = 'KullanÄ±m HakkÄ±';
    } else {
        // DiÄŸer tÃ¼m tipler iÃ§in KullanÄ±m HakkÄ± alanÄ± pasif ve boÅŸ olmalÄ±.
        durationInput.value = ''; 
    }
}

async function saveWheelSettings() {
    if (!isAdmin) return;

    const newConfig = [];
    let hasError = false;
    document.querySelectorAll('.wheel-setting-row').forEach((row, index) => {
        if(hasError) return;
        
        const type = row.querySelector('.setting-type').value;
        const label = row.querySelector('.setting-label').value.trim();
        const imageUrl = row.querySelector('.setting-image-url').value.trim();
        const value = parseInt(row.querySelector('.setting-value').value); // DeÄŸeri her zaman oku
        const duration = parseInt(row.querySelector('.setting-duration').value); // KullanÄ±m hakkÄ±nÄ± her zaman oku
        const color = row.querySelector('.setting-color').value;
        const weight = parseInt(row.querySelector('.setting-weight').value);

        if (!label || !color || isNaN(weight) || weight <= 0) {
            displayMessage("Her dilim iÃ§in Etiket, Renk ve geÃ§erli bir Åans AÄŸÄ±rlÄ±ÄŸÄ± girmelisiniz.");
            hasError = true;
            return;
        }

        const segment = { type, label, imageUrl, color, weight, order: index };
        
        // DeÄŸerin gerekli olduÄŸu tipler iÃ§in kontrol
        const needsValue = ['points', 'boxRights', 'iflasShield', 'tempMultiplier', 'clickCatchTicket', 'wheelTicket', 'wildcard', 'card_pack', 'card_pack_normal', 'card_pack_gumus', 'card_pack_altin', 'card_pack_efsanevi'];
        if(needsValue.includes(type)) {
            if(isNaN(value)) {
                displayMessage(`'${label}' adlÄ± dilim iÃ§in geÃ§erli bir DeÄŸer girmelisiniz.`);
                hasError = true;
                return;
            }
            segment.value = value;
        }

        // Sadece Ã‡ARPAN tipi iÃ§in KullanÄ±m HakkÄ±'nÄ± (duration) ekle
        if (type === 'tempMultiplier') {
            if(isNaN(duration) || duration <= 0) {
                displayMessage(`'${label}' adlÄ± Ã‡arpan dilimi iÃ§in geÃ§erli bir KullanÄ±m HakkÄ± girmelisiniz.`);
                hasError = true;
                return;
            }
            segment.duration = duration;
        }
        
        newConfig.push(segment);
    });

    if (hasError) return;
    
    if (newConfig.length === 0) {
        displayMessage("Ã‡arkta en az bir dilim olmalÄ±dÄ±r.");
        return;
    }

    const confirmed = await customConfirm("Yeni Ã§ark ayarlarÄ± kaydedilecek. OnaylÄ±yor musunuz?");
    if (confirmed) {
        await db.ref('gameConfig/wheelSegments').set(newConfig);
        await loadWheelSettingsFromDB(); // Yeni ayarlarÄ± anÄ±nda yÃ¼kle ve Ã§arkÄ± Ã§iz
        displayMessage("Åans Ã‡arkÄ± ayarlarÄ± baÅŸarÄ±yla kaydedildi.");
        closeWheelSettingsModal();
    }
}
    
async function resetWheelSettingsToDefault() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Mevcut ayarlarÄ± silip varsayÄ±lan Ã§ark yapÄ±landÄ±rmasÄ±na dÃ¶nmek istediÄŸinize emin misiniz? (DeÄŸiÅŸiklikleri kalÄ±cÄ± yapmak iÃ§in kaydetmeniz gerekir.)");
    if (!confirmed) return;

    // DoÄŸru container'Ä± seÃ§iyoruz
    const container = document.getElementById('wheelSettingsRowsContainer');
    container.innerHTML = ''; // Paneli temizliyoruz

    // HATA BURADAYDI: YanlÄ±ÅŸlÄ±kla BOX_CONTENTS kullanÄ±lÄ±yordu, DOÄRUSU defaultWheelSegments olacak.
    // ArtÄ±k doÄŸru listeyi okuyup, doÄŸru fonksiyonla satÄ±rlarÄ± ekliyor.
    defaultWheelSegments.forEach(item => {
        addWheelSettingRow(item);
    });
}

function loadWheelHistory() {
    const historyRef = db.ref('wheelHistory').limitToLast(10);
    const listEl = document.getElementById('wheelHistoryList');
    
    const callback = (snapshot) => {
        listEl.innerHTML = ''; 

        if (isAdmin) {
            listEl.innerHTML += `<div class="p-1 mb-2 text-center"><button onclick="clearWheelHistory()" class="w-full py-2 px-4 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg shadow-md text-sm">TÃ¼m Kazanan GeÃ§miÅŸini Temizle</button></div>`;
        }

        if (!snapshot.exists()) {
            listEl.innerHTML += '<p class="text-center text-gray-500">HenÃ¼z Ã§ark Ã§evrilmedi.</p>';
            return;
        }
        
        const history = [];
        snapshot.forEach(child => { history.push({ key: child.key, ...child.val() }); });
        history.reverse();

        const typeToName = {
    points: 'Puan',
    boxRights: 'Kutu HakkÄ±',
    iflasShield: 'Ä°flas KalkanÄ±',
    wheelTicket: 'Ã‡ark Bileti',
    clickCatchTicket: 'TÄ±kla-Yakala Bileti',
    tempMultiplier: 'Ã‡arpan',
    wildcard: 'Joker Kart',
    card_pack: 'Standart Kart Paketi',
    card_pack_normal: 'Bronz Kart Paketi',
    card_pack_gumus: 'GÃ¼mÃ¼ÅŸ Kart Paketi',
    card_pack_altin: 'AltÄ±n Kart Paketi',
    card_pack_efsanevi: 'Efsanevi Kart Paketi',
    health_regen_potion: 'Can Yenileme Ä°ksiri', // â˜…â˜…â˜… BU SATIRIN EKLÄ° OLDUÄUNDAN EMÄ°N OL â˜…â˜…â˜…
    health_potion: 'Can Ä°ksiri',
    revival_stone: 'Dirilme TaÅŸÄ±',
    defense_potion: 'Savunma Ä°ksiri',
    damage_potion: 'Hasar Ä°ksiri',
    crit_potion: 'Kritik VuruÅŸ Ä°ksiri',
    dodge_potion: 'SÄ±yrÄ±lma Ä°ksiri',
    crit_damage_potion: 'Kritik Hasar Ä°ksiri',
    pierce_potion: 'Delici VuruÅŸ Ä°ksiri'
};

        const typeToIcon = {
            wildcard: 'ğŸƒ', card_pack: 'ğŸ´', card_pack_normal: 'ğŸ¥‰',
            card_pack_gumus: 'ğŸ¥ˆ', card_pack_altin: 'ğŸ¥‡', card_pack_efsanevi: 'ğŸ†'
        };
        // --- DÃœZELTME BURADA BÄ°TÄ°YOR ---

        history.forEach(item => {
            const timeAgo = formatTimeAgo(item.timestamp);
            
            let icon = 'â“';
            let prizeText = item.prize;
            const prizeType = item.type;
            const prizeValue = item.value;

            if (prizeType === 'points') {
                if (prizeValue >= 1000) icon = 'ğŸ‚';
                else if (prizeValue >= 250) icon = 'ğŸ';
                else if (prizeValue >= 100) icon = 'ğŸŒ';
                else icon = 'ğŸ†';
                prizeText = `+${prizeValue} PUAN`; 
            } else if (prizeType === 'surpriseBox') {
                icon = 'ğŸ‰';
                prizeText = 'SÃœRPRÄ°Z KUTU';
            } else if (prizeType === 'boxRights') {
                icon = prizeValue > 1 ? 'ğŸ' : 'ğŸ“¦';
                prizeText = `+${prizeValue} Kutu HakkÄ±`;
            } else if (prizeType === 'clickCatchTicket') {
                icon = 'ğŸŸï¸';
                prizeText = `+${prizeValue} TÄ±kla-Yakala Bileti`;
            } else if (prizeType === 'wheelTicket') {
                icon = 'ğŸ¡';
                prizeText = `+${prizeValue} Ã‡ark Bileti`;
            } else if (prizeType === 'tempMultiplier') {
                icon = 'âœ–ï¸';
                prizeText = `${prizeValue}X Ã‡ARPAN`;
            } else if (prizeType === 'iflasShield') {
                icon = 'ğŸ›¡ï¸';
                prizeText = `+${prizeValue} Ä°flas KalkanÄ±`;
            // --- DÃœZELTME BURADA BAÅLIYOR: ArtÄ±k tÃ¼m kart paketlerini tanÄ±yor ---
            } else if (prizeType.startsWith('card_pack') || prizeType === 'wildcard') {
                icon = typeToIcon[prizeType] || 'ğŸƒ';
                const name = typeToName[prizeType] || 'Kart Paketi';
                prizeText = `+${prizeValue} ${name}`;
            // --- DÃœZELTME BURADA BÄ°TÄ°YOR ---
            } else if (prizeType === 'pas') {
                icon = 'â˜ ï¸';
                prizeText = 'PAS';
            }
            
            const deleteButton = isAdmin 
                ? `<button onclick="deleteWheelHistoryEntry('${item.key}')" class="ml-3 text-gray-500 hover:text-red-500 transition-colors" title="Bu KaydÄ± Sil">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                   </button>` 
                : '';

            listEl.innerHTML += `
                <div class="p-2 bg-gray-800 rounded-md mb-2 text-sm flex justify-between items-center">
                    <span class="flex items-center">
                        <b>${item.username}:</b> 
                        <span class="text-yellow-200 ml-2 flex items-center gap-2">
                            <span>${prizeText}</span>
                            <span class="text-lg">${icon}</span>
                        </span>
                    </span>
                    <div class="flex items-center">
                        <span class="text-gray-500 text-xs">${timeAgo}</span>
                        ${deleteButton}
                    </div>
                </div>
            `;
        });
    };

    if (activeListeners.wheelHistory) {
      historyRef.off('value', activeListeners.wheelHistory.callback);
    }
    activeListeners.wheelHistory = { ref: historyRef, event: 'value', callback };
    historyRef.on('value', callback);
}

  function openHelpModal() {
  helpModal.style.display = 'flex';
}

function closeHelpModal() {
  helpModal.style.display = 'none';
}

  function closeAvatarSelectionModal() {
        avatarSelectionModal.style.display = 'none';
    }

    async function openAvatarSelectionModal() {
        closeInventoryModal(); // Ã–nce envanter penceresini kapat
        avatarSelectionModal.style.display = 'flex';
        const avatarGrid = document.getElementById('avatarGrid');
        avatarGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">YÃ¼kleniyor...</p>';

        const userRef = db.ref('users/' + currentUser);
        const userSnap = await userRef.once('value');
        const userData = userSnap.val();
        
        const purchasedAvatars = userData.avatars || {};
        const selectedAvatarId = userData.selectedAvatar ? userData.selectedAvatar.id : null;

        if (Object.keys(purchasedAvatars).length === 0) {
            avatarGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">HenÃ¼z satÄ±n alÄ±nmÄ±ÅŸ bir avatarÄ±nÄ±z yok. MaÄŸazayÄ± ziyaret edin!</p>';
            return;
        }

        avatarGrid.innerHTML = ''; // Temizle
        for (const itemId in purchasedAvatars) {
            const avatar = purchasedAvatars[itemId];
            const isSelected = selectedAvatarId === itemId;
            
            const avatarCard = document.createElement('div');
            avatarCard.className = `relative p-2 rounded-lg cursor-pointer transition-all duration-200 ${isSelected ? 'bg-blue-500 ring-4 ring-blue-300' : 'bg-gray-700 hover:bg-gray-600'}`;
            avatarCard.onclick = () => selectAvatar(itemId, avatar.imageUrl);
            
            avatarCard.innerHTML = `
                <img src="${avatar.imageUrl}" alt="${avatar.name}" class="w-full h-auto rounded-md object-cover aspect-square">
                <p class="text-xs mt-2 text-white truncate">${avatar.name}</p>
                ${isSelected ? '<div class="absolute top-1 right-1 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">âœ“</div>' : ''}
            `;
            avatarGrid.appendChild(avatarCard);
        }
    }

    // MEVCUT selectAvatar FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
async function selectAvatar(itemId, imageUrl) {
    if (isAdmin) return;

    // â˜…â˜…â˜… Ã–NEMLÄ° DÃœZELTME BURADA â˜…â˜…â˜…
    // Devam eden bir savaÅŸ olup olmadÄ±ÄŸÄ±nÄ± global veriden kontrol ediyoruz.
    if (monsterBattleData && monsterBattleData.damageLeaderboard && monsterBattleData.damageLeaderboard[currentUser]) {
        // EÄŸer savaÅŸ varsa, uyarÄ±yÄ± gÃ¶steriyoruz.
        displayMessage("Devam eden bir canavar savaÅŸÄ± varken avatarÄ±nÄ± deÄŸiÅŸtiremezsin!");
        // VE en Ã¶nemlisi, `return;` komutuyla fonksiyonun devam etmesini ENGELLÄ°YORUZ.
        return; 
    }
    // â˜…â˜…â˜… DÃœZELTME SONU â˜…â˜…â˜…

    const userRef = db.ref('users/' + currentUser);
    const avatarData = {
        id: itemId,
        url: imageUrl
    };
    await userRef.child('selectedAvatar').set(avatarData);

    document.getElementById('currentUserAvatar').src = imageUrl;

    if (currentActiveSection === 'monsterBattle') {
        renderMonsterBattleUI();
    }

    displayMessage("Avatar baÅŸarÄ±yla seÃ§ildi!");
    closeAvatarSelectionModal();
}

// MEVCUT editStoreItem FONKSÄ°YONUNU SÄ°LÄ°P BU YENÄ° VERSÄ°YONU YAPIÅTIRIN
async function editStoreItem(itemId) {
    if (!isAdmin) return;
    
    const itemSnap = await storeItemsRef.child(itemId).once('value');
    const item = itemSnap.val();
    if (!item) {
        displayMessage("DÃ¼zenlenecek Ã¼rÃ¼n bulunamadÄ±.");
        return;
    }

    document.getElementById('newItemName').value = item.name;
    document.getElementById('newItemDescription').value = item.description;
    document.getElementById('newItemCost').value = item.cost;
    document.getElementById('newItemStock').value = item.stock !== null ? item.stock : '';
    document.getElementById('newItemType').value = item.type;
    document.getElementById('newItemValue').value = item.value;
    document.getElementById('newItemImageUrl').value = item.imageUrl || '';
    
    // â˜…â˜…â˜… DÃœZELTME BURADA: ArtÄ±k "Fiyat ArtÄ±ÅŸÄ±" 0 ise bile input'ta doÄŸru ÅŸekilde "0" gÃ¶rÃ¼necek. â˜…â˜…â˜…
    // '||' operatÃ¶rÃ¼ 0'Ä± 'false' kabul ettiÄŸi iÃ§in boÅŸ gÃ¶steriyordu, bu dÃ¼zeltildi.
    document.getElementById('newItemPriceIncrease').value = (item.priceIncrease !== undefined && item.priceIncrease !== null) ? item.priceIncrease : '';

    const totalMins = item.countdownDurationMinutes || 0;
    const days = Math.floor(totalMins / 1440);
    const remainingMinsAfterDays = totalMins % 1440;
    const hours = Math.floor(remainingMinsAfterDays / 60);
    const minutes = remainingMinsAfterDays % 60;

    document.getElementById('storeItemCountdownDays').value = days > 0 ? days : '';
    document.getElementById('storeItemCountdownHours').value = hours > 0 ? hours : '';
    document.getElementById('storeItemCountdownMinutes').value = minutes > 0 ? minutes : '';
    document.getElementById('storeItemCountdownSeconds').value = '';
    
    const durationInput = document.getElementById('newItemMultiplierDuration');
    if (item.type === 'tempMultiplier') {
      durationInput.classList.remove('hidden');
      durationInput.value = item.duration || '';
    } else {
      durationInput.classList.add('hidden');
    }

    document.getElementById('addUpdateStoreItemBtn').textContent = 'ÃœRÃœNÃœ GÃœNCELLE';
    editingItemId = itemId;
    
    handleStoreItemTypeChange();
    openAdminStoreModal();
}

// MEVCUT buyItem FONKSÄ°YONUNU SÄ°L VE BUNUNLA DEÄÄ°ÅTÄ°R
async function buyItem(itemId) {
    if (isAdmin) {
        displayMessage("Adminler alÄ±ÅŸveriÅŸ yapamaz.");
        return;
    }
    const userRef = db.ref('users/' + currentUser);
    const itemRef = db.ref('storeItems/' + itemId);
    const [userSnap, itemSnap] = await Promise.all([userRef.once('value'), itemRef.once('value')]);
    const user = userSnap.val();
    const item = itemSnap.val();

    if (!user || !item) return;

    const isPotion = ['health_potion', 'damage_potion', 'defense_potion', 'crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion', 'health_regen_potion'].includes(item.type);

    if (isPotion) {
        if (item.type === 'health_regen_potion') {
            const purchaseCount = user.potionPurchaseCounts?.[itemId] || 0;
            const priceIncrease = item.hasOwnProperty('priceIncrease') ? item.priceIncrease : 1000;
            const currentCost = item.cost + (purchaseCount * priceIncrease);

            if ((user.balance || 0) < currentCost) {
                displayMessage(`Yetersiz Puan! Bu iksirin ÅŸu anki fiyatÄ± ${currentCost} PuandÄ±r.`);
                return;
            }
            let confirmationMessage = `'Can Yenileme Ä°ksiri (%${item.value})' iksirini <b class="text-yellow-400">${currentCost} Puana</b> satÄ±n alarak envanterinize ekleyeceksiniz.`;
            if (priceIncrease > 0) {
                const nextCost = currentCost + priceIncrease;
                confirmationMessage += `<br><br>Bu alÄ±mdan sonra bu iksirin fiyatÄ± sizin iÃ§in <b class="text-yellow-400">${nextCost} Puana</b> yÃ¼kselecektir.`;
            }
            confirmationMessage += `<br><br>OnaylÄ±yor musunuz?`;
            const confirmed = await customConfirm(confirmationMessage);
            if (!confirmed) return;

            const updates = {};
            const newBalance = user.balance - currentCost;
            updates.balance = newBalance;
            updates.totalSpentPoints = (user.totalSpentPoints || 0) + currentCost;
            updates[`potionPurchaseCounts/${itemId}`] = purchaseCount + 1;
            
            const currentPotions = user.inventory?.health_regen_potion?.[item.value] || 0;
            updates[`inventory/health_regen_potion/${item.value}`] = currentPotions + 1;

            await userRef.update(updates);
            
            // â˜…â˜…â˜… DÃœZELTME: Log'a artÄ±k base 'item.cost' yerine, hesaplanan 'currentCost' gÃ¶nderiliyor. â˜…â˜…â˜…
            logActivity('buyItem', currentUser, { 
                itemName: `1 adet %${item.value} Can Yenileme Ä°ksiri`, // Bu zaten doÄŸru formatta
                itemCost: currentCost, 
                itemType: item.type, 
                itemValue: item.value, 
                newBalance: newBalance
            });

        } else { // DiÄŸer (bonus veren) iksirler
            const capCheck = checkPotionCap(user, item.type, item.value);
            if (!capCheck.canAdd) {
                displayMessage(`Bu bonus tÃ¼rÃ¼nde zaten maksimum limite ulaÅŸtÄ±nÄ±z, daha fazla alamazsÄ±nÄ±z.`);
                return;
            }

            const purchaseCount = user.potionPurchaseCounts?.[itemId] || 0;
            const priceIncrease = item.hasOwnProperty('priceIncrease') ? item.priceIncrease : 1000;
            const currentCost = item.cost + (purchaseCount * priceIncrease);
            
            if ((user.balance || 0) < currentCost) {
                displayMessage(`Yetersiz Puan! Bu iksirin ÅŸu anki fiyatÄ± ${currentCost} PuandÄ±r.`);
                return;
            }

            const valueToAdd = capCheck.amount;
            if (valueToAdd <= 0) {
                 displayMessage(`Bu bonus tÃ¼rÃ¼nde zaten maksimum limite ulaÅŸtÄ±nÄ±z, daha fazla alamazsÄ±nÄ±z.`);
                 return;
            }
            
            // â˜…â˜…â˜… DÃœZELTME: Ä°steÄŸine gÃ¶re, belirli iksirler iÃ§in "+" iÅŸaretini kaldÄ±rÄ±yoruz. â˜…â˜…â˜…
            const noPlusPotions = ['defense_potion', 'crit_potion', 'dodge_potion', 'pierce_potion'];
            let formattedValue;
            if (noPlusPotions.includes(item.type)) {
                formattedValue = `%${valueToAdd.toFixed(1)}`; // Sadece %
            } else if (item.type === 'crit_damage_potion') {
                formattedValue = `+%${valueToAdd.toFixed(1)}`; // Eskisi gibi +%
            } else {
                formattedValue = `+${valueToAdd}`; // DiÄŸerleri iÃ§in sadece +
            }
            
            let confirmationMessage = `'${item.name}' iksirini <b class="text-yellow-400">${currentCost} Puana</b> satÄ±n alarak bu bonusa <b class="text-green-400">${formattedValue}</b> ekleyeceksiniz.`;
            if (capCheck.isCapped) {
                confirmationMessage += `<br><br><b class="text-yellow-400">UYARI:</b> Bu alÄ±m ile bu bonus tÃ¼rÃ¼nde maksimum limite ulaÅŸacaksÄ±nÄ±z.`;
            }
            if (priceIncrease > 0) {
                const nextCost = currentCost + priceIncrease;
                confirmationMessage += `<br><br>Bu alÄ±mdan sonra bu iksirin fiyatÄ± sizin iÃ§in <b class="text-yellow-400">${nextCost} Puana</b> yÃ¼kselecektir.`;
            }
            confirmationMessage += `<br><br>OnaylÄ±yor musunuz?`;
            
            const confirmed = await customConfirm(confirmationMessage);
            if (!confirmed) return;
            
            const statKeyMap = { 'health_potion': 'hp', 'damage_potion': 'damage', 'defense_potion': 'defense', 'crit_potion': 'critChance', 'crit_damage_potion': 'critDamage', 'dodge_potion': 'dodgeChance', 'pierce_potion': 'pierceChance' };
            const statKey = statKeyMap[item.type];
            if (!statKey) {
                displayMessage("GeÃ§ersiz iksir tÃ¼rÃ¼, iÅŸlem iptal edildi.");
                return;
            }

            const statRef = db.ref(`users/${currentUser}/globalPotionBuffs/${statKey}`);
            await statRef.transaction(currentValue => (currentValue || 0) + valueToAdd);

            const newBalance = user.balance - currentCost;
            const updates = {
                balance: newBalance,
                totalSpentPoints: (user.totalSpentPoints || 0) + currentCost,
                [`potionPurchaseCounts/${itemId}`]: purchaseCount + 1
            };
            await userRef.update(updates);
            
            // â˜…â˜…â˜… DÃœZELTME: Log'a da artÄ±k doÄŸru formatlanmÄ±ÅŸ metin ve gÃ¼ncel fiyat gÃ¶nderiliyor. â˜…â˜…â˜…
            logActivity('buyItem', currentUser, { 
                itemName: `${formattedValue} ${item.name}`,
                itemCost: currentCost,
                itemType: item.type, 
                itemValue: valueToAdd, 
                newBalance: newBalance
            });
        }
        
        // Ortak Ä°ksir Ä°ÅŸlemleri
        await itemRef.transaction(currentItem => { 
            if (currentItem) { 
                if (currentItem.stock !== undefined && currentItem.stock !== null) { currentItem.stock--; } 
                currentItem.purchaseCount = (currentItem.purchaseCount || 0) + 1; 
            } return currentItem; 
        });
        
        displayMessage(`BaÅŸarÄ±lÄ±! '${item.name}' satÄ±n alÄ±ndÄ± ve bonuslarÄ±n eklendi.`);
        if (currentActiveSection === 'monsterBattle') { renderMonsterBattleUI(); }
        return;
    }

    // Fonksiyonun geri kalanÄ± (iksir olmayan Ã¼rÃ¼nler iÃ§in) aynÄ± kalabilir.
    if (item.type === 'special') {
        const kasaPuani = user.kasaPuani || 0;
        if (kasaPuani < item.cost) {
            displayMessage("Yetersiz Kasa PuanÄ±!");
            return;
        }
        if (item.stock !== undefined && item.stock <= 0) { displayMessage("Bu Ã¼rÃ¼nÃ¼n stoÄŸu tÃ¼kenmiÅŸtir."); return; }
        const confirmed = await customConfirm(`'${item.name}' Ã¼rÃ¼nÃ¼nÃ¼ ${item.cost} Kasa PuanÄ±'na almak istiyor musunuz? Bu puanlar Kasa'nÄ±zdan dÃ¼ÅŸÃ¼lecektir.`);
        if (!confirmed) return;
        const purchaseId = db.ref('pendingSpecialPurchases').push().key;
        await db.ref(`pendingSpecialPurchases/${purchaseId}`).set({ username: currentUser, itemName: item.name, itemCost: item.cost, timestamp: firebase.database.ServerValue.TIMESTAMP });
        await userRef.update({ kasaPuani: kasaPuani - item.cost });
        await db.ref(`purchaseHistory/${purchaseId}`).set({ username: currentUser, itemName: item.name, itemCost: item.cost, imageUrl: item.imageUrl, status: 'pending', purchaseType: 'kasaPuani', timestamp: firebase.database.ServerValue.TIMESTAMP });
        let itemUpdates = {};
        if (item.stock !== undefined && item.stock !== null) { itemUpdates.stock = item.stock - 1; }
        itemUpdates.purchaseCount = (item.purchaseCount || 0) + 1;
        await itemRef.update(itemUpdates);
        logActivity('buyItem', currentUser, { itemName: item.name, itemCost: `${item.cost} KP`, itemType: item.type, newKasaBalance: kasaPuani - item.cost });
        displayMessage(`'${item.name}' talebiniz admine iletildi. OnaylandÄ±ÄŸÄ±nda hesabÄ±nÄ±za eklenecek. Kasa'nÄ±zdan ${item.cost} KP dÃ¼ÅŸÃ¼ldÃ¼.`);
        return;
    }
    
    if ((user.balance || 0) < item.cost) { displayMessage("Yetersiz Puan!"); return; }

    if (item.type === 'tempMultiplier') {
        if (typeof item.value !== 'number' || typeof item.duration !== 'number') {
            displayMessage("MaÄŸaza HatasÄ±: Bu Ã§arpan Ã¼rÃ¼nÃ¼nde eksik bilgi var. LÃ¼tfen yÃ¶netici ile iletiÅŸime geÃ§in.");
            return;
        }
        if (user.multiplierSource && user.multiplierSource !== 'none') {
            if (item.value === user.activeMultiplier) {
                if ((user.balance || 0) < item.cost) { displayMessage("Yetersiz Puan!"); return; }
                const confirmedStack = await customConfirm(`Zaten ${user.activeMultiplier}x Ã§arpanÄ±n var. Bu alÄ±m, mevcut Ã§arpanÄ±na <b>+${item.duration} kullanÄ±m hakkÄ±</b> ekleyecek ve toplamda <b>${(user.multiplierRemainingUses || 0) + item.duration} kullanÄ±m hakkÄ±n</b> olacak. OnaylÄ±yor musun?`);
                if (confirmedStack) {
                    logActivity('multiplierStackedFromStore', currentUser, { cost: item.cost, multiplierValue: item.value, usesAdded: item.duration, oldUses: user.multiplierRemainingUses || 0, newTotalUses: (user.multiplierRemainingUses || 0) + item.duration, newBalance: (user.balance - item.cost) });
                    await userRef.update({ balance: user.balance - item.cost, totalSpentPoints: (user.totalSpentPoints || 0) + item.cost, multiplierRemainingUses: (user.multiplierRemainingUses || 0) + item.duration });
                    await itemRef.transaction(currentItem => { if (currentItem) { if (currentItem.stock !== undefined && currentItem.stock !== null) { currentItem.stock--; } currentItem.purchaseCount = (currentItem.purchaseCount || 0) + 1; } return currentItem; });
                    displayMessage(`BaÅŸarÄ±lÄ±! ${user.activeMultiplier}x Ã§arpanÄ±na +${item.duration} kullanÄ±m hakkÄ± eklendi.`);
                    return;
                } else { return; }
            } else if (item.value > user.activeMultiplier) {
                if ((user.balance || 0) < item.cost) { displayMessage("Yetersiz Puan!"); return; }
                const kutuHakkiDonusum = user.multiplierRemainingUses || 0;
                const confirmedUpgrade = await customConfirm(`Mevcut ${user.activeMultiplier}x Ã§arpanÄ±nÄ± daha yÃ¼ksek olan <b>${item.value}x</b> ile deÄŸiÅŸtirmek Ã¼zeresin. Mevcut Ã§arpanÄ±nÄ±n kalan <b>${user.multiplierRemainingUses} kullanÄ±m hakkÄ±</b>, envanterine <b>+${kutuHakkiDonusum} Kutu HakkÄ±</b> olarak eklenecek. OnaylÄ±yor musun?`);
                if (confirmedUpgrade) {
                    logActivity('multiplierUpgradedFromStore', currentUser, { cost: item.cost, newValue: item.value, newUses: item.duration, oldValue: user.activeMultiplier, oldUses: user.multiplierRemainingUses || 0, boxRights: kutuHakkiDonusum, newBalance: (user.balance - item.cost) });
                    await userRef.update({ balance: user.balance - item.cost, totalSpentPoints: (user.totalSpentPoints || 0) + item.cost, kutuHakki: (user.kutuHakki || 0) + kutuHakkiDonusum, activeMultiplier: item.value, multiplierRemainingUses: item.duration, multiplierSource: 'store' });
                    await itemRef.transaction(currentItem => { if (currentItem) { if (currentItem.stock !== undefined && currentItem.stock !== null) { currentItem.stock--; } currentItem.purchaseCount = (currentItem.purchaseCount || 0) + 1; } return currentItem; });
                    displayMessage(`YÃ¼kseltme baÅŸarÄ±lÄ±! Envanterine +${kutuHakkiDonusum} Kutu HakkÄ± eklendi ve yeni ${item.value}x Ã§arpanÄ±n aktif!`);
                    return;
                } else { return; }
            } else {
                displayMessage(`Mevcut Ã§arpanÄ±n (${user.activeMultiplier}x) zaten bu Ã¼rÃ¼nden (${item.value}x) daha gÃ¼Ã§lÃ¼. Daha dÃ¼ÅŸÃ¼k bir Ã§arpan alamazsÄ±n.`);
                return;
            }
        }
    }
    if (item.type === 'avatar' && user.avatars && user.avatars[itemId]) {
        displayMessage("Bu avatara zaten sahipsin!");
        return;
    }

    const confirmed = await customConfirm(`${item.name} Ã¼rÃ¼nÃ¼nÃ¼ ${item.cost} puana almak istiyor musunuz?`);
    if (confirmed) {
        const itemValue = parseInt(item.value) || 0;

        if (item.type.startsWith('card_pack')) {
            await userRef.update({ balance: user.balance - item.cost, totalSpentPoints: (user.totalSpentPoints || 0) + item.cost });
            await itemRef.transaction(currentItem => { if (currentItem) { if (currentItem.stock !== undefined && currentItem.stock !== null) { currentItem.stock--; } currentItem.purchaseCount = (currentItem.purchaseCount || 0) + 1; } return currentItem; });
            displayMessage(`${item.cost} puan harcandÄ±. Kart paketlerin aÃ§Ä±lÄ±yor...`);
            startCardPackOpening(itemValue || 1, 'MaÄŸaza', 1, item.type);
            return;
        }

        logActivity('buyItem', currentUser, { itemName: item.name, itemCost: item.cost, itemType: item.type, itemValue: item.value || null, itemDuration: item.duration || null, newBalance: user.balance - item.cost });
        let updates = { balance: user.balance - item.cost, totalSpentPoints: (user.totalSpentPoints || 0) + item.cost, storePurchasesCount: (user.storePurchasesCount || 0) + 1 };
        let message = 'SatÄ±n alma baÅŸarÄ±lÄ±!';
        const itemDuration = parseInt(item.duration) || 0;

        if (!updates.inventory) updates.inventory = user.inventory || {};

        if (item.type === 'boxRights') updates.kutuHakki = (user.kutuHakki || 0) + itemValue;
        else if (item.type === 'wheelTicket') updates.carkBileti = (user.carkBileti || 0) + itemValue;
        else if (item.type === 'clickCatchTicket') updates.clickCatchTickets = (user.clickCatchTickets || 0) + itemValue;
        else if (item.type === 'iflasShield') updates.iflasShieldUses = (user.iflasShieldUses || 0) + itemValue;
        else if (item.type === 'revival_stone') updates.inventory.revival_stone = (user.inventory?.revival_stone || 0) + itemValue;
        else if (item.type === 'tempMultiplier') {
            updates.activeMultiplier = itemValue;
            updates.multiplierSource = 'store';
            updates.multiplierRemainingUses = itemDuration;
            updates.activeStoreMultiplierItemId = itemId;
        } 
        else if (item.type === 'wildcard') {
            updates.wildcards = (user.wildcards || 0) + itemValue;
            message = `Tebrikler! MaÄŸazadan ${itemValue} adet Joker Kart satÄ±n aldÄ±n!`;
        } 
        else if (item.type === 'avatar') {
            const newAvatarId = db.ref().push().key;
            updates[`avatars/${itemId}`] = { id: itemId, name: item.name, imageUrl: item.imageUrl };
            message = `'${item.name}' avatarÄ± koleksiyonuna eklendi!`;
        }

        let itemUpdates = {};
        if (item.stock !== undefined && item.stock !== null) itemUpdates.stock = item.stock - 1;
        itemUpdates.purchaseCount = (item.purchaseCount || 0) + 1;
        await itemRef.update(itemUpdates);
        await userRef.update(updates);
        const purchaseId = db.ref('purchaseHistory').push().key;
        db.ref(`purchaseHistory/${purchaseId}`).set({ username: currentUser, itemName: item.name, itemCost: item.cost, imageUrl: item.imageUrl, status: 'completed', timestamp: firebase.database.ServerValue.TIMESTAMP });
        displayMessage(message);
    }
}

// YENÄ° YARDIMCI FONKSÄ°YON
function handleReviveClick(stoneCount) {
    if (stoneCount > 0) {
        useRevivalStone();
    } else {
        displayMessage("Dirilmek iÃ§in Dirilme TaÅŸÄ±n yok! MaÄŸazadan veya diÄŸer etkinliklerden kazanabilirsin.");
    }
}

async function renderMonsterBattleUI() {
    const battleArenaContainer = document.getElementById('battleArenaContainer');
    if (!battleArenaContainer) return;

    const lastChampionPanel = document.getElementById('lastChampionPanel');
    const lastChampionSnap = await db.ref('gameStats/lastMonsterChampion').once('value');
    const lastChampionData = lastChampionSnap.val();

    const monster = monsterBattleData.monsterDetails;
    const leaderboard = monsterBattleData.damageLeaderboard || {};
    const battleArena = document.getElementById('battleArena');
    const defeatedScreen = document.getElementById('monsterDefeatedScreen');
    const monsterInstanceControls = document.getElementById('monsterInstanceAdminControls');

    const attackBtn = document.getElementById('attackMonsterBtn');
    const reviveBtn = document.getElementById('reviveBtn');
    const defeatMessageContainer = document.getElementById('defeatMessageContainer');
    const regenPotionContainer = document.getElementById('regenPotionContainer');
    const revivalStoneContainer = document.getElementById('revivalStoneContainer');

    if (isAdmin) {
        document.getElementById('monsterBattleAdminToggles')?.classList.toggle('hidden', !isAdmin);
    }
    
    if (lastChampionData && monster && monster.currentHP > 0) {
        lastChampionPanel.innerHTML = `
            <h4 class="text-amber-300 text-lg font-bold mb-3">Ã–nceki CanavarÄ±n Åampiyonu</h4>
            <div class="flex items-center justify-center gap-4">
                <img src="${lastChampionData.lockedAvatarUrl}" class="champion-avatar" onclick="openAvatarStatsModal('${lastChampionData.username}')">
                <div>
                    <p class="text-xl font-bold text-white cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${lastChampionData.username}')">${lastChampionData.username}</p>
                    <p class="text-gray-300">Toplam Hasar: <b class="text-yellow-400">${formatNumber(lastChampionData.totalDamage)}</b></p>
                </div>
            </div>
        `;
        lastChampionPanel.classList.remove('hidden');
    } else {
        lastChampionPanel.classList.add('hidden');
    }

    if (!monster || monster.currentHP <= 0) {
        battleArena.style.display = 'none';
        defeatedScreen.classList.remove('hidden');
        const sortedLeaderboard = Object.entries(leaderboard).sort((a, b) => b[1].totalDamage - a[1].totalDamage);
        const winner = sortedLeaderboard.length > 0 ? sortedLeaderboard[0][0] : null;
        const winnerData = winner ? leaderboard[winner] : null;
        const prize = monsterBattleData.rewards?.onKillLeader;
        
        document.getElementById('monsterDefeatedTitle').textContent = `${monster?.name || 'Canavar'} MaÄŸlup Edildi!`;
        
        if (winner && prize && winnerData) {
            const prizeName = typeToName[prize.type] || prize.type;
            const winnerAvatarUrl = winnerData.lockedAvatarUrl || defaultAvatarUrl;
            document.getElementById('monsterDefeatedMessage').innerHTML = `
                <div class="flex flex-col items-center justify-center gap-4">
                    <img src="${winnerAvatarUrl}" class="w-24 h-24 rounded-full border-4 border-yellow-400 object-cover cursor-pointer" onclick="openAvatarStatsModal('${winner}')">
                    <p>En Ã§ok hasarÄ± veren <b class="text-yellow-300 text-xl cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${winner}')">${winner}</b> oldu ve <b class="text-green-400">${formatNumber(prize.value)} ${prizeName}</b> Ã¶dÃ¼lÃ¼nÃ¼ kazandÄ±!</p>
                </div>
                <br>
                <span class="text-gray-400">Adminin yeni bir canavar Ã§aÄŸÄ±rmasÄ± bekleniyor...</span>
            `;
        } else {
            document.getElementById('monsterDefeatedMessage').textContent = 'Adminin yeni bir canavar Ã§aÄŸÄ±rmasÄ± bekleniyor.';
        }
        
        if(monsterInstanceControls) monsterInstanceControls.classList.add('hidden');
        return;
    }

    battleArena.style.display = 'grid';
    defeatedScreen.classList.add('hidden');
    if(monsterInstanceControls) monsterInstanceControls.style.display = isAdmin ? 'flex' : 'none';

    document.getElementById('monsterName').textContent = monster.name;
    document.getElementById('monsterImage').src = monster.imageUrl || 'https://i.hizliresim.com/n01dnz4.png';
    const mHealthPercent = (monster.currentHP / monster.maxHP) * 100;
    document.getElementById('monsterHealthBar').style.width = `${mHealthPercent}%`;
    document.getElementById('monsterHealthBar').textContent = `${Math.ceil(mHealthPercent)}%`;
    document.getElementById('monsterHealthText').textContent = `${formatNumber(monster.currentHP)} / ${formatNumber(monster.maxHP)} Can`;

    const leaderboardEl = document.getElementById('monsterLeaderboard');
    // *** HATA DÃœZELTMESÄ° BURADA: SÄ±ralama Ã§izilmeden Ã¶nce liste temizleniyor ***
    leaderboardEl.innerHTML = '';
    const sortedLeaderboard = Object.entries(leaderboard).sort((a, b) => b[1].totalDamage - a[1].totalDamage);

    if (sortedLeaderboard.length === 0) {
        leaderboardEl.innerHTML = '<p class="text-center text-gray-500">HenÃ¼z kimse canavara saldÄ±rmadÄ±.</p>';
    } else {
        for (const [username, data] of sortedLeaderboard) {
            const userSnap = await db.ref(`users/${username}`).once('value');
            const userData = userSnap.val();
            if (!userData) continue;

            const avatarUrl = data.lockedAvatarUrl || userData.selectedAvatar?.url || defaultAvatarUrl;
            const sanitizedId = sanitizeFirebaseKey(avatarUrl);
            const globalBuffs = userData.globalPotionBuffs || {};
            const baseStats = avatarBaseStats[sanitizedId] || {};
            const userMaxHP = (baseStats.hp || 1000) + (globalBuffs.hp || 0);
            const userCurrentHP = data.currentHP < 0 ? 0 : data.currentHP;
            const userHealthPercent = (userCurrentHP / userMaxHP) * 100;

            const itemHtml = `
                <div class="leaderboard-item" onclick="openPublicUserDetailModal('${username}')">
                    <span class="rank">${leaderboardEl.children.length + 1}.</span>
                    <img src="${avatarUrl}" class="avatar" onclick="event.stopPropagation(); openAvatarStatsModal('${username}')">
                    <div class="flex-grow">
                        <p class="font-bold text-white">${username}</p>
                        <div class="health-bar-container mt-1">
                            <div class="health-bar ${userCurrentHP <= 0 ? 'bg-gray-500' : 'bg-green-500'}" style="width: ${userHealthPercent}%;">
                                ${formatNumber(userCurrentHP)} / ${formatNumber(userMaxHP)}
                            </div>
                        </div>
                    </div>
                    <p class="text-yellow-400 font-bold">${formatNumber(data.totalDamage)} Hasar</p>
                </div>
            `;
            leaderboardEl.innerHTML += itemHtml;
        }
    }

    const playerSnap = await db.ref(`users/${currentUser}`).once('value');
    const playerData = playerSnap.val();
    const playerBattleData = leaderboard[currentUser];

    if (playerData) {
        document.getElementById('playerBattleName').textContent = currentUser;
        
        const playerAvatarUrl = playerBattleData?.lockedAvatarUrl || playerData.selectedAvatar?.url || defaultAvatarUrl;
        const sanitizedPlayerAvatarId = sanitizeFirebaseKey(playerAvatarUrl);
        const globalBuffs = playerData.globalPotionBuffs || {};
        const baseStats = avatarBaseStats[sanitizedPlayerAvatarId] || {};
        const playerMaxHP = (baseStats.hp || 1000) + (globalBuffs.hp || 0);

        let playerCurrentHP = playerBattleData ? playerBattleData.currentHP : playerMaxHP;
        if (playerCurrentHP < 0) playerCurrentHP = 0;

        const playerHealthPercent = (playerCurrentHP / playerMaxHP) * 100;
        const playerHealthBar = document.getElementById('playerHealthBar');
        playerHealthBar.style.width = `${playerHealthPercent}%`;
        
        playerHealthBar.textContent = `${Math.ceil(playerHealthPercent)}%`; 
        playerHealthBar.classList.remove('text-black');
        playerHealthBar.classList.add('text-white');
        document.getElementById('playerHealthText').textContent = `${formatNumber(playerCurrentHP)} / ${formatNumber(playerMaxHP)} Can`;
        
        const playerRevivalStones = playerData.inventory?.revival_stone || 0;
        const regenPotions = playerData.inventory?.health_regen_potion || {};
        const isPlayerDead = playerCurrentHP <= 0;
        
        const hasPotions = Object.values(regenPotions).some(count => count > 0);
        
        let optionsHtml = '';
        if (hasPotions) {
            optionsHtml = '<option value="">Ä°ksir SeÃ§...</option>';
            Object.entries(regenPotions).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).forEach(([percentage, count]) => {
                if (count > 0) optionsHtml += `<option value="${percentage}">Can Ä°ksiri (%${percentage}) x${count}</option>`;
            });
        } else {
            optionsHtml = '<option value="">Can Yenileme Ä°ksiri Yok</option>';
        }
        
        regenPotionContainer.innerHTML = `
            <div class="flex items-center justify-center gap-2">
                <select id="regenPotionSelector" class="box-setting-input flex-grow" onchange="handlePotionSelectionChange()" ${!hasPotions ? 'disabled' : ''}>
                    ${optionsHtml}
                </select>
                <button id="useRegenPotionBtn" onclick="useHealthRegenPotion()" 
                        class="py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm font-bold">
                    Kullan
                </button>
            </div>`;
        
        defeatMessageContainer.classList.remove('hidden'); 
        if (isPlayerDead) {
            defeatMessageContainer.innerHTML = `
                <p class="text-sm text-yellow-300 mb-2">HesabÄ±na kalÄ±cÄ± iksir bonuslarÄ± ekleyerek gÃ¼cÃ¼nÃ¼ artÄ±rabilirsin!</p>
                <p class="text-lg font-bold text-red-500 animate-pulse">MAÄLUP OLDUN!</p>`;
            
            revivalStoneContainer.classList.add('hidden');
            playerHealthBar.classList.add('bg-gray-500');
            playerHealthBar.classList.remove('bg-green-500');
            attackBtn.classList.add('hidden');
            reviveBtn.classList.remove('hidden');
            
            reviveBtn.setAttribute('onclick', `handleReviveClick(${playerRevivalStones})`);
            reviveBtn.textContent = `ğŸ’ Dirilme TaÅŸÄ± Kullan (${playerRevivalStones})`;
            reviveBtn.disabled = false;
            
            if (playerRevivalStones <= 0) {
                 reviveBtn.classList.add('bg-gray-600');
                 reviveBtn.classList.remove('bg-cyan-600', 'hover:bg-cyan-500');
            } else {
                 reviveBtn.classList.remove('bg-gray-600');
                 reviveBtn.classList.add('bg-cyan-600', 'hover:bg-cyan-500');
            }
        } else {
            defeatMessageContainer.innerHTML = `<p class="text-sm text-yellow-300 mb-2">HesabÄ±na kalÄ±cÄ± iksir bonuslarÄ± ekleyerek gÃ¼cÃ¼nÃ¼ artÄ±rabilirsin!</p>`;
            
            revivalStoneContainer.innerHTML = `<p class="text-lg font-bold text-cyan-300">ğŸ’ Dirilme TaÅŸÄ±: ${playerRevivalStones}</p>`;
            revivalStoneContainer.classList.remove('hidden');

            playerHealthBar.classList.add('bg-green-500');
            playerHealthBar.classList.remove('bg-gray-500');
            attackBtn.classList.remove('hidden');
            reviveBtn.classList.add('hidden');
        }
        
        handlePotionSelectionChange();
    }

    const playerRankInfoEl = document.getElementById('playerRankInfo');
    if (playerRankInfoEl) {
        if (playerBattleData) {
            const playerIndex = sortedLeaderboard.findIndex(([username]) => username === currentUser);
            const playerRank = playerIndex !== -1 ? playerIndex + 1 : 'N/A';
            
            playerRankInfoEl.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="border-r border-gray-700">
                        <p class="text-sm text-gray-400">SÄ±ralaman</p>
                        <p class="font-bold text-lg text-white">${playerRank}.</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Toplam HasarÄ±n</p>
                        <p class="font-bold text-lg text-yellow-300">${formatNumber(playerBattleData.totalDamage)}</p>
                    </div>
                </div>
            `;
        } else {
            playerRankInfoEl.innerHTML = '<p class="text-gray-400 col-span-2">SÄ±ralama ve hasar bilgin iÃ§in Ã¶nce canavara saldÄ±rmalÄ±sÄ±n.</p>';
        }
    }
}

      // MEVCUT handlePotionSelectionChange FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR
async function handlePotionSelectionChange() {
    const selector = document.getElementById('regenPotionSelector');
    const useButton = document.getElementById('useRegenPotionBtn');
    if (!selector || !useButton) return;

    const selectedValue = selector.value;

    const battleData = monsterBattleData;
    const playerBattleData = battleData?.damageLeaderboard?.[currentUser];
    const playerCurrentHP = playerBattleData?.currentHP || 0;
    const isPlayerDead = playerCurrentHP <= 0;

    const userSnap = await db.ref(`users/${currentUser}`).once('value');
    const userData = userSnap.val();
    const playerAvatarUrl = playerBattleData?.lockedAvatarUrl || userData.selectedAvatar?.url || defaultAvatarUrl;
    const sanitizedPlayerAvatarId = sanitizeFirebaseKey(playerAvatarUrl);
    const playerMaxHP = (avatarBaseStats[sanitizedPlayerAvatarId]?.hp || 1000) + (userData.globalPotionBuffs?.hp || 0);
    const isPlayerFullHealth = playerCurrentHP >= playerMaxHP;

    const canUse = selectedValue && !isPlayerDead && !isPlayerFullHealth;

    // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K: ArtÄ±k butonu disabled yapmÄ±yoruz, sadece rengini deÄŸiÅŸtiriyoruz â˜…â˜…â˜…
    if (canUse) {
        useButton.classList.remove('bg-gray-600', 'hover:bg-gray-500');
        useButton.classList.add('bg-green-600', 'hover:bg-green-500');
    } else {
        useButton.classList.remove('bg-green-600', 'hover:bg-green-500');
        useButton.classList.add('bg-gray-600', 'hover:bg-gray-500');
    }
}
      
// YENÄ° KODU YAPIÅTIR
function hideAllAdminControls() {
    // Bu fonksiyon, ID'si bilinen tÃ¼m admin elementlerini bulup gizler.
    document.getElementById('boxSettingsButton')?.classList.add('hidden');
    document.getElementById('adminStoreManagementButtonContainer')?.classList.add('hidden');
    document.getElementById('adminAnnouncementControls')?.classList.add('hidden');
    document.getElementById('clickCatchAdminButtonsContainer')?.classList.add('hidden');
    document.getElementById('kasaSettingsBtn')?.classList.add('hidden');
    document.getElementById('collectionAdminBtn')?.classList.add('hidden');
    document.getElementById('monsterBattleAdminToggles')?.classList.add('hidden');
    document.getElementById('monsterAdminControls')?.classList.add('hidden');
    document.getElementById('avatarAdminControls')?.classList.add('hidden');
}

// Kart dÃ¶nÃ¼ÅŸtÃ¼rme onay penceresini aÃ§ar
function openCardConversionModal(cardId, cardName, cardRarity, boxRightsToGain) {
    const modal = document.getElementById('cardConversionModal');
    const infoText = document.getElementById('conversionInfoText');
    const confirmBtn = document.getElementById('confirmConversionBtn');
    
    const rarityNames = { normal: 'Bronz', gumus: 'GÃ¼mÃ¼ÅŸ', altin: 'AltÄ±n', efsanevi: 'Efsanevi' };
    const displayRarity = rarityNames[cardRarity] || cardRarity;

    infoText.innerHTML = `Fazla olan 1 adet <b class="text-white">'${cardName}'</b> (${displayRarity}) kartÄ±nÄ± <b class="text-yellow-300">+${boxRightsToGain} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rmek istediÄŸine emin misin?`;
    
    confirmBtn.onclick = () => convertDuplicateCard(cardId, boxRightsToGain);
    
    modal.style.display = 'flex';
}

// KartÄ± Kutu HakkÄ±na dÃ¶nÃ¼ÅŸtÃ¼rme iÅŸlemini yapar
async function convertDuplicateCard(cardId, boxRightsToGain) {
    if(isTradeInProgress) return;
    isTradeInProgress = true;
    
    const userRef = db.ref(`users/${currentUser}`);

    try {
        const { committed, snapshot } = await userRef.transaction(userData => {
            if (userData && userData.completedCollection === true && userData.cardCollection?.[cardId]?.count > 1) {
                userData.cardCollection[cardId].count--;
                userData.kutuHakki = (userData.kutuHakki || 0) + boxRightsToGain;
                return userData;
            }
            return; // KoÅŸullar saÄŸlanmazsa iÅŸlemi iptal et
        });

        if (committed) {
            displayMessage(`BaÅŸarÄ±lÄ±! KartÄ±n +${boxRightsToGain} Kutu HakkÄ±'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼.`);
            closeCardConversionModal();
            loadCollectionAlbum(); // ArayÃ¼zÃ¼ anÄ±nda gÃ¼ncelle
        } else {
            throw new Error("DÃ¶nÃ¼ÅŸtÃ¼rme iÅŸlemi baÅŸarÄ±sÄ±z oldu. Kart durumu deÄŸiÅŸmiÅŸ veya koleksiyon tamamlanmamÄ±ÅŸ olabilir.");
        }

    } catch (error) {
        displayMessage(error.message);
        closeCardConversionModal();
    } finally {
        isTradeInProgress = false;
    }
}

// YENÄ°: Kart dÃ¶nÃ¼ÅŸtÃ¼rme penceresini kapatÄ±r
function closeCardConversionModal() {
    document.getElementById('cardConversionModal').style.display = 'none';
}

// YENÄ°: KartÄ± Kutu HakkÄ±na dÃ¶nÃ¼ÅŸtÃ¼rme iÅŸlemini yapar
async function convertDuplicateCard(cardId, boxRightsToGain) {
    if(isTradeInProgress) return;
    isTradeInProgress = true;
    
    const userRef = db.ref(`users/${currentUser}`);

    try {
        const { committed, snapshot } = await userRef.transaction(userData => {
            if (userData && userData.completedCollection === true && userData.cardCollection?.[cardId]?.count > 1) {
                userData.cardCollection[cardId].count--;
                userData.kutuHakki = (userData.kutuHakki || 0) + boxRightsToGain;
                return userData;
            }
            return; 
        });

        if (committed) {
            displayMessage(`BaÅŸarÄ±lÄ±! KartÄ±n +${boxRightsToGain} Kutu HakkÄ±'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼.`);
            closeCardConversionModal();
            loadCollectionAlbum();
        } else {
            throw new Error("DÃ¶nÃ¼ÅŸtÃ¼rme iÅŸlemi baÅŸarÄ±sÄ±z oldu. Kart durumu deÄŸiÅŸmiÅŸ olabilir.");
        }

    } catch (error) {
        displayMessage(error.message);
        closeCardConversionModal();
    } finally {
        isTradeInProgress = false;
    }
}

// ModalÄ± aÃ§ar, veritabanÄ±ndan ayarlarÄ± Ã§eker ve satÄ±rlarÄ± oluÅŸturur.
async function openBoxSettingsModal() {
    if (!isAdmin) return;

    const container = document.getElementById('boxSettingsRowsContainer');
    container.innerHTML = ''; // Ã–nceki satÄ±rlarÄ± temizle

    const settingsRef = db.ref('gameConfig/boxContents');
    const snapshot = await settingsRef.once('value');

    // EÄŸer veritabanÄ±nda hiÃ§ ayar yoksa kullanÄ±lacak varsayÄ±lan ayarlar.
    const defaultSettings = [ 
        { type: 'points', value: 100, count: 10 }, 
        { type: 'iflas', value: 0, count: 2 }, 
        { type: 'iflasShield', value: 1, count: 2 },
        { type: 'surpriz', value: 0, count: 1 } 
    ];
    const currentConfig = snapshot.exists() ? snapshot.val() : defaultSettings;

    if (currentConfig && currentConfig.length > 0) {
        currentConfig.forEach(item => addBoxSettingRow(item));
    } else {
        addBoxSettingRow(); // EÄŸer hiÃ§ ayar yoksa boÅŸ bir satÄ±rla baÅŸlat
    }
    
    updateTotalBoxCount(); // Toplam sayÄ±yÄ± ilk aÃ§Ä±lÄ±ÅŸta hesapla
    boxSettingsModal.style.display = 'flex';
}

// ModalÄ± kapatÄ±r.
function closeBoxSettingsModal() {
    boxSettingsModal.style.display = 'none';
}

// Bir satÄ±rda tÃ¼r seÃ§imi deÄŸiÅŸtiÄŸinde "DeÄŸer" input'unu aktif/pasif yapar.
function handleRowTypeChange(selectElement) {
    const row = selectElement.parentElement;
    const valueInput = row.querySelector('.setting-value');
    const selectedType = selectElement.value;

    const typesWithValue = ['points', 'multiplier'];
    const typesWithAutoValue = ['wheelTicket', 'clickCatchTicket', 'iflasShield'];

    if (typesWithValue.includes(selectedType)) {
        valueInput.disabled = false;
        valueInput.placeholder = 'DeÄŸer';
        if(selectedType === 'multiplier') valueInput.placeholder = 'DeÄŸer (2, 3 vb.)';
    } else {
        valueInput.disabled = true;
        valueInput.placeholder = 'N/A';
        if(typesWithAutoValue.includes(selectedType)){
             valueInput.value = 1;
        } else {
             valueInput.value = 0;
        }
    }
}

// "Adet" inputlarÄ±ndan biri her deÄŸiÅŸtiÄŸinde toplam kutu sayÄ±sÄ±nÄ± hesaplar ve gÃ¶sterir.
function updateTotalBoxCount() {
    let total = 0;
    document.querySelectorAll('.box-setting-row .setting-count').forEach(input => {
        const count = parseInt(input.value);
        if (!isNaN(count) && count > 0) {
            total += count;
        }
    });
    document.getElementById('totalBoxCountDisplay').textContent = total;
}

function openHelpModal() {
  helpModal.style.display = 'flex';
}
function closeHelpModal() {
  helpModal.style.display = 'none';
}

    // BU FONKSÄ°YONU SCRIPT BLOÄUNUN Ä°Ã‡Ä°NE EKLE
// BU FONKSÄ°YONU SCRIPT BLOÄUNUN Ä°Ã‡Ä°NE EKLE
function closeModalOnClickOutside(event) {
  // EÄŸer tÄ±klanan elementin ID'si modalÄ±n kendisi ise (yani dÄ±ÅŸtaki karanlÄ±k alan ise)
  if (event.target.id === 'publicUserDetailModal') {
    closePublicUserDetailModal(); // Normal kapatma fonksiyonunu Ã§aÄŸÄ±r
  }
}

async function clearWheelHistory() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("TÃ¼m 'Son Kazananlar' geÃ§miÅŸini kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!");
    if (confirmed) {
        await db.ref('wheelHistory').remove();
        displayMessage("Ã‡ark geÃ§miÅŸi baÅŸarÄ±yla temizlendi.");
    }
}

async function deleteWheelHistoryEntry(entryKey) {
    if (!isAdmin || !entryKey) return;
    const confirmed = await customConfirm("Bu kaydÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?");
    if (confirmed) {
        await db.ref('wheelHistory/' + entryKey).remove();
    }
}

    function updateWheelAppearance() {
     const wheel = document.getElementById('wheel');
     if (!wheel) return;

     const segments = defaultWheelSegments;
     const numSegments = segments.length;
     const degreesPerSegment = 360 / numSegments;

     let conicGradient = 'conic-gradient(';
     wheel.innerHTML = ''; // Ã–nceki yazÄ±larÄ± temizle

     for (let i = 0; i < numSegments; i++) {
         const startAngle = i * degreesPerSegment;
         const endAngle = (i + 1) * degreesPerSegment;
         const color = getSegmentColor(i); // Fonksiyonu basitleÅŸtirdik
         
         // Renk dilimini oluÅŸtur
         conicGradient += `${color} ${startAngle}deg ${endAngle}deg`;
         if (i < numSegments - 1) {
             conicGradient += ', ';
         }

         // YazÄ±larÄ± oluÅŸtur ve yerleÅŸtir
         const segmentTextContainer = document.createElement('div');
         segmentTextContainer.className = 'wheel-segment-text';
         segmentTextContainer.style.transform = `rotate(${startAngle + (degreesPerSegment / 2)}deg)`;
         
         const textSpan = document.createElement('span');
         // HATALI KISIM DÃœZELTÄ°LDÄ°: ArtÄ±k doÄŸrudan doÄŸru segmentin etiketini alÄ±yor
         textSpan.innerText = segments[i].label; 
         
         segmentTextContainer.appendChild(textSpan);
         wheel.appendChild(segmentTextContainer);
     }
     conicGradient += ')';
     wheel.style.background = conicGradient;
 }

function getSegmentColor(index) {
     // Basit bir renk atama mantÄ±ÄŸÄ±
     const colors = ['#f44336', '#4caf50', '#2196f3', '#ffeb3b', '#9c27b0', '#e91e63', '#00bcd4', '#8bc34a', '#ff9800', '#607d8b', '#795548', '#cddc39'];
     // HATALI KISIM DÃœZELTÄ°LDÄ°: ArtÄ±k renkleri sÄ±rayla ve hatasÄ±z alÄ±yor
     return colors[index % colors.length];
 }

updateWheelAppearance();

// ...VE YERÄ°NE BU YENÄ° VERSÄ°YONU YAPIÅTIR
function getIconForWheelLabel(label) {
    const upperLabel = (label || '').toUpperCase();
    
    // Yeni Puan ikonlarÄ±
    if (upperLabel.includes('1000 PUAN')) return 'ğŸ‚';
    if (upperLabel.includes('250 PUAN')) return 'ğŸ';
    if (upperLabel.includes('100 PUAN')) return 'ğŸŒ';
    if (upperLabel.includes('10 PUAN')) return 'ğŸ†';

    // Yeni "Bedava Ã‡evirme" Ã¶dÃ¼lÃ¼
    if (upperLabel.includes('BEDAVA Ã‡EVÄ°R')) return 'ğŸ¡';

    // DiÄŸer sabit Ã¶dÃ¼ller
    if (upperLabel.includes('3 KUTU HAKKI')) return 'ğŸ';
    if (upperLabel.includes('1 KUTU HAKKI')) return 'ğŸ“¦';
    if (upperLabel.includes('TIKLA-YAKALA')) return 'ğŸŸï¸';
    if (upperLabel.includes('5X Ã‡ARPAN')) return 'âœ–ï¸';
    if (upperLabel.includes('SÃœRPRÄ°Z KUTU')) return 'ğŸ‰';
    if (upperLabel.includes('Ä°FLAS KALKANI')) return 'ğŸ›¡ï¸';
    if (upperLabel.includes('PAS')) return 'â˜ ï¸';
    
    return 'ğŸ¡'; // VarsayÄ±lan simge
}

function closeWheelLegendModal() {
    document.getElementById('wheelLegendModal').style.display = 'none';
}

function openWheelLegendModal() {
    document.body.classList.add('modal-open');
    const contentDiv = document.getElementById('wheelLegendContent');
    contentDiv.innerHTML = '';

    const legendData = [
        { icon: 'ğŸ‰', title: 'SÃœRPRÄ°Z KUTU', description: 'En nadir Ã¶dÃ¼l! Ä°Ã§inden Ã§ok yÃ¼ksek puanlar Ã§Ä±kan Ã¶zel bir kart seÃ§me oyunu baÅŸlatÄ±r.' },
        { icon: 'ğŸ†', title: 'EFSANEVÄ° KART PAKETÄ°', description: 'Ã‡ok nadir! Ä°Ã§inden sadece Efsanevi nadirlikte bir koleksiyon kartÄ± Ã§Ä±kar.' },
        { icon: 'ğŸƒ', title: 'JOKER KART', description: 'Ã‡ok nadir! Kart koleksiyonundaki herhangi bir eksik kartÄ± tamamlamanÄ± saÄŸlar.' },
        { icon: 'âœ–ï¸', title: '5X Ã‡ARPAN', description: 'Ã‡ok nadir! Bir sonraki kutu aÃ§Ä±lÄ±ÅŸÄ±nda kazanacaÄŸÄ±n puanÄ± veya eÅŸyayÄ± 5\'e katlar.' }, // EKLENEN BLOK
        { icon: 'ğŸ‚', title: '1000 PUAN', description: 'Nadir bulunan, yÃ¼ksek miktarda bir puan Ã¶dÃ¼lÃ¼dÃ¼r.' },
        { icon: 'ğŸ¥‡', title: 'ALTIN KART PAKETÄ°', description: 'Ä°Ã§inden sadece AltÄ±n nadirlikte bir koleksiyon kartÄ± Ã§Ä±kar.' },
        { icon: 'ğŸ', title: '3 KUTU HAKKI', description: 'DeÄŸerli bir Ã¶dÃ¼l! Kutu oyununda kullanmak Ã¼zere tam 3 adet aÃ§ma hakkÄ± verir.' },
        { icon: 'ğŸ¥ˆ', title: 'GÃœMÃœÅ KART PAKETÄ°', description: 'Ä°Ã§inden sadece GÃ¼mÃ¼ÅŸ nadirlikte bir koleksiyon kartÄ± Ã§Ä±kar.' },
        { icon: 'ğŸ', title: '250 PUAN', description: 'HesabÄ±na anÄ±nda 250 Puan eklenir.' },
        { icon: 'ğŸ›¡ï¸', title: 'Ä°FLAS KALKANI', description: 'Kutu oyununda "Bomba" bulursan puanlarÄ±nÄ± bir defaya mahsus korur.' },
        { icon: 'ğŸŸï¸', title: '+1 T-Y BÄ°LETÄ°', description: 'TÄ±kla-Yakala mini oyununa bir giriÅŸ hakkÄ± kazandÄ±rÄ±r.' },
        { icon: 'ğŸ¡', title: 'BEDAVA Ã‡EVÄ°RME', description: 'ÅansÄ±nÄ± tekrar denemen iÃ§in +1 Ã‡ark Bileti kazandÄ±rÄ±r.' },
        { icon: 'ğŸ“¦', title: '+1 KUTU HAKKI', description: 'Kutu oyununda kullanmak Ã¼zere bir adet kutu aÃ§ma hakkÄ± kazandÄ±rÄ±r.' },
        { icon: 'ğŸ´', title: 'STANDART KART PAKETÄ°', description: 'Ä°Ã§inden herhangi bir nadirlikte rastgele bir kart Ã§Ä±kar.' },
        { icon: 'ğŸ¥‰', title: 'BRONZ KART PAKETÄ°', description: 'Ä°Ã§inden sadece Normal nadirlikte bir koleksiyon kartÄ± Ã§Ä±kar.' },
        { icon: 'ğŸŒ', title: '100 PUAN', description: 'SÄ±kÃ§a gelen, gÃ¼zel bir puan Ã¶dÃ¼lÃ¼dÃ¼r.' },
        { icon: 'ğŸ†', title: '10 PUAN', description: 'En kÃ¼Ã§Ã¼k teselli puanÄ± Ã¶dÃ¼lÃ¼dÃ¼r.' },
        { icon: 'â˜ ï¸', title: 'PAS', description: 'ÅanssÄ±zlÄ±k! Bu dilimde herhangi bir Ã¶dÃ¼l yoktur.' }
    ];

    legendData.forEach(item => {
        const itemHtml = `
            <div class="flex items-start gap-4 p-3 bg-gray-900 rounded-lg text-left">
                <span class="text-3xl w-8 text-center mt-1">${item.icon}</span>
                <div class="flex-1">
                    <strong class="text-yellow-200 block">${item.title}</strong>
                    <p class="text-gray-400 text-sm">${item.description}</p>
                </div>
            </div>
        `;
        contentDiv.innerHTML += itemHtml;
    });
    
    document.getElementById('wheelLegendModal').style.display = 'flex';
}

function closeWheelLegendModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('wheelLegendModal').style.display = 'none';
}

    function listenForLastGameSummary() {
    const ref = db.ref('clickCatchLobbyLastGameSummary');
    const container = document.getElementById('lastWinnerContainer');
    const titleEl = document.getElementById('lastWinnerInfo');
    const detailsListEl = document.getElementById('lastGameDetailsList');

    const callback = snap => {
        const summaryData = snap.val();

        // EÄER VERÄ° VARSA VE KAZANAN BELLÄ° Ä°SE BÄ°LGÄ°LERÄ° GÃ–STER
        if (summaryData && summaryData.winner) {
            
            // 1. Oyun SÃ¼resini Hesapla
            let durationText = '';
            if (summaryData.startTimestamp && summaryData.endTimestamp) {
                const durationMs = summaryData.endTimestamp - summaryData.startTimestamp;
                const seconds = Math.floor(durationMs / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                durationText = ` (SÃ¼re: ${minutes}dk ${remainingSeconds}sn)`;
            }

            // 2. Ana BaÅŸlÄ±ÄŸÄ± GÃ¼ncelle (Admin iÃ§in silme butonuyla birlikte)
            let deleteButton = '';
            if (isAdmin) {
                deleteButton = `
                    <button onclick="clearLastWinner()" class="ml-2 text-gray-500 hover:text-red-500 transition-colors" title="Son KazananÄ± Sil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                `;
            }
            titleEl.innerHTML = `ğŸ† Son Lobi Galibi: <b class="text-white">${summaryData.winner}</b> (+${summaryData.prize} Puan)${durationText}${deleteButton}`;

            // 3. Oyuncu Listesini OluÅŸtur ve SÄ±rala
            const players = summaryData.players || {};
            const sortedPlayers = Object.entries(players).sort(([, a], [, b]) => b.score - a.score);
            
            let detailsHtml = '';
            sortedPlayers.forEach(([username, data], index) => {
                const isWinner = username === summaryData.winner;
                const rowClass = isWinner ? 'bg-green-800/50 border-green-500' : 'bg-gray-800/50 border-gray-700';
                const rankIcon = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : `${index + 1}.`));
                
                detailsHtml += `
                    <div class="flex justify-between items-center p-2 rounded border ${rowClass}">
                        <span class="font-bold">${rankIcon} ${username}</span>
                        <span class="text-gray-300">Skor: <b class="text-white">${data.score} / ${summaryData.target}</b></span>
                    </div>
                `;
            });
            
            detailsListEl.innerHTML = detailsHtml;
            container.classList.remove('hidden'); // Paneli gÃ¶rÃ¼nÃ¼r yap

        } else {
            // SORUNU Ã‡Ã–ZEN KISIM: EÄER VERÄ° SÄ°LÄ°NMÄ°ÅSE (NULL Ä°SE) PANELÄ° GÄ°ZLE
            container.classList.add('hidden');
        }
    };
    
    // Listener'Ä± tekrar tekrar eklememek iÃ§in kontrol
    if (activeListeners.lobbySummary) {
        activeListeners.lobbySummary.ref.off('value', activeListeners.lobbySummary.callback);
    }
    activeListeners.lobbySummary = { ref, event: 'value', callback };
    ref.on('value', callback);
}

    // YENÄ° EKLENECEK KOD BAÅLANGICI
  // GÃ¼nlÃ¼k Ã–dÃ¼l modalÄ±ndaki "Ã–dÃ¼l Tipi" dropdown'Ä±nÄ± dinler.
  document.getElementById('dailyRewardType').addEventListener('change', function() {
      const usesInput = document.getElementById('dailyRewardMultiplierUses');
      // EÄŸer seÃ§ilen tip "Ã‡arpan" (tempMultiplier) ise, KullanÄ±m HakkÄ± alanÄ±nÄ± gÃ¶ster.
      if (this.value === 'tempMultiplier') {
          usesInput.classList.remove('hidden');
      } else {
      // DeÄŸilse, KullanÄ±m HakkÄ± alanÄ±nÄ± gizle.
          usesInput.classList.add('hidden');
      }
  });

    function openClickCatchInfoModal() {
    document.body.classList.add('modal-open');
    document.getElementById('clickCatchInfoModal').style.display = 'flex';
}

function closeClickCatchInfoModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('clickCatchInfoModal').style.display = 'none';
}

    // YENÄ° EKLENECEK GERÄ° SAYIM FONKSÄ°YONU
let seasonCountdownInterval = null;

function listenForSeasonCountdown() {
    const countdownContainer = document.getElementById('seasonCountdownContainer');
    const countdownEl = document.getElementById('seasonCountdown');
    const countdownContainerCards = document.getElementById('seasonCountdownContainer_cards'); // Kartlar iÃ§in yeni container
    const countdownElCards = document.getElementById('seasonCountdown_cards'); // Kartlar iÃ§in yeni sayaÃ§
    const ref = db.ref('gameConfig/seasonEndDate');

    const callback = snap => {
        if (seasonCountdownInterval) {
            clearInterval(seasonCountdownInterval);
        }

        const endDateTimestamp = snap.val();

        if (!endDateTimestamp || endDateTimestamp < getSyncedTime()) {
            countdownContainer.classList.add('hidden');
            if (countdownContainerCards) countdownContainerCards.classList.add('hidden');
            return;
        }

        countdownContainer.classList.remove('hidden');
        if (countdownContainerCards) countdownContainerCards.classList.remove('hidden');

        const updateTimer = () => {
            const now = getSyncedTime();
            const timeLeft = endDateTimestamp - now;

            if (timeLeft <= 0) {
                countdownEl.textContent = "SEZON BÄ°TTÄ°!";
                if (countdownElCards) countdownElCards.textContent = "SEZON BÄ°TTÄ°!";
                clearInterval(seasonCountdownInterval);
                
                executeSeasonReset();
                
                return;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            const timeString = `${days} GÃ¼n ${hours} Saat ${minutes} Dakika ${seconds} Saniye`;
            countdownEl.textContent = timeString;
            if (countdownElCards) countdownElCards.textContent = timeString;
        };

        updateTimer();
        seasonCountdownInterval = setInterval(updateTimer, 1000);
    };

    if (activeListeners.seasonCountdown) {
        activeListeners.seasonCountdown.ref.off('value', activeListeners.seasonCountdown.callback);
    }
    activeListeners.seasonCountdown = { ref, event: 'value', callback };
    ref.on('value', callback);
}

   async function openSeasonManagementModal() {
    document.body.classList.add('modal-open');
    // KayÄ±tlÄ± ayarlarÄ± Ã§ek ve inputlarÄ± doldur
    const settingsSnap = await db.ref('gameConfig/seasonSettings').once('value');
    if (settingsSnap.exists()) {
        const settings = settingsSnap.val();
        if (settings.endDate) {
            const date = new Date(settings.endDate);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            // DEÄÄ°ÅEN SATIR: ArtÄ±k doÄŸru ve benzersiz ID'ye sahip input'u hedefliyoruz.
            document.getElementById('seasonManagementEndDateInput').value = date.toISOString().slice(0, 16);
        }
        document.getElementById('puanLeaderAvatarUrl').value = settings.rewards?.puanLeaderAvatarUrl || '';
        document.getElementById('rozetLeaderAvatarUrl').value = settings.rewards?.rozetLeaderAvatarUrl || '';
    }
    document.getElementById('seasonManagementModal').style.display = 'flex';
}

function closeSeasonManagementModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('seasonManagementModal').style.display = 'none';
}

// --- ESKÄ° saveAutomaticResetSettings FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR ---

async function saveAutomaticResetSettings() {
    if (!isAdmin) return;

    const dateInput = document.getElementById('seasonManagementEndDateInput').value;
    const puanAvatarUrl = document.getElementById('puanLeaderAvatarUrl').value.trim();
    const rozetAvatarUrl = document.getElementById('rozetLeaderAvatarUrl').value.trim();

    // --- YENÄ° EKLENEN KOD BAÅLANGICI ---
    // Hediye paketi input'larÄ±ndaki deÄŸerleri oku. DeÄŸer girilmemiÅŸse 0 kabul et.
    const giftPackage = {
        kutuHakki: parseInt(document.getElementById('rewardBoxRights').value) || 0,
        carkBileti: parseInt(document.getElementById('rewardWheelTickets').value) || 0,
        clickCatchTickets: parseInt(document.getElementById('rewardClickCatchTickets').value) || 0,
        iflasShieldUses: parseInt(document.getElementById('rewardIflasShields').value) || 0
    };
    // --- YENÄ° EKLENEN KOD SONU ---

    if (!dateInput) {
        displayMessage("LÃ¼tfen geÃ§erli bir sezon bitiÅŸ tarihi seÃ§in.");
        return;
    }
    
    const settings = {
        endDate: new Date(dateInput).getTime(),
        status: 'active',
        rewards: {
            puanLeaderAvatarUrl: puanAvatarUrl,
            rozetLeaderAvatarUrl: rozetAvatarUrl,
            general: giftPackage // OkuduÄŸumuz hediye paketini ayarlara ekle
        }
    };
    
    await db.ref('gameConfig/seasonSettings').set(settings);
    await db.ref('gameConfig/seasonEndDate').set(settings.endDate);
    
    displayMessage("Otomatik sezon sonu ayarlarÄ± kaydedildi. Geri sayÄ±m baÅŸlayacak.");
    closeSeasonManagementModal();
}

// MEVCUT executeSeasonReset FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
async function executeSeasonReset(isManual = false) {
    if (!isAdmin) {
        const resetStatus = await db.ref('gameConfig/seasonResetStatus').once('value');
        if (resetStatus.val() === 'in_progress' || resetStatus.val() === 'completed') {
            console.log("Sezon sÄ±fÄ±rlama zaten baÅŸka bir tarayÄ±cÄ± tarafÄ±ndan baÅŸlatÄ±lmÄ±ÅŸ veya tamamlanmÄ±ÅŸ.");
            return;
        }
        await db.ref('gameConfig/seasonResetStatus').set('in_progress');
    }
    
    const confirmationText = isManual 
        ? "Sezonu ÅÄ°MDÄ° MANUEL olarak bitirmek Ã¼zeresiniz. TÃ¼m puanlar, istatistikler ve KART KOLEKSÄ°YONU sÄ±fÄ±rlanacak, Ã¶dÃ¼ller daÄŸÄ±tÄ±lacak. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?"
        : "Sezon sonu iÃ§in SON ONAY. SÄ±fÄ±rlama iÅŸlemi baÅŸlayacak ve geri alÄ±namayacak. OnaylÄ±yor musunuz?";

    if (isManual) {
        const confirmed = await customConfirm(confirmationText);
        if (!confirmed) return;
    }

    displayMessage("Sezon sonu iÅŸlemleri baÅŸlatÄ±ldÄ±... Bu iÅŸlem birkaÃ§ saniye sÃ¼rebilir. LÃ¼tfen bekleyin.");

    const allUsersSnap = await db.ref('users').once('value');
    const allUsersData = allUsersSnap.val();
    const leaders = await calculateAllLeaders(allUsersData);
    const settingsSnap = await db.ref('gameConfig/seasonSettings').once('value');
    const seasonSettings = settingsSnap.val();
    
    const puanLeader = leaders.highEverBalanceUser; 
    const rozetLeaderData = await getTopBadgeHolder(allUsersData, leaders); // â˜…â˜…â˜… YENÄ°: Hem ismi hem rozet sayÄ±sÄ±nÄ± al
    const rozetLeader = rozetLeaderData.username;
    
    const puanAvatar = seasonSettings?.rewards?.puanLeaderAvatarUrl;
    const rozetAvatar = seasonSettings?.rewards?.rozetLeaderAvatarUrl;
    const giftPackage = seasonSettings?.rewards?.general || {
        kutuHakki: 0, carkBileti: 0, clickCatchTickets: 0, iflasShieldUses: 0
    };

    const updates = {};
    updates['/gameConfig/collectionWinner'] = null;
    updates['/gameConfig/collectionGrandPrize'] = null;
    updates['/gameConfig/cardCollectionStatus'] = 'inactive';

    for (const username in allUsersData) {
        if (username.toLowerCase() === 'weizendtv' || !allUsersData[username].approved) continue;
        
        const userPath = `users/${username}`;
        const userData = allUsersData[username];

        updates[`${userPath}/kutuHakki`] = (userData.kutuHakki || 0) + giftPackage.kutuHakki;
        updates[`${userPath}/carkBileti`] = (userData.carkBileti || 0) + giftPackage.carkBileti;
        updates[`${userPath}/clickCatchTickets`] = (userData.clickCatchTickets || 0) + giftPackage.clickCatchTickets;
        updates[`${userPath}/iflasShieldUses`] = (userData.iflasShieldUses || 0) + giftPackage.iflasShieldUses;
        
        // â˜…â˜…â˜… DEÄÄ°ÅEN KISIM BAÅLANGICI: DetaylÄ± baÅŸarÄ±m verisi kaydediliyor â˜…â˜…â˜…
        if (username === puanLeader) {
            if(puanAvatar) {
                const newAvatarId = `sezon_odul_puan_${Date.now()}`;
                updates[`${userPath}/selectedAvatar`] = { id: newAvatarId, url: puanAvatar };
                updates[`${userPath}/avatars/${newAvatarId}`] = { id: newAvatarId, name: 'Puan Åampiyonu AvatarÄ±', imageUrl: puanAvatar };
            }
            const puanChampionships = userData.puanChampionships || [];
            puanChampionships.push({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                score: leaders.highestEverBalance // KazandÄ±ÄŸÄ± anki kariyer puanÄ±
            });
            updates[`${userPath}/puanChampionships`] = puanChampionships;
        }
        if (username === rozetLeader) {
            if(rozetAvatar) {
                const newAvatarId = `sezon_odul_rozet_${Date.now()}`;
                updates[`${userPath}/selectedAvatar`] = { id: newAvatarId, url: rozetAvatar };
                updates[`${userPath}/avatars/${newAvatarId}`] = { id: newAvatarId, name: 'Rozet Åampiyonu AvatarÄ±', imageUrl: rozetAvatar };
            }
            const rozetChampionships = userData.rozetChampionships || [];
            rozetChampionships.push({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                badgeCount: rozetLeaderData.badgeCount // KazandÄ±ÄŸÄ± anki rozet sayÄ±sÄ±
            });
            updates[`${userPath}/rozetChampionships`] = rozetChampionships;
        }
        // â˜…â˜…â˜… DEÄÄ°ÅEN KISIM SONU â˜…â˜…â˜…
        
        updates[`${userPath}/balance`] = 0;
        updates[`${userPath}/kariyerPuani`] = 0;
        updates[`${userPath}/totalSpentPoints`] = 0;
        updates[`${userPath}/boxesOpenedCount`] = 0;
        updates[`${userPath}/surpriseBoxesOpened`] = 0;
        updates[`${userPath}/iflasCount`] = 0;
        updates[`${userPath}/multiplierFoundCount`] = 0;
        updates[`${userPath}/iflasShieldUsedCount`] = 0;
        updates[`${userPath}/wheelSpinsCount`] = 0;
        updates[`${userPath}/clickCatchHighestScore`] = 0;
        updates[`${userPath}/cardCollection`] = null;
        updates[`${userPath}/completedCollection`] = null;
        // Eski sayaÃ§larÄ± da sÄ±fÄ±rla (isteÄŸe baÄŸlÄ± ama tutarlÄ±lÄ±k iÃ§in iyi)
        updates[`${userPath}/puanChampionshipsWon`] = null;
        updates[`${userPath}/rozetChampionshipsWon`] = null;
    }
    
    updates['purchaseHistory'] = null;
    updates['clickCatchWeeklyScores'] = null;
    updates['gameStats'] = null;

    const storeItemsSnap = await db.ref('storeItems').once('value');
    if (storeItemsSnap.exists()) {
        storeItemsSnap.forEach(itemSnap => {
            updates[`storeItems/${itemSnap.key}/purchaseCount`] = 0;
        });
    }

    const seasonName = new Date().toLocaleString('tr-TR', { month: 'long', year: 'numeric' }) + " Sezonu";
    updates[`seasonAnnouncements/${Date.now()}`] = {
        title: `${seasonName} Sona Erdi!`,
        message: `ğŸ† Kariyer Puan Lideri: <b>${puanLeader}</b><br>ğŸ‘‘ Rozet Lideri: <b>${rozetLeader}</b><br><br>Åampiyonlar Ã¶zel avatarlarÄ±nÄ± kazandÄ±! TÃ¼m katÄ±lÄ±mcÄ±lara ise hediye paketleri gÃ¶nderildi! Yeni sezon baÅŸladÄ±, herkese bol ÅŸans!`,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    await db.ref().update(updates);
    await createBoxes();
    
    await db.ref('gameConfig/seasonSettings').remove();
    await db.ref('gameConfig/seasonEndDate').remove();
    
    if (isAdmin) {
        await db.ref('gameConfig/seasonResetStatus').remove();
    } else {
        await db.ref('gameConfig/seasonResetStatus').set('completed');
    }

    displayMessage("SEZON BAÅARIYLA SIFIRLANDI! Ã–dÃ¼ller daÄŸÄ±tÄ±ldÄ± ve yeni sezon baÅŸladÄ±.");
    if (isManual) closeSeasonManagementModal();
}

async function stopSeasonCountdown() {
    if (!isAdmin) return; // Sadece adminin kullanabildiÄŸinden emin ol.

    const confirmed = await customConfirm("Mevcut otomatik sezon sonu geri sayÄ±mÄ±nÄ± durdurmak ve ayarlarÄ± silmek istediÄŸinizden emin misiniz?");
    if (!confirmed) return; // KullanÄ±cÄ± "HayÄ±r" derse iÅŸlemi iptal et.

    try {
        // Geri sayÄ±mÄ± ve ayarlarÄ± kontrol eden veritabanÄ± yollarÄ±nÄ± sil.
        await db.ref('gameConfig/seasonEndDate').remove();
        await db.ref('gameConfig/seasonSettings').remove();

        displayMessage("Otomatik aylÄ±k sezon sÄ±fÄ±rlama baÅŸarÄ±yla iptal edildi. Geri sayÄ±m durduruldu.");
        closeSeasonManagementModal(); // Ä°ÅŸlem bittikten sonra pencereyi kapat.

    } catch (error) {
        console.error("Sezon sayacÄ± durdurulurken hata:", error);
        displayMessage("Geri sayÄ±m iptal edilirken bir hata oluÅŸtu. LÃ¼tfen konsolu kontrol edin.");
    }
}

// --- YENÄ° EKLENECEK FONKSÄ°YON SONU ---

// Oyuncular iÃ§in kalÄ±cÄ± duyuru sistemini dinler
let currentPersistentAnnId = null;
function listenForPersistentAnnouncement() {
    const ref = db.ref('seasonAnnouncements').orderByChild('timestamp').limitToLast(1);
    
    const callback = async (snap) => {
        if (!snap.exists()) return;
        
        currentPersistentAnnId = Object.keys(snap.val())[0];
        const ann = snap.val()[currentPersistentAnnId];

        const userSeenRef = db.ref(`users/${currentUser}/seenAnnouncements/${currentPersistentAnnId}`);
        const userSeenSnap = await userSeenRef.once('value');

        if (!userSeenSnap.exists()) {
            document.getElementById('persistentAnnTitle').textContent = ann.title;
            document.getElementById('persistentAnnMessage').innerHTML = ann.message;
            document.getElementById('persistentAnnouncementModal').style.display = 'flex';
        }
    };
    
    if (activeListeners.persistentAnn) {
        activeListeners.persistentAnn.ref.off('value', activeListeners.persistentAnn.callback);
    }
    activeListeners.persistentAnn = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// Oyuncu duyuruyu kapattÄ±ÄŸÄ±nda iÅŸaretler
async function markPersistentAnnouncementAsSeen() {
    if (currentPersistentAnnId) {
        await db.ref(`users/${currentUser}/seenAnnouncements/${currentPersistentAnnId}`).set(true);
    }
    document.getElementById('persistentAnnouncementModal').style.display = 'none';
    document.body.classList.remove('modal-open');
}

// Rozet liderini bulan yardÄ±mcÄ± fonksiyon
async function getTopBadgeHolder(allUsersData, leaders) {
    let topUser = { username: null, badgeCount: -1 };
    
    for (const username in allUsersData) {
        if (username.toLowerCase() === 'weizendtv' || !allUsersData[username].approved) continue;

        let count = 0;
        if (username === leaders.currentBalanceUser) count++;
        if (username === leaders.highEverBalanceUser) count++;
        if (username === leaders.surpriseBoxUser) count++;
        if (username === leaders.bombUser) count++;
        if (username === leaders.spentPointsUser) count++;
        if (username === leaders.multiplierUser) count++;
        if (username === leaders.boxUser) count++;
        if (username === leaders.shieldUser) count++;
        if (username === leaders.clickCatchLeaderUser) count++;
        if (username === leaders.wheelSpinUser) count++;
        
        if (count > topUser.badgeCount) {
            topUser = { username: username, badgeCount: count };
        }
    }
    return topUser;
}

    // MEVCUT openSeasonInfoModal FONKSÄ°YONUNU SÄ°LÄ°P BUNUNLA DEÄÄ°ÅTÄ°RÄ°N

async function openSeasonInfoModal() {
    document.body.classList.add('modal-open');
    const giftDetailsContainer = document.getElementById('seasonGiftPackageDetails');
    const championPrizesContainer = document.getElementById('seasonChampionPrizes');
    
    giftDetailsContainer.innerHTML = '<p class="text-gray-400">Genel Ã¶dÃ¼l paketi yÃ¼kleniyor...</p>';
    championPrizesContainer.innerHTML = '<p class="text-gray-400">Åampiyon Ã¶dÃ¼lleri yÃ¼kleniyor...</p>';

    try {
        const settingsSnap = await db.ref('gameConfig/seasonSettings/rewards').once('value');
        
        // Genel Hediye Paketi KÄ±smÄ±
        let rewardsHtml = '<strong class="text-yellow-200 block mb-2">TÃ¼m KatÄ±lÄ±mcÄ±lar Ä°Ã§in Hediye Paketi:</strong><ul class="list-disc list-inside space-y-1 text-gray-300">';
        let hasRewards = false;
        
        const generalRewards = settingsSnap.exists() ? settingsSnap.val().general : null;
        if (generalRewards) {
            if (generalRewards.kutuHakki > 0) { rewardsHtml += `<li>ğŸ ${generalRewards.kutuHakki} Adet Kutu HakkÄ±</li>`; hasRewards = true; }
            if (generalRewards.carkBileti > 0) { rewardsHtml += `<li>ğŸ¡ ${generalRewards.carkBileti} Adet Ã‡ark Bileti</li>`; hasRewards = true; }
            if (generalRewards.clickCatchTickets > 0) { rewardsHtml += `<li>ğŸ¯ ${generalRewards.clickCatchTickets} Adet TÄ±kla-Yakala Bileti</li>`; hasRewards = true; }
            if (generalRewards.iflasShieldUses > 0) { rewardsHtml += `<li>ğŸ›¡ï¸ ${generalRewards.iflasShieldUses} Adet Ä°flas KalkanÄ±</li>`; hasRewards = true; }
        }
        if (!hasRewards) {
            rewardsHtml += '<li>Bu sezon iÃ§in henÃ¼z genel bir Ã¶dÃ¼l paketi belirlenmedi.</li>';
        }
        rewardsHtml += '</ul>';
        giftDetailsContainer.innerHTML = rewardsHtml;

        // Åampiyon Ã–dÃ¼lleri KÄ±smÄ±
        let championPrizesHtml = '<strong class="text-yellow-300 block mb-2">SÄ±ralama Liderleri Ä°Ã§in Ã–zel Ã–dÃ¼ller:</strong><ul class="list-disc list-inside space-y-1 text-gray-300">';
        let hasChampionPrizes = false;

        const championRewards = settingsSnap.val();
        if (championRewards) {
            if (championRewards.puanLeaderAvatarUrl) {
                // --- DEÄÄ°ÅEN SATIR: Profile iÅŸleneceÄŸi bilgisi eklendi ---
                championPrizesHtml += `<li>ğŸ† Kariyer Puan SÄ±ralamasÄ± 1.'si <b class="text-white">Ã–zel Åampiyon AvatarÄ±</b> kazanacak ve bu baÅŸarÄ± profiline kalÄ±cÄ± olarak iÅŸlenecektir.</li>`;
                hasChampionPrizes = true;
            }
            if (championRewards.rozetLeaderAvatarUrl) {
                // --- DEÄÄ°ÅEN SATIR: Profile iÅŸleneceÄŸi bilgisi eklendi ---
                championPrizesHtml += `<li>ğŸ‘‘ Liderler SÄ±ralamasÄ± 1.'si <b class="text-white">Ã–zel Åampiyon AvatarÄ±</b> kazanacak ve bu baÅŸarÄ± profiline kalÄ±cÄ± olarak iÅŸlenecektir.</li>`;
                hasChampionPrizes = true;
            }
        }

        if (!hasChampionPrizes) {
            championPrizesHtml += '<li>Bu sezon iÃ§in henÃ¼z Ã¶zel bir ÅŸampiyon Ã¶dÃ¼lÃ¼ belirlenmedi.</li>';
        }
        championPrizesHtml += '</ul>';
        championPrizesContainer.innerHTML = championPrizesHtml;

    } catch (error) {
        console.error("Sezon Ã¶dÃ¼lleri alÄ±nÄ±rken hata:", error);
        giftDetailsContainer.innerHTML = '<p class="text-red-500">Genel Ã¶dÃ¼l bilgileri yÃ¼klenemedi.</p>';
        championPrizesContainer.innerHTML = '<p class="text-red-500">Åampiyon Ã¶dÃ¼l bilgileri yÃ¼klenemedi.</p>';
    }

    document.getElementById('seasonInfoModal').style.display = 'flex';
}

function closeSeasonInfoModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('seasonInfoModal').style.display = 'none';
}

// YENÄ° VE DÃœZELTÄ°LMÄ°Å FONKSÄ°YONU BU ÅEKÄ°LDE YAPIÅTIR
async function openWeeklyResetInfoModal() {
    document.body.classList.add('modal-open');
    const detailsContainer = document.getElementById('weeklyWinnerPrizeDetails');
    detailsContainer.innerHTML = '<p class="text-gray-400">Åampiyon Ã¶dÃ¼lÃ¼ yÃ¼kleniyor...</p>';

    try {
        const settingsSnap = await db.ref('gameConfig/weeklyClickCatchReset/prize').once('value');
        let prizeHtml = '';

        if (settingsSnap.exists()) {
            const prize = settingsSnap.val();
            let prizeText = '';

            // Ã‡arpan tÃ¼rÃ¼ndeki Ã¶dÃ¼ller iÃ§in Ã¶zel bir metin oluÅŸturuyoruz
            if (prize.type === 'tempMultiplier') {
                prizeText = `${prize.amount}x Ã‡arpan (${prize.uses} kullanÄ±m)`;
            } 
            // DiÄŸer tÃ¼m Ã¶dÃ¼l tÃ¼rleri iÃ§in genel metin
            else {
                // typeToName haritasÄ±nÄ± kullanarak daha tutarlÄ± isimler alÄ±yoruz
                const prizeName = typeToName[prize.type] || prize.type;
                prizeText = `${prize.amount} ${prizeName}`;
            }
            
            prizeHtml = `<strong>ğŸ† Åampiyon Ã–dÃ¼lÃ¼:</strong> <span class="text-white font-bold">${prizeText}</span>`;

        } else {
            prizeHtml = '<strong>ğŸ† Åampiyon Ã–dÃ¼lÃ¼:</strong> <span class="text-gray-400">HenÃ¼z admin tarafÄ±ndan belirlenmedi.</span>';
        }
        detailsContainer.innerHTML = prizeHtml;

    } catch (error) {
        console.error("HaftalÄ±k Ã¶dÃ¼l bilgisi alÄ±nÄ±rken hata:", error);
        detailsContainer.innerHTML = '<p class="text-red-500">Ã–dÃ¼l bilgileri yÃ¼klenemedi.</p>';
    }

    document.getElementById('weeklyResetInfoModal').style.display = 'flex';
}

function closeWeeklyResetInfoModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('weeklyResetInfoModal').style.display = 'none';
}

async function kasaTransferEt() {
    if (isAdmin) {
        displayMessage("Adminler bu iÅŸlemi yapamaz.");
        return;
    }
    const miktar = parseInt(document.getElementById('kasaTransferInput').value);
    if (isNaN(miktar) || miktar <= 0) {
        displayMessage("LÃ¼tfen geÃ§erli bir miktar girin.");
        return;
    }

    // YENÄ° EKLENEN KONTROL MEKANÄ°ZMASI
    const settingsSnap = await db.ref('gameConfig/kasaSettings').once('value');
    const minAmount = settingsSnap.val()?.minTransferAmount || 0;

    if (minAmount > 0 && miktar < minAmount) {
        displayMessage(`Kasaya aktarÄ±m iÃ§in minimum tutar ${minAmount} PuandÄ±r.`);
        return;
    }
    // KONTROL SONU

    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();
    const mevcutPuan = userData.balance || 0;

    if (miktar > mevcutPuan) {
        displayMessage("Kasaya aktarmak iÃ§in yeterli puanÄ±nÄ±z yok.");
        return;
    }

    const confirmed = await customConfirm(`<b>${miktar}</b> Puan, Kasa'ya aktarÄ±lacak. Bu iÅŸlem geri alÄ±namaz ve Kasa PuanlarÄ± sadece Ã–zel ÃœrÃ¼n MaÄŸazasÄ±'nda kullanÄ±labilir. OnaylÄ±yor musunuz?`);
    if (!confirmed) return;

    const yeniPuan = mevcutPuan - miktar;
    const yeniKasaPuani = (userData.kasaPuani || 0) + miktar;

    await userRef.update({
        balance: yeniPuan,
        kasaPuani: yeniKasaPuani
    });

    logActivity('kasaTransfer', currentUser, { amount: miktar, newKasaBalance: yeniKasaPuani });
    displayMessage(`BaÅŸarÄ±lÄ±! <b>${miktar} Puan</b>, Kasa'ya aktarÄ±ldÄ±.`);
    document.getElementById('kasaTransferInput').value = '';
}

async function loadCollectionAlbum() {
    const albumContainer = document.getElementById('cardCollectionAlbum');
    const statusOverlay = document.getElementById('collectionStatusOverlay');
    const statusTitle = document.getElementById('collectionStatusTitle');
    const statusMessage = document.getElementById('collectionStatusMessage');
    const grandPrizeDisplay = document.getElementById('grandPrizeDisplay');

    const statusRef = db.ref('gameConfig/cardCollectionStatus');
    const statusSnap = await statusRef.once('value');
    const currentStatus = statusSnap.val() || 'inactive';

    if(isAdmin) {
        // ... (Admin kontrolleri aynÄ± kalacak, buraya dokunmuyoruz) ...
        const statusTextEl = document.getElementById('collectionStatusText');
        const pauseBtn = document.getElementById('pauseResumeButton');
        if (statusTextEl && pauseBtn) {
            statusTextEl.textContent = {'active': 'Aktif', 'paused': 'DuraklatÄ±ldÄ± (BakÄ±mda)', 'inactive': 'Bitti / BaÅŸlamadÄ±'}[currentStatus];
            if(currentStatus === 'paused') {
                pauseBtn.textContent = 'Sezonu Devam Ettir';
                pauseBtn.classList.replace('bg-orange-600', 'bg-green-600');
                pauseBtn.classList.replace('hover:bg-orange-500', 'hover:bg-green-500');
            } else {
                pauseBtn.textContent = 'Sezonu Duraklat';
                pauseBtn.classList.replace('bg-green-600', 'bg-orange-600');
                pauseBtn.classList.replace('hover:bg-green-500', 'hover:bg-orange-500');
            }
        }
        const toggleBtn = document.getElementById('toggleSeasonBtn');
        if (toggleBtn) {
            if (currentStatus === 'active') {
                toggleBtn.textContent = 'â›” Sezonu Bitir';
                toggleBtn.classList.add('bg-red-700', 'hover:bg-red-600');
                toggleBtn.classList.remove('bg-green-700', 'hover:bg-green-600', 'animate-pulse');
            } else {
                toggleBtn.textContent = 'ğŸ’¥ YENÄ° SEZONU BAÅLAT ğŸ’¥';
                toggleBtn.classList.add('bg-green-700', 'hover:bg-green-600', 'animate-pulse');
                toggleBtn.classList.remove('bg-red-700', 'hover:bg-red-600');
            }
        }
    }

    if (!isAdmin) {
        if (currentStatus === 'paused' || currentStatus === 'inactive') {
            statusTitle.textContent = currentStatus === 'paused' ? 'ğŸ”§ BakÄ±mdayÄ±z ğŸ”§' : 'ğŸš€ Yeni Sezon Ã‡ok YakÄ±nda! ğŸš€';
            statusMessage.textContent = currentStatus === 'paused' ? 'Kart Koleksiyonu sezonu ÅŸu anda kÄ±sa bir bakÄ±mda.' : 'Adminin yeni sezonu baÅŸlatmasÄ±nÄ± bekle.';
            statusOverlay.classList.remove('hidden');
            albumContainer.classList.add('hidden');
            grandPrizeDisplay.classList.add('hidden');
            return;
        }
    }
    
    statusOverlay.classList.add('hidden');
    albumContainer.classList.remove('hidden');
    
    const progressSpan = document.getElementById('collectionProgress');
    albumContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">Koleksiyon yÃ¼kleniyor...</p>';

    const masterListRef = db.ref('gameConfig/cardCollection');
    const masterListSnap = await masterListRef.orderByChild('order').once('value');
    
    if (!masterListSnap.exists()) {
        albumContainer.innerHTML = '<p class="text-center col-span-full">YÃ¶netici henÃ¼z bir koleksiyon oluÅŸturmadÄ±.</p>';
        if(progressSpan) progressSpan.textContent = '0/0';
        return;
    }
    const masterList = masterListSnap.val();
    const totalCardCount = Object.keys(masterList).length;

    const userRef = db.ref(`users/${currentUser}`);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val() || {};
    const userCards = userData.cardCollection || {};
    const hasCompletedCollection = userData.completedCollection === true;
    
    // --- YENÄ° EKLENEN KOD BAÅLANGICI (JOKER KART Ä°Ã‡Ä°N) ---
    const wildcardIndicator = document.getElementById('wildcardIndicator');
    const wildcardCountSpan = document.getElementById('wildcardCount');
    const userWildcards = userData.wildcards || 0;

    if (wildcardIndicator) {
        if (userWildcards > 0 || isAdmin) {
            wildcardCountSpan.textContent = userWildcards;
            wildcardIndicator.classList.remove('hidden');
            const convertBtn = document.getElementById('convertWildcardBtn');
            if (convertBtn) {
                convertBtn.classList.toggle('hidden', !(hasCompletedCollection && userWildcards > 0));
            }
        } else {
            wildcardIndicator.classList.add('hidden');
        }
    }
    // --- YENÄ° EKLENEN KOD SONU ---

    const userOwnedCardCount = Object.keys(userCards).length;
    if(progressSpan) progressSpan.textContent = `${userOwnedCardCount}/${totalCardCount}`;
    
    albumContainer.innerHTML = ''; 

    for (const cardId in masterList) {
        const cardInfo = masterList[cardId];
        const userHasCard = userCards[cardId];

        const slot = document.createElement('div');
        slot.className = 'card-slot';

        if (userHasCard || isAdmin) { 
            const cardItem = document.createElement('div');
            cardItem.className = `card-item rarity-${cardInfo.rarity || 'normal'}`;
            
            let duplicateBadge = userHasCard && userHasCard.count > 1 ? `<div class="duplicate-badge">+${userHasCard.count - 1}</div>` : '';
            let adminCardControls = isAdmin ? `<div class="card-admin-buttons"><button onclick="openCardCreatorModal('${cardId}')">âœï¸</button><button onclick="deleteCard('${cardId}')">ğŸ—‘ï¸</button></div>` : '';
            
            cardItem.innerHTML = `
                ${newlyAcquiredCards.has(cardId) ? `<div class="new-card-badge">YENÄ°</div>` : ''}
                ${duplicateBadge}
                ${adminCardControls}
                <img class="card-image" src="${cardInfo.imageUrl}">
                <h4 class="card-name">${cardInfo.cardName}</h4>
            `;

            if (userHasCard && userHasCard.count > 1) {
                if (hasCompletedCollection) {
                    cardItem.onclick = () => handleDuplicateCardClick(cardId);
                } else {
                    cardItem.onclick = () => openTradeMenu(cardId, cardInfo.cardName);
                }
            }
            
            slot.appendChild(cardItem);

        } else {
            let wildcardButton = '';
            if (userWildcards > 0 && !hasCompletedCollection) {
                wildcardButton = `<button class="absolute bottom-2 left-1/2 -translate-x-1/2 w-11/12 py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold text-xs rounded-lg animate-pulse" onclick="useWildcard('${cardId}', '${cardInfo.cardName}')">Joker Kullan</button>`;
            }
            slot.innerHTML = `
                <div class="card-item missing relative rarity-${cardInfo.rarity || 'normal'}">
                    <div class="card-image flex items-center justify-center"><span class="missing-text">?</span></div>
                    <h4 class="card-name text-gray-500">${cardInfo.cardName}</h4>
                    ${wildcardButton}
                </div>`;
        }
        albumContainer.appendChild(slot);
    }
}

// KullanÄ±cÄ± koleksiyonundaki fazla karta tÄ±kladÄ±ÄŸÄ±nda teklif oluÅŸturma penceresini aÃ§ar
function openTradeMenu(cardId, cardName) {
    if (!cardId) return;
    // Teklif penceresini, bu kart Ã¶nceden seÃ§ili olacak ÅŸekilde aÃ§
    openCreateOfferModal(cardId);
}

// YENÄ° VE TÃœM MANTIÄI Ä°Ã‡EREN FONKSÄ°YON
async function handleDuplicateCardClick(cardId) {
    if (isTradeInProgress) return; // BaÅŸka bir iÅŸlem devam ediyorsa bekle
    isTradeInProgress = true;

    try {
        // Gerekli tÃ¼m verileri tek seferde Ã§ekelim
        const [userSnap, cardInfoSnap] = await Promise.all([
            db.ref(`users/${currentUser}`).once('value'),
            db.ref(`gameConfig/cardCollection/${cardId}`).once('value')
        ]);

        const userData = userSnap.val();
        const cardInfo = cardInfoSnap.val();

        // Sunucu tarafÄ± gibi davranÄ±p tÃ¼m kontrolleri yapalÄ±m
        if (!userData || !cardInfo || userData.completedCollection !== true || !userData.cardCollection?.[cardId] || userData.cardCollection[cardId].count <= 1) {
            throw new Error("Bu kart dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lemez. SayfayÄ± yenileyip tekrar deneyin.");
        }

        // Ä°steÄŸine gÃ¶re oranlarÄ± belirleyelim
        const rates = { normal: 1, gumus: 2, altin: 3, efsanevi: 5 };
        const boxRightsToGain = rates[cardInfo.rarity] || 1; // Bilinmeyen bir nadirlik varsa 1 ver
        
        const rarityNames = { normal: 'Bronz', gumus: 'GÃ¼mÃ¼ÅŸ', altin: 'AltÄ±n', efsanevi: 'Efsanevi' };
        const displayRarity = rarityNames[cardInfo.rarity] || cardInfo.rarity;

        // KullanÄ±cÄ±ya onay soralÄ±m
        const confirmed = await customConfirm(`Fazla olan 1 adet <b class="text-white">'${cardInfo.cardName}'</b> (${displayRarity}) kartÄ±nÄ± <b class="text-yellow-300">+${boxRightsToGain} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rmek istediÄŸine emin misin?`);
        if (!confirmed) {
            isTradeInProgress = false;
            return;
        }

        // VeritabanÄ± iÅŸlemini Transaction ile gÃ¼venli bir ÅŸekilde yapalÄ±m
        const userRef = db.ref(`users/${currentUser}`);
        const { committed } = await userRef.transaction(currentData => {
            if (currentData && currentData.completedCollection === true && currentData.cardCollection?.[cardId]?.count > 1) {
                currentData.cardCollection[cardId].count--;
                currentData.kutuHakki = (currentData.kutuHakki || 0) + boxRightsToGain;
                return currentData;
            }
            return; // KoÅŸul saÄŸlanmazsa iÅŸlemi iptal et
        });

        if (committed) {
            displayMessage(`BaÅŸarÄ±lÄ±! KartÄ±n +${boxRightsToGain} Kutu HakkÄ±'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼.`);
            loadCollectionAlbum(); // ArayÃ¼zÃ¼ anÄ±nda yenile
        } else {
            throw new Error("DÃ¶nÃ¼ÅŸtÃ¼rme iÅŸlemi baÅŸarÄ±sÄ±z oldu. Kart durumu deÄŸiÅŸmiÅŸ olabilir.");
        }

    } catch (error) {
        displayMessage(error.message);
    } finally {
        isTradeInProgress = false; // Ä°ÅŸlem bitince kilidi kaldÄ±r
    }
}

// JOKER KART KULLANMA FONKSÄ°YONU

async function useWildcard(cardIdToGet, cardNameToGet) {
    if (isAdmin) return;

    const confirmed = await customConfirm(`'${cardNameToGet}' kartÄ±nÄ± tamamlamak iÃ§in 1 Joker Kart kullanmak istediÄŸine emin misin? Bu iÅŸlem geri alÄ±namaz!`);
    if (!confirmed) return;

    const userRef = db.ref('users/' + currentUser);
    
    // GÃ¼venli iÅŸlem iÃ§in transaction kullanÄ±yoruz
    await userRef.transaction(userData => {
        if (userData) {
            // KullanÄ±cÄ±nÄ±n joker kartÄ± olup olmadÄ±ÄŸÄ±nÄ± tekrar kontrol et
            if ((userData.wildcards || 0) > 0) {
                // Joker kart sayÄ±sÄ±nÄ± 1 azalt
                userData.wildcards = userData.wildcards - 1;

                // Koleksiyona yeni kartÄ± ekle
                if (!userData.cardCollection) {
                    userData.cardCollection = {};
                }
                // EÄŸer bu karttan daha Ã¶nce (baÅŸka yolla) kazanmÄ±ÅŸsa sayÄ±sÄ±nÄ± artÄ±r, yoksa 1 olarak ekle
                if (userData.cardCollection[cardIdToGet]) {
                    userData.cardCollection[cardIdToGet].count = (userData.cardCollection[cardIdToGet].count || 0) + 1;
                } else {
                    userData.cardCollection[cardIdToGet] = { count: 1 };
                }
                return userData;
            }
        }
        // EÄŸer joker kartÄ± yoksa veya kullanÄ±cÄ± verisi bulunamazsa, iÅŸlemi iptal et
        return; 
    });

    displayMessage(`Tebrikler! Joker Kart kullanarak '${cardNameToGet}' kartÄ±nÄ± koleksiyonuna ekledin!`);
    loadCollectionAlbum(); // DeÄŸiÅŸikliÄŸi anÄ±nda gÃ¶rmek iÃ§in albÃ¼mÃ¼ yenile
}

let editingCardId = null; // Hangi kartÄ±n dÃ¼zenlendiÄŸini tutar

// Kart oluÅŸturma/dÃ¼zenleme penceresini aÃ§ar
async function openCardCreatorModal(cardId = null) {
    const modal = document.getElementById('cardCreatorModal');
    const title = document.getElementById('cardFormTitle');
    const saveBtn = document.getElementById('saveCardBtn');

    // Formu temizle
    document.getElementById('cardNameInput').value = '';
    document.getElementById('cardImageUrlInput').value = '';
    document.getElementById('cardRarityInput').value = 'normal';

    if (cardId) {
        // EÄŸer bir cardId geldiyse, bu DÃœZENLEME modudur
        editingCardId = cardId;
        title.textContent = 'KartÄ± DÃ¼zenle';
        saveBtn.textContent = 'KARTI GÃœNCELLE';

        // KartÄ±n mevcut bilgilerini Firebase'den Ã§ek ve formu doldur
        const cardSnap = await db.ref(`gameConfig/cardCollection/${cardId}`).once('value');
        const cardData = cardSnap.val();
        if (cardData) {
            document.getElementById('cardNameInput').value = cardData.cardName;
            document.getElementById('cardImageUrlInput').value = cardData.imageUrl;
            document.getElementById('cardRarityInput').value = cardData.rarity;
            // YENÄ° EKLENEN SATIR
            document.getElementById('cardChanceInput').value = cardData.chance || 100; // EÄŸer ÅŸans belirtilmemiÅŸse varsayÄ±lan 100 olsun
        }
    } else {
        // EÄŸer cardId gelmediyse, bu YENÄ° KART EKLEME modudur
        editingCardId = null;
        title.textContent = 'Yeni Kart OluÅŸtur';
        saveBtn.textContent = 'KARTI KAYDET';
    }

    modal.style.display = 'flex';
}

// Kart oluÅŸturma/dÃ¼zenleme penceresini kapatÄ±r
function closeCardCreatorModal() {
    document.getElementById('cardCreatorModal').style.display = 'none';
    editingCardId = null;
}

// Formdaki bilgileri alÄ±p Firebase'e kaydeder veya gÃ¼nceller
async function saveCard() {
    if (!isAdmin) return;

    const cardData = {
        cardName: document.getElementById('cardNameInput').value.trim(),
        imageUrl: document.getElementById('cardImageUrlInput').value.trim(),
        rarity: document.getElementById('cardRarityInput').value,
        // YENÄ° EKLENEN SATIR
        chance: parseInt(document.getElementById('cardChanceInput').value) || 100 // EÄŸer boÅŸ bÄ±rakÄ±lÄ±rsa varsayÄ±lan 100
    };

    if (!cardData.cardName || !cardData.imageUrl) {
        displayMessage("Kart AdÄ± ve Resim URL'si boÅŸ bÄ±rakÄ±lamaz.");
        return;
    }

    if (editingCardId) {
        // Var olan kartÄ± gÃ¼ncelle
        await db.ref(`gameConfig/cardCollection/${editingCardId}`).update(cardData);
        displayMessage("Kart baÅŸarÄ±yla gÃ¼ncellendi.");
    } else {
        // Yeni kart oluÅŸtur
        // KartlarÄ±n sÄ±ralÄ± gÃ¶rÃ¼nmesi iÃ§in bir 'order' alanÄ± ekleyelim
        const collectionRef = db.ref('gameConfig/cardCollection');
        const lastCardSnap = await collectionRef.orderByChild('order').limitToLast(1).once('value');
        let nextOrder = 0;
        if (lastCardSnap.exists()) {
            nextOrder = Object.values(lastCardSnap.val())[0].order + 1;
        }
        cardData.order = nextOrder;

        await collectionRef.push(cardData);
        displayMessage("Yeni kart baÅŸarÄ±yla koleksiyona eklendi.");
    }

    closeCardCreatorModal();
    loadCollectionAlbum(); // DeÄŸiÅŸikliÄŸi anÄ±nda gÃ¶rmek iÃ§in albÃ¼mÃ¼ yenile
}

// Bir kartÄ± koleksiyondan kalÄ±cÄ± olarak siler
async function deleteCard(cardId) {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Bu kartÄ± koleksiyondan kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz? (Bu iÅŸlem kullanÄ±cÄ±larÄ±n ilerlemesini etkilemez, sadece ana listeden kaldÄ±rÄ±r)");
    if (confirmed) {
        await db.ref(`gameConfig/cardCollection/${cardId}`).remove();
        displayMessage("Kart baÅŸarÄ±yla silindi.");
        loadCollectionAlbum(); // DeÄŸiÅŸikliÄŸi anÄ±nda gÃ¶rmek iÃ§in albÃ¼mÃ¼ yenile
    }
}

async function resetWholeCollection() {
    if (!isAdmin) return;
    // Onay mesajÄ± aynÄ± kalabilir, kullanÄ±cÄ± zaten bunu gÃ¶rÃ¼yor.
    const confirmed = await customConfirm("Bu iÅŸlem mevcut tÃ¼m kartlarÄ±, kullanÄ±cÄ± ilerlemelerini ve ÅŸampiyonluklarÄ± SÄ°LEREK yepyeni bir sezon baÅŸlatacaktÄ±r. Emin misiniz?");
    if (confirmed) {
        const updates = {};
        // updates['/gameConfig/cardCollection'] = null; // <<<--- BU SATIR SÄ°LÄ°NDÄ°! ANA KART LÄ°STESÄ° ARTIK GÃœVENDE.
        updates['/gameConfig/collectionWinner'] = null;
        // Ã–dÃ¼lÃ¼ silmek yerine sÄ±fÄ±rlanmasÄ±nÄ± beklemek daha mantÄ±klÄ± olabilir, ama ÅŸimdilik kalsÄ±n.
        // updates['/gameConfig/collectionGrandPrize'] = null; 
        updates['/gameConfig/cardCollectionStatus'] = 'inactive'; 

        const usersSnap = await db.ref('users').once('value');
        if (usersSnap.exists()) {
            usersSnap.forEach(userSnap => {
                const username = userSnap.key;
                // Sadece kullanÄ±cÄ±larÄ±n kart ilerlemesini ve durumunu sÄ±fÄ±rlÄ±yoruz.
                updates[`/users/${username}/cardCollection`] = null;
                updates[`/users/${username}/completedCollection`] = null;
                // Åampiyonluklar bir baÅŸarÄ± olduÄŸu iÃ§in kalÄ±cÄ± olabilir, ama isteÄŸe gÃ¶re bu satÄ±r da kalabilir.
                updates[`/users/${username}/achievements/collectionChampion`] = null;
            });
        }
        await db.ref().update(updates);
        displayMessage("TÃ¼m kullanÄ±cÄ±larÄ±n koleksiyon ilerlemeleri baÅŸarÄ±yla sÄ±fÄ±rlandÄ±. Yeni sezon hazÄ±rlanÄ±yor...");
        loadCollectionAlbum();
    }
}

// =======================================================
// YENÄ° Ã–ZELLÄ°K: PAZAR YÃ–NETÄ°M FONKSÄ°YONLARI
// =======================================================

// Admin, Kartlar sekmesine girdiÄŸinde mevcut pazar ayarlarÄ±nÄ± input'lara yÃ¼kler
async function loadMarketSettingsForAdmin() {
    if (!isAdmin) return;
    const settingsRef = db.ref('gameConfig/marketSettings');
    const settingsSnap = await settingsRef.once('value');
    const settings = settingsSnap.val() || {};

    document.getElementById('tradeFeeInput').value = settings.tradeFee || 0;

    const lockBtn = document.getElementById('marketLockBtn');
    if (settings.isLocked) {
        lockBtn.textContent = 'PazarÄ±n Kilidini AÃ§';
        lockBtn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
        lockBtn.classList.add('bg-green-600', 'hover:bg-green-500');
    } else {
        lockBtn.textContent = 'PazarÄ± Kilitle';
        lockBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
        lockBtn.classList.add('bg-gray-600', 'hover:bg-gray-500');
    }
}

// Input'taki ayarlarÄ± Firebase'e kaydeder
async function saveMarketSettings() {
    if (!isAdmin) return;
    const tradeFee = parseInt(document.getElementById('tradeFeeInput').value);

    if (isNaN(tradeFee) || tradeFee < 0) {
        displayMessage("LÃ¼tfen geÃ§erli bir takas Ã¼creti girin (0 veya daha bÃ¼yÃ¼k bir sayÄ±).");
        return;
    }

    await db.ref('gameConfig/marketSettings/tradeFee').set(tradeFee);
    displayMessage("Pazar ayarlarÄ± baÅŸarÄ±yla kaydedildi.");
}

// PazarÄ±n kilitli olup olmadÄ±ÄŸÄ±nÄ± deÄŸiÅŸtirir
async function toggleMarketLock() {
    if (!isAdmin) return;
    const lockRef = db.ref('gameConfig/marketSettings/isLocked');
    const lockSnap = await lockRef.once('value');
    const isCurrentlyLocked = lockSnap.val() || false;

    await lockRef.set(!isCurrentlyLocked);
    displayMessage(`Takas PazarÄ± baÅŸarÄ±yla ${!isCurrentlyLocked ? 'kilitlendi' : 'aÃ§Ä±ldÄ±'}.`);
    loadMarketSettingsForAdmin(); // Butonun rengini ve yazÄ±sÄ±nÄ± gÃ¼ncelle
}

// Takas geÃ§miÅŸi penceresini aÃ§ar ve kayÄ±tlarÄ± yÃ¼kler
function openTradeHistoryModal() {
    loadTradeHistory();
    document.getElementById('tradeHistoryModal').style.display = 'flex';
}

// Takas geÃ§miÅŸi penceresini kapatÄ±r
function closeTradeHistoryModal() {
    document.getElementById('tradeHistoryModal').style.display = 'none';
}

// Firebase'den takas geÃ§miÅŸini Ã§eker ve listeler
async function loadTradeHistory() {
    const listEl = document.getElementById('tradeHistoryList');
    listEl.innerHTML = '<p class="text-center text-gray-400">YÃ¼kleniyor...</p>';

    const historyRef = db.ref('tradeHistory').orderByChild('timestamp').limitToLast(100);
    const historySnap = await historyRef.once('value');
    const history = historySnap.val();

    if (!history) {
        listEl.innerHTML = '<p class="text-center text-gray-400">HenÃ¼z tamamlanmÄ±ÅŸ bir takas yok.</p>';
        return;
    }

    const sortedHistory = Object.values(history).sort((a, b) => b.timestamp - a.timestamp);

    let html = '';
    sortedHistory.forEach(trade => {
        const date = new Date(trade.timestamp).toLocaleString('tr-TR');
        html += `
            <div class="p-3 bg-gray-900 rounded-lg mb-3">
                <p class="text-white">
                    <b class="text-green-400">${trade.accepter}</b>, 
                    <b class="text-yellow-400">${trade.offerer}</b> adlÄ± kullanÄ±cÄ±dan 
                    <span class="text-cyan-300">'${trade.offeredCardName}'</span> kartÄ±nÄ± alÄ±p karÅŸÄ±lÄ±ÄŸÄ±nda 
                    <span class="text-pink-300">'${trade.requestedCardName}'</span> kartÄ±nÄ± verdi.
                </p>
                <div class="text-xs text-gray-500 mt-1 text-right">${date}</div>
            </div>
        `;
    });
    listEl.innerHTML = html;
}

async function openTradeMarket() {
    const lockSnap = await db.ref('gameConfig/marketSettings/isLocked').once('value');
    if (lockSnap.val() === true && !isAdmin) {
        displayMessage("Takas PazarÄ± ÅŸu anda bakÄ±m nedeniyle geÃ§ici olarak kapalÄ±dÄ±r.");
        return;
    }

    const userSnap = await db.ref(`users/${currentUser}`).once('value');
    const userData = userSnap.val() || {};
    const createOfferBtn = document.getElementById('create-new-offer-btn');

    if (userData.completedCollection === true) {
        createOfferBtn.style.display = 'none'; // AlbÃ¼mÃ¼ tamamladÄ±ysa butonu gizle
    } else {
        createOfferBtn.style.display = 'block'; // TamamlamadÄ±ysa butonu gÃ¶ster
    }

    document.getElementById('tradeMarketModal').style.display = 'flex';
    switchMarketTab('all');
}

// Takas pazarÄ± ana penceresini kapatÄ±r
function closeTradeMarketModal() {
    // Pazar kapatÄ±ldÄ±ÄŸÄ±nda, arka planda veri Ã§ekmeye devam etmemesi iÃ§in dinleyiciyi durdur.
    if (activeListeners.marketOffers) {
        activeListeners.marketOffers.ref.off('value', activeListeners.marketOffers.callback);
        delete activeListeners.marketOffers;
    }
    document.getElementById('tradeMarketModal').style.display = 'none';
}

// "Pazardaki Teklifler" ve "Benim Tekliflerim" sekmeleri arasÄ±nda geÃ§iÅŸ yapar
function switchMarketTab(tabName) {
    const allTab = document.getElementById('marketTabAll');
    const mineTab = document.getElementById('marketTabMine');
    
    if (tabName === 'all') {
        allTab.classList.add('border-purple-500', 'text-white');
        allTab.classList.remove('border-transparent', 'text-gray-400');
        mineTab.classList.add('border-transparent', 'text-gray-400');
        mineTab.classList.remove('border-purple-500', 'text-white');
        loadMarketOffers('all'); // Herkesin tekliflerini yÃ¼kle
    } else { // 'mine'
        mineTab.classList.add('border-purple-500', 'text-white');
        mineTab.classList.remove('border-transparent', 'text-gray-400');
        allTab.classList.add('border-transparent', 'text-gray-400');
        allTab.classList.remove('border-purple-500', 'text-white');
        loadMarketOffers('mine'); // Sadece benim tekliflerimi yÃ¼kle
    }
}

let isTradeInProgress = false;

// acceptTradeOffer FONKSÄ°YONUNU BULUP BU BLOK Ä°LE DEÄÄ°ÅTÄ°RÄ°N

async function acceptTradeOffer(tradeId, buttonElement) {
    if (isTradeInProgress) {
        return;
    }
    if (isAdmin) return;

    isTradeInProgress = true;
    if (buttonElement) {
        buttonElement.disabled = true;
        buttonElement.textContent = 'Ä°ÅŸleniyor...';
    }

    try {
        // --- 1. VERÄ° TOPLAMA VE KONTROLLER ---
        const isCrossTrade = buttonElement.dataset.tradeFromMarket === 'true';
        const conflictingTradeId = buttonElement.dataset.conflictingTradeId;

        const [marketSettingsSnap, tradeSnap, userSnap, masterCardsSnap] = await Promise.all([
            db.ref('gameConfig/marketSettings').once('value'),
            db.ref(`trades/${tradeId}`).once('value'),
            db.ref(`users/${currentUser}`).once('value'),
            db.ref('gameConfig/cardCollection').once('value')
        ]);

        const marketSettings = marketSettingsSnap.val() || {};
        const trade = tradeSnap.val();
        const userData = userSnap.val();
        const masterCards = masterCardsSnap.val();

        // YENÄ° EKLENEN KISIM BAÅLANGICI: Koleksiyonu tamamlayanlar takas yapamaz.
        if (userData.completedCollection === true) {
            throw new Error("Koleksiyonu tamamladÄ±ÄŸÄ±n iÃ§in artÄ±k takas yapamazsÄ±n.");
        }
        // YENÄ° EKLENEN KISIM SONU

        if (marketSettings.isLocked) {
            throw new Error("Pazar kilitli.");
        }
        if (!trade) {
            loadMarketOffers('all');
            throw new Error("Bu takas teklifi artÄ±k geÃ§erli deÄŸil.");
        }
        if (!userData) {
            throw new Error("KullanÄ±cÄ± verisi bulunamadÄ±.");
        }

        const tradeFee = marketSettings.tradeFee || 0;
        const userCards = userData.cardCollection || {};

        if ((userData.balance || 0) < tradeFee) {
            throw new Error(`Takas iÃ§in gereken ${tradeFee} Puan iÅŸlem Ã¼cretine sahip deÄŸilsin.`);
        }

        if (isCrossTrade) {
            if (!userCards[trade.requestedCardId] || userCards[trade.requestedCardId].count !== 1) {
                throw new Error("Bu takasÄ± yapmak iÃ§in gerekli kart durumun deÄŸiÅŸmiÅŸ.");
            }
        } else {
            if (!userCards[trade.requestedCardId] || userCards[trade.requestedCardId].count <= 1) {
                throw new Error("Bu takasÄ± yapabilmek iÃ§in istenen karttan en az 2 adete sahip olmalÄ±sÄ±n.");
            }
        }

        // --- 2. KULLANICI ONAYI ---
        const offeredCard = masterCards[trade.offeredCardId];
        const requestedCard = masterCards[trade.requestedCardId];
        
        // YENÄ° EKLENEN KISIM BAÅLANGICI: Ekstra bilgilendirme mesajÄ±
        let extraWarningMessage = '';
        if (userCards[trade.offeredCardId] && userCards[trade.offeredCardId].count > 0) {
            const currentCount = userCards[trade.offeredCardId].count;
            extraWarningMessage = `<br><br><b class='text-amber-400'>Bilgilendirme:</b> AlacaÄŸÄ±nÄ±z '${offeredCard.cardName}' kartÄ± koleksiyonunuzda zaten mevcut (${currentCount} adet). TakasÄ± onaylarsanÄ±z bu kartÄ±n adedi +1 artacaktÄ±r.`;
        }
        // YENÄ° EKLENEN KISIM SONU

        let confirmed = false;
        if (isCrossTrade) {
            confirmed = await customConfirm(`Takas etmek istediÄŸiniz '${requestedCard.cardName}' kartÄ± takas pazarÄ±na eklenmiÅŸ TakasÄ± kabul ederseniz, kartÄ±nÄ±z pazardan silinecektir. <br><br><b>Ä°ÅŸlem Ã¼creti: ${tradeFee} Puan</b>. Devam etmek istiyor musunuz?${extraWarningMessage}`);
        } else {
            confirmed = await customConfirm(`<b>${trade.offerer}</b> ile takas yapacaksÄ±n. VereceÄŸin kart: <b class="text-red-400">${requestedCard.cardName}</b>, AlacaÄŸÄ±n kart: <b class="text-green-400">${offeredCard.cardName}</b>. Ä°ÅŸlem Ã¼creti: <b class="text-yellow-400">${tradeFee} Puan</b>. OnaylÄ±yor musunuz?${extraWarningMessage}`);
        }

        if (!confirmed) {
            throw new Error("KullanÄ±cÄ± iptal etti.");
        }

        // --- 3. GÃœNCELLEMELERÄ° HAZIRLAMA ---
        const updates = {};
        
        if (isCrossTrade && conflictingTradeId) {
            const conflictingTradeSnap = await db.ref(`trades/${conflictingTradeId}`).once('value');
            const conflictingTrade = conflictingTradeSnap.val();
            if (conflictingTrade) {
                updates[`/trades/${conflictingTradeId}`] = null;
                if (conflictingTrade.activityId) {
                    updates[`/activityFeed/${conflictingTrade.activityId}/details/status`] = 'cancelled';
                }
            }
        }
        
        updates[`/trades/${tradeId}`] = null;
        if (trade.activityId) {
            updates[`/activityFeed/${trade.activityId}/details/status`] = 'completed';
        }

        updates[`/users/${currentUser}/cardCollection/${trade.requestedCardId}/count`] = userCards[trade.requestedCardId].count - 1;
        updates[`/users/${currentUser}/cardCollection/${trade.offeredCardId}/count`] = (userCards[trade.offeredCardId]?.count || 0) + 1;
        updates[`/users/${currentUser}/balance`] = (userData.balance || 0) - tradeFee;
        const finalAccepterBalance = updates[`/users/${currentUser}/balance`];

        const offererSnap = await db.ref(`users/${trade.offerer}`).once('value');
        const offererData = offererSnap.val();
        if(offererData){
             updates[`/users/${trade.offerer}/cardCollection/${trade.requestedCardId}/count`] = (offererData.cardCollection?.[trade.requestedCardId]?.count || 0) + 1;
        }

        // --- 4. GÃœNCELLEMELERÄ° UYGULAMA VE BÄ°LDÄ°RÄ°MLER ---
        await db.ref().update(updates);

        await db.ref('tradeHistory').push().set({
            offerer: trade.offerer, accepter: currentUser, offeredCardId: trade.offeredCardId,
            requestedCardId: trade.requestedCardId, offeredCardName: offeredCard.cardName,
            requestedCardName: requestedCard.cardName, timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        logActivity('tradeOfferAccepted', currentUser, {
            offerer: trade.offerer, fee: tradeFee, newBalance: finalAccepterBalance,
            offeredCardName: offeredCard.cardName, requestedCardName: requestedCard.cardName
        });

        displayGlobalNotification(`Takas baÅŸarÄ±lÄ±! Yeni kartÄ±n albÃ¼mÃ¼ne eklendi.`);
        const notificationMessage = `<b>${currentUser}</b>, takasa koyduÄŸunuz '${offeredCard.cardName}' kartÄ± karÅŸÄ±lÄ±ÄŸÄ±nda istediÄŸiniz '${requestedCard.cardName}' kartÄ± takasÄ±nÄ± onayladÄ±. Yeni kartÄ±nÄ±z albÃ¼mÃ¼nÃ¼ze eklendi!`;
        await db.ref(`tradeNotifications/${trade.offerer}`).push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
        
        // YENÄ° EKLENEN KISIM BAÅLANGICI: Takas sonrasÄ± her iki oyuncu iÃ§in de koleksiyon tamamlama kontrolÃ¼
        await checkAndGrantPrize(currentUser); // TakasÄ± kabul eden iÃ§in kontrol
        await checkAndGrantPrize(trade.offerer); // Teklifi yapan iÃ§in kontrol
        // YENÄ° EKLENEN KISIM SONU

        if (currentActiveSection === 'cardCollection') {
            loadCollectionAlbum();
        }

    } catch (error) {
        const knownErrors = ["KullanÄ±cÄ± iptal etti.", "Pazar kilitli.", "Bu takas teklifi artÄ±k geÃ§erli deÄŸil.", "KullanÄ±cÄ± verisi bulunamadÄ±.", "Bu takasÄ± yapmak iÃ§in gerekli kart durumun deÄŸiÅŸmiÅŸ.", "Koleksiyonu tamamladÄ±ÄŸÄ±n iÃ§in artÄ±k takas yapamazsÄ±n."];
        if (!knownErrors.includes(error.message) && !error.message.includes("iÅŸlem Ã¼cretine sahip deÄŸilsin") && !error.message.includes("en az 2 adete sahip olmalÄ±sÄ±n")) {
             console.error("Takas iÅŸlemi hatasÄ±:", error);
             displayMessage("Beklenmedik bir hata oluÅŸtu. LÃ¼tfen konsolu kontrol edin.");
        } else {
            displayMessage(error.message);
        }
        loadMarketOffers('all');
    } finally {
        isTradeInProgress = false;
        if (buttonElement) {
            const tradeStillExists = (await db.ref(`trades/${tradeId}`).once('value')).exists();
            if(tradeStillExists){
                buttonElement.disabled = false;
                buttonElement.textContent = 'TakasÄ± Yap';
            }
        }
    }
}

async function loadMarketOffers(mode) {
    const listEl = document.getElementById('marketOffersList');
    listEl.innerHTML = '<p class="text-center text-gray-400">Teklifler yÃ¼kleniyor...</p>';

    if (activeListeners.marketOffers) {
        activeListeners.marketOffers.ref.off('value', activeListeners.marketOffers.callback);
    }

    let tradesRef = db.ref('trades');

    // KullanÄ±cÄ±nÄ±n kendi aktif tekliflerini en baÅŸta bir kez Ã§ekelim
    const myOffersSnap = await tradesRef.orderByChild('offerer').equalTo(currentUser).once('value');
    const myOffers = myOffersSnap.val() || {};
    const myOfferedCardIds = new Map();
    for (const tradeId in myOffers) {
        myOfferedCardIds.set(myOffers[tradeId].offeredCardId, tradeId);
    }

    if (mode === 'mine') {
        tradesRef = tradesRef.orderByChild('offerer').equalTo(currentUser);
    }

    const callback = async (tradesSnap) => {
        const [masterCardsSnap, userCardsSnap] = await Promise.all([
            db.ref('gameConfig/cardCollection').once('value'),
            db.ref(`users/${currentUser}/cardCollection`).once('value')
        ]);

        const trades = tradesSnap.val();
        const masterCards = masterCardsSnap.val();
        const userCards = userCardsSnap.val() || {};

        if (!trades || Object.keys(trades).length === 0) {
            listEl.innerHTML = `<p class="text-center text-gray-400">${mode === 'all' ? 'Åu anda pazarda aktif bir takas teklifi bulunmuyor.' : 'HenÃ¼z bir takas teklifi oluÅŸturmadÄ±n.'}</p>`;
            return;
        }

        listEl.innerHTML = '';
        const sortedTrades = Object.entries(trades).sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));

        for (const [tradeId, trade] of sortedTrades) {
            const offeredCard = masterCards[trade.offeredCardId];
            const requestedCard = masterCards[trade.requestedCardId];

            if (!offeredCard || !requestedCard) continue;

            let actionButton = '';
            if (mode === 'all') {
                const userHasDuplicate = userCards[trade.requestedCardId] && userCards[trade.requestedCardId].count > 1;
                const conflictingTradeId = myOfferedCardIds.get(trade.requestedCardId);
                const canTradeFromMarket = !userHasDuplicate && (userCards[trade.requestedCardId]?.count === 1) && conflictingTradeId;
                const canAccept = userHasDuplicate || canTradeFromMarket;
                const isMyOwnOffer = trade.offerer === currentUser;
                
                let tradeFromMarketAttr = '';
                if (canTradeFromMarket) {
                    tradeFromMarketAttr = `data-trade-from-market="true" data-conflicting-trade-id="${conflictingTradeId}"`;
                }

                if (isMyOwnOffer) {
                     actionButton = `<button disabled class="py-2 px-5 bg-gray-600 text-gray-400 rounded-lg text-sm font-bold cursor-not-allowed">Kendi Teklifin</button>`;
                } else {
                     actionButton = `
                        <button onclick="acceptTradeOffer('${tradeId}', this)" 
                                class="py-2 px-5 rounded-lg text-sm font-bold transition-colors ${canAccept ? 'bg-green-600 hover:bg-green-500 text-white' : 'bg-gray-600 text-gray-400 cursor-not-allowed'}"
                                ${!canAccept ? 'disabled title="Bu karttan takas edebileceÄŸin fazlan yok"' : ''}
                                ${tradeFromMarketAttr}>
                            TakasÄ± Yap
                        </button>
                    `;
                }
            } else { // mode === 'mine'
                actionButton = `<button onclick="cancelTradeOffer('${tradeId}')" class="py-2 px-5 bg-red-700 hover:bg-red-600 rounded-lg font-bold text-sm">Teklifi Ä°ptal Et</button>`;
            }
            
            if (isAdmin && mode === 'all' && trade.offerer !== currentUser) {
                 actionButton += `<button onclick="cancelTradeOffer('${tradeId}', true)" class="ml-2 py-2 px-3 bg-red-800 hover:bg-red-700 rounded-lg text-xs" title="Admin Olarak Ä°ptal Et">X</button>`;
            }

            // ... loadMarketOffers fonksiyonu iÃ§inde ...
const offerHtml = `
    <div class="market-offer-card">
        <div class="flex items-center gap-3 w-full">
            <div class="market-card-item rarity-${offeredCard.rarity || 'normal'}">
                <img class="market-card-image" src="${offeredCard.imageUrl}" alt="${offeredCard.cardName}">
            </div>
            <div class="market-card-info flex-grow">
                <p class="card-name">${offeredCard.cardName}</p>
                <p class="card-owner">Teklif Edilen Kart</p>
            </div>
        </div>
        
        <div class="self-center text-2xl font-bold text-gray-500 md:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
        </div>
        
        <div class="flex items-center gap-3 w-full">
            <div class="market-card-item rarity-${requestedCard.rarity || 'normal'}">
                <img class="market-card-image" src="${requestedCard.imageUrl}" alt="${requestedCard.cardName}">
            </div>
            <div class="market-card-info flex-grow">
                <p class="card-name">${requestedCard.cardName}</p>
                <p class="card-owner">Ä°stenen Kart</p>
            </div>
        </div>

        <hr class="border-gray-700 w-full md:hidden">
        
        <div class="w-full md:w-auto flex flex-col md:flex-row items-center gap-3 md:ml-auto">
             <p class="text-sm text-gray-300 md:hidden">
                Teklif Sahibi: <b class="text-yellow-400">${trade.offerer}</b>
             </p>
            <p class="hidden md:block text-sm text-gray-300">
                <b class="text-yellow-400">${trade.offerer}</b>
            </p>
            <div class="w-full md:w-auto">${actionButton}</div>
        </div>
    </div>
`;
listEl.innerHTML += offerHtml;

        }
    };
    
    activeListeners.marketOffers = { ref: tradesRef, event: 'value', callback };
    tradesRef.on('value', callback);
}

// --- YENÄ° FONKSÄ°YON ---
async function openCreateOfferModal(preselectedCardId = null) {
    // Ã–NCE KONTROL ET
    const userSnap = await db.ref(`users/${currentUser}`).once('value');
    const userData = userSnap.val() || {};
    if (userData.completedCollection === true) {
        displayMessage("Koleksiyonu tamamladÄ±ÄŸÄ±n iÃ§in artÄ±k yeni takas teklifi oluÅŸturamazsÄ±n.");
        return; // Fonksiyonu burada durdur, pencere aÃ§Ä±lmasÄ±n.
    }

    // Kontrolden geÃ§erse, eski kodun aynÄ±sÄ± devam etsin
    const myCardSelect = document.getElementById('offerMyCardSelect');
    const requestCardSelect = document.getElementById('offerRequestCardSelect');
    myCardSelect.innerHTML = '<option>YÃ¼kleniyor...</option>';
    requestCardSelect.innerHTML = '<option>YÃ¼kleniyor...</option>';

    const feeSnap = await db.ref('gameConfig/marketSettings/tradeFee').once('value');
    const tradeFee = feeSnap.val() || 0;
    
    const feeInfoEl = document.getElementById('tradeFeeInfo');
    if (tradeFee > 0) {
        feeInfoEl.innerHTML = `Bu teklifi oluÅŸturmak iÃ§in sizden <b class="text-yellow-400">${tradeFee} Puan</b> iÅŸlem Ã¼creti alÄ±nacaktÄ±r. <b class="text-red-400">Bu Ã¼cret, teklifi iptal etseniz bile iade edilmez.</b>`;
    } else {
        feeInfoEl.textContent = `Not: Takas iÅŸlemleri ÅŸu anda Ã¼cretsizdir.`;
    }

    const [userCardsSnap, masterCardsSnap] = await Promise.all([
        db.ref(`users/${currentUser}/cardCollection`).once('value'),
        db.ref('gameConfig/cardCollection').orderByChild('order').once('value')
    ]);

    const userCards = userCardsSnap.val() || {};
    const masterCards = masterCardsSnap.val() || {};

    myCardSelect.innerHTML = '';
    let hasDuplicates = false;
    for (const cardId in userCards) {
        if (userCards[cardId].count > 1) {
            const cardInfo = masterCards[cardId];
            if (cardInfo) {
                const option = document.createElement('option');
                option.value = cardId;
                option.textContent = cardInfo.cardName;
                myCardSelect.appendChild(option);
                hasDuplicates = true;
            }
        }
    }
    if (!hasDuplicates) {
        myCardSelect.innerHTML = '<option value="">Takas edilecek kartÄ±n yok</option>';
    }
    if (preselectedCardId) {
        myCardSelect.value = preselectedCardId;
    }

    requestCardSelect.innerHTML = '';
    for (const cardId in masterCards) {
        const cardInfo = masterCards[cardId];
        const option = document.createElement('option');
        option.value = cardId;
        option.textContent = cardInfo.cardName;
        requestCardSelect.appendChild(option);
    }
    
    document.getElementById('createOfferModal').style.display = 'flex';
}
      
// Yeni teklif oluÅŸturma penceresini kapatÄ±r
function closeCreateOfferModal() {
    document.getElementById('createOfferModal').style.display = 'none';
}

// submitTradeOffer FONKSÄ°YONUNU BULUP BU BLOK Ä°LE DEÄÄ°ÅTÄ°RÄ°N

async function submitTradeOffer() {
    const submitBtn = document.getElementById('submit-trade-offer-btn');
    if (!submitBtn) return;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Teklif OluÅŸturuluyor...';

    try {
        const offeredCardId = document.getElementById('offerMyCardSelect').value;
        const requestedCardId = document.getElementById('offerRequestCardSelect').value;

        if (!offeredCardId) {
            displayMessage("Teklif etmek iÃ§in en az bir karttan 2 adet veya daha fazlasÄ±na sahip olmalÄ±sÄ±n.");
            return;
        }
        if (offeredCardId === requestedCardId) {
            displayMessage("Bir kartÄ± kendisiyle takas edemezsin.");
            return;
        }

        const feeSnap = await db.ref('gameConfig/marketSettings/tradeFee').once('value');
        const tradeFee = feeSnap.val() || 0;

        const userSnap = await db.ref(`users/${currentUser}`).once('value');
        const userData = userSnap.val();

        // YENÄ° EKLENEN KISIM BAÅLANGICI: Koleksiyonu tamamlayanlarÄ±n yeni teklif oluÅŸturmasÄ±nÄ± engelle
        if (userData.completedCollection === true) {
            displayMessage("Koleksiyonu tamamladÄ±ÄŸÄ±n iÃ§in artÄ±k yeni takas teklifi oluÅŸturamazsÄ±n.");
            return; // Fonksiyonu burada durdur
        }
        // YENÄ° EKLENEN KISIM SONU

        if ((userData.balance || 0) < tradeFee) {
            displayMessage(`Teklif oluÅŸturmak iÃ§in gereken ${tradeFee} Puan iÅŸlem Ã¼cretine sahip deÄŸilsin.`);
            return;
        }

        const userCards = userData.cardCollection || {};
        const neededCard = !userCards[requestedCardId] || userCards[requestedCardId].count === 0;
        
        const userCardRef = db.ref(`users/${currentUser}/cardCollection/${offeredCardId}`);

        const { committed, snapshot } = await userCardRef.transaction(cardData => {
            if (!cardData || cardData.count <= 1) {
                return; 
            }
            cardData.count--;
            return cardData;
        });

        if (committed) {
            const masterCardsSnap = await db.ref('gameConfig/cardCollection').once('value');
            const masterCards = masterCardsSnap.val();
            const offeredCardName = masterCards[offeredCardId]?.cardName || 'Bilinmeyen Kart';
            const requestedCardName = masterCards[requestedCardId]?.cardName || 'Bilinmeyen Kart';
            
            const activityRef = db.ref('activityFeed').push();
            const activityId = activityRef.key;
            
            logActivity(
                'tradeOfferCreated', 
                currentUser, 
                {
                    offeredCardName: offeredCardName,
                    requestedCardName: requestedCardName,
                    fee: tradeFee,
                    status: 'active'
                },
                activityId
            );
            
            const newTradeRef = db.ref(`trades/${activityId}`);
            const newTrade = {
                offerer: currentUser,
                offeredCardId: offeredCardId,
                requestedCardId: requestedCardId,
                tradeFee: tradeFee, 
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                activityId: activityId,
                offererNeededCard: neededCard 
            };
            
            const updates = {};
            updates[`/trades/${newTradeRef.key}`] = newTrade;
            updates[`/users/${currentUser}/balance`] = userData.balance - tradeFee;
            updates[`/users/${currentUser}/totalSpentPoints`] = (userData.totalSpentPoints || 0) + tradeFee;

            await db.ref().update(updates);

            displayMessage("Takas teklifin baÅŸarÄ±yla pazara eklendi!");
            closeCreateOfferModal();
            switchMarketTab('mine');
            
            if (currentActiveSection === 'cardCollection') {
                loadCollectionAlbum();
            }
            
        } else {
            displayMessage("Hata: Bu karttan takas edebileceÄŸin fazlan kalmamÄ±ÅŸ.");
        }
    } catch (error) {
        console.error("Takas oluÅŸturma hatasÄ±:", error);
        displayMessage("Takas oluÅŸturulurken bir hata oluÅŸtu.");
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'TEKLÄ°FÄ° PAZARA KOY';
    }
}

// cancelTradeOffer FONKSÄ°YONUNU BUL VE BUNUNLA DEÄÄ°ÅTÄ°R
async function cancelTradeOffer(tradeId, asAdmin = false) {
    if (!tradeId) return;
    
    const tradeRef = db.ref(`trades/${tradeId}`);
    const tradeSnap = await tradeRef.once('value');
    const tradeData = tradeSnap.val();

    if (!tradeData) {
        displayMessage("Bu teklif zaten pazarda mevcut deÄŸil.");
        loadMarketOffers(asAdmin ? 'all' : 'mine');
        return;
    }
    
    const offererUsername = tradeData.offerer;
    const offeredCardId = tradeData.offeredCardId;
    const requestedCardId = tradeData.requestedCardId;
    const feeToRefund = tradeData.tradeFee || 0;
    const originalActivityId = tradeData.activityId;

    // --- YENÄ° KONTROL VE ONAY MANTIÄI BAÅLANGICI ---
    let willRefund = false;
    // Sadece admin deÄŸilse ve iade edilecek bir Ã¼cret varsa iade kontrolÃ¼ yap
    if (!asAdmin && feeToRefund > 0) {
        const userSnap = await db.ref(`users/${offererUsername}`).once('value');
        const userData = userSnap.val();
        const userCards = userData.cardCollection || {};

        // Ä°ade iÃ§in gereken iki ÅŸart:
        // 1. Teklif oluÅŸturulurken bu karta ihtiyacÄ± var mÄ±ydÄ±?
        const offerWasForNeededCard = tradeData.offererNeededCard === true;
        // 2. Åimdi bu karta sahip mi?
        const nowHasTheCard = (userCards[requestedCardId]?.count || 0) > 0;

        if (offerWasForNeededCard && nowHasTheCard) {
            willRefund = true;
        }
    }

    let confirmationMessage;
    if (asAdmin) {
        confirmationMessage = "Bu teklifi admin olarak zorla iptal etmek istediÄŸinize emin misiniz? Kart sahibine iade edilecek, iÅŸlem Ã¼creti iade edilmeyecektir.";
    } else if (willRefund) {
        confirmationMessage = `Bu teklifi iptal etmek istediÄŸine emin misin? Ä°htiyacÄ±n olan kartÄ± baÅŸka bir yolla bulduÄŸun iÃ§in, Ã¶dediÄŸin ${feeToRefund} Puan iÅŸlem Ã¼creti SANA Ä°ADE EDÄ°LECEK.`;
    } else {
        confirmationMessage = `Bu takas teklifini pazardan kaldÄ±rmak istediÄŸinize emin misiniz? Sadece kartÄ±nÄ±z iade edilecek, Ã¶dediÄŸiniz ${feeToRefund} Puan iÅŸlem Ã¼creti iade EDÄ°LMEYECEKTÄ°R.`;
    }
    const confirmed = await customConfirm(confirmationMessage);
    if (!confirmed) return;
    // --- YENÄ° KONTROL VE ONAY MANTIÄI SONU ---

    const userRef = db.ref(`users/${offererUsername}`);
    
    try {
        await userRef.transaction(userData => {
            if (userData) {
                // KartÄ± her zaman iade et
                if (!userData.cardCollection) userData.cardCollection = {};
                if (!userData.cardCollection[offeredCardId]) userData.cardCollection[offeredCardId] = { count: 0 };
                userData.cardCollection[offeredCardId].count++;

                // Sadece iade ÅŸartÄ± saÄŸlanÄ±yorsa Ã¼creti geri ver
                if (willRefund) {
                    userData.balance = (userData.balance || 0) + feeToRefund;
                    userData.totalSpentPoints = Math.max(0, (userData.totalSpentPoints || 0) - feeToRefund);
                }
            }
            return userData;
        });
        
        await tradeRef.remove();
        
        if (originalActivityId) {
            await db.ref(`activityFeed/${originalActivityId}/details/status`).set('cancelled');
        }

        if (asAdmin) {
            logActivity('tradeOfferCancelledByAdmin', 'WeizendTv', { offerer: offererUsername });
            displayMessage("Teklif admin tarafÄ±ndan iptal edildi. Kart sahibine iade edildi.");
            loadMarketOffers('all');
        } else {
            // BaÅŸarÄ± mesajÄ±nÄ± da duruma gÃ¶re dinamik yapalÄ±m
            if (willRefund) {
                displayMessage(`Teklifin iptal edildi. KartÄ±n ve ${feeToRefund} Puan iÅŸlem Ã¼cretin iade edildi.`);
            } else {
                displayMessage("Teklifin pazardan kaldÄ±rÄ±ldÄ±. KartÄ±n envanterine geri eklendi.");
            }
            loadMarketOffers('mine');
        }

        if (currentActiveSection === 'cardCollection') {
            loadCollectionAlbum();
        }

    } catch(error) {
        console.error("Takas iptal etme hatasÄ±:", error);
        displayMessage("Takas iptal edilirken bir hata oluÅŸtu.");
    }
}
      
let packsToReveal = [];
let packsRevealedCount = 0;

// MEVCUT startCardPackOpening FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR

async function startCardPackOpening(packCount, source = 'Bilinmeyen Kaynak', multiplier = 1, packType = 'card_pack') {
    if (packCount <= 0) return;
    
    // Koleksiyonu tamamlayan kullanÄ±cÄ±larÄ±n da paket aÃ§abilmesi iÃ§in kontrol kaldÄ±rÄ±ldÄ±.
    
    const masterCardsSnap = await db.ref('gameConfig/cardCollection').once('value');
    const masterCards = masterCardsSnap.val();
    if (!masterCards) {
        displayMessage("Kart paketi aÃ§Ä±lamadÄ±: Oyunda hiÃ§ kart tanÄ±mlanmamÄ±ÅŸ.");
        return;
    }

    let cardPool = [];
    const rarityMap = {
        'card_pack_efsanevi': 'efsanevi',
        'card_pack_altin': 'altin',
        'card_pack_gumus': 'gumus',
        'card_pack_normal': 'normal'
    };
    const targetRarity = rarityMap[packType];

    for (const cardId in masterCards) {
        const card = { id: cardId, ...masterCards[cardId] };
        if (targetRarity) {
            if (card.rarity === targetRarity) {
                cardPool.push(card);
            }
        } else {
            cardPool.push(card);
        }
    }
    
    if (cardPool.length === 0) {
        displayMessage(`Bu paketten kart Ã§Ä±kmadÄ± Ã§Ã¼nkÃ¼ oyunda hiÃ§ '${targetRarity}' nadirlikte kart tanÄ±mlanmamÄ±ÅŸ. Telafi olarak +500 Puan kazandÄ±n!`);
        const userRef = db.ref(`users/${currentUser}`);
        await userRef.transaction(user => {
            if (user) {
                user.balance = (user.balance || 0) + 500;
                user.kariyerPuani = (user.kariyerPuani || 0) + 500;
            }
            return user;
        });
        return;
    }

    const weightedCardList = [];
    let totalWeight = 0;
    cardPool.forEach(card => {
        const chance = card.chance || 1;
        weightedCardList.push({ ...card, chance: chance });
        totalWeight += chance;
    });

    if (totalWeight === 0) {
        displayMessage("Kart paketi aÃ§Ä±lamadÄ±: KartlarÄ±n ÅŸans aÄŸÄ±rlÄ±klarÄ± toplamÄ± sÄ±fÄ±r.");
        return;
    }

    packsToReveal = [];
    packsRevealedCount = 0;

    for (let i = 0; i < packCount; i++) {
        let randomWeight = Math.random() * totalWeight;
        let chosenCard = null;
        for (const card of weightedCardList) {
            randomWeight -= card.chance;
            if (randomWeight <= 0) {
                chosenCard = card;
                break;
            }
        }
        packsToReveal.push(chosenCard || weightedCardList[weightedCardList.length - 1]);
    }

    const modal = document.getElementById('cardPackOpeningModal');
    const area = document.getElementById('cardPackOpeningArea');
    const title = document.getElementById('cardPackOpeningTitle');
    title.textContent = `${packCount} Kart Paketini AÃ§!`;
    area.innerHTML = '';

    const packInfoMap = {
        'card_pack_efsanevi': { className: 'pack-front-efsanevi', icon: 'ğŸ†' },
        'card_pack_altin': { className: 'pack-front-altin', icon: 'ğŸ¥‡' },
        'card_pack_gumus': { className: 'pack-front-gumus', icon: 'ğŸ¥ˆ' },
        'card_pack_normal': { className: 'pack-front-normal', icon: 'ğŸ¥‰' },
        'card_pack': { className: 'pack-front-standart', icon: 'ğŸ´' }
    };
    const packInfo = packInfoMap[packType] || packInfoMap['card_pack'];

    for (let i = 0; i < packCount; i++) {
        const cardHtml = `
            <div class="card-flip-container" data-index="${i}" onclick="revealCard(this)">
                <div class="card-flipper">
                    <div class="card-front ${packInfo.className}">
                        <span class="pack-icon">${packInfo.icon}</span>
                    </div>
                    <div class="card-back"></div>
                </div>
            </div>
        `;
        area.innerHTML += cardHtml;
    }

    modal.style.display = 'flex';
}

async function revealCard(cardElement) {
    if (cardElement.classList.contains('flipped')) return; 

    cardElement.classList.add('flipped');
    const index = cardElement.getAttribute('data-index');
    const wonCard = packsToReveal[index];

    const cardBack = cardElement.querySelector('.card-back');
    const cardItemHtml = `
        <div class="card-item rarity-${wonCard.rarity || 'normal'}" style="width:100%; height:100%;">
            <img class="card-image" src="${wonCard.imageUrl}">
            <h4 class="card-name">${wonCard.cardName}</h4>
        </div>
    `;
    cardBack.innerHTML = cardItemHtml;

    // --- YENÄ° EKLENEN KISIM BAÅLANGICI ---
    // KullanÄ±cÄ±nÄ±n ilk kartÄ±nÄ± aldÄ±ÄŸÄ± anÄ± kaydetmek iÃ§in Transaction kullanÄ±yoruz.
    const userRef = db.ref(`users/${currentUser}`);
    await userRef.transaction(userData => {
        if (userData) {
            // EÄŸer kullanÄ±cÄ±nÄ±n daha Ã¶nce hiÃ§ kartÄ± yoksa, ilk kart zaman damgasÄ±nÄ± ekle
            if (!userData.cardCollection) {
                userData.cardCollection = {};
                // SÄ±ralama iÃ§in gereken zaman damgasÄ±nÄ± ekliyoruz
                if (!userData.collectionInfo) {
                    userData.collectionInfo = {};
                }
                userData.collectionInfo.firstCardTimestamp = firebase.database.ServerValue.TIMESTAMP;
            }
            
            // Kart sayÄ±sÄ±nÄ± artÄ±r
            if (!userData.cardCollection[wonCard.id]) {
                userData.cardCollection[wonCard.id] = { count: 0 };
            }
            userData.cardCollection[wonCard.id].count++;
        }
        return userData;
    });
    // --- YENÄ° EKLENEN KISIM SONU ---
    
    newlyAcquiredCards.add(wonCard.id); // KartÄ± "yeni" olarak iÅŸaretle

    packsRevealedCount++;
    
    if (packsRevealedCount >= packsToReveal.length) {
        checkAndGrantPrize(currentUser); 
        setTimeout(() => {
            document.getElementById('cardPackOpeningModal').style.display = 'none';
            if (currentActiveSection === 'cardCollection') {
                loadCollectionAlbum();
            }
        }, 2000); 
    }
}

async function saveGrandPrize() {
    if (!isAdmin) return;
    const prizeData = {
        points: parseInt(document.getElementById('prizePoints').value) || 0,
        boxRights: parseInt(document.getElementById('prizeBoxRights').value) || 0,
        iflasShields: parseInt(document.getElementById('prizeIflasShields').value) || 0, // DEÄÄ°ÅTÄ°
        wheelTickets: parseInt(document.getElementById('prizeWheelTickets').value) || 0,
        clickCatchTickets: parseInt(document.getElementById('prizeClickCatchTickets').value) || 0,
        avatarName: document.getElementById('prizeAvatarName').value.trim() || '', // YENÄ° EKLENDÄ°
        avatarImageUrl: document.getElementById('prizeAvatarImageUrl').value.trim() || '', // YENÄ° EKLENDÄ°
        description: document.getElementById('prizeDescription').value.trim() || ''
    };

    await db.ref('gameConfig/collectionGrandPrize').set(prizeData);
    displayMessage("BÃ¼yÃ¼k Ã–dÃ¼l baÅŸarÄ±yla kaydedildi!");
    loadGrandPrizeDisplay();
}

async function loadPrizeSettingsForAdmin() {
    if (!isAdmin) return;
    const prizeSnap = await db.ref('gameConfig/collectionGrandPrize').once('value');
    const prizeData = prizeSnap.val() || {};
    
    document.getElementById('prizePoints').value = prizeData.points || '';
    document.getElementById('prizeBoxRights').value = prizeData.boxRights || '';
    document.getElementById('prizeIflasShields').value = prizeData.iflasShields || ''; // DEÄÄ°ÅTÄ°
    document.getElementById('prizeWheelTickets').value = prizeData.wheelTickets || '';
    document.getElementById('prizeClickCatchTickets').value = prizeData.clickCatchTickets || '';
    document.getElementById('prizeAvatarName').value = prizeData.avatarName || ''; // YENÄ° EKLENDÄ°
    document.getElementById('prizeAvatarImageUrl').value = prizeData.avatarImageUrl || ''; // YENÄ° EKLENDÄ°
    document.getElementById('prizeDescription').value = prizeData.description || '';
}

async function loadGrandPrizeDisplay() {
    const prizeRef = db.ref('gameConfig/collectionGrandPrize');
    const prizeSnap = await prizeRef.once('value');
    const prizeData = prizeSnap.val();
    
    const displayContainer = document.getElementById('grandPrizeDisplay');
    const prizeList = document.getElementById('prizeList');

    // DEÄÄ°ÅEN KONTROL: Yeni alanlarÄ± da kontrol et
    if (!prizeData || (prizeData.points === 0 && prizeData.boxRights === 0 && prizeData.iflasShields === 0 && prizeData.wheelTickets === 0 && prizeData.clickCatchTickets === 0 && prizeData.avatarName === '' && prizeData.description === '')) {
        displayContainer.classList.add('hidden');
        return;
    }

    prizeList.innerHTML = '';
    if (prizeData.points > 0) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ’° ${formatNumber(prizeData.points)} Puan</div>`;
    if (prizeData.boxRights > 0) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ ${formatNumber(prizeData.boxRights)} Kutu HakkÄ±</div>`;
    if (prizeData.iflasShields > 0) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ›¡ï¸ ${formatNumber(prizeData.iflasShields)} Ä°flas KalkanÄ±</div>`; // DEÄÄ°ÅTÄ°
    if (prizeData.wheelTickets > 0) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ¡ ${formatNumber(prizeData.wheelTickets)} Ã‡ark Bileti</div>`;
    if (prizeData.clickCatchTickets > 0) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸŸï¸ ${formatNumber(prizeData.clickCatchTickets)} T-Y Bileti</div>`;
    if (prizeData.avatarName) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ‘¤ Ã–zel Avatar: ${prizeData.avatarName}</div>`; // YENÄ° EKLENDÄ°
    if (prizeData.description) prizeList.innerHTML += `<div class="text-white font-bold text-lg">ğŸ† ${prizeData.description}</div>`;
    
    displayContainer.classList.remove('hidden');
}

async function checkAndGrantPrize(username) {
    const userRef = db.ref(`users/${username}`);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();

    // EÄŸer kullanÄ±cÄ± zaten koleksiyonu tamamlamÄ±ÅŸsa, tekrar Ã¶dÃ¼l verme.
    if (userData.completedCollection === true) {
        return;
    }

    const userCards = userData.cardCollection || {};
    const ownedCardCount = Object.keys(userCards).length;

    const masterListSnap = await db.ref('gameConfig/cardCollection').once('value');
    const masterList = masterListSnap.val();
    if (!masterList) return;
    const totalCardCount = Object.keys(masterList).length;

    // EÄŸer kullanÄ±cÄ±nÄ±n kart sayÄ±sÄ± toplam kart sayÄ±sÄ±na eÅŸit veya fazlaysa Ã¶dÃ¼l sÃ¼recini baÅŸlat.
    if (ownedCardCount >= totalCardCount) {
        const prizeSnap = await db.ref('gameConfig/collectionGrandPrize').once('value');
        const prizeData = prizeSnap.val();
        if (!prizeData) return;

        const finishersRef = db.ref('gameStats/collectionFinishers');
        
        // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR â˜…â˜…â˜…
        // KullanÄ±cÄ±yÄ± eklemeden Ã–NCE mevcut bitirenlerin sayÄ±sÄ±nÄ± alÄ±yoruz.
        const finishersSnap = await finishersRef.once('value');
        const finisherCount = finishersSnap.exists() ? finishersSnap.numChildren() : 0;
        const rank = finisherCount + 1; // Yeni bitirenin sÄ±rasÄ±
        const isFirstWinner = rank === 1; // Sadece 1. kiÅŸi ise true olacak
        // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA BÄ°TÄ°YOR â˜…â˜…â˜…

        // Yeni bitireni listeye ekle
        await finishersRef.push({
            username: username,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        // Ã–dÃ¼lleri ve kullanÄ±cÄ± durumunu gÃ¼ncellemek iÃ§in bir obje hazÄ±rla
        const updates = {};
        updates.balance = (userData.balance || 0) + (prizeData.points || 0);
        updates.kutuHakki = (userData.kutuHakki || 0) + (prizeData.boxRights || 0);
        updates.iflasShieldUses = (userData.iflasShieldUses || 0) + (prizeData.iflasShields || 0);
        updates.carkBileti = (userData.carkBileti || 0) + (prizeData.wheelTickets || 0);
        updates.clickCatchTickets = (userData.clickCatchTickets || 0) + (prizeData.clickCatchTickets || 0);
        updates.completedCollection = true; // Koleksiyonu tamamladÄ± olarak iÅŸaretle

        // Avatar Ã¶dÃ¼lÃ¼ varsa ekle
        if (prizeData.avatarName && prizeData.avatarImageUrl) {
            const newAvatarId = db.ref().push().key;
            updates[`avatars/${newAvatarId}`] = {
                id: newAvatarId,
                name: prizeData.avatarName,
                imageUrl: prizeData.avatarImageUrl
            };
        }
        
        // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR: SADECE Ä°LK KAZANANA BAÅARIM VER â˜…â˜…â˜…
        // KalÄ±cÄ± koleksiyon ÅŸampiyonluÄŸu baÅŸarÄ±mÄ± SADECE Ä°LK BÄ°TÄ°RENE verilecek.
        if (isFirstWinner) {
            await userRef.child('collectionChampionshipsWon').transaction(currentCount => {
                return (currentCount || 0) + 1;
            });
        }
        // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA BÄ°TÄ°YOR â˜…â˜…â˜…
        
        await userRef.update(updates);

        // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR: DÄ°NAMÄ°K BÄ°LDÄ°RÄ°M MESAJI â˜…â˜…â˜…
        // KullanÄ±cÄ±ya gÃ¶sterilecek mesajÄ± sÄ±rasÄ±na gÃ¶re ayarla
        let prizeMessage = ``;
        if (isFirstWinner) {
            prizeMessage += `Ä°NANILMAZ! Koleksiyonu tamamlayan Ä°LK KÄ°ÅÄ° oldun ve bÃ¼yÃ¼k Ã¶dÃ¼lleri kazandÄ±n:`;
        } else {
            prizeMessage += `TEBRÄ°KLER! Koleksiyonu tamamlayan ${rank}. kiÅŸi oldun ve bÃ¼yÃ¼k Ã¶dÃ¼lleri kazandÄ±n:`;
        }
        // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA BÄ°TÄ°YOR â˜…â˜…â˜…

        let prizeParts = [];
        if (prizeData.points > 0) prizeParts.push(` ${formatNumber(prizeData.points)} Puan`);
        if (prizeData.boxRights > 0) prizeParts.push(` ${formatNumber(prizeData.boxRights)} Kutu HakkÄ±`);
        if (prizeData.iflasShields > 0) prizeParts.push(` ${formatNumber(prizeData.iflasShields)} Ä°flas KalkanÄ±`);
        if (prizeData.wheelTickets > 0) prizeParts.push(` ${formatNumber(prizeData.wheelTickets)} Ã‡ark Bileti`);
        if (prizeData.clickCatchTickets > 0) prizeParts.push(` ${formatNumber(prizeData.clickCatchTickets)} T-Y Bileti`);
        if (prizeData.avatarName) prizeParts.push(` '${prizeData.avatarName}' AvatarÄ±`);

        prizeMessage += prizeParts.join(',');
        prizeMessage += `!`;

        displayMessage(prizeMessage);

        // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR: logActivity'e rank bilgisini de gÃ¶nderiyoruz â˜…â˜…â˜…
        // Son Eylemler paneline de doÄŸru sÄ±ra bilgisiyle kayÄ±t dÃ¼ÅŸ
        logActivity('collectionCompleted', username, { 
            prizeText: 'BÃ¼yÃ¼k Ã–dÃ¼l',
            isFirst: isFirstWinner,
            rank: rank 
        });
        // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA BÄ°TÄ°YOR â˜…â˜…â˜…
    }
}

async function loadCollectionFinishers() {
    const leaderboardContainer = document.getElementById('collectionFinishersLeaderboard');
    const listEl = document.getElementById('finishersList');
    listEl.innerHTML = '<p class="text-gray-400">SÄ±ralama yÃ¼kleniyor...</p>';

    const finishersRef = db.ref('gameStats/collectionFinishers').orderByChild('timestamp');

    finishersRef.on('value', async (snapshot) => {
        if (!snapshot.exists()) {
            leaderboardContainer.classList.add('hidden');
            return;
        }

        // Gerekli tÃ¼m verileri tek seferde ve en baÅŸta Ã§ekiyoruz
        const [masterCardsSnap, allUsersSnap] = await Promise.all([
            db.ref('gameConfig/cardCollection').once('value'),
            db.ref('users').once('value')
        ]);
        
        const masterCards = masterCardsSnap.val() || {};
        const allUsersData = allUsersSnap.val() || {};
        const totalCardCount = Object.keys(masterCards).length;

        leaderboardContainer.classList.remove('hidden');
        const finishers = [];
        snapshot.forEach(childSnapshot => {
            finishers.push(childSnapshot.val());
        });

        let html = '';
        finishers.forEach((finisher, index) => {
            const rank = index + 1;
            const rankIcon = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : `${rank}.`));
            const rowClass = rank === 1 ? 'bg-amber-800/50 border-amber-500' : 'bg-gray-700/50 border-gray-600';
            
            // KullanÄ±cÄ±nÄ±n kart bilgilerini al
            const userData = allUsersData[finisher.username] || {};
            const ownedCardCount = Object.keys(userData.cardCollection || {}).length;

            let progressHtml = '';
            // TamamlamÄ±ÅŸsa "TamamlandÄ±" yaz
            if (ownedCardCount >= totalCardCount) {
                progressHtml = `<span class="font-bold text-green-400">TamamlandÄ±</span>`;
            } else {
            // TamamlamamÄ±ÅŸsa ilerlemesini gÃ¶ster ve tÄ±klanabilir yap
                progressHtml = `
                    <span class="font-bold text-yellow-300 cursor-pointer hover:underline" onclick="openMissingCardsModal('${finisher.username}')">
                        ${ownedCardCount}/${totalCardCount}
                    </span>
                `;
            }

            html += `
                <div class="flex items-center justify-between p-3 rounded-lg border ${rowClass}">
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-xl w-8 text-center">${rankIcon}</span>
                        <span class="text-lg text-white cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${finisher.username}')">
                            ${finisher.username}
                        </span>
                    </div>
                    <div class="text-right">
                        ${progressHtml}
                        <div class="text-xs text-gray-400 mt-1">${new Date(finisher.timestamp).toLocaleString('tr-TR')}</div>
                    </div>
                </div>
            `;
        });
        listEl.innerHTML = html;
    });
}

// YENÄ° EKLENECEK FONKSÄ°YONLAR BAÅLANGICI

// Eksik kartlar penceresini kapatÄ±r
function closeMissingCardsModal() {
    document.getElementById('missingCardsModal').style.display = 'none';
}

// Bir kullanÄ±cÄ±nÄ±n eksik kartlarÄ±nÄ± gÃ¶steren pencereyi aÃ§ar
async function openMissingCardsModal(username) {
    const modal = document.getElementById('missingCardsModal');
    const title = document.getElementById('missingCardsTitle');
    const listEl = document.getElementById('missingCardsList');
    
    title.textContent = `${username}'nin Eksik KartlarÄ±`;
    listEl.innerHTML = '<p class="text-center col-span-full text-gray-400">YÃ¼kleniyor...</p>';
    modal.style.display = 'flex';

    try {
        // Gerekli tÃ¼m verileri aynÄ± anda Ã§ekelim
        const [masterCardsSnap, userSnap] = await Promise.all([
            db.ref('gameConfig/cardCollection').orderByChild('order').once('value'),
            db.ref(`users/${username}`).once('value')
        ]);

        if (!masterCardsSnap.exists()) {
            listEl.innerHTML = '<p class="text-center col-span-full text-red-500">Hata: Ana kart listesi bulunamadÄ±.</p>';
            return;
        }

        const masterCards = masterCardsSnap.val();
        const userData = userSnap.val() || {};
        const userCards = userData.cardCollection || {};
        
        const missingCards = [];
        // Ana listedeki her kartÄ± kontrol et
        for (const cardId in masterCards) {
            // EÄŸer kart kullanÄ±cÄ±nÄ±n koleksiyonunda yoksa, eksik listesine ekle
            if (!userCards[cardId]) {
                missingCards.push(masterCards[cardId]);
            }
        }
        
        if (missingCards.length === 0) {
            listEl.innerHTML = '<p class="text-center col-span-full text-green-400 font-bold text-xl">Bu kullanÄ±cÄ± koleksiyonu tamamlamÄ±ÅŸ!</p>';
            return;
        }

        let html = '';
        missingCards.forEach(cardInfo => {
            // Eksik kartlarÄ± da albÃ¼mdeki gibi gÃ¶sterelim
            html += `
                <div class="card-slot">
                    <div class="card-item missing relative" style="border-style: solid; background-color: #1f2937;">
                        <img class="card-image" src="${cardInfo.imageUrl}">
                        <h4 class="card-name">${cardInfo.cardName}</h4>
                    </div>
                </div>
            `;
        });
        listEl.innerHTML = html;

    } catch (error) {
        console.error("Eksik kartlar yÃ¼klenirken hata:", error);
        listEl.innerHTML = '<p class="text-center col-span-full text-red-500">Veriler yÃ¼klenirken bir hata oluÅŸtu.</p>';
    }
}
// YENÄ° EKLENECEK FONKSÄ°YONLAR SONU

function openCollectionInfoModal() {
    document.getElementById('collectionInfoModal').style.display = 'flex';
}

function closeCollectionInfoModal() {
    document.getElementById('collectionInfoModal').style.display = 'none';
}

// MEVCUT openUserProfile FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIR
async function openUserProfile(username) {
    if (!username) {
        console.error("Profil aÃ§ma hatasÄ±: KullanÄ±cÄ± adÄ± belirtilmedi.");
        return;
    }

    const modal = document.getElementById('userProfileModal');
    if (!modal) {
        console.error("Profil aÃ§ma hatasÄ±: userProfileModal elementi bulunamadÄ±.");
        return;
    }

    // Modal iÃ§eriÄŸini temizle ve yÃ¼kleniyor gÃ¶stergesi ekle
    document.getElementById('profileUsername').textContent = 'YÃ¼kleniyor...';
    document.getElementById('profileAvatar').src = 'default_avatar.png'; // VarsayÄ±lan avatar
    document.getElementById('profileBalance').textContent = '...';
    document.getElementById('profileKutuHakki').textContent = '...';
    document.getElementById('profileCarkBileti').textContent = '...';
    document.getElementById('profileClickCatchTickets').textContent = '...';
    document.getElementById('profileIflasShield').textContent = '...';
    document.getElementById('profileKariyerPuani').textContent = '...';
    document.getElementById('profileAchievementsSection').classList.add('hidden');
    document.getElementById('profileAchievementsList').innerHTML = '';
    
    modal.style.display = 'flex'; // Ã–nce modalÄ± gÃ¶ster

    const userSnap = await db.ref('users/' + username).once('value');
    const user = userSnap.val();

    if (!user) {
        displayMessage(`${username} adlÄ± kullanÄ±cÄ± bulunamadÄ±.`);
        closeUserProfileModal(); // KullanÄ±cÄ± yoksa modalÄ± kapat
        return;
    }

    document.getElementById('profileUsername').textContent = username;
    document.getElementById('profileAvatar').src = user.avatarUrl || 'default_avatar.png';
    document.getElementById('profileBalance').textContent = formatNumber(user.balance || 0);
    document.getElementById('profileKutuHakki').textContent = formatNumber(user.kutuHakki || 0);
    document.getElementById('profileCarkBileti').textContent = formatNumber(user.carkBileti || 0);
    document.getElementById('profileClickCatchTickets').textContent = formatNumber(user.clickCatchTickets || 0);
    document.getElementById('profileIflasShield').textContent = formatNumber(user.iflasShieldUses || 0);
    document.getElementById('profileKariyerPuani').textContent = formatNumber(user.kariyerPuani || 0);

    // BaÅŸarÄ±mlar bÃ¶lÃ¼mÃ¼nÃ¼ yÃ¶net
    const achievementsSection = document.getElementById('profileAchievementsSection');
    const achievementsList = document.getElementById('profileAchievementsList');
    if (user.achievements && Object.keys(user.achievements).length > 0) {
        achievementsList.innerHTML = '';
        for(const key in user.achievements) {
            achievementsList.innerHTML += `<li>${user.achievements[key]}</li>`;
        }
        achievementsSection.classList.remove('hidden');
    } else {
        achievementsSection.classList.add('hidden');
    }

    // Admin kontrol butonlarÄ±nÄ± ayarla
    const adminControls = document.getElementById('adminProfileControls');
    if (isAdmin && adminControls) {
        adminControls.classList.remove('hidden');
        adminControls.innerHTML = `
            <input type="number" id="adminPointsInput" class="box-setting-input" placeholder="Puan Ekle/Ã‡Ä±kar">
            <button onclick="adjustUserPoints('${username}')" class="py-2 px-4 bg-green-600 rounded-lg">Uygula</button>
            <input type="number" id="adminKasaPointsInput" class="box-setting-input" placeholder="Kasa PuanÄ± Ekle/Ã‡Ä±kar">
            <button onclick="adjustUserKasaPoints('${username}')" class="py-2 px-4 bg-blue-600 rounded-lg">Uygula</button>
        `;
    }
}

// BÃ¼yÃ¼k Ã–dÃ¼l AyarlarÄ± modalÄ±nÄ± aÃ§ar
function openGrandPrizeSettings() {
    if (!isAdmin) return;
    loadPrizeSettingsForAdmin(); // KayÄ±tlÄ± ayarlarÄ± input'lara yÃ¼kle
    document.getElementById('grandPrizeSettingsModal').style.display = 'flex';
}

// BÃ¼yÃ¼k Ã–dÃ¼l AyarlarÄ± modalÄ±nÄ± kapatÄ±r
function closeGrandPrizeSettingsModal() {
    document.getElementById('grandPrizeSettingsModal').style.display = 'none';
}

// Ã–dÃ¼lÃ¼ kaydeder VE modalÄ± kapatÄ±r
async function saveGrandPrizeAndCloseModal() {
    await saveGrandPrize(); // Zaten var olan kaydetme fonksiyonunu Ã§aÄŸÄ±r
    closeGrandPrizeSettingsModal(); // ModalÄ± kapat
}

      // YENÄ° AKILLI FONKSÄ°YON: Sezonu baÅŸlatÄ±r veya bitirir.
async function toggleCardSeason() {
    if (!isAdmin) return;

    // 1. Mevcut sezon durumunu kontrol et
    const statusRef = db.ref('gameConfig/cardCollectionStatus');
    const statusSnap = await statusRef.once('value');
    const currentStatus = statusSnap.val() || 'inactive';

    // 2. EÄŸer sezon aktifse, BÄ°TÄ°RME iÅŸlemini yap
    if (currentStatus === 'active') {
        const confirmed = await customConfirm("Bu iÅŸlem mevcut sezonu sonlandÄ±racak. TÃ¼m kullanÄ±cÄ±larÄ±n topladÄ±ÄŸÄ± kartlar, joker kartlarÄ± ve koleksiyon tamamlama durumlarÄ± sÄ±fÄ±rlanacak. ANA KART LÄ°STENÄ°Z SÄ°LÄ°NMEZ. Emin misiniz?");
        if (!confirmed) return;

        try {
            const updates = {};
            updates['/gameConfig/cardCollectionStatus'] = 'inactive';
            updates['/gameConfig/collectionWinner'] = null;

            const usersSnap = await db.ref('users').once('value');
            if (usersSnap.exists()) {
                usersSnap.forEach(userSnap => {
                    const username = userSnap.key;
                    updates[`/users/${username}/cardCollection`] = null;
                    updates[`/users/${username}/completedCollection`] = null;
                    updates[`/users/${username}/wildcards`] = 0; 
                });
            }
            await db.ref().update(updates);
            displayMessage("Sezon baÅŸarÄ±yla bitirildi! TÃ¼m kullanÄ±cÄ±larÄ±n kart ilerlemesi sÄ±fÄ±rlandÄ±.");
            loadCollectionAlbum(); // ArayÃ¼zÃ¼ gÃ¼ncelle
        } catch (error) {
            console.error("Sezon bitirilirken hata oluÅŸtu:", error);
            displayMessage("Sezon bitirilirken bir hata meydana geldi.");
        }
    } 
    // 3. EÄŸer sezon aktif deÄŸilse (bitmiÅŸ veya duraklatÄ±lmÄ±ÅŸsa), YENÄ° SEZON BAÅLATMA iÅŸlemini yap
    else {
        const confirmed = await customConfirm("Bu iÅŸlem mevcut tÃ¼m kartlarÄ±, kullanÄ±cÄ± ilerlemelerini ve ÅŸampiyonluklarÄ± SÄ°LEREK yepyeni bir sezon baÅŸlatacaktÄ±r. Emin misiniz?");
        if (!confirmed) return;

        await resetWholeCollection(); // Bu fonksiyon zaten ilerlemeyi sÄ±fÄ±rlÄ±yor
        await statusRef.set('active');
        displayMessage("YENÄ° KOLEKSÄ°YON SEZONU BAÅLATILDI!");
        loadCollectionAlbum(); // ArayÃ¼zÃ¼ gÃ¼ncelle
    }
}

// YENÄ° VE GÃœNCEL FONKSÄ°YONU EKLE
async function toggleCollectionPause() {
    if (!isAdmin) return;

    const statusRef = db.ref('gameConfig/cardCollectionStatus');
    const statusSnap = await statusRef.once('value');
    const currentStatus = statusSnap.val();

    // Buton ve yazÄ± elementlerini en baÅŸta seÃ§elim
    const pauseBtn = document.getElementById('pauseResumeButton');
    const statusTextEl = document.getElementById('collectionStatusText');

    if (currentStatus === 'active') {
        await statusRef.set('paused');
        displayMessage("Koleksiyon sezonu duraklatÄ±ldÄ±. Oyuncular bakÄ±m bilgilendirmesi gÃ¶recek.");

        // --- YENÄ° EKLENEN ANINDA GÃœNCELLEME KODLARI ---
        statusTextEl.textContent = 'DuraklatÄ±ldÄ± (BakÄ±mda)';
        pauseBtn.textContent = 'Sezonu Devam Ettir';
        pauseBtn.classList.replace('bg-orange-600', 'bg-green-600');
        pauseBtn.classList.replace('hover:bg-orange-500', 'hover:bg-green-500');
        // --- GÃœNCELLEME BÄ°TTÄ° ---

    } else if (currentStatus === 'paused') {
        await statusRef.set('active');
        displayMessage("Koleksiyon sezonu devam ettiriliyor.");

        // --- YENÄ° EKLENEN ANINDA GÃœNCELLEME KODLARI ---
        statusTextEl.textContent = 'Aktif';
        pauseBtn.textContent = 'Sezonu Duraklat';
        pauseBtn.classList.replace('bg-green-600', 'bg-orange-600');
        pauseBtn.classList.replace('hover:bg-green-500', 'hover:bg-orange-500');
        // --- GÃœNCELLEME BÄ°TTÄ° ---

    } else {
        displayMessage("Sezon sadece 'aktif' veya 'duraklatÄ±lmÄ±ÅŸ' durumdayken bu iÅŸlem yapÄ±labilir.");
    }
}

// BU FONKSÄ°YONU SCRIPT BLOÄUNUN Ä°Ã‡Ä°NE EKLE
function formatNumber(num) {
  if (num === null || num === undefined) {
    return 0;
  }
  return num.toLocaleString('tr-TR');
}

// Kasa AyarlarÄ± penceresini aÃ§ar ve mevcut ayarÄ± input'a yazar
async function openKasaSettingsModal() {
    if (!isAdmin) return;
    const settingsSnap = await db.ref('gameConfig/kasaSettings').once('value');
    const minAmount = settingsSnap.val()?.minTransferAmount || 0;
    document.getElementById('minKasaTransferInput').value = minAmount;
    document.getElementById('kasaSettingsModal').style.display = 'flex';
}

// Kasa AyarlarÄ± penceresini kapatÄ±r
function closeKasaSettingsModal() {
    document.getElementById('kasaSettingsModal').style.display = 'none';
}

// Kasa AyarlarÄ±nÄ± Firebase'e kaydeder
async function saveKasaSettings() {
    if (!isAdmin) return;
    const minAmount = parseInt(document.getElementById('minKasaTransferInput').value);

    if (isNaN(minAmount) || minAmount < 0) {
        displayMessage("LÃ¼tfen geÃ§erli bir minimum tutar girin (0 veya daha bÃ¼yÃ¼k bir sayÄ±).");
        return;
    }

    await db.ref('gameConfig/kasaSettings/minTransferAmount').set(minAmount);
    displayMessage(`Minimum kasa transfer tutarÄ± baÅŸarÄ±yla ${minAmount} olarak ayarlandÄ±.`);
    closeKasaSettingsModal();
}

// --- YENÄ° Ã‡ARPAN SEÃ‡Ä°M SÄ°STEMÄ° FONKSÄ°YONLARI ---

// Hangi seÃ§imin beklendiÄŸini tutan global deÄŸiÅŸken
let pendingMultiplierChoice = null;

// SeÃ§im penceresini aÃ§ar ve iÃ§ini doldurur
function openMultiplierChoiceModal(existingMultiplier, foundMultiplier, boxId) {
    const modal = document.getElementById('multiplierChoiceModal');
    const infoEl = document.getElementById('multiplierChoiceInfo');
    const convertBtn = document.getElementById('choiceConvertBtn');
    const combineBtn = document.getElementById('choiceCombineBtn');

    // Bekleyen seÃ§imi global deÄŸiÅŸkene kaydet
    pendingMultiplierChoice = {
        existing: existingMultiplier,
        found: foundMultiplier,
        boxId: boxId
    };

    // SeÃ§eneklerin metinlerini oluÅŸtur
    const convertText = `Yeni ${foundMultiplier.value}x Ã‡arpanÄ±, <b>+${foundMultiplier.value} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼r. (Mevcut ${existingMultiplier.value}x Ã§arpanÄ±n korunur)`;
    const combineValue = existingMultiplier.value + foundMultiplier.value;
    const combineText = `Ä°ki Ã§arpanÄ± birleÅŸtirip <b>1 kullanÄ±mlÄ±k ${combineValue}x</b> elde et. (Mevcut tÃ¼m ${existingMultiplier.value}x haklarÄ±n gider)`;

    infoEl.innerHTML = `Kutudan <b class="text-yellow-300">${foundMultiplier.value}x Ã‡arpan</b> buldun! Mevcut <b class="text-purple-300">${existingMultiplier.uses} adet ${existingMultiplier.value}x</b> Ã§arpanÄ±n var. Ne yapmak istersin?`;
    convertBtn.innerHTML = convertText;
    combineBtn.innerHTML = combineText;

    // ButonlarÄ±n onclick olaylarÄ±nÄ± ayarla
    convertBtn.onclick = () => resolveMultiplierChoice('convert');
    combineBtn.onclick = () => resolveMultiplierChoice('combine');

    modal.style.display = 'flex';
}

function openMultiplierChoiceModal(context) {
    const modal = document.getElementById('multiplierChoiceModal');
    const infoEl = document.getElementById('multiplierChoiceInfo');
    const convertBtn = document.getElementById('choiceConvertBtn');
    const combineBtn = document.getElementById('choiceCombineBtn');

    pendingMultiplierChoice = context;

    const { hasMultiplier, existing, found } = context;

    if (hasMultiplier) {
        const boxRightsFromFound = found.value;
        const convertText = `Yeni ${found.value}x Ã‡arpanÄ±, <b>+${boxRightsFromFound} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼r. <br><small>(Mevcut ${existing.value}x Ã§arpanÄ±n korunur)</small>`;
        
        const combineValue = existing.value + found.value;
        const acceptNewText = `Ä°ki Ã§arpanÄ± birleÅŸtirip <b>1 kullanÄ±mlÄ±k ${combineValue}x</b> elde et. <br><small>(DÄ°KKAT: Mevcut ${existing.uses} adet ${existing.value}x Ã§arpan hakkÄ±n kaybolacak ve <b>+1 Kutu HakkÄ±</b> iade edilecek!)</small>`;

        infoEl.innerHTML = `Kutudan <b class="text-yellow-300">${found.value}x Ã‡arpan</b> buldun! Mevcut <b class="text-purple-300">${existing.uses} adet ${existing.value}x</b> Ã§arpanÄ±n var. Stratejik bir karar ver!`;
        convertBtn.innerHTML = convertText;
        combineBtn.innerHTML = acceptNewText;
        
        convertBtn.onclick = () => resolveMultiplierChoice('convert_new');
        combineBtn.onclick = () => resolveMultiplierChoice('combine_and_upgrade');

    } else {
        const boxRightsFromFound = found.value;
        const convertText = `BulduÄŸun ${found.value}x Ã‡arpanÄ±, <b>+${boxRightsFromFound} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼r.`;
        const acceptText = `BulduÄŸun ${found.value}x Ã‡arpanÄ± <b>1 kullanÄ±mlÄ±k</b> olarak envanterine ekle.`;

        infoEl.innerHTML = `Kutudan <b class="text-yellow-300">${found.value}x Ã‡arpan</b> buldun! Ne yapmak istersin?`;
        convertBtn.innerHTML = convertText;
        combineBtn.innerHTML = acceptText;

        convertBtn.onclick = () => resolveMultiplierChoice('convert_found');
        combineBtn.onclick = () => resolveMultiplierChoice('accept_found');
    }

    modal.style.display = 'flex';
}

async function resolveMultiplierChoice(choice) {
    if (!pendingMultiplierChoice) return;

    const { hasMultiplier, existing, found, boxId } = pendingMultiplierChoice;
    const userRef = db.ref('users/' + currentUser);
    const updates = {};
    let message = '';
    
    const userSnap = await userRef.once('value');
    const user = userSnap.val();

    if (hasMultiplier) { // Senaryo: KullanÄ±cÄ±nÄ±n zaten bir Ã§arpanÄ± var
        if (choice === 'convert_new') {
            updates.kutuHakki = (user.kutuHakki || 0) + found.value;
            message = `Mevcut ${existing.value}x Ã§arpanÄ±nÄ± korudun ve kutudan Ã§Ä±kan ${found.value}x Ã§arpanÄ± <b>+${found.value} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼!`;
            logActivity('multiplierConvertedToBoxRights', currentUser, { rewardValue: found.value, boxRights: found.value, source: `Kutudan` });
        } else if (choice === 'combine_and_upgrade') {
            const combinedValue = existing.value + found.value;
            updates.activeMultiplier = combinedValue;
            updates.multiplierSource = 'box';
            updates.multiplierRemainingUses = 0; // Tek kullanÄ±mlÄ±k olur
            updates.kutuHakki = (user.kutuHakki || 0) + 1; // 1 Kutu HakkÄ± iade et
            message = `SeÃ§im yapÄ±ldÄ±! Mevcut Ã§arpan haklarÄ±n feda edilerek envanterine <b>1 kullanÄ±mlÄ±k ${combinedValue}x</b> eklendi ve <b>+1 Kutu HakkÄ±</b> iade edildi!`;
            logActivity('multiplierCombined', currentUser, { boxId: boxId, foundValue: found.value, combinedValue: combinedValue });
        }
    } else { // Senaryo: KullanÄ±cÄ±nÄ±n hiÃ§ Ã§arpanÄ± yok
        if (choice === 'convert_found') {
            updates.kutuHakki = (user.kutuHakki || 0) + found.value;
            message = `SeÃ§imin Ã¼zerine, ${found.value}x Ã§arpan <b>+${found.value} Kutu HakkÄ±</b>'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼!`;
            logActivity('multiplierConvertedToBoxRights', currentUser, { rewardValue: found.value, boxRights: found.value, source: `Kutudan` });
        } else if (choice === 'accept_found') {
            updates.activeMultiplier = found.value;
            updates.multiplierSource = 'box';
            updates.multiplierRemainingUses = 0; // Tek kullanÄ±mlÄ±k
            message = `Yeni <b>${found.value}x</b> Ã§arpanÄ±n bir sonraki kutu aÃ§Ä±lÄ±ÅŸÄ±nda kullanÄ±lmak Ã¼zere envanterine eklendi!`;
            logActivity('multiplierFound', currentUser, { boxId: boxId, value: found.value });
        }
    }

    await userRef.update(updates);

    displayMessage(message);
    closeMultiplierChoiceModal();
    db.ref('gameLock').set(false);
}

// ESKÄ°SÄ°NÄ° SÄ°LÄ°P BUNU YAPIÅTIR
async function forceClientUpdate() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("TÃ¼m aktif kullanÄ±cÄ±lara 'GÃ¼ncelleme Mevcut' penceresini gÃ¶stermek istediÄŸinize emin misiniz?");
    if (confirmed) {
        // VeritabanÄ±na "gÃ¼ncelleme gerekli" iÅŸareti olarak o anki sunucu zamanÄ±nÄ± yazÄ±yoruz.
        await db.ref('gameConfig/updateRequiredTimestamp').set(firebase.database.ServerValue.TIMESTAMP);
        displayMessage("GÃ¼ncelleme sinyali tÃ¼m kullanÄ±cÄ±lara gÃ¶nderildi.");
    }
}

 // ESKÄ°SÄ°NÄ° SÄ°LÄ°P BUNU YAPIÅTIR
async function performForceReload() {
    // Ã–nce sunucudaki gÃ¼ncel gÃ¼ncelleme zaman damgasÄ±nÄ± al
    const updateTimestampSnap = await db.ref('gameConfig/updateRequiredTimestamp').once('value');
    const updateTimestamp = updateTimestampSnap.val();

    if (updateTimestamp) {
        // Bu zaman damgasÄ±nÄ± kullanÄ±cÄ±nÄ±n kendi profiline "gÃ¶rdÃ¼ÄŸÃ¼ son gÃ¼ncelleme" olarak kaydet
        await db.ref(`users/${currentUser}/lastSeenUpdateTimestamp`).set(updateTimestamp);
    }
    
    // SayfayÄ±, Ã¶nbelleÄŸi atlayacak ÅŸekilde yeniden yÃ¼kle
    window.location.href = window.location.pathname + '?v=' + Date.now();
}

// BU FONKSÄ°YONU BULUP AÅAÄIDAKÄ° Ä°LE DEÄÄ°ÅTÄ°RÄ°N
function listenForTradeNotifications() {
    if (isAdmin) return; 

    const notificationsRef = db.ref(`tradeNotifications/${currentUser}`);
    
    const callback = (snapshot) => {
        const notification = snapshot.val();
        if (notification && notification.message) {
            showTradeCompleteModal(notification.message);
            if (currentActiveSection === 'cardCollection') {
                loadCollectionAlbum();
            }
            snapshot.ref.remove();
        }
    };

    // Dinleyiciyi tekrar tekrar eklememek iÃ§in kontrol et ve kaydet
    if (activeListeners.tradeNotifications) {
        activeListeners.tradeNotifications.ref.off('child_added', activeListeners.tradeNotifications.callback);
    }
    activeListeners.tradeNotifications = { ref: notificationsRef, event: 'child_added', callback };
    notificationsRef.on('child_added', callback);
}

// BU FONKSÄ°YONU BULUP AÅAÄIDAKÄ° Ä°LE DEÄÄ°ÅTÄ°RÄ°N
function listenForForceUpdateSignal() {
    if (isAdmin) return; 

    const updateRef = db.ref('gameConfig/updateRequiredTimestamp');
    
    const callback = async (snapshot) => {
        const requiredUpdateTimestamp = snapshot.val();
        if (!requiredUpdateTimestamp) {
            return;
        }
        const userSeenTimestampSnap = await db.ref(`users/${currentUser}/lastSeenUpdateTimestamp`).once('value');
        const userSeenTimestamp = userSeenTimestampSnap.val() || 0;
        if (requiredUpdateTimestamp > userSeenTimestamp) {
            document.getElementById('forceUpdateModal').style.display = 'flex';
        }
    };
    
    // Dinleyiciyi tekrar tekrar eklememek iÃ§in kontrol et ve kaydet
    if (activeListeners.forceUpdate) {
        activeListeners.forceUpdate.ref.off('value', activeListeners.forceUpdate.callback);
    }
    activeListeners.forceUpdate = { ref: updateRef, event: 'value', callback };
    updateRef.on('value', callback);
}

async function loadCollectionLeaderboard() {
    const leaderboardContainer = document.getElementById('collectionFinishersLeaderboard');
    const listEl = document.getElementById('finishersList');
    listEl.innerHTML = '<p class="text-gray-400">SÄ±ralama yÃ¼kleniyor...</p>';
    listEl.classList.add('scrollable-list'); 

    const usersRef = db.ref('users');

    if (activeListeners.collectionLeaderboard) {
        usersRef.off('value', activeListeners.collectionLeaderboard.callback);
    }

    const callback = async (snapshot) => {
        const allUsersData = snapshot.val() || {};
        
        const masterCardsSnap = await db.ref('gameConfig/cardCollection').once('value');
        const masterCards = masterCardsSnap.val() || {};
        const totalCardCount = Object.keys(masterCards).length;

        const playersWithCards = Object.values(allUsersData).filter(user => 
            user.cardCollection && Object.keys(user.cardCollection).length > 0
        );

        if (playersWithCards.length === 0) {
            leaderboardContainer.classList.add('hidden');
            return;
        }

        leaderboardContainer.classList.remove('hidden');

        playersWithCards.sort((a, b) => {
            const cardCountA = Object.keys(a.cardCollection || {}).length;
            const cardCountB = Object.keys(b.cardCollection || {}).length;
            if (cardCountB !== cardCountA) {
                return cardCountB - cardCountA;
            }
            const firstCardTimeA = a.collectionInfo?.firstCardTimestamp || 0;
            const firstCardTimeB = b.collectionInfo?.firstCardTimestamp || 0;
            return firstCardTimeA - firstCardTimeB;
        });

        let html = '';
        playersWithCards.forEach((userData, index) => {
            const username = Object.keys(allUsersData).find(key => allUsersData[key] === userData);
            if (!username) return; 

            const rank = index + 1;
            const rankIcon = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : `${rank}.`));
            const rowClass = rank === 1 ? 'bg-amber-800/50 border-amber-500' : 'bg-gray-700/50 border-gray-600';
            
            const ownedCardCount = Object.keys(userData.cardCollection || {}).length;

            let progressHtml = '';
            // --- DEÄÄ°ÅTÄ°RÄ°LEN KISIM BAÅLANGICI ---
            if (ownedCardCount >= totalCardCount && totalCardCount > 0) {
                // Koleksiyonu tamamladÄ±ysa bile tÄ±klanabilir olsun.
                progressHtml = `
                    <span class="font-bold text-green-400 cursor-pointer hover:underline" onclick="openUserAlbumViewer('${username}')">
                        TamamlandÄ± (${ownedCardCount}/${totalCardCount})
                    </span>
                `;
            } else {
                // Koleksiyonu tamamlamadÄ±ysa normal ilerlemesini gÃ¶ster.
                progressHtml = `
                    <span class="font-bold text-yellow-300 cursor-pointer hover:underline" onclick="openUserAlbumViewer('${username}')">
                        ${ownedCardCount}/${totalCardCount}
                    </span>
                `;
            }
            // --- DEÄÄ°ÅTÄ°RÄ°LEN KISIM SONU ---

            html += `
                <div class="flex items-center justify-between p-3 rounded-lg border ${rowClass}">
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-xl w-8 text-center">${rankIcon}</span>
                        <span class="text-lg text-white cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${username}')">
                            ${username}
                        </span>
                    </div>
                    <div class="text-right">
                        ${progressHtml}
                    </div>
                </div>
            `;
        });
        listEl.innerHTML = html;
    };
    
    activeListeners.collectionLeaderboard = { callback };
    usersRef.on('value', callback);
}

      async function openUserAlbumViewer(username) {
    const modal = document.getElementById('userAlbumViewerModal');
    const title = document.getElementById('userAlbumViewerTitle');
    const grid = document.getElementById('userAlbumViewerGrid');
    
    title.textContent = `${username}'nin Kart AlbÃ¼mÃ¼`;
    grid.innerHTML = '<p class="text-center col-span-full text-gray-400">YÃ¼kleniyor...</p>';
    modal.style.display = 'flex';

    try {
        const [masterCardsSnap, userSnap] = await Promise.all([
            db.ref('gameConfig/cardCollection').orderByChild('order').once('value'),
            db.ref(`users/${username}`).once('value')
        ]);

        if (!masterCardsSnap.exists()) {
            grid.innerHTML = '<p class="text-center col-span-full text-red-500">Hata: Ana kart listesi bulunamadÄ±.</p>';
            return;
        }

        const masterCards = masterCardsSnap.val();
        const userData = userSnap.val() || {};
        const userCards = userData.cardCollection || {};
        
        // --- YENÄ° EKLENEN KOD BAÅLANGICI ---
        // Joker kart sayÄ±sÄ±nÄ± al ve ekranda gÃ¶ster
        const wildcardCount = userData.wildcards || 0;
        const wildcardCountEl = document.getElementById('userAlbumViewerWildcardCount');
        if (wildcardCountEl) {
            wildcardCountEl.textContent = `Joker Kart: ${wildcardCount}`;
            wildcardCountEl.classList.remove('hidden');
        }
        // --- YENÄ° EKLENEN KOD SONU ---
        
        grid.innerHTML = ''; // Temizle

        for (const cardId in masterCards) {
            const cardInfo = masterCards[cardId];
            const userHasCard = userCards[cardId];

            const slot = document.createElement('div');
            slot.className = 'card-slot';

            if (userHasCard) {
                const cardItem = document.createElement('div');
                cardItem.className = `card-item rarity-${cardInfo.rarity || 'normal'}`;
                
                let duplicateBadge = userHasCard.count > 1 ? `<div class="duplicate-badge">+${userHasCard.count - 1}</div>` : '';
                
                cardItem.innerHTML = `
                    ${duplicateBadge}
                    <img class="card-image" src="${cardInfo.imageUrl}">
                    <h4 class="card-name">${cardInfo.cardName}</h4>
                `;
                slot.appendChild(cardItem);

            } else {
                slot.innerHTML = `
                    <div class="card-item missing relative rarity-${cardInfo.rarity || 'normal'}">
                        <div class="card-image flex items-center justify-center">
                             <span class="missing-text">?</span>
                        </div>
                        <h4 class="card-name text-gray-500">${cardInfo.cardName}</h4>
                    </div>
                `;
            }
            grid.appendChild(slot);
        }
    } catch (error) {
        console.error("KullanÄ±cÄ± albÃ¼mÃ¼ yÃ¼klenirken hata:", error);
        grid.innerHTML = '<p class="text-center col-span-full text-red-500">Veriler yÃ¼klenirken bir hata oluÅŸtu.</p>';
    }
}

// YENÄ° EKLENECEK FONKSÄ°YON: KullanÄ±cÄ± albÃ¼mÃ¼ penceresini kapatÄ±r
function closeUserAlbumViewerModal() {
    document.getElementById('userAlbumViewerModal').style.display = 'none';
}

      // â˜…â˜…â˜… YENÄ° EKLENECEK FONKSÄ°YONLAR BAÅLANGICI â˜…â˜…â˜…

// Takas bilgilendirme penceresini gÃ¶sterir
function showTradeCompleteModal(message) {
    document.getElementById('tradeCompleteMessage').innerHTML = message;
    document.getElementById('tradeCompleteModal').style.display = 'flex';
}

// Takas bilgilendirme penceresini kapatÄ±r
function closeTradeCompleteModal() {
    document.getElementById('tradeCompleteModal').style.display = 'none';
}

      function openCollectionAdminModal() {
        if (!isAdmin) return;
        document.getElementById('collectionAdminModal').style.display = 'flex';
    }

    function closeCollectionAdminModal() {
        document.getElementById('collectionAdminModal').style.display = 'none';
    }
    
    // BU YENÄ° FONKSÄ°YONU EKLE
function handleSoloSpecialTypeChange() {
    const typeSelect = document.getElementById('soloSpecialItemType');
    const valueInput = document.getElementById('soloSpecialValue');
    const usesInput = document.getElementById('soloSpecialMultiplierUses');
    
    if (typeSelect.value === 'tempMultiplier') {
        valueInput.placeholder = 'Ã‡arpan DeÄŸeri (Ã¶rn: 2)';
        usesInput.classList.remove('hidden');
    } else {
        valueInput.placeholder = 'Adet (Ã¶rn: 1, 5)';
        usesInput.classList.add('hidden');
    }
}

// =======================================================
// YENÄ° Ã–ZELLÄ°K: GÄ°RÄ°Å SERÄ°SÄ° Ã–DÃœL SÄ°STEMÄ°
// =======================================================

let loginStreakRewardsCache = []; // Admin ayarlarÄ±nÄ± Ã¶nbellekte tutmak iÃ§in

const typeToName = {
    points: 'Puan',
    boxRights: 'Kutu HakkÄ±',
    iflasShield: 'Ä°flas KalkanÄ±',
    wheelTicket: 'Ã‡ark Bileti',
    clickCatchTicket: 'TÄ±kla-Yakala Bileti',
    tempMultiplier: 'Ã‡arpan',
    wildcard: 'Joker Kart',
    card_pack: 'Standart Kart Paketi',
    card_pack_normal: 'Bronz Kart Paketi',
    card_pack_gumus: 'GÃ¼mÃ¼ÅŸ Kart Paketi',
    card_pack_altin: 'AltÄ±n Kart Paketi',
    card_pack_efsanevi: 'Efsanevi Kart Paketi',
    health_regen_potion: 'Can Yenileme Ä°ksiri', // â˜…â˜…â˜… BU SATIRIN EKLÄ° OLDUÄUNDAN EMÄ°N OL â˜…â˜…â˜…
    health_potion: 'Can Ä°ksiri',
    revival_stone: 'Dirilme TaÅŸÄ±',
    defense_potion: 'Savunma Ä°ksiri',
    damage_potion: 'Hasar Ä°ksiri',
    crit_potion: 'Kritik VuruÅŸ Ä°ksiri',
    dodge_potion: 'SÄ±yrÄ±lma Ä°ksiri',
    crit_damage_potion: 'Kritik Hasar Ä°ksiri',
    pierce_potion: 'Delici VuruÅŸ Ä°ksiri'
};
      
// GiriÅŸ Serisi penceresini kapatÄ±r (ZamanlayÄ±cÄ±larÄ± temizler)
function closeLoginStreakModal() {
    // YENÄ° EKLENEN KISIM: Aktif zamanlayÄ±cÄ±larÄ± temizle
    Object.values(activeStreakTimers).forEach(clearInterval);
    activeStreakTimers = {};
    // YENÄ° EKLENEN KISIM SONU
    document.getElementById('loginStreakModal').style.display = 'none';
}
// Ana butondaki kÄ±rmÄ±zÄ± noktayÄ± kontrol eder ve gÃ¼nceller
async function checkLoginStreakIndicator() {
    if (isAdmin) return;
    const indicator = document.getElementById('loginStreakIndicator');
    try {
        const userSnap = await db.ref(`users/${currentUser}/loginStreak`).once('value');
        const userStreak = userSnap.val() || { currentDay: 1, lastClaimTimestamp: 0 };
        
        const rewardsSnap = await db.ref('gameConfig/loginStreakRewards').once('value');
        if (!rewardsSnap.exists() || userStreak.currentDay > rewardsSnap.val().length) {
            indicator.classList.add('hidden');
            return;
        }

        const cooldownMs = 20 * 60 * 60 * 1000;
        if (getSyncedTime() > (userStreak.lastClaimTimestamp + cooldownMs)) {
            indicator.classList.remove('hidden');
        } else {
            indicator.classList.add('hidden');
        }
    } catch (error) {
        indicator.classList.add('hidden');
    }
}

// Admin GiriÅŸ Serisi ayar panelini kapatÄ±r
function closeAdminLoginStreakModal() {
    document.getElementById('adminLoginStreakModal').style.display = 'none';
}

// =======================================================
// GÃœNCELLENMÄ°Å: GÄ°RÄ°Å SERÄ°SÄ° ADMÄ°N FONKSÄ°YONLARI (PAKET SÄ°STEMLÄ°)
// =======================================================

// Admin iÃ§in GiriÅŸ Serisi ayar panelini aÃ§ar (GÃ¼ncellendi)
function openAdminLoginStreakModal() {
    document.getElementById('adminLoginStreakModal').style.display = 'flex';
    const container = document.getElementById('adminLoginStreakRowsContainer');
    container.innerHTML = ''; // Paneli temizle
    
    // Ã–nbellekteki veya veritabanÄ±ndaki mevcut ayarlarÄ± yÃ¼kle
    loginStreakRewardsCache.forEach((dayData, index) => {
        addLoginStreakDay(dayData, index + 1);
    });
}

// Admin paneline yeni bir gÃ¼n bloÄŸu ekler (DÃœZELTÄ°LMÄ°Å)
function addLoginStreakDay(dayData = { rewards: [] }, dayNumber = null) {
    const container = document.getElementById('adminLoginStreakRowsContainer');
    const newDay = dayNumber || container.children.length + 1;
    
    const dayContainer = document.createElement('div');
    dayContainer.className = 'p-4 bg-gray-800 rounded-lg border border-gray-700';
    dayContainer.innerHTML = `
        <div class="flex justify-between items-center mb-3">
            <h4 class="text-xl font-bold text-blue-300">${newDay}. GÃ¼n Paketi</h4>
            <div>
                <button onclick="addRewardToDay(this)" class="py-1 px-3 bg-green-600 hover:bg-green-500 rounded-md text-xs mr-2">+ Bu GÃ¼ne Ã–dÃ¼l Ekle</button>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="py-1 px-3 bg-red-700 hover:bg-red-600 rounded-md text-xs">Bu GÃ¼nÃ¼ Sil</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3 border-b border-gray-700 pb-3">
             <input type="text" class="box-setting-input reward-name" placeholder="Paket AdÄ± (Ã¶rn: BaÅŸlangÄ±Ã§ Paketi)" value="${dayData.name || ''}">
            <input type="text" class="box-setting-input reward-description" placeholder="Paket AÃ§Ä±klamasÄ±" value="${dayData.description || ''}">
            <input type="text" class="box-setting-input reward-imageUrl" placeholder="Paket Resim URL" value="${dayData.imageUrl || ''}">
        </div>
        <div class="rewards-list space-y-3">
            </div>
    `;
    container.appendChild(dayContainer);

    const rewardsList = dayContainer.querySelector('.rewards-list');
    // Ã–nceki hataya neden olan 'else' bloÄŸu kaldÄ±rÄ±ldÄ±. ArtÄ±k sadece veri varsa Ã¶dÃ¼l ekleniyor.
    if (dayData.rewards && Array.isArray(dayData.rewards) && dayData.rewards.length > 0) {
        dayData.rewards.forEach(reward => addRewardToDay(rewardsList, reward));
    }
}

// Admin paneline belirli bir gÃ¼n iÃ§in yeni bir Ã¶dÃ¼l satÄ±rÄ± ekler (GÃœNCELLENMÄ°Å)
function addRewardToDay(element, rewardData = {}) {
    // element bir buton veya direkt container olabilir, o yÃ¼zden en yakÄ±n container'Ä± bulalÄ±m
    const rewardsListContainer = element.matches('.rewards-list') ? element : element.closest('.p-4').querySelector('.rewards-list');
    
    const rewardRow = document.createElement('div');
    rewardRow.className = 'reward-entry grid grid-cols-1 sm:grid-cols-3 gap-2 p-2 bg-gray-900/50 rounded-md';
    rewardRow.innerHTML = `
        <select class="box-setting-input reward-type" onchange="handleAdminRewardTypeChange(this)">
            <option value="points" ${rewardData.type === 'points' ? 'selected' : ''}>ğŸ’° Puan</option>
            <option value="boxRights" ${rewardData.type === 'boxRights' ? 'selected' : ''}>ğŸ“¦ Kutu HakkÄ±</option>
            <option value="wheelTicket" ${rewardData.type === 'wheelTicket' ? 'selected' : ''}>ğŸ« Ã‡ark Bileti</option>
            <option value="clickCatchTicket" ${rewardData.type === 'clickCatchTicket' ? 'selected' : ''}>ğŸŸï¸ T-Y Bileti</option>
            <option value="iflasShield" ${rewardData.type === 'iflasShield' ? 'selected' : ''}>ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
            <option value="tempMultiplier" ${rewardData.type === 'tempMultiplier' ? 'selected' : ''}>âœ–ï¸ Ã‡arpan</option>
            <option value="avatar" ${rewardData.type === 'avatar' ? 'selected' : ''}>ğŸ‘¤ Avatar</option>
            <option value="wildcard" ${rewardData.type === 'wildcard' ? 'selected' : ''}>ğŸƒ Joker Kart</option>
            <option value="card_pack" ${rewardData.type === 'card_pack' ? 'selected' : ''}>ğŸ´ Standart Kart Paketi</option>
            <option value="card_pack_normal" ${rewardData.type === 'card_pack_normal' ? 'selected' : ''}>ğŸ¥‰ Bronz Kart Paketi</option>
            <option value="card_pack_gumus" ${rewardData.type === 'card_pack_gumus' ? 'selected' : ''}>ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
            <option value="card_pack_altin" ${rewardData.type === 'card_pack_altin' ? 'selected' : ''}>ğŸ¥‡ AltÄ±n Kart Paketi</option>
            <option value="card_pack_efsanevi" ${rewardData.type === 'card_pack_efsanevi' ? 'selected' : ''}>ğŸ† Efsanevi Kart Paketi</option>
            <option value="revival_stone" ${rewardData.type === 'revival_stone' ? 'selected' : ''}>ğŸ’ Dirilme TaÅŸÄ±</option>
            <option value="health_potion" ${rewardData.type === 'health_potion' ? 'selected' : ''}>ğŸ§ª Can Ä°ksiri</option>
            <option value="damage_potion" ${rewardData.type === 'damage_potion' ? 'selected' : ''}>âš”ï¸ Hasar Ä°ksiri</option>
            <option value="defense_potion" ${rewardData.type === 'defense_potion' ? 'selected' : ''}>ğŸ›¡ï¸ Savunma Ä°ksiri</option>
            <option value="crit_potion" ${rewardData.type === 'crit_potion' ? 'selected' : ''}>ğŸ’¥ Kritik VuruÅŸ Ä°ksiri</option>
            <option value="crit_damage_potion" ${rewardData.type === 'crit_damage_potion' ? 'selected' : ''}>ğŸ¯ Kritik Hasar Ä°ksiri</option>
            <option value="dodge_potion" ${rewardData.type === 'dodge_potion' ? 'selected' : ''}>ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± Ä°ksiri</option>
            <option value="pierce_potion" ${rewardData.type === 'pierce_potion' ? 'selected' : ''}>ğŸ“Œ Delici ÅansÄ± Ä°ksiri</option>
        </select>
        <div class="reward-fields-container grid grid-cols-2 gap-2 sm:col-span-2">
            </div>
    `;
    rewardsListContainer.appendChild(rewardRow);
    const selectElement = rewardRow.querySelector('.reward-type');
    handleAdminRewardTypeChange(selectElement, rewardData); // Mevcut veriyi de gÃ¶nder
}
      
function handleAdminRewardTypeChange(selectElement, rewardData = {}) {
    const type = selectElement.value;
    const container = selectElement.closest('.grid').querySelector('.reward-fields-container');
    let fieldsHtml = '';
    const isPercent = ['defense_potion', 'crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion'].includes(type);
    const valuePlaceholder = isPercent ? 'DeÄŸer (Ã¶rn: 2.5)' : 'Miktar / Adet';

    if (type === 'tempMultiplier') {
        fieldsHtml = `
            <input type="number" class="box-setting-input reward-value" placeholder="Ã‡arpan DeÄŸeri (Ã¶rn: 2)" value="${rewardData.value || ''}">
            <input type="number" class="box-setting-input reward-uses" placeholder="KullanÄ±m HakkÄ±" value="${rewardData.uses || ''}">
            <button onclick="this.parentElement.parentElement.remove()" class="py-1 px-2 bg-red-600 hover:bg-red-500 rounded-md text-xs col-span-2">Sil</button>
        `;
    } else if (type === 'avatar') {
        fieldsHtml = `
            <input type="text" class="box-setting-input reward-avatarName col-span-2" placeholder="AvatarÄ±n AdÄ±" value="${rewardData.avatarName || ''}">
            <input type="text" class="box-setting-input reward-avatarImageUrl col-span-2" placeholder="Avatar Resim URL" value="${rewardData.avatarImageUrl || ''}">
            <button onclick="this.parentElement.parentElement.remove()" class="py-1 px-2 bg-red-600 hover:bg-red-500 rounded-md text-xs col-span-2">Sil</button>
        `;
    } else {
        fieldsHtml = `
            <input type="text" class="box-setting-input reward-value col-span-2 sm:col-span-1" placeholder="${valuePlaceholder}" value="${rewardData.value || ''}">
            <button onclick="this.parentElement.parentElement.remove()" class="py-1 px-2 bg-red-600 hover:bg-red-500 rounded-md text-xs sm:col-span-1">Sil</button>
        `;
    }
    container.innerHTML = fieldsHtml;
}

// ESKÄ° saveLoginStreakRewards FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR
async function saveLoginStreakRewards() {
    if (!isAdmin) return;
    const container = document.getElementById('adminLoginStreakRowsContainer');
    const newRewardsData = [];
    let hasError = false;

    Array.from(container.children).forEach((dayRow, dayIndex) => {
        if (hasError) return;
        const dayRewards = [];
        
        dayRow.querySelectorAll('.rewards-list .reward-entry').forEach((rewardRow, rewardIndex) => {
            if (hasError) return;
            const reward = { type: rewardRow.querySelector('.reward-type').value };

            if (reward.type === 'tempMultiplier') {
                reward.value = parseInt(rewardRow.querySelector('.reward-value').value);
                reward.uses = parseInt(rewardRow.querySelector('.reward-uses').value);
                if (isNaN(reward.value) || isNaN(reward.uses) || reward.value <= 0 || reward.uses <= 0) {
                    displayMessage(`${dayIndex + 1}. gÃ¼n, ${rewardIndex + 1}. Ã¶dÃ¼l (Ã‡arpan) iÃ§in geÃ§erli DeÄŸer ve KullanÄ±m HakkÄ± girin.`);
                    hasError = true; return;
                }
            } else if (reward.type === 'avatar') {
                reward.avatarName = rewardRow.querySelector('.reward-avatarName').value.trim();
                reward.avatarImageUrl = rewardRow.querySelector('.reward-avatarImageUrl').value.trim();
                if (!reward.avatarName || !reward.avatarImageUrl) {
                    displayMessage(`${dayIndex + 1}. gÃ¼n, ${rewardIndex + 1}. Ã¶dÃ¼l (Avatar) iÃ§in Ad ve Resim URL'si girin.`);
                    hasError = true; return;
                }
            } else {
                reward.value = parseStatValue(reward.type, rewardRow.querySelector('.reward-value').value);
                if (isNaN(reward.value) || reward.value <= 0) {
                    displayMessage(`${dayIndex + 1}. gÃ¼n, ${rewardIndex + 1}. Ã¶dÃ¼l iÃ§in geÃ§erli bir Miktar/Adet girin.`);
                    hasError = true; return;
                }
            }

            dayRewards.push(reward);
        });
        
        if (hasError) return;

        const dayName = dayRow.querySelector('.reward-name')?.value.trim() || `${dayIndex + 1}. GÃ¼n Ã–dÃ¼lÃ¼`;
        const dayDescription = dayRow.querySelector('.reward-description')?.value.trim() || `GiriÅŸ yaparak bu paketi kazan!`;
        const dayImageUrl = dayRow.querySelector('.reward-imageUrl')?.value.trim() || '';
        
        if (dayRewards.length > 0) {
            newRewardsData.push({ 
                day: dayIndex + 1, 
                name: dayName, 
                description: dayDescription, 
                imageUrl: dayImageUrl, 
                rewards: dayRewards 
            });
        }
    });

    if (hasError) return;

    const confirmed = await customConfirm(`${newRewardsData.length} gÃ¼nlÃ¼k yeni bir GiriÅŸ Serisi oluÅŸturulacak. Mevcut seri silinecek ve tÃ¼m kullanÄ±cÄ±larÄ±n ilerlemesi SIFIRLANACAK. Emin misiniz?`);
    if (confirmed) {
        const usersSnap = await db.ref('users').once('value');
        const updates = {};
        if(usersSnap.exists()) {
            usersSnap.forEach(user => {
                updates[`/users/${user.key}/loginStreak`] = null;
            });
        }
        await db.ref().update(updates);

        await db.ref('gameConfig/loginStreakRewards').set(newRewardsData);
        loginStreakRewardsCache = newRewardsData;

        displayMessage("GiriÅŸ Serisi baÅŸarÄ±yla gÃ¼ncellendi ve tÃ¼m oyuncularÄ±n ilerlemesi sÄ±fÄ±rlandÄ±.");
        closeAdminLoginStreakModal();
        openLoginStreakModal();
    }
}
      
// MEVCUT openLoginStreakModal FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIRIN
async function openLoginStreakModal() {
    document.getElementById('loginStreakModal').style.display = 'flex';
    const container = document.getElementById('loginStreakRewardsContainer');
    const messageEl = document.getElementById('loginStreakMessage'); 
    container.innerHTML = '<p class="text-center col-span-full text-gray-400">Ã–dÃ¼l yolculuÄŸu yÃ¼kleniyor...</p>';
    
    Object.values(activeStreakTimers).forEach(clearInterval);
    activeStreakTimers = {};

    const adminButtonContainer = document.getElementById('adminLoginStreakManagementButtonContainer');
    if (isAdmin) {
        adminButtonContainer.classList.remove('hidden');
    } else {
        adminButtonContainer.classList.add('hidden');
    }

    try {
        const [rewardsSnap, userSnap] = await Promise.all([
            db.ref('gameConfig/loginStreakRewards').once('value'),
            db.ref(`users/${currentUser}`).once('value')
        ]);

        if (!rewardsSnap.exists()) {
            container.innerHTML = '<p class="text-center col-span-full">Admin henÃ¼z bir giriÅŸ serisi oluÅŸturmadÄ±.</p>';
            return;
        }

        const rewardsData = rewardsSnap.val();
        loginStreakRewardsCache = rewardsData;
        const userData = userSnap.val() || {};
        const userStreak = userData.loginStreak || { currentDay: 1, lastClaimTimestamp: 0 };

        const now = getSyncedTime();
        const cooldownMs = 20 * 60 * 60 * 1000;
        const resetMs = 48 * 60 * 60 * 1000;
        const lastClaimTime = userStreak.lastClaimTimestamp;
        const canClaimToday = now > (lastClaimTime + cooldownMs);
        const streakWillResetTime = lastClaimTime + resetMs;

        if (lastClaimTime > 0 && now < streakWillResetTime) {
            startStreakResetCountdown(messageEl, streakWillResetTime);
        } else {
             messageEl.textContent = 'Her gÃ¼n giriÅŸ yaparak sÄ±radaki Ã¶dÃ¼lÃ¼ al. Seriyi bozma!';
        }

        container.innerHTML = '';
        rewardsData.forEach((dayData) => {
            const day = dayData.day;
            if (!day) return;

            let status = 'locked';
            if (day < userStreak.currentDay) {
                status = 'claimed';
            } else if (day === userStreak.currentDay && canClaimToday) {
                status = 'claimable';
            }

            const buttonId = `streak-btn-${day}`;

            let rewardsListHtml = '<ul class="text-left list-disc list-inside space-y-1 text-sm text-gray-400 flex-grow mb-4">';
            (dayData.rewards || []).forEach(reward => {
                let rewardText = '';
                // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR â˜…â˜…â˜…
                if (reward.type === 'tempMultiplier') {
                    // Ä°stenen yeni format: +3 KullanÄ±m HakkÄ± 3x Ã‡arpan
                    rewardText = `+${reward.uses} KullanÄ±m HakkÄ± ${reward.value}x Ã‡arpan`;
                } 
                // â˜…â˜…â˜… DEÄÄ°ÅÄ°KLÄ°K BURADA BÄ°TÄ°YOR â˜…â˜…â˜…
                else if (reward.type === 'avatar') {
                    rewardText = `'${reward.avatarName}' AvatarÄ±`;
                } else {
                    rewardText = `+${reward.value} ${typeToName[reward.type] || 'Ã–dÃ¼l'}`;
                }
                rewardsListHtml += `<li>${rewardText}</li>`;
            });
            rewardsListHtml += '</ul>';

            const card = document.createElement('div');
            card.className = `streak-card ${status}`;
            card.id = `streak-card-${day}`;
            card.innerHTML = `
                <div class="day-number">${day}. GÃ¼n</div>
                <img src="${dayData.imageUrl || 'https://i.hizliresim.com/pntfb6j.png'}" alt="${dayData.name}" class="reward-image">
                <h4 class="reward-name">${dayData.name || day + '. GÃ¼n Paketi'}</h4>
                <div class="reward-description">${rewardsListHtml}</div>
                <button 
                    id="${buttonId}"
                    class="claim-button" 
                    ${status === 'claimable' ? `onclick="claimLoginStreakReward(${day})"` : 'disabled'}>
                    ${status === 'claimed' ? 'AlÄ±ndÄ±' : (status === 'claimable' ? 'Ã–dÃ¼lÃ¼ Al' : 'Kilitli')}
                </button>
            `;
            container.appendChild(card);
            
            if (status === 'locked' && day === userStreak.currentDay) {
                const nextAvailableTime = userStreak.lastClaimTimestamp + cooldownMs;
                startStreakCountdown(buttonId, nextAvailableTime, day);
            }
        });

    } catch (error) {
        console.error("GiriÅŸ Serisi yÃ¼klenirken hata:", error);
        container.innerHTML = '<p class="text-center col-span-full text-red-500">Ã–dÃ¼ller yÃ¼klenemedi.</p>';
    }
}
      
function startStreakCountdown(buttonId, nextAvailableTime, day) {
    const buttonEl = document.getElementById(buttonId);
    if (!buttonEl) return;

    const timerId = setInterval(() => {
        const now = getSyncedTime();
        const timeLeft = nextAvailableTime - now;

        if (timeLeft <= 0) {
            clearInterval(timerId);
            const cardEl = document.getElementById(`streak-card-${day}`);
            if (cardEl) {
                cardEl.classList.remove('locked');
                cardEl.classList.add('claimable');
            }
            buttonEl.disabled = false;
            buttonEl.textContent = 'Ã–dÃ¼lÃ¼ Al';
            buttonEl.onclick = () => claimLoginStreakReward(day);
            checkLoginStreakIndicator();
        } else {
            const hours = Math.floor(timeLeft / (1000 * 60 * 60)).toString().padStart(2, '0');
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000).toString().padStart(2, '0');
            buttonEl.innerHTML = `Kalan SÃ¼re:<br>${hours}:${minutes}:${seconds}`;
        }
    }, 1000);

    activeStreakTimers[day] = timerId;
}

function startStreakResetCountdown(element, resetTime) {
    const timerId = setInterval(() => {
        const now = getSyncedTime();
        const timeLeft = resetTime - now;

        if (timeLeft <= 0) {
            clearInterval(timerId);
            element.textContent = 'Serin bozuldu! 1. gÃ¼nden tekrar baÅŸla.';
        } else {
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            element.innerHTML = `HER GÃœN PAKETLERÄ° TOPLA SÃœREYÄ° UZAT
            <div class="space-y-3 text-gray-300">
            AÅAÄIDA KÄ° SÃœRE BÄ°TERSE SERÄ° SIFIRLANIR
            <div class="space-y-3 text-gray-300">
            <b class="text-red-400">${hours} saat ${minutes} dakika </b>`;
        }
    }, 1000);

    activeStreakTimers['resetTimer'] = timerId;
}
      
// MEVCUT claimLoginStreakReward FONKSÄ°YONUNU SÄ°LÄ°P BUNU YAPIÅTIRIN

async function claimLoginStreakReward(day) {
    if (isAdmin) {
        displayMessage("Adminler Ã¶dÃ¼l alamaz.");
        return;
    }

    const claimButton = document.getElementById(`streak-btn-${day}`);
    if (claimButton && claimButton.disabled) {
        return;
    }
    if (claimButton) {
        claimButton.disabled = true;
        claimButton.textContent = 'Ä°ÅŸleniyor...';
    }

    try {
        const userRef = db.ref(`users/${currentUser}`);
        const dayData = loginStreakRewardsCache[day - 1];

        if (!dayData || !dayData.rewards) {
            throw new Error("Ã–dÃ¼l verisi bulunamadÄ±.");
        }

        const multiplierReward = dayData.rewards.find(r => r.type === 'tempMultiplier');
        if (multiplierReward) {
            const userSnap = await userRef.once('value');
            const user = userSnap.val();
            const hasActiveMultiplier = (user.multiplierSource === 'box') || (user.multiplierSource === 'store' && (user.multiplierRemainingUses || 0) > 0);

            if (hasActiveMultiplier) {
                const rewardValue = parseInt(multiplierReward.value);
                const userMultiplierValue = parseInt(user.activeMultiplier);
                
                if (rewardValue === userMultiplierValue) {
                    const confirmedStack = await customConfirm(`Zaten ${user.activeMultiplier}x Ã§arpanÄ±n var. Bu Ã¶dÃ¼l, mevcut Ã§arpanÄ±na <b>+${multiplierReward.uses} kullanÄ±m hakkÄ±</b> ekleyecek. OnaylÄ±yor musun?`);
                    if (!confirmedStack) throw new Error("KullanÄ±cÄ± iptal etti.");
                } else if (rewardValue > userMultiplierValue) {
                    const kutuHakkiDonusum = user.multiplierRemainingUses || 0;
                    const confirmedUpgrade = await customConfirm(`Mevcut ${user.activeMultiplier}x Ã§arpanÄ±nÄ± daha yÃ¼ksek olan <b>${rewardValue}x</b> ile deÄŸiÅŸtirmek Ã¼zeresin. Mevcut Ã§arpanÄ±nÄ±n kalan <b>${user.multiplierRemainingUses} kullanÄ±m hakkÄ±</b>, envanterine <b>+${kutuHakkiDonusum} Kutu HakkÄ±</b> olarak eklenecek. OnaylÄ±yor musun?`);
                    if (!confirmedUpgrade) throw new Error("KullanÄ±cÄ± iptal etti.");
                } else {
                    const kutuHakkiDonusum = multiplierReward.uses || 0;
                    const confirmedConvert = await customConfirm(`Mevcut <b>${user.activeMultiplier}x</b> Ã§arpanÄ±n bu <b>${rewardValue}x</b> Ã¶dÃ¼lÃ¼nden daha gÃ¼Ã§lÃ¼. Bu Ã¶dÃ¼lÃ¼ alÄ±rsan, Ã§arpanÄ±n deÄŸiÅŸmeyecek ancak Ã¶dÃ¼lÃ¼n <b>${kutuHakkiDonusum} kullanÄ±m hakkÄ±</b>, envanterine <b>+${kutuHakkiDonusum} Kutu HakkÄ±</b> olarak eklenecek. OnaylÄ±yor musun?`);
                    if (!confirmedConvert) throw new Error("KullanÄ±cÄ± iptal etti.");
                }
            }
        }
        
        const cardPacksToOpen = [];

        const { committed, snapshot } = await userRef.transaction(userData => {
            if (userData) {
                const userStreak = userData.loginStreak || { currentDay: 1, lastClaimTimestamp: 0 };
                
                if (day !== userStreak.currentDay) return;
                const cooldownMs = 20 * 60 * 60 * 1000;
                if (getSyncedTime() < (userStreak.lastClaimTimestamp + cooldownMs)) return;

                dayData.rewards.forEach(reward => {
                    switch (reward.type) {
                        case 'points':
                            userData.balance = (userData.balance || 0) + reward.value;
                            userData.kariyerPuani = (userData.kariyerPuani || 0) + reward.value;
                            break;
                        case 'boxRights': userData.kutuHakki = (userData.kutuHakki || 0) + reward.value; break;
                        case 'wheelTicket': userData.carkBileti = (userData.carkBileti || 0) + reward.value; break;
                        case 'clickCatchTicket': userData.clickCatchTickets = (userData.clickCatchTickets || 0) + reward.value; break;
                        case 'iflasShield': userData.iflasShieldUses = (userData.iflasShieldUses || 0) + reward.value; break;
                        case 'wildcard': userData.wildcards = (userData.wildcards || 0) + reward.value; break;
                        case 'tempMultiplier':
                            const hasActiveMultiplier = (userData.multiplierSource === 'box') || (userData.multiplierSource === 'store' && (userData.multiplierRemainingUses || 0) > 0);
                            if (hasActiveMultiplier) {
                                const rewardValue = parseInt(reward.value);
                                const userMultiplierValue = parseInt(userData.activeMultiplier);
                                if (rewardValue === userMultiplierValue) {
                                    userData.multiplierRemainingUses = (userData.multiplierRemainingUses || 0) + reward.uses;
                                    logActivity('dailyRewardMultiplierStacked', currentUser, { source: `${day}. GÃ¼n Ã–dÃ¼lÃ¼'nden`, usesAdded: reward.uses, newTotalUses: userData.multiplierRemainingUses, multiplierValue: rewardValue });
                                } else if (rewardValue > userMultiplierValue) {
                                    const refundedBoxRights = userData.multiplierRemainingUses || 0;
                                    logActivity('multiplierUpgraded', currentUser, { 
                                        source: `${day}. GÃ¼n Ã–dÃ¼lÃ¼`, 
                                        oldValue: userMultiplierValue, 
                                        oldUses: refundedBoxRights, 
                                        newValue: rewardValue, 
                                        newUses: reward.uses, 
                                        boxRights: refundedBoxRights 
                                    });
                                    userData.kutuHakki = (userData.kutuHakki || 0) + refundedBoxRights;
                                    userData.activeMultiplier = reward.value;
                                    userData.multiplierRemainingUses = reward.uses;
                                    userData.multiplierSource = 'store';
                                } else {
                                    userData.kutuHakki = (userData.kutuHakki || 0) + (reward.uses || 0);
                                    logActivity('dailyRewardMultiplierConverted', currentUser, { keptMultiplierValue: userMultiplierValue, boxRights: reward.uses, rewardValue: rewardValue, source: `${day}. GÃ¼n Ã–dÃ¼lÃ¼'nden` });
                                }
                            } else {
                                userData.activeMultiplier = reward.value;
                                userData.multiplierRemainingUses = reward.uses;
                                userData.multiplierSource = 'store';
                            }
                            break;
                        case 'avatar':
                             const newAvatarId = firebase.database().ref().push().key;
                             if (!userData.avatars) userData.avatars = {};
                             userData.avatars[newAvatarId] = { id: newAvatarId, name: reward.avatarName, imageUrl: reward.avatarImageUrl };
                             break;
                        case 'card_pack':
                        case 'card_pack_normal':
                        case 'card_pack_gumus':
                        case 'card_pack_altin':
                        case 'card_pack_efsanevi':
                            cardPacksToOpen.push(reward);
                            break;
                        // --- DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR: ArtÄ±k inventory anahtarÄ± kontrol ediliyor ---
                        case 'revival_stone':
                            if (!userData.inventory) userData.inventory = {};
                            userData.inventory.revival_stone = (userData.inventory.revival_stone || 0) + reward.value;
                            break;
                        // --- DEÄÄ°ÅÄ°KLÄ°K SONU ---
                        case 'health_potion':
                        case 'damage_potion':
                        case 'defense_potion':
                        case 'crit_potion':
                        case 'crit_damage_potion':
                        case 'dodge_potion':
                        case 'pierce_potion':
                            const statKeyMap = { 
                                'health_potion': 'hp', 'damage_potion': 'damage', 'defense_potion': 'defense', 
                                'crit_potion': 'critChance', 'crit_damage_potion': 'critDamage', 
                                'dodge_potion': 'dodgeChance', 'pierce_potion': 'pierceChance' 
                            };
                            const statKey = statKeyMap[reward.type];
                            if (statKey) {
                                if (!userData.globalPotionBuffs) userData.globalPotionBuffs = {};
                                userData.globalPotionBuffs[statKey] = (userData.globalPotionBuffs[statKey] || 0) + reward.value;
                            }
                            break;
                    }
                });

                userData.loginStreak = {
                    currentDay: userStreak.currentDay + 1,
                    lastClaimTimestamp: getSyncedTime()
                };
            }
            return userData;
        });

        if (committed) {
            const rewardNames = dayData.rewards.map(r => {
                if (r.type === 'avatar') {
                    return `'${r.avatarName}' AvatarÄ±`;
                } else if (r.type === 'tempMultiplier') {
                    return `+${r.uses} KullanÄ±m HakkÄ± ${r.value}x Ã‡arpan`;
                } else {
                    return `+${r.value} ${typeToName[r.type] || 'Ã–dÃ¼l'}`;
                }
            }).join(', ');

            displayMessage(`Tebrikler! ${day}. gÃ¼n Ã¶dÃ¼llerin (${rewardNames}) envanterine eklendi!`);
            
            logActivity('loginStreakClaim', currentUser, {
                day: day,
                packageName: dayData.name || `${day}. GÃ¼n Paketi`
            });

            const hasPotion = dayData.rewards.some(r => r.type.includes('_potion'));
            if (hasPotion && currentActiveSection === 'monsterBattle') { renderMonsterBattleUI(); }

            for (const pack of cardPacksToOpen) {
                await startCardPackOpening(pack.value || 1, `${day}. GÃ¼n Ã–dÃ¼lÃ¼`, 1, pack.type);
            }

            await openLoginStreakModal();
            await checkLoginStreakIndicator();
        } else {
            throw new Error("Ã–dÃ¼l alÄ±namadÄ±. KoÅŸullar saÄŸlanmÄ±yor olabilir, lÃ¼tfen sayfayÄ± yenileyip tekrar deneyin.");
        }

    } catch (error) {
        if (error.message !== "KullanÄ±cÄ± iptal etti.") {
            console.error("Ã–dÃ¼l talep edilirken hata:", error);
            displayMessage("Bir hata oluÅŸtu: " + error.message);
        }
    } finally {
         if (claimButton) {
            claimButton.disabled = false;
            claimButton.textContent = 'Ã–dÃ¼lÃ¼ Al';
        }
    }
}
      // --- YENÄ° YARDIMCI FONKSÄ°YON (BUNU EKLE) ---
function displayTemporaryNotification(message, color = 'bg-blue-600') {
    const notification = document.createElement('div');
    notification.textContent = message;
    // Tailwind CSS ile ÅŸÄ±k bir gÃ¶rÃ¼nÃ¼m
    notification.className = `fixed top-20 left-1/2 -translate-x-1/2 z-[100001] px-6 py-3 rounded-lg shadow-xl text-white font-bold text-center ${color} transition-all duration-300 ease-in-out transform opacity-0`;
    document.body.appendChild(notification);
    
    // Animasyonla gÃ¶rÃ¼nÃ¼r yap
    setTimeout(() => {
        notification.classList.remove('opacity-0');
        notification.classList.add('opacity-100');
    }, 100);

    // 2.5 saniye sonra animasyonla gizle ve kaldÄ±r
    setTimeout(() => {
        notification.classList.remove('opacity-100');
        notification.classList.add('opacity-0');
        notification.addEventListener('transitionend', () => notification.remove());
    }, 2500);
}

// =======================================================
// YENÄ°: CANAVAR SAVAÅI SÄ°STEMÄ° FONKSÄ°YONLARI
// =======================================================

/**
 * Canavar ve Avatar stat verilerini Firebase'den dinler ve deÄŸiÅŸiklik olduÄŸunda arayÃ¼zÃ¼ gÃ¼nceller.
 */
function listenForMonsterBattleData() {
    const ref = db.ref('gameConfig/monsterBattle');
    const callback = snap => {
        monsterBattleData = snap.val() || {};
        // Sadece canavar savaÅŸÄ± sekmesi aÃ§Ä±ksa arayÃ¼zÃ¼ gÃ¼ncelle
        if (currentActiveSection === 'monsterBattle') {
            renderMonsterBattleUI();
        }
    };
    if (activeListeners.monsterBattle) ref.off('value', activeListeners.monsterBattle.callback);
    activeListeners.monsterBattle = { ref, event: 'value', callback };
    ref.on('value', callback);
}

function listenForAvatarBaseStats() {
    const ref = db.ref('gameConfig/avatarBaseStats');
    const callback = snap => {
        avatarBaseStats = snap.val() || {};
        if (currentActiveSection === 'monsterBattle') {
            renderMonsterBattleUI();
        }
    };
    if (activeListeners.avatarStats) ref.off('value', activeListeners.avatarStats.callback);
    activeListeners.avatarStats = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// MEVCUT openAvatarStatsModal VE closeAvatarStatsModal FONKSÄ°YONLARINI SÄ°LÄ°P BUNLARI YAPIÅTIRIN

// Hangi kullanÄ±cÄ±nÄ±n profilini dinlediÄŸimizi takip etmek iÃ§in global bir deÄŸiÅŸken
let activeProfileListener = null;

// --- YENÄ° VE Ä°STEDÄ°ÄÄ°N GÃ–RÃœNÃœMDEKÄ° FONKSÄ°YON ---
async function openAvatarStatsModal(username) {
    const modal = document.getElementById('avatarStatsModal');
    const contentEl = document.getElementById('statsModalContent');
    const titleEl = document.getElementById('statsModalUsername');

    titleEl.textContent = `YÃ¼kleniyor...`;
    contentEl.innerHTML = '<p class="text-gray-400">YÃ¼kleniyor...</p>';
    modal.style.display = 'flex';

    if (activeProfileListener && activeProfileListener.ref) {
        activeProfileListener.ref.off('value', activeProfileListener.callback);
    }

    const userRef = db.ref(`users/${username}`);
    
    const userProfileCallback = (userSnap) => {
        const userData = userSnap.val();

        if (!userData) {
            closeAvatarStatsModal();
            return;
        }
        
        titleEl.textContent = `${username} Avatar Ã–zellikleri`;
        
        const selectedAvatar = userData.selectedAvatar;
        const globalBuffs = userData.globalPotionBuffs || {};
        
        if (!selectedAvatar || !selectedAvatar.url) {
            contentEl.innerHTML = `
                <p class="text-center text-yellow-300 mb-4">Åu anda seÃ§ili bir avatar yok.</p>
                <h5 class="font-bold text-teal-300 mb-1">KalÄ±cÄ± Ä°ksir BonuslarÄ±:</h5>
                <p>â¤ï¸ Can: <b class="text-white">+${formatNumber(globalBuffs.hp || 0)}</b></p>
                <p>âš”ï¸ Hasar: <b class="text-white">+${formatNumber(globalBuffs.damage || 0)}</b></p>
                <p>ğŸ›¡ï¸ Savunma ÅansÄ±: <b class="text-white">+%${(globalBuffs.defense || 0).toFixed(1)}</b></p>
                <p>ğŸ¯ Kritik Hasar: <b class="text-white">+%${(globalBuffs.critDamage || 0).toFixed(1)}</b></p>
                <p>ğŸ’¨ SÄ±yrÄ±lma ÅansÄ±: <b class="text-white">+%${(globalBuffs.dodgeChance || 0).toFixed(1)}</b></p>
                <p>ğŸ“Œ Delici VuruÅŸ ÅansÄ±: <b class="text-white">+%${(globalBuffs.pierceChance || 0).toFixed(1)}</b></p>
                <p>ğŸ’¥ Kritik VuruÅŸ ÅansÄ±: <b class="text-white">+%${(globalBuffs.critChance || 0).toFixed(1)}</b></p>
            `;
            return;
        }
        
        const avatarUrl = selectedAvatar.url;
        const sanitizedId = sanitizeFirebaseKey(avatarUrl);
        const baseStats = avatarBaseStats[sanitizedId] || {};

        const finalStats = {
            hp: (baseStats.hp || 1000) + (globalBuffs.hp || 0),
            minDamage: (baseStats.minDamage || 50) + (globalBuffs.damage || 0),
            maxDamage: (baseStats.maxDamage || 100) + (globalBuffs.damage || 0),
            defense: (baseStats.defense || 0) + (globalBuffs.defense || 0), // Savunma artÄ±k yÃ¼zdelik
            critChance: (baseStats.critChance || 5) + (globalBuffs.critChance || 0),
            critDamage: (baseStats.critDamage || 10) + (globalBuffs.critDamage || 0),
            dodgeChance: (baseStats.dodgeChance || 5) + (globalBuffs.dodgeChance || 0),
            pierceChance: (baseStats.pierceChance || 5) + (globalBuffs.pierceChance || 0),
        };
        
        const capHtml = (statKey) => {
            const cap = potionCapsCache[statKey];
            return cap ? ` / <span class="text-gray-400">${formatNumber(cap)}</span>` : '';
        };
        const capPercentHtml = (statKey) => {
            const cap = potionCapsCache[statKey];
            return cap ? ` / <span class="text-gray-400">${cap.toFixed(1)}%</span>` : '';
        };

        // Ä°STEDÄ°ÄÄ°N YENÄ° SIRALAMA VE METÄ°NLER
        contentEl.innerHTML = `
            <div class="flex flex-col items-center mb-4">
                <img src="${selectedAvatar.url}" alt="${selectedAvatar.name || 'Avatar'}" class="w-24 h-24 rounded-full border-2 border-green-500 mb-2">
                <span class="text-lg font-bold text-white">${selectedAvatar.name || 'SeÃ§ili Avatar'}</span>
            </div>
            <p>â¤ï¸ Can: <b class="text-white">${formatNumber(finalStats.hp)}</b></p>
            <p>âš”ï¸ Hasar: <b class="text-white">${formatNumber(finalStats.minDamage)} - ${formatNumber(finalStats.maxDamage)}</b></p>
            <p>ğŸ¯ Kritik Hasar: <b class="text-white">+%${finalStats.critDamage.toFixed(1)}</b></p>
            <p>ğŸ›¡ï¸ Savunma ÅansÄ±: <b class="text-white">%${finalStats.defense.toFixed(1)}</b></p>
            <p>ğŸ’¨ SÄ±yrÄ±lma ÅansÄ±: <b class="text-white">%${finalStats.dodgeChance.toFixed(1)}</b></p>
            <p>ğŸ“Œ Delici VuruÅŸ ÅansÄ±: <b class="text-white">%${finalStats.pierceChance.toFixed(1)}</b></p>
            <p>ğŸ’¥ Kritik VuruÅŸ ÅansÄ±: <b class="text-white">%${finalStats.critChance.toFixed(1)}</b></p>
            
            <div class="mt-4 pt-3 border-t border-gray-600 text-sm">
                <h5 class="font-bold text-teal-300 mb-1">KalÄ±cÄ± Ä°ksir BonuslarÄ± (Limit):</h5>
                <p>â¤ï¸ Can: <b class="text-white">+${formatNumber(globalBuffs.hp || 0)}</b>${capHtml('hp')}</p>
                <p>âš”ï¸ Hasar: <b class="text-white">+${formatNumber(globalBuffs.damage || 0)}</b>${capHtml('damage')}</p>
                <p>ğŸ¯ Kritik Hasar: <b class="text-white">+%${(globalBuffs.critDamage || 0).toFixed(1)}</b>${capPercentHtml('critDamage')}</p>
                <p>ğŸ›¡ï¸ Savunma ÅansÄ±: <b class="text-white">%${(globalBuffs.defense || 0).toFixed(1)}</b>${capPercentHtml('defense')}</p>
                <p>ğŸ’¨ SÄ±yrÄ±lma ÅansÄ±: <b class="text-white">%${(globalBuffs.dodgeChance || 0).toFixed(1)}</b>${capPercentHtml('dodgeChance')}</p>
                <p>ğŸ“Œ Delici VuruÅŸ ÅansÄ±: <b class="text-white">%${(globalBuffs.pierceChance || 0).toFixed(1)}</b>${capPercentHtml('pierceChance')}</p>
                <p>ğŸ’¥ Kritik VuruÅŸ ÅansÄ±: <b class="text-white">%${(globalBuffs.critChance || 0).toFixed(1)}</b>${capPercentHtml('critChance')}</p>
            </div>
        `;
    };
    
    userRef.on('value', userProfileCallback);
    activeProfileListener = { ref: userRef, callback: userProfileCallback };
}
      
function closeAvatarStatsModal() {
    document.getElementById('avatarStatsModal').style.display = 'none';

    // ModalÄ± kapatÄ±rken, arka planda veri Ã§ekmeye devam etmemesi iÃ§in dinleyiciyi durdur
    if (activeProfileListener && activeProfileListener.ref) {
        activeProfileListener.ref.off('value', activeProfileListener.callback);
        activeProfileListener = null; // DeÄŸiÅŸkeni temizle
    }
}

// --- Admin FonksiyonlarÄ± ---

function toggleMonsterAdminPanel() {
    document.getElementById('monsterAdminControls').classList.toggle('hidden');
}

function toggleAvatarAdminPanel() {
    const panel = document.getElementById('avatarAdminControls');
    if (panel.classList.contains('hidden')) {
        loadAvatarStatsForAdmin(); // Paneli aÃ§arken verileri yÃ¼kle
        loadPotionCapsForAdmin();  // YENÄ° EKLENEN SATIR: Limitleri de yÃ¼kle
    }
    panel.classList.toggle('hidden');
}

// MEVCUT loadAvatarStatsForAdmin FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR

async function loadAvatarStatsForAdmin() {
    const editorEl = document.getElementById('avatarStatEditor');
    editorEl.innerHTML = '<p class="text-gray-400">TÃ¼m benzersiz avatarlar taranÄ±yor...</p>';

    const allAvatars = new Map();

    // --- 1. ADIM: TÃ¼m Avatar KaynaklarÄ±nÄ± Tara ---
    const sources = [
        db.ref('storeItems').orderByChild('type').equalTo('avatar').once('value'),
        db.ref('dailyRewardOptions').once('value'),
        db.ref('gameConfig/loginStreakRewards').once('value'),
        db.ref('gameConfig/collectionGrandPrize').once('value'),
        db.ref('users').once('value'),
        // â˜…â˜…â˜… YENÄ° EKLENECEK KOD BAÅLANGICI â˜…â˜…â˜…
        // 6. kaynak olarak Sezon AyarlarÄ±nÄ± da ekliyoruz.
        db.ref('gameConfig/seasonSettings').once('value')
        // â˜…â˜…â˜… YENÄ° EKLENECEK KOD SONU â˜…â˜…â˜…
    ];
    
    const snapshots = await Promise.all(sources);
    
    // MaÄŸaza
    if (snapshots[0].exists()) snapshots[0].forEach(snap => {
        const item = snap.val();
        if (item.imageUrl && !allAvatars.has(item.imageUrl)) allAvatars.set(item.imageUrl, { name: item.name, imageUrl: item.imageUrl });
    });
    // GÃ¼nlÃ¼k Ã–dÃ¼ller
    if (snapshots[1].exists()) snapshots[1].forEach(snap => {
        const reward = snap.val();
        if (reward.type === 'avatar' && reward.avatarImageUrl && !allAvatars.has(reward.avatarImageUrl)) allAvatars.set(reward.avatarImageUrl, { name: reward.avatarName, imageUrl: reward.avatarImageUrl });
    });
    // GiriÅŸ Serisi
    if (snapshots[2].exists()) {
        snapshots[2].val().forEach(dayData => {
            (dayData.rewards || []).forEach(reward => {
                if (reward.type === 'avatar' && reward.avatarImageUrl && !allAvatars.has(reward.avatarImageUrl)) {
                    allAvatars.set(reward.avatarImageUrl, { name: reward.avatarName, imageUrl: reward.avatarImageUrl });
                }
            });
        });
    }
    // Koleksiyon Ã–dÃ¼lÃ¼
    if (snapshots[3].exists()) {
        const prize = snapshots[3].val();
        if (prize.avatarName && prize.avatarImageUrl && !allAvatars.has(prize.avatarImageUrl)) allAvatars.set(prize.avatarImageUrl, { name: prize.avatarName, imageUrl: prize.avatarImageUrl });
    }
    // KullanÄ±cÄ± Envanterleri
    if (snapshots[4].exists()) snapshots[4].forEach(userSnap => {
        const avatars = userSnap.val().avatars;
        if (avatars) {
            for (const avatarId in avatars) {
                const userAvatar = avatars[avatarId];
                if (userAvatar.imageUrl && !allAvatars.has(userAvatar.imageUrl)) allAvatars.set(userAvatar.imageUrl, { name: userAvatar.name, imageUrl: userAvatar.imageUrl });
            }
        }
    });

    // â˜…â˜…â˜… YENÄ° EKLENECEK KOD BAÅLANGICI â˜…â˜…â˜…
    // Sezon YÃ¶netiminden gelen avatarlarÄ± iÅŸle
    if (snapshots[5].exists()) {
        const settings = snapshots[5].val();
        const rewards = settings.rewards;
        if (rewards) {
            if (rewards.puanLeaderAvatarUrl && !allAvatars.has(rewards.puanLeaderAvatarUrl)) {
                allAvatars.set(rewards.puanLeaderAvatarUrl, { name: 'Puan Lideri Sezon AvatarÄ±', imageUrl: rewards.puanLeaderAvatarUrl });
            }
            if (rewards.rozetLeaderAvatarUrl && !allAvatars.has(rewards.rozetLeaderAvatarUrl)) {
                allAvatars.set(rewards.rozetLeaderAvatarUrl, { name: 'Rozet Lideri Sezon AvatarÄ±', imageUrl: rewards.rozetLeaderAvatarUrl });
            }
        }
    }
    // â˜…â˜…â˜… YENÄ° EKLENECEK KOD SONU â˜…â˜…â˜…

    // --- 2. ADIM: Paneli OluÅŸtur ---
    if (allAvatars.size === 0) {
        editorEl.innerHTML = '<p class="text-red-500">Sistemde (MaÄŸaza, Ã–dÃ¼ller, KullanÄ±cÄ±lar vb.) hiÃ§ avatar bulunamadÄ±.</p>';
        return;
    }

    editorEl.innerHTML = '';
    for (const avatar of allAvatars.values()) {
        const sanitizedId = sanitizeFirebaseKey(avatar.imageUrl);
        const currentStats = avatarBaseStats[sanitizedId] || {};

        const avatarHtml = `
            <div class="p-3 bg-gray-800 rounded-lg border border-gray-700" data-avatar-id="${sanitizedId}">
                <div class="flex items-center gap-3 mb-2">
                    <img src="${avatar.imageUrl}" class="w-12 h-12 rounded-md object-cover">
                    <h5 class="text-lg font-bold text-white">${avatar.name}</h5>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <input type="number" class="box-setting-input stat-hp" placeholder="Can" value="${currentStats.hp || ''}">
                    <input type="number" class="box-setting-input stat-min-damage" placeholder="Min Hasar" value="${currentStats.minDamage || ''}">
                    <input type="number" class="box-setting-input stat-max-damage" placeholder="Max Hasar" value="${currentStats.maxDamage || ''}">
                    <input type="number" class="box-setting-input stat-crit-damage" placeholder="Kritik Hasar (%)" value="${currentStats.critDamage || ''}">
                    <input type="number" class="box-setting-input stat-defense" placeholder="Savunma (%)" value="${currentStats.defense || ''}">
                    <input type="number" class="box-setting-input stat-dodge" placeholder="SÄ±yrÄ±lma ÅansÄ± (%)" value="${currentStats.dodgeChance || ''}">
                    <input type="number" class="box-setting-input stat-pierce" placeholder="Delici ÅansÄ± (%)" value="${currentStats.pierceChance || ''}">
                    <input type="number" class="box-setting-input stat-crit" placeholder="Kritik ÅansÄ± (%)" value="${currentStats.critChance || ''}">
                </div>
            </div>
        `;
        editorEl.innerHTML += avatarHtml;
    }
}
      
// MEVCUT saveAndSpawnMonster FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR
async function saveAndSpawnMonster() {
    if (!isAdmin) return;

    // â˜…â˜…â˜… YENÄ° KOD BAÅLANGICI: Yeni canavar gelmeden Ã¶nce eski ÅŸampiyonu temizle â˜…â˜…â˜…
    await db.ref('gameStats/lastMonsterChampion').remove();
    // â˜…â˜…â˜… YENÄ° KOD SONU â˜…â˜…â˜…

    const minDamage = parseInt(document.getElementById('adminMonsterMinDamage').value) || 500;
    const maxDamage = parseInt(document.getElementById('adminMonsterMaxDamage').value) || 1000;

    if (minDamage > maxDamage) {
        displayMessage("CanavarÄ±n minimum hasarÄ±, maksimum hasarÄ±ndan bÃ¼yÃ¼k olamaz.");
        return;
    }

    const monsterDetails = {
        name: document.getElementById('adminMonsterName').value.trim() || 'Ä°simsiz DehÅŸet',
        imageUrl: document.getElementById('adminMonsterImageUrl').value.trim(),
        maxHP: parseInt(document.getElementById('adminMonsterMaxHP').value) || 1000000,
        minDamage: minDamage,
        maxDamage: maxDamage,
        defense: parseInt(document.getElementById('adminMonsterDefense').value) || 100,
        critChance: parseFloat(String(document.getElementById('adminMonsterCritChance').value).replace(',', '.')) || 5,
        critDamage: parseFloat(String(document.getElementById('adminMonsterCritDamage').value).replace(',', '.')) || 10,
        dodgeChance: parseFloat(String(document.getElementById('adminMonsterDodgeChance').value).replace(',', '.')) || 5,
        pierceChance: parseFloat(String(document.getElementById('adminMonsterPierceChance').value).replace(',', '.')) || 5,
    };
    monsterDetails.currentHP = monsterDetails.maxHP;
    
    const onKillRewardType = document.getElementById('adminMonsterKillRewardType').value;
    const onKillRewardValue = parseStatValue(onKillRewardType, document.getElementById('adminMonsterKillReward').value);

    const rewards = {
        onKillLeader: {
            type: onKillRewardType,
            value: onKillRewardValue || 50000
        }
    };
    
    const damageTiers = [];
    document.querySelectorAll('.damage-tier-row').forEach(tierRow => {
        const minDamage = parseInt(tierRow.querySelector('.min-damage').value);
        if (isNaN(minDamage) || minDamage <= 0) return;
        
        const tierRewards = [];
        tierRow.querySelectorAll('.rewards-list > .grid').forEach(rewardRow => {
            const type = rewardRow.querySelector('.reward-type').value;
            const value = parseStatValue(type, rewardRow.querySelector('.reward-value').value);
            const chance = parseInt(rewardRow.querySelector('.reward-chance').value);

            if (type && !isNaN(value) && !isNaN(chance) && value > 0 && chance > 0) {
                tierRewards.push({ type, value, chance });
            }
        });
        
        if(tierRewards.length > 0) {
            damageTiers.push({ minDamage, rewards: tierRewards });
        }
    });

    const confirmed = await customConfirm(`<b>${monsterDetails.name}</b> canavarÄ± ${formatNumber(monsterDetails.maxHP)} can ile Ã§aÄŸrÄ±lacak. Mevcut savaÅŸ ilerlemesi (varsa) sÄ±fÄ±rlanacak. OnaylÄ±yor musun?`);
    if (!confirmed) return;

    await db.ref('gameConfig/monsterBattle').set({
        monsterDetails: monsterDetails,
        rewards: rewards,
        damageTiers: damageTiers,
        damageLeaderboard: null 
    });

    displayMessage("Canavar baÅŸarÄ±yla Ã§aÄŸrÄ±ldÄ± ve savaÅŸ baÅŸladÄ±!");
    toggleMonsterAdminPanel();
}

function updateHealthBar(currentHP, maxHP) {
  const healthBarEl = document.getElementById('monsterHealthBar');
  const healthTextEl = document.getElementById('monsterHealthText');

  const healthPercentage = (currentHP / maxHP) * 100;
  const healthColor = healthPercentage > 50 ? 'bg-green-500' : (healthPercentage > 20 ? 'bg-yellow-500' : 'bg-red-500');

  healthBarEl.style.width = `${healthPercentage}%`;
  healthBarEl.className = `health-bar ${healthColor}`;
  healthTextEl.textContent = `${formatNumber(currentHP)} / ${formatNumber(maxHP)}`;
}

/**
 * YENÄ°: Hasar aralÄ±ÄŸÄ± admin paneline yeni bir satÄ±r ekler.
 */
function addDamageTierRow(tierData = {}) {
    const container = document.getElementById('damageTiersContainer');
    const tierRow = document.createElement('div');
    tierRow.className = 'damage-tier-row bg-gray-800 p-3 rounded-lg';
    tierRow.innerHTML = `
        <div class="flex items-center gap-2 mb-2">
            <input type="number" class="box-setting-input min-damage" placeholder="Minimum Hasar" value="${tierData.minDamage || ''}">
            <button onclick="addRewardToTier(this)" class="py-1 px-2 bg-green-600 hover:bg-green-500 rounded-md text-xs">+ Ã–dÃ¼l</button>
            <button onclick="this.parentElement.parentElement.remove()" class="py-1 px-2 bg-red-700 hover:bg-red-600 rounded-md text-xs">AralÄ±ÄŸÄ± Sil</button>
        </div>
        <div class="rewards-list space-y-2"></div>
    `;
    container.appendChild(tierRow);

    if (tierData.rewards && tierData.rewards.length > 0) {
        tierData.rewards.forEach(reward => {
            const rewardsListContainer = tierRow.querySelector('.rewards-list');
            addRewardToTier(rewardsListContainer, reward);
        });
    }
}

function addRewardToTier(element, rewardData = {}) {
    const rewardsListContainer = element.matches('.rewards-list') ? element : element.closest('.damage-tier-row').querySelector('.rewards-list');
    const rewardRow = document.createElement('div');
    rewardRow.className = 'grid grid-cols-4 gap-2 items-center';
    rewardRow.innerHTML = `
        <select class="box-setting-input reward-type col-span-2">
            <option value="points">ğŸ’° Puan</option>
            <option value="boxRights">ğŸ“¦ Kutu HakkÄ±</option>
            <option value="wheelTicket">ğŸ« Ã‡ark Bileti</option>
            <option value="clickCatchTicket">ğŸŸï¸ TÄ±kla-Yakala Bileti</option>
            <option value="iflasShield">ğŸ›¡ï¸ Ä°flas KalkanÄ±</option>
            <option value="wildcard">ğŸƒ Joker Kart</option>
            <option value="card_pack">ğŸ´ Standart Kart Paketi</option>
            <option value="card_pack_normal">ğŸ¥‰ Bronz Kart Paketi</option>
            <option value="card_pack_gumus">ğŸ¥ˆ GÃ¼mÃ¼ÅŸ Kart Paketi</option>
            <option value="card_pack_altin">ğŸ¥‡ AltÄ±n Kart Paketi</option>
            <option value="card_pack_efsanevi">ğŸ† Efsanevi Kart Paketi</option>
            <option value="health_regen_potion">ğŸ§ª Can Yenileme Ä°ksiri</option>
            <option value="revival_stone">ğŸ’ Dirilme TaÅŸÄ±</option>
            <option value="health_potion">ğŸ§ª Can Ä°ksiri</option>
            <option value="damage_potion">âš”ï¸ Hasar Ä°ksiri</option>
            <option value="defense_potion">ğŸ›¡ï¸ Savunma Ä°ksiri</option>
            <option value="crit_potion">ğŸ’¥ Kritik VuruÅŸ Ä°ksiri</option>
            <option value="crit_damage_potion">ğŸ¯ Kritik Hasar Ä°ksiri</option>
            <option value="dodge_potion">ğŸ’¨ SÄ±yrÄ±lma ÅansÄ± Ä°ksiri</option>
            <option value="pierce_potion">ğŸ“Œ Delici ÅansÄ± Ä°ksiri</option>
        </select>
        <input type="number" class="box-setting-input reward-value" placeholder="Miktar" value="${rewardData.value || ''}">
        <div class="flex items-center gap-1">
           <input type="number" class="box-setting-input reward-chance" placeholder="Åans (%)" value="${rewardData.chance || ''}">
           <button onclick="this.parentElement.parentElement.remove()" class="text-red-500 text-xl font-bold">&times;</button>
        </div>
    `;
    // SeÃ§ili deÄŸeri ayarla
    if(rewardData.type) {
        rewardRow.querySelector('.reward-type').value = rewardData.type;
    }
    rewardsListContainer.appendChild(rewardRow);
}

// MEVCUT attackMonster FONKSÄ°YONUNU SÄ°L VE BUNUNLA DEÄÄ°ÅTÄ°R
async function attackMonster() {
    if (isAdmin) {
        displayMessage("Adminler saldÄ±ramaz.");
        return;
    }
    
    if (attackCooldown) return;

    const attackBtn = document.getElementById('attackMonsterBtn');
    
    try {
        const userRef = db.ref(`users/${currentUser}`);
        const battleRef = db.ref('gameConfig/monsterBattle');

        const [userSnap, battleSnap] = await Promise.all([userRef.once('value'), battleRef.once('value')]);
        
        const userData = userSnap.val();
        const battleData = battleSnap.val();

        if (!userData || !battleData || !battleData.monsterDetails || battleData.monsterDetails.currentHP <= 0) {
            throw new Error("SavaÅŸ durumu geÃ§ersiz veya canavar zaten Ã¶lÃ¼.");
        }
        
        const playerBattleData = battleData.damageLeaderboard?.[currentUser];

        if (!playerBattleData) {
            if (!userData.selectedAvatar || !userData.selectedAvatar.url) {
                displayMessage("SavaÅŸa katÄ±lmak iÃ§in Ã¶nce envanterden bir avatar seÃ§melisin!");
                return;
            }
            const confirmed = await customConfirm(
                `Canavara ilk saldÄ±rÄ±nÄ± yapÄ±yorsun! Bu saldÄ±rÄ±dan sonra, ÅŸu an seÃ§ili olan avatarÄ±n bu canavar Ã¶lene kadar kilitlenecek ve deÄŸiÅŸtirilemeyecek. Devam etmek istiyor musun?`
            );
            if (!confirmed) return; 
        }

        if (playerBattleData && playerBattleData.currentHP <= 0) {
            throw new Error("SavaÅŸmak iÃ§in canÄ±n kalmadÄ±! Dirilme TaÅŸÄ± kullanmalÄ±sÄ±n.");
        }
        
        attackCooldown = true;
        attackBtn.disabled = true;

        const playerAvatarUrl = playerBattleData?.lockedAvatarUrl || userData.selectedAvatar?.url || defaultAvatarUrl;
        const sanitizedPlayerAvatarId = sanitizeFirebaseKey(playerAvatarUrl);
        const playerBaseStats = avatarBaseStats[sanitizedPlayerAvatarId] || {};
        const globalBuffs = userData.globalPotionBuffs || {};

        const playerStats = {
            hp: (playerBaseStats.hp || 1000) + (globalBuffs.hp || 0),
            minDamage: (playerBaseStats.minDamage || 50) + (globalBuffs.damage || 0),
            maxDamage: (playerBaseStats.maxDamage || 100) + (globalBuffs.damage || 0),
            defense: (playerBaseStats.defense || 10) + (globalBuffs.defense || 0),
            critChance: (playerBaseStats.critChance || 5) + (globalBuffs.critChance || 0),
            critDamage: (playerBaseStats.critDamage || 10) + (globalBuffs.critDamage || 0),
            dodgeChance: (playerBaseStats.dodgeChance || 5) + (globalBuffs.dodgeChance || 0),
            pierceChance: (playerBaseStats.pierceChance || 5) + (globalBuffs.pierceChance || 0),
        };
        const monsterStats = battleData.monsterDetails;
        
        const monsterDefenseReduction = Math.min((monsterStats.defense || 0) / 100, 0.8);
        const playerDefenseReduction = Math.min((playerStats.defense || 0) / 100, 0.8);

        // --- Oyuncunun SaldÄ±rÄ± HesaplamasÄ± (GÃœNCELLENDÄ°) ---
        let finalDamageToMonster = 0;
        let playerAttackType = 'normal';
        const playerPierced = (Math.random() * 100) < playerStats.pierceChance;
        const didMonsterDodge = !playerPierced && (Math.random() * 100) < (monsterStats.dodgeChance || 0);
        let playerAttackDetails = '';

        if (didMonsterDodge) {
            playerAttackDetails = `Canavar saldÄ±rÄ±ndan <b class="text-cyan-400">sÄ±yrÄ±ldÄ±!</b>`;
        } else {
            const playerCritted = (Math.random() * 100) < playerStats.critChance;
            let totalDamage;

            // â˜…â˜…â˜… Ä°STEÄÄ°NE GÃ–RE DEÄÄ°ÅEN KRÄ°TÄ°K VURUÅ HESAPLAMASI BAÅLANGICI â˜…â˜…â˜…
            if (playerCritted) {
                // Kritik vuruÅŸ, MAKSÄ°MUM hasarÄ±n Ã¼zerine kritik hasar bonusunu ekler.
                totalDamage = playerStats.maxDamage + Math.floor(playerStats.maxDamage * (playerStats.critDamage / 100));
            } else {
                // Normal vuruÅŸ, minimum ve maksimum hasar arasÄ±nda rastgele bir deÄŸer alÄ±r.
                totalDamage = Math.floor(Math.random() * (playerStats.maxDamage - playerStats.minDamage + 1)) + playerStats.minDamage;
            }
            // â˜…â˜…â˜… KRÄ°TÄ°K VURUÅ HESAPLAMASI SONU â˜…â˜…â˜…
            
            if (playerPierced) {
                finalDamageToMonster = playerStats.maxDamage; // Delici vuruÅŸ her zaman maksimum hasar verir.
                playerAttackType = 'pierce';
                playerAttackDetails = `ğŸ“Œ <b class="text-purple-400">Delici VuruÅŸ</b> ile canavara <b class="text-white">${finalDamageToMonster} hasar</b> verdin.`;
            } else {
                finalDamageToMonster = Math.max(1, Math.floor(totalDamage * (1 - monsterDefenseReduction)));
                if(playerCritted) {
                    playerAttackType = 'crit';
                    playerAttackDetails = `ğŸ’¥ <b class="text-amber-400">Kritik VuruÅŸ</b> ile canavara <b class="text-white">${finalDamageToMonster} hasar</b> verdin.`;
                } else {
                    playerAttackDetails = `Canavara <b class="text-white">${finalDamageToMonster} hasar</b> verdin.`;
                }
            }
        }

        // --- CanavarÄ±n SaldÄ±rÄ± HesaplamasÄ± (GÃœNCELLENDÄ°) ---
        let finalDamageToPlayer = 0;
        let monsterAttackType = 'normal';
        const monsterPierced = (Math.random() * 100) < (monsterStats.pierceChance || 5);
        const didPlayerDodge = !monsterPierced && (Math.random() * 100) < playerStats.dodgeChance;
        let monsterAttackDetails = '';

        if (didPlayerDodge) {
            monsterAttackDetails = `CanavarÄ±n saldÄ±rÄ±sÄ±ndan <b class="text-cyan-400">sÄ±yrÄ±ldÄ±n!</b>`;
        } else {
            const monsterCritted = (Math.random() * 100) < (monsterStats.critChance || 5);
            let totalDamage;

            // â˜…â˜…â˜… CANAVAR Ä°Ã‡Ä°N DEÄÄ°ÅEN KRÄ°TÄ°K VURUÅ HESAPLAMASI BAÅLANGICI â˜…â˜…â˜…
            if (monsterCritted) {
                // Kritik vuruÅŸ, MAKSÄ°MUM hasarÄ±n Ã¼zerine kritik hasar bonusunu ekler.
                totalDamage = monsterStats.maxDamage + Math.floor(monsterStats.maxDamage * ((monsterStats.critDamage || 10) / 100));
            } else {
                // Normal vuruÅŸ, minimum ve maksimum hasar arasÄ±nda rastgele bir deÄŸer alÄ±r.
                totalDamage = Math.floor(Math.random() * (monsterStats.maxDamage - monsterStats.minDamage + 1)) + monsterStats.minDamage;
            }
            // â˜…â˜…â˜… KRÄ°TÄ°K VURUÅ HESAPLAMASI SONU â˜…â˜…â˜…

            if (monsterPierced) {
                finalDamageToPlayer = monsterStats.maxDamage; // Delici vuruÅŸ her zaman maksimum hasar verir.
                monsterAttackType = 'pierce';
                monsterAttackDetails = `ğŸ“Œ Canavar <b class="text-purple-400">delici vuruÅŸla</b> sana <b class="text-red-400">${finalDamageToPlayer} hasar</b> verdi.`;
            } else {
                finalDamageToPlayer = Math.max(1, Math.floor(totalDamage * (1 - playerDefenseReduction)));
                if(monsterCritted) {
                    monsterAttackType = 'crit';
                    monsterAttackDetails = `ğŸ’¥ Canavar <b class="text-amber-400">kritik vuruÅŸla</b> sana <b class="text-red-400">${finalDamageToPlayer} hasar</b> verdi.`;
                } else {
                    monsterAttackDetails = `Canavar sana <b class="text-red-400">${finalDamageToPlayer} hasar</b> verdi.`;
                }
            }
        }
        
        let randomReward = null;
        const damageTiers = (battleData.damageTiers || []).sort((a, b) => b.minDamage - a.minDamage);
        for (const tier of damageTiers) {
            if (finalDamageToMonster >= tier.minDamage) {
                const totalChance = tier.rewards.reduce((sum, r) => sum + r.chance, 0);
                let randomRoll = Math.random() * totalChance;
                for (const reward of tier.rewards) {
                    randomRoll -= reward.chance;
                    if (randomRoll <= 0) { randomReward = reward; break; }
                }
                break; 
            }
        }
        
        let finalPlayerHP = 0;
        let finalMonsterHP = 0;
        let finalTotalPlayerDamage = 0;
        let playerDiedInAttack = false;

        await battleRef.transaction(currentBattleData => {
            if (!currentBattleData || !currentBattleData.monsterDetails || currentBattleData.monsterDetails.currentHP <= 0) return;
            
            finalMonsterHP = Math.max(0, currentBattleData.monsterDetails.currentHP - finalDamageToMonster);
            currentBattleData.monsterDetails.currentHP = finalMonsterHP;

            if (!currentBattleData.damageLeaderboard) currentBattleData.damageLeaderboard = {};
            if (!currentBattleData.damageLeaderboard[currentUser]) {
                currentBattleData.damageLeaderboard[currentUser] = { totalDamage: 0, currentHP: playerStats.hp, lockedAvatarUrl: playerAvatarUrl };
            }

            const currentPlayerBattleData = currentBattleData.damageLeaderboard[currentUser];
            currentPlayerBattleData.totalDamage += finalDamageToMonster;
            finalTotalPlayerDamage = currentPlayerBattleData.totalDamage;
            
            currentPlayerBattleData.currentHP = Math.max(0, currentPlayerBattleData.currentHP - finalDamageToPlayer);
            finalPlayerHP = currentPlayerBattleData.currentHP;
            
            if (finalPlayerHP <= 0) playerDiedInAttack = true;
            return currentBattleData;
        });
        
        const updates = {};
        let rewardMessage = '';
        let rewardLogText = '';
        if (randomReward) {
            const { type, value } = randomReward;
            const prizeName = typeToName[type] || 'Ã–dÃ¼l';
            const isPercent = ['defense_potion', 'crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion'].includes(type);
            const valuePrefix = isPercent ? `+%` : `+`;
            
            rewardMessage = `<hr class="border-gray-600 my-2">ğŸ‰ <b>Ã–dÃ¼l:</b> <b class="text-green-400">${valuePrefix}${value} ${prizeName}</b> kazandÄ±n!`;
            rewardLogText = `${valuePrefix}${value} ${prizeName}`;
            
            if (type === 'health_regen_potion') {
                const currentPotions = userData.inventory?.health_regen_potion?.[value] || 0;
                updates[`/users/${currentUser}/inventory/health_regen_potion/${value}`] = currentPotions + 1;
            } else {
                const dbKeyMap = { points: 'balance', boxRights: 'kutuHakki', wheelTicket: 'carkBileti', clickCatchTicket: 'clickCatchTickets', iflasShield: 'iflasShieldUses', wildcard: 'wildcards', revival_stone: 'inventory/revival_stone' };
                const statKeyMap = { health_potion: 'hp', damage_potion: 'damage', defense_potion: 'defense', crit_potion: 'critChance', crit_damage_potion: 'critDamage', dodge_potion: 'dodgeChance', pierce_potion: 'pierceChance' };
                if (type === 'points') {
                    updates[`/users/${currentUser}/balance`] = (userData.balance || 0) + value;
                    updates[`/users/${currentUser}/kariyerPuani`] = (userData.kariyerPuani || 0) + value;
                } else if (type.startsWith('card_pack')) {
                     startCardPackOpening(value, 'Canavar SavaÅŸÄ±', 1, type);
                } else if (dbKeyMap[type]) {
                    const path = `/users/${currentUser}/${dbKeyMap[type]}`;
                    const pathParts = dbKeyMap[type].split('/');
                    const currentValue = pathParts.length > 1 ? (userData.inventory?.[pathParts[1]] || 0) : (userData[pathParts[0]] || 0);
                    updates[path] = currentValue + value;
                } else if (statKeyMap[type]) {
                    const statKey = statKeyMap[type];
                    const capCheck = checkPotionCap(userData, type, value);
                    if (capCheck.canAdd && capCheck.amount > 0) {
                        const path = `/users/${currentUser}/globalPotionBuffs/${statKey}`;
                        const currentValue = userData.globalPotionBuffs?.[statKey] || 0;
                        updates[path] = currentValue + capCheck.amount;
                        if(capCheck.isCapped) rewardMessage += ` (Limite ulaÅŸÄ±ldÄ±!)`;
                    } else {
                        rewardMessage += ` (Limitte olduÄŸu iÃ§in kazanÄ±lamadÄ±!)`;
                    }
                }
            }
        }
        if (Object.keys(updates).length > 0) await db.ref().update(updates);
        
        logActivity('monsterAttack', currentUser, {
            monsterName: monsterStats.name,
            damageDealt: finalDamageToMonster,
            damageTaken: finalDamageToPlayer,
            playerAttackType: playerAttackType,
            monsterAttackType: monsterAttackType,
            didPlayerDodge: didPlayerDodge,
            didMonsterDodge: didMonsterDodge,
            playerRemainingHP: finalPlayerHP,
            playerMaxHP: playerStats.hp,
            monsterRemainingHP: finalMonsterHP,
            monsterMaxHP: monsterStats.maxHP,
            playerTotalDamage: finalTotalPlayerDamage,
            rewardWon: rewardLogText,
            playerDied: playerDiedInAttack
        });
        
        let attackInfoMessage = `
            <div class="text-left space-y-2">
                <p><b>Senin SaldÄ±rÄ±n:</b> ${playerAttackDetails}</p>
                <p><b>CanavarÄ±n SaldÄ±rÄ±sÄ±:</b> ${monsterAttackDetails}</p>
                ${rewardMessage}
            </div>
        `;

        showFloatingText(`-${finalDamageToMonster}`, document.getElementById('monsterImage').getBoundingClientRect().left + 100, document.getElementById('monsterImage').getBoundingClientRect().top + 100);
        displayMessage(attackInfoMessage);
        
        const finalBattleSnap = await battleRef.once('value');
        const finalBattleData = finalBattleSnap.val();

        if (finalBattleData && finalBattleData.monsterDetails.currentHP <= 0) {
            const sortedLeaderboard = Object.entries(finalBattleData.damageLeaderboard || {}).sort((a,b) => b[1].totalDamage - a[1].totalDamage);
            const winner = sortedLeaderboard.length > 0 ? sortedLeaderboard[0][0] : null;
            const winnerData = winner ? finalBattleData.damageLeaderboard[winner] : null;
            const prize = finalBattleData.rewards?.onKillLeader;

            if (winner && prize && winnerData) {
                await db.ref('gameStats/lastMonsterChampion').set({
                    username: winner,
                    totalDamage: winnerData.totalDamage,
                    lockedAvatarUrl: winnerData.lockedAvatarUrl
                });

                const prizeName = typeToName[prize.type] || prize.type;
                const prizeText = `${prize.value} ${prizeName}`;
                
                logActivity('monsterDefeated', 'WeizendTv', { 
                    monsterName: finalBattleData.monsterDetails.name, 
                    winner: winner, 
                    prize: prizeText,
                    totalDamage: winnerData.totalDamage
                });
                
                const winnerRef = db.ref(`users/${winner}`);
                await winnerRef.transaction(winnerDataFromDB => {
                    if (winnerDataFromDB) {
                         const { type, value } = prize;
                         if(type === 'health_regen_potion'){
                            if(!winnerDataFromDB.inventory) winnerDataFromDB.inventory = {};
                            if(!winnerDataFromDB.inventory.health_regen_potion) winnerDataFromDB.inventory.health_regen_potion = {};
                            const currentPotions = winnerDataFromDB.inventory.health_regen_potion[value] || 0;
                            winnerDataFromDB.inventory.health_regen_potion[value] = currentPotions + 1;
                         } else {
                             const dbKeyMap = { points: 'balance', boxRights: 'kutuHakki', wheelTicket: 'carkBileti', clickCatchTicket: 'clickCatchTickets', iflasShield: 'iflasShieldUses', wildcard: 'wildcards', revival_stone: 'inventory/revival_stone' };
                             const statKeyMap = { health_potion: 'hp', damage_potion: 'damage', defense_potion: 'defense', crit_potion: 'critChance', crit_damage_potion: 'critDamage', dodge_potion: 'dodgeChance', pierce_potion: 'pierceChance' };
                             
                             if (type === 'points') {
                                winnerDataFromDB.balance = (winnerDataFromDB.balance || 0) + value;
                                winnerDataFromDB.kariyerPuani = (winnerDataFromDB.kariyerPuani || 0) + value;
                             } else if (type.startsWith('card_pack')) {
                                 const packKey = db.ref().push().key;
                                 if (!winnerDataFromDB.pendingActions) winnerDataFromDB.pendingActions = {};
                                 if (!winnerDataFromDB.pendingActions.cardPacks) winnerDataFromDB.pendingActions.cardPacks = {};
                                 winnerDataFromDB.pendingActions.cardPacks[packKey] = { type: type, count: value };
                             } else if (dbKeyMap[type]) {
                                 const pathParts = dbKeyMap[type].split('/');
                                 if (pathParts.length > 1) {
                                     if (!winnerDataFromDB[pathParts[0]]) winnerDataFromDB[pathParts[0]] = {};
                                     winnerDataFromDB[pathParts[0]][pathParts[1]] = (winnerDataFromDB[pathParts[0]][pathParts[1]] || 0) + value;
                                 } else {
                                     winnerDataFromDB[dbKeyMap[type]] = (winnerDataFromDB[dbKeyMap[type]] || 0) + value;
                                 }
                             } else if (statKeyMap[type]) {
                                const statKey = statKeyMap[type];
                                const capCheck = checkPotionCap(winnerDataFromDB, type, value);
                                if (capCheck.canAdd && capCheck.amount > 0) {
                                    if (!winnerDataFromDB.globalPotionBuffs) winnerDataFromDB.globalPotionBuffs = {};
                                    winnerDataFromDB.globalPotionBuffs[statKey] = (winnerDataFromDB.globalPotionBuffs[statKey] || 0) + capCheck.amount;
                                }
                             }
                         }

                         if (!winnerDataFromDB.monsterChampionships) {
                             winnerDataFromDB.monsterChampionships = [];
                         }
                         winnerDataFromDB.monsterChampionships.push({
                             timestamp: firebase.database.ServerValue.TIMESTAMP,
                             monsterName: finalBattleData.monsterDetails.name,
                             damage: winnerData.totalDamage
                         });
                    }
                    return winnerDataFromDB;
                });
            }
        }

    } catch (error) {
        displayMessage(error.message);
    } finally {
        let count = 3;
        const interval = setInterval(() => {
            attackBtn.textContent = `BEKLE (${count--})`;
            if (count < 0) {
                clearInterval(interval);
                attackCooldown = false;
                attackBtn.disabled = false;
                attackBtn.textContent = 'SALDIR!';
            }
        }, 1000);
    }
}
      
// YENÄ°: Canavar SavaÅŸÄ± Bilgi Modal'Ä±nÄ± aÃ§ar ve kapatÄ±r
function openMonsterBattleInfoModal() {
    document.getElementById('monsterBattleInfoModal').style.display = 'flex';
}
function closeMonsterBattleInfoModal() {
    document.getElementById('monsterBattleInfoModal').style.display = 'none';
}

// MEVCUT useRevivalStone FONKSÄ°YONUNU SÄ°L VE BUNUNLA DEÄÄ°ÅTÄ°R

async function useRevivalStone() {
    if (isAdmin) return;

    const reviveBtn = document.getElementById('reviveBtn');
    reviveBtn.disabled = true;

    try {
        const userRef = db.ref(`users/${currentUser}`);
        const battleRef = db.ref('gameConfig/monsterBattle');

        const [userSnap, battleSnap] = await Promise.all([userRef.once('value'), battleRef.once('value')]);
        
        const userData = userSnap.val();
        const battleData = battleSnap.val();
        
        const playerBattleData = battleData?.damageLeaderboard?.[currentUser];

        if (!playerBattleData || playerBattleData.currentHP > 0) {
            throw new Error("CanÄ±n zaten dolu veya savaÅŸta deÄŸilsin.");
        }

        const revivalStones = userData.inventory?.revival_stone || 0;
        if (revivalStones < 1) {
            displayMessage("Dirilmek iÃ§in Dirilme TaÅŸÄ±n yok! MaÄŸazadan veya diÄŸer etkinliklerden kazanabilirsin.");
            return; 
        }

        // --- DEÄÄ°ÅÄ°KLÄ°K BURADA BAÅLIYOR: Transaction daha spesifik hale getirildi ---
        // Sadece kullanÄ±cÄ±nÄ±n dirilme taÅŸÄ± sayÄ±sÄ±nÄ± gÃ¼ncelliyoruz.
        const stoneRef = userRef.child('inventory/revival_stone');
        const { committed } = await stoneRef.transaction(currentStones => {
            if ((currentStones || 0) > 0) {
                return currentStones - 1;
            }
            return; // Yeterli taÅŸ yoksa iÅŸlemi iptal et
        });
        
        if (!committed) {
            throw new Error("Dirilme taÅŸÄ± kullanÄ±lamadÄ±. Envanterin baÅŸka bir iÅŸlem tarafÄ±ndan gÃ¼ncellenmiÅŸ olabilir.");
        }
        // --- DEÄÄ°ÅÄ°KLÄ°K SONU ---

        const playerAvatarUrl = playerBattleData.lockedAvatarUrl || userData.selectedAvatar?.url || defaultAvatarUrl;
        const sanitizedPlayerAvatarId = sanitizeFirebaseKey(playerAvatarUrl);
        
        const globalBuffs = userData.globalPotionBuffs || {};
        const baseStats = avatarBaseStats[sanitizedPlayerAvatarId] || {};
        const playerMaxHP = (baseStats.hp || 1000) + (globalBuffs.hp || 0);

        await battleRef.child(`damageLeaderboard/${currentUser}/currentHP`).set(playerMaxHP);

        displayMessage("Dirilme TaÅŸÄ± kullanÄ±ldÄ± ve canÄ±n tamamen yenilendi. Tekrar savaÅŸa hazÄ±rsÄ±n!");

    } catch (error) {
        displayMessage(error.message);
    } finally {
        reviveBtn.disabled = false;
    }
}

// MEVCUT editCurrentMonster FONKSÄ°YONUNU SÄ°L VE BUNU YAPIÅTIR

/**
 * Adminin mevcut canavarÄ± dÃ¼zenlemek iÃ§in yÃ¶netim panelini aÃ§masÄ±nÄ± saÄŸlar.
 */
async function editCurrentMonster() {
    if (!isAdmin || !monsterBattleData.monsterDetails) return;
    
    const monster = monsterBattleData.monsterDetails;
    const rewards = monsterBattleData.rewards || {};
    const tiers = monsterBattleData.damageTiers || [];

    // Formu mevcut canavarÄ±n bilgileriyle doldur
    document.getElementById('adminMonsterName').value = monster.name || '';
    document.getElementById('adminMonsterImageUrl').value = monster.imageUrl || '';
    document.getElementById('adminMonsterMaxHP').value = monster.maxHP || '';
    document.getElementById('adminMonsterMinDamage').value = monster.minDamage || '';
    document.getElementById('adminMonsterMaxDamage').value = monster.maxDamage || '';
    document.getElementById('adminMonsterDefense').value = monster.defense || '';
    document.getElementById('adminMonsterCritChance').value = monster.critChance || '';
    
    // â˜…â˜…â˜… EKSÄ°K OLAN VE YENÄ° EKLENEN SATIRLAR â˜…â˜…â˜…
    document.getElementById('adminMonsterCritDamage').value = monster.critDamage || '';
    document.getElementById('adminMonsterDodgeChance').value = monster.dodgeChance || '';
    document.getElementById('adminMonsterPierceChance').value = monster.pierceChance || '';
    // â˜…â˜…â˜… EKLENEN SATIRLARIN SONU â˜…â˜…â˜…

    if (rewards.onKillLeader) {
        document.getElementById('adminMonsterKillRewardType').value = rewards.onKillLeader.type || 'points';
        document.getElementById('adminMonsterKillReward').value = rewards.onKillLeader.value || '';
    }

    // Hasar aralÄ±klarÄ±nÄ± temizle ve yeniden doldur
    const tiersContainer = document.getElementById('damageTiersContainer');
    tiersContainer.innerHTML = '';
    tiers.forEach(tier => addDamageTierRow(tier));

    // Paneli aÃ§
    document.getElementById('monsterAdminControls').classList.remove('hidden');
}

/**
 * Adminin mevcut canavarÄ± oyundan kaldÄ±rmasÄ±nÄ± saÄŸlar.
 */
async function deleteCurrentMonster() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Mevcut canavarÄ± ve tÃ¼m savaÅŸ ilerlemesini kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?");
    if (confirmed) {
        await db.ref('gameConfig/monsterBattle').remove();
        displayMessage("Canavar baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±.");
    }
}

function openMonsterInfoModal() {
    const monster = monsterBattleData.monsterDetails;
    if (!monster) return;

    document.getElementById('modalMonsterName').textContent = monster.name;
    
    // YENÄ° EKLENEN KOD BAÅLANGICI
    const imgEl = document.getElementById('modalMonsterImage');
    if (imgEl && monster.imageUrl) {
        imgEl.src = monster.imageUrl;
        imgEl.style.display = 'block';
    } else if (imgEl) {
        imgEl.style.display = 'none';
    }
    // YENÄ° EKLENEN KOD SONU
    
    const statsEl = document.getElementById('modalMonsterStats');
    statsEl.innerHTML = `
        <p>â¤ï¸ Can: <b class="text-white">${formatNumber(monster.maxHP)}</b></p>
        <p>âš”ï¸ Hasar: <b class="text-white">${formatNumber(monster.minDamage)} - ${formatNumber(monster.maxDamage)}</b></p>
        <p>ğŸ¯ Kritik Hasar: <b class="text-white">+%${monster.critDamage || 10}</b></p>
        <p>ğŸ›¡ï¸ Savunma ÅansÄ±: <b class="text-white">%${monster.defense || 0}</b></p>
        <p>ğŸ’¨ SÄ±yrÄ±lma ÅansÄ±: <b class="text-white">%${monster.dodgeChance || 5}</b></p>
        <p>ğŸ“Œ Delici VuruÅŸ ÅansÄ±: <b class="text-white">%${monster.pierceChance || 5}</b></p>
        <p>ğŸ’¥ Kritik VuruÅŸ ÅansÄ±: <b class="text-white">%${monster.critChance || 5}</b></p>
    `;

    const killReward = monsterBattleData.rewards?.onKillLeader;
    const killRewardEl = document.getElementById('modalKillReward');
    if (killReward) {
        const prizeName = typeToName[killReward.type] || killReward.type;
        killRewardEl.innerHTML = `CanavarÄ± Ã¶ldÃ¼ren takÄ±mÄ±n lideri <b class="text-green-400">${formatNumber(killReward.value)} ${prizeName}</b> kazanÄ±r.`;
    } else {
        killRewardEl.textContent = 'Liderlik Ã¶dÃ¼lÃ¼ belirlenmemiÅŸ.';
    }

    const tiers = monsterBattleData.damageTiers || [];
    const tiersEl = document.getElementById('modalDamageTiers');
    if (tiers.length > 0) {
        tiersEl.innerHTML = '';
        tiers.sort((a,b) => a.minDamage - b.minDamage).forEach(tier => {
            
            const rewardTexts = tier.rewards.map(r => {
                const isPercent = ['defense_potion', 'crit_potion', 'crit_damage_potion', 'dodge_potion', 'pierce_potion', 'health_regen_potion'].includes(r.type);
                const name = typeToName[r.type] || r.type;
                let valueText = '';

                if (isPercent) {
                    valueText = `+%${r.value} ${name}`;
                } 
                else {
                    valueText = `+${r.value} ${name}`;
                }
                
                return `${valueText} (%${r.chance})`;
            }).join(', ');
            
            tiersEl.innerHTML += `<div><b class="text-white">${formatNumber(tier.minDamage)}+ Hasar</b> vuranlar ÅŸu Ã¶dÃ¼llerden birini kazanma ÅŸansÄ± yakalar: <span class="text-cyan-300">${rewardTexts}</span></div>`;
        });
    } else {
        tiersEl.textContent = 'Bu canavar iÃ§in Ã¶zel hasar eÅŸiÄŸi Ã¶dÃ¼lÃ¼ ayarlanmamÄ±ÅŸ.';
    }

    document.getElementById('monsterInfoModal').style.display = 'flex';
}

/**
 * Canavar bilgi penceresini kapatÄ±r.
 */
function closeMonsterInfoModal() {
    document.getElementById('monsterInfoModal').style.display = 'none';
}

 /**
 * Firebase anahtarlarÄ±nda kullanÄ±lamayacak yasaklÄ± karakterleri temizler.
 * @param {string} key - Temizlenecek olan metin.
 * @returns {string} TemizlenmiÅŸ ve Firebase iÃ§in gÃ¼venli metin.
 */
function sanitizeFirebaseKey(key) {
    if (!key) return '';
    // Firebase'in yasakladÄ±ÄŸÄ± karakterleri (. # $ [ ] /) bulur ve kaldÄ±rÄ±r.
    // DEÄÄ°ÅÄ°KLÄ°K: ':' ve '/' karakterlerini de '_' ile deÄŸiÅŸtirerek URL'leri daha gÃ¼venli hale getiriyoruz.
    return key.replace(/[.#$[\]/]/g, '').replace(/:/g, '_');
}

// BU YENÄ° FONKSÄ°YONU EKLE
function handleWeeklyPrizeTypeChange() {
    const prizeType = document.getElementById('weeklyPrizeType').value;
    const amountInput = document.getElementById('weeklyPrizeAmount');
    const usesInput = document.getElementById('weeklyPrizeMultiplierUses');

    if (prizeType === 'tempMultiplier') {
        amountInput.placeholder = 'Ã‡arpan DeÄŸeri (Ã¶rn: 2)';
        usesInput.classList.remove('hidden');
    } else {
        amountInput.placeholder = 'Miktar';
        usesInput.classList.add('hidden');
    }
}

      // BU YEPYENÄ° FONKSÄ°YONU SCRIPT BLOÄUNUZUN UYGUN BÄ°R YERÄ°NE EKLEYÄ°N

function customAlert(message) {
    return new Promise(resolve => {
        const alertBox = document.createElement('div');
        // Z-index'i yÃ¼ksek tutarak diÄŸer modallarÄ±n Ã¼zerinde gÃ¶rÃ¼nmesini saÄŸlÄ±yoruz.
        alertBox.className = 'fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99999]';
        alertBox.innerHTML = `
          <div class="bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-md text-center relative">
            <p class="text-lg text-gray-300 mb-6">${message}</p>
            <button id="alertOkBtn" class="w-full py-3 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg">Tamam</button>
          </div>
        `;
        document.body.appendChild(alertBox);
        
        document.getElementById('alertOkBtn').onclick = (event) => { 
            event.preventDefault(); 
            alertBox.remove(); 
            resolve(true); // "Tamam" butonuna basÄ±ldÄ±ÄŸÄ±nda Promise'i Ã§Ã¶zerek beklemenin bitmesini saÄŸlÄ±yoruz.
        };
    });
}

async function convertWildcard() {
    if (isAdmin) return;

    const confirmed = await customConfirm("1 adet Joker Kart'Ä± 10 Kutu HakkÄ±'na dÃ¶nÃ¼ÅŸtÃ¼rmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!");
    if (!confirmed) return;

    const userRef = db.ref(`users/${currentUser}`);

    try {
        const { committed, snapshot } = await userRef.transaction(userData => {
            if (userData && (userData.wildcards || 0) > 0) {
                userData.wildcards--;
                userData.kutuHakki = (userData.kutuHakki || 0) + 10;
                return userData;
            }
            return; 
        });

        if (committed) {
            displayMessage("BaÅŸarÄ±lÄ±! 1 Joker Kart, 10 Kutu HakkÄ±'na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼.");
            logActivity('wildcardConvertedToBoxRights', currentUser, {
                boxRights: 10,
                newBoxRights: snapshot.val().kutuHakki
            });
            if (currentActiveSection === 'cardCollection') {
                loadCollectionAlbum();
            }
        } else {
            throw new Error("DÃ¶nÃ¼ÅŸtÃ¼rme iÅŸlemi baÅŸarÄ±sÄ±z oldu. Yeterli Joker KartÄ±nÄ±z olmayabilir.");
        }
    } catch (error) {
        displayMessage(error.message);
    }
}

      async function resetUser(username) {
    if (!isAdmin || !username) return;

    const confirmed = await customConfirm(
        `<b>${username}</b> adlÄ± kullanÄ±cÄ±yÄ± sÄ±fÄ±rlamak istediÄŸinize emin misiniz? Bu iÅŸlem, kullanÄ±cÄ±nÄ±n AvatarlarÄ±, Kasa PuanlarÄ± ve KalÄ±cÄ± Ä°ksir BonuslarÄ± DIÅINDAKÄ° tÃ¼m verilerini (puanlar, envanter, istatistikler, sÄ±ralamalar, kartlar vb.) kalÄ±cÄ± olarak silecektir!`
    );

    if (!confirmed) return;

    try {
        const userRef = db.ref(`users/${username}`);
        const userSnap = await userRef.once('value');
        if (!userSnap.exists()) {
            throw new Error("KullanÄ±cÄ± bulunamadÄ±.");
        }
        const userData = userSnap.val();

        // KORUNACAK VERÄ°LERÄ° YEDEKLE
        const preservedData = {
            kasaPuani: userData.kasaPuani || 0,
            avatars: userData.avatars || null,
            globalPotionBuffs: userData.globalPotionBuffs || null,
            password: userData.password,
            pin: userData.pin,
            approved: userData.approved,
            registeredAt: userData.registeredAt || new Date().toLocaleString()
        };

        // KULLANICIYI SÄ°LÄ°P KORUNAN VERÄ°LERLE YENÄ°DEN OLUÅTUR
        const updates = {};
        updates[`/users/${username}`] = preservedData;
        // GÃœNCELLENEN KISIM: Ä°lgili tÃ¼m liderlik tablolarÄ±ndan kullanÄ±cÄ±yÄ± temizle
        updates[`/clickCatchWeeklyScores/${username}`] = null;
        updates[`/gameConfig/monsterBattle/damageLeaderboard/${username}`] = null;
        
        await db.ref().update(updates);
        
        displayMessage(`${username} baÅŸarÄ±yla sÄ±fÄ±rlandÄ±. Kasa PuanÄ±, avatarlarÄ± ve iksir bonuslarÄ± korundu.`);
        closeUserManagementModal();
        
    } catch (error) {
        console.error("KullanÄ±cÄ± sÄ±fÄ±rlanÄ±rken hata oluÅŸtu:", error);
        displayMessage("KullanÄ±cÄ± sÄ±fÄ±rlanÄ±rken bir hata meydana geldi: " + error.message);
    }
}

// BU YEPYENÄ° FONKSÄ°YONU SCRIPT BLOÄUNUZA EKLEYÄ°N

async function resetUserPotionBonuses(username) {
    if (!isAdmin || !username) return;

    const confirmed = await customConfirm(
        `<b>${username}</b> adlÄ± kullanÄ±cÄ±nÄ±n maÄŸazadan aldÄ±ÄŸÄ± <b>tÃ¼m kalÄ±cÄ± iksir bonuslarÄ±nÄ±</b> sÄ±fÄ±rlamak istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!`
    );

    if (!confirmed) return;

    try {
        const userRef = db.ref(`users/${username}`);
        
        // KullanÄ±cÄ±nÄ±n globalPotionBuffs anahtarÄ±nÄ± silerek tÃ¼m bonuslarÄ± sÄ±fÄ±rla
        await userRef.child('globalPotionBuffs').remove();
        
        displayMessage(`${username} adlÄ± kullanÄ±cÄ±nÄ±n tÃ¼m kalÄ±cÄ± iksir bonuslarÄ± baÅŸarÄ±yla sÄ±fÄ±rlandÄ±.`);
        
        // ArayÃ¼zÃ¼ anÄ±nda gÃ¼ncellemek iÃ§in yÃ¶netim modalÄ±nÄ± yeniden aÃ§
        openUserManagementModal(event, username);
        
    } catch (error) {
        console.error("Ä°ksir bonuslarÄ± sÄ±fÄ±rlanÄ±rken hata oluÅŸtu:", error);
        displayMessage("Bonuslar sÄ±fÄ±rlanÄ±rken bir hata meydana geldi: " + error.message);
    }
}

// BU YEPYENÄ° FONKSÄ°YONU SCRIPT BLOÄUNUZA EKLEYÄ°N

/**
 * Adminin, tÃ¼m kullanÄ±cÄ±larÄ±n kalÄ±cÄ± iksir bonuslarÄ±nÄ± tek seferde sÄ±fÄ±rlamasÄ±nÄ± saÄŸlar.
 */
async function resetAllPotionBonuses() {
    if (!isAdmin) return;

    // Bu, Ã§ok gÃ¼Ã§lÃ¼ bir iÅŸlem olduÄŸu iÃ§in net bir onay mesajÄ± gÃ¶steriyoruz.
    const confirmed = await customConfirm(
        "TÃœM kullanÄ±cÄ±larÄ±n sahip olduÄŸu KALICI iksir bonuslarÄ±nÄ± sÄ±fÄ±rlamak istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!"
    );

    if (!confirmed) return;

    try {
        const usersRef = db.ref('users');
        const usersSnap = await usersRef.once('value');
        const usersData = usersSnap.val();

        // Tek seferde yapÄ±lacak tÃ¼m gÃ¼ncellemeleri bu objede toplayacaÄŸÄ±z.
        const updates = {};
        
        if (usersData) {
            for (const username in usersData) {
                // Sadece iksir bonusu olan kullanÄ±cÄ±lar iÃ§in silme iÅŸlemi hazÄ±rla
                if (usersData[username] && usersData[username].globalPotionBuffs) {
                    // globalPotionBuffs anahtarÄ±nÄ± null olarak ayarlamak, onu veritabanÄ±ndan siler.
                    updates[`/users/${username}/globalPotionBuffs`] = null;
                }
            }
        }

        // EÄŸer gÃ¼ncellenecek bir ÅŸey varsa (yani en az bir kullanÄ±cÄ±nÄ±n bonusu varsa)
        if (Object.keys(updates).length > 0) {
            await db.ref().update(updates);
            displayMessage("TÃ¼m kullanÄ±cÄ±larÄ±n kalÄ±cÄ± iksir bonuslarÄ± baÅŸarÄ±yla sÄ±fÄ±rlandÄ±.");
        } else {
            displayMessage("SÄ±fÄ±rlanacak iksir bonusuna sahip hiÃ§bir kullanÄ±cÄ± bulunamadÄ±.");
        }

    } catch (error) {
        console.error("Toplu iksir bonusu sÄ±fÄ±rlama hatasÄ±:", error);
        displayMessage("Ä°ÅŸlem sÄ±rasÄ±nda bir hata meydana geldi: " + error.message);
    }
}

// YENÄ° EKLENECEK KOD BAÅLANGICI

let potionCapsCache = {}; // Ä°ksir limitlerini Ã¶nbellekte tutmak iÃ§in

/**
 * Admin panelindeki iksir limiti ayarlarÄ±nÄ± veritabanÄ±ndan yÃ¼kler ve input'lara yazar.
 */
async function loadPotionCapsForAdmin() {
    if (!isAdmin) return;
    const capsRef = db.ref('gameConfig/potionCaps');
    const capsSnap = await capsRef.once('value');
    const caps = capsSnap.val() || {};

    document.getElementById('potionCapHp').value = caps.hp || '';
    document.getElementById('potionCapDamage').value = caps.damage || '';
    document.getElementById('potionCapDefense').value = caps.defense || '';
    document.getElementById('potionCapCritDamage').value = caps.critDamage || '';
    document.getElementById('potionCapDodge').value = caps.dodgeChance || '';
    document.getElementById('potionCapPierce').value = caps.pierceChance || '';
    document.getElementById('potionCapCrit').value = caps.critChance || '';
}

/**
 * Admin panelindeki iksir limiti ayarlarÄ±nÄ± kaydeder.
 */
async function savePotionCaps() {
    if (!isAdmin) return;
    const caps = {
        hp: parseInt(document.getElementById('potionCapHp').value) || null,
        damage: parseInt(document.getElementById('potionCapDamage').value) || null,
        defense: parseInt(document.getElementById('potionCapDefense').value) || null,
        critDamage: parseFloat(document.getElementById('potionCapCritDamage').value) || null,
        dodgeChance: parseFloat(document.getElementById('potionCapDodge').value) || null,
        pierceChance: parseFloat(document.getElementById('potionCapPierce').value) || null,
        critChance: parseFloat(document.getElementById('potionCapCrit').value) || null,
    };
    await db.ref('gameConfig/potionCaps').set(caps);
    displayMessage("Ä°ksir bonus limitleri baÅŸarÄ±yla kaydedildi.");
}

/**
 * Bir kullanÄ±cÄ±nÄ±n belirli bir iksiri alÄ±p alamayacaÄŸÄ±nÄ± ve ne kadar alabileceÄŸini kontrol eder.
 * @param {object} userData KullanÄ±cÄ±nÄ±n tam verisi.
 * @param {string} potionType 'health_potion', 'damage_potion' gibi iksir tipi.
 * @param {number} amountToAdd Eklenmek istenen miktar.
 * @returns {object} { canAdd: boolean, amount: number, isCapped: boolean }
 */
function checkPotionCap(userData, potionType, amountToAdd) {
    const statKeyMap = { 
        health_potion: 'hp', damage_potion: 'damage', defense_potion: 'defense', 
        crit_potion: 'critChance', crit_damage_potion: 'critDamage', 
        dodge_potion: 'dodgeChance', pierce_potion: 'pierceChance' 
    };
    const statKey = statKeyMap[potionType];
    if (!statKey) return { canAdd: true, amount: amountToAdd, isCapped: false }; // Bilinmeyen iksir tÃ¼rÃ¼, limitleme

    const cap = potionCapsCache[statKey];
    // EÄŸer bu stat iÃ§in bir limit belirlenmemiÅŸse, tam miktarÄ± eklemesine izin ver
    if (cap === undefined || cap === null) {
        return { canAdd: true, amount: amountToAdd, isCapped: false };
    }

    const currentBonus = userData.globalPotionBuffs?.[statKey] || 0;
    
    // KullanÄ±cÄ± zaten limitte veya limiti geÃ§miÅŸse, hiÃ§bir ÅŸey ekleyemez
    if (currentBonus >= cap) {
        return { canAdd: false, amount: 0, isCapped: true };
    }

    const potentialTotal = currentBonus + amountToAdd;
    // EÄŸer eklenecek miktar limiti aÅŸmÄ±yorsa, tam miktarÄ± eklemesine izin ver
    if (potentialTotal <= cap) {
        return { canAdd: true, amount: amountToAdd, isCapped: false };
    } 
    // EÄŸer eklenecek miktar limiti aÅŸÄ±yorsa, sadece limite ulaÅŸacak kadarÄ±nÄ± eklemesine izin ver
    else {
        const amountCanAdd = cap - currentBonus;
        return { canAdd: true, amount: amountCanAdd, isCapped: true };
    }
}

async function useHealthRegenPotion() {
    const selector = document.getElementById('regenPotionSelector');
    const useButton = document.getElementById('useRegenPotionBtn');

    if (useButton) useButton.disabled = true;

    try {
        const userRef = db.ref(`users/${currentUser}`);
        const battleRef = db.ref('gameConfig/monsterBattle');

        const [userSnap, battleSnap] = await Promise.all([userRef.once('value'), battleRef.once('value')]);
        
        const userData = userSnap.val();
        const battleData = battleSnap.val();
        const playerBattleData = battleData?.damageLeaderboard?.[currentUser];

        const regenPotions = userData.inventory?.health_regen_potion || {};
        const hasPotions = Object.values(regenPotions).some(count => count > 0);
        const playerCurrentHP = playerBattleData?.currentHP || 0;
        const isPlayerDead = playerCurrentHP <= 0;
        
        const playerAvatarUrl = playerBattleData?.lockedAvatarUrl || userData.selectedAvatar?.url || defaultAvatarUrl;
        const sanitizedPlayerAvatarId = sanitizeFirebaseKey(playerAvatarUrl);
        const playerMaxHP = (avatarBaseStats[sanitizedPlayerAvatarId]?.hp || 1000) + (userData.globalPotionBuffs?.hp || 0);
        const isPlayerFullHealth = playerCurrentHP >= playerMaxHP;
        const selectedValue = selector.value;

        if (isPlayerDead) {
            throw new Error("MaÄŸlup durumdayken can iksiri kullanamazsÄ±n!");
        }
        if (!hasPotions) {
            throw new Error("Mevcut can yenileme iksirin yok. MaÄŸazadan veya etkinliklerden kazanabilirsin.");
        }
        if (isPlayerFullHealth) {
            throw new Error("CanÄ±n zaten dolu olduÄŸu iÃ§in iksir kullanamazsÄ±n.");
        }
        if (!selectedValue) {
            throw new Error("LÃ¼tfen kullanmak iÃ§in bir iksir seÃ§.");
        }

        const percentage = parseInt(selectedValue);
        const potionCount = userData.inventory?.health_regen_potion?.[percentage] || 0;
        if (potionCount < 1) {
            throw new Error(`Kullanmak istediÄŸin %${percentage} iksirinden kalmamÄ±ÅŸ.`);
        }

        const healingAmount = Math.floor(playerMaxHP * (percentage / 100));
        const newHP = Math.min(playerMaxHP, playerCurrentHP + healingAmount);
        const actualHeal = newHP - playerCurrentHP;

        const updates = {};
        updates[`/users/${currentUser}/inventory/health_regen_potion/${percentage}`] = potionCount - 1;
        updates[`/gameConfig/monsterBattle/damageLeaderboard/${currentUser}/currentHP`] = newHP;
        
        await db.ref().update(updates);

        displayMessage(`BaÅŸarÄ±lÄ±! ${actualHeal} can yeniledin.`);
        
        // *** DEÄÄ°ÅÄ°KLÄ°K BURADA: Aktivite kaydÄ±na yeni can bilgileri eklendi ***
        logActivity('useRegenPotion', currentUser, { 
            percentage: percentage, 
            healed: actualHeal,
            newHP: newHP,
            playerMaxHP: playerMaxHP
        });

    } catch (error) {
        displayMessage(error.message);
    } finally {
        if (useButton) useButton.disabled = false;
        handlePotionSelectionChange();
    }
}

      // --- YENÄ° VE Ã‡ALIÅAN FONKSÄ°YON ---
async function saveAvatarStats() {
    if (!isAdmin) return;

    const confirmed = await customConfirm("TÃ¼m avatarlarÄ±n temel istatistiklerini kaydetmek istediÄŸinize emin misiniz? Bu iÅŸlem, tÃ¼m avatarlarÄ±n Ã¶zelliklerini gÃ¼ncelleyecektir.");
    if (!confirmed) return;

    const updates = {};
    let hasError = false;

    document.querySelectorAll('#avatarStatEditor .p-3').forEach(row => {
        if (hasError) return;
        const avatarId = row.dataset.avatarId;
        if (!avatarId) return;

        // SayÄ±sal deÄŸerleri alÄ±rken ondalÄ±k sayÄ±lar iÃ§in virgÃ¼lÃ¼ noktaya Ã§eviriyoruz
        const hp = parseInt(row.querySelector('.stat-hp').value);
        const minDamage = parseInt(row.querySelector('.stat-min-damage').value);
        const maxDamage = parseInt(row.querySelector('.stat-max-damage').value);
        const defense = parseInt(row.querySelector('.stat-defense').value);
        const critDamage = parseFloat(String(row.querySelector('.stat-crit-damage').value).replace(',', '.'));
        const dodgeChance = parseFloat(String(row.querySelector('.stat-dodge').value).replace(',', '.'));
        const pierceChance = parseFloat(String(row.querySelector('.stat-pierce').value).replace(',', '.'));
        const critChance = parseFloat(String(row.querySelector('.stat-crit').value).replace(',', '.'));
        
        // EÄŸer bir alanda geÃ§ersiz bir deÄŸer varsa (NaN), kullanÄ±cÄ±yÄ± uyar ve iÅŸlemi durdur.
        if (isNaN(hp) || isNaN(minDamage) || isNaN(maxDamage) || isNaN(defense) || isNaN(critDamage) || isNaN(dodgeChance) || isNaN(pierceChance) || isNaN(critChance)) {
            displayMessage("LÃ¼tfen tÃ¼m alanlarÄ± geÃ§erli sayÄ±larla doldurun. OndalÄ±klÄ± sayÄ±lar iÃ§in nokta (.) kullanÄ±n.");
            hasError = true;
            return;
        }
        
        updates[`/gameConfig/avatarBaseStats/${avatarId}`] = {
            hp: hp,
            minDamage: minDamage,
            maxDamage: maxDamage,
            defense: defense,
            critDamage: critDamage,
            dodgeChance: dodgeChance,
            pierceChance: pierceChance,
            critChance: critChance
        };
    });

    if (hasError) return;

    await db.ref().update(updates);
    displayMessage("TÃ¼m avatarlarÄ±n temel istatistikleri baÅŸarÄ±yla kaydedildi!");
}

// BU KOD BLOÄUNU let currentActiveSection = 'game'; SATIRININ ALTINA EKLE

let storeFilter = null; // MaÄŸazayÄ± filtrelemek iÃ§in kullanÄ±lacak global deÄŸiÅŸken

// Canavar sayfasÄ±ndan maÄŸazaya yÃ¶nlendirir ve iksir filtresini aktif eder
function goToMonsterStore() {
    storeFilter = 'monster_battle'; // Filtreyi 'canavar savaÅŸÄ±' olarak ayarla
    showSection('store'); // MaÄŸaza bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster
}

// YENÄ° EKLENECEK YARDIMCI FONKSÄ°YONLAR
// KalÄ±cÄ± bildirimleri dinler ve gÃ¶sterir
function listenForPersistentNotifications() {
    if (isAdmin) return;
    const ref = db.ref(`users/${currentUser}/persistentNotifications`);
    
    const callback = (snap) => {
        const notifId = snap.key;
        const notification = snap.val();
        
        if (notification && notification.type) {
            switch(notification.type) {
                case 'collectionCompleted':
                    showCollectionCompleteModal(notification);
                    break;
                case 'tradesCancelled':
                    // Bu bildirim iÃ§in ayrÄ± bir modal yerine genel mesajÄ± kullanabiliriz
                    displayMessage(notification.message);
                    break;
                // Gelecekte baÅŸka tÃ¼rde kalÄ±cÄ± bildirimler de eklenebilir
            }
            // Bildirimi gÃ¶sterdikten sonra veritabanÄ±ndan sil
            snap.ref.remove();
        }
    };
    
    if (activeListeners.persistentNotifs) {
        activeListeners.persistentNotifs.ref.off('child_added', activeListeners.persistentNotifs.callback);
    }
    activeListeners.persistentNotifs = { ref, event: 'child_added', callback };
    ref.on('child_added', callback);
}

// Koleksiyon tamamlama penceresini gÃ¶sterir
function showCollectionCompleteModal(notificationData) {
    document.getElementById('collectionCompleteTitle').innerHTML = notificationData.title;
    document.getElementById('collectionCompleteMessage').innerHTML = notificationData.message;
    document.getElementById('collectionCompleteModal').style.display = 'flex';
}

// Koleksiyon tamamlama penceresini kapatÄ±r
function closeCollectionCompleteModal() {
    document.getElementById('collectionCompleteModal').style.display = 'none';
}


// YENÄ° EKLENECEK YARDIMCI FONKSÄ°YONLAR SONU
      
// â˜…â˜…â˜… YENÄ° EKLENECEK FONKSÄ°YONLAR SONU â˜…â˜…â˜…
      
</script>
</body>
</html>
