<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WeizendTv Kutu Oyunu</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
  .floating-text {
      position: absolute;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      text-shadow: 1px 1px 3px black;
      animation: floatUp 1.5s ease-out forwards;
      pointer-events: none; /* Tıklanamaz yapar */
      z-index: 100;
  }
  @keyframes floatUp {
      0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
      }
      100% {
          opacity: 0;
          transform: translate(-50%, -150%) scale(1.2);
      }
  }
  body {
    font-family: 'Inter', sans-serif;
  }
  .inline-badge {
    margin-left: 4px; /* Rozetlerin soluna boşluk ekler */
    vertical-align: middle; /* Dikey olarak ortalar */
}
  .scrollable-list::-webkit-scrollbar {
    width: 8px;
  }
  .scrollable-list::-webkit-scrollbar-track {
    background: #333;
    border-radius: 10px;
  }
  .scrollable-list::-webkit-scrollbar-thumb {
    background: #b71c1c;
    border-radius: 10px;
  }
  .scrollable-list::-webkit-scrollbar-thumb:hover {
    background: #ff4444;
  }
  @keyframes glow {
    0%, 100% { box-shadow: 0 0 5px #fde047, 0 0 10px #fde047, 0 0 15px #fde047; }
    50% { box-shadow: 0 0 10px #facc15, 0 0 20px #facc15, 0 0 30px #facc15; }
  }
  .glowing-border {
    animation: glow 2.5s ease-in-out infinite;
  }
  .card-back, .card-front {
    backface-visibility: hidden;
    transition: transform 0.5s ease-in-out;
  }
  .card.opened .card-back {
    transform: rotateY(180deg);
  }
  .card.opened .card-front {
    transform: rotateY(0deg);
  }
  .card-front {
    transform: rotateY(-180deg);
  }
  .user-mention {
    background-color: #4a5568;
    color: #a0aec0;
    padding: 2px 5px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .user-mention:hover {
    background-color: #718096;
  }
  .user-mention.highlighted {
    background-color: #f59e0b;
    color: #1a202c;
    font-weight: bold;
  }
  .admin-controls button:disabled svg {
    fill: #4a5568;
    cursor: not-allowed;
  }
  #gameDiv.modal-is-open .admin-controls,
  #gameDiv.modal-is-open .best-seller-badge {
    visibility: hidden;
  }
  /* ŞANS ÇARKI STİLLERİ BAŞLANGIÇ */
#wheelContainer {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 2rem auto;
}

/* Sadece renkli dilimleri içeren dönen arka plan */
#wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 10px solid #4a5568;
    transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
    position: relative;
    /* Arka plan JS tarafından 'conic-gradient' ile doldurulacak */
}

  /* Yazıyı taşıyan ve merkezden dönen görünmez "çubuk" */
.wheel-text-container {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 50%; /* Çarkın yarıçapı kadar */
    height: 1px;
    transform-origin: left center; /* Merkezden dönmesini sağlar */
    z-index: 6; /* Yazıların renklerin üstünde olmasını sağlar */
}

/* Yazının kendisi */
.wheel-text {
    display: block;
    position: absolute;
    left: 70%; 
    top: 70%;
    
    /* Bu transform, yazıyı kendi boyutlarına göre tam olarak ortalar. */
    transform: translate(-80%, -80%);
    
    /* Görsel Stiller */
    color: white;
    font-size: 25px;
    font-weight: bold;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 1);
    white-space: nowrap;
}
  
  .wheel-image {
    display: block;
    position: absolute;
    left: 60%; 
    top: 50%;
    /* Boyutları ayarla */
    width: 45px;
    height: 45px;
    object-fit: contain; /* Resmin orantısını bozmadan sığdır */
    /* Ortalamak için transformu ayarla */
    transform: translate(-50%, -50%);
}
  
/* Üstteki sabit sarı ok işareti */
#wheelMarker {
    position: absolute;
    top: -5px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    border-top: 30px solid #fde047;
    z-index: 10;
}
/* ŞANS ÇARKI STİLLERİ BİTİŞ */
   /* Tıkla Yakala Stilleri */
   #clickCatchGameArea {
    width: 100%;
    max-width: 600px;
    height: 400px;
    background-color: #1a202c;
    border: 3px solid #b71c1c;
    border-radius: 10px;
    position: relative;
    overflow: hidden;
    cursor: crosshair;
  }
  .catch-item {
    position: absolute;
    width: 50px;
    height: 50px;
    background-size: contain;
    background-repeat: no-repeat;
    cursor: pointer;
    transition: transform 0.1s ease;
    /* --- YENİ EKLENEN KODLAR --- */
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none;    /* Firefox */
    -ms-user-select: none;     /* Internet Explorer/Edge */
    user-select: none;         /* Standart sözdizimi */
}
  .catch-item:hover {
      transform: scale(1.1);
  }
  /* Modal Başlığı Alanı (Güncellendi) */
  .modal-header {
    /* Butonu sağa yaslama komutunu kaldırıyoruz, artık kendi başına ortalanacak */
    padding-bottom: 1rem;
    border-bottom: 1px solid #4a5568;
    margin-bottom: 1rem;
  }

 /* ...VE BU ORİJİNAL HALİYLE DEĞİŞTİR */
.modal-close-button {
    position: absolute;
    top: 10px; /* Yukarıdan boşluk */
    right: 15px; /* Sağdan boşluk */
    color: white; /* Buton rengi */
    font-size: 28px; /* Buton yazı boyutu */
    line-height: 1; /* Satır yüksekliği */
    background: none; /* Arka planı transparan yapar */
    border: none; /* Kenarlığı kaldırır */
    cursor: pointer; /* Üzerine gelince fare işaretçisini değiştirir */
    opacity: 0.7; /* Başlangıçta biraz saydam yapar */
    transition: all 0.2s ease-in-out; /* Geçiş efekti */
    z-index: 10; /* Diğer içeriklerin üstünde kalmasını sağlar */
}

.modal-close-button:hover {
    opacity: 1; /* Üzerine gelince tam görünür yapar */
    transform: scale(1.1); /* Hafifçe büyütür */
    color: #ffdddd; /* Üzerine gelince renk değişimi */
}

/* Modal açıkken body'nin kaymasını engelleyen sınıf */
body.modal-open {
    overflow: hidden;
}

/* Modal içerisindeki kaydırılabilir alanların kaymasını engellememek için */
body.modal-open .modal-content {
    overflow-y: auto;
}
  .box-setting-input {
    width: 100%;
    padding: 10px;
    background-color: #374151; /* bg-gray-700 */
    border: 1px solid #4b5563; /* border-gray-600 */
    border-radius: 8px; /* rounded-lg */
    color: white;
  }
  .box-setting-input:focus {
    outline: none;
    border-color: #8b5cf6; /* focus:border-purple-500 */
    box-shadow: 0 0 0 2px #a78bfa; /* focus:ring-2 focus:ring-purple-400 */
  }
  body.modal-open {
    overflow: hidden;
}

</style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center py-8 px-4">
  <div id="globalAdminNotification" class="fixed top-5 left-1/2 -translate-x-1/2 w-auto max-w-md bg-blue-600 text-white px-6 py-3 rounded-lg shadow-xl text-center font-bold z-[100000] transition-all duration-500 ease-in-out opacity-0 -translate-y-20">
      </div>

  <header class="w-full max-w-4xl bg-gradient-to-r from-red-700 to-black text-white text-3xl font-extrabold tracking-wider py-4 rounded-xl shadow-xl mb-8 text-center relative">
    WEIZENDTV KUTU OYUNU
    
    <div id="seasonCountdownContainer" class="text-base font-normal mt-2 text-yellow-300 hidden flex justify-center items-center gap-2">
    <span>Aylık Sezonun Bitmesine: <span id="seasonCountdown" class="font-bold text-white tracking-wider"></span></span>
    <button onclick="openSeasonInfoModal()" class="text-blue-400 hover:text-blue-300 transition-colors" title="Aylık Sezon Sıfırlaması Hakkında Bilgi">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>
</div>
</header>

<div id="activityFeedPanel" class="fixed top-0 right-0 h-full w-full max-w-md bg-gray-800 border-l-2 border-red-700 shadow-2xl z-[10000] transform translate-x-full transition-transform duration-300 ease-in-out hidden">
      <div class="flex flex-col h-full">
          <div class="flex justify-between items-center p-4 border-b border-gray-700">
              <h4 class="text-yellow-400 text-2xl font-bold">Son Eylemler</h4>
              <button onclick="closeActivityFeed()" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
              </button>
          </div>
          <div id="activityFeedList" class="flex-grow overflow-y-auto p-4 scrollable-list">
              </div>
      </div>
</div>

<div id="loginContainer" class="bg-gray-800 p-8 rounded-xl shadow-lg border border-red-700 w-full max-w-md">
    <div class="flex border-b border-gray-600 mb-6">
        <button id="loginTabBtn" onclick="switchAuthTab('login')" class="flex-1 py-3 text-lg font-bold border-b-2 border-red-500 text-white transition-colors duration-300">Giriş Yap</button>
        <button id="registerTabBtn" onclick="switchAuthTab('register')" class="flex-1 py-3 text-lg font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors duration-300">Kayıt Ol</button>
    </div>

    <div id="loginDiv">
        <input type="text" id="loginUsername" placeholder="Kick Kullanıcı Adı" autocomplete="username"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="password" id="loginPassword" placeholder="Şifre" autocomplete="current-password"
               class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <button onclick="login()"
                class="w-full py-3 mb-4 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
          Giriş Yap
        </button>
        <p class="mt-4 text-center">
          <a href="#" onclick="openPasswordResetModal()" class="text-red-500 hover:text-red-400 font-bold transition duration-200">
            Şifremi Unuttum
          </a>
        </p>
    </div>

    <div id="registerDiv" class="hidden">
        <div id="kickWarning" class="bg-yellow-900/50 border border-yellow-400 text-yellow-300 px-4 py-3 rounded-lg relative mb-4 text-center">
            <strong class="font-bold">Kick Kullanıcı Adı Zorunludur!</strong>
            <span class="block sm:inline">Lütfen Kick platformundaki kullanıcı adınız ile kayıt olunuz.</span>
            <br>
            <span class="block sm:inline font-bold text-red-400 mt-2">ÖNEMLİ: Lütfen Kick şifrenizi değil, bu siteye özel yeni bir şifre oluşturun!</span>
        </div>
        <input type="text" id="registerUsername" placeholder="Kick Kullanıcı Adı" autocomplete="username"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="password" id="registerPassword" placeholder="Şifre (Yeni Bir Şifre Oluşturun)" autocomplete="new-password"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="password" id="registerPasswordConfirm" placeholder="Şifre Tekrar" autocomplete="new-password"
               class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />
        <input type="text" id="registerPin" placeholder="6 Haneli Unutulmaz Rakam (PIN)" maxlength="6"
               class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300" />

        <button onclick="register()"
                class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
          Kayıt Ol
        </button>
    </div>
</div>
<div id="gameDiv" class="w-full max-w-4xl hidden pb-16">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 mb-8 relative">
        <div class="flex flex-col items-center mb-4">
            <img id="currentUserAvatar" src="" class="w-24 h-24 rounded-full border-4 border-yellow-400 mb-3 object-cover shadow-lg cursor-pointer transition-opacity hover:opacity-80" onclick="openAvatarSelectionModal()">
            <div id="currentUserBadges" class="h-6 mb-1 flex items-center justify-center space-x-1"></div>
            <h3 class="text-yellow-400 text-2xl font-bold flex items-center justify-center">
                <span id="currentUser" class="inline-flex items-center cursor-pointer transition-opacity hover:opacity-80" onclick="openPublicUserDetailModal(currentUser)"></span> 
                <span id="role" class="text-base text-gray-400 ml-2"></span>
            </h3>
        </div>
        <p id="balance" class="text-lg text-gray-300 mb-4 text-center"></p>
        <div class="flex justify-center flex-wrap gap-4 mt-4">
            <button onclick="logout()" class="py-2 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md">Çıkış Yap</button>
            <button id="dailyRewardButton" onclick="openDailyRewardModal()" class="py-2 px-6 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg shadow-md relative">
                Günlük Ödül
                <span id="dailyRewardIndicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
            </button>
            <button id="inventoryButton" onclick="openInventoryModal()" class="py-2 px-6 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md">Envanter</button>
            <button id="adminPanelToggleButton" onclick="openAdminPanelModal()" class="py-2 px-6 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md hidden">Admin Paneli</button>
            <button id="helpButton" onclick="openHelpModal()" class="py-2 px-6 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">Yardım</button>
        </div>
        <div id="activityBellContainer" class="absolute top-3 right-3 hidden">
            <button onclick="toggleActivityFeed()" class="relative p-2 rounded-full hover:bg-white/20 transition-colors" title="Son Eylemler">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <span id="activityCounter" class="absolute top-0 right-0 h-5 w-5 bg-yellow-400 text-black text-xs font-bold rounded-full flex items-center justify-center hidden"></span>
            </button>
        </div>
    </div>

    <div class="flex justify-center flex-wrap gap-4 mb-8">
      <button id="gameTabBtn" onclick="showSection('game')"
              class="relative py-3 px-8 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Kutu Oyunu
      </button>
       <button id="chanceWheelTabBtn" onclick="showSection('chanceWheel')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Şans Çarkı
      </button>
       <button id="clickCatchTabBtn" onclick="showSection('clickCatch')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Tıkla-Yakala
      </button>
      <button id="storeTabBtn" onclick="showSection('store')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Puan Alışverişi
        <span id="storeIndicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
      </button>
      <button id="announcementsTabBtn" onclick="showSection('announcements')"
              class="relative py-3 px-8 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
        Duyurular
        <span id="announcementIndicator" class="hidden absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 animate-pulse"></span>
      </button>
    </div>
    
    <div id="mainContentArea" class="w-full">
    <div id="gameContent" class="w-full">
      <div class="text-lg text-gray-300 mb-6 text-center flex flex-wrap justify-center items-center gap-4">
        <button id="boxSettingsButton" onclick="openBoxSettingsModal()" class="hidden py-1 px-3 text-sm bg-purple-600 hover:bg-purple-500 rounded-lg">Kutu Ayarları</button>
        <span>Toplam Açılan: <b id="totalOpenedBoxesCount" class="font-bold text-yellow-400">0</b></span>
        <button onclick="openBoxStatsModal()" class="py-1 px-3 text-sm bg-blue-600 hover:bg-blue-500 rounded-lg">Açanlar Detay</button>
        <button onclick="openUnopenedBoxContentsModal()" class="py-1 px-3 text-sm bg-green-600 hover:bg-green-500 rounded-lg">Kalan İçerikler</button>
        <button onclick="openSolveProblemsModal()" class="py-1 px-3 text-sm bg-orange-600 hover:bg-orange-500 rounded-lg">Sorunları Çöz</button>
      </div>

      <div id="boxContainer" class="grid grid-cols-[repeat(auto-fill,minmax(80px,1fr))] gap-2 w-full mx-auto mb-8 p-2">
      </div>
      <div id="tablesWrapper" class="flex flex-wrap justify-center gap-6 mb-8">
        <div class="tableBox bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 w-full md:flex-1 min-w-[280px] md:max-w-md">
            <h3 class="text-yellow-400 text-xl font-bold border-b border-gray-600 pb-3 mb-4">KULLANICI PUAN SIRALAMASI 🥇</h3>
            <p class="text-gray-300 mb-3">Toplam Kullanıcı: <span id="totalUsers" class="font-bold text-yellow-400">0</span></p>
            <input type="text" id="searchUserRanking" oninput="renderUserRankings()" placeholder="Sıralamada Kullanıcı Ara..." class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <div id="allUserRankings" class="scrollable-list max-h-80 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-900 text-sm leading-relaxed">Yükleniyor...</div>
        </div>
        <div class="tableBox bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 w-full md:flex-1 min-w-[280px] md:max-w-md">
           <h3 class="text-yellow-400 text-xl font-bold border-b border-gray-600 pb-3 mb-4 flex justify-between items-center">
                <span>LİDERLER SIRALAMASI 👑</span>
                <button onclick="openBadgeInfoModal()" class="text-xl text-blue-400 hover:text-blue-300 transition-colors" title="Rozet Bilgileri">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
            </h3>
          <div id="badgedUsersRanking" class="scrollable-list max-h-80 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-900 text-sm leading-relaxed">Yükleniyor...</div>
        </div>
      </div>
    </div>
    
    <div id="lastSurpriseFinderPanel" class="hidden w-full max-w-2xl mx-auto mt-6 bg-gray-800 p-6 rounded-xl shadow-lg border-2 border-amber-400 text-center space-y-3">
        </div>

        <div id="chanceWheelContent" class="w-full hidden">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 text-center">
        <div class="flex justify-center items-center gap-4 mb-4">
    <h3 class="text-yellow-400 text-3xl font-bold">Şans Çarkı</h3>

    <button onclick="openWheelLegendModal()" class="text-blue-400 hover:text-blue-300 transition-colors" title="Simge Anlamları">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    </button>

    <button id="wheelSettingsButton" onclick="openWheelSettingsModal()" class="hidden py-1 px-3 text-sm bg-teal-600 hover:bg-teal-500 rounded-lg">Çark Ayarları</button>
</div>
        
        <p class="text-gray-300 mb-2">Çarkı çevirerek harika ödüller kazanma şansı yakala!</p>
        <p class="text-lg font-semibold mb-4">Çevirme Bedeli: <span class="text-green-400">1 Çark Bileti</span> | Mevcut Biletlerin: <span id="wheelTicketBalance" class="text-yellow-400 font-bold">0</span></p>
        
        <div id="wheelContainer">
    <div id="wheel"></div>
    <div id="wheelMarker"></div>
</div>

        <button id="spinWheelBtn" onclick="spinWheel()" class="py-3 px-10 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
            Çarkı Çevir!
        </button>

        <div class="mt-8 bg-gray-900/50 p-4 rounded-lg border border-gray-700 max-w-lg mx-auto">
            <h4 class="text-yellow-300 text-lg font-semibold mb-3">Son Kazananlar</h4>
            <div id="wheelHistoryList" class="scrollable-list max-h-40 overflow-y-auto text-left">
                </div>
        </div>
    </div>
</div>
<div id="solveProblemsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-orange-500 w-11/12 max-w-lg text-center relative">
    <button class="modal-close-button" onclick="closeSolveProblemsModal()">&times;</button>
    <h4 class="text-orange-300 text-2xl font-bold mb-6">Sorun Giderme Menüsü</h4>
    <p class="text-gray-400 mb-6">Buradaki araçları kullanarak oyunda oluşabilecek genel sorunları çözebilirsiniz.</p>
    <div class="space-y-4">
        <button onclick="manualUnlockGame()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">
            Kutu açmaya devam et.
        </button>
        <button onclick="manualResetAfterSurprise()" class="w-full py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">
            Oyunu baştan başlat (Sürpriz Kutu Sonrası)
        </button>
    </div>
  </div>
</div>
      <div id="lobbyNotificationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-blue-500 w-11/12 max-w-md text-center relative">
    <h4 class="text-blue-400 text-3xl font-bold mb-4">📢 Tıkla-Yakala Lobisi Kuruldu! 📢</h4>
    <div id="lobbyNotificationInfo" class="text-lg text-gray-200 space-y-3 bg-gray-900 p-4 rounded-lg">
        </div>
    <div class="flex gap-4 mt-8">
        <button onclick="closeLobbyNotificationModal()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">
          Kapat
        </button>
        <button onclick="goToLobbySection()" class="flex-1 py-3 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md">
          Lobiye Git
        </button>
    </div>
  </div>
</div>

        <div id="clickCatchContent" class="w-full hidden">
    
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 text-center">
                <div class="flex justify-center items-center gap-4 mb-4">
    <h3 class="text-yellow-400 text-3xl font-bold">Tıkla-Yakala</h3>
    <button onclick="openClickCatchInfoModal()" class="text-blue-400 hover:text-blue-300 transition-colors" title="Oyun Modları Hakkında Bilgi">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>
</div>
                <div id="weeklyWinnerContainer" class="hidden w-full max-w-2xl mx-auto mt-6 mb-4 bg-gray-800 p-4 rounded-xl shadow-lg border-2 border-green-500 text-center relative">
    <h4 class="text-green-300 text-xl font-bold mb-3">🏆 Haftanın Tıkla-Yakala Şampiyonu 🏆</h4>
    <div id="weeklyWinnerInfo" class="text-lg text-gray-200 space-y-2">
        </div>
    <button id="clearWeeklyWinnerBtn" onclick="clearWeeklyWinnerDisplay()" class="hidden absolute -top-3 -right-3 bg-red-600 hover:bg-red-500 text-white rounded-full h-8 w-8 flex items-center justify-center text-lg font-bold" title="Kazanan Panelini Gizle">&times;</button>
</div>
        
                <div id="clickCatchAdminButtonsContainer" class="hidden bg-gray-900/50 p-4 rounded-lg border border-yellow-500 mb-6 flex justify-center gap-4">
                    <button onclick="openSoloGameSettingsModal()" class="py-3 px-6 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-md">
                        Tekli Oyun Ayarları
                    </button>
                    <button onclick="openLobbySettingsModal()" class="py-3 px-6 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">
                        Lobi Yönetim Paneli
                    </button>
                </div>
        
                <div id="lastWinnerContainer" class="hidden bg-gray-900/50 p-4 rounded-lg border border-yellow-400 mb-6 text-left">
    <h4 id="lastWinnerInfo" class="text-yellow-300 text-xl font-semibold mb-3 border-b border-gray-700 pb-2"></h4>
    <div id="lastGameDetailsList" class="space-y-2">
        </div>
</div>
                
                <div id="lobbyStatusContainer" class="hidden bg-blue-900/50 p-4 rounded-lg border border-blue-400 mb-6">
                    <h4 id="lobbyStatusTitle" class="text-blue-300 text-xl font-semibold animate-pulse">Lobi Katılıma Açık!</h4>
                    <p id="lobbyStatusInfo" class="mt-2 text-gray-200"></p>
                    <div id="lobbyPlayerList" class="mt-2 text-sm text-gray-400"></div>
                </div>
                
                <div class="flex justify-around items-center mb-4 bg-gray-900 p-3 rounded-lg">
                    <div id="displayScore" class="hidden">
                        <p class="text-gray-400 text-sm">Toplanan Skor</p>
                        <p id="clickCatchScore" class="text-green-400 font-bold text-lg">0</p>
                    </div>
                    <div id="displaySpecials" class="hidden">
                        <p class="text-gray-400 text-sm">Alınan Ödüller</p>
                        <div id="collectedSpecials" class="h-[28px] flex items-center justify-center gap-2"></div>
                    </div>
                    <div id="displayTarget" class="hidden">
                        <p class="text-gray-400 text-sm">Hedef</p>
                        <p id="clickCatchTarget" class="text-purple-400 font-bold text-lg">0 / 10</p>
                    </div>
                    <div id="displayTimer" class="hidden">
                        <p class="text-gray-400 text-sm">Kalan Süre</p>
                        <p id="clickCatchTimer" class="text-yellow-400 font-bold text-lg">30</p>
                    </div>
                </div>
                <div id="clickCatchGameAreaContainer" class="flex justify-center mb-4">
                    <div id="clickCatchGameArea">
                         <div id="clickCatchStartScreen" class="w-full h-full flex flex-col justify-center items-center bg-black bg-opacity-50">
                            <p class="text-xl mb-6">Oyun Modunu Seç</p>
                            <div class="flex gap-4">
                               <button id="startSoloGameBtn" onclick="startSoloClickCatchGame()" class="py-3 px-10 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-md">Tek Oyna</button>
                               <button id="joinLobbyBtn" onclick="joinLobby()" class="py-3 px-10 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Lobiye Katıl</button>
                            </div>
                        </div>
                        
                        <div id="gameCountdownOverlay" class="absolute inset-0 bg-gray-900/90 hidden flex-col justify-center items-center text-center z-20">
                            <p class="text-6xl font-extrabold text-yellow-400 animate-pulse" id="countdownText"></p>
                        </div>
                        
                        <div id="lobbyGameOverScreen" class="absolute inset-0 bg-gray-900/95 rounded-lg hidden flex flex-col items-center justify-center p-8 text-center border-4 border-gray-700">
                            <h4 id="lobbyGameOverTitle" class="text-white text-3xl font-bold mb-4">Oyun Bitti!</h4>
                            <p id="lobbyGameOverInfo" class="text-xl text-gray-200 mb-6"></p>
                            <button onclick="closeLobbyGameOverScreen()" class="mt-4 py-2 px-6 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
                                Oyun Ekranına Dön
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="tableBox bg-gray-800 p-6 rounded-xl shadow-lg border border-red-700 w-full md:flex-1 min-w-[280px] mt-6 mx-auto max-w-2xl">
    <h3 class="text-yellow-400 text-xl font-bold border-b border-gray-600 pb-3 mb-4">TIKLA-YAKALA HAFTALIK SKOR SIRALAMASI 🎯</h3>
    <input type="text" id="searchClickCatchRanking" oninput="loadClickCatchRankings()" placeholder="Sıralamada Kullanıcı Ara..." class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
    
    <div id="weeklyResetCountdownContainer" class="hidden text-center bg-purple-900/50 border border-purple-400 text-purple-200 p-3 rounded-lg mb-4">
        <div class="flex justify-center items-center gap-2">
            <span>Haftalık Liderin Belirlenmesine: <span id="weeklyResetCountdown" class="font-bold text-white tracking-wider"></span></span>
            <button onclick="openWeeklyResetInfoModal()" class="text-blue-400 hover:text-blue-300 transition-colors" title="Haftalık Sıfırlama Hakkında Bilgi">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
        </div>
    </div>

    <div id="clickCatchRankings" class="scrollable-list max-h-80 overflow-y-auto border border-gray-600 rounded-lg p-3 bg-gray-900 text-sm leading-relaxed">Yükleniyor...</div>
</div>
        
        </div>
            
        <div id="storeSection" class="w-full hidden">
          <h3 class="text-yellow-400 text-3xl font-bold mb-2 text-center">Mağaza</h3>
          <div id="storeUserPointInfo" class="text-center mb-6 bg-gray-800 p-3 rounded-lg border border-gray-700 max-w-lg mx-auto flex justify-center items-center gap-4">
            <div>
                <span class="text-green-400">Mevcut Puan: <b id="storeCurrentUserBalance">0</b></span> |
                <span class="text-red-400">Harcanan Puan: <b id="storeCurrentUserSpent">0</b></span>
            </div>
            <button onclick="openPurchaseHistoryModal()" class="py-1 px-4 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg text-sm">
                Alışveriş Geçmişim
            </button>
          </div>
          
          <div id="adminStoreManagementButtonContainer" class="text-center mb-6 hidden">
             <button onclick="openNewItemForm()" class="py-2 px-6 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">
               Yeni Ürün Ekle
             </button>
          </div>
        
          <div class="flex border-b border-gray-600 mb-6 max-w-md mx-auto">
            <button id="gameStoreTabBtn" onclick="switchStoreTab('game')" class="flex-1 py-3 text-lg font-bold border-b-2 border-red-500 text-white transition-colors duration-300">Oyun Mağazası</button>
            <button id="specialStoreTabBtn" onclick="switchStoreTab('special')" class="flex-1 py-3 text-lg font-bold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors duration-300">Özel Ürün Mağazası</button>
          </div>
          
          <div id="gameStoreItemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
            </div>
        
          <div id="specialStoreItemsContainer" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
            </div>
        </div>
        
        <div id="announcementsContent" class="w-full hidden">
            <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">Duyurular</h3>
            
            <div id="adminAnnouncementControls" class="hidden bg-gray-800 p-6 rounded-lg border border-gray-700 mb-8 max-w-2xl mx-auto">
              <h4 id="announcementFormTitle" class="text-yellow-300 text-xl font-semibold mb-4">Yeni Duyuru Yap</h4>
              <textarea id="announcementText" placeholder="Duyuru metnini buraya yazın... Kullanıcıları etiketlemek için @kullaniciadi formatını kullanın." rows="4" class="w-full p-2 mb-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500"></textarea>
              <div class="flex gap-4">
                <button id="postAnnouncementBtn" onclick="postAnnouncement()" class="flex-1 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">DUYURU YAP</button>
                <button id="cancelEditAnnouncementBtn" onclick="resetAnnouncementForm()" class="hidden py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg">İptal</button>
              </div>
            </div>

            <div id="announcementsList" class="space-y-6 max-w-2xl mx-auto">
                <p class="text-center text-gray-400">Duyurular yükleniyor...</p>
            </div>
        </div>
    </div>
</div>
  
<div id="adminStoreModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-60 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-3xl text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button" onclick="closeAdminStoreModal()">&times;</button>
      <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">Ürün Ekle / Düzenle</h3>
      <div id="adminStoreControls" class="bg-gray-900 p-6 rounded-lg border border-gray-700 mb-6">
          <div class="mb-4">
            <input type="text" id="newItemName" placeholder="Ürün Adı" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <textarea id="newItemDescription" placeholder="Ürün Açıklaması" rows="3" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300"></textarea>
            <input type="number" id="newItemCost" placeholder="Maliyet (Puan)" min="1" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <input type="number" id="newItemStock" placeholder="Stok Durumu (Opsiyonel, boş bırakılırsa sınırsız)" min="0" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <select id="newItemType" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
              <option value="">Ürün Tipi Seçin</option>
              <option value="boxRights">Kutu Hakkı</option>
              <option value="wheelTicket">Çark Bileti</option>
              <option value="clickCatchTicket">Tıkla-Yakala Bileti</option>
              <option value="tempMultiplier">Geçici Çarpan</option>
              <option value="iflasShield">İflas Kalkanı</option>
              <option value="special">Özel Ürün (Onay Gerektirir)</option>
              <option value="avatar">Avatar</option>
            </select>
            <input type="number" id="newItemValue" placeholder="Değer (Kutu Hakkı Adedi / Çarpan Değeri / Kalkan Sayısı)" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <input type="number" id="newItemMultiplierDuration" placeholder="Çarpan Süresi (Kutu Sayısı)" min="1" class="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white hidden focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            
            <label class="text-gray-300 text-sm block mt-2 mb-1 text-left">Geri Sayım Süresi (Boş Bırakılırsa Süresiz):</label>
            <div class="flex gap-2 mb-4">
                <input type="number" id="storeItemCountdownDays" placeholder="Gün" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <input type="number" id="storeItemCountdownHours" placeholder="Saat" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <input type="number" id="storeItemCountdownMinutes" placeholder="Dakika" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <input type="number" id="storeItemCountdownSeconds" placeholder="Saniye" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>

            <input type="text" id="newItemImageUrl" placeholder="Resim URL (Opsiyonel)" class="w-full p-2 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500 transition duration-300">
            <button onclick="saveStoreItem()" id="addUpdateStoreItemBtn" class="w-full py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-1 transition duration-300">ÜRÜN EKLE</button>
            <button onclick="resetStoreItemForm()" class="w-full py-2 mt-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md hover:-translate-y-1 transition duration-300">Formu Temizle</button>
          </div>
        </div>
  </div>
</div>

<div id="purchaseHistoryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-2xl text-center relative max-h-[90vh]">
        <button class="modal-close-button absolute top-2 right-4 text-white text-4xl leading-none bg-transparent border-none cursor-pointer hover:text-red-500 transition duration-200" onclick="closePurchaseHistoryModal()">&times;</button>
        <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">Satın Alma Geçmişi</h3>
        <div id="purchaseHistoryList" class="scrollable-list max-h-[70vh] overflow-y-auto">
            <div class='text-center text-gray-400'>Satın alma geçmişi yükleniyor...</div>
        </div>
    </div>
</div>

<div id="boxStatsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-lg text-center relative max-h-[90vh]">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl" onclick="closeBoxStatsModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-4">Güncel Tur Kutu Açma İstatistikleri</h4>
      <p class="text-sm text-gray-400 mb-6">Bu istatistikler oyun sıfırlandığında temizlenir.</p>
      <div id="boxStatsList" class="scrollable-list max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-lg">
          Yükleniyor...
      </div>
  </div>
</div>

<div id="globalSurpriseBoxModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-md text-center relative">
        <h4 class="text-yellow-400 text-3xl font-bold mb-4">🎉 SÜRPRİZ KUTU! 🎉</h4>
        <div class="text-lg text-gray-200 space-y-3">
            <p><span id="surpriseOpener" class="text-green-400 font-bold text-2xl"></span> adlı kullanıcı,</p>
            <p id="surpriseSourceInfo"></p>
            <p class="text-3xl text-yellow-300 font-extrabold my-4">
                <span id="surprisePoints"></span> Puan
            </p>
            <p id="surpriseMultiplierInfo" class="text-base text-gray-400 -mt-2"></p>
            <p>kazandı!</p>
        </div>
        <button onclick="closeGlobalSurpriseBoxModal()" class="mt-8 w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">
            Tamam
        </button>
    </div>
</div>

<div id="adminPanelModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-2xl border border-yellow-500 w-full max-w-7xl h-[95vh] text-white relative flex flex-col">
    <button class="modal-close-button" onclick="closeAdminPanelModal()">&times;</button>
    
    <div class="flex-shrink-0 mb-4">
      <h3 class="text-yellow-300 text-3xl font-bold text-center">Yönetim Paneli</h3>
      <p class="text-center text-gray-400">Tüm yönetim araçları elinizin altında.</p>
    </div>

    <div class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto scrollable-list pr-2">
      
      <div class="flex flex-col gap-6">
        <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700">
          <h4 class="text-yellow-200 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Onay Bekleyenler</h4>
          <div class="space-y-4">
            <div>
              <h5 class="text-gray-300 font-bold mb-2">Kullanıcılar</h5>
              <div id="pendingUsers" class="scrollable-list max-h-48 overflow-y-auto p-2 bg-gray-900/50 rounded-md">Yükleniyor...</div>
            </div>
            <div>
              <h5 class="text-gray-300 font-bold mb-2">Özel Ürün Alımları</h5>
              <div id="pendingSpecialPurchasesList" class="scrollable-list max-h-48 overflow-y-auto p-2 bg-gray-900/50 rounded-md">Yükleniyor...</div>
            </div>
          </div>
        </div>

        <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700">
          <h4 class="text-red-400 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Tehlikeli Bölge</h4>
          <div class="flex flex-wrap gap-3 justify-center">
            <div class="bg-gray-800/80 p-6 rounded-xl border border-green-500">
    <h4 class="text-green-300 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">🏆 Aylık Sezon Yönetimi 👑</h4>
    <button onclick="openSeasonManagementModal()" class="w-full py-3 bg-green-800 hover:bg-green-700 text-white font-bold rounded-lg">Sezon Ayarlarını Aç</button>
</div>
          
            <button onclick="restartSystem()" class="flex-1 py-2 px-3 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg text-sm">Sistemi Sıfırla</button>
            <button onclick="clearAllTotalSpentPoints()" class="flex-1 py-2 px-3 bg-purple-800 hover:bg-purple-700 text-white font-bold rounded-lg text-sm">Harcanan Puanları Temizle</button>
            <button onclick="clearPurchaseHistory()" class="flex-1 py-2 px-3 bg-pink-800 hover:bg-pink-700 text-white font-bold rounded-lg text-sm">Satın Alma Geçmişini Sil</button>
          </div>
        </div>
      </div>
      
      <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700 flex flex-col">
        <h4 class="text-yellow-200 text-xl font-semibold mb-4 border-b border-gray-600 pb-2 flex-shrink-0">Kullanıcı Yönetimi</h4>
        <div class="flex-shrink-0 mb-4">
          <input type="text" id="searchUser" placeholder="Kullanıcı Ara..." oninput="searchUsers()" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-yellow-500 focus:ring-2 focus:ring-yellow-500 transition duration-300">
        </div>
        <div id="allUsers" class="flex-grow scrollable-list overflow-y-auto bg-gray-900/50 p-2 rounded-md">Yükleniyor...</div>
      </div>
      
      <div class="bg-gray-800/80 p-6 rounded-xl border border-gray-700">
        <h4 class="text-yellow-200 text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Toplu Kullanıcı İşlemleri</h4>
        <div class="space-y-6">
          <div>
            <label for="globalPoint" class="block text-gray-300 mb-1">Toplu Puan İşlemi</label>
            <input type="number" id="globalPoint" placeholder="Puan Miktarı" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="changeAllPoints(true)" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Ekle</button>
              <button onclick="changeAllPoints(false)" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sil</button>
            </div>
          </div>
          <div>
            <label for="globalBoxRight" class="block text-gray-300 mb-1">Toplu Kutu Hakkı İşlemi</label>
            <input type="number" id="globalBoxRight" placeholder="Kutu Hakkı Miktarı" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="changeAllBoxRights(true)" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Ekle</button>
              <button onclick="changeAllBoxRights(false)" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sil</button>
            </div>
          </div>
          <div>
            <label for="globalShield" class="block text-gray-300 mb-1">Toplu İflas Kalkanı İşlemi</label>
            <input type="number" id="globalShield" placeholder="Kalkan Miktarı" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="changeAllShields(true)" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Ekle</button>
              <button onclick="changeAllShields(false)" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sil</button>
            </div>
          </div>
          <div>
            <label for="globalWheelTicket" class="block text-gray-300 mb-1">Toplu Çark Bileti İşlemi</label>
            <input type="number" id="globalWheelTicket" placeholder="Bilet Miktarı" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="changeAllWheelTickets(true)" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Ekle</button>
              <button onclick="changeAllWheelTickets(false)" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sil</button>
            </div>
          </div>
          <div>
            <label for="globalClickCatchTicket" class="block text-gray-300 mb-1">Toplu Tıkla-Yakala Bileti İşlemi</label>
            <input type="number" id="globalClickCatchTicket" placeholder="Bilet Miktarı" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="changeAllClickCatchTickets(true)" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Ekle</button>
              <button onclick="changeAllClickCatchTickets(false)" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sil</button>
            </div>
          </div>
          <div>
            <label for="globalMultiplier" class="block text-gray-300 mb-1">Toplu Çarpan İşlemi</label>
            <input type="number" id="globalMultiplier" placeholder="Çarpan Değeri (örn: 2, 3)" min="2" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <input type="number" id="globalMultiplierUses" placeholder="Kullanım Sayısı" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            <div class="flex gap-2">
              <button onclick="setAllMultipliers()" class="flex-1 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Uygula</button>
              <button onclick="clearAllMultipliers()" class="flex-1 py-2 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg text-sm">Sıfırla</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  <div id="pointAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closePointAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Kullanıcı Puan Ayarı: <span id="adjUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Puan: <span id="adjUserBalance" class="font-bold"></span></p>
      <input type="number" id="adjAmount" placeholder="Puan Miktarı" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserPoints(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Puan Ekle</button>
        <button onclick="adjustUserPoints(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Puan Çıkar</button>
      </div>
    </div>
</div>

<div id="boxRightAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeBoxRightAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Kullanıcı Kutu Hakkı Ayarı: <span id="adjBoxRightUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Kutu Hakkı: <span id="adjUserBoxRight" class="font-bold"></span></p>
      <input type="number" id="adjBoxRightAmount" placeholder="Kutu Hakkı Miktarı" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserBoxRights(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Kutu Hakkı Ekle</button>
        <button onclick="adjustUserBoxRights(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Kutu Hakkı Çıkar</button>
      </div>
    </div>
</div>

<div id="wheelTicketAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeWheelTicketAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Kullanıcı Çark Bileti Ayarı: <span id="adjWheelTicketUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Çark Bileti: <span id="adjUserWheelTicket" class="font-bold"></span></p>
      <input type="number" id="adjWheelTicketAmount" placeholder="Bilet Miktarı" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserWheelTickets(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Bilet Ekle</button>
        <button onclick="adjustUserWheelTickets(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Bilet Çıkar</button>
      </div>
    </div>
</div>

<div id="clickCatchTicketAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeClickCatchTicketAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Kullanıcı Tıkla-Yakala Bileti Ayarı: <span id="adjClickCatchTicketUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Bilet Sayısı: <span id="adjUserClickCatchTicket" class="font-bold"></span></p>
      <input type="number" id="adjClickCatchTicketAmount" placeholder="Bilet Miktarı" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserClickCatchTickets(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Bilet Ekle</button>
        <button onclick="adjustUserClickCatchTickets(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Bilet Çıkar</button>
      </div>
    </div>
</div>

<div id="iflasShieldAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeIflasShieldAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Kullanıcı İflas Kalkanı Ayarı: <span id="adjIflasShieldUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut İflas Kalkanı: <span id="adjUserIflasShield" class="font-bold"></span></p>
      <input type="number" id="adjIflasShieldAmount" placeholder="İflas Kalkanı Miktarı" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <div class="flex gap-4 justify-center">
        <button onclick="adjustUserIflasShields(true)" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Kalkan Ekle</button>
        <button onclick="adjustUserIflasShields(false)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Kalkan Çıkar</button>
      </div>
    </div>
</div>

<div id="multiplierAdjustmentModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeMultiplierAdjustmentModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Kullanıcı Çarpan Ayarı: <span id="adjMultiplierUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Mevcut Çarpan: <span id="adjUserMultiplier" class="font-bold"></span> (Kalan Kullanım: <span id="adjUserMultiplierUses" class="font-bold"></span>)</p>
      <div class="mb-4">
        <label for="setMultiplierValue" class="block text-left text-gray-300 mb-1">Çarpan Değeri:</label>
        <input type="number" id="setMultiplierValue" placeholder="Çarpan Değeri (örn: 2, 3, 5)" min="1" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
      </div>
      <div class="mb-4">
        <label for="setMultiplierSource" class="block text-left text-gray-300 mb-1">Çarpan Kaynağı:</label>
        <select id="setMultiplierSource" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
          <option value="none">Yok</option>
          <option value="store">Mağaza</option>
          <option value="box">Kutu</option>
        </select>
      </div>
      <div class="mb-6">
        <label for="setMultiplierUses" class="block text-left text-gray-300 mb-1">Kalan Kullanım (Sadece Mağaza İçin):</label>
        <input type="number" id="setMultiplierUses" placeholder="Kalan Kullanım" min="0" class="w-full p-3 mb-2 bg-gray-700 border border-gray-600 rounded-lg text-white" />
      </div>
      <div class="flex gap-4 justify-center">
        <button onclick="setMultiplier()" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Çarpanı Ayarla</button>
        <button onclick="resetMultiplier()" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Çarpanı Sıfırla</button>
      </div>
    </div>
</div>

<div id="blockDurationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeBlockDurationModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Kullanıcıyı Engelle: <span id="blockUserName"></span></h4>
      <p class="text-lg text-gray-300 mb-4">Engelleme Süresi (Dakika):</p>
      <input type="number" id="blockDuration" placeholder="Süre (dakika)" min="1" class="w-full p-3 mb-6 bg-gray-700 border border-gray-600 rounded-lg text-white" /><br>
      <button onclick="confirmBlockUser()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Engellemeyi Onayla</button>
    </div>
</div>

<div id="blockedMessageModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <h4 class="text-red-500 text-3xl font-bold mb-6">HESABINIZ ENGELLENDİ</h4>
      <p id="blockedReason" class="text-lg text-gray-300 mb-4"></p>
      <p id="blockedCountdown" class="text-2xl text-yellow-400 font-semibold"></p>
    </div>
</div>

<div id="kickVerificationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeKickVerificationModal()">&times;</button>
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">Kick Kullanıcı Adı Doğrulaması</h4>
    <p class="text-lg text-gray-300 mb-6">
      Kayıt işleminin son adımı olarak, hesabınızı doğrulamak için Kick sohbet kanalımıza gidip
      <span class="text-green-400 font-bold p-1 bg-gray-900 rounded">!doğrula</span>
      yazarak göndermeniz gerekmektedir. Onaylandıktan sonra giriş yapabilirsiniz.
    </p>
    <button onclick="window.open('https://kick.com/popout/weizendtv/chat', '_blank'); closeKickVerificationModal();" class="w-full py-3 bg-green-500 hover:bg-green-400 text-gray-900 font-bold rounded-lg">
      Kick Sohbete Git
    </button>
  </div>
</div>

<div id="passwordResetModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closePasswordResetModal()">&times;</button>
      <div id="resetStep1">
          <h4 class="text-yellow-400 text-2xl font-bold mb-6">Şifre Sıfırlama (Adım 1/2)</h4>
          <input type="text" id="resetUsername" placeholder="Kick Kullanıcı Adı" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <input type="text" id="resetPin" placeholder="6 Haneli PIN" maxlength="6" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <button onclick="verifyResetInfo()" class="w-full py-3 mt-4 bg-red-700 hover:bg-red-600 rounded-lg font-bold">Bilgileri Doğrula</button>
      </div>
      <div id="resetStep3" class="hidden">
          <h4 class="text-yellow-400 text-2xl font-bold mb-6">Yeni Şifre Belirle (Adım 2/2)</h4>
          <input type="password" id="newPassword" placeholder="Yeni Şifre" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <input type="password" id="newPasswordConfirm" placeholder="Yeni Şifre Tekrar" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">
          <button onclick="updatePassword()" class="w-full py-3 mt-4 bg-red-700 hover:bg-red-600 rounded-lg font-bold">Şifreyi Güncelle</button>
      </div>
  </div>
</div>

<div id="generalMessageModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeGeneralMessageModal()">&times;</button>
    <p id="generalMessageContent" class="text-lg text-gray-300 mb-6"></p>
    <button onclick="closeGeneralMessageModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Tamam</button>
  </div>
</div>

<div id="welcomeGiftModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <h4 class="text-yellow-400 text-3xl font-bold mb-4">Aramıza Hoş Geldin!</h4>
    <p class="text-lg text-gray-300 mb-6">WeizendTV Kutu Oyunu'na katıldığın için teşekkürler! Başlangıç olarak sana özel bir hediyemiz var.</p>
    <p class="text-2xl text-green-400 font-bold mb-8">🎁 3 Kutu Açma Hakkı Kazandın!</p>
    <button onclick="closeWelcomeGiftModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Harika!</button>
  </div>
</div>

<div id="cardSelectionModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-2xl text-center relative">
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">Sürpriz Kutu! Bir Kart Seçin</h4>
    
    <h4 id="cardSelectionCountdown" class="text-red-500 text-2xl font-bold mb-4">60</h4>

    <div class="card-container grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 justify-center items-center"></div>
  </div>
</div>

<div id="openedBoxInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <button class="modal-close-button" onclick="closeOpenedBoxInfoModal()">&times;</button>
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">Açılan Kutu Bilgisi</h4>
    <div id="openedBoxInfoContent" class="text-lg text-gray-300 mb-6"></div>
    <button onclick="closeOpenedBoxInfoModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Tamam</button>
  </div>
</div>

<div id="globalOpenedBoxInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[100000] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">KUTU AÇILDI!</h4>
    <div id="globalOpenedBoxInfoContent" class="text-lg text-gray-300 mb-4"></div>
    <p id="globalOpenedBoxCountdown" class="text-xl text-yellow-400 font-semibold"></p>
  </div>
</div>

<div id="userManagementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-xl text-center relative max-h-[90vh] flex flex-col">
    
    <div class="p-8 pb-4 flex-shrink-0">
        <button class="modal-close-button absolute top-2 right-4 text-white text-4xl leading-none bg-transparent border-none cursor-pointer hover:text-red-500 transition duration-200" onclick="closeUserManagementModal()">&times;</button>
        <img id="managedUserAvatar" src="" class="w-24 h-24 rounded-lg mx-auto mb-4 object-contain">
        <h4 class="text-yellow-400 text-2xl font-bold">Kullanıcı Yönetimi: <span id="managedUserName"></span></h4>
    </div>

    <div class="overflow-y-auto px-8 pb-8">
        <div id="managedUserDetails" class="text-left text-gray-300 mb-6 space-y-1">
            <p><span id="managedBadgeBalance" class="inline-block w-6 text-center"></span>Mevcut Puan: <span id="managedUserBalance" class="font-bold text-yellow-300"></span></p>
            <p><span id="managedBadgeHighest" class="inline-block w-6 text-center"></span>Ulaşılan En Yüksek Puan: <span id="managedUserHighestBalance" class="font-bold text-green-400"></span></p>
            <p>Kutu Hakkı: <span id="managedUserBoxRight" class="font-bold text-green-400"></span></p>
            <p>Şans Çarkı Bileti: <span id="managedUserWheelTickets" class="font-bold text-yellow-400"></span></p>
            <p>Tıkla-Yakala Bileti: <span id="managedUserClickCatchTickets" class="font-bold text-fuchsia-400"></span></p>
            <p>İflas Kalkanı: <span id="managedUserIflasShield" class="font-bold text-blue-400"></span></p>
            <p>Aktif Çarpan: <span id="managedUserMultiplier" class="font-bold text-purple-400"></span></p>
            <p>Çarpan Kalan Kullanım: <span id="managedUserMultiplierUses" class="font-bold text-purple-400"></span></p>
            <p>Engelli Durumu: <span id="managedUserBlockedStatus" class="font-bold"></span></p>
            <p id="managedUserBlockedCountdownContainer" class="hidden text-red-400">Kalan Süre: <span id="managedUserBlockedCountdown" class="font-bold"></span></p>
            <hr class="my-3 border-gray-600">
            <p><span id="managedBadgeBox" class="inline-block w-6 text-center"></span>Açılan Kutu (Tüm Zamanlar): <span id="managedUserBoxesOpened" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeSurprise" class="inline-block w-6 text-center"></span>Sürpriz Kutu Buldu: <span id="managedUserSurpriseBoxes" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeBomb" class="inline-block w-6 text-center"></span>Bulunan Bomba Sayısı: <span id="managedUserBombCount" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeMultiplier" class="inline-block w-6 text-center"></span>Bulunan Çarpan Sayısı: <span id="managedUserMultiplierFoundCount" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeStore" class="inline-block w-6 text-center"></span>Mağazada Harcanan Puan: <span id="managedUserTotalSpent" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeShield" class="inline-block w-6 text-center"></span>Kullanılan Kalkan Sayısı: <span id="managedUserShieldUsedCount" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeClickCatch" class="inline-block w-6 text-center"></span>Tıkla-Yakala Rekoru: <span id="managedUserClickCatchScore" class="font-bold text-fuchsia-400"></span></p>
            <p><span id="managedBadgeWheel" class="inline-block w-6 text-center"></span>Çevrilen Çark Sayısı: <span id="managedUserWheelSpins" class="font-bold text-fuchsia-400"></span></p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <button onclick="openPointAdjustmentModal(selectedUserForManagement)" class="py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">Puan Ayarı</button>
            <button onclick="openBoxRightAdjustmentModal(selectedUserForManagement)" class="py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg shadow-md">Kutu Hakkı Ayarı</button>
            <button onclick="openIflasShieldAdjustmentModal(selectedUserForManagement)" class="py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-lg shadow-md">İflas Kalkanı Ayarı</button>
            <button onclick="openWheelTicketAdjustmentModal(selectedUserForManagement)" class="py-3 bg-pink-600 hover:bg-pink-500 text-white font-bold rounded-lg shadow-md">Çark Bileti Ayarı</button>
            <button onclick="openClickCatchTicketAdjustmentModal(selectedUserForManagement)" class="py-3 bg-fuchsia-600 hover:bg-fuchsia-500 text-white font-bold rounded-lg shadow-md">Tıkla-Yakala Bileti Ayarı</button>
            <button onclick="openMultiplierAdjustmentModal(selectedUserForManagement)" class="py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-md">Çarpan Ayarı</button>
            <button id="toggleBlockUserBtn" class="py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg shadow-md">Engelle / Engeli Kaldır</button>
            <button onclick="resetUser(selectedUserForManagement)" class="py-3 bg-orange-600 hover:bg-orange-500 text-white font-bold rounded-lg shadow-md">Kullanıcıyı Sıfırla</button>
            <button onclick="denyUser(selectedUserForManagement, false, true)" class="py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md lg:col-span-3">Kullanıcıyı Sil</button>
        </div>
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 mt-6">
            <h4 class="text-yellow-300 text-xl font-semibold mb-4">Avatar Yönetimi</h4>
            <div id="managedUserAvatarGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 scrollable-list max-h-60 overflow-y-auto p-3 bg-gray-800 rounded-md">
            </div>
        </div>
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 mt-6">
            <h4 class="text-yellow-300 text-xl font-semibold mb-4">Kullanıcının Satın Alma Geçmişi</h4>
            <div id="managedUserPurchaseHistory" class="scrollable-list max-h-60 overflow-y-auto p-3 bg-gray-800 rounded-md">
                <div class='text-center text-gray-400'>Satın alma geçmişi yükleniyor...</div>
            </div>
        </div>
    </div>

  </div>
</div>

<div id="publicUserDetailModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-10001 hidden" onclick="closeModalOnClickOutside(event)">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-yellow-500 w-11/12 max-w-2xl text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
    <button class="modal-close-button absolute top-4 right-4 text-gray-400 hover:text-white text-4xl transition-colors" onclick="closePublicUserDetailModal()">&times;</button>

    <div class="flex flex-col items-center gap-4 mb-6">
    <img id="publicUserAvatar" src="" class="w-28 h-28 rounded-full border-4 border-yellow-400 object-cover">
    <div class="flex flex-col items-center text-center">
        <div id="publicUserProfileBadges" class="flex items-center justify-center gap-2 h-8 mb-2"></div>
        <h4 id="publicUserName" class="text-yellow-300 text-3xl font-bold">
          </h4>
    </div>
</div>
   <div id="publicUserBlockedInfo" class="hidden bg-red-900/50 border border-red-500 text-red-300 p-3 rounded-lg mb-4">
     <div id="publicUserChampionships" class="hidden w-full max-w-lg mx-auto bg-yellow-900/50 border-2 border-yellow-500 text-yellow-200 p-4 rounded-xl mb-6 space-y-2 text-center shadow-lg">
    </div>
        Bu kullanıcı engellidir. Kalan süre: <span id="publicUserBlockedCountdown" class="font-bold"></span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
        <div class="bg-gray-800/70 p-4 rounded-xl border border-gray-700">
    <h5 class="font-bold text-yellow-200 text-xl mb-3 border-b border-gray-600 pb-2">Puan & Envanter</h5>
    <div class="space-y-3 text-gray-300">
        <p class="flex justify-between items-center"><span><span id="publicBadgeBalance" class="inline-block w-6 text-center"></span>Mevcut Puan:</span> <span id="publicUserBalance" class="font-bold text-yellow-300 text-lg"></span></p>
        <p class="flex justify-between items-center"><span><span id="publicBadgeHighest" class="inline-block w-6 text-center"></span>Ulaşılan En Yüksek Puan:</span> <span id="publicUserHighestBalance" class="font-bold text-green-400 text-lg"></span></p>
        <hr class="border-gray-600 !my-2">
                <p class="flex justify-between items-center"><span> Kutu Hakkı:</span> <span id="publicUserBoxRight" class="font-bold text-green-400 text-lg"></span></p>
                <p class="flex justify-between items-center"><span> Şans Çarkı Bileti:</span> <span id="publicUserWheelTickets" class="font-bold text-yellow-400 text-lg"></span></p>
                <p class="flex justify-between items-center"><span> Tıkla-Yakala Bileti:</span> <span id="publicUserClickCatchTickets" class="font-bold text-fuchsia-400 text-lg"></span></p>
                <p class="flex justify-between items-center"><span> İflas Kalkanı:</span> <span id="publicUserIflasShield" class="font-bold text-blue-400 text-lg"></span></p>
                <p class="flex justify-between items-center"><span> Aktif Çarpan:</span> <span id="publicUserMultiplier" class="font-bold text-purple-400 text-lg text-right"></span></p>
            </div>
        </div>

        <div class="bg-gray-800/70 p-4 rounded-xl border border-gray-700">
            <h5 class="font-bold text-yellow-200 text-xl mb-3 border-b border-gray-600 pb-2">Oyun İstatistikleri</h5>
            <div class="space-y-3 text-gray-300">
                <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-box"></span>Toplam Açılan Kutu:</span> <span id="publicUserBoxesOpened" class="font-bold text-fuchsia-400 text-lg"></span></p>
                <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-wheel"></span>Toplam Çevrilen Çark:</span> <span id="publicUserWheelSpins" class="font-bold text-fuchsia-400 text-lg"></span></p>
                <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-clickcatch"></span>Tıkla-Yakala Skoru:</span> <span id="publicUserClickCatchScore" class="font-bold text-fuchsia-400 text-lg"></span></p>
                <hr class="border-gray-600 !my-2">
                <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-surprise"></span>Bulunan Sürpriz Kutu:</span> <span id="publicUserSurpriseBoxes" class="font-bold text-fuchsia-400 text-lg"></span></p>
                <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-bomb"></span>Bulunan Bomba Sayısı:</span> <span id="publicUserBombCount" class="font-bold text-fuchsia-400 text-lg"></span></p>
                <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-multiplier"></span>Bulunan Çarpan Sayısı:</span> <span id="publicUserMultiplierFoundCount" class="font-bold text-fuchsia-400 text-lg"></span></p>
                <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-shield"></span>Kullanılan Kalkan Sayısı:</span> <span id="publicUserShieldUsedCount" class="font-bold text-fuchsia-400 text-lg"></span></p>
                <p class="flex justify-between items-center"><span><span class="inline-block w-6 text-center" id="badge-stat-store"></span>Mağazada Harcanan Puan:</span> <span id="publicUserTotalSpent" class="font-bold text-fuchsia-400 text-lg"></span></p>
            </div>
        </div>
    </div>
     <button onclick="closePublicUserDetailModal()" class="mt-6 w-full max-w-xs mx-auto py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg transition-colors">Kapat</button>
  </div>
</div>
  <div id="inventoryModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-700 w-11/12 max-w-md text-center relative">
      <button class="modal-close-button" onclick="closeInventoryModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Envanterin</h4>
      <div id="inventoryDetails" class="text-left text-gray-300 mb-6 space-y-3 bg-gray-900 p-4 rounded-lg border border-gray-700">
          <p class="flex justify-between items-center"><span>📦 Kutu Hakkı:</span> <strong id="inventoryBoxRights" class="text-green-400 text-lg">0</strong></p>
          <p class="flex justify-between items-center"><span>🎡 Şans Çarkı Bileti:</span> <strong id="inventoryWheelTickets" class="text-yellow-400 text-lg">0</strong></p>
          <p class="flex justify-between items-center"><span>🎯 Tıkla-Yakala Bileti:</span> <strong id="inventoryClickCatchTickets" class="text-fuchsia-400 text-lg">0</strong></p>
          <p class="flex justify-between items-center"><span>🛡️ İflas Kalkanı:</span> <strong id="inventoryIflasShields" class="text-blue-400 text-lg">0</strong></p>
          <hr class="border-gray-600 my-2">
          <div id="inventoryMultiplierDetails">
              <p>✖️ Aktif çarpan yok.</p>
          </div>
      </div>
      <div class="flex gap-4 mt-6">
        <button onclick="openAvatarSelectionModal()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">Avatarlarım</button>
        <button onclick="closeInventoryModal()" class="w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg">Kapat</button>
      </div>
  </div>
</div>

<div id="badgeInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-lg text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button" onclick="closeBadgeInfoModal()">&times;</button>
      <h4 class="text-yellow-400 text-2xl font-bold mb-6">Rozetler ve Anlamları</h4>
      <div class="space-y-4 text-left">
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">👑</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Kral Tacı</strong>
                <p class="text-gray-400">Tüm liderlik rozetlerine (🥇, 🏆, 🎉, 💣, 🛒, ✖️, 📦, 🛡️, 🎯, 🎡) aynı anda sahip olan kullanıcıya verilir. En prestijli rozettir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">🥇</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Mevcut Puan Lideri</strong>
                <p class="text-gray-400">Anlık olarak en yüksek puana sahip olan kullanıcıya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">🏆</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Ulaşılan En Yüksek Puan Lideri</strong>
                <p class="text-gray-400">Oyun boyunca ulaşılmış en yüksek puana sahip olan kullanıcıya verilir.</p>
            </div>
        </div>
         <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">🎯</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Tıkla-Yakala Lideri</strong>
                <p class="text-gray-400">Tıkla-Yakala puan sıralamasında lider olan oyuncuya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">🎡</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Çark Lideri</strong>
                <p class="text-gray-400">Tüm zamanlarda en çok Şans Çarkı çeviren kullanıcıya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">📦</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Kutu Açma Lideri</strong>
                <p class="text-gray-400">Tüm zamanlarda en çok kutu açan kullanıcıya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">🎉</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Sürpriz Kutu Lideri</strong>
                <p class="text-gray-400">Tüm zamanlarda en çok "Sürpriz Kutu" bulan kullanıcıya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">💣</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Bomba Lideri</strong>
                <p class="text-gray-400">Tüm zamanlarda en çok "İflas (Bomba)" kutusu bulan şanssız kullanıcıya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">✖️</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Çarpan Lideri</strong>
                <p class="text-gray-400">Tüm zamanlarda en çok "Çarpan" kutusu bulan kullanıcıya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">🛒</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Alışveriş Lideri</strong>
                <p class="text-gray-400">Mağazada en çok puan harcayan kullanıcıya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">🛡️</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Kalkan Lideri</strong>
                <p class="text-gray-400">En çok "İflas Kalkanı" kullanan kullanıcıya verilir.</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-3xl w-8 text-center">🎁</span>
            <div>
                <strong class="text-yellow-200 block text-lg">Sürpriz Kutu Rozeti</strong>
                <p class="text-gray-400">En az bir adet "Sürpriz Kutu" bulmuş olan tüm kullanıcılara verilir (Liderlik gerektirmez).</p>
            </div>
        </div>
      </div>
  </div>
</div>

<div id="helpModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-2xl text-left relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button" onclick="closeHelpModal()">&times;</button>
      <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">Yardım / Nasıl Oynanır?</h3>
      <div class="space-y-6 text-gray-300">
    <div>
        <h4 class="text-xl font-bold text-yellow-300 mb-2">Oyunun Amacı</h4>
        <p>Oyunun temel amacı, kutuları açarak puan toplamak, çeşitli mini oyunlarda en yüksek skoru elde etmek ve diğer kullanıcılarla liderlik sıralamasında yarışmaktır. Kazandığınız puanlarla mağazadan çeşitli oyun içi avantajlar ve kozmetik ürünler satın alabilirsiniz.</p>
    </div>

    <div>
        <h4 class="text-xl font-bold text-yellow-300 mb-2">Nasıl Kutu Hakkı Kazanırım?</h4>
        <p>Oyuna başlarken size hediye olarak kutu hakkı verilir. Daha fazla hak kazanmak için:</p>
        <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
            <li>Mağazadan puanlarınızla "Kutu Hakkı" satın alabilirsiniz.</li>
            <li>Günlük ödüllerinizi toplayarak kazanabilirsiniz.</li>
            <li>Şans Çarkı'nı çevirerek elde edebilirsiniz.</li>
            <li>Tıkla-Yakala oyununda özel hedefleri yakalayarak kazanabilirsiniz.</li>
        </ul>
    </div>

    <div>
        <h4 class="text-xl font-bold text-yellow-300 mb-2">Kutu İçerikleri</h4>
        <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
            <li><strong class="text-green-400">Puan:</strong> Farklı miktarlarda puanlar içerir.</li>
            <li><strong class="text-red-500">İflas (Bomba 💣):</strong> Tüm puanlarınızı sıfırlar! Dikkatli olun.</li>
            <li><strong class="text-yellow-400">Sürpriz Kutu  🎉:</strong> İçinden yüksek puanlar çıkan özel bir kart seçme oyunu başlatır. Sürpriz kutu bulunduğunda mevcut turdaki tüm kutular sıfırlanır ve karıştırılır.</li>
            <li><strong class="text-blue-400">Çarpan ✖️:</strong> Bir sonraki açacağınız kutudan çıkacak puanı veya eşyayı katlar. <b class="text-yellow-200">ÖNEMLİ:</b> Eğer mağazadan alınmış aktif bir çarpanla kutu açar ve kutudan yeni bir çarpan bulursanız, mağaza çarpanınız size iade edilir ve yeni bulduğunuz çarpan aktif olur!</li>
            <li><strong class="text-cyan-400">İflas Kalkanı 🛡️:</strong> Bomba bulduğunuzda puanlarınızı korur. Tek kullanımlıktır.</li>
            <li><strong class="text-pink-400">Çark Bileti 🎟️:</strong> Şans Çarkı'nı çevirmeniz için bilet verir.</li>
            <li><strong class="text-orange-400">Tıkla-Yakala Bileti 🎫:</strong> Tıkla-Yakala oyununu oynamanız için bilet verir.</li>
        </ul>
    </div>
    
     <div>
        <h4 class="text-xl font-bold text-yellow-300 mb-2">Mini Oyunlar</h4>
        <ul class="list-disc list-inside mt-2 space-y-1 pl-4">
            <li><strong class="text-yellow-200">Şans Çarkı:</strong> Biletinizle çarkı çevirerek puan, kutu hakkı, kalkan, yeni biletler ve hatta sürpriz kutu gibi çeşitli ödüller kazanabilirsiniz.</li>
            <li><strong class="text-orange-300">Tıkla-Yakala:</strong> Biletinizle oyuna girerek ekrandaki hedefleri yakalayıp puan ve özel ödüller (kutu hakkı, bilet vb.) toplayabilirsiniz. Lobi oyunlarında ise diğer oyuncularla yarışarak büyük ödülü kazanmaya çalışırsınız.</li>
        </ul>
    </div>

    <div>
        <h4 class="text-xl font-bold text-yellow-300 mb-2">Mağaza</h4>
        <p>Oyun içinde kazandığınız puanları kullanarak mağazadan Kutu Hakkı, Çark Bileti, Tıkla-Yakala Bileti, İflas Kalkanı ve özel avatar gibi birçok faydalı ürün satın alabilirsiniz.</p>
    </div>
</div>
  </div>
</div>

<div id="avatarSelectionModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-3xl text-center relative max-h-[90vh] flex flex-col">
      <button class="modal-close-button" onclick="closeAvatarSelectionModal()">&times;</button>
      <h3 class="text-blue-300 text-3xl font-bold mb-6">Avatarını Seç</h3>
      <div id="avatarGrid" class="flex-grow grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 overflow-y-auto scrollable-list p-4 bg-gray-900 rounded-lg"></div>
  </div>
</div>
</div>
  <div id="boxSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-2xl text-center relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeBoxSettingsModal()">&times;</button>
    <h3 class="text-purple-300 text-3xl font-bold mb-6">Oyun Kutusu Ayarları</h3>
    
    <div class="flex-grow overflow-y-auto scrollable-list pr-4 space-y-2" id="boxSettingsRowsContainer">
      </div>

    <div class="mt-6 pt-4 border-t border-gray-700">
        <div class="text-lg text-white mb-4">Toplam Kutu Sayısı: <span id="totalBoxCountDisplay" class="font-bold text-yellow-300">0</span></div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <button onclick="addBoxSettingRow()" class="py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">Yeni Satır Ekle</button>
    <button onclick="resetBoxSettingsToDefault()" class="py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg shadow-md">Varsayılana Döndür</button>
    <button onclick="saveBoxSettings()" class="py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">Kaydet ve Sıfırla</button>
</div>
<div class="mt-4 pt-4 border-t border-gray-600 grid grid-cols-1 sm:grid-cols-3 gap-4">
    <button id="toggleGameLockBtn" onclick="toggleGameLock()" class="py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">Oyunu Kilitle</button>
    <button onclick="revealAll()" class="py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-md">Tüm Kutuları Aç</button>
    <button onclick="resetGame()" class="py-3 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-md">Oyunu Sıfırla</button>
</div>
    </div>
  </div>
</div>
  <div id="soloGameSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-3xl text-left relative max-h-[90vh] flex flex-col">
        <button class="modal-close-button" onclick="closeSoloGameSettingsModal()">&times;</button>
        <h3 class="text-purple-300 text-3xl font-bold mb-6 text-center">Tıkla-Yakala Yönetim Paneli</h3>
        <div class="flex-grow overflow-y-auto scrollable-list pr-4">
            <h4 class="text-lg font-semibold text-yellow-300 mb-3 text-center">Tekli Oyun Ayarları</h4>
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <div>
                        <h5 class="font-semibold text-gray-300 mb-2">Süre ve Görünüm</h5>
                        <label for="soloGameDuration" class="block text-sm font-medium text-gray-400">Oyun Süresi (saniye)</label>
                        <input type="number" id="soloGameDuration" class="box-setting-input mt-1 mb-3">
                        <label for="soloItemInterval" class="block text-sm font-medium text-gray-400">Yeni Hedef Sıklığı (ms)</label>
                        <input type="number" id="soloItemInterval" class="box-setting-input mt-1 mb-3">
                        <label for="soloItemDisappearTime" class="block text-sm font-medium text-gray-400">Hedef Kaybolma Süresi (ms)</label>
                        <input type="number" id="soloItemDisappearTime" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <h5 class="font-semibold text-gray-300 mb-2">Puan Değerleri</h5>
                        <label for="soloNormalValue" class="block text-sm font-medium text-gray-400">Düşük Skor (🥮)</label>
                        <input type="number" id="soloNormalValue" class="box-setting-input mt-1 mb-3">
                        <label for="soloGoldValue" class="block text-sm font-medium text-gray-400">Yüksek Skor (💰)</label>
                        <input type="number" id="soloGoldValue" class="box-setting-input mt-1 mb-3">
                        <label for="soloBombValue" class="block text-sm font-medium text-gray-400">Bomba Cezası (💣)</label>
                        <input type="number" id="soloBombValue" class="box-setting-input mt-1 mb-3">
                        <label for="soloTimeValue" class="block text-sm font-medium text-gray-400">Süre Bonusu (⏰)</label>
                        <input type="number" id="soloTimeValue" class="box-setting-input mt-1">
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 mt-4">
                <h5 class="font-semibold text-gray-300 mb-2">Çıkma İhtimalleri (Toplamı 100 olmalı)</h5>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div>
                        <label for="soloNormalChance" class="block text-sm font-medium text-gray-400">🥮 (%)</label>
                        <input type="number" id="soloNormalChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloGoldChance" class="block text-sm font-medium text-gray-400">💰 (%)</label>
                        <input type="number" id="soloGoldChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloBombChance" class="block text-sm font-medium text-gray-400">💣 (%)</label>
                        <input type="number" id="soloBombChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloTimeChance" class="block text-sm font-medium text-gray-400">⏰ (%)</label>
                        <input type="number" id="soloTimeChance" class="box-setting-input mt-1">
                    </div>
                    <div>
                        <label for="soloSpecialChance" class="block text-sm font-medium text-gray-400">🎁 (%)</label>
                        <input type="number" id="soloSpecialChance" class="box-setting-input mt-1">
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 mt-4">
                <h5 class="font-semibold text-gray-300 mb-2">Çıkacak Özel Hedef</h5>
                <div class="grid grid-cols-2 gap-4">
                    <select id="soloSpecialItemType" class="box-setting-input">
                        <option value="boxRight">Kutu Hakkı (📦)</option>
                        <option value="iflasShield">İflas Kalkanı (🛡️)</option>
                        <option value="wheelTicket">Çark Bileti (🎫️)</option>
                    </select>
                    <input type="number" id="soloSpecialValue" class="box-setting-input" placeholder="Adet (örn: 1, 5)">
                </div>
            </div>
            
            <div class="mt-4">
                <button onclick="saveSoloGameSettings()" class="w-full py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">Tekli Oyun Ayarlarını Kaydet</button>
            </div>
        </div>
        
        <div class="mt-6 pt-4 border-t-2 border-dashed border-purple-400">
            <h4 class="text-lg font-semibold text-purple-300 mb-3 text-center">🏆 Haftalık Otomatik Sıfırlama Yönetimi</h4>
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-4">
                <div>
                    <label for="weeklyResetEndDateInput" class="block text-sm font-medium text-gray-300 mb-1">Haftalık Sıfırlama Bitiş Tarihi ve Saati:</label>
                    <input type="datetime-local" id="weeklyResetEndDateInput" class="box-setting-input">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Şampiyon Ödülü:</label>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="weeklyPrizeType" class="box-setting-input">
                            <option value="points">Puan</option>
                            <option value="boxRights">Kutu Hakkı</option>
                            <option value="wheelTicket">Çark Bileti</option>
                            <option value="iflasShield">İflas Kalkanı</option>
                        </select>
                        <input type="number" id="weeklyPrizeAmount" class="box-setting-input" value="1000" min="1" placeholder="Miktar">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                     <button onclick="saveWeeklyResetSettings()" class="w-full py-2 bg-purple-700 hover:bg-purple-600 text-white font-bold rounded-lg shadow-md">Haftalık Geri Sayımı Başlat/Kaydet</button>
                     <button onclick="stopWeeklyReset()" class="w-full py-2 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-md">Geri Sayımı İptal Et</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="lobbySettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-lg text-left relative">
        <button class="modal-close-button" onclick="closeLobbySettingsModal()">&times;</button>
        <h3 class="text-blue-300 text-3xl font-bold mb-6 text-center">Lobi Yönetim Paneli</h3>
        
        <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 mb-4">
            <h4 class="text-lg font-semibold text-yellow-300 mb-3">Lobi Ayarları</h4>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="lobbyEntryFee" class="block text-sm font-medium text-gray-300">Giriş Ücreti (Puan)</label>
                    <input type="number" id="lobbyEntryFee" value="100" class="box-setting-input mt-1">
                </div>
                 <div>
                    <label for="lobbyEntryTickets" class="block text-sm font-medium text-gray-300">Giriş Ücreti (Bilet)</label>
                    <input type="number" id="lobbyEntryTickets" value="0" class="box-setting-input mt-1">
                </div>
                <div>
                    <label for="lobbyTarget" class="block text-sm font-medium text-gray-300">Hedef Skor</label>
                    <input type="number" id="lobbyTarget" value="10" class="box-setting-input mt-1">
                </div>
                 <div>
                    <label for="lobbyPrize" class="block text-sm font-medium text-gray-300">Kazanan Ödülü (Puan)</label>
                    <input type="number" id="lobbyPrize" value="1000" class="box-setting-input mt-1">
                </div>
                 <div class="col-span-2">
                    <label for="lobbyItemInterval" class="block text-sm font-medium text-gray-300">Hedef Çıkma Sıklığı (ms)</label>
                    <input type="number" id="lobbyItemInterval" value="800" class="box-setting-input mt-1">
                </div>
            </div>
             <button onclick="startLobbyGame()" class="w-full mt-4 py-2 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">Lobi Kur ve Beklemeye Al</button>
        </div>

        <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
            <h4 class="text-lg font-semibold text-yellow-300 mb-3">Oyun Kontrolü</h4>
            <div class="flex gap-4">
                <button id="lobbyStartBtn" onclick="triggerLobbyGameStart()" class="flex-1 py-3 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Oyunu Başlat</button>
                <button onclick="endLobbyGame(true)" class="flex-1 py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">Lobi İptal Et ve Ücretleri İade Et</button>
            </div>
            <button onclick="resetClickCatchLeaderboard()" class="w-full mt-4 py-2 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg shadow-md">Haftalık Sıralamayı Sıfırla</button>
        </div>
    </div>
</div>
  <div id="spectatorModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
    <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-2xl text-center relative">
        <h4 id="spectatorTitle" class="text-yellow-400 text-3xl font-bold mb-4"></h4>
        <p class="text-gray-300 mb-2">Kullanıcının bir kart seçmesi bekleniyor...</p>
        <div class="text-2xl font-bold text-red-500 mb-6" id="spectatorCountdown">60</div>
        <div id="spectatorCardContainer" class="card-container grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 justify-center items-center">
            </div>
        <div id="spectatorResultContainer" class="mt-6 min-h-[60px]">
    <p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8"></p>
</div>
    </div>
</div>
  <div id="wheelSettingsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-teal-500 w-11/12 max-w-4xl text-center relative max-h-[90vh] flex flex-col">
    <button class="modal-close-button" onclick="closeWheelSettingsModal()">&times;</button>
    <h3 class="text-teal-300 text-3xl font-bold mb-6">Şans Çarkı Ayarları</h3>
    
    <div class="flex-grow overflow-y-auto scrollable-list pr-4 space-y-2" id="wheelSettingsRowsContainer">
      </div>

    <div class="mt-6 pt-4 border-t border-gray-700">
        <div class="flex flex-col sm:flex-row gap-4">
            <button onclick="addWheelSettingRow()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-md">Yeni Dilim Ekle</button>
            <button onclick="resetWheelSettingsToDefault()" class="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-lg shadow-md">Varsayılana Döndür</button>
            <button onclick="saveWheelSettings()" class="flex-1 py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg shadow-md">Ayarları Kaydet</button>
        </div>
    </div>
  </div>
</div>
  <div id="unopenedBoxContentsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-green-700 w-11/12 max-w-lg text-center relative max-h-[90vh]">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl" onclick="closeUnopenedBoxContentsModal()">&times;</button>
      <h4 class="text-green-300 text-2xl font-bold mb-4">Kapalı Kutularda Kalanlar</h4>
      <p class="text-sm text-gray-400 mb-6">Bu listede sadece henüz açılmamış kutuların içerikleri gösterilir.</p>
      <div id="unopenedBoxContentsList" class="scrollable-list max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-lg text-left">
          Yükleniyor...
      </div>
  </div>
</div>

<div id="newAnnouncementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[99998] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-md text-center relative">
    <h4 class="text-yellow-400 text-3xl font-bold mb-4">📢 YENİ DUYURU! 📢</h4>
    <div class="text-lg text-gray-200 space-y-3 bg-gray-900 p-4 rounded-lg max-h-60 overflow-y-auto scrollable-list">
        <p id="newAnnouncementText"></p>
    </div>
    <div class="flex gap-4 mt-8">
        <button onclick="closeNewAnnouncementModal()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md">
          Sonra Bak
        </button>
        <button onclick="goToAnnouncements()" class="flex-1 py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">
          Duyuruya Git
        </button>
    </div>
  </div>
</div>
  <div id="dailyRewardModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-yellow-500 w-11/12 max-w-4xl text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl" onclick="closeDailyRewardModal()">&times;</button>
      <h4 class="text-yellow-400 text-3xl font-bold mb-2">Günlük Ödüller</h4>
      <p id="dailyRewardMessage" class="text-lg text-gray-300 mb-6">Aşağıdaki ödüllerden alabileceklerini topla. Bol şans!</p>
      <div id="adminDailyRewardManagementButtonContainer" class="text-center mb-6 hidden">
          <button onclick="openNewDailyRewardForm()" class="py-2 px-6 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md">
              Yeni Ödül Ekle
          </button>
      </div>
      <div id="dailyRewardItemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
      </div>
  </div>
</div>
  <div id="announcementLikesModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative max-h-[90vh]">
    <button class="modal-close-button" onclick="closeAnnouncementLikesModal()">&times;</button>
    <h4 class="text-yellow-400 text-2xl font-bold mb-6">Beğenen Kullanıcılar</h4>
    <div id="announcementLikesList" class="scrollable-list max-h-[60vh] overflow-y-auto bg-gray-900 p-4 rounded-lg text-left">
      </div>
  </div>
</div>

<div id="adminDailyRewardModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[100] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-3xl text-center relative max-h-[90vh] overflow-y-auto scrollable-list">
      <button class="modal-close-button absolute top-2 right-4 text-white text-4xl" onclick="closeAdminDailyRewardModal()">&times;</button>
      <h3 class="text-yellow-400 text-3xl font-bold mb-6 text-center">Günlük Ödül Yönetimi</h3>
        <div class="bg-gray-900 p-6 rounded-lg border border-gray-700">
          <div class="mb-4 space-y-2">
              <input type="text" id="dailyRewardName" placeholder="Ödül Adı (Örn: 100 Puan)" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              <textarea id="dailyRewardDescription" placeholder="Ödül Açıklaması" rows="2" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white"></textarea>
              <select id="dailyRewardType" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <option value="">Ödül Tipi Seçin</option>
                  <option value="points">Puan</option>
                  <option value="boxRights">Kutu Hakkı</option>
                  <option value="wheelTicket">Çark Bileti</option>
                  <option value="clickCatchTicket">Tıkla-Yakala Bileti</option>
                  <option value="iflasShield">İflas Kalkanı</option>
                  <option value="tempMultiplier">Çarpan</option>
              </select>
              <input type="number" id="dailyRewardValue" placeholder="Değer (Puan/Hak Adedi/Kalkan)" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              <input type="number" id="dailyRewardMultiplierUses" placeholder="Çarpan Kullanım Hakkı" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white hidden">
              
              <label class="text-gray-300 text-sm block text-left">Ödül Bekleme Süresi:</label>
              <div class="flex gap-2">
                  <input type="number" id="dailyRewardCooldownDays" placeholder="Gün" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="number" id="dailyRewardCooldownHours" placeholder="Saat" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="number" id="dailyRewardCooldownMinutes" placeholder="Dakika" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                  <input type="number" id="dailyRewardCooldownSeconds" placeholder="Saniye" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              </div>
              
              <input type="text" id="dailyRewardImageUrl" placeholder="Resim URL (Opsiyonel)" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
          </div>
          <button onclick="saveDailyReward()" id="saveDailyRewardBtn" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">GÜNLÜK ÖDÜL OLUŞTUR</button>
          <button onclick="resetDailyRewardForm()" class="w-full py-2 mt-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg shadow-md hover:-translate-y-1 transition duration-300">Formu Temizle</button>
      </div>
  </div>
</div>
  <div id="wheelLegendModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-md text-center relative max-h-[90vh]">
      <button class="modal-close-button" onclick="closeWheelLegendModal()">&times;</button>
      <h4 class="text-blue-300 text-2xl font-bold mb-6">Çark Simgeleri ve Anlamları</h4>
      <div id="wheelLegendContent" class="space-y-3 text-left scrollable-list max-h-80 overflow-y-auto">
          </div>
  </div>
</div>

  <div id="clickCatchInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[9999] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeClickCatchInfoModal()">&times;</button>
        <h4 class="text-blue-300 text-2xl font-bold text-center">Tıkla-Yakala Oyun Bilgileri</h4>
    </div>

    <div class="overflow-y-auto scrollable-list pr-4 space-y-6 text-gray-300">
        <div>
            <h5 class="text-xl font-bold text-purple-400 mb-2">Tekli Oyun (Haftalık Skor Yarışması)</h5>
            <p class="mb-2">Bu mod, haftalık liderlik tablosunda en yüksek skoru elde etme yarışmasıdır.</p>
            <ul class="list-disc list-inside space-y-1 pl-2">
                <li>Oyuna girmek <strong>1 Tıkla-Yakala Bileti</strong> gerektirir.</li>
                <li>Oyun sırasında topladığınız skorlar, ana Puanınıza değil, o haftaki toplam skorunuza eklenir.</li>
                <li>Hafta sonunda, en yüksek skoru yapan oyuncu "Haftanın Şampiyonu" seçilir ve <strong>özel bir ödül</strong> kazanır.</li>
                <li>Kazanan seçildikten sonra, o hafta yarışmaya katılmış olan <strong>tüm oyunculara +1 Bilet</strong> hediye edilir.</li>
                <li>Sıralama ve tüm kişisel skorlar sıfırlanarak yeni bir haftaya başlanır.</li>
            </ul>
        </div>
        <div>
            <h5 class="text-xl font-bold text-green-400 mb-2">Lobi Oyunu (Rekabetçi Mod)</h5>
            <p class="mb-2">Admin tarafından kurulan bu mod, diğer oyuncularla gerçek zamanlı bir skor yarışıdır.</p>
            <ul class="list-disc list-inside space-y-1 pl-2">
                <li>Lobiye katılmak için admin tarafından belirlenen bir <strong>giriş ücreti</strong> (Puan veya Bilet) ödenir.</li>
                <li>Adminin belirlediği <strong>hedef skora ilk ulaşan oyuncu</strong> oyunu anında kazanır.</li>
                <li>Kazanan oyuncu, lobideki <strong>büyük ödülün</strong> sahibi olur.</li>
            </ul>
        </div>

        <div>
            <h5 class="text-xl font-bold text-yellow-300 mb-2">Tıklanabilir Hedefler ve Anlamları</h5>
            <div class="space-y-3">
                <p class="font-semibold text-purple-400">-- Tekli Oyunda Geçerli --</p>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">🥮</span><span><strong>Düşük Skor:</strong> Oyundaki temel skor kaynağınızdır.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">💰</span><span><strong>Yüksek Skor:</strong> Normal hedeften daha fazla skor kazandırır.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">💣</span><span><strong>Bomba:</strong> DİKKAT! Tıklanıldığında toplam skorunuzdan -skor düşürür.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">⏰</span><span><strong>Ekstra Süre:</strong> Kalan oyun sürenize bonus saniyeler ekler.</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">🎁</span><span><strong>Özel Hedef:</strong> Nadiren belirir. Kutu Hakkı (📦) , İflas Kalkanı (🛡️) veya Çark Bilet (🎫️) gibi değerli eşyalar kazandırır.</span></div>
                <hr class="border-gray-600">
                <p class="font-semibold text-green-400">-- Lobi Oyununda Geçerli --</p>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">🎯</span><span><strong>Hedef:</strong> Hedef skora ulaşmak için tıklamanız gereken ana hedeftir. (+1 Skor)</span></div>
                <div class="flex items-center gap-3"><span class="text-2xl w-6 text-center">💣</span><span><strong>Bomba:</strong> Bu hedefe tıklamak, o anki lobi skorunuzu bir azaltır. (-1 Skor)</span></div>
            </div>
        </div>
        </div>
  </div>
</div>
  <div id="seasonManagementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-green-500 w-11/12 max-w-3xl text-left relative max-h-[95vh] flex flex-col">
    
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeSeasonManagementModal()">&times;</button>
        <h4 class="text-green-300 text-2xl font-bold text-center">🏆 Aylık Sezon Yönetimi 👑</h4>
    </div>

    <div class="overflow-y-auto scrollable-list pr-4 space-y-6">
      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
  <h5 class="text-lg font-semibold text-yellow-300 mb-3">Otomatik Sezon Sonu Ayarları</h5>
  <div>
    <label for="seasonManagementEndDateInput" class="block text-gray-300 mb-1 text-sm">Sezon Bitiş Tarih ve Saati:</label>
    <input type="datetime-local" id="seasonManagementEndDateInput" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
  </div>
</div>

      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
        <h5 class="text-lg font-semibold text-yellow-300 mb-3">Şampiyon Avatar Ödülleri</h5>
        <p class="text-xs text-gray-400 mb-3">Bu alanlara URL girilirse, sezon sonunda liderlerin avatarları otomatik olarak bu resimlerle güncellenir.</p>
        <div>
          <label for="puanLeaderAvatarUrl" class="block text-gray-300 mb-1 text-sm">Puan Sıralaması 1.'sinin Avatar URL'i:</label>
          <input type="text" id="puanLeaderAvatarUrl" placeholder="https://ornek.com/resim.png" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
        </div>
        <div class="mt-3">
          <label for="rozetLeaderAvatarUrl" class="block text-gray-300 mb-1 text-sm">Liderler Sıralaması 1.'sinin Avatar URL'i:</label>
          <input type="text" id="rozetLeaderAvatarUrl" placeholder="https://ornek.com/resim.png" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
        </div>
      </div>

      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
        <h5 class="text-lg font-semibold text-yellow-300 mb-3">Genel Katılımcı Ödülleri</h5>
        <p class="text-xs text-gray-400 mb-3">Sıfırlama sonrası TÜM KULLANICILARA (şampiyonlar dahil) verilecek hediye miktarları. Boş bırakılırsa o hediye verilmez.</p>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div>
                <label for="rewardBoxRights" class="block text-gray-300 mb-1 text-sm">📦 Kutu Hakkı</label>
                <input type="number" id="rewardBoxRights" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label for="rewardWheelTickets" class="block text-gray-300 mb-1 text-sm">🎡 Çark Bileti</label>
                <input type="number" id="rewardWheelTickets" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label for="rewardClickCatchTickets" class="block text-gray-300 mb-1 text-sm">🎯 Tıkla-Yakala Bileti</label>
                <input type="number" id="rewardClickCatchTickets" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <div>
                <label for="rewardIflasShields" class="block text-gray-300 mb-1 text-sm">🛡️ İflas Kalkanı</label>
                <input type="number" id="rewardIflasShields" value="0" min="0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
        </div>
      </div>
      <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
        <h5 class="text-lg font-semibold text-yellow-300 mb-3">Eylemler</h5>
        <div class="space-y-3">
            <button onclick="saveAutomaticResetSettings()" class="w-full py-2 bg-blue-700 hover:bg-blue-600 text-white font-bold rounded-lg">Otomatik Sıfırlamayı Ayarla/Kaydet</button>
            <p class="text-xs text-gray-400 text-center">Yukarıdaki ayarları kaydeder ve geri sayımı başlatır.</p>
            <hr class="border-gray-600">
            <button onclick="stopSeasonCountdown()" class="w-full py-2 bg-orange-700 hover:bg-orange-600 text-white font-bold rounded-lg">Otomatik Sıfırlamayı İptal Et</button>
            <p class="text-xs text-gray-400 text-center">Ayarlanmış olan otomatik sıfırlamayı ve geri sayımı durdurur.</p>
            <hr class="border-gray-600">
            <button onclick="executeSeasonReset(true)" class="w-full py-3 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg">SEZONU ŞİMDİ BİTİR (MANUEL)</button>
            <p class="text-xs text-gray-400 text-center">Geri sayımı beklemeden, anında her şeyi sıfırlar ve ödülleri dağıtır.</p>
        </div>
      </div>
    </div>
  </div>
</div>
  <div id="persistentAnnouncementModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[100002] hidden">
  <div class="modal-content bg-gray-900/95 backdrop-blur-sm p-8 rounded-xl shadow-2xl border-4 border-yellow-500 w-11/12 max-w-lg text-center relative">
    <h4 id="persistentAnnTitle" class="text-yellow-400 text-3xl font-bold mb-4"></h4>
    <div id="persistentAnnMessage" class="text-lg text-gray-200 space-y-3 bg-gray-800 p-4 rounded-lg max-h-80 overflow-y-auto scrollable-list"></div>
    <button onclick="markPersistentAnnouncementAsSeen()" class="mt-8 w-full py-3 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg shadow-md">
      Anladım, Kapat
    </button>
  </div>
</div>
  <div id="seasonInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-blue-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeSeasonInfoModal()">&times;</button>
        <h4 class="text-blue-300 text-2xl font-bold text-center">🏆 Aylık Sezon Sıfırlaması Nedir?</h4>
    </div>

    <div class="overflow-y-auto scrollable-list pr-4 space-y-4 text-gray-300">
        <p>Oyunumuz, her ay rekabeti tazelemek ve tüm oyunculara yeni bir başlangıç şansı sunmak için <strong>Sezonluk Sıfırlama</strong> sistemini kullanır. Geri sayım sayacı sona erdiğinde, bir önceki sezon biter ve yeni bir sezon başlar.</p>
        
        <div>
            <h5 class="text-xl font-bold text-yellow-300 mb-2">Sezon Bittiğinde Ne Olur?</h5>
            <ul class="list-disc list-inside space-y-2 pl-2">
                <li><strong>Ödüller Dağıtılır:</strong>
                    <ul class="list-circle list-inside pl-4 mt-1 space-y-2">
                        <li>
                            <p>Şampiyonlar dahil, oyundaki <strong>tüm oyunculara</strong> admin tarafından belirlenen bir <strong>hediye paketi</strong> gönderilir.</p>
                            <div id="seasonGiftPackageDetails" class="mt-3 bg-gray-900/50 p-4 rounded-lg border border-gray-600">
                                <p class="text-gray-400">Ödül detayları yükleniyor...</p>
                            </div>
                        </li>
                        <li>
                            <p>Ayrıca sıralamalarda 1. olan şampiyonlara özel ödüller verilir.</p>
                             <div id="seasonChampionPrizes" class="mt-3 bg-gray-900/50 p-4 rounded-lg border border-yellow-600">
                                <p class="text-gray-400">Şampiyon ödülleri yükleniyor...</p>
                            </div>
                        </li>
                        </ul>
                </li>
                <li><strong>Her Şey Sıfırlanır:</strong>
                    <ul class="list-circle list-inside pl-4 mt-1 text-red-400">
                        <li>Tüm kullanıcıların <strong>Puanları </strong> sıfırlanır.</li>
                        <li>Tüm liderlik istatistikleri (açılan kutu sayısı, harcanan puan vb.) sıfırlanır.</li>
                        <li>Mağaza satın alma geçmişleri ve ürünlerin "kaç kez satın alındığı" bilgisi temizlenir.</li>
                    </ul>
                </li>
                 <li><strong>Neler Kalır?</strong>
                    <ul class="list-circle list-inside pl-4 mt-1 text-green-400">
                        <li>Kullanıcı hesaplarınız, şifreleriniz ve PIN'leriniz.</li>
                        <li>Mağazadan satın aldığınız <strong>Avatarlar</strong> gibi kalıcı kozmetikler.</li>
                        <li>Sezon sonunda hediye edilen envanter eşyaları (Kutu Hakları, Biletler vb.) yeni sezona aktarılır.</li>
                    </ul>
                </li>
            </ul>
        </div>
        <p class="font-bold text-center text-yellow-200 pt-2 border-t border-gray-700">Yeni sezon, yeni bir başlangıç demektir. Herkese bol şans!</p>
    </div>
  </div>
</div>
<div id="weeklyResetInfoModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10001] hidden">
  <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl border border-purple-500 w-11/12 max-w-2xl text-left relative max-h-[90vh] flex flex-col">
    <div class="flex-shrink-0 mb-4 pb-4 border-b border-gray-700">
        <button class="modal-close-button" onclick="closeWeeklyResetInfoModal()">&times;</button>
        <h4 class="text-purple-300 text-2xl font-bold text-center">🎯 Haftalık Tıkla-Yakala Sıfırlaması Nedir?</h4>
    </div>
    <div class="overflow-y-auto scrollable-list pr-4 space-y-4 text-gray-300">
        <p>Tıkla-Yakala oyununda rekabeti canlı tutmak için her hafta liderlik tablosu sıfırlanır ve ödüller dağıtılır. Geri sayım sayacı sona erdiğinde, bir önceki hafta biter ve yeni bir hafta başlar.</p>
        <div>
            <h5 class="text-xl font-bold text-yellow-300 mb-2">Hafta Bittiğinde Ne Olur?</h5>
            <ul class="list-disc list-inside space-y-2 pl-2">
                <li><strong>Şampiyon Belirlenir:</strong> Haftalık skor tablosunda <strong>1. sırada</strong> olan oyuncu "Haftanın Şampiyonu" olur ve admin tarafından belirlenen özel ödülü kazanır.</li>
                
                <div id="weeklyWinnerPrizeDetails" class="mt-2 mb-2 bg-gray-900/50 p-4 rounded-lg border border-gray-600">
                    <p class="text-gray-400">Şampiyon ödülü yükleniyor...</p>
                </div>
                
                <li><strong>Katılım Ödülü Dağıtılır:</strong> O hafta en az bir kez Tıkla-Yakala oynamış olan <strong>tüm katılımcılara</strong> (şampiyon dahil) <strong class="text-green-400">+1 Tıkla-Yakala Bileti</strong> hediye edilir.</li>
                <li><strong>Sıralama Sıfırlanır:</strong> Tüm oyuncuların o haftaki skorları ve haftalık liderlik tablosu tamamen temizlenir. Herkes yeni haftaya eşit şartlarda başlar.</li>
            </ul>
        </div>
        <p class="font-bold text-center text-yellow-200 pt-2 border-t border-gray-700">Yeni hafta, yeni bir şampiyonluk şansı demektir. Bol şans!</p>
    </div>
  </div>
</div>
  <script>
  // Firebase yapılandırması
  const firebaseConfig = {
    apiKey: "AIzaSyAVuyT2Hb7v9omKSgcwtoj0gzjTbXRtQn8",
    authDomain: "weizendtv-oyun.firebaseapp.com",
    databaseURL: "https://weizendtv-oyun-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "weizendtv-oyun",
    storageBucket: "weizendtv-oyun.appspot.com",
    messagingSenderId: "762409187638",
    appId: "1:762409187638:web:6e9888f4bdacfac017db97"
  };

  try {
    firebase.initializeApp(firebaseConfig);
  } catch (e) {
    if (!e.message.includes("already exists")) {
      console.error("Firebase başlatma hatası: ", e);
    }
  }

  const db = firebase.database()
  // BU YENİ KOD BLOĞUNU OLDUĞU GİBİ EKLE

let serverTimeOffset = 0;
db.ref(".info/serverTimeOffset").on("value", function(snapshot) {
    serverTimeOffset = snapshot.val();
});

function getSyncedTime() {
    return Date.now() + serverTimeOffset;
};
  
  
  // --- YENİ: Listener (Dinleyici) Yönetimi ---
  let activeListeners = {};
  function detachAllListeners() {
      console.log("Tüm Firebase dinleyicileri kapatılıyor...");
      for (const key in activeListeners) {
          const listener = activeListeners[key];
          if (listener && listener.ref && listener.event && listener.callback) {
              listener.ref.off(listener.event, listener.callback);
          }
      }
      activeListeners = {};
      console.log("Dinleyiciler kapatıldı.");
  }
  // --- YENİ KOD BİTİŞ ---
  const auth = firebase.auth();

  // Global değişkenler
  let hasShownLobbyNotification = false;
  let currentUser = null;
  let allUsersCache = [];
  let isAdmin = false;
  let boxes = [];
  const BOX_RIGHTS_COST_PER_BOX = 1;
  let isGameLocked = false; 
  let sessionStartTime = Date.now();
  let latestAnnouncementTimestamp = 0;
  let latestStoreItemTimestamp = 0;

  const defaultAvatarUrl = 'https://i.hizliresim.com/n01dnz4.png?_gl=1*11uaptm*_ga*NTE1MDc3ODEyLjE3Mzg5Mjg1MDk.*_ga_M9ZRXYS2YN*czE3NTQ2OTEwMTgkbzkkZzEkdDE3NTQ2OTEwMjYkajUyJGwwJGgw'; // Varsayılan profil resmi
  
  const BOX_CONTENTS = [
    { type: 'surpriz', value: 0, count: 1 },
    { type: 'points', value: 1000, count: 2 },
    { type: 'iflas', count: 2 },
    { type: 'points', value: 750, count: 4 },
    { type: 'points', value: 500, count: 6 },
    { type: 'points', value: 250, count: 8 },
    { type: 'points', value: 100, count: 10 },
    { type: 'points', value: 50, count: 15 },
    { type: 'points', value: 10, count: 20 },
    { type: 'points', value: 1, count: 30 },
    { type: 'multiplier', value: 2, count: 1 },
    { type: 'multiplier', value: 3, count: 1 }
  ];
  const TOTAL_BOXES = BOX_CONTENTS.reduce((sum, item) => sum + item.count, 0);

  // Modal elementleri
  const pointAdjustmentModal = document.getElementById('pointAdjustmentModal');
  const boxRightAdjustmentModal = document.getElementById('boxRightAdjustmentModal');
  const iflasShieldAdjustmentModal = document.getElementById('iflasShieldAdjustmentModal');
  const multiplierAdjustmentModal = document.getElementById('multiplierAdjustmentModal');
  const blockDurationModal = document.getElementById('blockDurationModal');
  const blockedMessageModal = document.getElementById('blockedMessageModal');
  const kickVerificationModal = document.getElementById('kickVerificationModal');
  const passwordResetModal = document.getElementById('passwordResetModal');
  const generalMessageModal = document.getElementById('generalMessageModal');
  const welcomeGiftModal = document.getElementById('welcomeGiftModal');
  const cardSelectionModal = document.getElementById('cardSelectionModal');
  const cardContainer = document.querySelector('#cardSelectionModal .card-container');
  const openedBoxInfoModal = document.getElementById('openedBoxInfoModal');
  const adminPanelModal = document.getElementById('adminPanelModal');
  const adminPanelToggleButton = document.getElementById('adminPanelToggleButton');
  const userManagementModal = document.getElementById('userManagementModal');
  const publicUserDetailModal = document.getElementById('publicUserDetailModal'); 
  const inventoryModal = document.getElementById('inventoryModal');
  const globalOpenedBoxInfoModal = document.getElementById('globalOpenedBoxInfoModal');
  const badgeInfoModal = document.getElementById('badgeInfoModal');
  const purchaseHistoryModal = document.getElementById('purchaseHistoryModal');
  const boxStatsModal = document.getElementById('boxStatsModal');
  const spectatorModal = document.getElementById('spectatorModal');
  const dailyRewardModal = document.getElementById('dailyRewardModal');
  const newAnnouncementModal = document.getElementById('newAnnouncementModal');
  const announcementLikesModal = document.getElementById('announcementLikesModal');
  const adminStoreModal = document.getElementById('adminStoreModal');
  const adminDailyRewardModal = document.getElementById('adminDailyRewardModal');
  const wheelTicketAdjustmentModal = document.getElementById('wheelTicketAdjustmentModal');
  const clickCatchTicketAdjustmentModal = document.getElementById('clickCatchTicketAdjustmentModal');
  const boxSettingsModal = document.getElementById('boxSettingsModal');
  const helpModal = document.getElementById('helpModal');
  const avatarSelectionModal = document.getElementById('avatarSelectionModal');

  let targetUserForAdjustment = null;
  let targetUserForBoxRightAdjustment = null;
  let targetUserForIflasShieldAdjustment = null;
  let targetUserForMultiplierAdjustment = null;
  let targetUserForBlock = null;
  let targetUserForWheelTicket = null;
  let targetUserForClickCatchTicket = null;
  let userForPasswordReset = null;
  let selectedUserForManagement = null;
  let countdownInterval = null;
  let cardValues = [1000, 2000, 3000, 4000, 5000];
  let activeBlockedUserTimers = {};
  let activeDailyRewardTimers = {};
  
  let currentCardsToOpen = 0;
  let cardsOpenedInCurrentSurpriseSession = 0;
  let totalPointsGainedInSurpriseSession = 0;
  let surpriseBoxMultiplier = 1;

  let editingItemId = null;
  let currentActiveSection = 'game';

  let storeCountdownInterval = null;
  let activeStoreCountdowns = {};
  
  let editingDailyRewardId = null;
  let editingAnnouncementId = null;
  let activeUserProfileListener = null;
  
  // Şans Çarkı Değişkenleri
  const wheel = document.getElementById('wheel');
  const spinBtn = document.getElementById('spinWheelBtn');
  let isWheelSpinning = false;
  let wheelSegments = []; // Bu artık veritabanından doldurulacak

const defaultWheelSegments = [
    // Sık Gelen Ödüller (Toplam Ağırlık: 55)
    { type: 'points', value: 100, label: '🍌', color: '#fde047', weight: 20 },
    { type: 'boxRights', value: 1, label: '📦', color: '#8b5cf6', weight: 15 },
    { type: 'points', value: 10, label: '🍆', color: '#9ca3af', weight: 10 },
    { type: 'pas', label: '☠️', color: '#6b7280', weight: 10 },

    // Orta Seviye Ödüller (Toplam Ağırlık: 30)
    { type: 'points', value: 250, label: '🍐', color: '#22c55e', weight: 10 },
    { type: 'iflasShield', value: 1, label: '🛡️', color: '#3b82f6', weight: 10 },
    { type: 'clickCatchTicket', value: 1, label: '🎟️', color: '#ec4899', weight: 10 },
    { type: 'pas', label: '☠️', color: '#6b7280', weight: 10 },

    // Nadir Ödüller (Toplam Ağırlık: 15)
    { type: 'wheelTicket', value: 1, label: '🎡', color: '#14b8a6', weight: 5 },
    { type: 'boxRights', value: 3, label: '🎁', color: '#f97316', weight: 5 },
    { type: 'pas', label: '☠️', color: '#6b7280', weight: 10 },
    { type: 'points', value: 1000, label: '🎂', color: '#ef4444', weight: 2 },
    { type: 'tempMultiplier', value: 5, duration: 1, label: '✖️', color: '#d946ef', weight: 2 },
    { type: 'pas', label: '☠️', color: '#6b7280', weight: 10 },
    { type: 'surpriseBox', value: 1, label: '🎉', color: '#eab308', weight: 1 }
];
  
  // Tıkla Yakala Değişkenleri
  let clickCatchGameActive = false;
  let clickCatchScore = 0;
  let clickCatchTimer = 30; // Bu artık sadece bir başlangıç değeri
  let clickCatchTimerInterval = null;
  let clickCatchItemInterval = null;
  
  // Oyun sonunda eklenecek ödülleri tutan değişkenler
  let collectedBoxRights = 0;
  let collectedIflasShields = 0;
  let collectedWheelTickets = 0;
  
  // Haftanın liderini bu değişkende tutacağız. Sıralama güncellendiğinde bu da güncellenir.
  let clickCatchLeader = null; 
  
  // Tekli oyunun tüm ayarlarını bu obje içinde toplayacağız.
  let soloGameSettings = {
      duration: 30,
      itemDisappearTime: 1200,
      itemInterval: 600,
      bombChance: 40,
      timeChance: 8,
      goldChance: 6,
      specialChance: 4,
      timeValue: 3,
      bombValue: -75,
      goldValue: 100,
      normalValue: 50
  };
  
  // Her oyun başladığında rastgele bir özel eşya seçip bu değişkene atayacağız.
  let specialItemForThisRound = null;

  // GİRİŞ/KAYIT SİSTEMİ
  function switchAuthTab(tab) {
    const loginDiv = document.getElementById('loginDiv');
    const registerDiv = document.getElementById('registerDiv');
    const loginTabBtn = document.getElementById('loginTabBtn');
    const registerTabBtn = document.getElementById('registerTabBtn');

    if (tab === 'login') {
        loginDiv.classList.remove('hidden');
        registerDiv.classList.add('hidden');
        loginTabBtn.classList.add('border-red-500', 'text-white');
        loginTabBtn.classList.remove('border-transparent', 'text-gray-400');
        registerTabBtn.classList.add('border-transparent', 'text-gray-400');
        registerTabBtn.classList.remove('border-red-500', 'text-white');
    } else {
        loginDiv.classList.add('hidden');
        registerDiv.classList.remove('hidden');
        registerTabBtn.classList.add('border-red-500', 'text-white');
        registerTabBtn.classList.remove('border-transparent', 'text-gray-400');
        loginTabBtn.classList.add('border-transparent', 'text-gray-400');
        loginTabBtn.classList.remove('border-red-500', 'text-white');
    }
  }
  
  // Giriş
  async function login() {
    const user = document.getElementById("loginUsername").value.trim().toLowerCase();
    const pass = document.getElementById("loginPassword").value.trim();

    if (!user || !pass) {
        displayMessage("Kullanıcı adı ve şifre boş bırakılamaz!");
        return;
    }

    if (user === "weizendtv") {
        const adminEmail = "weizendtv@weizendtvoyun.com";
        try {
            await auth.signInWithEmailAndPassword(adminEmail, pass);
        } catch (error) {
            displayMessage("Admin kullanıcı adı veya şifresi yanlış!");
        }
        return;
    }

    db.ref('users/' + user).once('value').then(snap => {
        if (!snap.exists()) {
            displayMessage("Hesap bulunamadı. Lütfen 'Kayıt Ol' sekmesinden yeni bir hesap oluşturun.");
            return;
        }
        
        const data = snap.val();
        
        if (data.approved && data.approvalNotified === false) {
            displayMessage(`<b>${user}</b>, hesabınız onaylandı. Artık giriş yapabilirsiniz!`);
            db.ref('users/' + user).update({ approvalNotified: true });
            return;
        }

        if (data.password !== pass) {
            displayMessage("Şifre yanlış!");
            return;
        }
        if (!data.approved) {
            displayMessage("Hesabınız henüz admin tarafından onaylanmamış. Lütfen Kick üzerinden doğrulamayı tamamladığınızdan emin olun ve bekleyin.");
            return;
        }
        
        checkAndProceedLogin(user, data);

    }).catch(error => {
        console.error("Firebase veritabanı okuma hatası: ", error);
        displayMessage("Giriş yaparken bir sorun oluştu.");
    });
  }

  // Kayıt
  async function register() {
    const username = document.getElementById("registerUsername").value.trim().toLowerCase();
    const password = document.getElementById("registerPassword").value.trim();
    const passwordConfirm = document.getElementById("registerPasswordConfirm").value.trim();
    const pin = document.getElementById("registerPin").value.trim();

    if (!username || !password || !passwordConfirm || !pin) {
        displayMessage("Lütfen tüm alanları eksiksiz doldurun.");
        return;
    }
    if (username.length < 3) {
        displayMessage("Kullanıcı adı en az 3 karakter olmalı!");
        return;
    }
    if (password.length < 6) {
        displayMessage("Şifre en az 6 karakter olmalı!");
        return;
    }
    if (password !== passwordConfirm) {
        displayMessage("Şifreler uyuşmuyor!");
        return;
    }
    if (!/^\d{6}$/.test(pin)) {
        displayMessage("PIN, 6 haneli bir rakam olmalıdır!");
        return;
    }

    const existingUsernameSnap = await db.ref('users/' + username).once('value');
    if (existingUsernameSnap.exists()) {
        displayMessage("Bu Kick kullanıcı adı zaten alınmış.");
        return;
    }

    const confirmed = await customConfirm(`<b>${username}</b> kullanıcı adının Kick hesabınızla aynı olduğuna emin misiniz? Onay süreci bu isme göre yapılacaktır.`);
    if (confirmed) {
        const newUser = {
            password: password,
            pin: pin,
            balance: 0,
            highestBalanceEver: 0,
            totalSpentPoints: 0,
            kutuHakki: 0,
            carkBileti: 0,
            clickCatchTickets: 0, // YENİ EKLENDİ
            clickCatchHighestScore: 0,
            approved: false,
            approvalNotified: null,
            blocked: false,
            blockedUntil: null,
            boxesOpenedCount: 0,
            surpriseBoxesOpened: 0,
            activeMultiplier: 1,
            multiplierSource: 'none',
            multiplierRemainingUses: 0,
            iflasShieldUses: 0,
            registeredAt: new Date().toLocaleString(),
            iflasCount: 0,
            iflasShieldUsedCount: 0,
            multiplierFoundCount: 0,
            storePurchasesCount: 0,
            hasReceivedWelcomeGift: false,
            notifications: {},
            dailyRewardsClaimed: {},
            lastSeenAnnouncementTimestamp: 0,
        };

        db.ref('users/' + username).set(newUser).then(() => {
            openKickVerificationModal();
        }).catch(error => {
            console.error("Firebase kayıt hatası: ", error);
            displayMessage("Kayıt olurken bir hata oluştu.");
        });
    }
  }

  // Şifre Sıfırlama
  function openPasswordResetModal() {
    document.getElementById('resetStep1').classList.remove('hidden');
    document.getElementById('resetStep3').classList.add('hidden');
    document.getElementById('resetUsername').value = '';
    document.getElementById('resetPin').value = '';
    passwordResetModal.style.display = 'flex';
  }

  async function verifyResetInfo() {
      const username = document.getElementById('resetUsername').value.trim().toLowerCase();
      const pin = document.getElementById('resetPin').value.trim();
      
      if (!username || !pin) {
          displayMessage("Kullanıcı adı ve PIN gereklidir.");
          return;
      }

      const userSnap = await db.ref('users/' + username).once('value');
      if (!userSnap.exists()) {
          displayMessage("Kullanıcı bulunamadı.");
          return;
      }

      const userData = userSnap.val();
      if (userData.pin !== pin) {
          displayMessage("Girilen PIN, kullanıcı ile eşleşmiyor.");
          return;
      }
      
      userForPasswordReset = username;
      document.getElementById('resetStep1').classList.add('hidden');
      document.getElementById('resetStep3').classList.remove('hidden');
  }

  async function updatePassword() {
      const newPass = document.getElementById('newPassword').value.trim();
      const newPassConfirm = document.getElementById('newPasswordConfirm').value.trim();

      if (newPass.length < 6) {
          displayMessage("Yeni şifre en az 6 karakter olmalıdır.");
          return;
      }
      if (newPass !== newPassConfirm) {
          displayMessage("Yeni şifreler uyuşmuyor.");
          return;
      }
      await db.ref('users/' + userForPasswordReset).update({ password: newPass });
      displayMessage("Şifreniz başarıyla güncellendi. Artık giriş yapabilirsiniz.");
      closePasswordResetModal();
  }
  
  function closePasswordResetModal() {
      passwordResetModal.style.display = 'none';
      userForPasswordReset = null;
  }
  
  function openKickVerificationModal() { kickVerificationModal.style.display = 'flex'; }
  function closeKickVerificationModal() { 
      kickVerificationModal.style.display = 'none'; 
      switchAuthTab('login');
  }
  function closeWelcomeGiftModal() { welcomeGiftModal.style.display = 'none'; }


  // Oturum yönetimi
  function checkAndProceedLogin(username, userData) {
    if (userData.blocked && userData.blockedUntil && Date.now() >= userData.blockedUntil) {
         db.ref('users/' + username).update({ blocked: false, blockedUntil: null }).then(() => {
            currentUser = username;
            isAdmin = false;
            afterLogin();
         });
         return;
    }
    
    currentUser = username;
    isAdmin = false;
    afterLogin();
  }

 // BU FONKSİYONU BUL VE AŞAĞIDAKİYLE DEĞİŞTİR
auth.onAuthStateChanged(user => {
  if (user) {
    // Bu kısım aynı kalacak
    const firebaseAuthUsername = user.email ? user.email.split('@')[0].toLowerCase() : '';
    if (firebaseAuthUsername === "weizendtv") {
      currentUser = "WeizendTv";
      isAdmin = true;
      afterLogin();
    }
  } else {
    // ÇIKIŞ YAPILDIĞINDA ÇALIŞACAK BLOK (BURASI GÜNCELLENDİ)
    // Arayüzü sıfırla
    document.getElementById("loginContainer").style.display = "block";
    document.getElementById("gameDiv").style.display = "none";
    
    // YENİ EKLENEN/DEĞİŞTİRİLEN KOD BAŞLANGICI
    const activityFeedPanel = document.getElementById('activityFeedPanel');
    if (activityFeedPanel) {
        // Paneli hem gizle hem de animasyon için ekran dışına konumlandır
        activityFeedPanel.classList.add('hidden', 'translate-x-full');
    }
    const activityBellContainer = document.getElementById('activityBellContainer');
    if (activityBellContainer) {
        activityBellContainer.classList.add('hidden');
    }
    // YENİ EKLENEN/DEĞİŞTİRİLEN KOD SONU
    
    switchAuthTab('login');
    
    // Kullanıcı durumunu sıfırla
    currentUser = null;
    isAdmin = false;
    
    // Tüm zamanlayıcıları temizle
    if (countdownInterval) clearInterval(countdownInterval);
    if (globalCountdownInterval) clearInterval(globalCountdownInterval);
    if (clickCatchTimerInterval) clearInterval(clickCatchTimerInterval);
    if (clickCatchItemInterval) clearInterval(clickCatchItemInterval);
    if (storeCountdownInterval) clearInterval(storeCountdownInterval);
    if (spectatorCountdownInterval) clearInterval(spectatorCountdownInterval);
    
    // Obje olarak tutulan zamanlayıcıları temizle
    Object.values(activeBlockedUserTimers).forEach(clearInterval);
    activeBlockedUserTimers = {};
    Object.values(activeDailyRewardTimers).forEach(clearInterval);
    activeDailyRewardTimers = {};
    activeStoreCountdowns = {};

    console.log("Auth state changed to signed out. Cleanup complete.");
  }
});

async function saveWeeklyResetSettings() {
    if (!isAdmin) return;

    const dateInput = document.getElementById('weeklyResetEndDateInput').value;
    const prizeType = document.getElementById('weeklyPrizeType').value;
    const prizeAmount = parseInt(document.getElementById('weeklyPrizeAmount').value);

    if (!dateInput || isNaN(prizeAmount) || prizeAmount <= 0) {
        displayMessage("Lütfen geçerli bir bitiş tarihi ve ödül miktarı girin.");
        return;
    }
    
    const settings = {
        endDate: new Date(dateInput).getTime(),
        prize: {
            type: prizeType,
            amount: prizeAmount
        }
    };
    
    await db.ref('gameConfig/weeklyClickCatchReset').set(settings);
    
    displayMessage("Haftalık otomatik sıfırlama ayarları kaydedildi. Geri sayım başlayacak.");
    closeSoloGameSettingsModal();
}

async function stopWeeklyReset() {
    if (!isAdmin) return;

    const confirmed = await customConfirm("Mevcut haftalık geri sayımı durdurmak ve ayarları silmek istediğinizden emin misiniz?");
    if (!confirmed) return;

    await db.ref('gameConfig/weeklyClickCatchReset').remove();
    displayMessage("Haftalık otomatik sıfırlama iptal edildi.");
    closeSoloGameSettingsModal();
}

function listenForWeeklyCountdown() {
    const countdownContainer = document.getElementById('weeklyResetCountdownContainer');
    const countdownEl = document.getElementById('weeklyResetCountdown');
    const ref = db.ref('gameConfig/weeklyClickCatchReset');

    const callback = snap => {
        if (weeklyCountdownInterval) clearInterval(weeklyCountdownInterval);

        const settings = snap.val();

        if (!settings || !settings.endDate || settings.endDate < getSyncedTime()) {
            countdownContainer.classList.add('hidden');
            return;
        }

        countdownContainer.classList.remove('hidden');

        const updateTimer = () => {
            const now = getSyncedTime(); // <-- HATA DÜZELTİLDİ
            const timeLeft = settings.endDate - now;

            if (timeLeft <= 0) {
                countdownEl.textContent = "HAFTA BİTTİ!";
                clearInterval(weeklyCountdownInterval);
                if (isAdmin) { 
                   executeWeeklyReset();
                }
                return;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            countdownEl.textContent = `${days}g ${hours}s ${minutes}d ${seconds}sn`;
        };

        updateTimer();
        weeklyCountdownInterval = setInterval(updateTimer, 1000);
    };

    if (activeListeners.weeklyCountdown) {
        activeListeners.weeklyCountdown.ref.off('value', activeListeners.weeklyCountdown.callback);
    }
    activeListeners.weeklyCountdown = { ref, event: 'value', callback };
    ref.on('value', callback);
}

async function executeWeeklyReset() {
    if (!isAdmin) return;

    console.log("Haftalık sıfırlama işlemi tetiklendi...");

    // *** ÖNCELİK KONTROLÜ ***
    const seasonEndDateSnap = await db.ref('gameConfig/seasonEndDate').once('value');
    if (seasonEndDateSnap.exists()) {
        const seasonEndDate = seasonEndDateSnap.val();
        if (seasonEndDate - Date.now() < 5 * 60 * 1000) {
            console.log("Aylık sezon sıfırlaması yakın. Haftalık sıfırlama atlandı.");
            await db.ref('gameConfig/weeklyClickCatchReset').remove();
            return;
        }
    }

    const weeklyScoresSnap = await db.ref('clickCatchWeeklyScores').once('value');
    if (!weeklyScoresSnap.exists()) {
        console.log("Sıralama boş, sıfırlama işlemi iptal edildi.");
        await db.ref('gameConfig/weeklyClickCatchReset').remove();
        return;
    }
    
    const scores = [];
    weeklyScoresSnap.forEach(child => {
        scores.push({ username: child.key, score: child.val() });
    });
    scores.sort((a, b) => b.score - a.score);
    
    const winner = scores[0];
    const participants = scores.map(s => s.username);
    
    const settingsSnap = await db.ref('gameConfig/weeklyClickCatchReset').once('value');
    const settings = settingsSnap.val();
    if (!settings || !settings.prize) {
        console.error("Ödül ayarları bulunamadı, sıfırlama iptal edildi.");
        return;
    }
    const prize = settings.prize;
    const prizeNames = { boxRights: "Kutu Hakkı", points: "Puan", wheelTicket: "Çark Bileti", iflasShield: "İflas Kalkanı" };
    const prizeName = prizeNames[prize.type];

    await db.ref('gameStats/weeklyClickCatchWinner').set({
        winnerName: winner.username,
        winningScore: winner.score,
        prizeAwarded: `${prize.amount} ${prizeName}`,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    const allUsersSnap = await db.ref('users').once('value');
    const allUsers = allUsersSnap.val();
    const updates = {};

    for (const username in allUsers) {
        if (!allUsers[username].approved) continue;
        const userPath = `/users/${username}`;
        if (allUsers[username].clickCatchHighestScore) {
            updates[`${userPath}/clickCatchHighestScore`] = 0;
        }
        if (participants.includes(username)) {
            updates[`${userPath}/clickCatchTickets`] = (allUsers[username].clickCatchTickets || 0) + 1;
        }
        if (username === winner.username) {
            if (prize.type === 'points') {
                updates[`${userPath}/balance`] = (allUsers[username].balance || 0) + prize.amount;
            } else {
                const prizeKey = prize.type === 'iflasShield' ? 'iflasShieldUses' : prize.type;
                updates[`${userPath}/${prizeKey}`] = (allUsers[username][prizeKey] || 0) + prize.amount;
            }
        }
    }
    
    updates['/clickCatchWeeklyScores'] = null;
    updates['/gameConfig/weeklyClickCatchReset'] = null;
    await db.ref().update(updates);

    const notificationMessage = `Tıkla-Yakala haftasının şampiyonu ${winner.username} oldu! Yeni hafta başladı ve tüm katılımcılara +1 bilet hediye edildi!`;
    db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
    
    console.log("Haftalık sıfırlama başarıyla tamamlandı.");
}

  // MEVCUT afterLogin FONKSİYONUNU SİL VE BUNUNLA DEĞİŞTİR
async function afterLogin() {
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("gameDiv").style.display = "block";
    
    document.getElementById("currentUser").textContent = currentUser;
    document.getElementById("role").textContent = isAdmin ? "(Admin)" : "";
    document.getElementById("inventoryButton").style.display = isAdmin ? 'none' : 'inline-block';

    if (isAdmin) {
      document.getElementById('adminPanelToggleButton').classList.remove('hidden');
      document.getElementById('boxSettingsButton').classList.remove('hidden');
      document.getElementById('currentUserAvatar').src = 'https://i.hizliresim.com/mtwdr1x.png?_gl=1*1vzhmma*_ga*MTA2NTkzNzE4OC4xNzQ3MTQ1Mzk0*_ga_M9ZRXYS2YN*czE3NTUxNzY3MTckbzEwJGcxJHQxNzU1MTc3NTAwJGozNyRsMCRoMA..';
    } else {
      document.getElementById('adminPanelToggleButton').classList.add('hidden');
      document.getElementById('boxSettingsButton').classList.add('hidden');
      
      const userSnap = await db.ref('users/' + currentUser).once('value');
      const userData = userSnap.val();
      const avatarUrl = userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;
      document.getElementById('currentUserAvatar').src = avatarUrl;
    }

    showSection('game');
    await loadWheelSettingsFromDB();
    renderWheel();
    
    loadBalanceAndBoxRights();
    loadUserRankingsAndBoxCounts();
    loadLeaderboardRanking();
    loadBoxes();
    loadTotalOpenedBoxesCount();
    loadAnnouncements();
    loadClickCatchRankings();
    listenForGameChanges();
    listenForSurpriseBox();
    listenForDailyRewardChanges();
    initActivityFeed();
    listenForGlobalNotifications();
    listenForLobbyChanges();
    listenForWeeklyWinner(); 
    listenForSeasonCountdown();
    listenForWeeklyCountdown();
    listenForPersistentAnnouncement();
    listenForLastSurpriseFinderPanel(); // Bu satır eklendi
    
    if (!isAdmin) {
        listenForAdminNotifications();
        listenForNewAnnouncements(); 
        listenForNewStoreItems(); 
        checkAvailableDailyRewards();

        const userRef = db.ref('users/' + currentUser);
        userRef.once('value').then(snap => {
            const userData = snap.val();
            if (userData && userData.hasReceivedWelcomeGift === false) {
                welcomeGiftModal.style.display = 'flex';
                userRef.update({
                    kutuHakki: (userData.kutuHakki || 0) + 3,
                    hasReceivedWelcomeGift: true
                });
            }
        });
    }
}

  function switchStoreTab(tab) {
    const gameStoreContainer = document.getElementById('gameStoreItemsContainer');
    const specialStoreContainer = document.getElementById('specialStoreItemsContainer');
    const gameTabBtn = document.getElementById('gameStoreTabBtn');
    const specialTabBtn = document.getElementById('specialStoreTabBtn');

    if (tab === 'game') {
        gameStoreContainer.classList.remove('hidden');
        specialStoreContainer.classList.add('hidden');
        gameTabBtn.classList.add('border-red-500', 'text-white');
        gameTabBtn.classList.remove('border-transparent', 'text-gray-400');
        specialTabBtn.classList.add('border-transparent', 'text-gray-400');
        specialTabBtn.classList.remove('border-red-500', 'text-white');
    } else { // special
        gameStoreContainer.classList.add('hidden');
        specialStoreContainer.classList.remove('hidden');
        specialTabBtn.classList.add('border-red-500', 'text-white');
        specialTabBtn.classList.remove('border-transparent', 'text-gray-400');
        gameTabBtn.classList.add('border-transparent', 'text-gray-400');
        gameTabBtn.classList.remove('border-red-500', 'text-white');
    }
  }
  // MEVCUT showSection FONKSİYONUNU SİLİP BUNU YAPIŞTIRIN

function showSection(sectionId) {
    document.getElementById('gameContent').classList.add('hidden');
    document.getElementById('storeSection').classList.add('hidden');
    document.getElementById('announcementsContent').classList.add('hidden');
    document.getElementById('chanceWheelContent').classList.add('hidden');
    document.getElementById('clickCatchContent').classList.add('hidden');
    document.getElementById('adminStoreManagementButtonContainer').classList.add('hidden');
    document.getElementById('adminAnnouncementControls').classList.add('hidden');
    
    const clickCatchAdminButtonsContainer = document.getElementById('clickCatchAdminButtonsContainer');
    if(clickCatchAdminButtonsContainer) clickCatchAdminButtonsContainer.classList.add('hidden');

    const tabButtons = ['gameTabBtn', 'storeTabBtn', 'announcementsTabBtn', 'chanceWheelTabBtn', 'clickCatchTabBtn'];
    tabButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        btn.classList.remove('bg-red-700', 'hover:bg-red-600');
        btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
    });
    
    const activeBtn = document.getElementById(`${sectionId}TabBtn`);
    const activeContent = document.getElementById(`${sectionId}Content`) || document.getElementById(`${sectionId}Section`);

    if(activeContent) activeContent.classList.remove('hidden');
    if(activeBtn) {
        activeBtn.classList.add('bg-red-700', 'hover:bg-red-600');
        activeBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
    }

    if (sectionId === 'store') {
        loadStoreItems();
        if (isAdmin) {
            document.getElementById('adminStoreManagementButtonContainer').classList.remove('hidden');
        } else {
            // YENİ: Mağaza sekmesi görüldüğünde, zaman damgasını güncelle ve bildirimi kaldır
            document.getElementById('storeIndicator').classList.add('hidden');
            db.ref(`users/${currentUser}/lastSeenStoreTimestamp`).set(latestStoreItemTimestamp);
        }
        switchStoreTab('game'); 
    } else if (sectionId === 'announcements') {
        if (isAdmin) {
            document.getElementById('adminAnnouncementControls').classList.remove('hidden');
        } else {
            // YENİ: Duyuru sekmesi görüldüğünde, zaman damgasını güncelle ve bildirimi kaldır
            document.getElementById('announcementIndicator').classList.add('hidden');
            db.ref(`users/${currentUser}/lastSeenAnnouncementTimestamp`).set(latestAnnouncementTimestamp);
        }
    } else if (sectionId === 'clickCatch') {
        loadClickCatchRankings();
        // listenForLobbyChanges(); // BU SATIR ARTIK BURADA DEĞİL
        listenForLastGameSummary(); 
        
        if (currentUser && !isAdmin) {
            db.ref('users/' + currentUser).once('value').then(snap => {
                const userData = snap.val();
                if (userData) {
                    document.getElementById('clickCatchScore').textContent = userData.clickCatchHighestScore || 0;
                }
            });
        }

        if (isAdmin) {
            document.getElementById('clickCatchAdminButtonsContainer').classList.remove('hidden');
            loadSoloGameSettings(); 
        }
    } else if (sectionId === 'chanceWheel') {
        loadWheelHistory();
        const wheelSettingsBtn = document.getElementById('wheelSettingsButton');
        if (isAdmin) {
            wheelSettingsBtn.classList.remove('hidden');
        } else {
            wheelSettingsBtn.classList.add('hidden');
        }
    }
    
    currentActiveSection = sectionId;
}
  
  // Admin panel
  function openAdminPanelModal() { 
    document.body.classList.add('modal-open'); // BU SATIRI EKLE
    adminPanelModal.style.display = 'flex'; 
    loadPendingUsers(); 
    loadAllUsers(); 
    loadPendingSpecialPurchases();
  }
  function closeAdminPanelModal() { 
    document.body.classList.remove('modal-open'); // BU SATIRI EKLE
    adminPanelModal.style.display = 'none'; 
  }
    

// MEVCUT logout FONKSİYONUNU KOMPLE SİLİP BUNU YAPIŞTIR

async function logout() {
    const confirmed = await customConfirm("Çıkış yapmak istediğinize emin misiniz?");
    if (!confirmed) return;

    // 1. Önce tüm veritabanı dinleyicilerini kapatarak olası hataları önle.
    detachAllListeners();
    
    // 2. Arayüzü anında değiştirerek kullanıcıya anlık geri bildirim ver.
    // Bu, senin eski kodundaki anında çalışan kısımdı.
    document.getElementById("gameDiv").style.display = "none";
    document.getElementById("loginContainer").style.display = "block";
    
    const activityFeedPanel = document.getElementById('activityFeedPanel');
    if (activityFeedPanel) {
        activityFeedPanel.classList.add('hidden', 'translate-x-full');
    }
    const activityBellContainer = document.getElementById('activityBellContainer');
    if (activityBellContainer) {
        activityBellContainer.classList.add('hidden');
    }

    // 3. Global değişkenleri anında temizle.
    currentUser = null;
    isAdmin = false;
    
    // 4. Arka planda Firebase oturumunu güvenli bir şekilde kapat.
    // Bu komut, onAuthStateChanged dinleyicisini tetikleyerek kalan
    // teknik temizliği de yapacaktır.
    auth.signOut().catch((error) => {
        console.error("Çıkış yapılırken hata oluştu: ", error);
        displayMessage("Çıkış yapılırken bir hata oluştu.");
    });
}

// ...VE YERİNE BU YENİ VERSİYONU YAPIŞTIR
function loadBalanceAndBoxRights() {
    if (isAdmin) {
        document.getElementById("balance").textContent = "Admin Paneli Aktif";
        document.getElementById("currentUser").innerHTML = `${currentUser}`;
        return;
    }
    const ref = db.ref('users/' + currentUser);
    const allUsersRef = db.ref('users');

    const callback = async snap => {
        const userData = snap.val();
        if (!userData) return;

        if (userData.blocked && userData.blockedUntil && Date.now() < userData.blockedUntil) {
            displayBlockedMessage(userData.blockedUntil, currentUser);
        } else if (userData.blocked) {
            db.ref('users/' + currentUser).update({ blocked: false, blockedUntil: null });
        }

        let statusText = `Mevcut Puan: ${userData.balance || 0} | Kutu Hakkı: ${userData.kutuHakki || 0}`;
        if ((userData.carkBileti || 0) > 0) statusText += ` | 🎡 Çark Bileti: ${userData.carkBileti}`;
        if ((userData.clickCatchTickets || 0) > 0) statusText += ` | 🎯 Yakalama Bileti: ${userData.clickCatchTickets}`;
        if (userData.iflasShieldUses > 0) statusText += ` | 🛡️ Kalkan: ${userData.iflasShieldUses}`;
        if (userData.multiplierSource === 'store' && userData.multiplierRemainingUses > 0) statusText += ` | ✖️ Çarpan: ${userData.activeMultiplier}x (${userData.multiplierRemainingUses} kullanım)`;
        else if (userData.multiplierSource === 'box') statusText += ` | ✖️ Çarpan: ${userData.activeMultiplier}x (Otomatik)`;

        document.getElementById("balance").textContent = statusText;
        document.getElementById('storeCurrentUserBalance').textContent = userData.balance || 0;
        document.getElementById('storeCurrentUserSpent').textContent = userData.totalSpentPoints || 0;
        document.getElementById('wheelTicketBalance').textContent = userData.carkBileti || 0;

        // --- ROZET GÜNCELLEME KISMI ---
        const allUsersSnap = await allUsersRef.once('value');
        const leaders = await calculateAllLeaders(allUsersSnap.val());
        const userLeaderStatus = {
            isCurrentLeader: currentUser === leaders.currentBalanceUser,
            isHighLeader: currentUser === leaders.highEverBalanceUser,
            isSurpriseLeader: currentUser === leaders.surpriseBoxUser,
            isBombLeader: currentUser === leaders.bombUser,
            isStoreLeader: currentUser === leaders.spentPointsUser,
            isMultiplierLeader: currentUser === leaders.multiplierUser,
            isBoxLeader: currentUser === leaders.boxUser,
            isShieldLeader: currentUser === leaders.shieldUser,
            isClickCatchLeader: currentUser === leaders.clickCatchLeaderUser,
            isWheelSpinLeader: currentUser === leaders.wheelSpinUser
        };
        const badgesHtml = getInlineBadgesHtmlFromStatus(userLeaderStatus);
        // Rozetleri yeni açtığımız alana koy, ismin yanından kaldır.
        document.getElementById("currentUserBadges").innerHTML = badgesHtml;
        document.getElementById("currentUser").innerHTML = `${currentUser}`;
        // --- ROZET GÜNCELLEME BİTİŞ ---
    };
    
    if(activeListeners.balance) activeListeners.balance.ref.off('value', activeListeners.balance.callback);
    activeListeners.balance = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// --- YENİ EKLENECEK SİHİRLİ ROZET FONKSİYONU ---
function getInlineBadgesHtmlFromStatus(userLeaderStatus) {
    if (!userLeaderStatus) return '';

    const hasKingCrown = userLeaderStatus.isCurrentLeader && userLeaderStatus.isHighLeader && userLeaderStatus.isSurpriseLeader &&
                         userLeaderStatus.isBombLeader && userLeaderStatus.isStoreLeader && userLeaderStatus.isMultiplierLeader &&
                         userLeaderStatus.isBoxLeader && userLeaderStatus.isShieldLeader && userLeaderStatus.isClickCatchLeader && userLeaderStatus.isWheelSpinLeader;

    if (hasKingCrown) {
        return `<span class="inline-badge" title="Tüm Liderlik Rozetlerinin Sahibi!">👑</span>`;
    }

    const badges = [];
    if (userLeaderStatus.isCurrentLeader) badges.push(`<span class="inline-badge" title="Mevcut Puan Lideri">🥇</span>`);
    if (userLeaderStatus.isHighLeader) badges.push(`<span class="inline-badge" title="Ulaşılan En Yüksek Puan Lideri">🏆</span>`);
    if (userLeaderStatus.isClickCatchLeader) badges.push(`<span class="inline-badge" title="Tıkla-Yakala Lideri">🎯</span>`);
    if (userLeaderStatus.isWheelSpinLeader) badges.push(`<span class="inline-badge" title="Çark Lideri">🎡</span>`);
    if (userLeaderStatus.isBoxLeader) badges.push(`<span class="inline-badge" title="Kutu Lideri">📦</span>`);
    if (userLeaderStatus.isSurpriseLeader) badges.push(`<span class="inline-badge" title="Sürpriz Kutu Lideri">🎉</span>`);
    if (userLeaderStatus.isBombLeader) badges.push(`<span class="inline-badge" title="Bomba Lideri">💣</span>`);
    if (userLeaderStatus.isMultiplierLeader) badges.push(`<span class="inline-badge" title="Çarpan Lideri">✖️</span>`);
    if (userLeaderStatus.isStoreLeader) badges.push(`<span class="inline-badge" title="Alışveriş Lideri">🛒</span>`);
    if (userLeaderStatus.isShieldLeader) badges.push(`<span class="inline-badge" title="Kalkan Lideri">🛡️</span>`);
    
    return badges.join(''); // Rozetleri yanyana birleştirip döndür
}
// --- YENİ FONKSİYON BİTİŞ ---
  
 function getUserBadgesHtml(u, leaders, forPublicProfile = false) {
    const hasKingCrown = leaders.isCurrentLeader && leaders.isHighLeader && leaders.isSurpriseLeader &&
                         leaders.isBombLeader && leaders.isStoreLeader && leaders.isMultiplierLeader &&
                         leaders.isBoxLeader && leaders.isShieldLeader && leaders.isClickCatchLeader && leaders.isWheelSpinLeader;

    if (forPublicProfile) {
        if (hasKingCrown) {
            return {
                crown: `<span class="text-3xl" title="Tüm Liderlik Rozetlerinin Sahibi!">👑</span>`,
                others: ''
            };
        }

        const allBadges = [];
        if (leaders.isCurrentLeader) allBadges.push(`<span class="text-2xl" title="Mevcut Puan Lideri">🥇</span>`);
        if (leaders.isHighLeader) allBadges.push(`<span class="text-2xl" title="Ulaşılan En Yüksek Puan Lideri">🏆</span>`);
        if (leaders.isClickCatchLeader) allBadges.push(`<span class="text-2xl" title="Tıkla-Yakala Lideri">🎯</span>`);
        if (leaders.isWheelSpinLeader) allBadges.push(`<span class="text-2xl" title="Çark Lideri">🎡</span>`);
        if (leaders.isBoxLeader) allBadges.push(`<span class="text-2xl" title="Kutu Lideri">📦</span>`);
        if (leaders.isSurpriseLeader) allBadges.push(`<span class="text-2xl" title="Sürpriz Kutu Lideri">🎉</span>`);
        if (leaders.isBombLeader) allBadges.push(`<span class="text-2xl" title="Bomba Lideri">💣</span>`);
        if (leaders.isMultiplierLeader) allBadges.push(`<span class="text-2xl" title="Çarpan Lideri">✖️</span>`);
        if (leaders.isStoreLeader) allBadges.push(`<span class="text-2xl" title="Alışveriş Lideri">🛒</span>`);
        if (leaders.isShieldLeader) allBadges.push(`<span class="text-2xl" title="Kalkan Lideri">🛡️</span>`);
        if (!leaders.isSurpriseLeader && (u.surpriseBoxesOpened || 0) > 0) {
            allBadges.push(`<span class="text-2xl" title="Sürpriz Kutu Rozeti">🎁</span>`);
        }
        
        return {
            crown: '',
            others: allBadges.join('')
        };
    }

    const rankingBadges = [];
    if (leaders.isCurrentLeader) rankingBadges.push(`<span class="text-xl" title="Mevcut Puan Lideri">🥇</span>`);
    if (leaders.isHighLeader) rankingBadges.push(`<span class="text-xl" title="Ulaşılan En Yüksek Puan Lideri">🏆</span>`);
    if (leaders.isClickCatchLeader) rankingBadges.push(`<span class="text-xl" title="Tıkla-Yakala Lideri">🎯</span>`);
    if (leaders.isWheelSpinLeader) rankingBadges.push(`<span class="text-xl" title="Çark Lideri">🎡</span>`);
    if (leaders.isBoxLeader) rankingBadges.push(`<span class="text-xl" title="Kutu Lideri">📦</span>`);
    if (leaders.isSurpriseLeader) rankingBadges.push(`<span class="text-xl" title="Sürpriz Kutu Lideri">🎉</span>`);
    if (leaders.isBombLeader) rankingBadges.push(`<span class="text-xl" title="Bomba Lideri">💣</span>`);
    if (leaders.isMultiplierLeader) rankingBadges.push(`<span class="text-xl" title="Çarpan Lideri">✖️</span>`);
    if (leaders.isStoreLeader) rankingBadges.push(`<span class="text-xl" title="Alışveriş Lideri">🛒</span>`);
    if (leaders.isShieldLeader) rankingBadges.push(`<span class="text-xl" title="Kalkan Lideri">🛡️</span>`);
    if (!leaders.isSurpriseLeader && (u.surpriseBoxesOpened || 0) > 0) {
        rankingBadges.push(`<span class="text-xl" title="Sürpriz Kutu Rozeti">🎁</span>`);
    }

    const crownHtml = hasKingCrown ? `<div class="flex justify-center w-full mb-1"><span class="text-3xl" title="Tüm Liderlik Rozetlerinin Sahibi!">👑</span></div>` : '';
    const otherBadgesHtml = `<div class="flex items-center justify-center gap-1 h-6">${rankingBadges.join('')}</div>`;

    return crownHtml + otherBadgesHtml;
}

  // === ESKİ loadUserRankingsAndBoxCounts FONKSİYONUNU SİL VE BUNU YAPIŞTIR ===

function loadUserRankingsAndBoxCounts() {
    const ref = db.ref('users');

    // Önceki dinleyiciyi temizle
    if (activeListeners.userRankings && activeListeners.userRankings.ref) {
        activeListeners.userRankings.ref.off();
    }
    
    // Dinleyiciyi kaydet
    activeListeners.userRankings = { ref: ref };
    
    // Sadece ilk yüklemede tüm veriyi çek
    ref.once('value', initialSnap => {
        allUsersCache = []; // Önbelleği temizle
        const usersData = initialSnap.val();
        if (usersData) {
            allUsersCache = Object.entries(usersData)
                .filter(([username, userData]) => username.toLowerCase() !== 'weizendtv' && userData.approved)
                .map(([username, userData]) => ({ username, ...userData }));
        }
        renderUserRankings(); // İlk sıralamayı çiz
    });

    // Yeni eklenen kullanıcıları dinle
    ref.on('child_added', snap => {
        const username = snap.key;
        const userData = snap.val();
        if (username.toLowerCase() !== 'weizendtv' && userData.approved) {
            // Eğer önbellekte zaten varsa ekleme (ilk yüklemede gelebilir), yoksa ekle
            if (!allUsersCache.some(u => u.username === username)) {
                allUsersCache.push({ username, ...userData });
                renderUserRankings();
            }
        }
    });

    // Değişen kullanıcıları dinle
    ref.on('child_changed', snap => {
        const username = snap.key;
        const userData = snap.val();
        const userIndex = allUsersCache.findIndex(u => u.username === username);
        if (userIndex > -1) {
            // Kullanıcıyı önbellekte güncelle
            allUsersCache[userIndex] = { username, ...userData };
            renderUserRankings(); // Sıralamayı yeniden çiz
        }
    });

    // Silinen kullanıcıları dinle
    ref.on('child_removed', snap => {
        const username = snap.key;
        const userIndex = allUsersCache.findIndex(u => u.username === username);
        if (userIndex > -1) {
            // Kullanıcıyı önbellekten sil
            allUsersCache.splice(userIndex, 1);
            renderUserRankings(); // Sıralamayı yeniden çiz
        }
    });
}

async function calculateAllLeaders(allUsersData) {
    const currentClickCatchLeader = await getClickCatchLeaderUsername();
    let leaders = {
        highestCurrentBalance: -1, currentBalanceUser: null,
        highestEverBalance: -1, highEverBalanceUser: null,
        maxSurpriseBoxes: -1, surpriseBoxUser: null,
        maxBombCount: -1, bombUser: null,
        maxSpentPoints: -1, spentPointsUser: null,
        maxMultiplierFound: -1, multiplierUser: null,
        maxBoxesOpened: -1, boxUser: null,
        maxShieldUsed: -1, shieldUser: null,
        maxWheelSpins: -1, wheelSpinUser: null,
    };

    // allUsersData bir obje olduğu için for...in döngüsü kullanıyoruz.
    for (const username in allUsersData) {
        if (username.toLowerCase() === 'weizendtv' || !allUsersData[username].approved) continue;
        const userData = allUsersData[username];
        
        const userBalance = userData.balance || 0;
        if (userBalance > 0 && userBalance > leaders.highestCurrentBalance) {
            leaders.highestCurrentBalance = userBalance;
            leaders.currentBalanceUser = username;
        }

        const userHighestBalance = userData.highestBalanceEver || 0;
        if (userHighestBalance > 0 && userHighestBalance > leaders.highestEverBalance) {
            leaders.highestEverBalance = userHighestBalance;
            leaders.highEverBalanceUser = username;
        }

        const userSurpriseBoxes = userData.surpriseBoxesOpened || 0;
        if (userSurpriseBoxes > 0 && userSurpriseBoxes > leaders.maxSurpriseBoxes) {
            leaders.maxSurpriseBoxes = userSurpriseBoxes;
            leaders.surpriseBoxUser = username;
        }

        const userBombCount = userData.iflasCount || 0;
        if (userBombCount > 0 && userBombCount > leaders.maxBombCount) {
            leaders.maxBombCount = userBombCount;
            leaders.bombUser = username;
        }

        const userSpentPoints = userData.totalSpentPoints || 0;
        if (userSpentPoints > 0 && userSpentPoints > leaders.maxSpentPoints) {
            leaders.maxSpentPoints = userSpentPoints;
            leaders.spentPointsUser = username;
        }

        const userMultiplierFound = userData.multiplierFoundCount || 0;
        if (userMultiplierFound > 0 && userMultiplierFound > leaders.maxMultiplierFound) {
            leaders.maxMultiplierFound = userMultiplierFound;
            leaders.multiplierUser = username;
        }

        const userBoxesOpened = userData.boxesOpenedCount || 0;
        if (userBoxesOpened > 0 && userBoxesOpened > leaders.maxBoxesOpened) {
            leaders.maxBoxesOpened = userBoxesOpened;
            leaders.boxUser = username;
        }

        const userShieldUsed = userData.iflasShieldUsedCount || 0;
        if (userShieldUsed > 0 && userShieldUsed > leaders.maxShieldUsed) {
            leaders.maxShieldUsed = userShieldUsed;
            leaders.shieldUser = username;
        }
        
        const userWheelSpins = userData.wheelSpinsCount || 0;
        if (userWheelSpins > 0 && userWheelSpins > leaders.maxWheelSpins) {
            leaders.maxWheelSpins = userWheelSpins;
            leaders.wheelSpinUser = username;
        }
    }
    
    leaders.clickCatchLeaderUser = currentClickCatchLeader;
    
    return leaders;
}

  // BU FONKSİYONU BUL VE AŞAĞIDAKİ KOD İLE DEĞİŞTİR

async function renderUserRankings() {
    const searchTerm = document.getElementById('searchUserRanking').value.trim().toLowerCase();
    
    let filteredUsers = allUsersCache;
    if (searchTerm) {
        filteredUsers = allUsersCache.filter(u => u.username.toLowerCase().includes(searchTerm));
    }

    const allUsersSnap = await db.ref('users').once('value');
    const allUsersData = allUsersSnap.val() || {};
    
    const leaders = await calculateAllLeaders(allUsersData);

    filteredUsers.sort((a, b) => (b.balance || 0) - (a.balance || 0));

    let html = filteredUsers.map((u, i) => {
        const userLeaderStatus = {
            isCurrentLeader: u.username === leaders.currentBalanceUser,
            isHighLeader: u.username === leaders.highEverBalanceUser,
            isSurpriseLeader: u.username === leaders.surpriseBoxUser,
            isBombLeader: u.username === leaders.bombUser,
            isStoreLeader: u.username === leaders.spentPointsUser,
            isMultiplierLeader: u.username === leaders.multiplierUser,
            isBoxLeader: u.username === leaders.boxUser,
            isShieldLeader: u.username === leaders.shieldUser,
            isClickCatchLeader: u.username === leaders.clickCatchLeaderUser,
            isWheelSpinLeader: u.username === leaders.wheelSpinUser
        };

        const userIcons = getUserBadgesHtml(u, userLeaderStatus);
        const avatarUrl = u.selectedAvatar ? u.selectedAvatar.url : defaultAvatarUrl;
        
        let blockedInfo = '';
        const isBlocked = u.blocked && u.blockedUntil && Date.now() < u.blockedUntil;
        if (isBlocked) {
            blockedInfo = `<div class="text-red-400 font-bold mt-2">Engelli - Kalan Süre: <span id="countdown-${u.username}">--:--</span></div>`;
        }

        return `<div class="mb-3 p-3 bg-gray-800 rounded-md border border-gray-700 cursor-pointer hover:bg-gray-700" onclick="openPublicUserDetailModal('${u.username}')">
            <div class="text-center">${userIcons}</div>
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mt-1 gap-2">
                <div class="flex items-center text-left">
                    <span class="font-semibold text-base sm:text-lg text-yellow-300 mr-3 w-8 text-center">${i + 1}.</span>
                    <img src="${avatarUrl}" class="w-10 h-10 sm:w-12 sm:h-12 rounded-md mr-3 object-contain">
                    <span class="font-semibold text-base sm:text-lg">${u.username}</span>
                </div>
                <span class="text-yellow-400 font-bold text-base sm:text-lg w-full sm:w-auto text-right pr-2 sm:pr-0">${u.balance || 0} Puan</span>
            </div>
            ${blockedInfo}
        </div>`;
    }).join("");

    document.getElementById("allUserRankings").innerHTML = html || "<div class='text-center text-gray-400'>Aramayla eşleşen kullanıcı bulunamadı.</div>";
    document.getElementById("totalUsers").textContent = allUsersCache.length;
}


// BU FONKSİYONU DA BUL VE AŞAĞIDAKİ KOD İLE DEĞİŞTİR

async function loadLeaderboardRanking() {
    const ref = db.ref('users');

    if (activeListeners.leaderboard && activeListeners.leaderboard.ref) {
        activeListeners.leaderboard.ref.off();
    }

    activeListeners.leaderboard = { ref: ref };

    const renderLeaders = async (snap) => {
        const usersData = snap.val() || {};

        if (Object.keys(usersData).length === 0) {
            document.getElementById("badgedUsersRanking").innerHTML = "<div class='text-center text-gray-400'>Henüz lider kullanıcı yok.</div>";
            return;
        }

        const leaders = await calculateAllLeaders(usersData);
        
        const leaderUsernames = new Set([
            leaders.currentBalanceUser, leaders.highEverBalanceUser, leaders.surpriseBoxUser,
            leaders.bombUser, leaders.spentPointsUser, leaders.multiplierUser,
            leaders.boxUser, leaders.shieldUser, leaders.clickCatchLeaderUser, leaders.wheelSpinUser
        ]);
        leaderUsernames.delete(null);
        
        const allUsersAsArray = Object.entries(usersData).map(([username, data]) => ({ username, ...data }));
        const leaderUsers = allUsersAsArray.filter(u => leaderUsernames.has(u.username));

        leaderUsers.sort((a, b) => {
            const getBadgeCount = (user) => {
                let count = 0;
                if (user.username === leaders.currentBalanceUser) count++;
                if (user.username === leaders.highEverBalanceUser) count++;
                if (user.username === leaders.surpriseBoxUser) count++;
                if (user.username === leaders.bombUser) count++;
                if (user.username === leaders.spentPointsUser) count++;
                if (user.username === leaders.multiplierUser) count++;
                if (user.username === leaders.boxUser) count++;
                if (user.username === leaders.shieldUser) count++;
                if (user.username === leaders.clickCatchLeaderUser) count++;
                if (user.username === leaders.wheelSpinUser) count++;
                return count;
            };

            const aBadgeCount = getBadgeCount(a);
            const bBadgeCount = getBadgeCount(b);
            
            if (bBadgeCount !== aBadgeCount) return bBadgeCount - aBadgeCount;
            return (b.balance || 0) - (a.balance || 0);
        });

        const html = leaderUsers.map((u, i) => {
            const userLeaderStatus = {
                isCurrentLeader: u.username === leaders.currentBalanceUser,
                isHighLeader: u.username === leaders.highEverBalanceUser,
                isSurpriseLeader: u.username === leaders.surpriseBoxUser,
                isBombLeader: u.username === leaders.bombUser,
                isStoreLeader: u.username === leaders.spentPointsUser,
                isMultiplierLeader: u.username === leaders.multiplierUser,
                isBoxLeader: u.username === leaders.boxUser,
                isShieldLeader: u.username === leaders.shieldUser,
                isClickCatchLeader: u.username === leaders.clickCatchLeaderUser,
                isWheelSpinLeader: u.username === leaders.wheelSpinUser
            };
            const badgesHtml = getUserBadgesHtml(u, userLeaderStatus);
            const avatarUrl = u.selectedAvatar ? u.selectedAvatar.url : defaultAvatarUrl;

            return `<div class="mb-3 p-3 bg-gray-800 rounded-md border border-gray-700 cursor-pointer hover:bg-gray-700" onclick="openPublicUserDetailModal('${u.username}')">
                <div class="text-center">${badgesHtml}</div>
                <div class="flex items-center justify-start mt-1">
                    <span class="font-semibold text-lg text-yellow-300 mr-3 w-8 text-left">${i + 1}.</span>
                    <img src="${avatarUrl}" class="w-12 h-12 rounded-md mr-3 object-contain">
                    <span class="font-semibold text-lg">${u.username}</span>
                </div>
            </div>`;
        }).join("");

        document.getElementById("badgedUsersRanking").innerHTML = html || "<div class='text-center text-gray-400'>Henüz lider kullanıcı yok.</div>";
    };

    ref.on('value', renderLeaders);
}
  
  function loadPendingUsers() {
    const ref = db.ref('users');
    const callback = snap => {
      const data = snap.val();
      let html = "";
      if (data) {
          for (const u in data) {
            if (data[u].approved === false) {
              html += `<div class="flex justify-between items-center p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-red-500">
                <span class="text-gray-200">${u}</span>
                <div class="flex space-x-2">
                <button onclick="approveUser('${u}')" class="py-1 px-3 bg-green-600 hover:bg-green-500 text-white text-sm font-bold rounded-md">Onayla</button>
                <button onclick="denyUser('${u}', true)" class="py-1 px-3 bg-red-600 hover:bg-red-500 text-white text-sm font-bold rounded-md">Sil</button></div></div>`;
            }
          }
      }
      document.getElementById("pendingUsers").innerHTML = html || "<div class='text-center text-gray-400'>Onay bekleyen kullanıcı yok.</div>";
    };
    activeListeners.pendingUsers = { ref, event: 'value', callback };
    ref.on('value', callback);
  }

  function loadAllUsers() {
    const ref = db.ref('users');
    const callback = snap => {
      const data = snap.val();
      let html = "";
      if (data) {
          for (const u in data) {
            if (u.toLowerCase() === "weizendtv") continue;
            const user = data[u];
            let blockedStatusHtml = '';
            const isCurrentlyBlocked = user.blocked && user.blockedUntil && Date.now() < user.blockedUntil;
            if (isCurrentlyBlocked) {
                blockedStatusHtml = `<span class="text-red-400">(Engelli - <span id="admin-countdown-${u}">--:--</span>)</span>`;
                if (!activeBlockedUserTimers[u]) {
                    const timerId = setInterval(() => {
                        const timeLeft = user.blockedUntil - Date.now();
                        const el = document.getElementById(`admin-countdown-${u}`);
                        if (timeLeft <= 0) {
                            clearInterval(timerId);
                            if(el) el.parentElement.innerHTML = '<span class="text-green-400">(Engel Kalktı)</span>';
                        } else {
                            const minutes = Math.floor(timeLeft / 60000);
                            const seconds = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, '0');
                            if(el) el.textContent = `${minutes}:${seconds}`;
                        }
                    }, 1000);
                    activeBlockedUserTimers[u] = timerId;
                }
            } else if (user.blocked) {
                blockedStatusHtml = `<span class="text-green-400">(Engel Süresi Doldu)</span>`;
            }

            const avatarUrl = user.selectedAvatar ? user.selectedAvatar.url : defaultAvatarUrl;
html += `<div class="flex items-center justify-between p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-blue-500 cursor-pointer hover:bg-gray-600 transition-colors" onclick="openUserManagementModal('${u}')">
            <div class="flex items-center">
              <img src="${avatarUrl}" class="w-12 h-12 rounded-md mr-3 object-contain">
              <span class="text-gray-200">${u} ${blockedStatusHtml}</span>
            </div>
            <span class="text-yellow-300">Puan: ${user.balance || 0}</span>
          </div>`;
          }
      }
      document.getElementById("allUsers").innerHTML = html || "<div class='text-center text-gray-400'>Kullanıcı yok.</div>";
    };
    activeListeners.allUsers = { ref, event: 'value', callback };
    ref.on('value', callback);
  }
  
  function displayMessage(message) { document.getElementById('generalMessageContent').innerHTML = message; generalMessageModal.style.display = 'flex'; }
  function closeGeneralMessageModal() { generalMessageModal.style.display = 'none'; }
  function customConfirm(message, callback) {
    return new Promise(resolve => {
        const confirmBox = document.createElement('div');
        confirmBox.className = 'fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[99999]';
        confirmBox.innerHTML = `
          <div class="bg-gray-800 p-8 rounded-xl shadow-2xl border border-red-700 w-11/12 max-w-md text-center relative">
            <p class="text-lg text-gray-300 mb-6">${message}</p>
            <div class="flex gap-4 justify-center">
              <button id="confirmYes" class="flex-1 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg">Evet</button>
              <button id="confirmNo" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">Hayır</button>
            </div>
          </div>
        `;
        document.body.appendChild(confirmBox);
        document.getElementById('confirmYes').onclick = () => { confirmBox.remove(); resolve(true); };
        document.getElementById('confirmNo').onclick = () => { confirmBox.remove(); resolve(false); };
    });
  }

  function notifyUser(username, message) {
      if (!username || !message) return;
      const notifRef = db.ref(`users/${username}/notifications`).push();
      notifRef.set({
          message: message,
          timestamp: firebase.database.ServerValue.TIMESTAMP
      });
  }

  function openPointAdjustmentModal(username) {
    targetUserForAdjustment = username;
    document.getElementById('adjUserName').textContent = username;
    db.ref('users/' + username + '/balance').once('value').then(snap => {
      document.getElementById('adjUserBalance').textContent = snap.val() || 0;
    });
    pointAdjustmentModal.style.display = 'flex';
  }

  function closePointAdjustmentModal() {
    pointAdjustmentModal.style.display = 'none';
    document.getElementById('adjAmount').value = '';
    targetUserForAdjustment = null;
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement);
  }

  function adjustUserPoints(add) {
    const amount = parseInt(document.getElementById('adjAmount').value);
    if (isNaN(amount) || amount <= 0) {
      displayMessage("Geçerli bir miktar girin.");
      return;
    }
    db.ref('users/' + targetUserForAdjustment).once('value').then(snap => {
      let data = snap.val();
      let bal = data.balance || 0;
      let highBal = data.highestBalanceEver || 0;
      bal = add ? bal + amount : Math.max(0, bal - amount);
      if (bal > highBal) highBal = bal;
      db.ref('users/' + targetUserForAdjustment).update({
        balance: bal,
        highestBalanceEver: highBal
      }).then(() => {
        const message = `Admin tarafından hesabınıza ${amount} puan ${add ? 'eklendi' : 'silindi'}.`;
        notifyUser(targetUserForAdjustment, message);
        displayMessage(`${targetUserForAdjustment} yeni bakiyesi: ${bal}`);
        closePointAdjustmentModal();
      });
    });
  }

  function openBoxRightAdjustmentModal(username) {
    targetUserForBoxRightAdjustment = username;
    document.getElementById('adjBoxRightUserName').textContent = username;
    db.ref('users/' + username + '/kutuHakki').once('value').then(snap => {
      document.getElementById('adjUserBoxRight').textContent = snap.val() || 0;
    });
    boxRightAdjustmentModal.style.display = 'flex';
  }

  function closeBoxRightAdjustmentModal() {
    boxRightAdjustmentModal.style.display = 'none';
    document.getElementById('adjBoxRightAmount').value = '';
    targetUserForBoxRightAdjustment = null;
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement);
  }

  function adjustUserBoxRights(add) {
    const amount = parseInt(document.getElementById('adjBoxRightAmount').value);
    if (isNaN(amount) || amount <= 0) {
      displayMessage("Geçerli bir miktar girin.");
      return;
    }
    db.ref('users/' + targetUserForBoxRightAdjustment + '/kutuHakki').once('value').then(snap => {
      let val = snap.val() || 0;
      val = add ? val + amount : Math.max(0, val - amount);
      db.ref('users/' + targetUserForBoxRightAdjustment).update({
        kutuHakki: val
      }).then(() => {
        const message = `Admin tarafından hesabınıza ${amount} kutu hakkı ${add ? 'eklendi' : 'silindi'}.`;
        notifyUser(targetUserForBoxRightAdjustment, message);
        displayMessage(`${targetUserForBoxRightAdjustment} yeni kutu hakkı: ${val}`);
        closeBoxRightAdjustmentModal();
      });
    });
  }

  function openIflasShieldAdjustmentModal(username) {
    targetUserForIflasShieldAdjustment = username;
    document.getElementById('adjIflasShieldUserName').textContent = username;
    db.ref('users/' + username + '/iflasShieldUses').once('value').then(snap => {
      document.getElementById('adjUserIflasShield').textContent = snap.val() || 0;
    });
    iflasShieldAdjustmentModal.style.display = 'flex';
  }

  function closeIflasShieldAdjustmentModal() {
    iflasShieldAdjustmentModal.style.display = 'none';
    document.getElementById('adjIflasShieldAmount').value = '';
    targetUserForIflasShieldAdjustment = null;
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement);
  }

  async function adjustUserIflasShields(add) {
    const amount = parseInt(document.getElementById('adjIflasShieldAmount').value);
    if (isNaN(amount) || amount <= 0) {
      displayMessage("Geçerli bir miktar girin.");
      return;
    }
    const userRef = db.ref('users/' + targetUserForIflasShieldAdjustment + '/iflasShieldUses');
    userRef.once('value').then(snap => {
      let currentShields = snap.val() || 0;
      const newShields = add ? currentShields + amount : Math.max(0, currentShields - amount);
      userRef.set(newShields).then(() => {
        const message = `Admin tarafından hesabınıza ${amount} İflas Kalkanı ${add ? 'eklendi' : 'silindi'}.`;
        notifyUser(targetUserForIflasShieldAdjustment, message);
        displayMessage(`${targetUserForIflasShieldAdjustment} için kalkan ayarlandı: ${newShields}`);
        closeIflasShieldAdjustmentModal();
      });
    });
  }

  async function openMultiplierAdjustmentModal(username) {
    targetUserForMultiplierAdjustment = username;
    document.getElementById('adjMultiplierUserName').textContent = username;
    const userSnap = await db.ref('users/' + username).once('value');
    const userData = userSnap.val();
    if (userData) {
      document.getElementById('adjUserMultiplier').textContent = `${userData.activeMultiplier || 1}x`;
      document.getElementById('adjUserMultiplierUses').textContent = userData.multiplierRemainingUses || 0;
      document.getElementById('setMultiplierValue').value = userData.activeMultiplier || 1;
      document.getElementById('setMultiplierSource').value = userData.multiplierSource || 'none';
      document.getElementById('setMultiplierUses').value = userData.multiplierRemainingUses || 0;
    }
    multiplierAdjustmentModal.style.display = 'flex';
  }

  function closeMultiplierAdjustmentModal() {
    multiplierAdjustmentModal.style.display = 'none';
    targetUserForMultiplierAdjustment = null;
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement);
  }

  async function setMultiplier() {
    const multiplierValue = parseInt(document.getElementById('setMultiplierValue').value);
    const multiplierSource = document.getElementById('setMultiplierSource').value;
    const multiplierUses = parseInt(document.getElementById('setMultiplierUses').value);
    if (isNaN(multiplierValue) || multiplierValue <= 0) {
      displayMessage("Geçerli çarpan değeri girin.");
      return;
    }
    const updates = {
      activeMultiplier: multiplierValue,
      multiplierSource: multiplierSource,
      multiplierRemainingUses: multiplierSource === 'store' ? (isNaN(multiplierUses) ? 0 : multiplierUses) : (multiplierSource === 'box' ? 1 : 0)
    };
    await db.ref('users/' + targetUserForMultiplierAdjustment).update(updates);
    const message = `Admin tarafından hesabınıza ${multiplierValue}x çarpan ayarlandı.`;
    notifyUser(targetUserForMultiplierAdjustment, message);
    displayMessage("Çarpan ayarlandı.");
    closeMultiplierAdjustmentModal();
  }

  async function resetMultiplier() {
    const updates = {
      activeMultiplier: 1,
      multiplierSource: 'none',
      multiplierRemainingUses: 0,
      activeStoreMultiplierItemId: null
    };
    await db.ref('users/' + targetUserForMultiplierAdjustment).update(updates);
    notifyUser(targetUserForMultiplierAdjustment, "Çarpanınız admin tarafından sıfırlandı.");
    displayMessage("Çarpan sıfırlandı.");
    closeMultiplierAdjustmentModal();
  }
function openWheelTicketAdjustmentModal(username) { 
    targetUserForWheelTicket = username; 
    document.getElementById('adjWheelTicketUserName').textContent = username; 
    db.ref('users/' + username + '/carkBileti').once('value').then(snap => { 
        document.getElementById('adjUserWheelTicket').textContent = snap.val() || 0; 
    }); 
    wheelTicketAdjustmentModal.style.display = 'flex'; 
}
function closeWheelTicketAdjustmentModal() { 
    wheelTicketAdjustmentModal.style.display = 'none'; 
    document.getElementById('adjWheelTicketAmount').value = ''; 
    targetUserForWheelTicket = null; 
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement); 
}
function adjustUserWheelTickets(add) { 
    const amount = parseInt(document.getElementById('adjWheelTicketAmount').value); 
    if(isNaN(amount) || amount <= 0) { displayMessage("Geçerli bir miktar girin."); return; } 
    const userRef = db.ref('users/' + targetUserForWheelTicket + '/carkBileti');
    userRef.transaction(currentTickets => {
        currentTickets = currentTickets || 0;
        return add ? currentTickets + amount : Math.max(0, currentTickets - amount);
    }).then(() => {
        const message = `Admin tarafından ${targetUserForWheelTicket} hesabına ${amount} çark bileti ${add ? 'eklendi' : 'silindi'}.`;
        notifyUser(targetUserForWheelTicket, message);
        displayMessage(message); 
        closeWheelTicketAdjustmentModal(); 
    });
}

function openClickCatchTicketAdjustmentModal(username) { 
    targetUserForClickCatchTicket = username; 
    document.getElementById('adjClickCatchTicketUserName').textContent = username; 
    db.ref('users/' + username + '/clickCatchTickets').once('value').then(snap => { 
        document.getElementById('adjUserClickCatchTicket').textContent = snap.val() || 0; 
    }); 
    clickCatchTicketAdjustmentModal.style.display = 'flex'; 
}
function closeClickCatchTicketAdjustmentModal() { 
    clickCatchTicketAdjustmentModal.style.display = 'none'; 
    document.getElementById('adjClickCatchTicketAmount').value = ''; 
    targetUserForClickCatchTicket = null; 
    if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement); 
}
function adjustUserClickCatchTickets(add) { 
    const amount = parseInt(document.getElementById('adjClickCatchTicketAmount').value); 
    if(isNaN(amount) || amount <= 0) { displayMessage("Geçerli bir miktar girin."); return; } 
    const userRef = db.ref('users/' + targetUserForClickCatchTicket + '/clickCatchTickets');
    userRef.transaction(currentTickets => {
        currentTickets = currentTickets || 0;
        return add ? currentTickets + amount : Math.max(0, currentTickets - amount);
    }).then(() => {
        const message = `Admin tarafından ${targetUserForClickCatchTicket} hesabına ${amount} Tıkla-Yakala bileti ${add ? 'eklendi' : 'silindi'}.`;
        notifyUser(targetUserForClickCatchTicket, message);
        displayMessage(message); 
        closeClickCatchTicketAdjustmentModal(); 
    });
}

// --- YENİ BİLET YÖNETİM FONKSİYONLARI BİTİŞ ---
  // Admin işlemleri
  function openBlockDurationModal(username) { targetUserForBlock = username; document.getElementById('blockUserName').textContent = username; blockDurationModal.style.display = 'flex'; }
  function closeBlockDurationModal() { blockDurationModal.style.display = 'none'; document.getElementById('blockDuration').value = ''; targetUserForBlock = null; if (selectedUserForManagement) openUserManagementModal(selectedUserForManagement); }
  function confirmBlockUser() { const duration = parseInt(document.getElementById('blockDuration').value); if (isNaN(duration) || duration <= 0) { displayMessage("Geçerli süre girin."); return; } const blockedUntil = Date.now() + duration * 60 * 1000; db.ref('users/' + targetUserForBlock).update({ blocked: true, blockedUntil: blockedUntil }).then(() => { displayMessage(`${targetUserForBlock} ${duration} dakika engellendi.`); closeBlockDurationModal(); }); }
  async function toggleBlockUser(user, currentStatus, blockedUntil) { 
    const isCurrentlyBlocked = currentStatus && blockedUntil && Date.now() < blockedUntil;
    if (isCurrentlyBlocked) { 
      const confirmed = await customConfirm(user + " engelini kaldırmak istiyor musunuz?"); 
      if(confirmed) db.ref('users/' + user).update({ blocked: false, blockedUntil: null }).then(() => { displayMessage(user + " engeli kaldırıldı."); if(selectedUserForManagement) openUserManagementModal(user); }); 
    } else { 
      openBlockDurationModal(user); 
    } 
  }
  async function approveUser(user) { const confirmed = await customConfirm(user + " kullanıcısını onaylamak istiyor musunuz?"); if(confirmed) { db.ref('users/' + user).update({ approved: true, approvalNotified: false }); displayMessage(`${user} onaylandı.`); } }
  async function denyUser(user, fromPending = false, fromManagementModal = false) {
    const confirmed = await customConfirm(`<b>${user}</b> kullanıcısını silmek istediğinize emin misiniz? Bu işlem, kullanıcıya ait tüm puan, bilet, skor ve istatistikleri kalıcı olarak silecektir!`);
    if (confirmed) {
        // Silinecek tüm verilerin yollarını bir obje içinde topluyoruz.
        const updates = {};

        // 1. Ana kullanıcı verisini silmek için hazırlıyoruz.
        updates[`users/${user}`] = null;

        // 2. Haftalık "Tıkla-Yakala" skor tablosundaki kaydını siliyoruz.
        // Rozetlerin geri gelmesinin ana sebebi bu kaydın kalmasıydı.
        updates[`clickCatchWeeklyScores/${user}`] = null;
        
        // (Gelecekte başka tablolar eklenirse, buraya o tablolardaki silme yolu da eklenebilir)

        // Tüm silme işlemlerini tek seferde ve güvenli bir şekilde yapıyoruz.
        await db.ref().update(updates);

        displayMessage(`${user} kullanıcısı ve ilişkili tüm verileri başarıyla silindi.`);
        
        // Eğer liderlik tablosundaki lider silindiyse, lider değişkenini sıfırla
        if (clickCatchLeader === user) {
            clickCatchLeader = null;
        }

        if (fromManagementModal) {
            closeUserManagementModal();
        }
    }
}

    async function changeAllPoints(add) {
    const amount = parseInt(document.getElementById("globalPoint").value);
    if (isNaN(amount) || amount <= 0) { displayMessage("Geçerli miktar girin."); return; }
    const confirmed = await customConfirm(`Tüm kullanıcılara ${amount} puan ${add ? 'eklemek' : 'silmek'} istediğinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let balance = child.val().balance || 0;
                    let highestBalanceEver = child.val().highestBalanceEver || 0;
                    balance = add ? balance + amount : Math.max(balance - amount, 0);
                    if (balance > highestBalanceEver) highestBalanceEver = balance;
                    updates['users/' + child.key + '/balance'] = balance;
                    updates['users/' + child.key + '/highestBalanceEver'] = highestBalanceEver;
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("Tüm kullanıcılara puan işlemi başarıyla uygulandı.");
                // YENİ EKLENEN KOD BAŞLANGICI
                const actionText = add ? 'ekledi' : 'çıkardı';
                const notificationMessage = `Admin, tüm kullanıcılara ${amount} Puan ${actionText}.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                // YENİ EKLENEN KOD SONU
            });
        });
    }
}
    
  async function changeAllBoxRights(add) {
    const amount = parseInt(document.getElementById("globalBoxRight").value);
    if (isNaN(amount) || amount <= 0) { displayMessage("Geçerli miktar girin."); return; }
    const confirmed = await customConfirm(`Tüm kullanıcılara ${amount} kutu hakkı ${add ? 'eklemek' : 'silmek'} istediğinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let kutuHakki = child.val().kutuHakki || 0;
                    kutuHakki = add ? kutuHakki + amount : Math.max(kutuHakki - amount, 0);
                    updates['users/' + child.key + '/kutuHakki'] = kutuHakki;
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("Tüm kullanıcılara kutu hakkı işlemi başarıyla uygulandı.");
                // YENİ EKLENEN KOD BAŞLANGICI
                const actionText = add ? 'verdi' : 'sildi';
                const notificationMessage = `Admin, tüm kullanıcılara ${amount} Kutu Hakkı ${actionText}.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                // YENİ EKLENEN KOD SONU
            });
        });
    }
}
    
async function changeAllShields(add) {
    const amount = parseInt(document.getElementById("globalShield").value);
    if (isNaN(amount) || amount <= 0) { displayMessage("Geçerli bir kalkan miktarı girin."); return; }
    const confirmed = await customConfirm(`Tüm kullanıcılara ${amount} adet İflas Kalkanı ${add ? 'eklemek' : 'silmek'} istediğinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let currentShields = child.val().iflasShieldUses || 0;
                    currentShields = add ? currentShields + amount : Math.max(0, currentShields - amount);
                    updates['users/' + child.key + '/iflasShieldUses'] = currentShields;
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("Tüm kullanıcılara kalkan işlemi başarıyla uygulandı.");
                // YENİ EKLENEN KOD BAŞLANGICI
                const actionText = add ? 'gönderdi' : 'sildi';
                const notificationMessage = `Admin, tüm kullanıcılara ${amount} İflas Kalkanı ${actionText}.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                // YENİ EKLENEN KOD SONU
            });
        });
    }
}
    
async function changeAllWheelTickets(add) {
    const amount = parseInt(document.getElementById("globalWheelTicket").value);
    if (isNaN(amount) || amount <= 0) { displayMessage("Geçerli bir bilet miktarı girin."); return; }
    const confirmed = await customConfirm(`Tüm kullanıcılara ${amount} adet Çark Bileti ${add ? 'eklemek' : 'silmek'} istediğinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let currentTickets = child.val().carkBileti || 0;
                    currentTickets = add ? currentTickets + amount : Math.max(0, currentTickets - amount);
                    updates['users/' + child.key + '/carkBileti'] = currentTickets;
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("Tüm kullanıcılara Çark Bileti işlemi başarıyla uygulandı.");
                // YENİ EKLENEN KOD BAŞLANGICI
                const actionText = add ? 'gönderdi' : 'sildi';
                const notificationMessage = `Admin, tüm kullanıcılara ${amount} Çark Bileti ${actionText}.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                // YENİ EKLENEN KOD SONU
            });
        });
    }
}
    
async function setAllMultipliers() {
    const multiplier = parseInt(document.getElementById("globalMultiplier").value);
    const uses = parseInt(document.getElementById("globalMultiplierUses").value);
    if (isNaN(multiplier) || multiplier < 2) { displayMessage("Geçerli bir çarpan değeri girin (en az 2)."); return; }
    if (isNaN(uses) || uses <= 0) { displayMessage("Geçerli bir kullanım sayısı girin."); return; }
    const confirmed = await customConfirm(`Tüm kullanıcılara ${multiplier}x çarpanı ${uses} kullanım hakkı ile uygulamak istediğinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    const userPath = 'users/' + child.key;
                    updates[userPath + '/activeMultiplier'] = multiplier;
                    updates[userPath + '/multiplierRemainingUses'] = uses;
                    updates[userPath + '/multiplierSource'] = 'store';
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("Tüm kullanıcılara çarpan işlemi başarıyla uygulandı.");
                // YENİ EKLENEN KOD BAŞLANGICI
                const notificationMessage = `Admin, tüm kullanıcılara ${uses} kullanımlık ${multiplier}x Çarpan verdi.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                // YENİ EKLENEN KOD SONU
            });
        });
    }
}
    
async function clearAllMultipliers() {
    const confirmed = await customConfirm("Tüm kullanıcıların aktif çarpanlarını sıfırlamak istediğinizden emin misiniz? Bu işlem geri alınamaz.");
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    const userPath = 'users/' + child.key;
                    updates[userPath + '/activeMultiplier'] = 1;
                    updates[userPath + '/multiplierRemainingUses'] = 0;
                    updates[userPath + '/multiplierSource'] = 'none';
                    updates[userPath + '/activeStoreMultiplierItemId'] = null;
                }
            });
            db.ref().update(updates).then(() => {
                displayMessage("Tüm kullanıcıların çarpanları başarıyla sıfırlandı.");
                const notificationMessage = `Admin, tüm kullanıcıların aktif çarpanlarını sıfırladı.`;
                db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
            });
        });
    }
}
  async function resetUser(username) {
    const confirmed = await customConfirm(`<b>${username}</b> kullanıcısını sıfırlamak istediğinize emin misiniz? Bu işlem kullanıcının puanlarını, biletlerini ve istatistiklerini sıfırlar!`);
    if (!confirmed) return;

    const updates = {};
    const userRefPath = `users/${username}`;
    
    // Temel verileri sıfırla
    updates[`${userRefPath}/balance`] = 0;
    updates[`${userRefPath}/highestBalanceEver`] = 0;
    updates[`${userRefPath}/totalSpentPoints`] = 0;
    updates[`${userRefPath}/kutuHakki`] = 0;
    updates[`${userRefPath}/carkBileti`] = 0;
    updates[`${userRefPath}/clickCatchTickets`] = 0; // Tıkla-yakala bileti de sıfırlanıyor
    updates[`${userRefPath}/clickCatchHighestScore`] = 0;
    updates[`${userRefPath}/iflasShieldUses`] = 0;
    
    // Çarpanı sıfırla
    updates[`${userRefPath}/activeMultiplier`] = 1;
    updates[`${userRefPath}/multiplierSource`] = 'none';
    updates[`${userRefPath}/multiplierRemainingUses`] = 0;
    updates[`${userRefPath}/activeStoreMultiplierItemId`] = null;

    // İstatistikleri sıfırla
    updates[`${userRefPath}/boxesOpenedCount`] = 0;
    updates[`${userRefPath}/surpriseBoxesOpened`] = 0;
    updates[`${userRefPath}/iflasCount`] = 0;
    updates[`${userRefPath}/iflasShieldUsedCount`] = 0;
    updates[`${userRefPath}/multiplierFoundCount`] = 0;
    updates[`${userRefPath}/storePurchasesCount`] = 0;

    // Diğer durumları sıfırla
    updates[`${userRefPath}/dailyRewardsClaimed`] = null;
    
    await db.ref().update(updates);
    displayMessage(`${username} kullanıcısı başarıyla sıfırlandı.`);
    
    // Eğer o an yönetiliyorsa modalı yenile
    if (selectedUserForManagement === username) {
        openUserManagementModal(username);
    }
}

    // YENİ AVATAR SİLME FONKSİYONU
async function deleteUserAvatar(username, avatarId) {
    if (!isAdmin) return;

    const confirmed = await customConfirm(`<b>${username}</b> adlı kullanıcının bu avatarını kalıcı olarak silmek istediğinize emin misiniz?`);
    if (!confirmed) return;

    try {
        const userRef = db.ref(`users/${username}`);
        const userSnap = await userRef.once('value');
        const userData = userSnap.val();

        // Silme işlemleri için bir güncelleme objesi hazırlıyoruz
        const updates = {};
        updates[`/users/${username}/avatars/${avatarId}`] = null; // Avatarı koleksiyondan sil

        // Eğer silinen avatar, kullanıcının o an seçtiği avatarsa, seçili avatarı da sıfırla
        if (userData.selectedAvatar && userData.selectedAvatar.id === avatarId) {
            updates[`/users/${username}/selectedAvatar`] = null;
        }

        // Tüm güncellemeleri tek seferde yap
        await db.ref().update(updates);

        displayMessage("Avatar başarıyla kullanıcıdan silindi.");
        
        // Yönetim penceresini güncel bilgilerle yeniden açarak anında değişikliği göster
        openUserManagementModal(username);

    } catch (error) {
        console.error("Avatar silinirken hata oluştu:", error);
        displayMessage("Avatar silinirken bir hata meydana geldi.");
    }
}
  // Kutu işlemleri
  async function createBoxes() {
    // 1. Veritabanından özel kutu ayarlarını çek
    const settingsRef = db.ref('gameConfig/boxContents');
    const snapshot = await settingsRef.once('value');
    
    // 2. Eğer veritabanında ayar yoksa, kodun en başındaki global BOX_CONTENTS listesini kullan.
    const currentBoxConfig = snapshot.exists() ? snapshot.val() : BOX_CONTENTS;

    // 3. Ayarlara göre kutu içeriğini oluştur
    boxes = []; 
    let allContents = []; 
    currentBoxConfig.forEach(item => { 
        for (let i = 0; i < item.count; i++) { 
            allContents.push({ type: item.type, value: item.value || 0 }); 
        } 
    }); 
    
    // 4. Kutu içeriğini karıştır
    for (let i = allContents.length - 1; i > 0; i--) { 
        const j = Math.floor(Math.random() * (i + 1)); 
        [allContents[i], allContents[j]] = [allContents[j], allContents[i]]; 
    } 
    
    // 5. Karıştırılmış içerikle yeni kutu listesini oluştur
    const TOTAL_BOXES = allContents.length;
    for (let i = 0; i < TOTAL_BOXES; i++) { 
        boxes.push({ 
            id: i + 1, 
            content: allContents[i].type, 
            value: allContents[i].value, 
            opened: false, 
            opener: '' 
        }); 
    } 
    
    // 6. Yeni kutu listesini veritabanına yaz
    db.ref('boxes').set(boxes); 
    db.ref('gameStats/boxesOpenedByUsers').remove(); 
}
  
  function loadBoxes() {
    const ref = db.ref('boxes');
    const callback = snap => {
        if (!snap.exists()) {
            createBoxes();
        } else {
            boxes = snap.val();
            renderBoxes();
        }
    };
    activeListeners.boxes = { ref, event: 'value', callback };
    ref.on('value', callback);
  }
  
  function renderBoxes() { 
      const container = document.getElementById("boxContainer"); 
      container.innerHTML = ''; 
      boxes.forEach((box, i) => { 
          let div = document.createElement('div'); 
          div.className = `box bg-gray-700 border-2 border-red-700 aspect-square flex flex-col items-center justify-center cursor-pointer font-bold text-lg rounded-lg relative transition-all duration-200 shadow-md hover:shadow-lg ${box.opened ? 'opened bg-gray-600 cursor-default border-gray-500 shadow-inner' : ''}`; 
          let displayContent = `<span class="text-gray-300">${box.id}</span>`; 
          if (box.opened) { 
              if (box.content === 'points') { 
                  // Düzeltme: finalPoints varsa onu, yoksa value'yu göster
                  displayContent = `<span class="text-green-400 text-xl">+${box.finalPoints || box.value}</span>`; 
                  div.classList.add('bg-green-700', 'border-green-500', 'animate-pulse'); 
              } else if (box.content === 'surpriz') { 
                  displayContent = `<span class="text-yellow-400 text-2xl"> 🎉</span>`; 
                  div.classList.add('bg-yellow-700', 'border-yellow-500', 'animate-pulse'); 
              } else if (box.content === 'iflas') { 
                  displayContent = `<span class="text-red-400 text-2xl">💣</span>`; 
                  div.classList.add('bg-red-700', 'border-red-500'); 
              } else if (box.content === 'multiplier') { 
                  displayContent = `<span class="text-blue-400 text-xl">${box.value}X</span>`; 
                  div.classList.add('bg-blue-700', 'border-blue-500', 'animate-pulse'); 
              } 
              // YENİ EKLENECEK KOD BAŞLANGICI
              else if (box.content === 'wheelTicket') {
                  displayContent = `<span class="text-pink-400 text-2xl">🎫️</span>`; 
                  div.classList.add('bg-pink-700', 'border-pink-500', 'animate-pulse'); 
              } else if (box.content === 'clickCatchTicket') {
                  displayContent = `<span class="text-orange-400 text-2xl">🎟️</span>`; 
                  div.classList.add('bg-orange-700', 'border-orange-500', 'animate-pulse');
              }
              else if (box.content === 'iflasShield') {
                  displayContent = `<span class="text-cyan-400 text-2xl">🛡️</span>`; 
                  div.classList.add('bg-cyan-700', 'border-cyan-500', 'animate-pulse');
              }
            
              // YENİ EKLENEN KOD SONU
              if (box.opener) {
                  let openerDiv = document.createElement('div'); 
                  openerDiv.className = 'opener absolute bottom-1 left-0 right-0 text-center text-xs text-gray-400 truncate px-1'; 
                  openerDiv.textContent = box.opener; 
                  div.appendChild(openerDiv); 
              }

              // --- EKSİK OLAN ÇARPAN İKONU KODU BURAYA EKLENDİ --- //
              if (box.multiplierApplied && box.multiplierApplied > 1) {
                  let multiplierIcon = document.createElement('div');
                  multiplierIcon.className = 'absolute top-0 right-1 text-yellow-300 font-bold text-xs bg-black bg-opacity-50 px-1 rounded-bl';
                  multiplierIcon.textContent = `✖️${box.multiplierApplied}`;
                  multiplierIcon.title = `Bu kutu ${box.multiplierApplied}x çarpan ile açıldı.`;
                  div.appendChild(multiplierIcon);
              }
              // --- YENİ KOD SONU --- //
          } 
          div.innerHTML += displayContent; 
          div.onclick = () => { 
              if (box.opened) { 
                  showOpenedBoxInfo(box); 
              } else { 
                  openBox(i); 
              } 
          }; 
          container.appendChild(div); 
      }); 
  }

// MEVCUT openBox FONKSİYONUNU SİL VE BUNUNLA DEĞİŞTİR
async function openBox(index) {
    if (isGameLocked) {
        displayMessage("Başka bir kullanıcı şu anda bir kutu açıyor. Lütfen 3 saniye sonra tekrar deneyin.");
        return;
    }
    if (boxes[index].opened) return;
    if (isAdmin) {
        displayMessage("Adminler oyun oynamaz, sadece izler.");
        return;
    }

    const userRef = db.ref('users/' + currentUser);
    let userSnap = await userRef.once('value');
    let user = userSnap.val();

    if (!user) { displayMessage("Kullanıcı verisi bulunamadı."); return; }

    const isCurrentlyBlocked = user.blocked && user.blockedUntil && Date.now() < user.blockedUntil;
    if (isCurrentlyBlocked) {
        displayBlockedMessage(user.blockedUntil, currentUser);
        return;
    }
    if ((user.kutuHakki || 0) < BOX_RIGHTS_COST_PER_BOX) {
        displayMessage("Yetersiz kutu hakkı.");
        return;
    }

    const initialConfirm = await customConfirm(`<b>${boxes[index].id}</b> numaralı kutuyu açmak istediğinize emin misiniz?`);
    if (!initialConfirm) return;

    const boxRef = db.ref('boxes/' + index);
    let latestBoxSnap = await boxRef.once('value');
    if (latestBoxSnap.val().opened) {
        displayMessage(`Seçtiğiniz kutu <b>${latestBoxSnap.val().opener}</b> tarafından açıldı. Geç kaldınız!`);
        return;
    }
    userSnap = await userRef.once('value');
    user = userSnap.val();

    let finalMultiplier = 1;
    let useMultiplier = false;
    const originalMultiplierSource = user.multiplierSource || 'none';

    if (user.multiplierSource === 'box') {
        finalMultiplier = user.activeMultiplier;
        useMultiplier = true;
    } else if (user.multiplierSource === 'store' && (user.multiplierRemainingUses || 0) > 0) {
        const confirmed = await customConfirm(`Mevcut <b>${user.activeMultiplier}x</b> çarpanınızı kullanmak ister misiniz?`);
        if (confirmed) {
            latestBoxSnap = await boxRef.once('value');
            if (latestBoxSnap.val().opened) {
                displayMessage(`Siz çarpanı onaylayana kadar bu kutu <b>${latestBoxSnap.val().opener}</b> tarafından açıldı. Haklarınız ve çarpanınız kullanılmadı.`);
                return;
            }
            finalMultiplier = user.activeMultiplier;
            useMultiplier = true;
        }
    }

    const statsRef = db.ref(`gameStats/boxesOpenedByUsers/${currentUser}`);
    await statsRef.transaction(currentValue => {
        return (currentValue || 0) + 1;
    });

    const box = boxes[index];
    let message = '';
    const updates = {};
    updates['kutuHakki'] = (user.kutuHakki || 0) - BOX_RIGHTS_COST_PER_BOX;
    updates['boxesOpenedCount'] = (user.boxesOpenedCount || 0) + 1;

    const boxUpdate = { opened: true, opener: currentUser, id: box.id, content: box.content, value: box.value };
    const boxOpenInfo = { boxId: box.id, opener: currentUser, content: box.content, value: box.value, timestamp: firebase.database.ServerValue.TIMESTAMP };

    if (finalMultiplier > 1) {
        boxUpdate.multiplierApplied = finalMultiplier;
        boxOpenInfo.multiplierUsed = finalMultiplier;
    }
    
    if (box.content === 'multiplier') {
        updates['multiplierFoundCount'] = (user.multiplierFoundCount || 0) + 1;
        
        if (user.multiplierSource && user.multiplierSource !== 'none') {
            if (box.value === user.activeMultiplier) {
                updates['multiplierRemainingUses'] = (user.multiplierRemainingUses || 0) + 1;
                message = `Tebrikler! Mevcut <b>${user.activeMultiplier}x</b> çarpanınla aynı türde bir çarpan daha buldun. Kullanım hakkın <b>+1</b> arttı!`;
                logActivity('multiplierStacked', currentUser, { value: user.activeMultiplier, uses: 1 });
            } 
            else if (box.value > user.activeMultiplier) {
                const kutuHakkiDonusum = user.multiplierRemainingUses || 0;
                updates['kutuHakki'] = (updates['kutuHakki'] || user.kutuHakki) + kutuHakkiDonusum;
                updates['activeMultiplier'] = box.value;
                updates['multiplierSource'] = 'box';
                updates['multiplierRemainingUses'] = 0;
                message = `İNANILMAZ! Mevcut ${user.activeMultiplier}x çarpanın, kutudan çıkan daha güçlü <b>${box.value}x çarpan</b> ile değiştirildi. Eski çarpanının kalan ${user.multiplierRemainingUses} hakkı, envanterine <b>+${kutuHakkiDonusum} Kutu Hakkı</b> olarak eklendi!`;
                logActivity('multiplierUpgraded', currentUser, { 
                    oldValue: user.activeMultiplier, 
                    newValue: box.value, 
                    boxRights: kutuHakkiDonusum 
                });
            }
            else {
                message = `Kutudan ${box.value}x çarpan buldun ama mevcut <b>${user.activeMultiplier}x çarpanın</b> daha güçlü olduğu için korundu.`;
                logActivity('multiplierDiscarded', currentUser, { discardedValue: box.value, keptValue: user.activeMultiplier });
            }

        } else {
            message = `Tebrikler! <b>${box.value}x Çarpan</b> buldun! Bu çarpan, bir sonraki kutu açılışında otomatik olarak kullanılacak.`;
            updates['activeMultiplier'] = box.value;
            updates['multiplierSource'] = 'box';
            logActivity('multiplierFound', currentUser, { boxId: box.id, value: box.value });
        }
    }
    else {
        if (useMultiplier && box.content !== 'surpriz') {
            if (originalMultiplierSource === 'box') {
                updates['activeMultiplier'] = 1;
                updates['multiplierSource'] = 'none';
            } else if (originalMultiplierSource === 'store') {
                updates['multiplierRemainingUses'] = (user.multiplierRemainingUses || 0) - 1;
                if (updates['multiplierRemainingUses'] <= 0) {
                    updates['multiplierSource'] = 'none';
                    updates['activeStoreMultiplierItemId'] = null;
                }
            }
        }

        if (box.content === 'points') {
            const pointsGained = box.value * finalMultiplier;
            updates['balance'] = (user.balance || 0) + pointsGained;
            if (updates['balance'] > (user.highestBalanceEver || 0)) updates['highestBalanceEver'] = updates['balance'];
            message = `+${pointsGained} puan kazandınız!`;
            boxUpdate.basePoints = box.value;
            boxUpdate.finalPoints = pointsGained;
            boxOpenInfo.basePoints = box.value;
            boxOpenInfo.finalPoints = pointsGained;
            logActivity('openBox', currentUser, { 
                boxId: box.id, 
                points: pointsGained, 
                multiplier: finalMultiplier, 
                newBalance: updates['balance'] 
            });
        }
        else if (box.content === 'iflas') {
            let shieldWasUsed = false;
            const lostPoints = user.balance || 0;
            updates['iflasCount'] = (user.iflasCount || 0) + 1;
            if ((user.iflasShieldUses || 0) > 0) {
                updates['iflasShieldUses'] = (user.iflasShieldUses || 0) - 1;
                updates['iflasShieldUsedCount'] = (user.iflasShieldUsedCount || 0) + 1; 
                shieldWasUsed = true;
                message = `İflas! 🛡️ Kalkanın seni korudu!`;
            } else {
                updates['balance'] = 0;
                message = `İflas! Tüm puanların (${lostPoints} puan) silindi.`;
            }
            boxUpdate.shieldUsed = shieldWasUsed;
            boxUpdate.lostPoints = shieldWasUsed ? 0 : lostPoints;
            boxOpenInfo.shieldUsed = shieldWasUsed;
            boxOpenInfo.lostPoints = shieldWasUsed ? 0 : lostPoints;
            logActivity('iflas', currentUser, { 
                shieldUsed: shieldWasUsed, 
                lostPoints: shieldWasUsed ? 0 : lostPoints, 
                boxId: box.id, 
                multiplier: finalMultiplier,
                newBalance: updates['balance']
            });
        }
        else if (box.content === 'surpriz') {
            updates['surpriseBoxesOpened'] = (user.surpriseBoxesOpened || 0) + 1;
            
            const statsSnap = await db.ref(`gameStats/boxesOpenedByUsers/${currentUser}`).once('value');
            const boxesOpenedThisRound = statsSnap.val() || 0;

            const sessionRef = db.ref('surprise_box_session');
            await sessionRef.set({
                active: true, user: currentUser, boxId: box.id, multiplier: finalMultiplier,
                cards: shuffleArray([...cardValues]), selection: null, result: null,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                boxesOpenedThisRound: boxesOpenedThisRound
            });
            const snap = await sessionRef.once('value');
            await sessionRef.update({ expirationTimestamp: snap.val().timestamp + 60000 });
            openCardSelectionModal(currentUser);
        }
        else {
            const itemsGained = box.value * finalMultiplier;
            const itemNames = { wheelTicket: 'Şans Çarkı Bileti', clickCatchTicket: 'Tıkla-Yakala Bileti', iflasShield: 'İflas Kalkanı' };
            const dbKeys = { wheelTicket: 'carkBileti', clickCatchTicket: 'clickCatchTickets', iflasShield: 'iflasShieldUses' };
            updates[dbKeys[box.content]] = (user[dbKeys[box.content]] || 0) + itemsGained;
            message = `Kutudan <b>+${itemsGained} ${itemNames[box.content]}</b> kazandın!`;

            boxUpdate.baseValue = box.value;
            boxUpdate.finalValue = itemsGained;
            boxOpenInfo.baseValue = box.value;
            boxOpenInfo.finalValue = itemsGained;

            logActivity('newItemFound', currentUser, { itemName: `+${itemsGained} ${itemNames[box.content]}`, itemType: box.content, boxId: box.id, multiplier: finalMultiplier });
        }
    }

    await userRef.update(updates);
    await boxRef.update(boxUpdate);

    if (box.content !== 'surpriz') {
        await db.ref('lastOpenedBox').set(boxOpenInfo);
        displayMessage(message);
    }
    
    await db.ref('gameLock').set(true);
}

  async function revealAll() { const confirmed = await customConfirm("Tüm kutuları açmak istiyor musunuz?"); if(confirmed) { boxes.forEach(b => { if (!b.opened) { b.opened = true; b.opener = 'Admin'; } }); db.ref('boxes').set(boxes).then(() => displayMessage("Tüm kutular başarıyla açıldı.")) } }
  
  async function resetGameBoard() {
      console.log("resetGameBoard fonksiyonu çalıştı! Oyun sıfırlanıyor...");
      await createBoxes();
      // ----- EKLENEN SATIR BURASI -----
      // Oyunu sıfırlarken, "kim kaç kutu açtı" istatistiklerini de temizliyoruz.
      await db.ref('gameStats/boxesOpenedByUsers').remove(); 
      // ---------------------------------
      await db.ref('lastOpenedBox').remove();
      await db.ref('gameLock').set(false);
}

async function handleSurpriseBoxCleanup(sessionData) {
    if (!sessionData) return;

    // --- SÜRPRİZ KUTU DÜZELTMESİ: Kutunun nereden geldiğini kontrol et ---
    if (sessionData.boxId !== 'Çark') {
    }
    
    // Her durumda, sürpriz kutu oturumunu veritabanından temizle.
    await db.ref('surprise_box_session').remove();
}

  async function resetGame() {
      const confirmed = await customConfirm("Oyunu sıfırlamak istiyor musunuz? (Tüm kutular kapatılır, karıştırılır ve kutu açma istatistikleri sıfırlanır)");
      if (confirmed) {
          await resetGameBoard();
          displayMessage("Oyun yöneticisi tarafından sıfırlandı.");
      }
  }

  async function restartSystem() {
    const confirmed = await customConfirm("Sistemi baştan başlatmak istediğinize emin misiniz? Tüm kullanıcı verileri (puan, hak, istatistik) sıfırlanacak!");
    if (confirmed) {
        const userSnap = await db.ref('users').once('value');
        const usersData = userSnap.val();
        const updates = {};
        if (usersData) {
            for (const u in usersData) {
                if (u !== "weizendtv") {
                    updates['users/' + u + '/balance'] = 0;
                    updates['users/' + u + '/highestBalanceEver'] = 0;
                    updates['users/' + u + '/totalSpentPoints'] = 0;
                    updates['users/' + u + '/kutuHakki'] = 0;
                    updates['users/' + u + '/carkBileti'] = 0; // YENİ
                    updates['users/' + u + '/clickCatchHighestScore'] = 0; // YENİ
                    updates['users/' + u + '/boxesOpenedCount'] = 0;
                    updates['users/' + u + '/surpriseBoxesOpened'] = 0;
                    updates['users/' + u + '/activeMultiplier'] = 1;
                    updates['users/' + u + '/multiplierSource'] = 'none';
                    updates['users/' + u + '/multiplierRemainingUses'] = 0;
                    updates['users/' + u + '/activeStoreMultiplierItemId'] = null;
                    updates['users/' + u + '/iflasShieldUses'] = 0;
                    updates['users/' + u + '/iflasCount'] = 0;
                    updates['users/' + u + '/iflasShieldUsedCount'] = 0;
                    updates['users/' + u + '/multiplierFoundCount'] = 0;
                    updates['users/' + u + '/storePurchasesCount'] = 0;
                    updates['users/' + u + '/hasReceivedWelcomeGift'] = false;
                    updates['users/' + u + '/approvalNotified'] = null;
                    updates['users/' + u + '/notifications'] = null;
                    updates['users/' + u + '/dailyRewardsClaimed'] = null;
                    updates['users/' + u + '/lastSeenAnnouncementTimestamp'] = null;
                    updates['users/' + u + '/lastSeenGlobalNotifTimestamp'] = null; // YENİ EKLENEN SATIR
                }
            }
            await db.ref().update(updates);
        }
        await createBoxes();
        await db.ref('purchaseHistory').remove();
        await db.ref('pendingSpecialPurchases').remove();
        await db.ref('gameStats').remove();
        await db.ref('announcements').remove();
        await db.ref('dailyRewardOptions').remove();
        await db.ref('gameConfig').remove(); // <-- BU SATIRI EKLE
        displayMessage("Sistem başarıyla baştan başlatıldı!");
    }
  }

  function loadTotalOpenedBoxesCount() {
    const ref = db.ref('boxes');
    const callback = snap => {
        const allBoxes = snap.val();
        let openedCount = 0;
        if (allBoxes) {
            openedCount = allBoxes.filter(box => box.opened).length;
        }
        document.getElementById('totalOpenedBoxesCount').textContent = openedCount;
    };
    activeListeners.totalOpenedBoxes = { ref, event: 'value', callback };
    ref.on('value', callback);
  }
  
  function searchUsers() { const term = document.getElementById("searchUser").value.trim().toLowerCase(); db.ref('users').once('value').then(snap => { const data = snap.val(); let html = ""; for (const u in data) { if (u.toLowerCase().includes(term) && u !== 'weizendtv') { html += `<div class="flex items-center justify-between p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-blue-500 cursor-pointer" onclick="openUserManagementModal('${u}')"><span>${u}</span></div>`; } } document.getElementById("allUsers").innerHTML = html || "Kullanıcı bulunamadı."; }); }
  
  function displayBlockedMessage(blockedUntil, username) {
      blockedMessageModal.style.display = 'flex';
      document.getElementById('blockedReason').textContent = "Hesabınız geçici olarak engellendi. Süre dolduğunda devam edebilirsiniz.";
      
      if(countdownInterval) clearInterval(countdownInterval);

      const updateCountdown = () => {
          const timeLeft = blockedUntil - Date.now();
          if (timeLeft <= 0) {
              document.getElementById('blockedCountdown').textContent = "Engel süreniz doldu!";
              clearInterval(countdownInterval);
              setTimeout(() => {
                 blockedMessageModal.style.display = 'none';
                 if (username === currentUser) {
                    db.ref('users/' + username).update({ blocked: false, blockedUntil: null });
                 }
              }, 2000);
              return;
          }
          const minutes = Math.floor(timeLeft / 60000);
          const seconds = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, '0');
          document.getElementById('blockedCountdown').textContent = `Kalan süre: ${minutes}:${seconds}`;
      };
      countdownInterval = setInterval(updateCountdown, 1000);
      updateCountdown();
  }
  
  // YENİ VE GÜNCELLENMİŞ FONKSİYON
function showOpenedBoxInfo(box) {
    let contentDisplay = '';

    const itemNames = {
        wheelTicket: 'Şans Çarkı Bileti',
        clickCatchTicket: 'Tıkla-Yakala Bileti',
        iflasShield: 'İflas Kalkanı'
    };

    if (box.content === 'points') {
        let multiplierText = ` (Çarpan kullanılmadı)`;
        if (box.multiplierUsed && box.multiplierUsed > 1) {
            multiplierText = ` (${box.basePoints} Puan x ${box.multiplierUsed} Çarpan)`;
        }
        contentDisplay = `<b>+${box.finalPoints} Puan</b><br><span class="text-sm text-gray-400">${multiplierText}</span>`;
    } 
    else if (box.content === 'iflas') {
        contentDisplay = box.shieldUsed ? 'İflas (Kalkanla Korundu)' : (box.lostPoints ? `İflas (-${box.lostPoints} Puan)` : 'İflas');
    } 
    else if (box.content === 'multiplier' && box.refundOccurred) {
        contentDisplay = `<b>${box.value}x Çarpan</b><br><span class="text-sm text-blue-300">Bu kutu açılırken ${box.refundedMultiplier}x çarpan hakkı iade edildi.</span>`;
    } 
    else if (box.content === 'multiplier') {
        contentDisplay = `<b>${box.value}X Çarpan</b>`;
    } 
    else if (box.content === 'surpriz') {
        contentDisplay = 'Sürpriz Kutu';
    } 
    else if (itemNames[box.content]) { // Bilet veya Kalkan ise
        const itemName = itemNames[box.content];
        const finalValue = box.finalValue || box.value || 1;
        contentDisplay = `<b>+${finalValue} Adet ${itemName}</b>`;
        if (box.multiplierUsed && box.multiplierUsed > 1) {
            const baseValue = box.baseValue || 1;
            contentDisplay += `<br><span class="text-sm text-gray-400">(${baseValue} Adet x ${box.multiplierUsed} Çarpan)</span>`;
        }
    }

    const contentHtml = `<div class='text-center mb-4'><p class='text-gray-400'>${box.id} Nolu Kutuyu Açan</p><p class='text-2xl font-bold text-green-400 py-2'>${box.opener}</p></div><hr class="border-gray-600 my-3"><p class="text-xl"><b>İçerik:</b> ${contentDisplay}</p>`;
    document.getElementById('openedBoxInfoContent').innerHTML = contentHtml;
    openedBoxInfoModal.style.display = 'flex';
}
  
  function closeOpenedBoxInfoModal() { openedBoxInfoModal.style.display = 'none'; }
  function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
  
  // MEVCUT openCardSelectionModal FONKSİYONUNU BU BLOK İLE DEĞİŞTİRİN
function openCardSelectionModal(userId) {
    if (countdownInterval) clearInterval(countdownInterval);
    cardContainer.innerHTML = '';
    const sessionRef = db.ref('surprise_box_session');

    sessionRef.once('value').then(snap => {
        const sessionData = snap.val();
        if (!sessionData || !sessionData.active || sessionData.result) return;
        
        sessionData.cards.forEach((cardValue, index) => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card bg-gray-700 border-2 border-red-700 rounded-xl w-28 h-40 flex flex-col items-center justify-center font-bold text-2xl cursor-pointer relative';
            cardDiv.dataset.value = cardValue;
            cardDiv.dataset.index = index;
            const cardBack = document.createElement('div');
            cardBack.className = 'card-back absolute inset-0 bg-gradient-to-br from-red-700 to-red-900 flex items-center justify-center text-white text-5xl';
            cardBack.textContent = '?';
            cardDiv.appendChild(cardBack);
            const cardFront = document.createElement('div');
            cardFront.className = 'card-front absolute inset-0 bg-gray-900 flex items-center justify-center text-yellow-400 text-3xl';
            cardFront.classList.add('card-value');
            cardDiv.appendChild(cardFront);
            cardDiv.onclick = () => selectCard(cardDiv, userId);
            cardContainer.appendChild(cardDiv);
        });
        cardSelectionModal.style.display = 'flex';

        const countdownEl = document.getElementById('cardSelectionCountdown');
        let timeLeft = Math.round((sessionData.expirationTimestamp - getSyncedTime()) / 1000);

        const handleTimeout = () => {
            clearInterval(countdownInterval);
            closeCardSelectionModal();
            if (sessionData) {
                logActivity('surpriseBoxTimeout', sessionData.user, { boxId: sessionData.boxId });

                // --- YENİ EKLENEN KISIM BAŞLANGICI ---
                // Kullanıcı kart seçmedi, bu bilgiyi veritabanına yazıyoruz.
                const surpriseInfoOnTimeout = {
                    finder: sessionData.user,
                    boxId: sessionData.boxId,
                    points: 0,
                    multiplier: sessionData.multiplier,
                    timedOut: true, // Zaman aşımına uğradı
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                db.ref('gameStats/lastSurpriseInfo').set(surpriseInfoOnTimeout);
                // --- YENİ EKLENEN KISIM SONU ---

                handleSurpriseBoxCleanup(sessionData);
            } else {
                sessionRef.remove();
            }
        };

        if (timeLeft <= 0) {
            countdownEl.textContent = '0';
            handleTimeout();
            return;
        }

        countdownEl.textContent = timeLeft;
        countdownInterval = setInterval(() => {
            timeLeft--;
            countdownEl.textContent = timeLeft;
            if (timeLeft <= 0) {
                handleTimeout();
            }
        }, 1000);
    });
}

// MEVCUT selectCard FONKSİYONUNU SİLİP BUNUNLA DEĞİŞTİRİN

async function selectCard(selectedCardDiv, userId) { 
    if (countdownInterval) clearInterval(countdownInterval);
    if (selectedCardDiv.classList.contains('opened')) return; 

    const cardIndex = selectedCardDiv.dataset.index;
    const sessionRef = db.ref('surprise_box_session');
    
    await sessionRef.child('selection').set({ user: userId, cardIndex: cardIndex });

    const snap = await sessionRef.once('value');
    const sessionData = snap.val();
    let points = parseInt(selectedCardDiv.dataset.value) * sessionData.multiplier;
    
    const userRef = db.ref('users/' + userId); 
    const userSnap = await userRef.once('value'); 
    let user = userSnap.val(); 
    let newBalance = 0;
    if (user) { 
      newBalance = (user.balance || 0) + points; 
      let newHighest = user.highestBalanceEver || 0;
      if (newBalance > newHighest) newHighest = newBalance; 
      await userRef.update({ balance: newBalance, highestBalanceEver: newHighest }); 
    } 

    // --- DEĞİŞİKLİK: Sonucu ve yeni bakiyeyi birlikte kaydediyoruz ---
    await sessionRef.child('result').set({ points: points, newBalance: newBalance });
}

// MEVCUT listenForSurpriseBox FONKSİYONUNU SİL VE BUNUNLA DEĞİŞTİR

let isProcessingSurpriseResult = false;
let spectatorViewingResult = false;

function listenForSurpriseBox() {
    const sessionRef = db.ref('surprise_box_session');
    
    if (activeListeners.surpriseBox) {
        activeListeners.surpriseBox.ref.off(activeListeners.surpriseBox.event, activeListeners.surpriseBox.callback);
    }

    const callback = snap => {
        const sessionData = snap.val();

        if (sessionData && sessionData.active && !sessionData.result) {
            const sessionAge = getSyncedTime() - sessionData.timestamp;
            if (sessionAge > 70000) {
                console.log("Zaman aşımına uğramış Sürpriz Kutu oturumu tespit edildi ve temizleniyor...");
                sessionRef.remove();
                return; 
            }
        }

        if (sessionData && sessionData.active) {
            if (sessionData.user === currentUser && !sessionData.result && cardSelectionModal.style.display !== 'flex') {
                openCardSelectionModal(currentUser);
            }
            
            if (sessionData.selection && sessionData.result && spectatorModal.style.display === 'flex') {
                updateSpectatorView(sessionData);
            }

            if (sessionData.user !== currentUser && !sessionData.result && sessionData.expirationTimestamp && spectatorModal.style.display !== 'flex' && !isProcessingSurpriseResult) {
                openSpectatorModal(sessionData);
            }

            if (sessionData.result && !sessionData.logged && !isProcessingSurpriseResult) {
                isProcessingSurpriseResult = true; 

                sessionRef.transaction(currentData => {
                    if (currentData && currentData.result && !currentData.logged) {
                        currentData.logged = true; 
                        return currentData;
                    }
                    return; 
                }, (error, committed, snapshot) => {
                    if (error) {
                        console.error('Sürpriz kutu işlemi sırasında transaction hatası: ', error);
                        isProcessingSurpriseResult = false;
                    } else if (committed) {
                        const finalSessionData = snapshot.val();

                        // --- YENİ EKLENEN KONTROL BAŞLANGICI ---
                        // Sadece kutudan geldiyse özel paneli tetikle ve sıfırlama moduna geç.
                        if (finalSessionData.boxId !== 'Çark') {
                            const surpriseInfo = {
                                finder: finalSessionData.user,
                                boxId: finalSessionData.boxId,
                                points: finalSessionData.result.points,
                                newBalance: finalSessionData.result.newBalance,
                                boxesOpenedThisRound: finalSessionData.boxesOpenedThisRound || null,
                                resettledBy: null,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            };
                            db.ref('gameStats/lastSurpriseInfo').set(surpriseInfo);
                        }
                        // --- YENİ EKLENEN KONTROL SONU ---
                        
                        // Bu log her durumda çalışır, böylece eylem panelinde her zaman görünür.
                        logActivity('surpriseBox', finalSessionData.user, { 
                            boxId: finalSessionData.boxId,
                            points: finalSessionData.result.points, 
                            multiplier: finalSessionData.multiplier,
                            newBalance: finalSessionData.result.newBalance
                        });
                        
                        if (finalSessionData.user === currentUser) {
                            closeCardSelectionModal();
                            displayMessage(`Sürpriz kutudan tebrikler! Toplam ${finalSessionData.result.points} puan kazandınız!`);
                        } else {
                            showGlobalSurpriseBoxNotification(finalSessionData);
                        }
                        
                        setTimeout(() => {
                            closeGlobalSurpriseBoxModal(); 
                            handleSurpriseBoxCleanup(finalSessionData);
                            isProcessingSurpriseResult = false;
                        }, 4000);
                    } else {
                        isProcessingSurpriseResult = false;
                    }
                });
            }
        } else {
            if (!spectatorViewingResult) {
                closeSpectatorModal();
            }
        }
    };

    activeListeners.surpriseBox = { ref: sessionRef, event: 'value', callback };
    sessionRef.on('value', callback);
}

  function closeCardSelectionModal() { 
    cardSelectionModal.style.display = 'none'; 
  }
  
  const storeItemsRef = db.ref('storeItems');

  function openNewItemForm() {
    resetStoreItemForm();
    openAdminStoreModal();
  }

  function openAdminStoreModal() {
    document.getElementById('gameDiv').classList.add('modal-is-open');
    adminStoreModal.style.display = 'flex';
  }

  // Bu fonksiyon, "Ürün Ekle / Düzenle" panelini kapatır.
function closeAdminStoreModal() {
    document.getElementById('gameDiv').classList.remove('modal-is-open');
    adminStoreModal.style.display = 'none';
    resetStoreItemForm();
}
  
  function loadStoreItems() {
    const ref = storeItemsRef;
    const callback = snap => {
        const items = snap.val();
        renderStoreItems(items);
    };
    activeListeners.storeItems = { ref, event: 'value', callback };
    ref.on('value', callback);
  }
  
  function updateStoreCountdowns() {
      const now = Date.now();
      for (const itemId in activeStoreCountdowns) {
          const { endTime } = activeStoreCountdowns[itemId];
          const countdownEl = document.getElementById(`countdown-${itemId}`);
          const buyButton = document.getElementById(`buy-btn-${itemId}`);
          
          if (!countdownEl) continue;

          const timeLeft = endTime - now;

          if (timeLeft > 0) {
              const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
              const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
              const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
              const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
              
              let parts = [];
              if (days > 0) parts.push(`${days}g`);
              if (hours > 0) parts.push(`${hours}sa`);
              if (minutes > 0) parts.push(`${minutes}d`);
              if (seconds >= 0) parts.push(`${seconds}sn`);
              
              const timeString = parts.join(' ');

              countdownEl.innerHTML = `Kalan Süre: <b class="text-white">${timeString}</b>`;
          } else {
              countdownEl.innerHTML = `<span class="text-red-500 font-bold">Süre Doldu</span>`;
              if (buyButton) {
                  buyButton.disabled = true;
                  buyButton.classList.add('bg-gray-600', 'cursor-not-allowed');
                  buyButton.classList.remove('bg-red-700', 'hover:bg-red-600');
              }
              delete activeStoreCountdowns[itemId];
          }
      }
  }

  // DEĞİŞTİRİLECEK FONKSİYON
function renderStoreItems(items) { 
    const gameContainer = document.getElementById('gameStoreItemsContainer');
    const specialContainer = document.getElementById('specialStoreItemsContainer');
    gameContainer.innerHTML = '';
    specialContainer.innerHTML = '';

    if (storeCountdownInterval) clearInterval(storeCountdownInterval);
    activeStoreCountdowns = {};

    if (!items) {
        const placeholder = '<p class="text-center col-span-full text-gray-400">Mağazada şu an ürün bulunmamaktadır.</p>';
        gameContainer.innerHTML = placeholder;
        specialContainer.innerHTML = placeholder;
        return;
    }
    
    // Ürünleri önce kategoriye ayır, sonra sırala
    let allItemsArray = Object.entries(items);
    let gameItems = allItemsArray
        .filter(([, item]) => item.type !== 'special')
        .sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

    let specialItems = allItemsArray
        .filter(([, item]) => item.type === 'special')
        .sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

    let bestSellerGameItemId = null;
    if (gameItems.length > 0) {
      const sortedByPurchase = [...gameItems].sort(([,a], [,b]) => (b.purchaseCount || 0) - (a.purchaseCount || 0));
      if((sortedByPurchase[0][1].purchaseCount || 0) > 0) {
        bestSellerGameItemId = sortedByPurchase[0][0];
      }
    }

    let bestSellerSpecialItemId = null;
    if (specialItems.length > 0) {
      const sortedByPurchase = [...specialItems].sort(([,a], [,b]) => (b.purchaseCount || 0) - (a.purchaseCount || 0));
      if((sortedByPurchase[0][1].purchaseCount || 0) > 0) {
        bestSellerSpecialItemId = sortedByPurchase[0][0];
      }
    }

    const renderItem = (itemData, container) => {
        const [itemId, item] = itemData; // itemID ve item objesini ayır
        const isSpecial = item.type === 'special';
        const list = isSpecial ? specialItems : gameItems;
        const index = list.findIndex(([id]) => id === itemId); // Kendi listesindeki index'i bul
        const isBestSeller = isSpecial ? itemId === bestSellerSpecialItemId : itemId === bestSellerGameItemId;

        const outOfStock = item.stock !== undefined && item.stock <= 0;
        let isExpired = false;
        let countdownHtml = '';
        
        let adminControlsHtml = '';
        if(isAdmin){
          const leftArrowDisabled = index === 0 ? 'disabled' : '';
          const rightArrowDisabled = index === list.length - 1 ? 'disabled' : '';
          adminControlsHtml = `
            <div class="admin-controls absolute top-0 right-0 p-1 bg-gray-900 bg-opacity-70 rounded-bl-lg flex gap-1 z-10">
                <button onclick="reorderStoreItem('${itemId}', ${index - 1})" ${leftArrowDisabled} title="Sola Taşı" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/></svg>
                </button>
                <button onclick="editStoreItem('${itemId}')" title="Düzenle" class="p-1 rounded-full hover:bg-gray-700">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a1 1 0 011-1h2.586l-2 2H6v3h3v-1.586l2-2H13a1 1 0 011 1v5a1 1 0 01-1 1H6a1 1 0 01-1-1v-2z"/></svg>
                </button>
                 <button onclick="deleteStoreItem('${itemId}')" title="Sil" class="p-1 rounded-full hover:bg-gray-700">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"/></svg>
                </button>
                <button onclick="reorderStoreItem('${itemId}', ${index + 1})" ${rightArrowDisabled} title="Sağa Taşı" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>
                </button>
            </div>`;
        }

        if (item.countdownDurationMinutes && item.createdAt) {
            const endTime = item.createdAt + item.countdownDurationMinutes * 60 * 1000;
            if (Date.now() > endTime) {
                isExpired = true;
            } else {
                activeStoreCountdowns[itemId] = { endTime: endTime };
                countdownHtml = `<div id="countdown-${itemId}" class="text-sm text-yellow-300 font-bold mb-2 h-5"></div>`;
            }
        } else {
            countdownHtml = `<div class="h-5 mb-2"></div>`;
        }

        const disabled = outOfStock || isExpired;
        
        const popularityHtml = `<p class="text-blue-300 text-sm mb-2">🔥 ${item.purchaseCount || 0} kez satın alındı</p>`;
        const bestSellerBadge = isBestSeller ? `<span class="best-seller-badge absolute top-2 left-2 bg-yellow-500 text-gray-900 text-xs font-bold px-2 py-1 rounded-full z-10">ÇOK SATAN</span>` : '';
        const cardClass = isBestSeller ? 'glowing-border' : 'border-red-700';

        const cardDiv = document.createElement('div');
        cardDiv.className = `relative bg-gray-800 p-6 rounded-xl shadow-lg border-2 ${cardClass} text-center flex flex-col justify-between`;
        cardDiv.innerHTML = `
            ${adminControlsHtml}
            ${bestSellerBadge}
            <div class="flex-grow">
              <img src="${item.imageUrl || 'https://via.placeholder.com/150'}" alt="${item.name}" class="w-24 h-24 mx-auto mb-4 rounded-lg object-cover">
              <h4 class="text-yellow-400 text-xl font-bold">${item.name}</h4>
              <p class="text-gray-300 mb-2 flex-grow">${item.description}</p>
            </div>
            <div>
              ${countdownHtml}
              ${popularityHtml}
              <p class="text-gray-400 text-sm mb-2">Stok: ${item.stock !== undefined && item.stock !== null ? item.stock : 'Sınırsız'}</p>
              <p class="text-green-400 text-2xl font-bold mb-4">${item.cost} Puan</p>
              <button id="buy-btn-${itemId}" onclick="buyItem('${itemId}')" ${disabled ? 'disabled' : ''} class="w-full py-3 mt-auto ${disabled ? 'bg-gray-600 cursor-not-allowed' : 'bg-red-700 hover:bg-red-600'} text-white font-bold rounded-lg transition duration-300">
                ${isExpired ? 'Süre Doldu' : (outOfStock ? 'Stok Tükendi' : 'Satın Al')}
              </button>
            </div>
          `;
        container.appendChild(cardDiv);
    };

    if (gameItems.length > 0) {
      gameItems.forEach(itemData => renderItem(itemData, gameContainer));
    } else {
      gameContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">Oyun mağazasında ürün bulunmamaktadır.</p>';
    }
    
    if (specialItems.length > 0) {
      specialItems.forEach(itemData => renderItem(itemData, specialContainer));
    } else {
      specialContainer.innerHTML = '<p class="text-center col-span-full text-gray-400">Özel ürün mağazasında ürün bulunmamaktadır.</p>';
    }

    if (Object.keys(activeStoreCountdowns).length > 0) {
        updateStoreCountdowns();
        storeCountdownInterval = setInterval(updateStoreCountdowns, 1000);
    }
}

// MEVCUT buyItem FONKSİYONUNU SİLİP BUNUNLA DEĞİŞTİRİN

async function buyItem(itemId) {
    if (isAdmin) {
        displayMessage("Adminler alışveriş yapamaz.");
        return;
    }
    const userRef = db.ref('users/' + currentUser);
    const itemRef = db.ref('storeItems/' + itemId);
    const [userSnap, itemSnap] = await Promise.all([userRef.once('value'), itemRef.once('value')]);
    const user = userSnap.val();
    const item = itemSnap.val();
    
    if (!user || !item) return;

    if (item.type === 'tempMultiplier') {
        if (typeof item.value !== 'number' || typeof item.duration !== 'number') {
            displayMessage("Mağaza Hatası: Bu çarpan ürününde eksik bilgi var. Lütfen yönetici ile iletişime geçin.");
            return;
        }

        if (user.multiplierSource && user.multiplierSource !== 'none') {
            
            if (item.value === user.activeMultiplier) {
                if ((user.balance || 0) < item.cost) {
                    displayMessage("Yetersiz Puan!");
                    return;
                }
                const confirmedStack = await customConfirm(`Zaten ${user.activeMultiplier}x çarpanın var. Bu alım, mevcut çarpanına <b>+${item.duration} kullanım hakkı</b> ekleyecek ve toplamda <b>${(user.multiplierRemainingUses || 0) + item.duration} kullanım hakkın</b> olacak. Onaylıyor musun?`);
                if (confirmedStack) {
                    logActivity('multiplierStackedFromStore', currentUser, { 
                        cost: item.cost,
                        multiplierValue: item.value,
                        usesAdded: item.duration,
                        newTotalUses: (user.multiplierRemainingUses || 0) + item.duration,
                        newBalance: user.balance - item.cost
                    });
                    
                    await userRef.update({
                        balance: user.balance - item.cost,
                        totalSpentPoints: (user.totalSpentPoints || 0) + item.cost,
                        multiplierRemainingUses: (user.multiplierRemainingUses || 0) + item.duration
                    });
                    await itemRef.transaction(currentItem => {
                        if (currentItem) {
                            if (currentItem.stock !== undefined && currentItem.stock !== null) {
                                currentItem.stock--;
                            }
                            currentItem.purchaseCount = (currentItem.purchaseCount || 0) + 1;
                        }
                        return currentItem;
                    });
                    displayMessage(`Başarılı! ${user.activeMultiplier}x çarpanına +${item.duration} kullanım hakkı eklendi.`);
                    return;
                } else {
                    return;
                }
            }
            else if (item.value > user.activeMultiplier) {
                if ((user.balance || 0) < item.cost) {
                    displayMessage("Yetersiz Puan!");
                    return;
                }
                const kutuHakkiDonusum = user.multiplierRemainingUses || 0;
                const confirmedUpgrade = await customConfirm(`Mevcut ${user.activeMultiplier}x çarpanını daha yüksek olan <b>${item.value}x</b> ile değiştirmek üzeresin. Mevcut çarpanının kalan <b>${user.multiplierRemainingUses} kullanım hakkı</b>, envanterine <b>+${kutuHakkiDonusum} Kutu Hakkı</b> olarak eklenecek. Onaylıyor musun?`);
                if (confirmedUpgrade) {
                    // --- DEĞİŞİKLİK: newBalance hesaplaması düzeltildi ---
                    logActivity('multiplierUpgradedFromStore', currentUser, { 
                        oldValue: user.activeMultiplier, 
                        newValue: item.value, 
                        boxRights: kutuHakkiDonusum,
                        cost: item.cost,
                        newBalance: user.balance - item.cost 
                    });
                    await userRef.update({
                        balance: user.balance - item.cost,
                        totalSpentPoints: (user.totalSpentPoints || 0) + item.cost,
                        kutuHakki: (user.kutuHakki || 0) + kutuHakkiDonusum,
                        activeMultiplier: item.value,
                        multiplierRemainingUses: item.duration,
                        multiplierSource: 'store'
                    });
                     await itemRef.transaction(currentItem => {
                        if (currentItem) {
                            if (currentItem.stock !== undefined && currentItem.stock !== null) {
                                currentItem.stock--;
                            }
                            currentItem.purchaseCount = (currentItem.purchaseCount || 0) + 1;
                        }
                        return currentItem;
                    });
                    displayMessage(`Yükseltme başarılı! Envanterine +${kutuHakkiDonusum} Kutu Hakkı eklendi ve yeni ${item.value}x çarpanın aktif!`);
                    return;
                } else {
                    return;
                }
            }
            else {
                displayMessage(`Mevcut çarpanın (${user.activeMultiplier}x) zaten bu üründen (${item.value}x) daha güçlü. Daha düşük bir çarpan alamazsın.`);
                return;
            }
        }
    }
    
    if (item.type === 'avatar' && user.avatars && user.avatars[itemId]) {
        displayMessage("Bu avatara zaten sahipsin!");
        return;
    }

    if ((user.balance || 0) < item.cost) {
        displayMessage("Yetersiz Puan!");
        return;
    }
    if (item.stock !== undefined && item.stock <= 0) {
        displayMessage("Bu ürünün stoğu tükenmiştir.");
        return;
    }
    const confirmed = await customConfirm(`${item.name} ürününü ${item.cost} puana almak istiyor musunuz?`);
    if (confirmed) {
      
        logActivity('buyItem', currentUser, { 
            itemName: item.name, 
            itemCost: item.cost,
            itemType: item.type,
            itemValue: item.value || null,
            itemDuration: item.duration || null,
            newBalance: user.balance - item.cost
        });
        
        let updates = {
            balance: user.balance - item.cost,
            totalSpentPoints: (user.totalSpentPoints || 0) + item.cost,
            storePurchasesCount: (user.storePurchasesCount || 0) + 1
        };
        let message = 'Satın alma başarılı!';
        
        const itemValue = parseInt(item.value) || 0;
        const itemDuration = parseInt(item.duration) || 0;

        if (item.type === 'boxRights') {
            if (itemValue <= 0) { displayMessage("Ürün hatası: Geçersiz Kutu Hakkı değeri."); return; }
            updates.kutuHakki = (user.kutuHakki || 0) + itemValue;
        } else if (item.type === 'wheelTicket') {
            if (itemValue <= 0) { displayMessage("Ürün hatası: Geçersiz Bilet değeri."); return; }
            updates.carkBileti = (user.carkBileti || 0) + itemValue;
        } else if (item.type === 'clickCatchTicket') {
            if (itemValue <= 0) { displayMessage("Ürün hatası: Geçersiz Bilet değeri."); return; }
            updates.clickCatchTickets = (user.clickCatchTickets || 0) + itemValue;
        } else if (item.type === 'tempMultiplier') {
            if (itemValue <= 1) { displayMessage("Ürün hatası: Geçersiz Çarpan değeri (1'den büyük olmalı)."); return; }
            if (itemDuration <= 0) { displayMessage("Ürün hatası: Geçersiz Çarpan kullanım hakkı."); return; }
            updates.activeMultiplier = itemValue;
            updates.multiplierSource = 'store';
            updates.multiplierRemainingUses = itemDuration;
            updates.activeStoreMultiplierItemId = itemId; 
        } else if (item.type === 'iflasShield') {
            if (itemValue <= 0) { displayMessage("Ürün hatası: Geçersiz Kalkan değeri."); return; }
            updates.iflasShieldUses = (user.iflasShieldUses || 0) + itemValue;
        } 
        else if (item.type === 'avatar') {
            const newAvatar = {
                id: itemId,
                name: item.name,
                imageUrl: item.imageUrl
            };
            updates[`avatars/${itemId}`] = newAvatar;
            message = `'${item.name}' avatarı koleksiyonuna eklendi!`;
        } 
        else if (item.type === 'special') {
            const purchaseId = db.ref('pendingSpecialPurchases').push().key;
            db.ref(`pendingSpecialPurchases/${purchaseId}`).set({
                username: currentUser,
                itemName: item.name,
                itemCost: item.cost,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            db.ref(`purchaseHistory/${purchaseId}`).set({
                username: currentUser,
                itemName: item.name,
                itemCost: item.cost,
                imageUrl: item.imageUrl,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            message = `'${item.name}' adlı özel ürün talebiniz admine iletildi. Onaylandığında hesabınıza eklenecektir.`;
        }
        
        let itemUpdates = {};
        if (item.stock !== undefined && item.stock !== null) {
            itemUpdates.stock = item.stock - 1;
        }
        itemUpdates.purchaseCount = (item.purchaseCount || 0) + 1;
        await itemRef.update(itemUpdates);
        await userRef.update(updates);
        
        if(item.type !== 'special') {
            const purchaseId = db.ref('purchaseHistory').push().key;
            db.ref(`purchaseHistory/${purchaseId}`).set({
                username: currentUser,
                itemName: item.name,
                itemCost: item.cost,
                imageUrl: item.imageUrl,
                status: 'completed',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }
        
        displayMessage(message);
    }
}
  
  function resetStoreItemForm() {
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemDescription').value = '';
    document.getElementById('newItemCost').value = '';
    document.getElementById('newItemStock').value = '';
    document.getElementById('newItemType').value = '';
    document.getElementById('newItemValue').value = '';
    document.getElementById('newItemMultiplierDuration').value = '';
    
    document.getElementById('storeItemCountdownDays').value = '';
    document.getElementById('storeItemCountdownHours').value = '';
    document.getElementById('storeItemCountdownMinutes').value = '';
    document.getElementById('storeItemCountdownSeconds').value = '';

    document.getElementById('newItemImageUrl').value = '';
    document.getElementById('addUpdateStoreItemBtn').textContent = 'ÜRÜN EKLE';
    document.getElementById('newItemMultiplierDuration').classList.add('hidden');
    editingItemId = null; 
  }

  document.getElementById('newItemType').addEventListener('change', function() {
      const durationInput = document.getElementById('newItemMultiplierDuration');
      if (this.value === 'tempMultiplier') {
          durationInput.classList.remove('hidden');
      } else {
          durationInput.classList.add('hidden');
      }
  });

  async function saveStoreItem() {
    if (!isAdmin) return;

    try {
        const name = document.getElementById('newItemName').value.trim();
        const description = document.getElementById('newItemDescription').value.trim();
        const cost = parseInt(document.getElementById('newItemCost').value);
        const type = document.getElementById('newItemType').value;
        const imageUrl = document.getElementById('newItemImageUrl').value.trim();
        let stockInput = document.getElementById('newItemStock').value;

        const days = parseInt(document.getElementById('storeItemCountdownDays').value) || 0;
        const hours = parseInt(document.getElementById('storeItemCountdownHours').value) || 0;
        const minutes = parseInt(document.getElementById('storeItemCountdownMinutes').value) || 0;
        const seconds = parseInt(document.getElementById('storeItemCountdownSeconds').value) || 0;
        const totalMinutes = (days * 24 * 60) + (hours * 60) + minutes + Math.round(seconds / 60);

        // Temel alanların kontrolü
        if (!name || !description || isNaN(cost) || !type) {
            displayMessage("Lütfen Ad, Açıklama, Maliyet ve Tip alanlarını doldurun.");
            return;
        }

        const stock = (stockInput === '' || stockInput === null) ? null : parseInt(stockInput);

        const itemData = {
            name, description, cost, stock, type,
            imageUrl: imageUrl || 'https://via.placeholder.com/150',
        };

        // Her ürün tipi için Değer ve Süre kontrolünü ayrı ayrı ve daha güvenli yapıyoruz.
        if (type === 'tempMultiplier') {
            const value = parseInt(document.getElementById('newItemValue').value);
            const multiplierDuration = parseInt(document.getElementById('newItemMultiplierDuration').value);

            if (isNaN(value) || value <= 0) {
                displayMessage("Çarpan için geçerli bir 'Değer' (2x, 3x gibi) girmelisiniz.");
                return;
            }
            if (isNaN(multiplierDuration) || multiplierDuration <= 0) {
                displayMessage("Çarpan için geçerli bir 'Kullanım Sayısı' girmelisiniz.");
                return;
            }
            itemData.value = value;
            itemData.duration = multiplierDuration;
        } else {
            const typesThatNeedValue = ['boxRights', 'wheelTicket', 'clickCatchTicket', 'iflasShield'];
            if (typesThatNeedValue.includes(type)) {
                const value = parseInt(document.getElementById('newItemValue').value);
                if (isNaN(value) || value <= 0) {
                    displayMessage(`'${type}' tipi için geçerli bir 'Değer' girmelisiniz.`);
                    return;
                }
                itemData.value = value;
            }
        }

        if (totalMinutes > 0) {
            itemData.countdownDurationMinutes = totalMinutes;
        } else {
            itemData.countdownDurationMinutes = null;
        }

        if (editingItemId) {
            const existingItemSnap = await storeItemsRef.child(editingItemId).once('value');
            const existingItem = existingItemSnap.val();
            itemData.createdAt = existingItem.createdAt || firebase.database.ServerValue.TIMESTAMP;
            itemData.order = existingItem.order;
            itemData.purchaseCount = existingItem.purchaseCount || 0;
            await storeItemsRef.child(editingItemId).update(itemData);
            displayMessage(`'${name}' ürünü başarıyla güncellendi!`);
        } else {
            itemData.createdAt = firebase.database.ServerValue.TIMESTAMP;
            itemData.purchaseCount = 0;
            const maxOrderSnap = await storeItemsRef.orderByChild('order').limitToLast(1).once('value');
            let maxOrder = -1;
            if (maxOrderSnap.exists()) {
                maxOrder = Object.values(maxOrderSnap.val())[0].order || 0;
            }
            itemData.order = maxOrder + 1;
            await storeItemsRef.push(itemData);
            displayMessage(`'${name}' ürünü başarıyla eklendi!`);
        }
        
        closeAdminStoreModal();
        loadStoreItems();

    } catch (error) {
        console.error("Mağaza ürünü kaydetme hatası:", error);
        displayMessage("Ürün kaydedilirken bir hata oluştu: " + error.message);
    }
}
  
  // DEĞİŞTİRİLECEK FONKSİYON
async function reorderStoreItem(itemId, newIndex) {
    if (!isAdmin) return;
    const itemsRef = db.ref('storeItems');
    const itemsSnap = await itemsRef.once('value');
    const items = itemsSnap.val();
    if (!items) return;

    const itemType = items[itemId].type;

    let allItemsArray = Object.entries(items);
    let gameItems = allItemsArray.filter(([, item]) => item.type !== 'special').sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));
    let specialItems = allItemsArray.filter(([, item]) => item.type === 'special').sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));

    let listToModify = (itemType === 'special') ? specialItems : gameItems;

    const itemToMoveIndex = listToModify.findIndex(([id]) => id === itemId);
    if (itemToMoveIndex === -1) return;

    if (newIndex < 0 || newIndex >= listToModify.length) return;

    const [movedItem] = listToModify.splice(itemToMoveIndex, 1);
    listToModify.splice(newIndex, 0, movedItem);

    const finalCombinedList = [...gameItems, ...specialItems];

    const updates = {};
    finalCombinedList.forEach(([id], index) => {
        updates[`storeItems/${id}/order`] = index;
    });

    await db.ref().update(updates);
}
  async function editStoreItem(itemId) {
    if (!isAdmin) return;
    
    const itemSnap = await storeItemsRef.child(itemId).once('value');
    const item = itemSnap.val();
    if (!item) {
        displayMessage("Düzenlenecek ürün bulunamadı.");
        return;
    }

    document.getElementById('newItemName').value = item.name;
    document.getElementById('newItemDescription').value = item.description;
    document.getElementById('newItemCost').value = item.cost;
    document.getElementById('newItemStock').value = item.stock !== null ? item.stock : '';
    document.getElementById('newItemType').value = item.type;
    document.getElementById('newItemValue').value = item.value;
    document.getElementById('newItemImageUrl').value = item.imageUrl || '';

    const totalMins = item.countdownDurationMinutes || 0;
    const days = Math.floor(totalMins / 1440);
    const remainingMinsAfterDays = totalMins % 1440;
    const hours = Math.floor(remainingMinsAfterDays / 60);
    const minutes = remainingMinsAfterDays % 60;

    document.getElementById('storeItemCountdownDays').value = days > 0 ? days : '';
    document.getElementById('storeItemCountdownHours').value = hours > 0 ? hours : '';
    document.getElementById('storeItemCountdownMinutes').value = minutes > 0 ? minutes : '';
    document.getElementById('storeItemCountdownSeconds').value = '';
    
    const durationInput = document.getElementById('newItemMultiplierDuration');
    if (item.type === 'tempMultiplier') {
      durationInput.classList.remove('hidden');
      durationInput.value = item.duration || '';
    } else {
      durationInput.classList.add('hidden');
    }

    document.getElementById('addUpdateStoreItemBtn').textContent = 'ÜRÜNÜ GÜNCELLE';
    editingItemId = itemId;
    openAdminStoreModal();
  }

  async function deleteStoreItem(itemId) {
      if (!isAdmin) return;
      if (await customConfirm("Bu ürünü silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!")) {
          try {
              await storeItemsRef.child(itemId).remove();
              displayMessage("Ürün başarıyla silindi.");
          } catch (error) {
              console.error("Ürün silme hatası:", error);
              displayMessage("Ürün silinirken bir hata oluştu.");
          }
      }
  }

  function openPurchaseHistoryModal() {
      loadPurchaseHistory();
      purchaseHistoryModal.style.display = 'flex';
  }
  function closePurchaseHistoryModal() {
      purchaseHistoryModal.style.display = 'none';
  }
  
  function loadPurchaseHistory() {
      const list = document.getElementById('purchaseHistoryList');
      list.innerHTML = "<div class='text-center text-gray-400'>Yükleniyor...</div>";
      let ref = db.ref('purchaseHistory');
      
      // Admin değilse sadece kendi geçmişini görsün
      if (!isAdmin) {
          ref = ref.orderByChild('username').equalTo(currentUser);
      }

      ref.once('value').then(snap => {
          const history = snap.val();
          let html = '';
          if (!history || Object.keys(history).length === 0) {
              list.innerHTML = `<div class='text-center text-gray-400'>${isAdmin ? 'Hiçbir satın alma işlemi yapılmamış.' : 'Henüz bir satın alma işlemi yapmadınız.'}</div>`;
              return;
          }
          
          // YENİ: Anahtarları (ID'leri) kaybetmemek için Object.entries kullanıyoruz
          const sorted = Object.entries(history).sort(([, a], [, b]) => b.timestamp - a.timestamp);

          sorted.forEach(([key, r]) => { // key = purchaseId
              let statusBadge = '';
              if (r.status === 'pending') {
                  statusBadge = '<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200">Beklemede</span>';
              } else if (r.status === 'denied') {
                  statusBadge = '<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-red-600 bg-red-200">Reddedildi</span>';
              }

              // YENİ: Admin ise silme butonu ekliyoruz
              const deleteButton = isAdmin ? `
                <button onclick="deletePurchase('${key}')" class="ml-4 p-2 text-gray-400 hover:text-red-500 rounded-full transition-colors" title="Bu alımı sil ve iade et">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
              ` : '';

              html += `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 mb-3 bg-gray-700 rounded-lg border-l-4 border-red-500">
                    <div class="flex items-center mb-2 sm:mb-0">
                        <img src="${r.imageUrl || 'https://via.placeholder.com/150'}" alt="${r.itemName}" class="w-12 h-12 rounded-md mr-4 object-cover">
                        <div>
                            <p class="font-bold text-lg text-yellow-300">${r.itemName}</p>
                            <p class="text-sm text-gray-300">Maliyet: ${r.itemCost} Puan</p>
                        </div>
                    </div>
                    <div class="flex items-center w-full sm:w-auto">
                        <div class="text-xs text-gray-400 text-right flex-grow">
                            ${new Date(r.timestamp).toLocaleString()}
                            ${isAdmin ? `<br><span class="font-semibold text-white">${r.username}</span>` : ''}
                            ${statusBadge ? `<br class="mt-1">${statusBadge}` : ''}
                        </div>
                        ${deleteButton}
                    </div>
                </div>
              `;
          });
          list.innerHTML = html;
      });
  }

    // DEĞİŞTİRİLECEK FONKSİYON
async function deletePurchase(purchaseId) {
    if (!isAdmin) return;

    const confirmed = await customConfirm("Bu satın alımı silmek istediğinizden emin misiniz? Puanlar kullanıcıya iade edilecek, ürün istatistikleri güncellenecektir.");
    if (!confirmed) return;

    try {
        const purchaseRef = db.ref(`purchaseHistory/${purchaseId}`);
        const purchaseSnap = await purchaseRef.once('value');
        const purchaseData = purchaseSnap.val();

        if (!purchaseData) {
            displayMessage("Hata: Silinecek satın alım kaydı bulunamadı.");
            return;
        }

        const { username, itemName, itemCost } = purchaseData;
        const userRef = db.ref(`users/${username}`);
        const storeItemsRef = db.ref('storeItems');

        const itemsSnap = await storeItemsRef.orderByChild('name').equalTo(itemName).once('value');
        let originalItemId = null;
        let originalItem = null;
        if (itemsSnap.exists()) {
            originalItemId = Object.keys(itemsSnap.val())[0];
            originalItem = itemsSnap.val()[originalItemId];
        }

        const userSnap = await userRef.once('value');
        const userData = userSnap.val();
        if (!userData) {
            displayMessage(`Hata: ${username} adlı kullanıcı bulunamadı.`);
            await purchaseRef.remove(); // Kullanıcı yoksa bile geçmişi sil
            return;
        }

        const updates = {};
        
        updates[`/users/${username}/balance`] = (userData.balance || 0) + itemCost;
        updates[`/users/${username}/totalSpentPoints`] = Math.max(0, (userData.totalSpentPoints || 0) - itemCost);
        
        if (originalItemId && originalItem) {
            updates[`/storeItems/${originalItemId}/purchaseCount`] = Math.max(0, (originalItem.purchaseCount || 0) - 1);
            if (originalItem.stock !== null && originalItem.stock !== undefined) {
                updates[`/storeItems/${originalItemId}/stock`] = (originalItem.stock || 0) + 1;
            }
        }

        updates[`/purchaseHistory/${purchaseId}`] = null;

        await db.ref().update(updates);

        displayMessage(`'${itemName}' alımı başarıyla silindi. ${username} adlı kullanıcıya ${itemCost} puan iade edildi.`);
        // Eğer modal açıksa, listeyi yenile
        if (purchaseHistoryModal.style.display === 'flex') {
            loadPurchaseHistory();
        }

    } catch (error) {
        console.error("Satın alım silinirken hata oluştu: ", error);
        displayMessage("İşlem sırasında bir hata oluştu. Lütfen konsolu kontrol edin.");
    }
}
  async function clearPurchaseHistory() { if(await customConfirm("Tüm satın alma geçmişini silmek istediğinize emin misiniz? Bu işlem geri alınamaz!")) { db.ref('purchaseHistory').remove().then(() => displayMessage("Satın alma geçmişi başarıyla temizlendi.")) } }
  async function clearAllTotalSpentPoints() { if(await customConfirm("Tüm kullanıcıların harcadığı puanları sıfırlamak istediğinize emin misiniz?")) { db.ref('users').once('value').then(snap => { const updates = {}; snap.forEach(c => { if(c.key !== 'weizendtv') updates[`users/${c.key}/totalSpentPoints`] = 0; }); db.ref().update(updates).then(() => displayMessage("Tüm kullanıcıların harcanan puanları sıfırlandı.")) }); } }
  
  function openInventoryModal() {
      const userRef = db.ref('users/' + currentUser);
      userRef.once('value').then(snap => {
          const user = snap.val();
          if (user) {
              document.getElementById('inventoryBoxRights').textContent = user.kutuHakki || 0;
              document.getElementById('inventoryWheelTickets').textContent = user.carkBileti || 0;
              // YENİ EKLENEN SATIR
              document.getElementById('inventoryClickCatchTickets').textContent = user.clickCatchTickets || 0;
              // YENİ EKLENEN SATIR BİTİŞ
              document.getElementById('inventoryIflasShields').textContent = user.iflasShieldUses || 0;
              
              let multiplierHtml = '<p>✖️ Aktif çarpan yok.</p>';
              if (user.multiplierSource === 'store' && user.multiplierRemainingUses > 0) {
                  multiplierHtml = `<p><b>✖️ Aktif Çarpan:</b> </b> [ ${user.activeMultiplier}X - ${user.multiplierRemainingUses} ADET ] </p>`;
              } else if (user.multiplierSource === 'box') {
                  multiplierHtml = `<p><b>✖️ Aktif Çarpan:</b> </b> [ ${user.activeMultiplier}X - [ </b> 1 ADET (Otomatik) ] </p>`;
              }
              document.getElementById('inventoryMultiplierDetails').innerHTML = multiplierHtml;
          }
      });
      inventoryModal.style.display = 'flex';
  }
  function closeInventoryModal() { inventoryModal.style.display = 'none'; }
  function openBadgeInfoModal() { badgeInfoModal.style.display = 'flex'; }
  function closeBadgeInfoModal() { badgeInfoModal.style.display = 'none'; }

// MEVCUT openPublicUserDetailModal FONKSİYONUNU SİLİP BUNUNLA DEĞİŞTİRİN

async function openPublicUserDetailModal(username) {
    // YENİ EKLENEN SATIR: Profile bakarken eylem panelini otomatik kapatır.
    closeActivityFeed(); 
    
    document.body.classList.add('modal-open');
    if (activeBlockedUserTimers[username]) {
        clearInterval(activeBlockedUserTimers[username]);
        delete activeBlockedUserTimers[username];
    }
    publicUserDetailModal.dataset.viewingUser = username;

    const userRef = db.ref('users/' + username);
    
    const userProfileCallback = async (userSnap) => {
        const userData = userSnap.val();
        if (!userData) {
            closePublicUserDetailModal();
            return;
        }

        const championshipsDiv = document.getElementById('publicUserChampionships');
        let championshipsHtml = '';

        if (userData.puanChampionshipsWon > 0) {
            championshipsHtml += `<p class="font-semibold text-base">🏆 ${userData.puanChampionshipsWon} kez [KULLANICI PUAN SIRALAMASI] aylık sezon şampiyonu oldu!</p>`;
        }
        if (userData.rozetChampionshipsWon > 0) {
            championshipsHtml += `<p class="font-semibold text-base">👑 ${userData.rozetChampionshipsWon} kez [LİDERLER SIRALAMASI] aylık sezon şampiyonu oldu!</p>`;
        }
        
        if (championshipsHtml) {
            championshipsDiv.innerHTML = championshipsHtml;
            championshipsDiv.classList.remove('hidden');
        } else {
            championshipsDiv.classList.add('hidden');
        }
        const allUsersSnap = await db.ref('users').once('value');
        const leaders = await calculateAllLeaders(allUsersSnap.val());
        const userLeaderStatus = {
            isCurrentLeader: username === leaders.currentBalanceUser,
            isHighLeader: username === leaders.highEverBalanceUser,
            isSurpriseLeader: username === leaders.surpriseBoxUser,
            isBombLeader: username === leaders.bombUser,
            isStoreLeader: username === leaders.spentPointsUser,
            isMultiplierLeader: username === leaders.multiplierUser,
            isBoxLeader: username === leaders.boxUser,
            isShieldLeader: username === leaders.shieldUser,
            isClickCatchLeader: username === leaders.clickCatchLeaderUser,
            isWheelSpinLeader: username === leaders.wheelSpinUser
        };
        const badges = getUserBadgesHtml(userData, userLeaderStatus, true);
        document.getElementById('publicUserProfileBadges').innerHTML = badges.crown + badges.others;
        document.getElementById('publicBadgeBalance').innerHTML = userLeaderStatus.isCurrentLeader ? '🥇' : '';
        document.getElementById('publicBadgeHighest').innerHTML = userLeaderStatus.isHighLeader ? '🏆' : '';
        const avatarUrl = userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;
        document.getElementById('publicUserAvatar').src = avatarUrl;
        document.getElementById('publicUserName').textContent = username;
        document.getElementById('publicUserBalance').textContent = userData.balance || 0;
        document.getElementById('publicUserHighestBalance').textContent = userData.highestBalanceEver || 0;
        document.getElementById('publicUserBoxRight').textContent = userData.kutuHakki || 0;
        document.getElementById('publicUserWheelTickets').textContent = userData.carkBileti || 0;
        document.getElementById('publicUserClickCatchTickets').textContent = userData.clickCatchTickets || 0;
        document.getElementById('publicUserIflasShield').textContent = userData.iflasShieldUses || 0;
        let multiplierText = 'Yok';
        if (userData.multiplierSource === 'store' && userData.multiplierRemainingUses > 0) {
          multiplierText = `${userData.activeMultiplier}x (Mağaza - ${userData.multiplierRemainingUses} kullanım)`;
        } else if (userData.multiplierSource === 'box') {
          multiplierText = `${userData.activeMultiplier}x (Kutu - Otomatik)`;
        }
        document.getElementById('publicUserMultiplier').textContent = multiplierText;
        document.getElementById('publicUserBoxesOpened').textContent = userData.boxesOpenedCount || 0;
        document.getElementById('publicUserWheelSpins').textContent = userData.wheelSpinsCount || 0;
        document.getElementById('publicUserClickCatchScore').textContent = userData.clickCatchHighestScore || 0;
        document.getElementById('publicUserSurpriseBoxes').textContent = userData.surpriseBoxesOpened || 0;
        document.getElementById('publicUserBombCount').textContent = userData.iflasCount || 0;
        document.getElementById('publicUserMultiplierFoundCount').textContent = userData.multiplierFoundCount || 0;
        document.getElementById('publicUserShieldUsedCount').textContent = userData.iflasShieldUsedCount || 0;
        document.getElementById('publicUserTotalSpent').textContent = userData.totalSpentPoints || 0;
        const statBadgeIds = ['box', 'wheel', 'clickcatch', 'surprise', 'bomb', 'multiplier', 'shield', 'store'];
        statBadgeIds.forEach(id => document.getElementById(`badge-stat-${id}`).innerHTML = '');
        if (userLeaderStatus.isBoxLeader) document.getElementById('badge-stat-box').innerHTML = '📦';
        if (userLeaderStatus.isWheelSpinLeader) document.getElementById('badge-stat-wheel').innerHTML = '🎡';
        if (userLeaderStatus.isClickCatchLeader) document.getElementById('badge-stat-clickcatch').innerHTML = '🎯';
        if (userLeaderStatus.isSurpriseLeader) document.getElementById('badge-stat-surprise').innerHTML = '🎉';
        if (userLeaderStatus.isBombLeader) document.getElementById('badge-stat-bomb').innerHTML = '💣';
        if (userLeaderStatus.isMultiplierLeader) document.getElementById('badge-stat-multiplier').innerHTML = '✖️';
        if (userLeaderStatus.isShieldLeader) document.getElementById('badge-stat-shield').innerHTML = '🛡️';
        if (userLeaderStatus.isStoreLeader) document.getElementById('badge-stat-store').innerHTML = '🛒';
        const blockedInfoDiv = document.getElementById('publicUserBlockedInfo');
        const countdownEl = document.getElementById('publicUserBlockedCountdown');
        const isCurrentlyBlocked = userData.blocked && userData.blockedUntil && Date.now() < userData.blockedUntil;
        if(isCurrentlyBlocked) {
            blockedInfoDiv.classList.remove('hidden');
        } else {
            blockedInfoDiv.classList.add('hidden');
        }
        publicUserDetailModal.style.display = 'flex';
    };
    userRef.on('value', userProfileCallback);
    activeUserProfileListener = { ref: userRef, callback: userProfileCallback };
}
  
  // YENİ VE DÜZELTİLMİŞ FONKSİYON
async function openUserManagementModal(username) {
    if (activeBlockedUserTimers[username]) {
        clearInterval(activeBlockedUserTimers[username]);
        delete activeBlockedUserTimers[username];
    }
    selectedUserForManagement = username;

    const [userSnap, allUsersSnap] = await Promise.all([
        db.ref('users/' + username).once('value'),
        db.ref('users').once('value')
    ]);

    const userData = userSnap.val();
    if (!userData) { displayMessage("Kullanıcı bulunamadı."); return; }

    const leaders = await calculateAllLeaders(allUsersSnap.val());

    // Yönetilen kullanıcıya özel liderlik durumlarını belirle
    const userLeaderStatus = {
        isCurrentLeader: username === leaders.currentBalanceUser,
        isHighLeader: username === leaders.highEverBalanceUser,
        isBoxLeader: username === leaders.boxUser,
        isSurpriseLeader: username === leaders.surpriseBoxUser,
        isBombLeader: username === leaders.bombUser,
        isMultiplierLeader: username === leaders.multiplierUser,
        isStoreLeader: username === leaders.spentPointsUser,
        isShieldLeader: username === leaders.shieldUser,
        isClickCatchLeader: username === leaders.clickCatchLeaderUser,
        isWheelSpinLeader: username === leaders.wheelSpinUser
    };
  // YENİ EKLENEN KISIM: Admin panelindeki satır başı rozetlerini de dinamik hale getirir.
    document.getElementById('managedBadgeBalance').innerHTML = userLeaderStatus.isCurrentLeader ? '🥇' : '';
    document.getElementById('managedBadgeHighest').innerHTML = userLeaderStatus.isHighLeader ? '🏆' : '';

    const avatarUrl = userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;
    document.getElementById('managedUserAvatar').src = avatarUrl;
    document.getElementById('managedUserName').textContent = username;
    document.getElementById('managedUserBalance').textContent = userData.balance || 0;
    document.getElementById('managedUserHighestBalance').textContent = userData.highestBalanceEver || 0;
    document.getElementById('managedUserBoxRight').textContent = userData.kutuHakki || 0;
    document.getElementById('managedUserWheelTickets').textContent = userData.carkBileti || 0;
    document.getElementById('managedUserClickCatchTickets').textContent = userData.clickCatchTickets || 0;
    document.getElementById('managedUserIflasShield').textContent = userData.iflasShieldUses || 0;
    let multiplierText = 'Yok';
    if (userData.multiplierSource === 'store') multiplierText = `${userData.activeMultiplier}x (Mağaza - ${userData.multiplierRemainingUses} kullanım)`;
    else if (userData.multiplierSource === 'box') multiplierText = `${userData.activeMultiplier}x (Kutu - Otomatik)`;
    document.getElementById('managedUserMultiplier').textContent = multiplierText;
    document.getElementById('managedUserMultiplierUses').textContent = userData.multiplierRemainingUses || 0;

    const isCurrentlyBlocked = userData.blocked && userData.blockedUntil && Date.now() < userData.blockedUntil;
    const countdownContainer = document.getElementById('managedUserBlockedCountdownContainer');
    const countdownEl = document.getElementById('managedUserBlockedCountdown');
    document.getElementById('managedUserBlockedStatus').textContent = isCurrentlyBlocked ? 'Engelli' : 'Aktif';
    if(isCurrentlyBlocked) {
        countdownContainer.classList.remove('hidden');
        const updateCountdown = () => {
              const timeLeft = userData.blockedUntil - Date.now();
              if (timeLeft <= 0) {
                  clearInterval(activeBlockedUserTimers[username]);
                  delete activeBlockedUserTimers[username];
                  countdownEl.textContent = 'Engel Kalktı';
              } else {
                  const minutes = Math.floor(timeLeft / 60000);
                  const seconds = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, '0');
                  countdownEl.textContent = `${minutes}:${seconds}`;
              }
          };
        updateCountdown();
        activeBlockedUserTimers[username] = setInterval(updateCountdown, 1000);
    } else {
        countdownContainer.classList.add('hidden');
    }
    const toggleBtn = document.getElementById('toggleBlockUserBtn');
    toggleBtn.textContent = isCurrentlyBlocked ? 'Engeli Kaldır' : 'Engelle';
    toggleBtn.onclick = () => toggleBlockUser(username, userData.blocked, userData.blockedUntil);

    document.getElementById('managedUserBoxesOpened').textContent = userData.boxesOpenedCount || 0;
    document.getElementById('managedUserSurpriseBoxes').textContent = userData.surpriseBoxesOpened || 0;
    document.getElementById('managedUserBombCount').textContent = userData.iflasCount || 0;
    document.getElementById('managedUserMultiplierFoundCount').textContent = userData.multiplierFoundCount || 0;
    document.getElementById('managedUserTotalSpent').textContent = userData.totalSpentPoints || 0;
    document.getElementById('managedUserShieldUsedCount').textContent = userData.iflasShieldUsedCount || 0;
    document.getElementById('managedUserClickCatchScore').textContent = userData.clickCatchHighestScore || 0;
    document.getElementById('managedUserWheelSpins').textContent = userData.wheelSpinsCount || 0;

    // Yönetim panelindeki liderlik rozetlerini göster
    ['managedBadgeWheel', 'managedBadgeBox', 'managedBadgeSurprise', 'managedBadgeBomb', 'managedBadgeMultiplier', 'managedBadgeStore', 'managedBadgeShield', 'managedBadgeClickCatch'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerHTML = '';
    });

    if (userLeaderStatus.isBoxLeader) document.getElementById('managedBadgeBox').innerHTML = '📦';
    if (userLeaderStatus.isSurpriseLeader) document.getElementById('managedBadgeSurprise').innerHTML = '🎉';
    if (userLeaderStatus.isBombLeader) document.getElementById('managedBadgeBomb').innerHTML = '💣';
    if (userLeaderStatus.isMultiplierLeader) document.getElementById('managedBadgeMultiplier').innerHTML = '✖️';
    if (userLeaderStatus.isStoreLeader) document.getElementById('managedBadgeStore').innerHTML = '🛒';
    if (userLeaderStatus.isShieldLeader) document.getElementById('managedBadgeShield').innerHTML = '🛡️';
    if (userLeaderStatus.isClickCatchLeader) document.getElementById('managedBadgeClickCatch').innerHTML = '🎯';
    if (userLeaderStatus.isWheelSpinLeader) document.getElementById('managedBadgeWheel').innerHTML = '🎡';

    const historyList = document.getElementById('managedUserPurchaseHistory');
    historyList.innerHTML = 'Yükleniyor...';
    db.ref('purchaseHistory').orderByChild('username').equalTo(username).once('value').then(snap => {
        const history = snap.val();
        let html = '';
        if (!history) {
            historyList.innerHTML = '<div class="text-center text-gray-400">Bu kullanıcının satın alma geçmişi yok.</div>';
            return;
        }
        const sorted = Object.values(history).sort((a,b) => b.timestamp - a.timestamp);
        sorted.forEach(r => {
            html += `<div class="p-2 bg-gray-900 mb-2 rounded text-sm"><b>Ürün:</b> ${r.itemName}, <b>Maliyet:</b> ${r.itemCost} Puan, <b>Tarih:</b> ${new Date(r.timestamp).toLocaleString()}</div>`;
        });
        historyList.innerHTML = html;
    });

    const avatarGrid = document.getElementById('managedUserAvatarGrid');
    avatarGrid.innerHTML = '';
    if (userData.avatars && Object.keys(userData.avatars).length > 0) {
        for (const avatarId in userData.avatars) {
            const avatar = userData.avatars[avatarId];
            const avatarCard = document.createElement('div');
            avatarCard.className = 'relative p-2 bg-gray-700 rounded-lg text-center';
            avatarCard.innerHTML = `<img src="${avatar.imageUrl}" alt="${avatar.name}" class="w-full h-auto rounded-md object-cover aspect-square"><p class="text-xs mt-2 text-white truncate" title="${avatar.name}">${avatar.name}</p><button onclick="deleteUserAvatar('${username}', '${avatarId}')" class="absolute -top-2 -right-2 bg-red-600 hover:bg-red-500 text-white rounded-full h-7 w-7 flex items-center justify-center text-lg font-bold" title="Bu Avatarı Sil">&times;</button>`;
            avatarGrid.appendChild(avatarCard);
        }
    } else {
        avatarGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Bu kullanıcının satın alınmış avatarı yok.</p>';
    }

    userManagementModal.style.display = 'flex';
}

    function closePublicUserDetailModal() {
    const publicUserDetailModal = document.getElementById('publicUserDetailModal');
    publicUserDetailModal.style.display = 'none';
    document.body.classList.remove('modal-open');

    // --- DEĞİŞEN KISIM BAŞLANGICI ---
    // Eğer aktif bir profil dinleyicisi varsa, onu kapatıyoruz.
    if (activeUserProfileListener && activeUserProfileListener.ref && activeUserProfileListener.callback) {
        // Dinleyiciyi 'value' event'i için ve sakladığımız callback ile kapatıyoruz.
        activeUserProfileListener.ref.off('value', activeUserProfileListener.callback);
        activeUserProfileListener = null; // Değişkeni temizliyoruz ki tekrar kullanılmasın.
    }
    // --- DEĞİŞEN KISIM SONU ---

    const viewingUser = publicUserDetailModal.dataset.viewingUser;
    if (viewingUser && activeBlockedUserTimers[viewingUser]) {
        clearInterval(activeBlockedUserTimers[viewingUser]);
        delete activeBlockedUserTimers[viewingUser];
    }
}
  
  function closeUserManagementModal() {
    if (selectedUserForManagement && activeBlockedUserTimers[selectedUserForManagement]) {
        clearInterval(activeBlockedUserTimers[selectedUserForManagement]);
        delete activeBlockedUserTimers[selectedUserForManagement];
    }
    userManagementModal.style.display = 'none'; 
    selectedUserForManagement = null; 
  }

  function loadPendingSpecialPurchases() {
    const list = document.getElementById('pendingSpecialPurchasesList');
    const ref = db.ref('pendingSpecialPurchases');
    const callback = snap => {
        const purchases = snap.val();
        let html = '';
        if (!purchases || Object.keys(purchases).length === 0) {
            list.innerHTML = "<div class='text-center text-gray-400'>Onay bekleyen özel ürün alımı yok.</div>";
            return;
        }
        for (const key in purchases) {
            const purchase = purchases[key];
            html += `
                <div class="flex flex-col items-start justify-between p-3 mb-2 bg-gray-700 rounded-md border-l-4 border-yellow-500">
                    <div>
                        <span class="text-gray-200 font-bold">${purchase.username}</span>
                        <span class="text-gray-300">- ${purchase.itemName}</span>
                    </div>
                    <div class="flex space-x-2 mt-2 self-end">
                        <button onclick="approveSpecialPurchase('${key}', '${purchase.username}')" class="py-1 px-3 bg-green-600 hover:bg-green-500 text-white text-sm font-bold rounded-md">Onayla</button>
                        <button onclick="denySpecialPurchase('${key}', '${purchase.username}', ${purchase.itemCost})" class="py-1 px-3 bg-red-600 hover:bg-red-500 text-white text-sm font-bold rounded-md">Reddet</button>
                    </div>
                </div>
            `;
        }
        list.innerHTML = html;
    };
    activeListeners.pendingPurchases = { ref, event: 'value', callback };
    ref.on('value', callback);
  }

  async function approveSpecialPurchase(purchaseId, username) {
      const purchaseItemSnap = await db.ref(`/pendingSpecialPurchases/${purchaseId}`).once('value');
      const purchaseItem = purchaseItemSnap.val();
      if (!purchaseItem) {
        displayMessage("Onaylanacak öğe bulunamadı.");
        return;
      }
      
      if (!await customConfirm(`${username} kullanıcısının '${purchaseItem.itemName}' alımını onaylamak istediğinize emin misiniz?`)) return;

      const updates = {};
      updates[`/pendingSpecialPurchases/${purchaseId}`] = null; 
      updates[`/purchaseHistory/${purchaseId}/status`] = 'completed'; 

      db.ref().update(updates).then(() => {
          notifyUser(username, `'${purchaseItem.itemName}' adlı özel ürün alımınız onaylandı!`);
          displayMessage("Özel ürün alımı başarıyla onaylandı.");
      }).catch(err => {
          console.error("Onaylama hatası: ", err);
          displayMessage("Onaylama sırasında bir hata oluştu.");
      });
  }

  async function denySpecialPurchase(purchaseId, username, itemCost) {
      const purchaseItemSnap = await db.ref(`/pendingSpecialPurchases/${purchaseId}`).once('value');
      const purchaseItem = purchaseItemSnap.val();
       if (!purchaseItem) {
        displayMessage("Reddedilecek öğe bulunamadı.");
        return;
      }

      if (!await customConfirm(`${username} kullanıcısının '${purchaseItem.itemName}' alımını reddetmek istediğinize emin misiniz? Puan iadesi yapılacaktır.`)) return;
      
      const userRef = db.ref(`users/${username}`);
      const updates = {};

      const userSnap = await userRef.once('value');
      const userData = userSnap.val();
      if (userData) {
          updates[`users/${username}/balance`] = (userData.balance || 0) + itemCost;
          updates[`users/${username}/totalSpentPoints`] = Math.max(0, (userData.totalSpentPoints || 0) - itemCost);
      }

      updates[`/pendingSpecialPurchases/${purchaseId}`] = null;
      updates[`/purchaseHistory/${purchaseId}/status`] = 'denied';

      db.ref().update(updates).then(() => {
          notifyUser(username, `'${purchaseItem.itemName}' adlı özel ürün alımınız reddedildi. ${itemCost} puan hesabınıza iade edildi.`);
          displayMessage("Özel ürün alımı reddedildi ve puan iadesi yapıldı.");
      }).catch(err => {
          console.error("Reddetme hatası: ", err);
          displayMessage("Reddetme sırasında bir hata oluştu.");
      });
  }

  let globalCountdownInterval = null;
    let spectatorCountdownInterval = null;

  // MEVCUT listenForGameChanges FONKSİYONUNU SİL VE BUNUNLA DEĞİŞTİR
function listenForGameChanges() {
    const gameLockRef = db.ref('gameLock');
    const gameLockCallback = snap => {
        isGameLocked = snap.val() === true;
        const toggleBtn = document.getElementById('toggleGameLockBtn');
        if (toggleBtn) {
            if (isGameLocked) {
                toggleBtn.textContent = 'Oyun Kilidini Aç';
                toggleBtn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
                toggleBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            } else {
                toggleBtn.textContent = 'Oyunu Kilitle';
                toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
                toggleBtn.classList.add('bg-gray-600', 'hover:bg-gray-500');
            }
        }
    };
    activeListeners.gameLock = { ref: gameLockRef, event: 'value', callback: gameLockCallback };
    gameLockRef.on('value', gameLockCallback);

    const lastOpenedBoxRef = db.ref('lastOpenedBox');
    const lastOpenedBoxCallback = snap => {
        const info = snap.val();
        if (info && (Date.now() - info.timestamp < 10000)) {
            if (info.content !== 'surpriz') {
                showGlobalOpenedBoxInfo(info);
            }
        }
    };
    activeListeners.lastOpenedBox = { ref: lastOpenedBoxRef, event: 'value', callback: lastOpenedBoxCallback };
    lastOpenedBoxRef.on('value', lastOpenedBoxCallback);
}

// --- SORUNLARI ÇÖZ MODALI İÇİN YENİ FONKSİYONLAR ---

function openSolveProblemsModal() {
    document.getElementById('solveProblemsModal').style.display = 'flex';
}

function closeSolveProblemsModal() {
    document.getElementById('solveProblemsModal').style.display = 'none';
}

async function manualUnlockGame() {
    const gameLockRef = db.ref('gameLock');
    const lockSnap = await gameLockRef.once('value');
    if (lockSnap.val() === true) {
        await gameLockRef.set(false);
        displayMessage("Oyun kilidi başarıyla kaldırıldı. Artık kutu açabilirsiniz.");
    } else {
        displayMessage("Oyun zaten kilitli değil, kutular şu anda açılabilir durumda.");
    }
    closeSolveProblemsModal();
}

// MEVCUT manualResetAfterSurprise FONKSİYONUNU SİL VE BUNUNLA DEĞİŞTİR
async function manualResetAfterSurprise() {
    const surpriseInfoRef = db.ref('gameStats/lastSurpriseInfo');
    const surpriseSnap = await surpriseInfoRef.once('value');
    if (surpriseSnap.exists()) {
        await surpriseInfoRef.update({ resettledBy: currentUser });
        displayMessage("Sıfırlama bilgisi kaydedildi. Lütfen oyunu sıfırlamak için Kutu Ayarları menüsündeki 'Oyunu Sıfırla' butonunu kullanın.");
    } else {
        displayMessage("Bu özellik sadece bir sürpriz kutu bulunduktan sonra kullanılabilir.");
    }
    closeSolveProblemsModal();
}

// BU YENİ FONKSİYONU SCRIPT BÖLÜMÜNÜN SONLARINA EKLE
function listenForLastSurpriseFinderPanel() {
    const ref = db.ref('gameStats/lastSurpriseInfo');
    const panel = document.getElementById('lastSurpriseFinderPanel');

    const callback = snap => {
        const data = snap.val();
        if (!data || !data.finder) {
            panel.classList.add('hidden');
            return;
        }

        let messageHtml = '';
        const finderHtml = `<b class="text-white text-lg">${data.finder}</b>`;

        if (data.boxId === 'Çark') {
            messageHtml = `
                <h4 class="text-amber-300 text-xl font-bold">🎡 SON SÜRPRİZ ÇARKTAN GELDİ! 🎡</h4>
                <p>${finderHtml}, çarkı çevirdi ve bir Sürpriz Kutu buldu!</p>
                <p>Kart seçiminden <b class="text-green-400">+${data.points} Puan</b> kazandı. <span class="text-gray-400">(Mevcut Puan: ${data.newBalance})</span></p>
            `;
        } 
        else {
            messageHtml = `
                <h4 class="text-amber-300 text-xl font-bold">🎉 SON SÜRPRİZ KUTUSU BULUNDU! 🎉</h4>
                <p>${finderHtml}, bu tur <b class="text-white">${data.boxesOpenedThisRound} adet</b> kutu açtıktan sonra <b class="text-white">${data.boxId} numaralı</b> kutudan Sürpriz Kutu buldu!</p>
                <p>Kart seçiminden <b class="text-green-400">+${data.points} Puan</b> kazandı. <span class="text-gray-400">(Mevcut Puan: ${data.newBalance})</span></p>
            `;
        }

        if (data.resettledBy) {
            messageHtml += `
                <hr class="border-gray-600 my-2">
                <p class="text-sm text-lime-400">Kutuları <b class="text-white">${data.resettledBy}</b> sıfırladı ve oyun yeniden başladı.</p>
            `;
        } else {
             messageHtml += `
                <hr class="border-gray-600 my-2">
                <p class="text-sm text-yellow-400 animate-pulse">Oyunun yeniden başlaması için bir oyuncunun 'Sorunları Çöz' menüsünden kutuları sıfırlaması gerekiyor.</p>
            `;
        }

        panel.innerHTML = messageHtml;
        panel.classList.remove('hidden');
    };
    
    if (activeListeners.surprisePanel) {
        activeListeners.surprisePanel.ref.off('value', activeListeners.surprisePanel.callback);
    }
    activeListeners.surprisePanel = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// YEPYENİ FONKSİYON - BU KOD BLOĞUNU OLDUĞU GİBİ EKLE
async function toggleGameLock() {
    if (!isAdmin) return;
    const gameLockRef = db.ref('gameLock');
    const lockSnap = await gameLockRef.once('value');
    const isCurrentlyLocked = lockSnap.val() === true;
    await gameLockRef.set(!isCurrentlyLocked);
    displayMessage(`Oyun kilidi başarıyla ${!isCurrentlyLocked ? 'aktif edildi' : 'kaldırıldı'}.`);
}

  // MEVCUT showGlobalOpenedBoxInfo FONKSİYONUNU SİLİP BUNU YAPIŞTIRIN

function showGlobalOpenedBoxInfo(info) {
    const isPlayingClickCatch = clickCatchGameActive || (lobbyGameSettings && lobbyGameSettings.state === 'active');
    if (isPlayingClickCatch) return;

    // YENİ EKLENEN KISIM: Modal yerine üstte çıkan bildirim bandını kullanacağız.
    const notificationMessage = `${info.opener}, ${info.boxId} numaralı kutuyu açtı.`;
    displayGlobalNotification(notificationMessage);

    // SİLİNEN KISIM: Artık modalı göstermeyeceğimiz için bu satırları siliyoruz.
    // document.getElementById('globalOpenedBoxInfoContent').innerHTML = contentHtml;
    // globalOpenedBoxInfoModal.style.display = 'flex';

    // DEĞİŞEN SATIR: Zamanlayıcı 3 saniyeye düşürüldü.
    let countdown = 3; 

    // Geri kalan zamanlayıcı mantığı aynı kalıyor, çünkü oyun kilidini bu yönetiyor.
    const countdownEl = document.getElementById('globalOpenedBoxCountdown'); // Bu element artık görünmese de sayaç çalışmaya devam eder.

    if(globalCountdownInterval) clearInterval(globalCountdownInterval);

    globalCountdownInterval = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
            clearInterval(globalCountdownInterval);
            // SİLİNEN SATIR: Modal artık olmadığı için kapatmaya gerek yok.
            // globalOpenedBoxInfoModal.style.display = 'none';
            
            // En önemli kısım: Süre dolduğunda oyun kilidini açar.
            db.ref('gameLock').set(false);
        }
    }, 1000);
}

    // YENİ DUYURU SİSTEMİ
    function resetAnnouncementForm() {
        document.getElementById('announcementText').value = '';
        document.getElementById('announcementFormTitle').textContent = 'Yeni Duyuru Yap';
        document.getElementById('postAnnouncementBtn').textContent = 'DUYURU YAP';
        document.getElementById('cancelEditAnnouncementBtn').classList.add('hidden');
        editingAnnouncementId = null;
    }

    async function postAnnouncement() {
        if (!isAdmin) return;
        const text = document.getElementById('announcementText').value.trim();
        if (!text) {
            displayMessage("Duyuru metni boş olamaz.");
            return;
        }

        const announcementData = {
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            likes: editingAnnouncementId ? (await db.ref(`announcements/${editingAnnouncementId}/likes`).once('value')).val() || 0 : 0,
            likedBy: editingAnnouncementId ? (await db.ref(`announcements/${editingAnnouncementId}/likedBy`).once('value')).val() || {} : {}
        };

        if (editingAnnouncementId) {
            await db.ref('announcements/' + editingAnnouncementId).update(announcementData);
            displayMessage("Duyuru başarıyla güncellendi.");
        } else {
            await db.ref('announcements').push(announcementData);
            displayMessage("Duyuru başarıyla yayınlandı.");
        }
        resetAnnouncementForm();
    }
    
    async function editAnnouncement(id) {
        const annSnap = await db.ref(`announcements/${id}`).once('value');
        const ann = annSnap.val();
        if (ann) {
            editingAnnouncementId = id;
            document.getElementById('announcementText').value = ann.text;
            document.getElementById('announcementFormTitle').textContent = 'Duyuruyu Düzenle';
            document.getElementById('postAnnouncementBtn').textContent = 'GÜNCELLE';
            document.getElementById('cancelEditAnnouncementBtn').classList.remove('hidden');
            document.getElementById('adminAnnouncementControls').scrollIntoView({ behavior: 'smooth' });
        }
    }

    async function deleteAnnouncement(id) {
        if (!isAdmin) return;
        if (await customConfirm("Bu duyuruyu silmek istediğinizden emin misiniz?")) {
            await db.ref('announcements/' + id).remove();
            displayMessage("Duyuru silindi.");
        }
    }
    
    function loadAnnouncements() {
        const listEl = document.getElementById('announcementsList');
        const userRef = db.ref(`users/${currentUser}`);
        const ref = db.ref('announcements').orderByChild('timestamp');

        const callback = async (snap) => {
            listEl.innerHTML = '';
            const announcements = snap.val();

            if (!announcements) {
                listEl.innerHTML = '<p class="text-center text-gray-400">Henüz yayınlanmış bir duyuru yok.</p>';
                return;
            }
            
            const userSnap = await userRef.once('value');
            const userData = userSnap.val() || {};
            const likedAnnouncements = userData.likedAnnouncements || {};
            
            const sortedAnnouncements = Object.entries(announcements).sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            sortedAnnouncements.forEach(([id, ann]) => {
                const date = new Date(ann.timestamp).toLocaleString('tr-TR');
                const processedText = ann.text.replace(/@(\w+)/g, (match, username) => {
                    const isCurrentUserMention = username.toLowerCase() === (currentUser || '').toLowerCase();
                    const highlightClass = isCurrentUserMention ? 'user-mention highlighted' : 'user-mention';
                    return `<span class="${highlightClass}" data-username="${username}">${match}</span>`;
                });
                
                let adminButtons = '';
                if(isAdmin) {
                    adminButtons = `
                        <button onclick="editAnnouncement('${id}')" class="py-1 px-3 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-md">Düzenle</button>
                        <button onclick="deleteAnnouncement('${id}')" class="py-1 px-3 bg-red-600 hover:bg-red-500 text-white text-xs font-bold rounded-md">Sil</button>
                    `;
                }

                const isLiked = likedAnnouncements[id] && !isAdmin;
                const likeButtonClass = isLiked ? 'bg-blue-600 text-white' : 'bg-gray-600 hover:bg-gray-500 text-gray-300';
                const likeButtonText = isLiked ? 'Beğenildi' : 'Beğen';

                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-6 rounded-lg border-l-4 border-yellow-500 shadow-lg';
                div.innerHTML = `
                    <p class="text-lg text-gray-200 mb-4 whitespace-pre-wrap">${processedText}</p>
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-700">
                        <p class="text-xs text-gray-500">${date}</p>
                        <div class="flex items-center gap-4">
                             <a onclick="showAnnouncementLikes('${id}')" class="cursor-pointer font-bold text-yellow-400 hover:text-yellow-300">${ann.likes || 0} Beğeni</a>
                             ${!isAdmin ? `
                             <button id="likeBtn-${id}" onclick="likeAnnouncement('${id}')" class="${likeButtonClass} px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.562 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.82 2.316l-1.09 1.817c-.381.636-.632 1.356-.632 2.146z" /></svg>
                                ${likeButtonText}
                            </button>
                             ` : adminButtons}
                        </div>
                    </div>
                `;
                listEl.appendChild(div);
            });
            
            listEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('user-mention')) {
                    const usernameToView = e.target.dataset.username;
                    if (usernameToView) {
                        openPublicUserDetailModal(usernameToView.toLowerCase());
                    }
                }
            });
        };

        activeListeners.announcements = { ref, event: 'value', callback };
        ref.on('value', callback);
    }

    async function likeAnnouncement(announcementId) {
        if (isAdmin) {
            displayMessage("Adminler beğeni yapamaz.");
            return;
        }

        const userLikeRef = db.ref(`users/${currentUser}/likedAnnouncements/${announcementId}`);
        const userLikeSnap = await userLikeRef.once('value');
        const announcementRef = db.ref(`announcements/${announcementId}`);

        if (userLikeSnap.exists()) {
            await userLikeRef.remove();
            await db.ref(`announcements/${announcementId}/likedBy/${currentUser}`).remove();
            await announcementRef.child('likes').transaction(currentLikes => (currentLikes || 0) - 1);
        } else {
            await userLikeRef.set(true);
            await db.ref(`announcements/${announcementId}/likedBy/${currentUser}`).set(true);
            await announcementRef.child('likes').transaction(currentLikes => (currentLikes || 0) + 1);
        }
    }
    
    function listenForNewAnnouncements() {
    const ref = db.ref('announcements').orderByChild('timestamp').limitToLast(1);
    const userRef = db.ref(`users/${currentUser}`);

    const callback = async (snap) => {
        if (!snap.exists()) return;

        const latestAnnKey = Object.keys(snap.val())[0];
        const latestAnn = snap.val()[latestAnnKey];
        latestAnnouncementTimestamp = latestAnn.timestamp;
        
        const userSnap = await userRef.once('value');
        const userData = userSnap.val();
        
        if (userData && latestAnn.timestamp > (userData.lastSeenAnnouncementTimestamp || 0)) {
            // Sadece modal kapalıysa ve duyuru sekmesinde değilsek göster
            const isModalHidden = document.getElementById('newAnnouncementModal').style.display !== 'flex';
            if (currentActiveSection !== 'announcements' && isModalHidden) {
                document.getElementById('newAnnouncementText').textContent = latestAnn.text.substring(0, 250) + (latestAnn.text.length > 250 ? '...' : '');
                newAnnouncementModal.style.display = 'flex';
            }
            document.getElementById('announcementIndicator').classList.remove('hidden');
        }
    };

    if (activeListeners.newAnnouncements) {
        activeListeners.newAnnouncements.ref.off(activeListeners.newAnnouncements.event, activeListeners.newAnnouncements.callback);
    }
    activeListeners.newAnnouncements = { ref, event: 'value', callback };
    ref.on('value', callback);
}

    function listenForNewStoreItems() {
    const ref = db.ref('storeItems').orderByChild('createdAt').limitToLast(1);
    const userRef = db.ref(`users/${currentUser}`);

    const callback = async (snap) => {
        if (!snap.exists()) return;

        const latestItemKey = Object.keys(snap.val())[0];
        const latestItem = snap.val()[latestItemKey];
        latestStoreItemTimestamp = latestItem.createdAt;

        const userSnap = await userRef.once('value');
        const userData = userSnap.val();

        if (userData && latestItem.createdAt > (userData.lastSeenStoreTimestamp || 0)) {
            document.getElementById('storeIndicator').classList.remove('hidden');
        }
    };

    if (activeListeners.newStoreItems) {
        activeListeners.newStoreItems.ref.off(activeListeners.newStoreItems.event, activeListeners.newStoreItems.callback);
    }
    activeListeners.newStoreItems = { ref, event: 'value', callback };
    ref.on('value', callback);
}

    function closeNewAnnouncementModal() {
    newAnnouncementModal.style.display = 'none';
    if (!isAdmin) {
        db.ref(`users/${currentUser}/lastSeenAnnouncementTimestamp`).set(latestAnnouncementTimestamp);
    }
}
    
    function goToAnnouncements() {
    closeNewAnnouncementModal();
    showSection('announcements');
}

    async function openUnopenedBoxContentsModal() {
    const listEl = document.getElementById('unopenedBoxContentsList');
    listEl.innerHTML = 'Yükleniyor...';
    
    try {
        const configSnap = await db.ref('gameConfig/boxContents').once('value');
        const defaultBoxConfig = [ { type: 'surpriz', value: 0, count: 1 }, { type: 'points', value: 1000, count: 2 }, { type: 'iflas', count: 2 }, { type: 'points', value: 750, count: 4 }, { type: 'points', value: 500, count: 6 }, { type: 'points', value: 250, count: 8 }, { type: 'points', value: 100, count: 10 }, { type: 'points', value: 50, count: 15 }, { type: 'points', value: 10, count: 20 }, { type: 'points', value: 1, count: 30 }, { type: 'multiplier', value: 2, count: 1 }, { type: 'multiplier', value: 3, count: 1 } ];
        const boxConfig = configSnap.exists() ? configSnap.val() : defaultBoxConfig;

        const boxesSnap = await db.ref('boxes').once('value');
        const currentBoxes = boxesSnap.val();

        const remainingContents = {};

        // 1. Başlangıçtaki tüm içerikleri say
        boxConfig.forEach(item => {
            const key = `${item.type}-${item.value}`;
            remainingContents[key] = (remainingContents[key] || 0) + item.count;
        });

        // 2. Açılmış kutuları bu sayıdan düş
        if (currentBoxes) {
            currentBoxes.forEach(box => {
                if (box.opened) {
                    const key = `${box.content}-${box.value}`;
                    if (remainingContents[key]) {
                        remainingContents[key]--;
                    }
                }
            });
        }
        
        // 3. Sonuçları ekrana yazdır
        listEl.innerHTML = '';
        let html = '';
        Object.entries(remainingContents).forEach(([key, count]) => {
            if (count > 0) {
                const [type, value] = key.split('-');
                let label = '';
                let icon = '❓';
                switch(type) {
                    case 'points': label = `${value} Puan`; icon = '💰'; break;
                    case 'iflas': label = 'İflas (Bomba)'; icon = '💣'; break;
                    case 'surpriz': label = 'Sürpriz Kutu'; icon = '🎉'; break;
                    case 'multiplier': label = `${value}x Çarpan`; icon = '✖️'; break;
                    case 'iflasShield': label = 'İflas Kalkanı'; icon = '🛡️'; break;
                    case 'wheelTicket': label = 'Çark Bileti'; icon = '️🎫'; break;
                    case 'clickCatchTicket': label = 'Tıkla-Yakala Bileti'; icon = '🎟️'; break;
                }
                html += `<p class="flex justify-between items-center p-2 bg-gray-800 rounded mb-2 text-white"><span>${icon} ${label}</span> <span class="font-bold text-yellow-300">${count} Adet</span></p>`;
            }
        });

        listEl.innerHTML = html || '<p class="text-center text-gray-400">Tüm kutular açılmış!</p>';

    } catch (error) {
        console.error("Kalan içerik yüklenirken hata:", error);
        listEl.innerHTML = '<p class="text-red-500">İçerik yüklenemedi.</p>';
    }

    document.getElementById('unopenedBoxContentsModal').style.display = 'flex';
}

    function closeUnopenedBoxContentsModal() {
    document.getElementById('unopenedBoxContentsModal').style.display = 'none';
}

    async function showAnnouncementLikes(announcementId) {
        const likesRef = db.ref(`announcements/${announcementId}/likedBy`);
        const likesSnap = await likesRef.once('value');
        const likers = likesSnap.val();
        
        const listEl = document.getElementById('announcementLikesList');
        listEl.innerHTML = '';

        if (!likers) {
            listEl.innerHTML = '<p class="text-gray-400">Bu duyuruyu henüz kimse beğenmedi.</p>';
        } else {
            const usernames = Object.keys(likers);
            usernames.forEach(username => {
                listEl.innerHTML += `<div class="p-2 bg-gray-800 rounded mb-2 text-white">${username}</div>`;
            });
        }
        
        announcementLikesModal.style.display = 'flex';
    }

    function closeAnnouncementLikesModal() {
        announcementLikesModal.style.display = 'none';
    }


    // YENİ GÜNLÜK ÖDÜL SİSTEMİ (ZAMAN AYARLI)
    function openNewDailyRewardForm() {
        resetDailyRewardForm();
        openAdminDailyRewardModal();
    }

    function openAdminDailyRewardModal() {
        adminDailyRewardModal.style.display = 'flex';
    }
    function closeAdminDailyRewardModal() {
        adminDailyRewardModal.style.display = 'none';
    }

    // DEĞİŞTİRİLECEK FONKSİYON
function closeDailyRewardModal() { 
    Object.values(activeDailyRewardTimers).forEach(clearInterval);
    activeDailyRewardTimers = {};
    const dailyRewardModal = document.getElementById('dailyRewardModal');
    if (dailyRewardModal) {
        dailyRewardModal.style.display = 'none'; 
    }
}
    
    async function checkAvailableDailyRewards() {
        if (isAdmin) {
            document.getElementById('dailyRewardIndicator').classList.add('hidden');
            return;
        }

        const userSnap = await db.ref('users/' + currentUser).once('value');
        const user = userSnap.val();
        const rewardsSnap = await db.ref('dailyRewardOptions').once('value');
        const rewards = rewardsSnap.val();

        if (!rewards || !user) {
            document.getElementById('dailyRewardIndicator').classList.add('hidden');
            return;
        }

        const userClaims = user.dailyRewardsClaimed || {};
        let hasAvailableReward = false;

        for (const rewardId in rewards) {
            const reward = rewards[rewardId];
            const cooldown = reward.cooldownMs || 0;
            const lastClaim = userClaims[rewardId] || 0;
            if (Date.now() > lastClaim + cooldown) {
                hasAvailableReward = true;
                break;
            }
        }
        
        if (hasAvailableReward) {
            document.getElementById('dailyRewardIndicator').classList.remove('hidden');
        } else {
            document.getElementById('dailyRewardIndicator').classList.add('hidden');
        }
    }
    
async function openDailyRewardModal() {
    const dailyRewardModal = document.getElementById('dailyRewardModal');
    // YENİ GÜVENLİK KONTROLÜ: Elementin var olduğundan emin ol
    if (!dailyRewardModal) {
        console.error("HATA: 'dailyRewardModal' elementi HTML'de bulunamadı!");
        displayMessage("Günlük ödül penceresi açılamadı. Lütfen sayfayı yenileyin.");
        return;
    }

    dailyRewardModal.style.display = 'flex';
    const container = document.getElementById('dailyRewardItemsContainer');
    container.innerHTML = '<p class="text-center col-span-full text-gray-400">Ödüller yükleniyor...</p>';
    document.getElementById('dailyRewardMessage').textContent = 'Aşağıdaki ödüllerden alabileceklerini topla. Bol şans!';

    if (isAdmin) {
        document.getElementById('adminDailyRewardManagementButtonContainer').classList.remove('hidden');
    } else {
        document.getElementById('adminDailyRewardManagementButtonContainer').classList.add('hidden');
    }

    try {
        const userSnap = await db.ref('users/' + currentUser).once('value');
        const user = userSnap.val();
        const rewardsRef = db.ref('dailyRewardOptions');
        const rewardsSnap = await rewardsRef.orderByChild('order').once('value');
        
        if (!rewardsSnap.exists()) {
            container.innerHTML = '<p class="text-center col-span-full">Şu anda mevcut bir günlük ödül bulunmamaktadır.</p>';
            return;
        }

        container.innerHTML = ''; 

        const rewardsArray = [];
        rewardsSnap.forEach(childSnap => {
            rewardsArray.push([childSnap.key, childSnap.val()]);
        });

        const userClaims = user ? (user.dailyRewardsClaimed || {}) : {};
        
        rewardsArray.forEach(([rewardId, reward], index) => {
            const lastClaim = userClaims[rewardId] || 0;
            const cooldown = reward.cooldownMs || 0;
            const nextAvailableTime = lastClaim + cooldown;
            const canClaim = isAdmin ? false : (Date.now() > nextAvailableTime);

            const card = document.createElement('div');
            card.className = 'relative bg-gray-900 p-4 rounded-xl shadow-lg border border-yellow-600 text-center flex flex-col justify-between';
            
            let adminControlsHtml = '';
            if(isAdmin){
                const leftArrowDisabled = index === 0 ? 'disabled' : '';
                const rightArrowDisabled = index === rewardsArray.length - 1 ? 'disabled' : '';
                
                adminControlsHtml = `
                  <div class="admin-controls absolute top-0 right-0 p-1 bg-gray-900 bg-opacity-70 rounded-bl-lg flex gap-1 z-10">
                      <button onclick="reorderDailyRewardItem('${rewardId}', ${index - 1})" ${leftArrowDisabled} title="Sola Taşı" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/></svg></button>
                      <button onclick="editDailyReward('${rewardId}')" title="Düzenle" class="p-1 rounded-full hover:bg-gray-700"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 12V7a1 1 0 011-1h2.586l-2 2H6v3h3v-1.586l2-2H13a1 1 0 011 1v5a1 1 0 01-1 1H6a1 1 0 01-1-1v-2z"/></svg></button>
                      <button onclick="removeDailyReward('${rewardId}')" title="Sil" class="p-1 rounded-full hover:bg-gray-700"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M6 2l2-2h4l2 2h4v2H2V2h4zM3 6h14l-1 14H4L3 6zm5 2v10h1V8H8zm3 0v10h1V8h-1z"/></svg></button>
                      <button onclick="reorderDailyRewardItem('${rewardId}', ${index + 1})" ${rightArrowDisabled} title="Sağa Taşı" class="p-1 rounded-full hover:bg-gray-700 disabled:cursor-not-allowed"><svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg></button>
                  </div>`;
            }

            // DÜZELTME: Butona benzersiz bir ID eklendi.
            let buttonHTML = '<button id="claim-reward-btn-' + rewardId + '" onclick="claimDailyReward(\'' + rewardId + '\')" class="w-full py-2 mt-auto bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition duration-300">Ödülü Al</button>';
            let cooldownHTML = '<div class="text-sm text-gray-500 font-bold mb-3 h-5">Süre: ' + (reward.cooldownText || 'Tek Seferlik') + '</div>';

            if (isAdmin || !canClaim) {
                const disabledState = isAdmin ? 'disabled' : '';
                buttonHTML = '<button ' + disabledState + ' class="w-full py-2 mt-auto bg-gray-600 cursor-not-allowed text-white font-bold rounded-lg transition duration-300">' + (isAdmin ? 'Admin' : 'Alındı') + '</button>';

                if (!isAdmin) {
                   cooldownHTML = '<div id="reward-cooldown-' + rewardId + '" class="text-sm text-yellow-300 font-bold mb-3 h-5"></div>';
                    
                    if (activeDailyRewardTimers[rewardId]) clearInterval(activeDailyRewardTimers[rewardId]);

                    const timerId = setInterval(() => {
                        const now = Date.now();
                        const timeLeft = nextAvailableTime - now;
                        const el = document.getElementById('reward-cooldown-' + rewardId);
                        if (!el) {
                            clearInterval(timerId);
                            return;
                        }

                        if (timeLeft <= 0) {
                            el.innerHTML = '<span class="text-green-400">Şimdi Alınabilir!</span>';
                            // DÜZELTME: Süre dolduğunda butonun ID'sini de ekliyoruz.
                            const claimButton = el.closest('.relative').querySelector('button');
                            if (claimButton) {
                                claimButton.id = 'claim-reward-btn-' + rewardId; // ID'yi yeniden ata
                                claimButton.disabled = false;
                                claimButton.onclick = () => claimDailyReward(rewardId);
                                claimButton.classList.replace('bg-gray-600', 'bg-green-600');
                                claimButton.classList.add('hover:bg-green-500');
                                claimButton.textContent = 'Ödülü Al';
                            }
                            clearInterval(timerId);
                        } else {
                            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                            
                            let parts = [];
                            if (days > 0) parts.push(days + 'g');
                            if (hours > 0) parts.push(hours + 'sa');
                            if (minutes > 0) parts.push(minutes + 'd');
                            if (seconds >= 0) parts.push(seconds + 'sn');

                            el.textContent = 'Kalan Süre: ' + parts.join(' ');
                        }
                    }, 1000);
                    activeDailyRewardTimers[rewardId] = timerId;
                }
            }

            card.innerHTML = `
                ${adminControlsHtml}
                <div>
                    <img src="${reward.imageUrl || 'https://via.placeholder.com/150'}" alt="${reward.name}" class="w-20 h-20 mx-auto mb-3 rounded-lg object-cover">
                    <h4 class="text-yellow-300 text-lg font-bold">${reward.name}</h4>
                    <p class="text-gray-400 text-sm mb-3">${reward.description}</p>
                    ${cooldownHTML}
                </div>
                ${buttonHTML}
            `;
            container.appendChild(card);
        });
    } catch (error) {
        console.error("Günlük ödüller yüklenirken bir hata oluştu:", error);
        container.innerHTML = '<p class="text-center col-span-full text-red-500">Ödüller yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyin.</p>';
    }
}

// MEVCUT claimDailyReward FONKSİYONUNU SİLİP BUNUNLA DEĞİŞTİRİN

async function claimDailyReward(rewardId) {
    if (isAdmin) return;

    const claimButton = document.getElementById(`claim-reward-btn-${rewardId}`);
    if (claimButton && claimButton.disabled) {
        return; 
    }
    if (claimButton) {
        claimButton.disabled = true;
        claimButton.textContent = 'İşleniyor...';
    }

    try {
        const userRef = db.ref('users/' + currentUser);
        const rewardRef = db.ref('dailyRewardOptions/' + rewardId);

        const [userSnap, rewardSnap] = await Promise.all([userRef.once('value'), rewardRef.once('value')]);
        const user = userSnap.val();
        const reward = rewardSnap.val();

        if (!reward) {
            throw new Error("Ödül bulunamadı.");
        }

        const lastClaim = (user.dailyRewardsClaimed && user.dailyRewardsClaimed[rewardId]) || 0;
        const cooldown = reward.cooldownMs || 0;

        if (Date.now() < lastClaim + cooldown) {
            displayMessage("Bu ödül için bekleme süresi henüz dolmadı.");
            if (claimButton) {
                claimButton.disabled = false;
                claimButton.textContent = 'Ödülü Al';
            }
            return;
        }

        if (reward.type === 'tempMultiplier') {
            if (user.multiplierSource && user.multiplierSource !== 'none') {
                
                if (reward.value === user.activeMultiplier) { // Stackleme
                    const confirmedStack = await customConfirm(`Zaten ${user.activeMultiplier}x çarpanın var. Bu ödül, mevcut çarpanına <b>+${reward.uses} kullanım hakkı</b> ekleyecek. Onaylıyor musun?`);
                    if (!confirmedStack) {
                        if (claimButton) { claimButton.disabled = false; claimButton.textContent = 'Ödülü Al'; }
                        return;
                    }
                    await userRef.update({ multiplierRemainingUses: (user.multiplierRemainingUses || 0) + reward.uses });
                } 
                else if (reward.value > user.activeMultiplier) { // Yükseltme
                    const kutuHakkiDonusum = user.multiplierRemainingUses || 0;
                    const confirmedUpgrade = await customConfirm(`Mevcut ${user.activeMultiplier}x çarpanını daha yüksek olan <b>${reward.value}x</b> ile değiştirmek üzeresin. Mevcut çarpanının kalan <b>${user.multiplierRemainingUses} kullanım hakkı</b>, envanterine <b>+${kutuHakkiDonusum} Kutu Hakkı</b> olarak eklenecek. Onaylıyor musun?`);
                    if (!confirmedUpgrade) {
                        if (claimButton) { claimButton.disabled = false; claimButton.textContent = 'Ödülü Al'; }
                        return;
                    }
                    await userRef.update({
                        kutuHakki: (user.kutuHakki || 0) + kutuHakkiDonusum,
                        activeMultiplier: reward.value,
                        multiplierRemainingUses: reward.uses,
                        multiplierSource: 'store'
                    });
                } 
                // --- DEĞİŞEN KISIM BAŞLANGICI: Düşük çarpanı kutu hakkına dönüştürme ---
                else { 
                    const kutuHakkiDonusum = reward.uses || 0;
                    const confirmedConvert = await customConfirm(`Mevcut <b>${user.activeMultiplier}x</b> çarpanın bu <b>${reward.value}x</b> ödülünden daha güçlü. Bu ödülü alırsan, çarpanın değişmeyecek ancak ödülün <b>${kutuHakkiDonusum} kullanım hakkı</b>, envanterine <b>+${kutuHakkiDonusum} Kutu Hakkı</b> olarak eklenecek. Onaylıyor musun?`);
                    
                    if (!confirmedConvert) {
                        if (claimButton) { claimButton.disabled = false; claimButton.textContent = 'Ödülü Al'; }
                        return;
                    }

                    // Yeni eylem türü ile log'luyoruz
                    logActivity('multiplierConvertedToBoxRights', currentUser, {
                        rewardValue: reward.value,
                        boxRights: kutuHakkiDonusum
                    });

                    // Sadece kutu hakkını güncelliyoruz
                    await userRef.update({
                        kutuHakki: (user.kutuHakki || 0) + kutuHakkiDonusum
                    });

                    // Ödülü alındı olarak işaretle ve işlemi bitir
                    await db.ref(`users/${currentUser}/dailyRewardsClaimed/${rewardId}`).set(firebase.database.ServerValue.TIMESTAMP);
                    displayMessage(`Başarılı! ${reward.name} ödülü, envanterinize +${kutuHakkiDonusum} Kutu Hakkı olarak eklendi.`);
                    closeDailyRewardModal();
                    checkAvailableDailyRewards();
                    return;
                }
                // --- DEĞİŞEN KISIM SONU ---
            }
        }
        
        let updates = {};
        let message = `Tebrikler! Günlük ödül olarak <b>${reward.name}</b> kazandın.`;

        switch (reward.type) {
            case 'points':
                updates['balance'] = (user.balance || 0) + reward.value;
                if (updates['balance'] > (user.highestBalanceEver || 0)) {
                    updates['highestBalanceEver'] = updates['balance'];
                }
                break;
            case 'boxRights':
                updates['kutuHakki'] = (user.kutuHakki || 0) + reward.value;
                break;
            case 'wheelTicket':
                updates['carkBileti'] = (user.carkBileti || 0) + reward.value;
                break;
            case 'clickCatchTicket':
                updates['clickCatchTickets'] = (user.clickCatchTickets || 0) + reward.value;
                break;
            case 'iflasShield':
                updates['iflasShieldUses'] = (user.iflasShieldUses || 0) + reward.value;
                break;
            case 'tempMultiplier':
                updates['activeMultiplier'] = reward.value;
                updates['multiplierRemainingUses'] = reward.uses;
                updates['multiplierSource'] = 'store';
                break;
        }

        const logDetails = { 
            rewardName: reward.name, 
            rewardType: reward.type, 
            rewardValue: reward.value 
        };
        if (reward.type === 'tempMultiplier') {
            logDetails.rewardUses = reward.uses;
        }
        if (reward.type === 'points') {
            logDetails.newBalance = updates.balance;
        }
        logActivity('dailyReward', currentUser, logDetails);
        
        await userRef.update(updates);
        await db.ref(`users/${currentUser}/dailyRewardsClaimed/${rewardId}`).set(firebase.database.ServerValue.TIMESTAMP);

        displayMessage(message);
        closeDailyRewardModal();
        checkAvailableDailyRewards();

    } catch (error) {
        console.error("Günlük ödül alınırken hata:", error);
        displayMessage("Ödül alınırken bir hata oluştu. Lütfen tekrar deneyin.");
        if (claimButton) {
            claimButton.disabled = false;
            claimButton.textContent = 'Ödülü Al';
        }
    }
}

    function resetDailyRewardForm() {
      document.getElementById('dailyRewardName').value = '';
      document.getElementById('dailyRewardDescription').value = '';
      document.getElementById('dailyRewardType').value = '';
      document.getElementById('dailyRewardValue').value = '';
      document.getElementById('dailyRewardMultiplierUses').value = '';
      document.getElementById('dailyRewardCooldownDays').value = '';
      document.getElementById('dailyRewardCooldownHours').value = '';
      document.getElementById('dailyRewardCooldownMinutes').value = '';
      document.getElementById('dailyRewardCooldownSeconds').value = '';
      document.getElementById('dailyRewardImageUrl').value = '';
      document.getElementById('saveDailyRewardBtn').textContent = 'GÜNLÜK ÖDÜL OLUŞTUR';
      document.getElementById('dailyRewardMultiplierUses').classList.add('hidden');
      editingDailyRewardId = null;
    }

    async function saveDailyReward() {
        if (!isAdmin) return;
        
        const name = document.getElementById('dailyRewardName').value.trim();
        const type = document.getElementById('dailyRewardType').value;
        const value = parseInt(document.getElementById('dailyRewardValue').value);
        const description = document.getElementById('dailyRewardDescription').value.trim();
        const imageUrl = document.getElementById('dailyRewardImageUrl').value.trim();
        
        const days = parseInt(document.getElementById('dailyRewardCooldownDays').value) || 0;
        const hours = parseInt(document.getElementById('dailyRewardCooldownHours').value) || 0;
        const minutes = parseInt(document.getElementById('dailyRewardCooldownMinutes').value) || 0;
        const seconds = parseInt(document.getElementById('dailyRewardCooldownSeconds').value) || 0;

        if (!name || !type || isNaN(value) || value <= 0 || !description) {
            displayMessage("Lütfen ödül için tüm zorunlu alanları (Ad, Tip, Değer, Açıklama) geçerli bir şekilde doldurun.");
            return;
        }

        const cooldownMs = (days * 24 * 3600 + hours * 3600 + minutes * 60 + seconds) * 1000;
        let cooldownText = '';
        if(days > 0) cooldownText += `${days}g `;
        if(hours > 0) cooldownText += `${hours}s `;
        if(minutes > 0) cooldownText += `${minutes}d `;
        if(seconds > 0) cooldownText += `${seconds}sn`;
        if (cooldownText === '') cooldownText = 'Tek Seferlik';


        const rewardData = { name, type, value, description, cooldownMs, cooldownText, imageUrl: imageUrl || 'https://via.placeholder.com/150' };

        if (editingDailyRewardId) {
            const existingRewardSnap = await db.ref('dailyRewardOptions/' + editingDailyRewardId).once('value');
            const existingReward = existingRewardSnap.val();
            rewardData.order = existingReward.order;
        } else {
            const maxOrderSnap = await db.ref('dailyRewardOptions').orderByChild('order').limitToLast(1).once('value');
            let maxOrder = -1;
            if(maxOrderSnap.exists()){
                maxOrder = Object.values(maxOrderSnap.val())[0].order || 0;
            }
            rewardData.order = maxOrder + 1;
        }

        if (type === 'tempMultiplier') {
            const uses = parseInt(document.getElementById('dailyRewardMultiplierUses').value);
            if (isNaN(uses) || uses <= 0) {
                displayMessage("Çarpan için geçerli bir kullanım hakkı sayısı girin.");
                return;
            }
            rewardData.uses = uses;
        }
        
        if (editingDailyRewardId) {
            await db.ref('dailyRewardOptions/' + editingDailyRewardId).update(rewardData);
            displayMessage("Günlük ödül başarıyla güncellendi.");
        } else {
            await db.ref('dailyRewardOptions').push(rewardData);
            displayMessage("Yeni günlük ödül başarıyla oluşturuldu.");
        }
        
        resetDailyRewardForm();
        closeAdminDailyRewardModal();
        openDailyRewardModal();
    }
    
    // DEĞİŞTİRİLECEK FONKSİYON
async function reorderDailyRewardItem(rewardId, newIndex) {
    if (!isAdmin) return;
    const rewardsRef = db.ref('dailyRewardOptions');
    const rewardsSnap = await rewardsRef.once('value');
    const rewards = rewardsSnap.val();
    if (!rewards) return;

    let sortedRewards = Object.entries(rewards).sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));
    
    const itemToMoveIndex = sortedRewards.findIndex(([id]) => id === rewardId);
    if (itemToMoveIndex === -1) return;

    if (newIndex < 0 || newIndex >= sortedRewards.length) return;

    const [movedItem] = sortedRewards.splice(itemToMoveIndex, 1);
    sortedRewards.splice(newIndex, 0, movedItem);

    const updates = {};
    sortedRewards.forEach(([id], index) => {
      updates[`dailyRewardOptions/${id}/order`] = index;
    });
    
    await db.ref().update(updates);
}

    async function editDailyReward(rewardId) {
        if (!isAdmin) return;
        
        const rewardSnap = await db.ref('dailyRewardOptions/' + rewardId).once('value');
        const reward = rewardSnap.val();
        if (!reward) {
            displayMessage("Düzenlenecek ödül bulunamadı.");
            return;
        }
        
        document.getElementById('dailyRewardName').value = reward.name;
        document.getElementById('dailyRewardDescription').value = reward.description;
        document.getElementById('dailyRewardType').value = reward.type;
        document.getElementById('dailyRewardValue').value = reward.value;
        document.getElementById('dailyRewardImageUrl').value = reward.imageUrl || '';
        
        const cooldownMs = reward.cooldownMs || 0;
        const days = Math.floor(cooldownMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((cooldownMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((cooldownMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((cooldownMs % (1000 * 60)) / 1000);

        document.getElementById('dailyRewardCooldownDays').value = days;
        document.getElementById('dailyRewardCooldownHours').value = hours;
        document.getElementById('dailyRewardCooldownMinutes').value = minutes;
        document.getElementById('dailyRewardCooldownSeconds').value = seconds;

        const usesInput = document.getElementById('dailyRewardMultiplierUses');
        if (reward.type === 'tempMultiplier') {
            usesInput.classList.remove('hidden');
            usesInput.value = reward.uses || '';
        } else {
            usesInput.classList.add('hidden');
        }

        document.getElementById('saveDailyRewardBtn').textContent = 'ÖDÜLÜ GÜNCELLE';
        editingDailyRewardId = rewardId;
        
        openAdminDailyRewardModal(); 
        document.querySelector('#adminDailyRewardModal .modal-content').scrollTop = 0;
    }

    async function removeDailyReward(rewardId) {
        if (!isAdmin) return;
        if (await customConfirm("Bu günlük ödülü silmek istediğinizden emin misiniz?")) {
            await db.ref('dailyRewardOptions/' + rewardId).remove();
            displayMessage("Günlük ödül kaldırıldı.");
            openDailyRewardModal();
        }
    }
  
    function listenForDailyRewardChanges() {
        const ref = db.ref('dailyRewardOptions');
        const callback = snap => {
            if (dailyRewardModal.style.display === 'flex') {
                openDailyRewardModal();
            }
            checkAvailableDailyRewards();
        };
        activeListeners.dailyRewards = { ref, event: 'value', callback };
        ref.on('value', callback);
    }
  
    function listenForAdminNotifications() {
      const ref = db.ref(`users/${currentUser}/notifications`);
      const callback = snap => {
          const notification = snap.val();
          if (notification && notification.message) {
              displayMessage(notification.message);
              snap.ref.remove();
          }
      };
      activeListeners.adminNotifications = { ref: ref.orderByChild('timestamp').startAt(sessionStartTime), event: 'child_added', callback };
      ref.orderByChild('timestamp').startAt(sessionStartTime).on('child_added', callback);
  }
  
    function openBoxStatsModal() {
      const listEl = document.getElementById('boxStatsList');
      listEl.innerHTML = 'Yükleniyor...';
      db.ref('gameStats/boxesOpenedByUsers').orderByValue().once('value').then(snap => {
          const stats = snap.val();
          if (!stats) {
              listEl.innerHTML = '<p class="text-center text-gray-400">Bu turda henüz kimse kutu açmadı.</p>';
          } else {
              let html = '';
              const sortedUsers = Object.entries(stats).sort(([, countA], [, countB]) => countB - countA);
              sortedUsers.forEach(([user, count]) => {
                  html += `<p class="p-2 bg-gray-800 rounded mb-2">${user}: <span class="font-bold text-yellow-300">${count}</span> kutu</p>`;
              });
              listEl.innerHTML = html;
          }
          boxStatsModal.style.display = 'flex';
      });
    }
    function closeBoxStatsModal() {
      boxStatsModal.style.display = 'none';
    }

    let surpriseSessionListener = null;

function openSpectatorModal(sessionData) {
    if (spectatorCountdownInterval) clearInterval(spectatorCountdownInterval);

    document.getElementById('spectatorTitle').innerHTML = `<span class="text-green-400 font-bold">${sessionData.user}</span> Sürpriz Kutu buldu!`;
    const cardContainer = document.getElementById('spectatorCardContainer');
    cardContainer.innerHTML = '';

    sessionData.cards.forEach((cardValue, index) => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card bg-gray-700 border-2 border-red-700 rounded-xl w-28 h-40 flex flex-col items-center justify-center font-bold text-2xl relative';
        cardDiv.id = `spectator-card-${index}`;
        cardDiv.innerHTML = `<div class="card-back absolute inset-0 bg-gradient-to-br from-red-700 to-red-900 flex items-center justify-center text-white text-5xl">?</div><div class="card-front absolute inset-0 bg-gray-900 flex items-center justify-center text-yellow-400 text-3xl"></div>`;
        cardContainer.appendChild(cardDiv);
    });
    
    const resultContainer = document.getElementById('spectatorResultContainer');
    resultContainer.innerHTML = '<p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8"></p>';

    const countdownEl = document.getElementById('spectatorCountdown');
    let timeLeft = Math.round((sessionData.expirationTimestamp - getSyncedTime()) / 1000);

    const handleTimeout = () => {
        countdownEl.textContent = 'Süre Doldu!';
        // --- YENİ EKLENEN KISIM ---
        const resultP = document.getElementById('spectatorResult');
        if (resultP) {
            resultP.textContent = 'Kart seçilmedi, puan kazanılamadı.';
            resultP.className = 'text-xl text-red-400 font-bold h-8';
        }
        // --- YENİ KISIM SONU ---
        resultContainer.innerHTML += `<button onclick="closeSpectatorModal()" class="mt-4 py-3 px-8 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg transition-colors">Oyuna Dön</button>`;
    };
    
    if (timeLeft <= 0) {
        handleTimeout();
        spectatorModal.style.display = 'flex';
        return;
    }

    countdownEl.textContent = timeLeft;
    spectatorCountdownInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft >= 0) {
            countdownEl.textContent = timeLeft;
        } else {
            clearInterval(spectatorCountdownInterval);
            handleTimeout();
        }
    }, 1000);
    
    spectatorModal.style.display = 'flex';
}

function updateSpectatorView(sessionData) {
    // *** YENİ EKLENEN SATIR ***
    // İzleyicinin artık sonucu gördüğünü ve pencerenin kapanmaması gerektiğini işaretle
    spectatorViewingResult = true;

    if (spectatorCountdownInterval) {
        clearInterval(spectatorCountdownInterval);
        spectatorCountdownInterval = null;
    }
    document.getElementById('spectatorCountdown').textContent = 'Seçim Yapıldı!';

    const selectedCardIndex = sessionData.selection.cardIndex;
    const pointsGained = sessionData.result.points;

    const allCards = document.querySelectorAll('#spectatorCardContainer .card');
    
    sessionData.cards.forEach((cardValue, index) => {
        const cardEl = allCards[index];
        if (cardEl) {
            const cardFront = cardEl.querySelector('.card-front');
            const realPoints = cardValue * (sessionData.multiplier || 1);
            cardFront.textContent = `+${realPoints}`;

            setTimeout(() => {
                cardEl.classList.add('opened');
                if (index == selectedCardIndex) {
                    cardEl.classList.add('glowing-border');
                }
            }, 100);
        }
    });

    const resultContainer = document.getElementById('spectatorResultContainer');
    if (resultContainer) {
         resultContainer.innerHTML = `
            <p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8">
                ${sessionData.user}, ${pointsGained} puan kazandı!
            </p>
            <button onclick="closeSpectatorModal()" class="mt-4 py-3 px-8 bg-red-700 hover:bg-red-600 text-white font-bold rounded-lg transition-colors">
                Oyuna Devam Et
            </button>
        `;
    }
}

// MEVCUT showGlobalSurpriseBoxNotification FONKSİYONUNU BU BLOK İLE DEĞİŞTİRİN

function showGlobalSurpriseBoxNotification(data) {
    document.getElementById('surpriseOpener').textContent = data.user;
    
    const sourceInfoEl = document.getElementById('surpriseSourceInfo');
    if (data.boxId === 'Çark') {
        sourceInfoEl.innerHTML = `<b>Şans Çarkı</b>'ndan Sürpriz Kutu elde etti ve kart seçiminden`;
    } else {
        sourceInfoEl.innerHTML = `<span class="text-red-400 font-bold">${data.boxId}</span> numaralı kutuyu açtı ve kart seçiminden`;
    }

    document.getElementById('surprisePoints').textContent = data.result.points;
    
    // *** İSTEĞİNİZE GÖRE DÜZENLENEN KISIM BAŞLANGICI ***
    let multiplierText = ''; // Varsayılan olarak metni boş yapıyoruz.
    // Sadece kutudan geldiyse çarpan metnini göster
    if (data.boxId !== 'Çark') {
        if (data.multiplier && data.multiplier > 1) {
            const basePoints = Math.round(data.result.points / data.multiplier);
            multiplierText = `kazandı! <br><span class="text-base text-gray-400">(${basePoints} Puan x ${data.multiplier} Çarpan)</span>`;
        } else {
            multiplierText = 'kazandı! (Çarpan kullanılmadı)';
        }
    } else {
        // Çarktan geldiyse sadece "kazandı!" yazsın.
        multiplierText = 'kazandı!';
    }
    // *** DÜZENLENEN KISIM SONU ***

    document.getElementById('surpriseMultiplierInfo').innerHTML = multiplierText;

    document.getElementById('globalSurpriseBoxModal').style.display = 'flex';
}

// MEVCUT closeSpectatorModal FONKSİYONUNU BU BLOK İLE DEĞİŞTİRİN

function closeSpectatorModal() {
    if (spectatorCountdownInterval) {
        clearInterval(spectatorCountdownInterval);
        spectatorCountdownInterval = null;
    }
    const spectatorModal = document.getElementById('spectatorModal');
    spectatorModal.style.display = 'none';

    const resultContainer = document.getElementById('spectatorResultContainer');
    if (resultContainer) {
        resultContainer.innerHTML = '<p id="spectatorResult" class="text-2xl text-green-400 font-bold h-8"></p>';
    }

    // *** YENİ EKLENEN SATIR ***
    // İzleyici pencereyi kapattığı için bayrağı sıfırla
    spectatorViewingResult = false;
}
    
// ...VE YERİNE BU YENİ VERSİYONU YAPIŞTİR
function renderWheel() {
    const wheelElement = document.getElementById('wheel');
    if (!wheelElement) { return; }
    
    wheelElement.innerHTML = ''; 

    const segments = wheelSegments;
    const segmentCount = segments.length;
    if (segmentCount === 0) return;

    // --- MANUEL AYAR NOKTAN BURASI ---
    // Bu sayıyı değiştirerek tüm simgelerin yönünü ayarla.
    // Pozitif sayı = Saat yönünde kaydırır.
    // Negatif sayı = Saat yönünün tersine kaydırır.
    // 0 = Tam ortaya alır.
    const angleOffset = 6; 
    // ------------------------------------

    const segmentAngle = 360 / segmentCount;
    let gradientParts = [];

    segments.forEach((segment, i) => {
        const startAngle = segmentAngle * i;
        const endAngle = startAngle + segmentAngle;
        gradientParts.push(`${segment.color || '#cccccc'} ${startAngle}deg ${endAngle}deg`);

        // HESAPLAMA BURADA DEĞİŞTİ: Artık angleOffset'i hesaba katıyor.
        const textAngle = startAngle + (segmentAngle / 2) + angleOffset;
        
        const textHolder = document.createElement('div');
        textHolder.className = 'wheel-text-container';
        textHolder.style.transform = `rotate(${textAngle}deg)`;

        if (segment.imageUrl && segment.imageUrl.trim() !== '') {
            const imageEl = document.createElement('img');
            imageEl.src = segment.imageUrl;
            imageEl.className = 'wheel-image';
            
            if (textAngle > 90 && textAngle < 270) {
                imageEl.style.transform = 'translate(-50%, -50%) rotate(180deg)';
            } else {
                imageEl.style.transform = 'translate(-50%, -50%)';
            }
            textHolder.appendChild(imageEl);
        } else {
            const textSpan = document.createElement('span');
            textSpan.className = 'wheel-text';
            textSpan.textContent = segment.label;

            if (textAngle > 90 && textAngle < 270) {
                textSpan.style.transform = 'translate(-50%, -50%) rotate(180deg)';
            } else {
                textSpan.style.transform = 'translate(-50%, -50%)';
            }
            textHolder.appendChild(textSpan);
        }
        
        wheelElement.appendChild(textHolder);
    });

    wheelElement.style.background = `conic-gradient(${gradientParts.join(', ')})`;
}
    
// MEVCUT spinWheel FONKSİYONUNU SİLİP BUNUNLA DEĞİŞTİRİN

async function spinWheel() {
    if (isWheelSpinning) return;
    if (isAdmin) {
        displayMessage("Adminler çark çeviremez.");
        return;
    }
    
    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();

    if (!userData || (userData.carkBileti || 0) < 1) {
        displayMessage("Çarkı çevirmek için yeterli biletiniz yok.");
        return;
    }
    
    if (userData.multiplierSource !== 'none') {
        const confirmSpin = await customConfirm("Aktif bir çarpanınız var. Çarktan yeni bir çarpan çıkarsa, mevcut çarpanınızın üzerine yazılır. Devam etmek istiyor musunuz?");
        if (!confirmSpin) return;
    }

    isWheelSpinning = true;
    spinBtn.disabled = true;
    spinBtn.textContent = 'Dönüyor...';

    await userRef.update({
        carkBileti: userData.carkBileti - 1,
        wheelSpinsCount: (userData.wheelSpinsCount || 0) + 1
    });

    const totalWeight = wheelSegments.reduce((sum, seg) => sum + (seg.weight || 1), 0);
    let randomWeight = Math.random() * totalWeight;
    let winningIndex = -1;
    for (let i = 0; i < wheelSegments.length; i++) {
        randomWeight -= (wheelSegments[i].weight || 1);
        if (randomWeight < 0) {
            winningIndex = i;
            break;
        }
    }
    if (winningIndex === -1) winningIndex = 0;
    const winningSegment = wheelSegments[winningIndex];
    
    const totalSegments = wheelSegments.length;
    const degreesPerSegment = 360 / totalSegments;
    const winningAngle = (winningIndex * degreesPerSegment) + (degreesPerSegment / 2);

    const spinCycles = 5 + Math.floor(Math.random() * 3);
    const finalRotation = (spinCycles * 360) + 270 - winningAngle;

    wheel.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
    wheel.style.transform = `rotate(${finalRotation}deg)`;
    
    setTimeout(async () => {
        isWheelSpinning = false;
        spinBtn.disabled = false;
        spinBtn.textContent = 'Çarkı Çevir!';

        const currentUserDataSnap = await userRef.once('value');
        const currentUserData = currentUserDataSnap.val();

        if (!currentUserData) {
            console.error("Çark sonucu işlenirken kullanıcı verisi bulunamadı!");
            displayMessage("Bir hata oluştu, ödülünüz işlenemedi. Lütfen sayfayı yenileyin.");
            return;
        }

        let message = '';
        let updates = {};
        
        switch(winningSegment.type) {
            case 'points':
                message = `Tebrikler, çarktan <b>+${winningSegment.value} Puan</b> kazandın!`;
                updates.balance = (currentUserData.balance || 0) + winningSegment.value;
                if(updates.balance > (currentUserData.highestBalanceEver || 0)) updates.highestBalanceEver = updates.balance;
                break;
            case 'boxRights':
                message = `Tebrikler, çarktan <b>+${winningSegment.value} Kutu Hakkı</b> kazandın!`;
                updates.kutuHakki = (currentUserData.kutuHakki || 0) + winningSegment.value;
                break;
            case 'iflasShield':
                message = `Tebrikler, çarktan <b>+${winningSegment.value} İflas Kalkanı</b> kazandın!`;
                updates.iflasShieldUses = (currentUserData.iflasShieldUses || 0) + winningSegment.value;
                break;
            case 'clickCatchTicket':
                 message = `Tebrikler, çarktan <b>+${winningSegment.value} Tıkla-Yakala Bileti</b> kazandın!`;
                updates.clickCatchTickets = (currentUserData.clickCatchTickets || 0) + winningSegment.value;
                break;
            case 'wheelTicket':
                 message = `Tebrikler, çarktan <b>+${winningSegment.value} Çark Bileti</b> kazandın!`;
                 updates.carkBileti = (currentUserData.carkBileti || 0) + winningSegment.value;
                break;
            case 'tempMultiplier':
                message = `Tebrikler, çarktan <b>${winningSegment.value}X Çarpan</b> kazandın!`;
                updates.activeMultiplier = winningSegment.value;
                updates.multiplierSource = 'store';
                updates.multiplierRemainingUses = winningSegment.duration;
                break;
            case 'surpriseBox':
                 const sessionRef = db.ref('surprise_box_session');
                 await sessionRef.set({ 
                     active: true, user: currentUser, boxId: 'Çark', 
                     multiplier: 1, cards: shuffleArray([...cardValues]), 
                     selection: null, result: null, 
                     timestamp: firebase.database.ServerValue.TIMESTAMP
                 });
                 const snap = await sessionRef.once('value');
                 const serverTimestamp = snap.val().timestamp;
                 await sessionRef.update({ expirationTimestamp: serverTimestamp + 60000 });
                 openCardSelectionModal(currentUser);
                 message = "Vay canına! Çarktan Sürpriz Kutu çıktı! Şimdi bir kart seç.";
                 break;
            case 'pas':
                message = "Bu seferlik pas! Bir dahaki sefere daha şanslı olabilirsin.";
                break;
        }

        db.ref('wheelHistory').push().set({
            username: currentUser, 
            prize: winningSegment.label, 
            type: winningSegment.type,
            value: winningSegment.value !== undefined ? winningSegment.value : null,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        const historyRef = db.ref('wheelHistory');
        historyRef.orderByChild('timestamp').once('value', (snapshot) => {
            const totalCount = snapshot.numChildren();
            const limit = 10;
            if (totalCount > limit) {
                let itemsToDeleteCount = totalCount - limit;
                snapshot.forEach((childSnapshot) => {
                    if (itemsToDeleteCount <= 0) return true; 
                    childSnapshot.ref.remove();
                    itemsToDeleteCount--;
                });
            }
        });

        const logDetails = {
            result: winningSegment.label,
            type: winningSegment.type,
            value: winningSegment.value !== undefined ? winningSegment.value : null
        };
        // --- DEĞİŞİKLİK: Log kaydına yeni bakiye bilgisini ekliyoruz. ---
        if (winningSegment.type === 'points') {
            logDetails.newBalance = updates.balance;
        }
        
        if (winningSegment.type !== 'surpriseBox') {
            logActivity('spinWheel', currentUser, logDetails);
        }
        
        if(Object.keys(updates).length > 0) await userRef.update(updates);
        
        displayMessage(message);
        
        const normalizedRotation = finalRotation % 360;
        wheel.style.transition = 'none';
        wheel.style.transform = `rotate(${normalizedRotation}deg)`;

    }, 5100);
}

// MEVCUT setWinner FONKSİYONUNU SİLİP BUNUNLA DEĞİŞTİRİN

async function setWinner(username) {
    const lobbyRef = db.ref('clickCatchLobby');
    const lobbySnap = await lobbyRef.once('value');
    const lobbyData = lobbySnap.val();
    if (!lobbyData || lobbyData.state !== 'active') return;

    const gameSummary = {
        winner: username,
        prize: lobbyData.prize,
        target: lobbyData.target,
        startTimestamp: lobbyData.startTimestamp || null,
        endTimestamp: firebase.database.ServerValue.TIMESTAMP,
        players: lobbyData.players || {}
    };
    
    // --- DEĞİŞİKLİK: Log'lamadan önce kazananın yeni bakiyesini hesaplıyoruz ---
    const winnerRefBefore = await db.ref(`users/${username}`).once('value');
    const winnerDataBefore = winnerRefBefore.val();
    const finalPrize = lobbyData.prize + (lobbyData.entryTickets > 0 ? 0 : lobbyData.entryFee);
    const winnerNewBalance = (winnerDataBefore.balance || 0) + finalPrize;

    logActivity('clickCatchLobby', currentUser, { 
        prize: lobbyData.prize,
        newBalance: winnerNewBalance // Yeni bakiyeyi log'luyoruz
    });
    
    await db.ref('clickCatchLobbyLastGameSummary').set(gameSummary);
    
    const updates = {
        state: 'finished',
        winner: username
    };
    await lobbyRef.update(updates);
    
    const winnerRef = db.ref(`users/${username}`);
    await winnerRef.transaction(user => {
        if (user) {
            let finalPrize = lobbyData.prize;
            if (lobbyData.prize === 500) {
                if (lobbyData.entryTickets > 0) {
                    user.clickCatchTickets = (user.clickCatchTickets || 0) + lobbyData.entryTickets;
                } 
                else {
                    finalPrize += lobbyData.entryFee;
                }
            }
            user.balance = (user.balance || 0) + finalPrize;
            if (user.balance > (user.highestBalanceEver || 0)) {
                user.highestBalanceEver = user.balance;
            }
        }
        return user;
    });

    setTimeout(() => {
        db.ref('clickCatchLobby').remove();
    }, 5000);
}

function closeSoloGameSettingsModal() {
    soloGameSettingsModal.style.display = 'none';
}

function openLobbySettingsModal() {
    lobbySettingsModal.style.display = 'flex';
}

function closeLobbySettingsModal() {
    lobbySettingsModal.style.display = 'none';
}

// --- YENİ FONKSİYONLAR BİTİŞ ---
  let lobbyGameSettings = {};
  let lobbyListener = null;

  function updateClickCatchTimer() {
    clickCatchTimer--;
    document.getElementById('clickCatchTimer').textContent = clickCatchTimer;
    if (clickCatchTimer <= 0) {
        endSoloClickCatchGame();
    }
  }
    
async function resetClickCatchLeaderboard() {
    if (!isAdmin) {
        displayMessage("Bu işlemi yapmaya yetkiniz yok.");
        return;
    }

    const confirmed = await customConfirm(
        "Tüm 'Tıkla-Yakala' sıralamasını ve tüm kullanıcıların kişisel rekorlarını kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!"
    );

    if (!confirmed) {
        return;
    }

    try {
        // 1. Haftalık skor tablosunu tamamen sil.
        // Bu tablo olmasa bile kod hata vermeden çalışacaktır.
        await db.ref('clickCatchWeeklyScores').remove();

        // 2. Tüm kullanıcıların kişisel rekorlarını sıfırla.
        const usersRef = db.ref('users');
        const usersSnap = await usersRef.once('value');
        const usersData = usersSnap.val();
        
        const updates = {};
        if (usersData) {
            for (const username in usersData) {
                // Sadece 'clickCatchHighestScore' alanı olan kullanıcıları güncelle
                if (usersData[username].hasOwnProperty('clickCatchHighestScore')) {
                    updates[`/users/${username}/clickCatchHighestScore`] = 0;
                }
            }
        }

        // Eğer güncellenecek kullanıcı varsa, toplu güncelleme yap.
        if (Object.keys(updates).length > 0) {
            await db.ref().update(updates);
        }

        // 3. Global lider değişkenini temizle
        clickCatchLeader = null;

        displayMessage("Tüm Tıkla-Yakala sıralaması ve kişisel rekorlar başarıyla sıfırlandı.");
        
    } catch (error) {
        console.error("Tıkla-Yakala sıralaması sıfırlanırken hata oluştu:", error);
        displayMessage("Sıfırlama işlemi sırasında bir hata meydana geldi.");
    }
}
  function createCatchItem(gameMode) {
    if (!clickCatchGameActive && gameMode === 'solo') return;
    if (gameMode === 'lobby' && (!lobbyGameSettings.state || lobbyGameSettings.state !== 'active')) return;

    const gameArea = document.getElementById('clickCatchGameArea');
    const item = document.createElement('div');
    item.className = 'catch-item';
    
    if (gameMode === 'solo') {
        const itemsWithChance = [
            { type: 'points', value: soloGameSettings.bombValue, emoji: '💣', chance: soloGameSettings.bombChance },
            { type: 'time', value: soloGameSettings.timeValue, emoji: '⏰', chance: soloGameSettings.timeChance },
            { type: 'points', value: soloGameSettings.goldValue, emoji: '💰', chance: soloGameSettings.goldChance },
            { type: 'special', value: null, emoji: null, chance: specialItemForThisRound ? soloGameSettings.specialChance : 0 },
            { type: 'points', value: soloGameSettings.normalValue, emoji: '🥮', chance: soloGameSettings.normalChance || 50 }
        ];
        
        const totalChance = itemsWithChance.reduce((sum, item) => sum + item.chance, 0);
        const random = Math.random() * totalChance;
        let cumulativeChance = 0;
        let itemToSpawn;

        for (const i of itemsWithChance) {
            cumulativeChance += i.chance;
            if (random < cumulativeChance) {
                itemToSpawn = i;
                break;
            }
        }
        
        if (!itemToSpawn) {
            itemToSpawn = { type: 'points', value: soloGameSettings.normalValue, emoji: '🥮' };
        }

        if (itemToSpawn.type === 'special') {
            itemToSpawn = specialItemForThisRound;
            specialItemForThisRound = null; 
        }
        
        item.textContent = itemToSpawn.emoji;
        item.dataset.type = itemToSpawn.type;
        item.dataset.value = itemToSpawn.value;
        item.dataset.emoji = itemToSpawn.emoji;

    } else { // Bu kısım lobi oyunu için
        const isBomb = Math.random() < 0.2; // %20 ihtimalle bomba çıkar

        if (isBomb) {
            item.textContent = '💣';
            item.style.backgroundColor = 'transparent';
            item.style.fontSize = '30px';
            item.dataset.type = 'bomb';
        } else {
            item.textContent = '🎯';
            item.style.backgroundColor = 'transparent';
            item.style.fontSize = '30px';
            item.dataset.type = 'target';
        }
    }

    item.style.left = `${Math.random() * (gameArea.clientWidth - 30)}px`;
    item.style.top = `${Math.random() * (gameArea.clientHeight - 30)}px`;
    
    item.onclick = gameMode === 'solo' ? handleSoloItemClick : handleLobbyItemClick;
    
    const disappearTime = gameMode === 'solo' ? soloGameSettings.itemDisappearTime : lobbyGameSettings.itemInterval;
    
    gameArea.appendChild(item);
    
    setTimeout(() => {
        if (item.parentNode) {
            item.remove();
        }
    }, disappearTime);
}
  function showFloatingText(text, x, y) {
      const gameArea = document.getElementById('clickCatchGameArea');
      const textEl = document.createElement('div');
      textEl.textContent = text;
      textEl.className = 'floating-text';
      
      const rect = gameArea.getBoundingClientRect();
      const relativeX = x - rect.left;
      const relativeY = y - rect.top;

      textEl.style.left = `${relativeX}px`;
      textEl.style.top = `${relativeY}px`;
      
      gameArea.appendChild(textEl);
      
      textEl.addEventListener('animationend', () => {
          textEl.remove();
      });
  }
    
async function clearLastWinner() {
    if (!isAdmin) {
        displayMessage("Bu işlemi yapmaya yetkiniz yok.");
        return;
    }
    const confirmed = await customConfirm("Son kazanan bilgisini silmek istediğinize emin misiniz? Bu işlem geri alınamaz!");
    if (confirmed) {
        await db.ref('clickCatchLobbyLastGameSummary').remove();
        displayMessage("Son kazanan bilgisi başarıyla silindi.");
        // Not: Arayüzün güncellenmesini listenForLastGameSummary fonksiyonu otomatik olarak yapacak.
    }
}
  
  // BU FONKSİYONUN TAMAMI DEĞİŞECEK
function handleSoloItemClick(event) {
    if (!clickCatchGameActive) return;
    
    const item = event.target;
    const type = item.dataset.type;
    const value = parseInt(item.dataset.value);
    const emoji = item.dataset.emoji;
    
    let floatingText = '';

    switch(type) {
        case 'points':
            clickCatchScore = Number(clickCatchScore) + value;
            document.getElementById('clickCatchScore').textContent = clickCatchScore;
            floatingText = (value > 0 ? '+' : '') + value + ' Skor';
            break;
        case 'time':
            clickCatchTimer += value;
            document.getElementById('clickCatchTimer').textContent = clickCatchTimer;
            floatingText = `+${value} Saniye`;
            break;
        // DEĞİŞEN KISIM BURASI
        case 'boxRight':
            collectedBoxRights += value; // Veritabanı yerine geçici değişkene ekle
            floatingText = `+${value} Kutu Hakkı`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'iflasShield':
            collectedIflasShields += value; // Veritabanı yerine geçici değişkene ekle
            floatingText = `+${value} İflas Kalkanı`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
        case 'wheelTicket':
            collectedWheelTickets += value; // Veritabanı yerine geçici değişkene ekle
            floatingText = `+${value} Çark Bileti`;
            document.getElementById('collectedSpecials').innerHTML += `<span class="text-xl">${emoji}</span>`;
            break;
    }
    
    showFloatingText(floatingText, event.clientX, event.clientY);
    item.remove();
}
  
async function deleteUserFromLeaderboard(event, username) {
      event.stopPropagation(); // Olayın yayılmasını engeller
      if (!isAdmin) return;
      const confirmed = await customConfirm(`<b>${username}</b> adlı kullanıcıyı Yakalayıcılar listesinden silmek istediğinize emin misiniz?`);
      if (confirmed) {
          await db.ref(`clickCatchWeeklyScores/${username}`).remove();
          displayMessage(`${username} skor tablosundan silindi.`);
          loadClickCatchRankings(); // Tabloyu anında yenile
      }
  }
  // YENİ YARDIMCI FONKSİYON: Tıkla-Yakala liderinin kullanıcı adını anlık çeker.
async function getClickCatchLeaderUsername() {
    const scoresSnap = await db.ref('clickCatchWeeklyScores').orderByValue().limitToLast(1).once('value');
    if (!scoresSnap.exists()) {
        return null; // Lider yoksa null döner
    }
    const scores = [];
    scoresSnap.forEach(child => {
        scores.push({ username: child.key });
    });
    return scores.length > 0 ? scores[0].username : null;
}
   function loadClickCatchRankings() {
      const rankingsList = document.getElementById('clickCatchRankings');
      const searchTerm = document.getElementById('searchClickCatchRanking').value.trim().toLowerCase();
      const ref = db.ref('clickCatchWeeklyScores').orderByValue();
      
      const callback = snap => {
          rankingsList.innerHTML = 'Yükleniyor...';
          
          if (!snap.exists()) {
              rankingsList.innerHTML = '<p class="text-center text-gray-400">Bu hafta henüz skor kaydedilmedi.</p>';
              clickCatchLeader = null;
              return;
          }

          let html = '';
          const scores = [];
          snap.forEach(child => {
              scores.push({ username: child.key, score: child.val() });
          });
          scores.reverse();

          if(scores.length > 0) { clickCatchLeader = scores[0].username; } 
          else { clickCatchLeader = null; }

          let filteredScores = scores;
          if (searchTerm) {
              filteredScores = scores.filter(entry => entry.username.toLowerCase().includes(searchTerm));
          }

          filteredScores.forEach((entry, index) => {
              const leaderBadge = (index === 0 && !searchTerm) ? '<span title="Tıkla ve Yakala Lideri">🎯</span>' : '';
              const deleteButton = isAdmin 
? `<button onclick="deleteUserFromLeaderboard(event, '${entry.username}')" class="ml-3 text-gray-500 hover:text-red-500 transition-colors" title="Skor Tablosundan Sil">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
     </button>` : '';

              const userData = allUsersCache.find(user => user.username === entry.username);
              const avatarUrl = userData && userData.selectedAvatar ? userData.selectedAvatar.url : defaultAvatarUrl;

              html += `
                <div onclick="openPublicUserDetailModal('${entry.username}')" class="flex justify-between items-center p-2 mb-2 bg-gray-800 rounded-md cursor-pointer hover:bg-gray-700 transition-colors">
                    <div class="flex items-center">
                        <span class="font-bold mr-2">${index + 1}.</span>
                        <img src="${avatarUrl}" class="w-10 h-10 rounded-md mr-3 object-contain">
                        <span>${leaderBadge} ${entry.username}</span>
                        ${deleteButton}
                    </div>
                    <span class="font-bold text-yellow-300">${entry.score} Skor</span>
                </div>`;
          });
          rankingsList.innerHTML = html || '<p class="text-center text-gray-400">Aramayla eşleşen kullanıcı bulunamadı.</p>';
      };
      
      if (activeListeners.clickCatchRankings) {
          activeListeners.clickCatchRankings.ref.off('value', activeListeners.clickCatchRankings.callback);
      }
      activeListeners.clickCatchRankings = { ref, event: 'value', callback };
      ref.on('value', callback);
  }

    // === BU YENİ FONKSİYONLARI DOSYANIN SONUNA EKLE ===

// Lobi bildirim penceresini gösterir
function showLobbyNotification(lobbyData) {
    const infoDiv = document.getElementById('lobbyNotificationInfo');
    const useTickets = lobbyData.entryTickets > 0;
    const entryRequirement = useTickets ? `${lobbyData.entryTickets} Bilet` : `${lobbyData.entryFee} Puan`;

    infoDiv.innerHTML = `
        <p>Giriş Ücreti: <b class="text-white">${entryRequirement}</b></p>
        <p>Hedef: <b class="text-white">${lobbyData.target} Yakalama</b></p>
        <p>Büyük Ödül: <b class="text-green-400">${lobbyData.prize} Puan</b></p>
        <p class="mt-2 text-sm text-gray-400">Hemen Tıkla-Yakala sekmesine git ve lobiye katıl!</p>
    `;
    document.getElementById('lobbyNotificationModal').style.display = 'flex';
}

// Lobi bildirim penceresini kapatır
function closeLobbyNotificationModal() {
    document.getElementById('lobbyNotificationModal').style.display = 'none';
}

// "Lobiye Git" butonuna basıldığında çalışır
function goToLobbySection() {
    closeLobbyNotificationModal();
    showSection('clickCatch');
}

  // ESKİ listenForLobbyChanges FONKSİYONUNU SİLİP, BUNU YAPIŞTIR

function listenForLobbyChanges() {
    const lobbyRef = db.ref('clickCatchLobby');

    if (activeListeners.lobby) {
        activeListeners.lobby.ref.off(activeListeners.lobby.event, activeListeners.lobby.callback);
    }
    
    const startScreen = document.getElementById('clickCatchStartScreen');
    const lobbyStatusContainer = document.getElementById('lobbyStatusContainer');
    const lobbyGameOverScreen = document.getElementById('lobbyGameOverScreen');

    const callback = snap => {
        const lobbyData = snap.val();
        const joinLobbyBtn = document.getElementById('joinLobbyBtn');
        const startSoloGameBtn = document.getElementById('startSoloGameBtn');
        const lobbyStartBtn = document.getElementById('lobbyStartBtn');
        
        if (countdownInterval) clearInterval(countdownInterval);

        startSoloGameBtn.disabled = false;

        if (!lobbyData || !lobbyData.state) {
            lobbyGameSettings = {};
            hasShownLobbyNotification = false; 
            closeLobbyNotificationModal(); 
            lobbyStatusContainer.classList.add('hidden');
            lobbyGameOverScreen.classList.add('hidden');
            startScreen.style.display = 'flex';
            
            // Oyun bitince veya iptal olunca arayüzdeki zamanlayıcıları temizle
            if (clickCatchItemInterval) {
                clearInterval(clickCatchItemInterval);
                clickCatchItemInterval = null;
            }
            
            joinLobbyBtn.disabled = true;
            joinLobbyBtn.textContent = 'Lobiye Katıl';
            joinLobbyBtn.onclick = () => joinLobby();
            joinLobbyBtn.classList.remove('bg-orange-600', 'hover:bg-orange-500');
            joinLobbyBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');

            if (isAdmin && lobbyStartBtn) lobbyStartBtn.disabled = true;
            document.getElementById('displayTarget').classList.add('hidden');
            return;
        }

        lobbyGameSettings = lobbyData;
        lobbyStatusContainer.classList.remove('hidden');
        lobbyGameOverScreen.classList.add('hidden');

        const useTickets = lobbyData.entryTickets > 0;
        const entryRequirement = useTickets ? `${lobbyData.entryTickets} Bilet` : `${lobbyData.entryFee} Puan`;
        
        document.getElementById('lobbyStatusInfo').textContent = `Katılım ücreti: ${entryRequirement} | Hedef: ${lobbyData.target} Yakalama | Ödül: ${lobbyData.prize} Puan`;
        
        const players = lobbyData.players || {};
        const hasPlayers = Object.keys(players).length > 0;
        const isCurrentUserInLobby = lobbyData.state !== 'finished' && players[currentUser] !== undefined;

        const playerListEl = document.getElementById('lobbyPlayerList');
        playerListEl.innerHTML = ``;
        if (hasPlayers) {
            const sortedPlayers = Object.entries(players).sort(([, a], [, b]) => b.score - a.score);
            playerListEl.innerHTML = `Katılımcılar: <br>`;
            sortedPlayers.forEach(([username, playerData]) => {
                playerListEl.innerHTML += `<b>${username}:</b> ${playerData.score} / ${lobbyData.target}<br>`;
            });
        } else {
            playerListEl.textContent = `Henüz katılan yok.`;
        }

        if (isAdmin) {
            startSoloGameBtn.disabled = true;
            joinLobbyBtn.disabled = true;
            if(lobbyStartBtn) lobbyStartBtn.disabled = !(lobbyData.state === 'waiting' && hasPlayers);
        } else {
            if (isCurrentUserInLobby) {
                joinLobbyBtn.disabled = lobbyData.state === 'active';
                joinLobbyBtn.textContent = 'Lobiden Ayrıl';
                joinLobbyBtn.onclick = () => leaveLobby();
                joinLobbyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                joinLobbyBtn.classList.add('bg-orange-600', 'hover:bg-orange-500');
            } else {
                joinLobbyBtn.disabled = lobbyData.state !== 'waiting';
                joinLobbyBtn.textContent = 'Lobiye Katıl';
                joinLobbyBtn.onclick = () => joinLobby();
                joinLobbyBtn.classList.remove('bg-orange-600', 'hover:bg-orange-500');
                joinLobbyBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            }
        }
        
        if (lobbyData.state === 'waiting') {
            document.getElementById('lobbyStatusTitle').textContent = "Lobi Katılıma Açık!";
            startScreen.style.display = 'flex';
            document.getElementById('displayTarget').classList.add('hidden');
            
            if (!isAdmin && !isCurrentUserInLobby && !hasShownLobbyNotification) {
                showLobbyNotification(lobbyData);
                hasShownLobbyNotification = true;
            }
            
        } else if (lobbyData.state === 'active') {
            document.getElementById('lobbyStatusTitle').textContent = "Oyun Başladı! Hedefe İlk Ulaşan Kazanır!";
            startScreen.style.display = 'none';
            closeLobbyNotificationModal();
            document.getElementById('displayScore').classList.add('hidden');
            document.getElementById('displaySpecials').classList.add('hidden');
            document.getElementById('displayTimer').classList.add('hidden');
            document.getElementById('displayTarget').classList.remove('hidden');
            
            const currentUserScore = isCurrentUserInLobby ? (players[currentUser] ? players[currentUser].score : 0) : 0;
            document.getElementById('clickCatchTarget').textContent = `${currentUserScore} / ${lobbyData.target}`;

            if (isCurrentUserInLobby && currentActiveSection !== 'clickCatch') {
                showSection('clickCatch');
            }
            
            // ================== PERFORMANS DÜZELTMESİ BURADA ==================
            // Bu blok artık sadece lobiye katılan oyuncularda çalışacak.
            if (isCurrentUserInLobby) {
                if (!clickCatchItemInterval) {
                   showGameCountdown(() => {
                       // Hedef oluşturma döngüsü sadece katılımcı için başlar.
                       clickCatchItemInterval = setInterval(() => createCatchItem('lobby'), lobbyData.itemInterval);
                   });
                }
            }
            // =================================================================

        } else if (lobbyData.state === 'finished') {
            lobbyStatusContainer.classList.add('hidden');
            lobbyGameOverScreen.classList.remove('hidden');
            document.getElementById('lobbyGameOverInfo').innerHTML = `Kazanan: <b class="text-2xl text-yellow-300">${lobbyData.winner}</b>! Ödül: ${lobbyData.prize} Puan!`;
            
            startScreen.style.display = 'none';
            document.getElementById('displayTarget').classList.add('hidden');
            if (clickCatchItemInterval) {
                clearInterval(clickCatchItemInterval);
                clickCatchItemInterval = null;
            }
        }
    };

    activeListeners.lobby = { ref: lobbyRef, event: 'value', callback };
    lobbyRef.on('value', callback);
}

    // === BU YENİ FONKSİYONLARI DOSYANIN SONUNA EKLE ===

async function changeAllWheelTickets(add) {
    const amount = parseInt(document.getElementById("globalWheelTicket").value);
    if (isNaN(amount) || amount <= 0) {
        displayMessage("Geçerli miktar girin.");
        return;
    }
    const confirmed = await customConfirm(`Tüm kullanıcılara ${amount} adet Çark Bileti ${add ? 'eklemek' : 'silmek'} istediğinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let currentTickets = child.val().carkBileti || 0;
                    currentTickets = add ? currentTickets + amount : Math.max(0, currentTickets - amount);
                    updates['users/' + child.key + '/carkBileti'] = currentTickets;
                }
            });
            db.ref().update(updates).then(() => displayMessage("Tüm kullanıcılara Çark Bileti işlemi başarıyla uygulandı."));
        });
    }
}

async function changeAllClickCatchTickets(add) {
    const amount = parseInt(document.getElementById("globalClickCatchTicket").value);
    if (isNaN(amount) || amount <= 0) {
        displayMessage("Geçerli miktar girin.");
        return;
    }
    const confirmed = await customConfirm(`Tüm kullanıcılara ${amount} adet Tıkla-Yakala Bileti ${add ? 'eklemek' : 'silmek'} istediğinizden emin misiniz?`);
    if (confirmed) {
        db.ref('users').once('value').then(snap => {
            const updates = {};
            snap.forEach(child => {
                if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
                    let currentTickets = child.val().clickCatchTickets || 0;
                    currentTickets = add ? currentTickets + amount : Math.max(0, currentTickets - amount);
                    updates['users/' + child.key + '/clickCatchTickets'] = currentTickets;
                }
            });
            db.ref().update(updates).then(() => {
                 displayMessage("Tüm kullanıcılara Tıkla-Yakala Bileti işlemi başarıyla uygulandı.");
                 // YENİ EKLENEN KOD BAŞLANGICI
                 const actionText = add ? 'gönderdi' : 'sildi';
                 const notificationMessage = `Admin, tüm kullanıcılara ${amount} Tıkla-Yakala Bileti ${actionText}.`;
                 db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
                 // YENİ EKLENEN KOD SONU
            });
        });
    }
}

let globalNotificationTimeout;

/**
 * Ekranda genel bir yönetici bildirimi gösterir.
 * @param {string} message - Gösterilecek mesaj.
 */
function displayGlobalNotification(message) {
    const notificationEl = document.getElementById('globalAdminNotification');
    if (!notificationEl) return;

    // Önceki bildirimin zaman aşımını temizle
    if (globalNotificationTimeout) {
        clearTimeout(globalNotificationTimeout);
    }

    notificationEl.textContent = message;
    // Bildirimi görünür yap ve animasyonu tetikle
    notificationEl.classList.remove('opacity-0', '-translate-y-20');

    // 5 saniye sonra bildirimi gizle
    globalNotificationTimeout = setTimeout(() => {
        notificationEl.classList.add('opacity-0', '-translate-y-20');
    }, 5000);
}
    
// YUKARIDAKİ ESKİ KODU SİLİP, YERİNE BU YENİ KODU YAPIŞTIR
async function listenForGlobalNotifications() {
    // Adminler için bu fonksiyon çalışmasın
    if (isAdmin) return;

    const userRef = db.ref(`users/${currentUser}`);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();
    
    // Kullanıcının en son gördüğü bildirimin zamanını al, yoksa 0 kullan.
    const lastSeenTimestamp = userData.lastSeenGlobalNotifTimestamp || 0;
    
    const notificationsRef = db.ref('globalNotifications');
    const listenerRef = notificationsRef.orderByChild('timestamp').startAt(lastSeenTimestamp + 1);

    const callback = (snap) => {
        const notification = snap.val();
        if (notification && notification.message) {
            // Bildirimi göster
            displayGlobalNotification(notification.message);
            
            // Kullanıcının "son görme" zamanını bu yeni bildirimin zamanıyla güncelle
            userRef.update({
                lastSeenGlobalNotifTimestamp: notification.timestamp
            });
        }
    };
    
    // Listener'ı tekrar tekrar eklememek için kontrol
    if (activeListeners.globalNotifications) {
        activeListeners.globalNotifications.ref.off('child_added', activeListeners.globalNotifications.callback);
    }
    
    activeListeners.globalNotifications = { ref: listenerRef, event: 'child_added', callback };
    listenerRef.on('child_added', callback);
}
  
  async function startLobbyGame() {
    if (!isAdmin) return;
    
    // Önceki lobi verilerini temizle
    await db.ref('clickCatchLobby').remove();
    
    // Yeni lobi verilerini kur
    const lobbyData = {
        entryFee: parseInt(document.getElementById('lobbyEntryFee').value) || 100,
        entryTickets: parseInt(document.getElementById('lobbyEntryTickets').value) || 0,
        target: parseInt(document.getElementById('lobbyTarget').value) || 10,
        prize: parseInt(document.getElementById('lobbyPrize').value) || 1000,
        itemInterval: parseInt(document.getElementById('lobbyItemInterval').value) || 800,
        state: 'waiting',
        players: {} // Yeni lobi her zaman boş oyuncu listesiyle başlar
    };
    await db.ref('clickCatchLobby').set(lobbyData);
    displayMessage("Lobi kuruldu. Oyuncular katıldıktan sonra 'Oyunu Başlat' butonuna bas.");
}

  async function endLobbyGame(isCancel = false) {
    if (!isAdmin) return;

    const lobbyRef = db.ref('clickCatchLobby');
    const lobbySnap = await lobbyRef.once('value');
    const lobbyData = lobbySnap.val();

    // Lobi zaten yoksa veya boşsa işlemi bitir.
    if (!lobbyData) {
        if (isCancel) {
            displayMessage("İptal edilecek aktif bir lobi bulunmuyor.");
        }
        await lobbyRef.remove();
        return;
    }

    const currentState = lobbyData.state;
    const useTickets = lobbyData.entryTickets > 0;
    const updates = {};
    let messageForAdmin = "";

    // Senaryo 1: Lobi "beklemede" veya "aktif" durumdayken admin tarafından iptal ediliyor.
    // Bu durumda ücretler iade edilir ve bildirim gönderilir.
    if (isCancel && (currentState === 'waiting' || currentState === 'active')) {
        const confirmed = await customConfirm("Lobi iptal edilecek ve tüm katılımcıların ücretleri iade edilecek. Emin misin?");
        if (!confirmed) return;

        // Lobide oyuncu varsa iade işlemlerini yap
        if (lobbyData.players) {
            for (const player in lobbyData.players) {
                const userRef = db.ref(`users/${player}`);
                const userSnap = await userRef.once('value');
                const userData = userSnap.val();

                if (userData) {
                    // Ücret türüne göre iadeyi hazırla
                    if (useTickets) {
                        const currentTickets = userData.clickCatchTickets || 0;
                        updates[`users/${player}/clickCatchTickets`] = currentTickets + (lobbyData.entryTickets || 0);
                    } else {
                        const currentBalance = userData.balance || 0;
                        updates[`users/${player}/balance`] = currentBalance + (lobbyData.entryFee || 0);
                    }
                    
                    // --- YENİ EKLENEN BİLDİRİM KODU ---
                    const messageForUser = "Kurulu lobi admin tarafından iptal edildi. Katılım ücretiniz iade edildi.";
                    const notifKey = db.ref('users/' + player + '/notifications').push().key;
                    updates[`users/${player}/notifications/${notifKey}`] = { message: messageForUser, timestamp: firebase.database.ServerValue.TIMESTAMP };
                    // --- BİLDİRİM KODU SONU ---
                }
            }
        }
        messageForAdmin = "Lobi iptal edildi ve tüm katılımcıların ücretleri iade edildi.";
    } 
    // Senaryo 2: Oyun zaten bitmiş veya başka bir durumda iptal ediliyor.
    // Bu durumda ücret iadesi yapılmaz.
    else {
        let confirmationMessage = "Lobi sonlandırılacak. Bu işlem geri alınamaz.";
        if (isCancel) {
             confirmationMessage = "Oyun zaten tamamlanmış. Lobiyi sonlandırmak, ücretlerin iade edilmemesine neden olur. Emin misin?";
        }
        const confirmed = await customConfirm(confirmationMessage);
        if (!confirmed) return;

        const winner = lobbyData.winner;
        messageForAdmin = winner 
            ? `Oyun sonlandırıldı. Kazanan: ${winner}. Ücretler iade edilmedi.`
            : "Lobi sonlandırıldı. Kazanan belirlenmediği için ücretler iade edilmedi.";
    }
    
    // Hazırlanan tüm güncellemeleri (iade ve bildirimler) tek seferde veritabanına yaz
    if (Object.keys(updates).length > 0) {
        await db.ref().update(updates);
    }
    
    // Son olarak lobiyi sil ve admine bilgi ver
    await lobbyRef.remove();
    displayMessage(messageForAdmin);
}
  // Yeni eklenecek fonksiyon: Ekranda geçici bildirim gösterir
function displayNotification(message, color = 'bg-yellow-500') {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 p-4 rounded-lg shadow-lg text-white font-bold text-center ${color} animate-fade-in-out`;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 3000); // 3 saniye sonra bildirim kaybolur
}
  // BU FONKSİYONU BUL VE AŞAĞIDAKİYLE DEĞİŞTİR
async function triggerLobbyGameStart() {
    if (!isAdmin) return;
    if (lobbyGameSettings.state !== 'waiting') {
        displayMessage("Oyun sadece 'beklemede' durumundayken başlatılabilir.");
        return;
    }
    if (!lobbyGameSettings.players || Object.keys(lobbyGameSettings.players).length === 0) {
        displayMessage("Oyunu başlatmak için en az bir katılımcı olmalıdır.");
        return;
    }
    // OYUNUN BAŞLAMA ZAMANINI KAYDETMEK İÇİN startTimestamp EKLENDİ
    await db.ref('clickCatchLobby').update({ 
        state: 'active',
        startTimestamp: firebase.database.ServerValue.TIMESTAMP 
    });
    displayMessage("Oyun başlatıldı!");
}
  async function joinLobby() {
      if (isAdmin) return;
      const userRef = db.ref('users/' + currentUser);
      const userSnap = await userRef.once('value');
      const userData = userSnap.val();
      const useTickets = lobbyGameSettings.entryTickets > 0;
      let confirmed = false;

      if (useTickets) {
          if ((!userData.clickCatchTickets || userData.clickCatchTickets < lobbyGameSettings.entryTickets)) {
              displayMessage(`Lobiye katılmak için ${lobbyGameSettings.entryTickets} adet Tıkla-Yakala Biletin yok.`);
              return;
          }
          confirmed = await customConfirm(`Lobiye katılmak için ${lobbyGameSettings.entryTickets} adet bilet harcanacak. Onaylıyor musun?`);
          if (confirmed) {
              await userRef.update({ clickCatchTickets: (userData.clickCatchTickets || 0) - lobbyGameSettings.entryTickets });
          }
      } else {
          if ((userData.balance || 0) < lobbyGameSettings.entryFee) {
              displayMessage("Lobiye katılmak için yeterli puanın yok.");
              return;
          }
          confirmed = await customConfirm(`Lobiye katılmak için ${lobbyGameSettings.entryFee} puan harcanacak. Onaylıyor musun?`);
          if (confirmed) {
              await userRef.update({ balance: (userData.balance || 0) - lobbyGameSettings.entryFee });
          }
      }
      
      if (confirmed) {
          await db.ref(`clickCatchLobby/players/${currentUser}`).set({ score: 0 });
          displayMessage("Lobiye başarıyla katıldın! Adminin oyunu başlatması bekleniyor.");
      }
  }
  async function leaveLobby() {
    if (isAdmin || !lobbyGameSettings || lobbyGameSettings.state !== 'waiting') return;

    const confirmed = await customConfirm("Lobiden ayrılmak istediğine emin misin? Katılım ücretin iade edilecek.");
    if (!confirmed) return;

    const userRef = db.ref('users/' + currentUser);
    const useTickets = lobbyGameSettings.entryTickets > 0;

    // Ücreti iade et
    await userRef.transaction(user => {
        if (user) {
            if (useTickets) {
                user.clickCatchTickets = (user.clickCatchTickets || 0) + lobbyGameSettings.entryTickets;
            } else {
                user.balance = (user.balance || 0) + lobbyGameSettings.entryFee;
            }
        }
        return user;
    });

    // Oyuncuyu lobiden sil
    await db.ref(`clickCatchLobby/players/${currentUser}`).remove();

    displayMessage("Lobiden ayrıldın ve katılım ücretin iade edildi.");
  }

  async function handleLobbyItemClick(event) {
    if (lobbyGameSettings.state !== 'active') return;
    
    // Düzeltilen kısım: Tıklanan element ne olursa olsun, en yakın ebeveyn catch-item'ı bulur
    const item = event.target.closest('.catch-item');
    if (!item) return; // Eğer doğru element bulunamazsa işlemi durdur

    const itemType = item.dataset.type;

    const lobbyPlayerRef = db.ref(`clickCatchLobby/players/${currentUser}`);
    
    const playerSnap = await lobbyPlayerRef.once('value');
    const playerData = playerSnap.val();
    if (!playerData) return;

    let newScore = playerData.score;

    if (itemType === 'bomb') {
        newScore = Math.max(0, newScore - 1); // Skoru 1 azalt, ama 0'ın altına düşmesin
        showFloatingText('-1', event.clientX, event.clientY);
    } else {
        newScore++;
        showFloatingText('+1', event.clientX, event.clientY);
    }

    await lobbyPlayerRef.update({ score: newScore });

    document.getElementById('clickCatchTarget').textContent = `${newScore} / ${lobbyGameSettings.target}`;

    if(newScore >= lobbyGameSettings.target) {
        db.ref('clickCatchLobby/state').once('value').then(snap => {
            if (snap.val() === 'active') {
                setWinner(currentUser);
            }
        });
    }

    item.remove();
}

// **** YENİ EKLENECEK FONKSİYONLAR BAŞLANGICI ****

/**
 * Oyun başlamadan önce ekranda 3'ten geriye sayım gösterir.
 * @param {function} onComplete - Geri sayım bittiğinde çalıştırılacak olan fonksiyon.
 */
function showGameCountdown(onComplete) {
    const overlay = document.getElementById('gameCountdownOverlay');
    const countdownText = document.getElementById('countdownText');
    const startScreen = document.getElementById('clickCatchStartScreen');

    startScreen.style.display = 'none'; // Oyun modunu seçme ekranını gizle
    overlay.style.display = 'flex';    // Geri sayım ekranını göster

    let count = 3;
    countdownText.textContent = count;

    const countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
            countdownText.textContent = count;
        } else if (count === 0) {
            countdownText.textContent = 'BAŞLA!';
        } else {
            clearInterval(countdownInterval);
            overlay.style.display = 'none'; // Geri sayım bitince ekranı gizle
            if (onComplete) {
                onComplete(); // Asıl oyunu başlatan fonksiyonu çağır
            }
        }
    }, 1000);
}

/**
 * Geri sayım bittikten sonra Tekli Oyun'u gerçekten başlatan yardımcı fonksiyon.
 */
function _actuallyStartSoloGame() {
    // Bu fonksiyonun içeriği, startSoloClickCatchGame fonksiyonundan taşındı.
    clickCatchTimerInterval = setInterval(updateClickCatchTimer, 1000);
    clickCatchItemInterval = setInterval(() => createCatchItem('solo'), soloGameSettings.itemInterval);
}

let weeklyCountdownInterval = null

  async function openSoloGameSettingsModal() {
    // Mevcut tekli oyun ayarlarını yükle
    await loadSoloGameSettings();

    // Haftalık otomatik sıfırlama ayarlarını yükle
    const settingsSnap = await db.ref('gameConfig/weeklyClickCatchReset').once('value');
    if (settingsSnap.exists()) {
        const settings = settingsSnap.val();
        if (settings.endDate) {
            const date = new Date(settings.endDate);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            document.getElementById('weeklyResetEndDateInput').value = date.toISOString().slice(0, 16);
        }
        if (settings.prize) {
            document.getElementById('weeklyPrizeType').value = settings.prize.type || 'points';
            document.getElementById('weeklyPrizeAmount').value = settings.prize.amount || 1000;
        }
    } else {
        // Eğer ayar yoksa alanları temizle/varsayılana ayarla
        document.getElementById('weeklyResetEndDateInput').value = '';
        document.getElementById('weeklyPrizeType').value = 'points';
        document.getElementById('weeklyPrizeAmount').value = 1000;
    }

    soloGameSettingsModal.style.display = 'flex';
}
  
  function closeSoloGameSettingsModal() {
      soloGameSettingsModal.style.display = 'none';
  }
  
  function closeSoloGameSettingsModal() {
    soloGameSettingsModal.style.display = 'none';
}

  function closeLobbySettingsModal() {
      lobbySettingsModal.style.display = 'none';
  }
  // YENİ EKLENECEK FONKSİYON
// "Oyun Bitti" ekranını sadece tıklayan kullanıcının ekranında kapatır.
function closeLobbyGameOverScreen() {
    const gameOverScreen = document.getElementById('lobbyGameOverScreen');
    const startScreen = document.getElementById('clickCatchStartScreen');

    if (gameOverScreen) {
        gameOverScreen.classList.add('hidden');
    }
    if (startScreen) {
        startScreen.style.display = 'flex';
    }

    // --- YENİ EKLENEN SATIR BAŞLANGICI ---
    // Butona basıldığı anda, bu oyuncu için lobi durumunu yerel olarak sıfırlıyoruz.
    // Bu, kullanıcının butona bastığı anda yeni bir oyuna başlayabilmesini sağlar.
    // Artık 5 saniye beklemesine gerek kalmaz.
    lobbyGameSettings = {};
    // --- YENİ EKLENEN SATIR SONU ---
}

// --- ESKİ saveSoloGameSettings FONKSİYONUNU SİL, BUNU YAPIŞTIR ---

async function saveSoloGameSettings() {
    if (!isAdmin) return;

    const settings = {
        duration: parseInt(document.getElementById('soloGameDuration').value) || 30,
        itemDisappearTime: parseInt(document.getElementById('soloItemDisappearTime').value) || 1200,
        itemInterval: parseInt(document.getElementById('soloItemInterval').value) || 600,
        bombChance: parseInt(document.getElementById('soloBombChance').value) || 40,
        timeChance: parseInt(document.getElementById('soloTimeChance').value) || 8,
        goldChance: parseInt(document.getElementById('soloGoldChance').value) || 6,
        specialChance: parseInt(document.getElementById('soloSpecialChance').value) || 4,
        normalChance: parseInt(document.getElementById('soloNormalChance').value) || 50,
        timeValue: parseInt(document.getElementById('soloTimeValue').value) || 3,
        bombValue: parseInt(document.getElementById('soloBombValue').value) || -75,
        goldValue: parseInt(document.getElementById('soloGoldValue').value) || 100,
        normalValue: parseInt(document.getElementById('soloNormalValue').value) || 50,
        specialItemType: document.getElementById('soloSpecialItemType').value || 'boxRight',
        // --- YENİ EKLENEN SATIR: Sadece bu ayar ekranı için adet bilgisini kaydeder ---
        specialValue: parseInt(document.getElementById('soloSpecialValue').value) || 1
    };

    const totalChance = settings.bombChance + settings.timeChance + settings.goldChance + settings.specialChance + settings.normalChance;

    await db.ref('gameSettings/clickCatchSolo').set(settings);

    if (totalChance !== 100) {
        displayMessage("Uyarı: Şans yüzdelerinin toplamı 100 değil! Lütfen değerleri kontrol et. Ayarlar yine de kaydedildi.");
    } else {
        displayMessage("Tekli oyun ayarları başarıyla kaydedildi.");
    }
}


// --- ESKİ loadSoloGameSettings FONKSİYONUNU SİL, BUNU YAPIŞTIR ---

async function loadSoloGameSettings() {
    const settingsSnap = await db.ref('gameSettings/clickCatchSolo').once('value');
    if (settingsSnap.exists()) {
        soloGameSettings = settingsSnap.val();
    }
    document.getElementById('soloGameDuration').value = soloGameSettings.duration;
    document.getElementById('soloItemDisappearTime').value = soloGameSettings.itemDisappearTime;
    document.getElementById('soloItemInterval').value = soloGameSettings.itemInterval;
    document.getElementById('soloBombChance').value = soloGameSettings.bombChance;
    document.getElementById('soloTimeChance').value = soloGameSettings.timeChance;
    document.getElementById('soloGoldChance').value = soloGameSettings.goldChance;
    document.getElementById('soloSpecialChance').value = soloGameSettings.specialChance;
    document.getElementById('soloNormalChance').value = soloGameSettings.normalChance || 50;
    document.getElementById('soloTimeValue').value = soloGameSettings.timeValue || 3;
    document.getElementById('soloBombValue').value = soloGameSettings.bombValue || -75;
    document.getElementById('soloGoldValue').value = soloGameSettings.goldValue || 100;
    document.getElementById('soloNormalValue').value = soloGameSettings.normalValue || 50;
    document.getElementById('soloSpecialItemType').value = soloGameSettings.specialItemType || 'boxRight';
    // --- YENİ EKLENEN SATIR: Sadece bu ayar ekranı için adet bilgisini yükler ---
    document.getElementById('soloSpecialValue').value = soloGameSettings.specialValue || 1;
}


// --- ESKİ startSoloClickCatchGame FONKSİYONUNU SİL, BUNU YAPIŞTIR ---

async function startSoloClickCatchGame() {
    if (lobbyGameSettings && lobbyGameSettings.state && (lobbyGameSettings.state === 'waiting' || lobbyGameSettings.state === 'active')) {
        displayMessage("Şu anda aktif bir lobi var. Lobi sona erdiğinde tekli oyun oynayabilirsiniz.");
        return;
    }
    if (clickCatchGameActive) return;
    if (isAdmin) {
        displayMessage("Adminler bu oyunu oynayamaz.");
        return;
    }
    await loadSoloGameSettings();
    const userRef = db.ref('users/' + currentUser);
    const userSnap = await userRef.once('value');
    const userData = userSnap.val();
    if ((!userData.clickCatchTickets || userData.clickCatchTickets < 1)) {
        displayMessage("Bu oyunu oynamak için 'Tıkla-Yakala Bileti'ne ihtiyacın var. Mağazadan alabilirsin.");
        return;
    }
    const confirmed = await customConfirm("Oyuna başlamak için 1 adet 'Tıkla-Yakala Bileti' harcanacaktır. Onaylıyor musun?");
    if (!confirmed) return;
    await userRef.update({ clickCatchTickets: (userData.clickCatchTickets || 0) - 1 });
    
    // --- DEĞİŞEN KISIM: Artık ayarlardan "specialValue" yani adet değerini de okuyor ---
    const specialItemMapping = {
      'boxRight': { type: 'boxRight', value: soloGameSettings.specialValue || 1, emoji: '📦' },
      'iflasShield': { type: 'iflasShield', value: soloGameSettings.specialValue || 1, emoji: '🛡️' },
      'wheelTicket': { type: 'wheelTicket', value: soloGameSettings.specialValue || 1, emoji: '🎫️' }
    };
    specialItemForThisRound = specialItemMapping[soloGameSettings.specialItemType] || specialItemMapping['boxRight'];
    
    clickCatchGameActive = true;
    clickCatchScore = 0;
    clickCatchTimer = soloGameSettings.duration;
    collectedBoxRights = 0;
    collectedIflasShields = 0;
    collectedWheelTickets = 0;
    document.getElementById('clickCatchScore').textContent = clickCatchScore;
    document.getElementById('clickCatchTimer').textContent = clickCatchTimer;
    document.getElementById('displayScore').classList.remove('hidden');
    document.getElementById('displaySpecials').classList.remove('hidden');
    document.getElementById('displayTimer').classList.remove('hidden');
    document.getElementById('displayTarget').classList.add('hidden');
    document.getElementById('collectedSpecials').innerHTML = '';
    showGameCountdown(_actuallyStartSoloGame);
}

async function endSoloClickCatchGame() {
    clickCatchGameActive = false;
    clearInterval(clickCatchTimerInterval);
    clearInterval(clickCatchItemInterval);
    clickCatchTimerInterval = null;
    clickCatchItemInterval = null;

    const gameArea = document.getElementById('clickCatchGameArea');
    const itemsToRemove = gameArea.querySelectorAll('.catch-item, .floating-text');
    itemsToRemove.forEach(item => item.remove());

    document.getElementById('clickCatchStartScreen').style.display = 'flex';
    document.getElementById('displayScore').classList.add('hidden');
    document.getElementById('displaySpecials').classList.add('hidden');
    document.getElementById('displayTimer').classList.add('hidden');

    const specialItemsWonLog = [];
    if (collectedBoxRights > 0) specialItemsWonLog.push(`+${collectedBoxRights} Kutu Hakkı`);
    if (collectedIflasShields > 0) specialItemsWonLog.push(`+${collectedIflasShields} İflas Kalkanı`);
    if (collectedWheelTickets > 0) specialItemsWonLog.push(`+${collectedWheelTickets} Çark Bileti`);

    let endMessage = `Oyun bitti! Bu turdaki skorun: <b>${clickCatchScore}</b>.`;
    if (specialItemsWonLog.length > 0) {
        endMessage += `<br>Ayrıca, <b>${specialItemsWonLog.join(', ')}</b> kazandın!`;
    }
    displayMessage(endMessage);

    const weeklyScoreRef = db.ref(`clickCatchWeeklyScores/${currentUser}`);
    const userRef = db.ref('users/' + currentUser);

    const [weeklyScoreSnap, userSnap] = await Promise.all([weeklyScoreRef.once('value'), userRef.once('value')]);
    
    const currentWeeklyScore = weeklyScoreSnap.val() || 0;
    const newTotalWeeklyScore = currentWeeklyScore + Math.max(0, clickCatchScore);
    const user = userSnap.val();

    logActivity('clickCatchSolo', currentUser, {
        score: clickCatchScore,
        specialItems: specialItemsWonLog,
        newWeeklyScore: newTotalWeeklyScore // Yeni haftalık skoru log'a ekliyoruz
    });
    
    // Veritabanı güncellemelerini tek bir işlemde birleştiriyoruz
    const updates = {};
    updates[`clickCatchWeeklyScores/${currentUser}`] = newTotalWeeklyScore;
    updates[`users/${currentUser}/clickCatchHighestScore`] = newTotalWeeklyScore;
    updates[`users/${currentUser}/kutuHakki`] = (user.kutuHakki || 0) + collectedBoxRights;
    updates[`users/${currentUser}/iflasShieldUses`] = (user.iflasShieldUses || 0) + collectedIflasShields;
    updates[`users/${currentUser}/carkBileti`] = (user.carkBileti || 0) + collectedWheelTickets;

    await db.ref().update(updates);
}

  // ... VE YERİNE BU YENİ VERSİYONU YAPIŞTIR
async function openSelectWinnerModal() {
    if (!isAdmin) return;

    const winnerInfoDiv = document.getElementById('winnerInfoForAdmin');
    winnerInfoDiv.innerHTML = '<p class="text-gray-400">Lider bilgisi yükleniyor...</p>';
    
    const scoresSnap = await db.ref('clickCatchWeeklyScores').orderByValue().limitToLast(1).once('value');
    
    // --- DEĞİŞİKLİK BURADA ---
    // Eğer sıralama boşsa (scoresSnap.exists() false ise)
    if (!scoresSnap.exists()) {
        // Ödül penceresini açmak yerine genel bilgilendirme mesajı göster
        displayMessage("Ödül verilecek bir lider bulunamadı çünkü Tıkla-Yakala sıralaması şu anda boş.");
        // ve fonksiyonu burada bitir.
        return;
    }
    
    const scoresData = scoresSnap.val();
    const winnerUsername = Object.keys(scoresData)[0];
    const winnerScore = scoresData[winnerUsername];

    winnerInfoDiv.innerHTML = `
        <p>Haftanın Lideri: <b class="text-white text-lg">${winnerUsername}</b></p>
        <p>Toplam Skoru: <b class="text-yellow-300 text-lg">${winnerScore}</b></p>
    `;
    
    window.weeklyWinnerData = { username: winnerUsername, score: winnerScore };

    document.getElementById('selectWinnerPrizeModal').style.display = 'flex';
}

// Ödül verme penceresini kapatır
function closeSelectWinnerModal() {
    document.getElementById('selectWinnerPrizeModal').style.display = 'none';
    window.weeklyWinnerData = null;
}

// ... VE YERİNE BU YENİ VERSİYONU YAPIŞTIR
async function confirmAndAwardPrize() {
    if (!isAdmin || !window.weeklyWinnerData) return;

    const { username, score } = window.weeklyWinnerData;
    const prizeType = document.getElementById('prizeType').value;
    const prizeAmount = parseInt(document.getElementById('prizeAmount').value);

    if (isNaN(prizeAmount) || prizeAmount <= 0) {
        displayMessage("Lütfen geçerli bir ödül miktarı girin.");
        return;
    }

    const prizeNames = {
        boxRights: "Kutu Hakkı",
        points: "Puan",
        wheelTicket: "Çark Bileti",
        iflasShield: "İflas Kalkanı"
    };
    const prizeName = prizeNames[prizeType];

    const confirmed = await customConfirm(
        `<b>${username}</b> adlı kullanıcıya <b>${prizeAmount} ${prizeName}</b> ödülü verilecek ve Tıkla-Yakala haftası sıfırlanacak. Onaylıyor musunuz?`
    );

    if (!confirmed) return;

    // --- YENİ ADIMLAR ---
    // Önce o hafta oyuna katılan herkesi bulalım.
    const weeklyScoresSnap = await db.ref('clickCatchWeeklyScores').once('value');
    const participants = weeklyScoresSnap.exists() ? Object.keys(weeklyScoresSnap.val()) : [];
    // --- YENİ ADIMLAR BİTİŞ ---

    // 1. Kazananın bilgilerini kalıcı olarak kaydet
    const winnerDataToSave = {
        winnerName: username,
        winningScore: score,
        prizeAwarded: `${prizeAmount} ${prizeName}`,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    await db.ref('gameStats/weeklyClickCatchWinner').set(winnerDataToSave);

    // 2. Kazanan kullanıcıya ödülünü ver
    const winnerUserRef = db.ref(`users/${username}`);
    await winnerUserRef.transaction(user => {
        if (user) {
            if (prizeType === 'points') user.balance = (user.balance || 0) + prizeAmount;
            else if (prizeType === 'boxRights') user.kutuHakki = (user.kutuHakki || 0) + prizeAmount;
            else if (prizeType === 'wheelTicket') user.carkBileti = (user.carkBileti || 0) + prizeAmount;
            else if (prizeType === 'iflasShield') user.iflasShieldUses = (user.iflasShieldUses || 0) + prizeAmount;
        }
        return user;
    });

    // 3. Haftalık skor tablosunu sil
    await db.ref('clickCatchWeeklyScores').remove();

    // 4. Tüm kullanıcıların skorlarını ve BİLET HEDİYELERİNİ güncelle
    const allUsersSnap = await db.ref('users').once('value');
    const allUsers = allUsersSnap.val();
    const updates = {};
    for (const u in allUsers) {
        // Kişisel skoru sıfırla (eğer varsa)
        if (allUsers[u].clickCatchHighestScore) {
            updates[`/users/${u}/clickCatchHighestScore`] = 0;
        }
        // Eğer bu kullanıcı o hafta katılım gösterdiyse +1 bilet hediye et
        if (participants.includes(u)) {
            const currentTickets = allUsers[u].clickCatchTickets || 0;
            updates[`/users/${u}/clickCatchTickets`] = currentTickets + 1;
        }
    }
    if (Object.keys(updates).length > 0) {
        await db.ref().update(updates);
    }
    
    // --- YENİ BİLGİLENDİRME ADIMI ---
    // Global bir bildirim göndererek herkesi bilgilendir
    const notificationMessage = `Tıkla-Yakala haftasının şampiyonu ${username} oldu! Kendisini tebrik ederiz. Yeni hafta başladı!`;
    db.ref('globalNotifications').push({ message: notificationMessage, timestamp: firebase.database.ServerValue.TIMESTAMP });
    // --- YENİ BİLGİLENDİRME BİTİŞ ---


    displayMessage(`${username} ödüllendirildi ve Tıkla-Yakala haftası başarıyla sıfırlandı! Katılımcılara +1 bilet hediye edildi.`);
    closeSelectWinnerModal();
}

// Haftanın kazananı verisini dinler ve paneli günceller
function listenForWeeklyWinner() {
    const ref = db.ref('gameStats/weeklyClickCatchWinner');
    const container = document.getElementById('weeklyWinnerContainer');
    const infoDiv = document.getElementById('weeklyWinnerInfo');
    const clearBtn = document.getElementById('clearWeeklyWinnerBtn');

    const callback = snap => {
        const winnerData = snap.val();
        if (winnerData) {
            infoDiv.innerHTML = `
                <p>Kazanan: <b class="text-white">${winnerData.winnerName}</b></p>
                <p>Skor: <b class="text-white">${winnerData.winningScore}</b></p>
                <p>Ödül: <b class="text-green-400">${winnerData.prizeAwarded}</b></p>
            `;
            container.classList.remove('hidden');
            if (isAdmin) {
                clearBtn.classList.remove('hidden');
            }
        } else {
            container.classList.add('hidden');
        }
    };
    
    // Listener'ı tekrar tekrar eklememek için kontrol
    if (activeListeners.weeklyWinner) {
        activeListeners.weeklyWinner.ref.off('value', activeListeners.weeklyWinner.callback);
    }
    activeListeners.weeklyWinner = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// Adminin kazanan panelini kapatmasını sağlar
async function clearWeeklyWinnerDisplay() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Haftanın kazananı panelini gizlemek istediğinize emin misiniz? Bu işlem kazananı veya ödülünü silmez, sadece paneli gizler.");
    if (confirmed) {
        await db.ref('gameStats/weeklyClickCatchWinner').remove();
    }
}

// --- YENİ FONKSİYONLAR BİTİŞ ---

function initActivityFeed() {
    const activityBellContainer = document.getElementById('activityBellContainer');
    const activityCounter = document.getElementById('activityCounter');
    const activityFeedPanel = document.getElementById('activityFeedPanel');
    const activityFeedList = document.getElementById('activityFeedList');

    activityBellContainer.classList.remove('hidden');

    const userFeedStatusRef = db.ref(`users/${currentUser}/lastCheckedFeedTimestamp`);
    // initActivityFeed fonksiyonu içinde bu satırla değiştir:
const ref = db.ref('activityFeed').orderByChild('timestamp').limitToLast(20);

    const callback = async (snapshot) => {
        const feedData = snapshot.val();
        
        if (!feedData) {
            renderActivityFeed([]); 
            activityCounter.classList.add('hidden'); 
            return;
        }

        const userStatusSnap = await userFeedStatusRef.once('value');
        const lastChecked = userStatusSnap.val() || 0;
        
        let unreadCount = 0;
        
        const sortedActivities = Object.keys(feedData).map(key => {
            return { id: key, ...feedData[key] };
        }).sort((a, b) => b.timestamp - a.timestamp);

        sortedActivities.forEach(activity => {
            if (activity.timestamp > lastChecked) {
                unreadCount++;
            }
        });

        if (unreadCount > 0) {
            activityCounter.textContent = unreadCount > 9 ? '9+' : unreadCount;
            activityCounter.classList.remove('hidden');
        } else {
            activityCounter.classList.add('hidden');
        }
        
        renderActivityFeed(sortedActivities);
    };

    activeListeners.activityFeed = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// --- MEVCUT İLGİLİ FONKSİYONLARI KOMPLE SİLİP BUNU YAPIŞTIR ---

function logActivity(type, username, details = {}) {
    // WeizendTv'nin kendi eylemlerini loglama (örneğin lobi iptali)
    if (username.toLowerCase() === 'weizendtv') {
        return;
    }
    const activityData = {
        type,
        username,
        details,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    const newActivityRef = db.ref('activityFeed').push();
    newActivityRef.set(activityData);

    const feedRef = db.ref('activityFeed');
    feedRef.orderByChild('timestamp').once('value', (snapshot) => {
        const totalCount = snapshot.numChildren();
        const limit = 20;

        if (totalCount > limit) {
            let itemsToDeleteCount = totalCount - limit;
            snapshot.forEach((childSnapshot) => {
                if (itemsToDeleteCount <= 0) {
                    return true; 
                }
                childSnapshot.ref.remove();
                itemsToDeleteCount--;
            });
        }
    });
}

// MEVCUT getActivityIcon FONKSİYONUNU SİLİP BUNUNLA DEĞİŞTİRİN

function getActivityIcon(type, details = {}) {
    let icon = '🔔';
    let bgColor = 'bg-gray-500';

    switch (type) {
        case 'openBox':
            icon = '💰';
            bgColor = 'bg-green-500';
            break;
        case 'surpriseBox':
            icon = '🎉';
            bgColor = 'bg-yellow-500';
            break;
        case 'iflas':
            if (details.shieldUsed) {
                icon = '🛡️';
                bgColor = 'bg-blue-500';
            } else if (details.multiplier && details.multiplier > 1) {
                icon = '❌'; 
                bgColor = 'bg-red-800';
            } else {
                icon = '💣';
                bgColor = 'bg-red-600';
            }
            break;
        case 'multiplierUpgraded':
            icon = '❎';
            bgColor = 'bg-teal-500';
            break;
        case 'multiplierFound':
        case 'multiplierRefund':
            icon = '✖️';
            bgColor = 'bg-purple-500';
            break;
        case 'multiplierUpgradedFromStore':
        case 'multiplierStackedFromStore':
        case 'buyItem':
            icon = '🛒';
            bgColor = 'bg-indigo-500';
            break;
        case 'multiplierDiscarded':
            icon = '❎';
            bgColor = 'bg-gray-600';
            break;
        // --- YENİ EKLENEN CASE ---
        case 'multiplierConvertedToBoxRights':
            icon = '♻️';
            bgColor = 'bg-lime-600';
            break;
        // --- YENİ EKLENEN CASE SONU ---
        case 'newItemFound':
            const itemType = details.itemType;
            if (itemType === 'iflasShield') {
                icon = '🛡️';
            } else if (itemType === 'wheelTicket') {
                icon = '🎫';
            } else if (itemType === 'clickCatchTicket') {
                icon = '🎟️';
            } else {
                icon = '📦';
            }
            bgColor = 'bg-cyan-500';
            break;
        case 'spinWheel':
            icon = '🎡';
            bgColor = 'bg-pink-500';
            break;
        case 'lobbyJoined':
            icon = '🎮';
            bgColor = 'bg-blue-600';
            break;
        case 'clickCatchSolo':
        case 'clickCatchLobby':
            icon = '🎯';
            bgColor = 'bg-orange-500';
            break;
        case 'dailyReward':
            icon = '📅';
            bgColor = 'bg-teal-500';
            break;
        case 'surpriseBoxTimeout':
            icon = '⏰';
            bgColor = 'bg-gray-600';
            break;
    }

    return `
        <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center ${bgColor} shadow-lg">
            <span class="text-2xl">${icon}</span>
        </div>
    `;
}

// MEVCUT renderActivityFeed FONKSİYONUNU SİLİP BUNUNLA DEĞİŞTİRİN

function renderActivityFeed(activities) {
    const activityFeedList = document.getElementById('activityFeedList');
    activityFeedList.innerHTML = '';

    if (isAdmin) {
        const clearButtonHtml = `
            <div class="px-2 mb-2 text-center">
                <button onclick="clearAllActivities()" class="w-full py-2 px-4 bg-red-800/50 hover:bg-red-700 text-white font-bold rounded-lg shadow-md text-sm border border-red-600">
                    Eylem Geçmişini Temizle
                </button>
            </div>
        `;
        activityFeedList.innerHTML += clearButtonHtml;
    }

    if (!activities || activities.length === 0) {
        activityFeedList.innerHTML += '<p class="text-center text-gray-400 p-4">Gösterilecek eylem bulunamadı.</p>';
        return;
    }
    
    const typeToName = {
        points: 'Puan',
        boxRights: 'Kutu Hakkı',
        iflasShield: 'İflas Kalkanı',
        wheelTicket: 'Çark Bileti',
        clickCatchTicket: 'Tıkla-Yakala Bileti',
        tempMultiplier: 'Çarpan'
    };

    activities.forEach(activity => {
        try {
            if (!activity || !activity.username || !activity.type) { 
                return; 
            }

            const details = activity.details || {};
            let iconHtml = getActivityIcon(activity.type, details);
            let message = '';
            const timeAgo = formatRelativeTime(activity.timestamp);
            const deleteButtonHtml = isAdmin ? `<button onclick="deleteActivity('${activity.id}')" class="ml-2 p-1 rounded-full text-gray-500 hover:text-red-500 hover:bg-white/10 transition-colors" title="Bu Eylemi Sil"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>` : '';
            const userHtml = `<b class="text-yellow-300 cursor-pointer hover:underline" onclick="openPublicUserDetailModal('${activity.username}')">${activity.username}</b>`;

            const remainingBalanceText = (details.newBalance !== undefined && details.newBalance !== null) 
                ? ` <span class="text-gray-400">(Mevcut Puan: ${details.newBalance})</span>`
                : '';
            
            const weeklyScoreText = (details.newWeeklyScore !== undefined && details.newWeeklyScore !== null)
                ? ` <span class="text-gray-400">(Mevcut Haftalık Skor: ${details.newWeeklyScore})</span>`
                : '';

            switch (activity.type) {
                // --- YENİ EKLENEN CASE BLOĞU ---
                case 'multiplierConvertedToBoxRights':
                    message = `${userHtml}, mevcut güçlü çarpanını koruyarak, günlük ödülden gelen ${details.rewardValue}x çarpanını <span class="text-cyan-300 font-bold">+${details.boxRights} Kutu Hakkı'na</span> dönüştürdü.`;
                    break;
                case 'multiplierStackedFromStore':
                    message = `${userHtml}, mağazadan <span class="text-red-400 font-bold">-${details.cost} Puan</span> harcayarak <b>${details.multiplierValue}x çarpanına</b> <span class="text-green-300 font-bold">+${details.usesAdded} kullanım hakkı</span> ekledi ve toplam <span class="text-green-300 font-bold">${details.newTotalUses} kullanım hakkı</span> oldu. <span class="text-gray-400">(Hesabında ${details.newBalance} puanı kaldı.)</span>`;
                    break;
                case 'multiplierStacked':
                    message = `${userHtml}, mevcut <b>${details.value}x</b> çarpanına <span class="text-green-300 font-bold">+${details.uses} kullanım hakkı</span> ekledi.`;
                    break;
                case 'multiplierUpgradedFromStore':
                    message = `${userHtml}, mağazadan yaptığı alımla eski ${details.oldValue}x çarpanını <span class="text-cyan-300 font-bold">${details.boxRights} Kutu Hakkı'na</span> dönüştürdü ve yeni <b>${details.newValue}x</b> çarpanına geçti.`;
                    break;
                case 'multiplierUpgraded':
                    message = `${userHtml}, eski ${details.oldValue}x çarpanını <span class="text-cyan-300 font-bold">${details.boxRights} Kutu Hakkı'na</span> dönüştürerek kutudan çıkan daha güçlü <b>${details.newValue}x</b> çarpanına geçti!`;
                    break;
                case 'multiplierDiscarded':
                    message = `${userHtml}, kutudan ${details.discardedValue}x çarpan buldu ancak mevcut <b>${details.keptValue}x</b> çarpanı daha güçlü olduğu için korundu.`;
                    break;
                case 'openBox':
                    let openBoxMultiplierText = (details.multiplier && details.multiplier > 1)
                        ? ` <span class="text-xs text-purple-400">(${details.multiplier}x çarpan kullandı)</span>`
                        : ``;
                    message = `${userHtml}, <b>${details.boxId}</b> numaralı kutudan <span class="text-green-300 font-bold">+${details.points} Puan</span> kazandı${openBoxMultiplierText}.${remainingBalanceText}`;
                    break;
                case 'iflas':
                    let iflasMultiplierText = (details.multiplier && details.multiplier > 1)
                        ? ` <span class="text-xs text-purple-400">(${details.multiplier}x çarpan kullanıldı)</span>`
                        : ``;
                    message = details.shieldUsed 
                        ? `${userHtml}, <b>${details.boxId}</b> numaralı kutudan bomba buldu ama kalkanı korudu${iflasMultiplierText}.`
                        : `${userHtml}, <b>${details.boxId}</b> numaralı kutudan bomba buldu ve <span class="text-red-400 font-bold">-${details.lostPoints} Puan</span> kaybetti${iflasMultiplierText}.${remainingBalanceText}`;
                    break;
                case 'surpriseBox':
                    let surpriseMultiplierText = (details.multiplier && details.multiplier > 1)
                        ? ` <span class="text-xs text-purple-400">(${details.multiplier}x çarpan kullandı)</span>`
                        : ``;
                    const source = details.boxId === 'Çark' ? 'Şans Çarkı\'ndan' : `<b>${details.boxId}</b> numaralı kutudan`;
                    message = `${userHtml}, ${source} Sürpriz Kutu buldu ve <span class="text-green-300 font-bold">+${details.points} Puan</span> kazandı${surpriseMultiplierText}!${remainingBalanceText}`;
                    break;
                case 'multiplierFound':
                    message = `${userHtml}, <b>${details.boxId}</b> numaralı kutudan <span class="text-purple-300 font-bold">${details.value}x Çarpan</span> buldu.`;
                    break;
                case 'multiplierRefund':
                     message = `${userHtml}, <b>${details.boxId}</b> numaralı kutudan <span class="text-purple-300 font-bold">${details.newMultiplier}x Çarpan</span> buldu ve mağaza çarpanı iade edildi.`;
                    break;
                case 'newItemFound':
                     let newItemMultiplierText = (details.multiplier && details.multiplier > 1)
                        ? ` <span class="text-xs text-purple-400">(${details.multiplier}x çarpan kullandı)</span>`
                        : ``;
                    message = `${userHtml}, <b>${details.boxId}</b> numaralı kutudan <span class="text-cyan-300 font-bold">${details.itemName}</span> buldu${newItemMultiplierText}.`;
                    break;
                case 'buyItem':
                    let purchasedItemText = '';
                    if (details.itemType === 'tempMultiplier') {
                        purchasedItemText = `<span class="text-indigo-300 font-bold">${details.itemDuration} Adet ${details.itemValue}x Çarpan</span>`;
                    } else if (details.itemValue) {
                        const itemName = typeToName[details.itemType] || details.itemName;
                        purchasedItemText = `<span class="text-indigo-300 font-bold">+${details.itemValue} ${itemName}</span>`;
                    } else {
                        purchasedItemText = `<span class="text-indigo-300 font-bold">${details.itemName}</span>`;
                    }
                    message = `${userHtml}, mağazadan <span class="text-red-400 font-bold">-${details.itemCost} Puan</span> harcayarak ${purchasedItemText} aldı.${remainingBalanceText}`;
                    break;
                case 'lobbyJoined':
                    message = `${userHtml}, Tıkla-Yakala lobisine <span class="text-red-400 font-bold">-${details.cost} Puan</span> karşılığında katıldı.${remainingBalanceText}`;
                    break;
                case 'spinWheel':
                    let prizeText = '';
                    const prizeType = details.type;
                    const prizeValue = details.value;

                    if (prizeType === 'pas') {
                        message = `${userHtml}, çarkı çevirdi ve <span class="text-gray-400 font-bold">Pas</span> geçti.`;
                    } else {
                        if (prizeType === 'points') {
                            prizeText = `+${prizeValue} Puan`;
                        } else if (prizeType === 'tempMultiplier') {
                            prizeText = `${prizeValue}X Çarpan`;
                        } else {
                            prizeText = `+${prizeValue} ${typeToName[prizeType] || prizeType}`;
                        }
                        message = `${userHtml}, çarkı çevirerek <span class="text-pink-300 font-bold">${prizeText}</span> kazandı.${remainingBalanceText}`;
                    }
                    break;
                case 'clickCatchSolo':
                    if (details.score > 0) {
                        message = `${userHtml}, Tıkla-Yakala oynadı ve <span class="text-green-300 font-bold">+${details.score} Skor</span> topladı.${weeklyScoreText}`;
                    } else if (details.score < 0) {
                        message = `${userHtml}, Tıkla-Yakala oynadı ve <span class="text-red-400 font-bold">${details.score} Skor</span> kaybetti.${weeklyScoreText}`;
                    } else {
                        message = `${userHtml}, Tıkla-Yakala oynadı ancak skor toplayamadı.${weeklyScoreText}`;
                    }

                    if (details.specialItems && details.specialItems.length > 0) {
                        message += ` Ayrıca, <span class="text-cyan-300 font-bold">${details.specialItems.join(', ')}</span> kazandı.`;
                    }
                    break;
                case 'clickCatchLobby':
                    message = `${userHtml}, lobi oyununu kazanarak <span class="text-yellow-300 font-bold">+${details.prize} Puan</span> ödül aldı!${remainingBalanceText}`;
                    break;
                case 'dailyReward':
                    let rewardText = '';
                    const rewardType = details.rewardType;
                    const rewardValue = details.rewardValue;

                    if (rewardType === 'points') {
                        rewardText = `+${rewardValue} Puan`;
                    } else if (rewardType === 'tempMultiplier') {
                        rewardText = `${details.rewardUses} adet ${rewardValue}x Çarpan`;
                    } else {
                        rewardText = `+${rewardValue} ${typeToName[rewardType] || details.rewardName}`;
                    }
                    message = `${userHtml}, günlük ödül olarak <span class="text-teal-300 font-bold">${rewardText}</span> aldı.${remainingBalanceText}`;
                    break;
                case 'surpriseBoxTimeout':
                    message = `${userHtml}, Sürpriz Kutu şansını süre dolduğu için kaçırdı.`;
                    break;
                default:
                    message = `${userHtml} bir eylem gerçekleştirdi. (Tip: ${activity.type})`;
                    break;
            }

            const activityHtml = `
                <div class="bg-gray-800/70 p-3 rounded-xl flex items-center gap-4 border border-transparent hover:border-gray-700 transition-all duration-200">
                    ${iconHtml}
                    <div class="flex-1 min-w-0">
                        <p class="text-gray-200 text-sm leading-relaxed">${message}</p>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500">${timeAgo}</span>
                            ${deleteButtonHtml}
                        </div>
                    </div>
                </div>`;
            
            activityFeedList.innerHTML += activityHtml;
        } catch (error) {
            console.error("Bir aktivite işlenirken hata oluştu, bu eylem atlandı:", error);
            console.error("Hatalı aktivite verisi:", activity);
        }
    });
}

function initActivityFeed() {
    const activityBellContainer = document.getElementById('activityBellContainer');
    const activityCounter = document.getElementById('activityCounter');
    
    activityBellContainer.classList.remove('hidden');

    const userFeedStatusRef = db.ref(`users/${currentUser}/lastCheckedFeedTimestamp`);
    const ref = db.ref('activityFeed').orderByChild('timestamp').limitToLast(20);

    const callback = async (snapshot) => {
        const feedData = snapshot.val();
        
        if (!feedData) {
            renderActivityFeed([]); 
            activityCounter.classList.add('hidden'); 
            return;
        }

        const userStatusSnap = await userFeedStatusRef.once('value');
        const lastChecked = userStatusSnap.val() || 0;
        
        let unreadCount = 0;
        
        const sortedActivities = Object.keys(feedData).map(key => {
            return { id: key, ...feedData[key] };
        }).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        sortedActivities.forEach(activity => {
            if (activity.timestamp > lastChecked) {
                unreadCount++;
            }
        });

        if (unreadCount > 0) {
            activityCounter.textContent = unreadCount > 9 ? '9+' : unreadCount;
            activityCounter.classList.remove('hidden');
        } else {
            activityCounter.classList.add('hidden');
        }
        
        renderActivityFeed(sortedActivities);
    };

    activeListeners.activityFeed = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// ...VE YERİNE BU YENİ VERSİYONU YAPIŞTIR
function openActivityFeed() {
    const activityFeedPanel = document.getElementById('activityFeedPanel'); // EKLENEN SATIR
    const activityCounter = document.getElementById('activityCounter');   // EKLENEN SATIR
    activityFeedPanel.classList.remove('hidden');
    setTimeout(() => {
        activityFeedPanel.classList.remove('translate-x-full');
    }, 10);
    activityCounter.classList.add('hidden');
    db.ref(`users/${currentUser}/lastCheckedFeedTimestamp`).set(Date.now());
}

function closeActivityFeed() {
    const activityFeedPanel = document.getElementById('activityFeedPanel'); // EKLENEN SATIR
    activityFeedPanel.classList.add('translate-x-full');
    setTimeout(() => {
        activityFeedPanel.classList.add('hidden');
    }, 300);
}

function toggleActivityFeed() {
    const activityFeedPanel = document.getElementById('activityFeedPanel'); // EKLENEN SATIR
    if (activityFeedPanel.classList.contains('hidden')) {
        openActivityFeed();
    } else {
        closeActivityFeed();
    }
}

async function deleteActivity(activityId) {
    if (!isAdmin || !activityId) return;
    const confirmed = await customConfirm("Bu eylemi kalıcı olarak silmek istediğinize emin misiniz?");
    if (confirmed) {
        await db.ref('activityFeed/' + activityId).remove();
    }
}

async function clearAllActivities() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Tüm eylem geçmişini kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!");
    if (confirmed) {
        await db.ref('activityFeed').remove();
        renderActivityFeed([]);
    }
}

function formatRelativeTime(timestamp) {
  const now = new Date();
  const activityDate = new Date(timestamp);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const activityDay = new Date(timestamp);
  activityDay.setHours(0, 0, 0, 0);
  const dayDifference = Math.floor((today - activityDay) / (1000 * 60 * 60 * 24));
  const timeString = activityDate.toLocaleTimeString('tr-TR', {
    hour: '2-digit',
    minute: '2-digit'
  });

  if (dayDifference === 0) {
    return `Bugün, ${timeString}`;
  } else if (dayDifference === 1) {
    return `Dün, ${timeString}`;
  } else {
    return `${dayDifference} gün önce, ${timeString}`;
  }
}

// Yeni bir ayar satırı (Puan, Bilet vb.) oluşturup ekrana ekler.
function addBoxSettingRow(item = {}) {
    const container = document.getElementById('boxSettingsRowsContainer');
    const row = document.createElement('div');
    row.className = 'box-setting-row flex items-center gap-3 p-3 bg-gray-900 rounded-lg';

    // Değerleri önceden doldurmak için (kayıtlı ayarları yüklerken kullanılır)
    const type = item.type || 'points';
    const value = item.value || '';
    const count = item.count || '';

    row.innerHTML = `
        <select class="setting-type flex-grow bg-gray-700 p-2 rounded-md text-white border border-gray-600" onchange="handleRowTypeChange(this)">
            <option value="points" ${type === 'points' ? 'selected' : ''}>Puan</option>
            <option value="iflas" ${type === 'iflas' ? 'selected' : ''}>İflas (Bomba)</option>
            <option value="surpriz" ${type === 'surpriz' ? 'selected' : ''}>Sürpriz Kutu</option>
            <option value="multiplier" ${type === 'multiplier' ? 'selected' : ''}>Çarpan</option>
            <option value="wheelTicket" ${type === 'wheelTicket' ? 'selected' : ''}>Çark Bileti</option>
            <option value="clickCatchTicket" ${type === 'clickCatchTicket' ? 'selected' : ''}>Tıkla-Yakala Bileti</option>
            <option value="iflasShield" ${type === 'iflasShield' ? 'selected' : ''}>İflas Kalkanı</option>
        </select>
        <input type="number" value="${value}" class="setting-value w-28 bg-gray-700 p-2 rounded-md text-white border border-gray-600" placeholder="Değer">
        <input type="number" value="${count}" class="setting-count w-28 bg-gray-700 p-2 rounded-md text-white border border-gray-600" placeholder="Adet" oninput="updateTotalBoxCount()">
        <button class="bg-red-700 hover:bg-red-600 text-white p-2 rounded-md" onclick="this.parentElement.remove(); updateTotalBoxCount();">Sil</button>
    `;
    
    container.appendChild(row);
    handleRowTypeChange(row.querySelector('.setting-type')); // Satırın ilk durumunu ayarla
    updateTotalBoxCount(); // Eklendikten sonra toplam sayıyı güncelle
}

// Bir satırda tür seçimi değiştiğinde "Değer" input'unu aktif/pasif yapar.
function handleRowTypeChange(selectElement) {
    const row = selectElement.parentElement;
    const valueInput = row.querySelector('.setting-value');
    const selectedType = selectElement.value;

    // Puan ve Çarpan dışındaki her şey için "Değer" alanı gereksizdir.
    if (selectedType === 'points' || selectedType === 'multiplier') {
        valueInput.disabled = false;
        valueInput.placeholder = 'Değer';
        if(selectedType === 'multiplier') valueInput.placeholder = 'Değer (2, 3 vb.)';

    } else {
        valueInput.disabled = true;
        valueInput.placeholder = 'N/A';
        // Biletler için değeri otomatik 1 yapalım, diğerleri 0 kalabilir.
        if(selectedType === 'wheelTicket' || selectedType === 'clickCatchTicket' || selectedType === 'iflasShield'){
             valueInput.value = 1;
        } else {
             valueInput.value = 0;
        }
    }
}

// "Adet" inputlarından biri her değiştiğinde toplam kutu sayısını hesaplar ve gösterir.
function updateTotalBoxCount() {
    let total = 0;
    document.querySelectorAll('.box-setting-row .setting-count').forEach(input => {
        const count = parseInt(input.value);
        if (!isNaN(count) && count > 0) {
            total += count;
        }
    });
    document.getElementById('totalBoxCountDisplay').textContent = total;
}

// Tüm satırlardaki verileri okur, yeni ayarları veritabanına kaydeder ve oyunu sıfırlar.
async function saveBoxSettings() {
    if (!isAdmin) return;

    const newConfig = [];
    let totalBoxes = 0;
    let hasError = false;

    document.querySelectorAll('.box-setting-row').forEach(row => {
        const type = row.querySelector('.setting-type').value;
        const value = parseInt(row.querySelector('.setting-value').value);
        const count = parseInt(row.querySelector('.setting-count').value);

        // Doğrulama: Adet ve Değer alanları geçerli mi?
        if (isNaN(count) || count <= 0) {
            // Adet girilmemişse bu satırı atla
            return;
        }
        if (isNaN(value) && (type === 'points' || type === 'multiplier')) {
            displayMessage(`Hata: ${type} türü için geçerli bir 'Değer' girmelisiniz.`);
            hasError = true;
            return;
        }
        
        newConfig.push({ type, value, count });
        totalBoxes += count;
    });

    if (hasError) return; // Hata varsa işlemi durdur

    if (totalBoxes === 0) {
        displayMessage("En az bir kutu türü için adet girmelisiniz!");
        return;
    }

    const confirmed = await customConfirm(`Toplam ${totalBoxes} kutu ile yeni bir oyun başlatılacak. Mevcut oyun sıfırlanacak. Onaylıyor musunuz?`);
    if (confirmed) {
        await db.ref('gameConfig/boxContents').set(newConfig);
        await resetGameBoard(); 
        displayMessage("Kutu ayarları başarıyla kaydedildi ve oyun yeni ayarlarla yeniden başlatıldı!");
        closeBoxSettingsModal();
    }
}

    // YENİ: Kutu ayarlarını kodda tanımlı olan varsayılan değerlere döndürür.
async function resetBoxSettingsToDefault() {
    if (!isAdmin) return;
    
    const confirmed = await customConfirm("Mevcut ayarları silip varsayılan kutu yapılandırmasına dönmek istediğinize emin misiniz? <br><small>(Bu işlem, siz 'Kaydet' butonuna basana kadar kalıcı olmayacaktır.)</small>");
    if (!confirmed) return;

    const container = document.getElementById('boxSettingsRowsContainer');
    container.innerHTML = ''; // Paneli temizle

    // Script'in en başında tanımlı olan varsayılan BOX_CONTENTS listesini kullan
    BOX_CONTENTS.forEach(item => {
        addBoxSettingRow(item);
    });

    updateTotalBoxCount(); // Toplam kutu sayısını güncelle
}

    // Çark Ayarlarını veritabanından YÜKLEYEN ve sıralayan fonksiyon
async function loadWheelSettingsFromDB() {
    const settingsRef = db.ref('gameConfig/wheelSegments');
    const snapshot = await settingsRef.once('value');
    
    if (snapshot.exists() && snapshot.val() !== null) {
        const loadedData = snapshot.val();
        
        if (Array.isArray(loadedData)) {
            wheelSegments = loadedData.filter(item => item).sort((a, b) => (a.order || 0) - (b.order || 0));
        } else {
            wheelSegments = Object.values(loadedData).sort((a, b) => (a.order || 0) - (b.order || 0));
        }
    } else {
        // Firebase'de ayar yoksa varsayılanı kullan
        wheelSegments = defaultWheelSegments;
    }
    
    renderWheel();
}
function openWheelSettingsModal() {
    if (!isAdmin) return;
    const container = document.getElementById('wheelSettingsRowsContainer');
    container.innerHTML = '';
    wheelSegments.forEach(item => addWheelSettingRow(item));
    wheelSettingsModal.style.display = 'flex';
}

function closeWheelSettingsModal() {
    wheelSettingsModal.style.display = 'none';
}

function addWheelSettingRow(item = {}) {
    const container = document.getElementById('wheelSettingsRowsContainer');
    const row = document.createElement('div');
    // DÜZENLEME: Grid yapısı 7 sütuna çıkarıldı
    row.className = 'wheel-setting-row grid grid-cols-1 sm:grid-cols-7 items-center gap-3 p-3 bg-gray-900 rounded-lg';

    const type = item.type || 'points';
    const value = item.value || '';
    const duration = item.duration || '';
    const label = item.label || '';
    const imageUrl = item.imageUrl || ''; // YENİ: Resim URL'i eklendi
    const color = item.color || '#f44336';
    const weight = item.weight || 10;

    row.innerHTML = `
        <select class="setting-type col-span-1 bg-gray-700 p-2 rounded-md text-white border border-gray-600" onchange="handleWheelRowTypeChange(this)">
            <option value="points" ${type === 'points' ? 'selected' : ''}>Puan</option>
            <option value="boxRights" ${type === 'boxRights' ? 'selected' : ''}>Kutu Hakkı</option>
            <option value="iflasShield" ${type === 'iflasShield' ? 'selected' : ''}>Kalkan</option>
            <option value="tempMultiplier" ${type === 'tempMultiplier' ? 'selected' : ''}>Çarpan</option>
            <option value="surpriseBox" ${type === 'surpriseBox' ? 'selected' : ''}>Sürpriz Kutu</option>
            <option value="clickCatchTicket" ${type === 'clickCatchTicket' ? 'selected' : ''}>Tıkla-Yakala Bileti</option>
            <option value="wheelTicket" ${type === 'wheelTicket' ? 'selected' : ''}>Çark Bileti</option>
            <option value="pas" ${type === 'pas' ? 'selected' : ''}>Pas</option>
        </select>
        <input type="text" value="${label}" class="setting-label col-span-1 sm:col-span-2 bg-gray-700 p-2 rounded-md text-white" placeholder="Etiket (Örn: 100 Puan)">
        
        <input type="text" value="${imageUrl}" class="setting-image-url col-span-1 sm:col-span-2 bg-gray-700 p-2 rounded-md text-white" placeholder="Resim URL (Opsiyonel)">

        <input type="number" value="${value}" class="setting-value bg-gray-700 p-2 rounded-md text-white" placeholder="Değer">
        <input type="number" value="${duration}" class="setting-duration bg-gray-700 p-2 rounded-md text-white" placeholder="Süre/Kullanım">
        <div class="col-span-1 flex items-center gap-2">
            <input type="color" value="${color}" class="setting-color h-10 w-10 p-1 bg-gray-700 rounded-md">
            <input type="number" value="${weight}" class="setting-weight flex-grow bg-gray-700 p-2 rounded-md text-white" placeholder="Şans">
            <button class="bg-red-700 hover:bg-red-600 text-white p-2 rounded-md" onclick="this.parentElement.parentElement.remove();">Sil</button>
        </div>
    `;
    container.appendChild(row);
    handleWheelRowTypeChange(row.querySelector('.setting-type'));
}
    
function handleWheelRowTypeChange(selectElement) {
    const row = selectElement.closest('.wheel-setting-row');
    const valueInput = row.querySelector('.setting-value');
    const durationInput = row.querySelector('.setting-duration');
    const selectedType = selectElement.value;

    valueInput.disabled = false;
    durationInput.disabled = true;

    if (selectedType === 'pas') {
        valueInput.disabled = true;
    } else if (selectedType === 'tempMultiplier') {
        durationInput.disabled = false;
    }
}

async function saveWheelSettings() {
    if (!isAdmin) return;

    const newConfig = [];
    let hasError = false;
    document.querySelectorAll('.wheel-setting-row').forEach((row, index) => {
        if(hasError) return;
        
        const type = row.querySelector('.setting-type').value;
        const label = row.querySelector('.setting-label').value.trim();
        const imageUrl = row.querySelector('.setting-image-url').value.trim(); // YENİ: Resim URL'i okunuyor
        const value = parseInt(row.querySelector('.setting-value').value) || 0;
        const duration = parseInt(row.querySelector('.setting-duration').value) || 0;
        const color = row.querySelector('.setting-color').value;
        const weight = parseInt(row.querySelector('.setting-weight').value);

        if (!label || !color || isNaN(weight) || weight <= 0) {
            displayMessage("Her dilim için Etiket, Renk ve geçerli bir Şans Ağırlığı girmelisiniz.");
            hasError = true;
        }

        const segment = { type, label, imageUrl, color, weight, order: index }; // YENİ: imageUrl veriye eklendi
        if (!row.querySelector('.setting-value').disabled) segment.value = value;
        if (!row.querySelector('.setting-duration').disabled) segment.duration = duration;
        
        newConfig.push(segment);
    });

    if (hasError) return;
    
    if (newConfig.length === 0) {
        displayMessage("Çarkta en az bir dilim olmalıdır.");
        return;
    }

    const confirmed = await customConfirm("Yeni çark ayarları kaydedilecek. Onaylıyor musunuz?");
    if (confirmed) {
        await db.ref('gameConfig/wheelSegments').set(newConfig);
        await loadWheelSettingsFromDB();
        displayMessage("Şans Çarkı ayarları başarıyla kaydedildi.");
        closeWheelSettingsModal();
    }
}
    
async function resetWheelSettingsToDefault() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Mevcut ayarları silip varsayılan çark yapılandırmasına dönmek istediğinize emin misiniz? (Değişiklikleri kalıcı yapmak için kaydetmeniz gerekir.)");
    if (!confirmed) return;
    const container = document.getElementById('wheelSettingsRowsContainer');
    container.innerHTML = '';
    defaultWheelSegments.forEach(item => addWheelSettingRow(item));
}

function loadWheelHistory() {
    const historyRef = db.ref('wheelHistory').limitToLast(10);
    const listEl = document.getElementById('wheelHistoryList');
    
    const callback = (snapshot) => {
        listEl.innerHTML = ''; 

        if (isAdmin) {
            listEl.innerHTML += `<div class="p-1 mb-2 text-center"><button onclick="clearWheelHistory()" class="w-full py-2 px-4 bg-red-800 hover:bg-red-700 text-white font-bold rounded-lg shadow-md text-sm">Tüm Kazanan Geçmişini Temizle</button></div>`;
        }

        if (!snapshot.exists()) {
            listEl.innerHTML += '<p class="text-center text-gray-500">Henüz çark çevrilmedi.</p>';
            return;
        }
        
        const history = [];
        snapshot.forEach(child => { history.push({ key: child.key, ...child.val() }); });
        history.reverse();

        history.forEach(item => {
            const timeAgo = formatRelativeTime(item.timestamp);
            
            let icon = '❓';
            let prizeText = item.prize;
            const prizeType = item.type;
            const prizeValue = item.value;

            // YENİ İKON MANTIĞI BURADA
            if (prizeType === 'points') {
                if (prizeValue >= 1000) icon = '🎂';
                else if (prizeValue >= 250) icon = '🍐';
                else if (prizeValue >= 100) icon = '🍌';
                else icon = '🍆';
                prizeText = `+${prizeValue} PUAN`; 
            } else if (prizeType === 'surpriseBox') {
                icon = '🎉';
                prizeText = 'SÜRPRİZ KUTU';
            } else if (prizeType === 'boxRights') {
                icon = prizeValue > 1 ? '🎁' : '📦';
                prizeText = `+${prizeValue} Kutu Hakkı`;
            } else if (prizeType === 'clickCatchTicket') {
                icon = '🎟️';
                prizeText = `+${prizeValue} Tıkla-Yakala Bileti`;
            } else if (prizeType === 'wheelTicket') {
                icon = '🎡';
                prizeText = `+${prizeValue} Çark Bileti`;
            } else if (prizeType === 'tempMultiplier') {
                icon = '✖️';
                prizeText = `${prizeValue}X ÇARPAN`;
            } else if (prizeType === 'iflasShield') {
                icon = '🛡️';
                prizeText = `+${prizeValue} İflas Kalkanı`;
            } else if (prizeType === 'pas') {
                icon = '☠️';
                prizeText = 'PAS';
            }
            
            const deleteButton = isAdmin 
                ? `<button onclick="deleteWheelHistoryEntry('${item.key}')" class="ml-3 text-gray-500 hover:text-red-500 transition-colors" title="Bu Kaydı Sil">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                   </button>` 
                : '';

            listEl.innerHTML += `
                <div class="p-2 bg-gray-800 rounded-md mb-2 text-sm flex justify-between items-center">
                    <span class="flex items-center">
                        <b>${item.username}:</b> 
                        <span class="text-yellow-200 ml-2 flex items-center gap-2">
                            <span>${prizeText}</span>
                            <span class="text-lg">${icon}</span>
                        </span>
                    </span>
                    <div class="flex items-center">
                        <span class="text-gray-500 text-xs">${timeAgo}</span>
                        ${deleteButton}
                    </div>
                </div>
            `;
        });
    };

    if (activeListeners.wheelHistory) {
      historyRef.off('value', activeListeners.wheelHistory.callback);
    }
    activeListeners.wheelHistory = { ref: historyRef, event: 'value', callback };
    historyRef.on('value', callback);
}
  function openHelpModal() {
  helpModal.style.display = 'flex';
}
function closeHelpModal() {
  helpModal.style.display = 'none';
}

  function closeAvatarSelectionModal() {
        avatarSelectionModal.style.display = 'none';
    }

    async function openAvatarSelectionModal() {
        closeInventoryModal(); // Önce envanter penceresini kapat
        avatarSelectionModal.style.display = 'flex';
        const avatarGrid = document.getElementById('avatarGrid');
        avatarGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">Yükleniyor...</p>';

        const userRef = db.ref('users/' + currentUser);
        const userSnap = await userRef.once('value');
        const userData = userSnap.val();
        
        const purchasedAvatars = userData.avatars || {};
        const selectedAvatarId = userData.selectedAvatar ? userData.selectedAvatar.id : null;

        if (Object.keys(purchasedAvatars).length === 0) {
            avatarGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">Henüz satın alınmış bir avatarınız yok. Mağazayı ziyaret edin!</p>';
            return;
        }

        avatarGrid.innerHTML = ''; // Temizle
        for (const itemId in purchasedAvatars) {
            const avatar = purchasedAvatars[itemId];
            const isSelected = selectedAvatarId === itemId;
            
            const avatarCard = document.createElement('div');
            avatarCard.className = `relative p-2 rounded-lg cursor-pointer transition-all duration-200 ${isSelected ? 'bg-blue-500 ring-4 ring-blue-300' : 'bg-gray-700 hover:bg-gray-600'}`;
            avatarCard.onclick = () => selectAvatar(itemId, avatar.imageUrl);
            
            avatarCard.innerHTML = `
                <img src="${avatar.imageUrl}" alt="${avatar.name}" class="w-full h-auto rounded-md object-cover aspect-square">
                <p class="text-xs mt-2 text-white truncate">${avatar.name}</p>
                ${isSelected ? '<div class="absolute top-1 right-1 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">✓</div>' : ''}
            `;
            avatarGrid.appendChild(avatarCard);
        }
    }

    async function selectAvatar(itemId, imageUrl) {
        if (isAdmin) return;
        const userRef = db.ref('users/' + currentUser);
        const avatarData = {
            id: itemId,
            url: imageUrl
        };
        await userRef.child('selectedAvatar').set(avatarData);
        displayMessage("Avatar başarıyla seçildi!");
        closeAvatarSelectionModal();
    }

   // YENİ: KUTU AYARLARI MODALI FONKSİYONLARI

// Modalı açar, veritabanından ayarları çeker ve satırları oluşturur.
async function openBoxSettingsModal() {
    if (!isAdmin) return;

    const container = document.getElementById('boxSettingsRowsContainer');
    container.innerHTML = ''; // Önceki satırları temizle

    const settingsRef = db.ref('gameConfig/boxContents');
    const snapshot = await settingsRef.once('value');

    // Eğer veritabanında hiç ayar yoksa kullanılacak varsayılan ayarlar.
    const defaultSettings = [ 
        { type: 'points', value: 100, count: 10 }, 
        { type: 'iflas', value: 0, count: 2 }, 
        { type: 'iflasShield', value: 1, count: 2 },
        { type: 'surpriz', value: 0, count: 1 } 
    ];
    const currentConfig = snapshot.exists() ? snapshot.val() : defaultSettings;

    if (currentConfig && currentConfig.length > 0) {
        currentConfig.forEach(item => addBoxSettingRow(item));
    } else {
        addBoxSettingRow(); // Eğer hiç ayar yoksa boş bir satırla başlat
    }
    
    updateTotalBoxCount(); // Toplam sayıyı ilk açılışta hesapla
    boxSettingsModal.style.display = 'flex';
}

// Modalı kapatır.
function closeBoxSettingsModal() {
    boxSettingsModal.style.display = 'none';
}

// Yeni bir ayar satırı (Puan, Bilet vb.) oluşturup ekrana ekler.
function addBoxSettingRow(item = {}) {
    const container = document.getElementById('boxSettingsRowsContainer');
    const row = document.createElement('div');
    row.className = 'box-setting-row flex items-center gap-3 p-3 bg-gray-900 rounded-lg';

    // Değerleri önceden doldurmak için (kayıtlı ayarları yüklerken kullanılır)
    const type = item.type || 'points';
    const value = item.value === 0 ? 0 : (item.value || ''); // 0 değerini koru
    const count = item.count || '';

    row.innerHTML = `
        <select class="setting-type flex-grow bg-gray-700 p-2 rounded-md text-white border border-gray-600" onchange="handleRowTypeChange(this)">
            <option value="points" ${type === 'points' ? 'selected' : ''}>Puan</option>
            <option value="iflas" ${type === 'iflas' ? 'selected' : ''}>İflas (Bomba)</option>
            <option value="surpriz" ${type === 'surpriz' ? 'selected' : ''}>Sürpriz Kutu</option>
            <option value="multiplier" ${type === 'multiplier' ? 'selected' : ''}>Çarpan</option>
            <option value="wheelTicket" ${type === 'wheelTicket' ? 'selected' : ''}>Çark Bileti</option>
            <option value="clickCatchTicket" ${type === 'clickCatchTicket' ? 'selected' : ''}>Tıkla-Yakala Bileti</option>
            <option value="iflasShield" ${type === 'iflasShield' ? 'selected' : ''}>İflas Kalkanı</option>
        </select>
        <input type="number" value="${value}" class="setting-value w-28 bg-gray-700 p-2 rounded-md text-white border border-gray-600" placeholder="Değer">
        <input type="number" value="${count}" class="setting-count w-28 bg-gray-700 p-2 rounded-md text-white border border-gray-600" placeholder="Adet" oninput="updateTotalBoxCount()">
        <button class="bg-red-700 hover:bg-red-600 text-white p-2 rounded-md" onclick="this.parentElement.remove(); updateTotalBoxCount();">Sil</button>
    `;
    
    container.appendChild(row);
    handleRowTypeChange(row.querySelector('.setting-type')); // Satırın ilk durumunu ayarla
    updateTotalBoxCount(); // Eklendikten sonra toplam sayıyı güncelle
}

// Bir satırda tür seçimi değiştiğinde "Değer" input'unu aktif/pasif yapar.
function handleRowTypeChange(selectElement) {
    const row = selectElement.parentElement;
    const valueInput = row.querySelector('.setting-value');
    const selectedType = selectElement.value;

    const typesWithValue = ['points', 'multiplier'];
    const typesWithAutoValue = ['wheelTicket', 'clickCatchTicket', 'iflasShield'];

    if (typesWithValue.includes(selectedType)) {
        valueInput.disabled = false;
        valueInput.placeholder = 'Değer';
        if(selectedType === 'multiplier') valueInput.placeholder = 'Değer (2, 3 vb.)';
    } else {
        valueInput.disabled = true;
        valueInput.placeholder = 'N/A';
        if(typesWithAutoValue.includes(selectedType)){
             valueInput.value = 1;
        } else {
             valueInput.value = 0;
        }
    }
}

// "Adet" inputlarından biri her değiştiğinde toplam kutu sayısını hesaplar ve gösterir.
function updateTotalBoxCount() {
    let total = 0;
    document.querySelectorAll('.box-setting-row .setting-count').forEach(input => {
        const count = parseInt(input.value);
        if (!isNaN(count) && count > 0) {
            total += count;
        }
    });
    document.getElementById('totalBoxCountDisplay').textContent = total;
}

function openHelpModal() {
  helpModal.style.display = 'flex';
}
function closeHelpModal() {
  helpModal.style.display = 'none';
}

    // YENİ EKLENEN FONKSİYON: DIŞARIYA TIKLAYINCA KAPATIR
function closeModalOnClickOutside(event) {
  // Eğer tıklanan elementin ID'si modalın kendisi ise (yani dıştaki karanlık alan ise)
  if (event.target.id === 'publicUserDetailModal') {
    closePublicUserDetailModal(); // Normal kapatma fonksiyonunu çağır
  }
}

async function clearWheelHistory() {
    if (!isAdmin) return;
    const confirmed = await customConfirm("Tüm 'Son Kazananlar' geçmişini kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!");
    if (confirmed) {
        await db.ref('wheelHistory').remove();
        displayMessage("Çark geçmişi başarıyla temizlendi.");
    }
}

async function deleteWheelHistoryEntry(entryKey) {
    if (!isAdmin || !entryKey) return;
    const confirmed = await customConfirm("Bu kaydı kalıcı olarak silmek istediğinizden emin misiniz?");
    if (confirmed) {
        await db.ref('wheelHistory/' + entryKey).remove();
    }
}

    function updateWheelAppearance() {
     const wheel = document.getElementById('wheel');
     if (!wheel) return;

     const segments = defaultWheelSegments;
     const numSegments = segments.length;
     const degreesPerSegment = 360 / numSegments;

     let conicGradient = 'conic-gradient(';
     wheel.innerHTML = ''; // Önceki yazıları temizle

     for (let i = 0; i < numSegments; i++) {
         const startAngle = i * degreesPerSegment;
         const endAngle = (i + 1) * degreesPerSegment;
         const color = getSegmentColor(i); // Fonksiyonu basitleştirdik
         
         // Renk dilimini oluştur
         conicGradient += `${color} ${startAngle}deg ${endAngle}deg`;
         if (i < numSegments - 1) {
             conicGradient += ', ';
         }

         // Yazıları oluştur ve yerleştir
         const segmentTextContainer = document.createElement('div');
         segmentTextContainer.className = 'wheel-segment-text';
         segmentTextContainer.style.transform = `rotate(${startAngle + (degreesPerSegment / 2)}deg)`;
         
         const textSpan = document.createElement('span');
         // HATALI KISIM DÜZELTİLDİ: Artık doğrudan doğru segmentin etiketini alıyor
         textSpan.innerText = segments[i].label; 
         
         segmentTextContainer.appendChild(textSpan);
         wheel.appendChild(segmentTextContainer);
     }
     conicGradient += ')';
     wheel.style.background = conicGradient;
 }

function getSegmentColor(index) {
     // Basit bir renk atama mantığı
     const colors = ['#f44336', '#4caf50', '#2196f3', '#ffeb3b', '#9c27b0', '#e91e63', '#00bcd4', '#8bc34a', '#ff9800', '#607d8b', '#795548', '#cddc39'];
     // HATALI KISIM DÜZELTİLDİ: Artık renkleri sırayla ve hatasız alıyor
     return colors[index % colors.length];
 }

updateWheelAppearance();

// ...VE YERİNE BU YENİ VERSİYONU YAPIŞTIR
function getIconForWheelLabel(label) {
    const upperLabel = (label || '').toUpperCase();
    
    // Yeni Puan ikonları
    if (upperLabel.includes('1000 PUAN')) return '🎂';
    if (upperLabel.includes('250 PUAN')) return '🍐';
    if (upperLabel.includes('100 PUAN')) return '🍌';
    if (upperLabel.includes('10 PUAN')) return '🍆';

    // Yeni "Bedava Çevirme" ödülü
    if (upperLabel.includes('BEDAVA ÇEVİR')) return '🎡';

    // Diğer sabit ödüller
    if (upperLabel.includes('3 KUTU HAKKI')) return '🎁';
    if (upperLabel.includes('1 KUTU HAKKI')) return '📦';
    if (upperLabel.includes('TIKLA-YAKALA')) return '🎟️';
    if (upperLabel.includes('5X ÇARPAN')) return '✖️';
    if (upperLabel.includes('SÜRPRİZ KUTU')) return '🎉';
    if (upperLabel.includes('İFLAS KALKANI')) return '🛡️';
    if (upperLabel.includes('PAS')) return '☠️';
    
    return '🎡'; // Varsayılan simge
}

function closeWheelLegendModal() {
    document.getElementById('wheelLegendModal').style.display = 'none';
}

// BU İKİ FONKSİYONU KOPYALAYIP MEVCUT OLANLARLA DEĞİŞTİR

function openWheelLegendModal() {
    document.body.classList.add('modal-open');
    const contentDiv = document.getElementById('wheelLegendContent');
    contentDiv.innerHTML = '';

    // En son konuştuğumuz, güncel ve doğru ödül listesi
    const legendData = [
        { icon: '🎉', title: 'SÜRPRİZ KUTU', description: 'En nadir ödül! İçinden çok yüksek puanlar çıkan özel bir kart seçme oyunu başlatır.' },
        { icon: '✖️', title: '5X ÇARPAN', description: 'Çok nadir! Bir sonraki kutu açılışında kazanacağın puanı veya eşyayı 5\'e katlar.' },
        { icon: '🎂', title: '1000 PUAN', description: 'Nadir bulunan, yüksek miktarda bir puan ödülüdür.' },
        { icon: '🎁', title: '3 KUTU HAKKI', description: 'Değerli bir ödül! Kutu oyununda kullanmak üzere tam 3 adet açma hakkı verir.' },
        { icon: '🍐', title: '250 PUAN', description: 'Hesabına anında 250 Puan eklenir.' },
        { icon: '📦', title: '1 KUTU HAKKI', description: 'Ana oyundaki kutu oyununda kullanabileceğin 1 adet açma hakkı kazandırır.' },
        { icon: '🛡️', title: 'İFLAS KALKANI', description: 'Kutu oyununda "Bomba" bulursan puanlarını bir defaya mahsus korur.' },
        { icon: '🎟️', title: '+1 T-Y BİLETİ', description: 'Tıkla-Yakala mini oyununa bir giriş hakkı kazandırır.' },
        { icon: '🎡', title: 'BEDAVA ÇEVİRME', description: 'Şansını tekrar denemen için +1 Çark Bileti kazandırır.' },
        { icon: '🍌', title: '100 PUAN', description: 'Sıkça gelen, güzel bir puan ödülüdür.' },
        { icon: '🍆', title: '10 PUAN', description: 'En küçük teselli puanı ödülüdür.' },
        { icon: '☠️', title: 'PAS', description: 'Şanssızlık! Bu dilimde herhangi bir ödül yoktur.' }
    ];

    legendData.forEach(item => {
        const itemHtml = `
            <div class="flex items-start gap-4 p-3 bg-gray-900 rounded-lg text-left">
                <span class="text-3xl w-8 text-center mt-1">${item.icon}</span>
                <div class="flex-1">
                    <strong class="text-yellow-200 block">${item.title}</strong>
                    <p class="text-gray-400 text-sm">${item.description}</p>
                </div>
            </div>
        `;
        contentDiv.innerHTML += itemHtml;
    });
    
    document.getElementById('wheelLegendModal').style.display = 'flex';
}

function closeWheelLegendModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('wheelLegendModal').style.display = 'none';
}

    function listenForLastGameSummary() {
    const ref = db.ref('clickCatchLobbyLastGameSummary');
    const container = document.getElementById('lastWinnerContainer');
    const titleEl = document.getElementById('lastWinnerInfo');
    const detailsListEl = document.getElementById('lastGameDetailsList');

    const callback = snap => {
        const summaryData = snap.val();

        // EĞER VERİ VARSA VE KAZANAN BELLİ İSE BİLGİLERİ GÖSTER
        if (summaryData && summaryData.winner) {
            
            // 1. Oyun Süresini Hesapla
            let durationText = '';
            if (summaryData.startTimestamp && summaryData.endTimestamp) {
                const durationMs = summaryData.endTimestamp - summaryData.startTimestamp;
                const seconds = Math.floor(durationMs / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                durationText = ` (Süre: ${minutes}dk ${remainingSeconds}sn)`;
            }

            // 2. Ana Başlığı Güncelle (Admin için silme butonuyla birlikte)
            let deleteButton = '';
            if (isAdmin) {
                deleteButton = `
                    <button onclick="clearLastWinner()" class="ml-2 text-gray-500 hover:text-red-500 transition-colors" title="Son Kazananı Sil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1-1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                `;
            }
            titleEl.innerHTML = `🏆 Son Lobi Galibi: <b class="text-white">${summaryData.winner}</b> (+${summaryData.prize} Puan)${durationText}${deleteButton}`;

            // 3. Oyuncu Listesini Oluştur ve Sırala
            const players = summaryData.players || {};
            const sortedPlayers = Object.entries(players).sort(([, a], [, b]) => b.score - a.score);
            
            let detailsHtml = '';
            sortedPlayers.forEach(([username, data], index) => {
                const isWinner = username === summaryData.winner;
                const rowClass = isWinner ? 'bg-green-800/50 border-green-500' : 'bg-gray-800/50 border-gray-700';
                const rankIcon = index === 0 ? '🥇' : (index === 1 ? '🥈' : (index === 2 ? '🥉' : `${index + 1}.`));
                
                detailsHtml += `
                    <div class="flex justify-between items-center p-2 rounded border ${rowClass}">
                        <span class="font-bold">${rankIcon} ${username}</span>
                        <span class="text-gray-300">Skor: <b class="text-white">${data.score} / ${summaryData.target}</b></span>
                    </div>
                `;
            });
            
            detailsListEl.innerHTML = detailsHtml;
            container.classList.remove('hidden'); // Paneli görünür yap

        } else {
            // SORUNU ÇÖZEN KISIM: EĞER VERİ SİLİNMİŞSE (NULL İSE) PANELİ GİZLE
            container.classList.add('hidden');
        }
    };
    
    // Listener'ı tekrar tekrar eklememek için kontrol
    if (activeListeners.lobbySummary) {
        activeListeners.lobbySummary.ref.off('value', activeListeners.lobbySummary.callback);
    }
    activeListeners.lobbySummary = { ref, event: 'value', callback };
    ref.on('value', callback);
}

    // YENİ EKLENECEK KOD BAŞLANGICI
  // Günlük Ödül modalındaki "Ödül Tipi" dropdown'ını dinler.
  document.getElementById('dailyRewardType').addEventListener('change', function() {
      const usesInput = document.getElementById('dailyRewardMultiplierUses');
      // Eğer seçilen tip "Çarpan" (tempMultiplier) ise, Kullanım Hakkı alanını göster.
      if (this.value === 'tempMultiplier') {
          usesInput.classList.remove('hidden');
      } else {
      // Değilse, Kullanım Hakkı alanını gizle.
          usesInput.classList.add('hidden');
      }
  });

    // --- TIKLA-YAKALA BİLGİ FONKSİYONLARI ---

function openClickCatchInfoModal() {
    document.body.classList.add('modal-open');
    document.getElementById('clickCatchInfoModal').style.display = 'flex';
}

function closeClickCatchInfoModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('clickCatchInfoModal').style.display = 'none';
}

    // YENİ EKLENECEK GERİ SAYIM FONKSİYONU
let seasonCountdownInterval = null;

function listenForSeasonCountdown() {
    const countdownContainer = document.getElementById('seasonCountdownContainer');
    const countdownEl = document.getElementById('seasonCountdown');
    const ref = db.ref('gameConfig/seasonEndDate');

    const callback = snap => {
        if (seasonCountdownInterval) {
            clearInterval(seasonCountdownInterval);
        }

        const endDateTimestamp = snap.val();

        if (!endDateTimestamp || endDateTimestamp < getSyncedTime()) {
            countdownContainer.classList.add('hidden');
            return;
        }

        countdownContainer.classList.remove('hidden');

        const updateTimer = () => {
            const now = getSyncedTime(); // <-- HATA DÜZELTİLDİ
            const timeLeft = endDateTimestamp - now;

            if (timeLeft <= 0) {
                countdownEl.textContent = "SEZON BİTTİ!";
                clearInterval(seasonCountdownInterval);
                return;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            countdownEl.textContent = `${days} Gün ${hours} Saat ${minutes} Dakika ${seconds} Saniye`;
        };

        updateTimer();
        seasonCountdownInterval = setInterval(updateTimer, 1000);
    };

    if (activeListeners.seasonCountdown) {
        activeListeners.seasonCountdown.ref.off('value', activeListeners.seasonCountdown.callback);
    }
    activeListeners.seasonCountdown = { ref, event: 'value', callback };
    ref.on('value', callback);
}

   async function openSeasonManagementModal() {
    document.body.classList.add('modal-open');
    // Kayıtlı ayarları çek ve inputları doldur
    const settingsSnap = await db.ref('gameConfig/seasonSettings').once('value');
    if (settingsSnap.exists()) {
        const settings = settingsSnap.val();
        if (settings.endDate) {
            const date = new Date(settings.endDate);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            // DEĞİŞEN SATIR: Artık doğru ve benzersiz ID'ye sahip input'u hedefliyoruz.
            document.getElementById('seasonManagementEndDateInput').value = date.toISOString().slice(0, 16);
        }
        document.getElementById('puanLeaderAvatarUrl').value = settings.rewards?.puanLeaderAvatarUrl || '';
        document.getElementById('rozetLeaderAvatarUrl').value = settings.rewards?.rozetLeaderAvatarUrl || '';
    }
    document.getElementById('seasonManagementModal').style.display = 'flex';
}

function closeSeasonManagementModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('seasonManagementModal').style.display = 'none';
}

// --- ESKİ saveAutomaticResetSettings FONKSİYONUNU SİL VE BUNU YAPIŞTIR ---

async function saveAutomaticResetSettings() {
    if (!isAdmin) return;

    const dateInput = document.getElementById('seasonManagementEndDateInput').value;
    const puanAvatarUrl = document.getElementById('puanLeaderAvatarUrl').value.trim();
    const rozetAvatarUrl = document.getElementById('rozetLeaderAvatarUrl').value.trim();

    // --- YENİ EKLENEN KOD BAŞLANGICI ---
    // Hediye paketi input'larındaki değerleri oku. Değer girilmemişse 0 kabul et.
    const giftPackage = {
        kutuHakki: parseInt(document.getElementById('rewardBoxRights').value) || 0,
        carkBileti: parseInt(document.getElementById('rewardWheelTickets').value) || 0,
        clickCatchTickets: parseInt(document.getElementById('rewardClickCatchTickets').value) || 0,
        iflasShieldUses: parseInt(document.getElementById('rewardIflasShields').value) || 0
    };
    // --- YENİ EKLENEN KOD SONU ---

    if (!dateInput) {
        displayMessage("Lütfen geçerli bir sezon bitiş tarihi seçin.");
        return;
    }
    
    const settings = {
        endDate: new Date(dateInput).getTime(),
        status: 'active',
        rewards: {
            puanLeaderAvatarUrl: puanAvatarUrl,
            rozetLeaderAvatarUrl: rozetAvatarUrl,
            general: giftPackage // Okuduğumuz hediye paketini ayarlara ekle
        }
    };
    
    await db.ref('gameConfig/seasonSettings').set(settings);
    await db.ref('gameConfig/seasonEndDate').set(settings.endDate);
    
    displayMessage("Otomatik sezon sonu ayarları kaydedildi. Geri sayım başlayacak.");
    closeSeasonManagementModal();
}

async function executeSeasonReset(isManual = false) {
    if (!isAdmin) return;
    
    const confirmationText = isManual 
        ? "Sezonu ŞİMDİ MANUEL olarak bitirmek üzeresiniz. Tüm puanlar ve istatistikler sıfırlanacak, ödüller dağıtılacak. Bu işlem geri alınamaz. Emin misiniz?"
        : "Sezon sonu için SON ONAY. Sıfırlama işlemi başlayacak ve geri alınamayacak. Onaylıyor musunuz?";

    const confirmed = await customConfirm(confirmationText);
    if (!confirmed) return;

    displayMessage("Sezon sonu işlemleri başlatıldı... Bu işlem birkaç saniye sürebilir. Lütfen bekleyin.");

    // 1. Gerekli tüm verileri topla
    const allUsersSnap = await db.ref('users').once('value');
    const allUsersData = allUsersSnap.val();
    const leaders = await calculateAllLeaders(allUsersData);
    const settingsSnap = await db.ref('gameConfig/seasonSettings').once('value');
    const seasonSettings = settingsSnap.val();

    const puanLeader = leaders.currentBalanceUser;
    const rozetLeader = (await getTopBadgeHolder(allUsersData, leaders)).username;
    
    const puanAvatar = seasonSettings?.rewards?.puanLeaderAvatarUrl || document.getElementById('puanLeaderAvatarUrl').value.trim();
    const rozetAvatar = seasonSettings?.rewards?.rozetLeaderAvatarUrl || document.getElementById('rozetLeaderAvatarUrl').value.trim();

    const giftPackage = {
        kutuHakki: parseInt(document.getElementById('rewardBoxRights').value) || 0,
        carkBileti: parseInt(document.getElementById('rewardWheelTickets').value) || 0,
        clickCatchTickets: parseInt(document.getElementById('rewardClickCatchTickets').value) || 0,
        iflasShieldUses: parseInt(document.getElementById('rewardIflasShields').value) || 0
    };

    // 2. Ödülleri ve sıfırlamaları hazırla
    const updates = {};
    
    for (const username in allUsersData) {
        if (username.toLowerCase() === 'weizendtv' || !allUsersData[username].approved) continue;
        
        const userPath = `users/${username}`;
        const userData = allUsersData[username];

        // HERKESE HEDİYE PAKETİNİ VER
        updates[`${userPath}/kutuHakki`] = (userData.kutuHakki || 0) + giftPackage.kutuHakki;
        updates[`${userPath}/carkBileti`] = (userData.carkBileti || 0) + giftPackage.carkBileti;
        updates[`${userPath}/clickCatchTickets`] = (userData.clickCatchTickets || 0) + giftPackage.clickCatchTickets;
        updates[`${userPath}/iflasShieldUses`] = (userData.iflasShieldUses || 0) + giftPackage.iflasShieldUses;

        // ŞAMPİYONLARA ÖZEL AVATAR ÖDÜLÜNÜ VE ŞAMPİYONLUK SAYACINI GÜNCELLE
        if (username === puanLeader) {
            if(puanAvatar) updates[`${userPath}/selectedAvatar`] = { id: `sezon_odul_puan_${Date.now()}`, url: puanAvatar };
            // YENİ: Puan şampiyonluğu sayacını 1 artır. Eğer sayaç yoksa 1'den başlar.
            updates[`${userPath}/puanChampionshipsWon`] = firebase.database.ServerValue.increment(1);
        }
        if (username === rozetLeader) {
            if(rozetAvatar) updates[`${userPath}/selectedAvatar`] = { id: `sezon_odul_rozet_${Date.now()}`, url: rozetAvatar };
            // YENİ: Rozet şampiyonluğu sayacını 1 artır. Eğer sayaç yoksa 1'den başlar.
            updates[`${userPath}/rozetChampionshipsWon`] = firebase.database.ServerValue.increment(1);
        }
        
        // HERKESİN PUAN VE İSTATİSTİKLERİNİ SIFIRLA
        updates[`${userPath}/balance`] = 0;
        updates[`${userPath}/highestBalanceEver`] = 0;
        // ... (diğer sıfırlama kodları aynı kalacak)
        updates[`${userPath}/totalSpentPoints`] = 0;
        updates[`${userPath}/boxesOpenedCount`] = 0;
        updates[`${userPath}/surpriseBoxesOpened`] = 0;
        updates[`${userPath}/iflasCount`] = 0;
        updates[`${userPath}/multiplierFoundCount`] = 0;
        updates[`${userPath}/iflasShieldUsedCount`] = 0;
        updates[`${userPath}/wheelSpinsCount`] = 0;
        updates[`${userPath}/clickCatchHighestScore`] = 0;
    }

    // Mağaza ve geçmiş verilerini sıfırla
    updates['purchaseHistory'] = null;
    updates['clickCatchWeeklyScores'] = null;
    updates['gameStats'] = null;

    const storeItemsSnap = await db.ref('storeItems').once('value');
    if (storeItemsSnap.exists()) {
        storeItemsSnap.forEach(itemSnap => {
            updates[`storeItems/${itemSnap.key}/purchaseCount`] = 0;
        });
    }

    // 3. Kalıcı Duyuruyu Oluştur
    const seasonName = new Date().toLocaleString('tr-TR', { month: 'long', year: 'numeric' }) + " Sezonu";
    updates[`seasonAnnouncements/${Date.now()}`] = {
        title: `${seasonName} Sona Erdi!`,
        message: `🏆 Puan Lideri: <b>${puanLeader}</b><br>👑 Rozet Lideri: <b>${rozetLeader}</b><br><br>Şampiyonlar özel avatarlarını kazandı! Tüm katılımcılara ise hediye paketleri gönderildi! Yeni sezon başladı, herkese bol şans!`,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    // 4. Tüm işlemleri tek seferde uygula ve oyunu yeniden kur
    await db.ref().update(updates);
    await createBoxes();
    
    // 5. Sezon ayarlarını temizle
    await db.ref('gameConfig/seasonSettings').remove();
    await db.ref('gameConfig/seasonEndDate').remove();

    displayMessage("SEZON BAŞARIYLA SIFIRLANDI! Ödüller dağıtıldı ve yeni sezon başladı.");
    closeSeasonManagementModal();
}
async function stopSeasonCountdown() {
    if (!isAdmin) return; // Sadece adminin kullanabildiğinden emin ol.

    const confirmed = await customConfirm("Mevcut otomatik sezon sonu geri sayımını durdurmak ve ayarları silmek istediğinizden emin misiniz?");
    if (!confirmed) return; // Kullanıcı "Hayır" derse işlemi iptal et.

    try {
        // Geri sayımı ve ayarları kontrol eden veritabanı yollarını sil.
        await db.ref('gameConfig/seasonEndDate').remove();
        await db.ref('gameConfig/seasonSettings').remove();

        displayMessage("Otomatik aylık sezon sıfırlama başarıyla iptal edildi. Geri sayım durduruldu.");
        closeSeasonManagementModal(); // İşlem bittikten sonra pencereyi kapat.

    } catch (error) {
        console.error("Sezon sayacı durdurulurken hata:", error);
        displayMessage("Geri sayım iptal edilirken bir hata oluştu. Lütfen konsolu kontrol edin.");
    }
}

// --- YENİ EKLENECEK FONKSİYON SONU ---

// Oyuncular için kalıcı duyuru sistemini dinler
let currentPersistentAnnId = null;
function listenForPersistentAnnouncement() {
    const ref = db.ref('seasonAnnouncements').orderByChild('timestamp').limitToLast(1);
    
    const callback = async (snap) => {
        if (!snap.exists()) return;
        
        currentPersistentAnnId = Object.keys(snap.val())[0];
        const ann = snap.val()[currentPersistentAnnId];

        const userSeenRef = db.ref(`users/${currentUser}/seenAnnouncements/${currentPersistentAnnId}`);
        const userSeenSnap = await userSeenRef.once('value');

        if (!userSeenSnap.exists()) {
            document.getElementById('persistentAnnTitle').textContent = ann.title;
            document.getElementById('persistentAnnMessage').innerHTML = ann.message;
            document.getElementById('persistentAnnouncementModal').style.display = 'flex';
        }
    };
    
    if (activeListeners.persistentAnn) {
        activeListeners.persistentAnn.ref.off('value', activeListeners.persistentAnn.callback);
    }
    activeListeners.persistentAnn = { ref, event: 'value', callback };
    ref.on('value', callback);
}

// Oyuncu duyuruyu kapattığında işaretler
async function markPersistentAnnouncementAsSeen() {
    if (currentPersistentAnnId) {
        await db.ref(`users/${currentUser}/seenAnnouncements/${currentPersistentAnnId}`).set(true);
    }
    document.getElementById('persistentAnnouncementModal').style.display = 'none';
    document.body.classList.remove('modal-open');
}

// Rozet liderini bulan yardımcı fonksiyon
async function getTopBadgeHolder(allUsersData, leaders) {
    let topUser = { username: null, badgeCount: -1 };
    
    for (const username in allUsersData) {
        if (username.toLowerCase() === 'weizendtv' || !allUsersData[username].approved) continue;

        let count = 0;
        if (username === leaders.currentBalanceUser) count++;
        if (username === leaders.highEverBalanceUser) count++;
        if (username === leaders.surpriseBoxUser) count++;
        if (username === leaders.bombUser) count++;
        if (username === leaders.spentPointsUser) count++;
        if (username === leaders.multiplierUser) count++;
        if (username === leaders.boxUser) count++;
        if (username === leaders.shieldUser) count++;
        if (username === leaders.clickCatchLeaderUser) count++;
        if (username === leaders.wheelSpinUser) count++;
        
        if (count > topUser.badgeCount) {
            topUser = { username: username, badgeCount: count };
        }
    }
    return topUser;
}

    // MEVCUT openSeasonInfoModal FONKSİYONUNU SİLİP BUNUNLA DEĞİŞTİRİN

async function openSeasonInfoModal() {
    document.body.classList.add('modal-open');
    const giftDetailsContainer = document.getElementById('seasonGiftPackageDetails');
    const championPrizesContainer = document.getElementById('seasonChampionPrizes');
    
    giftDetailsContainer.innerHTML = '<p class="text-gray-400">Genel ödül paketi yükleniyor...</p>';
    championPrizesContainer.innerHTML = '<p class="text-gray-400">Şampiyon ödülleri yükleniyor...</p>';

    try {
        const settingsSnap = await db.ref('gameConfig/seasonSettings/rewards').once('value');
        
        // Genel Hediye Paketi Kısmı
        let rewardsHtml = '<strong class="text-yellow-200 block mb-2">Tüm Katılımcılar İçin Hediye Paketi:</strong><ul class="list-disc list-inside space-y-1 text-gray-300">';
        let hasRewards = false;
        
        const generalRewards = settingsSnap.exists() ? settingsSnap.val().general : null;
        if (generalRewards) {
            if (generalRewards.kutuHakki > 0) { rewardsHtml += `<li>🎁 ${generalRewards.kutuHakki} Adet Kutu Hakkı</li>`; hasRewards = true; }
            if (generalRewards.carkBileti > 0) { rewardsHtml += `<li>🎡 ${generalRewards.carkBileti} Adet Çark Bileti</li>`; hasRewards = true; }
            if (generalRewards.clickCatchTickets > 0) { rewardsHtml += `<li>🎯 ${generalRewards.clickCatchTickets} Adet Tıkla-Yakala Bileti</li>`; hasRewards = true; }
            if (generalRewards.iflasShieldUses > 0) { rewardsHtml += `<li>🛡️ ${generalRewards.iflasShieldUses} Adet İflas Kalkanı</li>`; hasRewards = true; }
        }
        if (!hasRewards) {
            rewardsHtml += '<li>Bu sezon için henüz genel bir ödül paketi belirlenmedi.</li>';
        }
        rewardsHtml += '</ul>';
        giftDetailsContainer.innerHTML = rewardsHtml;

        // Şampiyon Ödülleri Kısmı
        let championPrizesHtml = '<strong class="text-yellow-300 block mb-2">Sıralama Liderleri İçin Özel Ödüller:</strong><ul class="list-disc list-inside space-y-1 text-gray-300">';
        let hasChampionPrizes = false;

        const championRewards = settingsSnap.val();
        if (championRewards) {
            if (championRewards.puanLeaderAvatarUrl) {
                // --- DEĞİŞEN SATIR: Profile işleneceği bilgisi eklendi ---
                championPrizesHtml += `<li>🥇 Kullanıcı Puan Sıralaması 1.'si <b class="text-white">Özel Şampiyon Avatarı</b> kazanacak ve bu başarı profiline kalıcı olarak işlenecektir.</li>`;
                hasChampionPrizes = true;
            }
            if (championRewards.rozetLeaderAvatarUrl) {
                // --- DEĞİŞEN SATIR: Profile işleneceği bilgisi eklendi ---
                championPrizesHtml += `<li>👑 Liderler Sıralaması 1.'si <b class="text-white">Özel Şampiyon Avatarı</b> kazanacak ve bu başarı profiline kalıcı olarak işlenecektir.</li>`;
                hasChampionPrizes = true;
            }
        }

        if (!hasChampionPrizes) {
            championPrizesHtml += '<li>Bu sezon için henüz özel bir şampiyon ödülü belirlenmedi.</li>';
        }
        championPrizesHtml += '</ul>';
        championPrizesContainer.innerHTML = championPrizesHtml;

    } catch (error) {
        console.error("Sezon ödülleri alınırken hata:", error);
        giftDetailsContainer.innerHTML = '<p class="text-red-500">Genel ödül bilgileri yüklenemedi.</p>';
        championPrizesContainer.innerHTML = '<p class="text-red-500">Şampiyon ödül bilgileri yüklenemedi.</p>';
    }

    document.getElementById('seasonInfoModal').style.display = 'flex';
}

function closeSeasonInfoModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('seasonInfoModal').style.display = 'none';
}

// --- YENİ EKLENECEK HAFTALIK BİLGİ PENCERESİ FONKSİYONLARI ---

async function openWeeklyResetInfoModal() {
    document.body.classList.add('modal-open');
    const detailsContainer = document.getElementById('weeklyWinnerPrizeDetails');
    detailsContainer.innerHTML = '<p class="text-gray-400">Şampiyon ödülü yükleniyor...</p>';

    try {
        const settingsSnap = await db.ref('gameConfig/weeklyClickCatchReset/prize').once('value');
        let prizeHtml = '';

        if (settingsSnap.exists()) {
            const prize = settingsSnap.val();
            const prizeNames = { boxRights: "Kutu Hakkı", points: "Puan", wheelTicket: "Çark Bileti", iflasShield: "İflas Kalkanı" };
            const prizeName = prizeNames[prize.type] || prize.type;
            
            prizeHtml = `<strong>🏆 Şampiyon Ödülü:</strong> <span class="text-white font-bold">${prize.amount} ${prizeName}</span>`;
        } else {
            prizeHtml = '<strong>🏆 Şampiyon Ödülü:</strong> <span class="text-gray-400">Henüz admin tarafından belirlenmedi.</span>';
        }
        detailsContainer.innerHTML = prizeHtml;

    } catch (error) {
        console.error("Haftalık ödül bilgisi alınırken hata:", error);
        detailsContainer.innerHTML = '<p class="text-red-500">Ödül bilgileri yüklenemedi.</p>';
    }

    document.getElementById('weeklyResetInfoModal').style.display = 'flex';
}

function closeWeeklyResetInfoModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('weeklyResetInfoModal').style.display = 'none';
}
  // YENİ EKLENECEK KOD SONU
    
</script>
</body>
</html>
